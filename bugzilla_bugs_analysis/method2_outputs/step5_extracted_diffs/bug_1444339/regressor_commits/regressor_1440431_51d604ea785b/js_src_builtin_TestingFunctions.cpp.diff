# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/builtin/TestingFunctions.cpp
# Commit: 51d604ea785b
# Full Hash: 51d604ea785bbc46db7f88235faef597f57e671f
# Author: Jason Orendorff <jorendorff@mozilla.com>
# Date: 2018-02-24 10:13:47
# Regressor Bug: 1440431
# File Overlap Count: 1
# Description:
#   Bug 1440431 - Part 3: Add baselineCompile() testing function. r=nbp.
# ==============================================================================

diff -r d6d01ad35d89 -r 51d604ea785b js/src/builtin/TestingFunctions.cpp
--- a/js/src/builtin/TestingFunctions.cpp	Thu Feb 22 14:24:11 2018 -0600
+++ b/js/src/builtin/TestingFunctions.cpp	Thu Feb 22 13:04:46 2018 -0600
@@ -27,6 +27,7 @@
 #include "irregexp/RegExpEngine.h"
 #include "irregexp/RegExpParser.h"
 #endif
+#include "jit/BaselineJIT.h"
 #include "jit/InlinableNatives.h"
 #include "js/Debug.h"
 #include "js/HashTable.h"
@@ -5016,6 +5017,72 @@
     return script;
 }
 
+static bool
+BaselineCompile(JSContext* cx, unsigned argc, Value* vp)
+{
+    CallArgs args = CallArgsFromVp(argc, vp);
+    RootedObject callee(cx, &args.callee());
+
+    RootedScript script(cx);
+    if (args.length() == 0) {
+        NonBuiltinScriptFrameIter iter(cx);
+        if (iter.done()) {
+            ReportUsageErrorASCII(cx, callee, "no script argument and no script caller");
+            return false;
+        }
+        script = iter.script();
+    } else {
+        script = TestingFunctionArgumentToScript(cx, args[0]);
+        if (!script)
+            return false;
+    }
+
+    bool forceDebug = false;
+    if (args.length() > 1) {
+        if (args.length() > 2) {
+            ReportUsageErrorASCII(cx, callee, "too many arguments");
+            return false;
+        }
+        if (!args[1].isBoolean() && !args[1].isUndefined()) {
+            ReportUsageErrorASCII(cx, callee, "forceDebugInstrumentation argument should be boolean");
+            return false;
+        }
+        forceDebug = ToBoolean(args[1]);
+    }
+
+    if (script->hasBaselineScript()) {
+        if (forceDebug && !script->baselineScript()->hasDebugInstrumentation()) {
+            // There isn't an easy way to do this for a script that might be on
+            // stack right now. See js::jit::RecompileOnStackBaselineScriptsForDebugMode.
+            ReportUsageErrorASCII(cx, callee,
+                                  "unsupported case: recompiling script for debug mode");
+            return false;
+        }
+
+        args.rval().setUndefined();
+        return true;
+    }
+
+    if (!jit::IsBaselineEnabled(cx))
+        return ReturnStringCopy(cx, args, "baseline disabled");
+    if (!script->canBaselineCompile())
+        return ReturnStringCopy(cx, args, "can't compile");
+
+    jit::MethodStatus status = jit::BaselineCompile(cx, script, forceDebug);
+    switch (status) {
+      case jit::Method_Error:
+        return false;
+      case jit::Method_CantCompile:
+        return ReturnStringCopy(cx, args, "can't compile");
+      case jit::Method_Skipped:
+        return ReturnStringCopy(cx, args, "skipped");
+      case jit::Method_Compiled:
+        args.rval().setUndefined();
+    }
+
+    return true;
+}
+
 static const JSFunctionSpecWithHelp TestingFunctions[] = {
     JS_FN_HELP("gc", ::GC, 0, 0,
 "gc([obj] | 'zone' [, 'shrinking'])",
@@ -5645,6 +5712,15 @@
 "disableExpressionClosures()",
 "  Disables the deprecated, non-standard expression closures.\n"),
 
+    JS_FN_HELP("baselineCompile", BaselineCompile, 2, 0,
+"baselineCompile([fun/code], forceDebugInstrumentation=false)",
+"  Baseline-compiles the given JS function or script.\n"
+"  Without arguments, baseline-compiles the caller's script; but note\n"
+"  that extra boilerplate is needed afterwards to cause the VM to start\n"
+"  running the jitcode rather than staying in the interpreter:\n"
+"    baselineCompile();  for (var i=0; i<1; i++) {} ...\n"
+"  The interpreter will enter the new jitcode at the loop header.\n"),
+
     JS_FS_HELP_END
 };
 