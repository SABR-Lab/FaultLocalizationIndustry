# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/xpconnect/src/nsXPConnect.cpp
# Commit: b3c093b141e2
# Full Hash: b3c093b141e2381efef699124f8a629d0711c8c6
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2018-08-07 15:42:55
# Regressor Bug: 1478359
# File Overlap Count: 2
# Description:
#   Bug 1478359 - Store a global object in nsXPCWrappedJS and use it for realm-entering. r=mccr8
#   
#   The problem we're solving here: getting/entering the realm/global of a cross-compartment wrapper doesn't make sense once there are multiple realms in a compartment and the CCW will be shared by all of them. Because nsXPCWrappedJS can store a CCW, we will no longer be able to use this JSObject to enter the target realm.
#   
#   What this patch does: we pass a JSContext* to nsXPCWrappedJS::GetNewOrUsed and we use this to store a global object in nsXPCWrappedJS (with the invariant that the object and global stored in nsXPCWrappedJS are same-compartment). Then when we want to enter the nsXPCWrappedJS's target realm, we use this global object instead of the maybe-CCW object. Because we currently still have one realm per compartment and the objects are same-compartment, this is guaranteed to preserve behavior for now.
# ==============================================================================

diff -r bf6961db9405 -r b3c093b141e2 js/xpconnect/src/nsXPConnect.cpp
--- a/js/xpconnect/src/nsXPConnect.cpp	Tue Aug 07 12:41:15 2018 +0300
+++ b/js/xpconnect/src/nsXPConnect.cpp	Tue Aug 07 11:57:41 2018 +0200
@@ -677,7 +677,7 @@
     RootedObject aJSObj(aJSContext, aJSObjArg);
 
     nsresult rv = NS_ERROR_UNEXPECTED;
-    if (!XPCConvert::JSObject2NativeInterface(result, aJSObj,
+    if (!XPCConvert::JSObject2NativeInterface(aJSContext, result, aJSObj,
                                               &aIID, nullptr, &rv))
         return rv;
     return NS_OK;
@@ -713,7 +713,7 @@
 
     RootedObject aJSObj(aJSContext, aJSObjArg);
     nsresult rv;
-    if (!XPCConvert::JSObject2NativeInterface(result, aJSObj,
+    if (!XPCConvert::JSObject2NativeInterface(aJSContext, result, aJSObj,
                                               &aIID, aOuter, &rv))
         return rv;
     return NS_OK;