# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/webrender_bindings/WebRenderAPI.cpp
# Commit: c09a51622e98
# Full Hash: c09a51622e988e81077c75e3aaa5a49df66284b3
# Author: Doug Thayer <dothayer@mozilla.com>
# Date: 2019-03-22 16:44:08
# Regressor Bug: 1441308
# File Overlap Count: 2
# Description:
#   Bug 1441308 - Core renderroot splitting changes r=kats,sotaro
#   
#   This is a large patch that contains all of the core changes for
#   renderroot splitting.
#   
# ==============================================================================

diff -r 737807563dd5 -r c09a51622e98 gfx/webrender_bindings/WebRenderAPI.cpp
--- a/gfx/webrender_bindings/WebRenderAPI.cpp	Thu Mar 21 23:14:26 2019 +0000
+++ b/gfx/webrender_bindings/WebRenderAPI.cpp	Fri Mar 22 03:15:14 2019 +0000
@@ -8,6 +8,7 @@
 
 #include "gfxPrefs.h"
 #include "LayersLogging.h"
+#include "mozilla/ipc/ByteBuf.h"
 #include "mozilla/webrender/RendererOGL.h"
 #include "mozilla/gfx/gfxVars.h"
 #include "mozilla/layers/CompositorThread.h"
@@ -80,8 +81,9 @@
                            ? aRenderThread.GetShaders()->RawShaders()
                            : nullptr,
                        aRenderThread.ThreadPool().Raw(), &WebRenderMallocSizeOf,
-                       &WebRenderMallocEnclosingSizeOf, mDocHandle, &wrRenderer,
-                       mMaxTextureSize)) {
+                       &WebRenderMallocEnclosingSizeOf,
+                       (uint32_t)wr::RenderRoot::Default,
+                       mDocHandle, &wrRenderer, mMaxTextureSize)) {
       // wr_window_new puts a message into gfxCriticalNote if it returns false
       return;
     }
@@ -205,10 +207,12 @@
 }
 
 void TransactionBuilder::SetDocumentView(
-    const LayoutDeviceIntRect& aDocumentRect) {
+    const LayoutDeviceIntRect& aDocumentRect,
+    const LayoutDeviceIntSize& aWidgetSize) {
   wr::FramebufferIntRect wrDocRect;
   wrDocRect.origin.x = aDocumentRect.x;
-  wrDocRect.origin.y = aDocumentRect.y;
+  wrDocRect.origin.y =
+      aWidgetSize.height - aDocumentRect.y - aDocumentRect.height;
   wrDocRect.size.width = aDocumentRect.width;
   wrDocRect.size.height = aDocumentRect.height;
   wr_transaction_set_document_view(mTxn, &wrDocRect);
@@ -276,7 +280,8 @@
 
   return RefPtr<WebRenderAPI>(
              new WebRenderAPI(docHandle, aWindowId, maxTextureSize, useANGLE,
-                              useDComp, useTripleBuffering, syncHandle))
+                              useDComp, useTripleBuffering, syncHandle,
+                              wr::RenderRoot::Default))
       .forget();
 }
 
@@ -286,24 +291,25 @@
 
   RefPtr<WebRenderAPI> renderApi =
       new WebRenderAPI(docHandle, mId, mMaxTextureSize, mUseANGLE, mUseDComp,
-                       mUseTripleBuffering, mSyncHandle);
+                       mUseTripleBuffering, mSyncHandle, mRenderRoot);
   renderApi->mRootApi = this;  // Hold root api
   renderApi->mRootDocumentApi = this;
   return renderApi.forget();
 }
 
 already_AddRefed<WebRenderAPI> WebRenderAPI::CreateDocument(
-    LayoutDeviceIntSize aSize, int8_t aLayerIndex) {
+    LayoutDeviceIntSize aSize, int8_t aLayerIndex, wr::RenderRoot aRenderRoot) {
   wr::FramebufferIntSize wrSize;
   wrSize.width = aSize.width;
   wrSize.height = aSize.height;
   wr::DocumentHandle* newDoc;
 
-  wr_api_create_document(mDocHandle, &newDoc, wrSize, aLayerIndex);
+  wr_api_create_document(mDocHandle, &newDoc, wrSize, aLayerIndex,
+                         (uint32_t)aRenderRoot);
 
-  RefPtr<WebRenderAPI> api(new WebRenderAPI(newDoc, mId, mMaxTextureSize,
-                                            mUseANGLE, mUseDComp,
-                                            mUseTripleBuffering, mSyncHandle));
+  RefPtr<WebRenderAPI> api(
+      new WebRenderAPI(newDoc, mId, mMaxTextureSize, mUseANGLE, mUseDComp,
+                       mUseTripleBuffering, mSyncHandle, aRenderRoot));
   api->mRootApi = this;
   return api.forget();
 }
@@ -312,6 +318,21 @@
   return wr_api_get_namespace(mDocHandle);
 }
 
+WebRenderAPI::WebRenderAPI(wr::DocumentHandle* aHandle, wr::WindowId aId,
+                           uint32_t aMaxTextureSize, bool aUseANGLE,
+                           bool aUseDComp, bool aUseTripleBuffering,
+                           layers::SyncHandle aSyncHandle,
+                           wr::RenderRoot aRenderRoot)
+    : mDocHandle(aHandle),
+      mId(aId),
+      mMaxTextureSize(aMaxTextureSize),
+      mUseANGLE(aUseANGLE),
+      mUseDComp(aUseDComp),
+      mUseTripleBuffering(aUseTripleBuffering),
+      mSyncHandle(aSyncHandle),
+      mDebugFlags({0}),
+      mRenderRoot(aRenderRoot) {}
+
 WebRenderAPI::~WebRenderAPI() {
   if (!mRootDocumentApi) {
     wr_api_delete_document(mDocHandle);
@@ -645,9 +666,13 @@
 
 DisplayListBuilder::DisplayListBuilder(PipelineId aId,
                                        const wr::LayoutSize& aContentSize,
-                                       size_t aCapacity)
+                                       size_t aCapacity, RenderRoot aRenderRoot)
     : mCurrentSpaceAndClipChain(wr::RootScrollNodeWithChain()),
-      mActiveFixedPosTracker(nullptr) {
+      mActiveFixedPosTracker(nullptr),
+      mPipelineId(aId),
+      mContentSize(aContentSize),
+      mRenderRoot(aRenderRoot),
+      mSendSubBuilderDisplayList(aRenderRoot == wr::RenderRoot::Default) {
   MOZ_COUNT_CTOR(DisplayListBuilder);
   mWrState = wr_state_new(aId, aContentSize, aCapacity);
 }
@@ -661,6 +686,31 @@
 void DisplayListBuilder::Restore() { wr_dp_restore(mWrState); }
 void DisplayListBuilder::ClearSave() { wr_dp_clear_save(mWrState); }
 
+DisplayListBuilder& DisplayListBuilder::CreateSubBuilder(
+    const wr::LayoutSize& aContentSize, size_t aCapacity,
+    wr::RenderRoot aRenderRoot) {
+  MOZ_ASSERT(mRenderRoot == wr::RenderRoot::Default);
+  MOZ_ASSERT(!mSubBuilders[aRenderRoot]);
+  mSubBuilders[aRenderRoot] = MakeUnique<DisplayListBuilder>(
+      mPipelineId, aContentSize, aCapacity, aRenderRoot);
+  return *mSubBuilders[aRenderRoot];
+}
+
+DisplayListBuilder& DisplayListBuilder::SubBuilder(RenderRoot aRenderRoot) {
+  if (aRenderRoot == mRenderRoot) {
+    return *this;
+  }
+  return *mSubBuilders[aRenderRoot];
+}
+
+bool DisplayListBuilder::HasSubBuilder(RenderRoot aRenderRoot) {
+  if (aRenderRoot == RenderRoot::Default) {
+    MOZ_ASSERT(mRenderRoot == RenderRoot::Default);
+    return true;
+  }
+  return !!mSubBuilders[aRenderRoot];
+}
+
 usize DisplayListBuilder::Dump(usize aIndent, const Maybe<usize>& aStart,
                                const Maybe<usize>& aEnd) {
   return wr_dump_display_list(mWrState, aIndent, aStart.ptrOr(nullptr),
@@ -673,6 +723,19 @@
                           &aOutDisplayList.dl.inner);
 }
 
+void DisplayListBuilder::Finalize(
+    layers::RenderRootDisplayListData& aOutTransaction) {
+  MOZ_ASSERT(mRenderRoot == wr::RenderRoot::Default);
+  wr::VecU8 dl;
+  wr_api_finalize_builder(SubBuilder(aOutTransaction.mRenderRoot).mWrState,
+                          &aOutTransaction.mContentSize,
+                          &aOutTransaction.mDLDesc, &dl.inner);
+  aOutTransaction.mDL =
+      ipc::ByteBuf(dl.inner.data, dl.inner.length, dl.inner.capacity);
+  dl.inner.capacity = 0;
+  dl.inner.data = nullptr;
+}
+
 Maybe<wr::WrSpatialId> DisplayListBuilder::PushStackingContext(
     const wr::StackingContextParams& aParams, const wr::LayoutRect& aBounds,
     const wr::RasterSpace& aRasterSpace) {