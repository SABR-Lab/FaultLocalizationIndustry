# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/webrender_bindings/WebRenderAPI.h
# Commit: c09a51622e98
# Full Hash: c09a51622e988e81077c75e3aaa5a49df66284b3
# Author: Doug Thayer <dothayer@mozilla.com>
# Date: 2019-03-22 16:44:08
# Regressor Bug: 1441308
# File Overlap Count: 2
# Description:
#   Bug 1441308 - Core renderroot splitting changes r=kats,sotaro
#   
#   This is a large patch that contains all of the core changes for
#   renderroot splitting.
#   
# ==============================================================================

diff -r 737807563dd5 -r c09a51622e98 gfx/webrender_bindings/WebRenderAPI.h
--- a/gfx/webrender_bindings/WebRenderAPI.h	Thu Mar 21 23:14:26 2019 +0000
+++ b/gfx/webrender_bindings/WebRenderAPI.h	Fri Mar 22 03:15:14 2019 +0000
@@ -37,6 +37,7 @@
 class CompositorBridgeParent;
 class WebRenderBridgeParent;
 class RenderRootStateManager;
+struct RenderRootDisplayListData;
 }  // namespace layers
 
 namespace layout {
@@ -103,7 +104,8 @@
       const nsTArray<wr::WrOpacityProperty>& aOpacityArray,
       const nsTArray<wr::WrTransformProperty>& aTransformArray);
 
-  void SetDocumentView(const LayoutDeviceIntRect& aDocRect);
+  void SetDocumentView(const LayoutDeviceIntRect& aDocRect,
+                       const LayoutDeviceIntSize& aWidgetSize);
 
   void UpdateScrollPosition(
       const wr::WrPipelineId& aPipelineId,
@@ -208,7 +210,8 @@
       const wr::WrWindowId& aWindowId, LayoutDeviceIntSize aSize);
 
   already_AddRefed<WebRenderAPI> CreateDocument(LayoutDeviceIntSize aSize,
-                                                int8_t aLayerIndex);
+                                                int8_t aLayerIndex,
+                                                wr::RenderRoot aRenderRoot);
 
   already_AddRefed<WebRenderAPI> Clone();
 
@@ -239,6 +242,7 @@
   void AccumulateMemoryReport(wr::MemoryReport*);
 
   wr::WrIdNamespace GetNamespace();
+  wr::RenderRoot GetRenderRoot() const { return mRenderRoot; }
   uint32_t GetMaxTextureSize() const { return mMaxTextureSize; }
   bool GetUseANGLE() const { return mUseANGLE; }
   bool GetUseDComp() const { return mUseDComp; }
@@ -249,16 +253,9 @@
 
  protected:
   WebRenderAPI(wr::DocumentHandle* aHandle, wr::WindowId aId,
-               int32_t aMaxTextureSize, bool aUseANGLE, bool aUseDComp,
-               bool aUseTripleBuffering, layers::SyncHandle aSyncHandle)
-      : mDocHandle(aHandle),
-        mId(aId),
-        mMaxTextureSize(aMaxTextureSize),
-        mUseANGLE(aUseANGLE),
-        mUseDComp(aUseDComp),
-        mUseTripleBuffering(aUseTripleBuffering),
-        mSyncHandle(aSyncHandle),
-        mDebugFlags({0}) {}
+               uint32_t aMaxTextureSize, bool aUseANGLE, bool aUseDComp,
+               bool aUseTripleBuffering, layers::SyncHandle aSyncHandle,
+               wr::RenderRoot aRenderRoot);
 
   ~WebRenderAPI();
   // Should be used only for shutdown handling
@@ -274,6 +271,7 @@
   bool mUseTripleBuffering;
   layers::SyncHandle mSyncHandle;
   wr::DebugFlags mDebugFlags;
+  wr::RenderRoot mRenderRoot;
 
   // We maintain alive the root api to know when to shut the render backend
   // down, and the root api for the document to know when to delete the
@@ -352,7 +350,8 @@
  public:
   explicit DisplayListBuilder(wr::PipelineId aId,
                               const wr::LayoutSize& aContentSize,
-                              size_t aCapacity = 0);
+                              size_t aCapacity = 0,
+                              RenderRoot aRenderRoot = RenderRoot::Default);
   DisplayListBuilder(DisplayListBuilder&&) = default;
 
   ~DisplayListBuilder();
@@ -363,8 +362,28 @@
   usize Dump(usize aIndent, const Maybe<usize>& aStart,
              const Maybe<usize>& aEnd);
 
-  void Finalize(wr::LayoutSize& aOutContentSize,
+  void Finalize(wr::LayoutSize& aOutContentSizes,
                 wr::BuiltDisplayList& aOutDisplayList);
+  void Finalize(layers::RenderRootDisplayListData& aOutTransaction);
+
+  RenderRoot GetRenderRoot() const { return mRenderRoot; }
+  bool HasSubBuilder(RenderRoot aRenderRoot);
+  DisplayListBuilder& CreateSubBuilder(const wr::LayoutSize& aContentSize,
+                                       size_t aCapacity,
+                                       RenderRoot aRenderRoot);
+  DisplayListBuilder& SubBuilder(RenderRoot aRenderRoot);
+
+  bool GetSendSubBuilderDisplayList(RenderRoot aRenderRoot) {
+    if (aRenderRoot == RenderRoot::Default) {
+      return true;
+    }
+    return mSubBuilders[aRenderRoot] &&
+           mSubBuilders[aRenderRoot]->mSendSubBuilderDisplayList;
+  }
+
+  void SetSendSubBuilderDisplayList(RenderRoot aRenderRoot) {
+    mSubBuilders[aRenderRoot]->mSendSubBuilderDisplayList = true;
+  }
 
   Maybe<wr::WrSpatialId> PushStackingContext(
       const StackingContextParams& aParams, const wr::LayoutRect& aBounds,
@@ -593,6 +612,13 @@
 
   FixedPosScrollTargetTracker* mActiveFixedPosTracker;
 
+  NonDefaultRenderRootArray<UniquePtr<DisplayListBuilder>> mSubBuilders;
+  wr::PipelineId mPipelineId;
+  wr::LayoutSize mContentSize;
+
+  RenderRoot mRenderRoot;
+  bool mSendSubBuilderDisplayList;
+
   friend class WebRenderAPI;
   friend class SpaceAndClipChainHelper;
 };