# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/remoteworkers/RemoteWorkerChild.h
# Commit: e6e7b9953ede
# Full Hash: e6e7b9953ede5e1435019e9ee80441ba144fab11
# Author: Yaron Tausky <ytausky@mozilla.com>
# Date: 2019-03-15 03:42:43
# Regressor Bug: 1530223
# File Overlap Count: 1
# Description:
#   Bug 1530223 - Guard RemoteWorkerChild's shared data with a mutex r=perry,asuth
#   
#   Reading and writing data without synchronization from multiple threads
#   is undefined behavior.
#   
# ==============================================================================

diff -r 4fd7ce83efe1 -r e6e7b9953ede dom/workers/remoteworkers/RemoteWorkerChild.h
--- a/dom/workers/remoteworkers/RemoteWorkerChild.h	Thu Mar 14 20:18:33 2019 +0000
+++ b/dom/workers/remoteworkers/RemoteWorkerChild.h	Thu Mar 14 20:19:18 2019 +0000
@@ -8,6 +8,7 @@
 #define mozilla_dom_RemoteWorkerChild_h
 
 #include "mozilla/dom/PRemoteWorkerChild.h"
+#include "mozilla/DataMutex.h"
 #include "mozilla/ThreadBound.h"
 #include "mozilla/UniquePtr.h"
 #include "nsISupportsImpl.h"
@@ -56,6 +57,13 @@
 
   mozilla::ipc::IPCResult RecvExecOp(const RemoteWorkerOp& aOp);
 
+  // This member is a function template because DataMutex<SharedData>::AutoLock
+  // is private, yet it must be passed by const reference into ExecuteOperation.
+  // There should only be one instantiation of this template.
+  template <typename T>
+  mozilla::ipc::IPCResult ExecuteOperation(const RemoteWorkerOp&,
+                                           const T& aLock);
+
   void RecvExecOpOnMainThread(const RemoteWorkerOp& aOp);
 
   nsresult ExecWorkerOnMainThread(const RemoteWorkerData& aData);
@@ -77,7 +85,6 @@
   // Touched on main-thread only.
   nsTArray<uint64_t> mWindowIDs;
 
-  RefPtr<WorkerPrivate> mWorkerPrivate;
   RefPtr<WeakWorkerRef> mWorkerRef;
   bool mIPCActive;
 
@@ -96,8 +103,14 @@
     eTerminated,
   };
 
-  // Touched only on the owning thread (Worker Launcher).
-  WorkerState mWorkerState;
+  struct SharedData {
+    SharedData();
+
+    RefPtr<WorkerPrivate> mWorkerPrivate;
+    WorkerState mWorkerState;
+  };
+
+  DataMutex<SharedData> mSharedData;
 
   // Touched only on the owning thread (Worker Launcher).
   struct LauncherBoundData {
