# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/ipc/TabChild.cpp
# Commit: 1ba9a2cebf12
# Full Hash: 1ba9a2cebf1252ffc1af89e3e978cf4b47fcb46e
# Author: Barret Rennie <barret@brennie.ca>
# Date: 2019-04-04 04:33:36
# Regressor Bug: 1510569
# File Overlap Count: 1
# Description:
#   Bug 1510569 - Filter TabChild nsIWebProgress events through a nsBrowserFilter r=kmag
#   
#   The implementation of WebProgressChild.jsm filters all nsIWebProgress events
#   through an nsBrowserFilter. We need to do this in the TabChild as well, but
#   TabChild currently only handles onContentBlockingEvent, for which
# ==============================================================================

diff -r a928d7bd9427 -r 1ba9a2cebf12 dom/ipc/TabChild.cpp
--- a/dom/ipc/TabChild.cpp	Wed Apr 03 17:28:56 2019 +0000
+++ b/dom/ipc/TabChild.cpp	Wed Apr 03 17:29:15 2019 +0000
@@ -60,6 +60,7 @@
 #include "mozilla/TextEvents.h"
 #include "mozilla/TouchEvents.h"
 #include "mozilla/Unused.h"
+#include "nsBrowserStatusFilter.h"
 #include "nsContentUtils.h"
 #include "nsDocShell.h"
 #include "nsEmbedCID.h"
@@ -381,7 +382,6 @@
       mIgnoreKeyPressEvent(false),
       mHasValidInnerSize(false),
       mDestroyed(false),
-      mProgressListenerRegistered(false),
       mUniqueId(aTabId),
       mHasSiblings(false),
       mIsTransparent(false),
@@ -540,11 +540,22 @@
   nsCOMPtr<nsIDocShell> docShell = do_GetInterface(WebNavigation());
   MOZ_ASSERT(docShell);
 
-  nsCOMPtr<nsIWebProgress> webProgress = do_QueryInterface(docShell);
-  nsresult rv = webProgress->AddProgressListener(
-      this, nsIWebProgress::NOTIFY_CONTENT_BLOCKING);
+  const uint32_t notifyMask = nsIWebProgress::NOTIFY_CONTENT_BLOCKING;
+
+  mStatusFilter = new nsBrowserStatusFilter();
+
+  RefPtr<nsIEventTarget> eventTarget =
+      TabGroup()->EventTargetFor(TaskCategory::Network);
+
+  mStatusFilter->SetTarget(eventTarget);
+  nsresult rv = mStatusFilter->AddProgressListener(this, notifyMask);
   NS_ENSURE_SUCCESS(rv, rv);
-  mProgressListenerRegistered = true;
+
+  {
+    nsCOMPtr<nsIWebProgress> webProgress = do_QueryInterface(docShell);
+    rv = webProgress->AddProgressListener(mStatusFilter, notifyMask);
+    NS_ENSURE_SUCCESS(rv, rv);
+  }
 
   docShell->SetAffectPrivateSessionLifetime(
       mChromeFlags & nsIWebBrowserChrome::CHROME_PRIVATE_LIFETIME);
@@ -634,11 +645,13 @@
 NS_IMPL_CYCLE_COLLECTION_CLASS(TabChild)
 
 NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(TabChild, TabChildBase)
+  NS_IMPL_CYCLE_COLLECTION_UNLINK(mStatusFilter)
   NS_IMPL_CYCLE_COLLECTION_UNLINK(mWebNav)
   NS_IMPL_CYCLE_COLLECTION_UNLINK(mBrowsingContext)
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(TabChild, TabChildBase)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mStatusFilter)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mWebNav)
   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mBrowsingContext)
 NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
@@ -930,6 +943,16 @@
     mBrowsingContext = nullptr;
   }
 
+  if (mStatusFilter) {
+    if (nsCOMPtr<nsIWebProgress> webProgress =
+            do_QueryInterface(WebNavigation())) {
+      webProgress->RemoveProgressListener(mStatusFilter);
+    }
+
+    mStatusFilter->RemoveProgressListener(this);
+    mStatusFilter = nullptr;
+  }
+
   if (mCoalescedMouseEventFlusher) {
     mCoalescedMouseEventFlusher->RemoveObserver();
     mCoalescedMouseEventFlusher = nullptr;
@@ -963,14 +986,6 @@
     }
     mLayersId = layers::LayersId{0};
   }
-
-  if (mProgressListenerRegistered) {
-    nsCOMPtr<nsIWebProgress> webProgress = do_QueryInterface(WebNavigation());
-    if (webProgress) {
-      webProgress->RemoveProgressListener(this);
-      mProgressListenerRegistered = false;
-    }
-  }
 }
 
 void TabChild::ActorDestroy(ActorDestroyReason why) {