# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/ipc/TabChild.cpp
# Commit: e1fbefe38944
# Full Hash: e1fbefe38944eb82d3c2e87a0307b121daf0e830
# Author: Barret Rennie <barret@brennie.ca>
# Date: 2019-04-04 04:33:36
# Regressor Bug: 1510569
# File Overlap Count: 1
# Description:
#   Bug 1510569 - Port onProgressChange notifications inside WebProgressChild.jsm to C++ r=baku
#   
#   We do not need to handle onProgressChange64 notifications since the TabChild's
#   web progress events are filtered through an nsBrowserStatusFilter, which
#   truncates onProgresChange64 event values to 32-bit integers and then calls
# ==============================================================================

diff -r 102881458323 -r e1fbefe38944 dom/ipc/TabChild.cpp
--- a/dom/ipc/TabChild.cpp	Wed Apr 03 17:32:21 2019 +0000
+++ b/dom/ipc/TabChild.cpp	Wed Apr 03 17:32:41 2019 +0000
@@ -540,8 +540,9 @@
   nsCOMPtr<nsIDocShell> docShell = do_GetInterface(WebNavigation());
   MOZ_ASSERT(docShell);
 
-  const uint32_t notifyMask =
-      nsIWebProgress::NOTIFY_STATUS | nsIWebProgress::NOTIFY_CONTENT_BLOCKING;
+  const uint32_t notifyMask = nsIWebProgress::NOTIFY_PROGRESS |
+                              nsIWebProgress::NOTIFY_STATUS |
+                              nsIWebProgress::NOTIFY_CONTENT_BLOCKING;
 
   mStatusFilter = new nsBrowserStatusFilter();
 
@@ -3289,7 +3290,22 @@
                                          int32_t aMaxSelfProgress,
                                          int32_t aCurTotalProgress,
                                          int32_t aMaxTotalProgress) {
-  return NS_ERROR_NOT_IMPLEMENTED;
+  if (!IPCOpen()) {
+    return NS_OK;
+  }
+
+  Maybe<WebProgressData> webProgressData;
+  RequestData requestData;
+
+  nsresult rv = PrepareProgressListenerData(aWebProgress, aRequest,
+                                            webProgressData, requestData);
+  NS_ENSURE_SUCCESS(rv, rv);
+
+  Unused << SendOnProgressChange(webProgressData, requestData, aCurSelfProgress,
+                                 aMaxSelfProgress, aCurTotalProgress,
+                                 aMaxTotalProgress);
+
+  return NS_OK;
 }
 
 NS_IMETHODIMP TabChild::OnLocationChange(nsIWebProgress* aWebProgress,
@@ -3348,6 +3364,9 @@
                                            int64_t aMaxSelfProgress,
                                            int64_t aCurTotalProgress,
                                            int64_t aMaxTotalProgress) {
+  // All the events we receive are filtered through an nsBrowserStatusFilter,
+  // which accepts ProgressChange64 events, but truncates the progress values to
+  // uint32_t and calls OnProgressChange.
   return NS_ERROR_NOT_IMPLEMENTED;
 }
 