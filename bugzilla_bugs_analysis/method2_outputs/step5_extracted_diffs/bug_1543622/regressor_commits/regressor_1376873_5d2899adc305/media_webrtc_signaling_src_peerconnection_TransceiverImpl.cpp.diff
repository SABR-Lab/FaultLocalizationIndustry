# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/src/peerconnection/TransceiverImpl.cpp
# Commit: 5d2899adc305
# Full Hash: 5d2899adc3057fe4df9dd454887c1832f54d91d9
# Author: Dan Minor <dminor@mozilla.com>
# Date: 2018-11-09 10:01:40
# Regressor Bug: 1376873
# File Overlap Count: 4
# Description:
#   Bug 1376873 - Use Call interface in AudioConduit; r=padenot
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D7441
# ==============================================================================

diff -r df960ea2d29e -r 5d2899adc305 media/webrtc/signaling/src/peerconnection/TransceiverImpl.cpp
--- a/media/webrtc/signaling/src/peerconnection/TransceiverImpl.cpp	Mon Mar 26 16:19:23 2018 -0400
+++ b/media/webrtc/signaling/src/peerconnection/TransceiverImpl.cpp	Tue Aug 21 13:39:53 2018 -0400
@@ -81,7 +81,7 @@
 void
 TransceiverImpl::InitAudio()
 {
-  mConduit = AudioSessionConduit::Create();
+  mConduit = AudioSessionConduit::Create(mCallWrapper, mStsThread);
 
   if (!mConduit) {
     MOZ_MTLOG(ML_ERROR, mPCHandle << "[" << mMid << "]: " << __FUNCTION__ <<
@@ -711,6 +711,13 @@
   RefPtr<AudioSessionConduit> conduit = static_cast<AudioSessionConduit*>(
       mConduit.get());
 
+  if (!mJsepTransceiver->mRecvTrack.GetSsrcs().empty()) {
+    MOZ_MTLOG(ML_DEBUG, mPCHandle << "[" << mMid << "]: " << __FUNCTION__ <<
+              " Setting remote SSRC " <<
+              mJsepTransceiver->mRecvTrack.GetSsrcs().front());
+    conduit->SetRemoteSSRC(mJsepTransceiver->mRecvTrack.GetSsrcs().front());
+  }
+
   if (mJsepTransceiver->mRecvTrack.GetNegotiatedDetails() &&
       mJsepTransceiver->mRecvTrack.GetActive()) {
     const auto& details(*mJsepTransceiver->mRecvTrack.GetNegotiatedDetails());
@@ -724,6 +731,9 @@
       return rv;
     }
 
+    // Ensure conduit knows about extensions prior to creating streams
+    UpdateConduitRtpExtmap(details, LocalDirection::kRecv);
+
     auto error = conduit->ConfigureRecvMediaCodecs(configs);
 
     if (error) {
@@ -731,7 +741,6 @@
                           " ConfigureRecvMediaCodecs failed: " << error);
       return NS_ERROR_FAILURE;
     }
-    UpdateConduitRtpExtmap(details, LocalDirection::kRecv);
   }
 
   if (mJsepTransceiver->mSendTrack.GetNegotiatedDetails() &&