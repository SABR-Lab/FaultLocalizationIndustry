# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: security/sandbox/linux/Sandbox.cpp
# Commit: 75d2b35c092f
# Full Hash: 75d2b35c092f4b77c3855569e5dd8b6803e8e914
# Author: Jed Davis <jld@mozilla.com>
# Date: 2019-04-17 15:54:01
# Description:
#   Bug 1543790 - Fix RDD sandboxing conditions so the parent and child processes agree. r=gcp
#   
#   If the system doesn't support seccomp-bpf, the parent process won't
#   try to set up sandboxing, but the child process has a separate check that
#   didn't test for this, and ends up failing a release assertion (in
# ==============================================================================

diff -r 01d9700306a4 -r 75d2b35c092f security/sandbox/linux/Sandbox.cpp
--- a/security/sandbox/linux/Sandbox.cpp	Tue Apr 16 06:50:50 2019 +0000
+++ b/security/sandbox/linux/Sandbox.cpp	Tue Apr 16 13:53:20 2019 +0000
@@ -652,7 +652,8 @@
 }
 
 void SetRemoteDataDecoderSandbox(int aBroker) {
-  if (PR_GetEnv("MOZ_DISABLE_RDD_SANDBOX") != nullptr) {
+  if (!SandboxInfo::Get().Test(SandboxInfo::kHasSeccompBPF) ||
+      PR_GetEnv("MOZ_DISABLE_RDD_SANDBOX")) {
     if (aBroker >= 0) {
       close(aBroker);
     }
