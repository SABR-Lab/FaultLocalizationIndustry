# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/JSObject.cpp
# Commit: ac1601914ac5
# Full Hash: ac1601914ac513fbf769bf9ebc4d900699ae7017
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2019-03-09 21:53:19
# Regressor Bug: 1403679
# File Overlap Count: 1
# Description:
#   Bug 1403679: Provide a shell testing function for JS_TransplantObject. r=jandem
# ==============================================================================

diff -r b486ad6d8c06 -r ac1601914ac5 js/src/vm/JSObject.cpp
--- a/js/src/vm/JSObject.cpp	Sat Mar 09 11:47:52 2019 +0200
+++ b/js/src/vm/JSObject.cpp	Fri Oct 20 11:32:22 2017 +0100
@@ -1357,7 +1357,10 @@
 
   RootedObject clone(cx);
   if (obj->isNative()) {
-    clone = NewObjectWithGivenTaggedProto(cx, obj->getClass(), proto);
+    // CloneObject is used to create the target object for JSObject::swap() and
+    // swap() requires its arguments are tenured, so ensure tenure allocation.
+    clone = NewObjectWithGivenTaggedProto(cx, obj->getClass(), proto,
+                                          NewObjectKind::TenuredObject);
     if (!clone) {
       return nullptr;
     }
@@ -1377,8 +1380,17 @@
     ProxyOptions options;
     options.setClass(obj->getClass());
 
-    clone = ProxyObject::New(cx, GetProxyHandler(obj), JS::NullHandleValue,
-                             proto, options);
+    auto* handler = GetProxyHandler(obj);
+
+    // Same as above, require tenure allocation of the clone. This means for
+    // proxy objects we need to reject nursery allocatable proxies.
+    if (handler->canNurseryAllocate()) {
+      JS_ReportErrorNumberASCII(cx, GetErrorMessage, nullptr,
+                                JSMSG_CANT_CLONE_OBJECT);
+      return nullptr;
+    }
+
+    clone = ProxyObject::New(cx, handler, JS::NullHandleValue, proto, options);
     if (!clone) {
       return nullptr;
     }
