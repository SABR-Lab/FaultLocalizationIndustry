# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLContextExtensions.cpp
# Commit: ff14d3c64e53
# Full Hash: ff14d3c64e53dad7b4720c983b8f19bb494ed28a
# Author: Ehsan Akhgari <ehsan@mozilla.com>
# Date: 2019-03-06 04:36:55
# Regressor Bug: 1532414
# File Overlap Count: 1
# Description:
#   Bug 1532414 - Pass a document/principal pointer to nsContentUtils::ShouldResistFingerprinting() callers in the canvas API; r=baku
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D22002
# ==============================================================================

diff -r 14b6b6f8a599 -r ff14d3c64e53 dom/canvas/WebGLContextExtensions.cpp
--- a/dom/canvas/WebGLContextExtensions.cpp	Tue Mar 05 12:42:51 2019 +0000
+++ b/dom/canvas/WebGLContextExtensions.cpp	Tue Mar 05 12:42:51 2019 +0000
@@ -107,6 +107,15 @@
 bool WebGLContext::IsExtensionSupported(WebGLExtensionID ext) const {
   if (mDisableExtensions) return false;
 
+  bool shouldResistFingerprinting =
+      mCanvasElement ?
+                     // If we're constructed from a canvas element
+          nsContentUtils::ShouldResistFingerprinting(GetOwnerDoc())
+                     :
+                     // If we're constructed from an offscreen canvas
+          nsContentUtils::ShouldResistFingerprinting(
+              mOffscreenCanvas->GetOwnerGlobal()->PrincipalOrNull());
+
   switch (ext) {
     // In alphabetical order
     // ANGLE_
@@ -201,10 +210,10 @@
 
     case WebGLExtensionID::WEBGL_debug_renderer_info:
       return Preferences::GetBool("webgl.enable-debug-renderer-info", false) &&
-             !nsContentUtils::ShouldResistFingerprinting();
+             !shouldResistFingerprinting;
 
     case WebGLExtensionID::WEBGL_debug_shaders:
-      return !nsContentUtils::ShouldResistFingerprinting();
+      return !shouldResistFingerprinting;
 
     case WebGLExtensionID::WEBGL_depth_texture:
       return WebGLExtensionDepthTexture::IsSupported(this);