# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/AsyncIteration.cpp
# Commit: b86f47596771
# Full Hash: b86f47596771c90b024b235a8c29ed16438bf94c
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2019-03-27 04:44:00
# Regressor Bug: 1530754
# File Overlap Count: 1
# Description:
#   Bug 1530754 - Part 3: Don't create unnecessary iterator result objects in async generators. r=arai
#   
#   Per spec, IteratorValue() must be called outside of the implicit try-catch-finally
#   block in yield*. But when IteratorValue is already called in the generated byte
#   code for yield*, we no longer have an iterator result object to pass back to
# ==============================================================================

diff -r 98c9901e6ca6 -r b86f47596771 js/src/vm/AsyncIteration.cpp
--- a/js/src/vm/AsyncIteration.cpp	Tue Mar 26 16:25:37 2019 +0000
+++ b/js/src/vm/AsyncIteration.cpp	Tue Mar 26 16:26:42 2019 +0000
@@ -381,30 +381,13 @@
     return AsyncGeneratorAwait(cx, asyncGenObj, thisOrRval);
   }
 
-  // The following code corresponds to the following 3 cases:
-  //   * yield
-  //   * yield*
-  //   * return
-  // For yield and return, property access is done on an internal result
-  // object and it's not observable.
-  // For yield*, it's done on a possibly user-provided result object, and
-  // it's observable.
-  //
-  // Note that IteratorComplete steps in 8.2.1 are done in bytecode.
-
-  // 8.2.1 yield* steps 6.a.vii, 6.b.ii.7, 6.c.ix.
-  RootedObject resultObj(cx, &thisOrRval.toObject());
-  RootedValue value(cx);
-  if (!GetProperty(cx, resultObj, resultObj, cx->names().value, &value)) {
-    return false;
+  // 25.5.3.7, steps 5-6, 9.
+  if (asyncGenObj->isAfterYield()) {
+    return AsyncGeneratorYield(cx, asyncGenObj, thisOrRval);
   }
 
-  if (asyncGenObj->isAfterYield()) {
-    return AsyncGeneratorYield(cx, asyncGenObj, value);
-  }
-
-  // 11.4.3.2 step 5.d-g.
-  return AsyncGeneratorReturned(cx, asyncGenObj, value);
+  // 25.5.3.2, steps 5.d-g.
+  return AsyncGeneratorReturned(cx, asyncGenObj, thisOrRval);
 }
 
 static const JSFunctionSpec async_iterator_proto_methods[] = {