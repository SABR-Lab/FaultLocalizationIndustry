# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/wr/webrender/src/batch.rs
# Commit: fb1438de2bbf
# Full Hash: fb1438de2bbf5b26b5d01d678e6559e9e90522b1
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2019-05-01 15:57:23
# Regressor Bug: 1540200
# File Overlap Count: 1
# Description:
#   Bug 1540200 - Part 1. Move picture local rect calculation to update visibility. r=kvark
#   
#   We currently calculate a picture's local rect when we are doing the
#   first picture traversal. It was composed of the union of the clipped
#   local rects of its children. However the true local rect of a picture is
# ==============================================================================

diff -r 0353393f9465 -r fb1438de2bbf gfx/wr/webrender/src/batch.rs
--- a/gfx/wr/webrender/src/batch.rs	Tue Apr 30 21:20:13 2019 +0100
+++ b/gfx/wr/webrender/src/batch.rs	Wed Apr 10 12:35:20 2019 -0400
@@ -981,7 +981,7 @@
                 let prim_cache_address = gpu_cache.get_address(&ctx.globals.default_image_handle);
 
                 let prim_header = PrimitiveHeader {
-                    local_rect: picture.local_rect,
+                    local_rect: picture.snapped_local_rect,
                     local_clip_rect: prim_info.combined_local_clip_rect,
                     task_address,
                     specific_prim_address: prim_cache_address,
@@ -1019,7 +1019,7 @@
                             ).unwrap_or(OPAQUE_TASK_ADDRESS);
 
                             let prim_header = PrimitiveHeader {
-                                local_rect: pic.local_rect,
+                                local_rect: pic.snapped_local_rect,
                                 local_clip_rect: prim_info.combined_local_clip_rect,
                                 task_address,
                                 specific_prim_address: GpuCacheAddress::invalid(),
@@ -1130,7 +1130,7 @@
                                 // the local bounds of the picture extend to within the edge tiles.
                                 let local_clip_rect = prim_info
                                     .combined_local_clip_rect
-                                    .intersection(&picture.local_rect)
+                                    .intersection(&picture.snapped_local_rect)
                                     .and_then(|rect| {
                                         rect.intersection(&tile_cache.local_clip_rect)
                                     });
@@ -1613,7 +1613,7 @@
                                 };
 
                                 let prim_header = PrimitiveHeader {
-                                    local_rect: picture.local_rect,
+                                    local_rect: picture.snapped_local_rect,
                                     local_clip_rect: prim_info.combined_local_clip_rect,
                                     task_address,
                                     specific_prim_address: prim_cache_address,