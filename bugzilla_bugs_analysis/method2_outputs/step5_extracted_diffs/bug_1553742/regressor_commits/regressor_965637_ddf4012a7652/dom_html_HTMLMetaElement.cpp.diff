# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/html/HTMLMetaElement.cpp
# Commit: ddf4012a7652
# Full Hash: ddf4012a7652e36d144fc43bc99335276deeafbe
# Author: Christoph Kerschbaumer <ckerschb@christophkerschbaumer.com>
# Date: 2019-05-22 03:40:58
# Regressor Bug: 965637
# File Overlap Count: 1
# Description:
#   Bug 965637: Move CSP from Principal into Client, part 1: backend changes. r=mccr8
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D27654
# ==============================================================================

diff -r 6c2047bc2f3e -r ddf4012a7652 dom/html/HTMLMetaElement.cpp
--- a/dom/html/HTMLMetaElement.cpp	Tue May 21 22:51:54 2019 +0000
+++ b/dom/html/HTMLMetaElement.cpp	Tue May 21 23:14:27 2019 +0000
@@ -96,9 +96,7 @@
           nsContentUtils::TrimWhitespace<nsContentUtils::IsHTMLWhitespace>(
               content);
 
-      nsIPrincipal* principal = aDocument->NodePrincipal();
-      nsCOMPtr<nsIContentSecurityPolicy> csp;
-      principal->EnsureCSP(aDocument, getter_AddRefs(csp));
+      nsCOMPtr<nsIContentSecurityPolicy> csp = aDocument->GetCsp();
       if (csp) {
         if (LOG_ENABLED()) {
           nsAutoCString documentURIspec;
@@ -122,6 +120,10 @@
                               false,  // csp via meta tag can not be report only
                               true);  // delivered through the meta tag
         NS_ENSURE_SUCCESS(rv, rv);
+        nsPIDOMWindowInner* inner = aDocument->GetInnerWindow();
+        if (inner) {
+          inner->SetCsp(csp);
+        }
         aDocument->ApplySettingsFromCSP(false);
       }
     }