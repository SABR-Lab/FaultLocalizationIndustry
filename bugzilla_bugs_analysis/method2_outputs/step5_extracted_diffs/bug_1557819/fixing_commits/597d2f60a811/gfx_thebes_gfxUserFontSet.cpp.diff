# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxUserFontSet.cpp
# Commit: 597d2f60a811
# Full Hash: 597d2f60a8113404a6d4675134039718f7e85730
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2019-06-08 09:39:25
# Description:
#   Bug 1557819 - Add a pref to disable async font sanitization, and disable it for now for running suspect code OMT. r=heycam
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D34241
# ==============================================================================

diff -r b596d98d59fd -r 597d2f60a811 gfx/thebes/gfxUserFontSet.cpp
--- a/gfx/thebes/gfxUserFontSet.cpp	Fri Jun 07 08:21:24 2019 +0000
+++ b/gfx/thebes/gfxUserFontSet.cpp	Fri Jun 07 23:35:26 2019 +0000
@@ -862,7 +862,18 @@
   // download successful, make platform font using font data
   if (NS_SUCCEEDED(aDownloadStatus) &&
       mFontDataLoadingState != LOADING_TIMED_OUT) {
-    LoadPlatformFontAsync(aFontData, aLength, aCallback);
+    if (StaticPrefs::gfx_downloadable_fonts_sanitize_omt()) {
+      LoadPlatformFontAsync(aFontData, aLength, aCallback);
+    } else {
+      bool loaded = LoadPlatformFontSync(aFontData, aLength);
+      aFontData = nullptr;
+      if (loaded) {
+        IncrementGeneration();
+        aCallback->FontLoadComplete();
+      } else {
+        FontLoadFailed(aCallback);
+      }
+    }
     return;
   }
 