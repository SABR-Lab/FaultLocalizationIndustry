# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/base/Document.cpp
# Commit: 9abe42390b6c
# Full Hash: 9abe42390b6c1bb52dc2ba7acdd16a71f86b8b89
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2019-06-12 12:02:49
# Description:
#   Bug 1558412 - Make `nsContentUtils::GetHTMLEditor()` null-check of the given `nsPresContext*` r=smaug
#   
#   Surprisingly, `Document::ExecCommand()` may be called when there is no
#   corresponding `nsPresContext`.  Then, `nsContentUtils::GetHTMLEditor()`
#   crashes because it does not check whether the argument is `nullptr` or not.
# ==============================================================================

diff -r 9b7d0410ba13 -r 9abe42390b6c dom/base/Document.cpp
--- a/dom/base/Document.cpp	Tue Jun 11 14:30:51 2019 +0000
+++ b/dom/base/Document.cpp	Wed Jun 12 01:58:01 2019 +0000
@@ -4328,17 +4328,19 @@
   //     <textarea> when it's in an editing host and has focus.  So, our
   //     traditional behavior is different and does not make sense.
   RefPtr<TextEditor> maybeHTMLEditor;
-  if (commandData.IsCutOrCopyCommand()) {
-    // Note that we used to use DocShell to handle `cut` and `copy` command
-    // for dispatching corresponding events for making possible web apps to
-    // implement their own editor without editable elements but supports
-    // standard shortcut keys, etc.  In this case, we prefer to use active
-    // element's editor to keep same behavior.
-    maybeHTMLEditor = nsContentUtils::GetActiveEditor(GetPresContext());
-  } else {
-    maybeHTMLEditor = nsContentUtils::GetHTMLEditor(GetPresContext());
-    if (!maybeHTMLEditor) {
-      maybeHTMLEditor = nsContentUtils::GetActiveEditor(GetPresContext());
+  if (nsPresContext* presContext = GetPresContext()) {
+    if (commandData.IsCutOrCopyCommand()) {
+      // Note that we used to use DocShell to handle `cut` and `copy` command
+      // for dispatching corresponding events for making possible web apps to
+      // implement their own editor without editable elements but supports
+      // standard shortcut keys, etc.  In this case, we prefer to use active
+      // element's editor to keep same behavior.
+      maybeHTMLEditor = nsContentUtils::GetActiveEditor(presContext);
+    } else {
+      maybeHTMLEditor = nsContentUtils::GetHTMLEditor(presContext);
+      if (!maybeHTMLEditor) {
+        maybeHTMLEditor = nsContentUtils::GetActiveEditor(presContext);
+      }
     }
   }
 