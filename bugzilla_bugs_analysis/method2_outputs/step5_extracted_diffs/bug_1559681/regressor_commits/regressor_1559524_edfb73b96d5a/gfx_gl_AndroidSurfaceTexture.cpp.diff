# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/gl/AndroidSurfaceTexture.cpp
# Commit: edfb73b96d5a
# Full Hash: edfb73b96d5ad946bbdd9da2e98d07b1f4565e1f
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2019-06-15 21:44:24
# Regressor Bug: 1559524
# File Overlap Count: 2
# Description:
#   Bug 1559524 - Reduce calls to GLLibraryEGL::Get(). r=lsalzman
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D35103
# ==============================================================================

diff -r 0378898329b2 -r edfb73b96d5a gfx/gl/AndroidSurfaceTexture.cpp
--- a/gfx/gl/AndroidSurfaceTexture.cpp	Sat Jun 15 05:14:53 2019 +0000
+++ b/gfx/gl/AndroidSurfaceTexture.cpp	Sat Jun 15 05:21:12 2019 +0000
@@ -76,7 +76,7 @@
     MutexAutoLock lock(sMutex);
 
     if (mTargetSurface != EGL_NO_SURFACE) {
-      const auto& egl = *GLLibraryEGL::Get();
+      const auto& egl = *(sContext->mEgl);
       egl.fDestroySurface(egl.Display(), mTargetSurface);
     }
 
@@ -92,13 +92,14 @@
 
     auto* egl = gl::GLLibraryEGL::Get();
     EGLDisplay eglDisplay = egl->fGetDisplay(EGL_DEFAULT_DISPLAY);
+    MOZ_ASSERT(eglDisplay == egl->Display());
     EGLConfig eglConfig;
-    CreateConfig(&eglConfig, /* bpp */ 24, /* depth buffer? */ false);
+    CreateConfig(egl, &eglConfig, /* bpp */ 24, /* depth buffer? */ false);
     EGLint attributes[] = {LOCAL_EGL_CONTEXT_CLIENT_VERSION, 2, LOCAL_EGL_NONE};
     EGLContext eglContext =
         egl->fCreateContext(eglDisplay, eglConfig, EGL_NO_CONTEXT, attributes);
     RefPtr<GLContextEGL> gl = new GLContextEGL(
-        CreateContextFlags::NONE, SurfaceCaps::Any(),
+        egl, CreateContextFlags::NONE, SurfaceCaps::Any(),
         /* offscreen? */ false, eglConfig, EGL_NO_SURFACE, eglContext);
     if (!gl->Init()) {
       NS_WARNING("Fail to create GL context for native blitter.");
@@ -114,8 +115,9 @@
     sMutex.AssertCurrentThreadOwns();
     MOZ_ASSERT(sContext);
 
-    mTargetSurface = gl::GLLibraryEGL::Get()->fCreateWindowSurface(
-        sContext->GetEGLDisplay(), sContext->mConfig, window.NativeWindow(), 0);
+    const auto& egl = *(sContext->mEgl);
+    mTargetSurface = egl.fCreateWindowSurface(egl.Display(), sContext->mConfig,
+                                              window.NativeWindow(), 0);
   }
 
   static bool UnmakeCurrent(RefPtr<GLContextEGL>& gl) {
@@ -125,9 +127,9 @@
     if (!gl->IsCurrent()) {
       return true;
     }
-    const auto& egl = *gl::GLLibraryEGL::Get();
-    return egl.fMakeCurrent(
-        egl.Display(), EGL_NO_SURFACE, EGL_NO_SURFACE, EGL_NO_CONTEXT);
+    const auto& egl = *(gl->mEgl);
+    return egl.fMakeCurrent(egl.Display(), EGL_NO_SURFACE, EGL_NO_SURFACE,
+                            EGL_NO_CONTEXT);
   }
 
   static Mutex sMutex;