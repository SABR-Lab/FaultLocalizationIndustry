# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: docshell/base/BrowsingContext.cpp
# Commit: 6c5ad42069d0
# Full Hash: 6c5ad42069d09a8bc8d8306ab4b21c00230091ec
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2019-07-09 03:44:14
# Description:
#   Bug 1563542 - Correctly align usage of mIsDiscarded and mClosed for BrowsingContext, r=peterv
#   
#   In the bug which introduced mIsDiscarded, the code was changed to not set
#   mClosed during Detach, and only set mIsDiscarded. This was a mistake because a
#   bunch of places are only reading mClosed. Specifically when creating a
# ==============================================================================

diff -r db4c8cbf463e -r 6c5ad42069d0 docshell/base/BrowsingContext.cpp
--- a/docshell/base/BrowsingContext.cpp	Fri Jul 05 22:08:13 2019 +0000
+++ b/docshell/base/BrowsingContext.cpp	Mon Jul 08 17:27:27 2019 +0000
@@ -65,6 +65,10 @@
   MOZ_DIAGNOSTIC_ASSERT(mGroup);
   mGroup->Unregister(this);
   mIsDiscarded = true;
+
+  // NOTE: Doesn't use SetClosed, as it will be set in all processes
+  // automatically by calls to Detach()
+  mClosed = true;
 }
 
 BrowsingContext* BrowsingContext::Top() {
@@ -327,7 +331,7 @@
            XRE_IsParentProcess() ? "Parent" : "Child", Id()));
 
   MOZ_ASSERT(mIsInProcess, "Must currently be an in-process frame");
-  MOZ_ASSERT(!mClosed, "We're already closed?");
+  MOZ_ASSERT(!mIsDiscarded, "We're already closed?");
 
   mIsInProcess = false;
 