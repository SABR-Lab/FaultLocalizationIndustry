# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: security/sandbox/chromium-shim/patches/after_update/change_to_DCHECK_in_CloseHandleWrapper.patch
# Commit: 80fff55bee77
# Full Hash: 80fff55bee77ccef9b884556668e69efded13bae
# Author: Bob Owen <bobowencode@gmail.com>
# Date: 2019-07-16 04:07:00
# Description:
#   Bug 1564899: Make CloseHandleWrapper CHECK a DCHECK on non-Nightly builds. r=handyman
#   
#   This is because we are hitting it frequently during PolicyBase::OnJobEmpty and
#   currently we can't work out how this can happen.
#   
# ==============================================================================

diff -r 262f4fd60398 -r 80fff55bee77 security/sandbox/chromium-shim/patches/after_update/change_to_DCHECK_in_CloseHandleWrapper.patch
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/security/sandbox/chromium-shim/patches/after_update/change_to_DCHECK_in_CloseHandleWrapper.patch	Mon Jul 15 17:19:17 2019 +0000
@@ -0,0 +1,38 @@
+# HG changeset patch
+# User Bob Owen <bobowencode@gmail.com>
+# Date 1563194469 -3600
+#      Mon Jul 15 13:41:09 2019 +0100
+# Node ID 6d4e1a08b36e4191bd5ba7a338965f42f09162a6
+# Parent  7d9b5d8c9b9b36b135237292785537fc13f40226
+Bug 1564899: Make CloseHandleWrapper CHECK a DCHECK on non-Nightly builds. r=handyman!
+
+This is because we are hitting it frequently during PolicyBase::OnJobEmpty and
+currently we can't work out how this can happen.
+
+diff --git a/security/sandbox/chromium/base/win/scoped_handle_verifier.cc b/security/sandbox/chromium/base/win/scoped_handle_verifier.cc
+--- a/security/sandbox/chromium/base/win/scoped_handle_verifier.cc
++++ b/security/sandbox/chromium/base/win/scoped_handle_verifier.cc
+@@ -65,17 +65,23 @@ ScopedHandleVerifier* ScopedHandleVerifi
+   if (!g_active_verifier)
+     ScopedHandleVerifier::InstallVerifier();
+ 
+   return g_active_verifier;
+ }
+ 
+ bool CloseHandleWrapper(HANDLE handle) {
+   if (!::CloseHandle(handle))
++    // Making this DCHECK on non-Nighly as we are hitting this frequently,
++    // looks like we are closing handles twice somehow. See bug 1564899.
++#if defined(NIGHTLY_BUILD)
+     CHECK(false);  // CloseHandle failed.
++#else
++    DCHECK(false);  // CloseHandle failed.
++#endif
+   return true;
+ }
+ 
+ // Assigns the g_active_verifier global within the GetLock() lock.
+ // If |existing_verifier| is non-null then |enabled| is ignored.
+ void ThreadSafeAssignOrCreateScopedHandleVerifier(
+     ScopedHandleVerifier* existing_verifier,
+     bool enabled) {