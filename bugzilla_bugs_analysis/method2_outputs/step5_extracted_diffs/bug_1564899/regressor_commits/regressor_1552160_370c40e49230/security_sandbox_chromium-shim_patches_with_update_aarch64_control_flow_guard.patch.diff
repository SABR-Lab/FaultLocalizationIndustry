# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: security/sandbox/chromium-shim/patches/with_update/aarch64_control_flow_guard.patch
# Commit: 370c40e49230
# Full Hash: 370c40e4923073a87845b57c1f4851bacd9663da
# Author: Bob Owen <bobowencode@gmail.com>
# Date: 2019-06-12 21:42:35
# Regressor Bug: 1552160
# File Overlap Count: 2
# Description:
#   Bug 1552160 Part 1: Roll-up of chromium sandbox update and mozilla patches to get a running browser. r=jld,aklotz,tjr,bobowen
#   
#   This updates security/sandbox/chromium/ files to chromium commit 84108231f6e6e0772fb9a4643679ce76aa771e67.
#   
#   Existing and new patches applied from security/sandbox/chromium-shim/patches/with_update/ to give a compiling and mostly working browser.
# ==============================================================================

diff -r bd5ecd72f76c -r 370c40e49230 security/sandbox/chromium-shim/patches/with_update/aarch64_control_flow_guard.patch
--- a/security/sandbox/chromium-shim/patches/with_update/aarch64_control_flow_guard.patch	Wed Jun 12 21:55:59 2019 +1200
+++ b/security/sandbox/chromium-shim/patches/with_update/aarch64_control_flow_guard.patch	Wed Jun 12 11:10:48 2019 +0100
@@ -1,3 +1,9 @@
+# HG changeset patch
+# User David Major <dmajor@mozilla.com>
+# Date 1560264749 -3600
+#      Tue Jun 11 15:52:29 2019 +0100
+# Node ID 6acdba6bd34e773d5e2d6a8461e3679a33340f77
+# Parent  a0adb2e7f668ed430948ae1ffaa42ec011ffde50
 Bug 1523526: Don't allow CFG on old releases of Windows for arm64
 
 There's a bug in ole32.dll on arm64 versions of Windows prior to 1809, that crashes our content processes if we enable CFG. We've reported the issue, but even if it gets fixed, we can't assume users will have the update.
@@ -11,25 +17,40 @@
 diff --git a/security/sandbox/chromium/sandbox/win/src/process_mitigations.cc b/security/sandbox/chromium/sandbox/win/src/process_mitigations.cc
 --- a/security/sandbox/chromium/sandbox/win/src/process_mitigations.cc
 +++ b/security/sandbox/chromium/sandbox/win/src/process_mitigations.cc
-@@ -354,6 +354,11 @@ void ConvertProcessMitigationsToPolicy(M
-         PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON;
+@@ -400,16 +400,21 @@ void ConvertProcessMitigationsToPolicy(M
+ 
+   // Mitigations >= Win8.1:
+   //----------------------------------------------------------------------------
+   if (version >= base::win::VERSION_WIN8_1) {
+     if (flags & MITIGATION_DYNAMIC_CODE_DISABLE) {
+       *policy_value_1 |=
+           PROCESS_CREATION_MITIGATION_POLICY_PROHIBIT_DYNAMIC_CODE_ALWAYS_ON;
+     }
++
++    if (flags & MITIGATION_CONTROL_FLOW_GUARD_DISABLE) {
++      *policy_value_1 |=
++          PROCESS_CREATION_MITIGATION_POLICY_CONTROL_FLOW_GUARD_ALWAYS_OFF;
++    }
    }
  
-+  if (flags & MITIGATION_CONTROL_FLOW_GUARD_DISABLE) {
-+    *policy_flags |=
-+        PROCESS_CREATION_MITIGATION_POLICY_CONTROL_FLOW_GUARD_ALWAYS_OFF;
-+  }
-+
-   if (version < base::win::VERSION_WIN10)
-     return;
- 
+   // Mitigations >= Win10:
+   //----------------------------------------------------------------------------
+   if (version >= base::win::VERSION_WIN10) {
+     if (flags & MITIGATION_NONSYSTEM_FONT_DISABLE) {
+       *policy_value_1 |=
+           PROCESS_CREATION_MITIGATION_POLICY_FONT_DISABLE_ALWAYS_ON;
 diff --git a/security/sandbox/chromium/sandbox/win/src/security_level.h b/security/sandbox/chromium/sandbox/win/src/security_level.h
 --- a/security/sandbox/chromium/sandbox/win/src/security_level.h
 +++ b/security/sandbox/chromium/sandbox/win/src/security_level.h
-@@ -255,6 +255,15 @@ const MitigationFlags MITIGATION_IMAGE_L
- // PROCESS_CREATION_MITIGATION_POLICY_IMAGE_LOAD_PREFER_SYSTEM32_ALWAYS_ON.
+@@ -273,11 +273,20 @@ const MitigationFlags MITIGATION_IMAGE_L
  const MitigationFlags MITIGATION_IMAGE_LOAD_PREFER_SYS32 = 0x00100000;
  
+ // Prevents hyperthreads from interfering with indirect branch predictions.
+ // (SPECTRE Variant 2 mitigation.)  Corresponds to
+ // PROCESS_CREATION_MITIGATION_POLICY2_RESTRICT_INDIRECT_BRANCH_PREDICTION_ALWAYS_ON.
+ const MitigationFlags MITIGATION_RESTRICT_INDIRECT_BRANCH_PREDICTION =
+     0x00200000;
+ 
 +// Begin Mozilla-added flags.
 +// Working down from the high bit to avoid conflict with new upstream flags.
 +