# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: security/sandbox/chromium/sandbox/win/src/policy_low_level_unittest.cc
# Commit: 370c40e49230
# Full Hash: 370c40e4923073a87845b57c1f4851bacd9663da
# Author: Bob Owen <bobowencode@gmail.com>
# Date: 2019-06-12 21:42:35
# Regressor Bug: 1552160
# File Overlap Count: 2
# Description:
#   Bug 1552160 Part 1: Roll-up of chromium sandbox update and mozilla patches to get a running browser. r=jld,aklotz,tjr,bobowen
#   
#   This updates security/sandbox/chromium/ files to chromium commit 84108231f6e6e0772fb9a4643679ce76aa771e67.
#   
#   Existing and new patches applied from security/sandbox/chromium-shim/patches/with_update/ to give a compiling and mostly working browser.
# ==============================================================================

diff -r bd5ecd72f76c -r 370c40e49230 security/sandbox/chromium/sandbox/win/src/policy_low_level_unittest.cc
--- a/security/sandbox/chromium/sandbox/win/src/policy_low_level_unittest.cc	Wed Jun 12 21:55:59 2019 +1200
+++ b/security/sandbox/chromium/sandbox/win/src/policy_low_level_unittest.cc	Wed Jun 12 11:10:48 2019 +0100
@@ -2,12 +2,13 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
+#include "sandbox/win/src/policy_low_level.h"
+
 #include <stddef.h>
 #include <stdint.h>
 
 #include "sandbox/win/src/policy_engine_params.h"
 #include "sandbox/win/src/policy_engine_processor.h"
-#include "sandbox/win/src/policy_low_level.h"
 #include "testing/gtest/include/gtest/gtest.h"
 
 #define POLPARAMS_BEGIN(x) sandbox::ParameterSet x[] = {
@@ -26,8 +27,8 @@
   EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"*.tmp", CASE_SENSITIVE));
   EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"c:\\*.doc", CASE_SENSITIVE));
   EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"c:\\windows\\*", CASE_SENSITIVE));
-  EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"d:\\adobe\\acrobat.exe",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF, 0, L"d:\\adobe\\acrobat.exe", CASE_SENSITIVE));
 }
 
 // Testing that we signal invalid string patterns.
@@ -42,7 +43,7 @@
 
 // Helper function to allocate space (on the heap) for policy.
 PolicyGlobal* MakePolicyMemory() {
-  const size_t kTotalPolicySz = 4096*8;
+  const size_t kTotalPolicySz = 4096 * 8;
   char* mem = new char[kTotalPolicySz];
   memset(mem, 0, kTotalPolicySz);
   PolicyGlobal* policy = reinterpret_cast<PolicyGlobal*>(mem);
@@ -55,8 +56,8 @@
 TEST(PolicyEngineTest, SimpleStrMatch) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"z:\\Directory\\domo.txt",
-              CASE_INSENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF, 0, L"z:\\Directory\\domo.txt", CASE_INSENSITIVE));
 
   PolicyGlobal* policy = MakePolicyMemory();
   const uint32_t kFakeService = 2;
@@ -68,7 +69,7 @@
   const wchar_t* filename = L"Z:\\Directory\\domo.txt";
 
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
+    POLPARAM(filename)  // Argument 0
   POLPARAMS_END;
 
   PolicyResult result;
@@ -82,14 +83,13 @@
   result = pol_ev.Evaluate(kShortEval, eval_params, _countof(eval_params));
   EXPECT_EQ(NO_POLICY_MATCH, result);
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, SimpleIfNotStrMatch) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\", CASE_SENSITIVE));
 
   PolicyGlobal* policy = MakePolicyMemory();
   const uint32_t kFakeService = 2;
@@ -98,9 +98,9 @@
   EXPECT_TRUE(policyGen.AddRule(kFakeService, &pr));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* filename = NULL;
+  const wchar_t* filename = nullptr;
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
+    POLPARAM(filename)  // Argument 0
   POLPARAMS_END;
 
   PolicyResult result;
@@ -120,14 +120,14 @@
   EXPECT_EQ(POLICY_MATCH, result);
   EXPECT_EQ(ASK_BROKER, pol_ev.GetAction());
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, SimpleIfNotStrMatchWild1) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*", CASE_SENSITIVE));
 
   PolicyGlobal* policy = MakePolicyMemory();
   const uint32_t kFakeService = 3;
@@ -136,9 +136,9 @@
   EXPECT_TRUE(policyGen.AddRule(kFakeService, &pr));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* filename = NULL;
+  const wchar_t* filename = nullptr;
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
+    POLPARAM(filename)  // Argument 0
   POLPARAMS_END;
 
   PolicyResult result;
@@ -153,14 +153,14 @@
   EXPECT_EQ(POLICY_MATCH, result);
   EXPECT_EQ(ASK_BROKER, pol_ev.GetAction());
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, SimpleIfNotStrMatchWild2) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*.txt",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*.txt", CASE_SENSITIVE));
 
   PolicyGlobal* policy = MakePolicyMemory();
   const uint32_t kFakeService = 3;
@@ -169,9 +169,9 @@
   EXPECT_TRUE(policyGen.AddRule(kFakeService, &pr));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* filename = NULL;
+  const wchar_t* filename = nullptr;
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
+    POLPARAM(filename)  // Argument 0
   POLPARAMS_END;
 
   PolicyResult result;
@@ -191,14 +191,14 @@
   EXPECT_EQ(POLICY_MATCH, result);
   EXPECT_EQ(ASK_BROKER, pol_ev.GetAction());
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, IfNotStrMatchTwoRulesWild1) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF_NOT, 0, L"c:\\Microsoft\\*", CASE_SENSITIVE));
   EXPECT_TRUE(pr.AddNumberMatch(IF, 1, 24, EQUAL));
 
   PolicyGlobal* policy = MakePolicyMemory();
@@ -208,11 +208,11 @@
   EXPECT_TRUE(policyGen.AddRule(kFakeService, &pr));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* filename = NULL;
+  const wchar_t* filename = nullptr;
   uint32_t access = 0;
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
-    POLPARAM(access)                  // Argument 1
+    POLPARAM(filename)  // Argument 0
+    POLPARAM(access)    // Argument 1
   POLPARAMS_END;
 
   PolicyResult result;
@@ -239,15 +239,15 @@
   result = pol_ev.Evaluate(kShortEval, eval_params, _countof(eval_params));
   EXPECT_EQ(NO_POLICY_MATCH, result);
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, IfNotStrMatchTwoRulesWild2) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
   EXPECT_TRUE(pr.AddNumberMatch(IF, 1, 24, EQUAL));
-  EXPECT_TRUE(pr.AddStringMatch(IF_NOT, 0, L"c:\\GoogleV?\\*.txt",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF_NOT, 0, L"c:\\GoogleV?\\*.txt", CASE_SENSITIVE));
   EXPECT_TRUE(pr.AddNumberMatch(IF, 2, 66, EQUAL));
 
   PolicyGlobal* policy = MakePolicyMemory();
@@ -257,14 +257,14 @@
   EXPECT_TRUE(policyGen.AddRule(kFakeService, &pr));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* filename = NULL;
+  const wchar_t* filename = nullptr;
   uint32_t access = 0;
   uint32_t sharing = 66;
 
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
-    POLPARAM(access)                  // Argument 1
-    POLPARAM(sharing)                 // Argument 2
+    POLPARAM(filename)  // Argument 0
+    POLPARAM(access)    // Argument 1
+    POLPARAM(sharing)   // Argument 2
   POLPARAMS_END;
 
   PolicyResult result;
@@ -287,7 +287,6 @@
   EXPECT_EQ(POLICY_MATCH, result);
   EXPECT_EQ(ASK_BROKER, pol_ev.GetAction());
 
-
   filename = L"c:\\GoogleV2\\domo.txt";
   access = 42;
   result = pol_ev.Evaluate(kShortEval, eval_params, _countof(eval_params));
@@ -310,7 +309,7 @@
   result = pol_ev.Evaluate(kShortEval, eval_params, _countof(eval_params));
   EXPECT_EQ(NO_POLICY_MATCH, result);
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 // Testing one single rule in one single service. The service is made to
@@ -318,8 +317,8 @@
 TEST(PolicyEngineTest, OneRuleTest) {
   SetupNtdllImports();
   PolicyRule pr(ASK_BROKER);
-  EXPECT_TRUE(pr.AddStringMatch(IF, 0, L"c:\\*Microsoft*\\*.txt",
-                                CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr.AddStringMatch(IF, 0, L"c:\\*Microsoft*\\*.txt", CASE_SENSITIVE));
   EXPECT_TRUE(pr.AddNumberMatch(IF_NOT, 1, CREATE_ALWAYS, EQUAL));
   EXPECT_TRUE(pr.AddNumberMatch(IF, 2, FILE_ATTRIBUTE_NORMAL, EQUAL));
 
@@ -334,12 +333,12 @@
   const wchar_t* filename = L"c:\\Documents and Settings\\Microsoft\\BLAH.txt";
   uint32_t creation_mode = OPEN_EXISTING;
   uint32_t flags = FILE_ATTRIBUTE_NORMAL;
-  void* security_descriptor = NULL;
+  void* security_descriptor = nullptr;
 
   POLPARAMS_BEGIN(eval_params)
-    POLPARAM(filename)                // Argument 0
-    POLPARAM(creation_mode)           // Argument 1
-    POLPARAM(flags)                   // Argument 2
+    POLPARAM(filename)       // Argument 0
+    POLPARAM(creation_mode)  // Argument 1
+    POLPARAM(flags)          // Argument 2
     POLPARAM(security_descriptor)
   POLPARAMS_END;
 
@@ -382,7 +381,7 @@
   result = pol_ev.Evaluate(kShortEval, eval_params, _countof(eval_params));
   EXPECT_EQ(NO_POLICY_MATCH, result);
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 // Testing 3 rules in 3 services. Two of the services resemble File services.
@@ -415,8 +414,8 @@
   EXPECT_EQ(3u, opc3);
 
   PolicyRule pr_adobe(GIVE_CACHED);
-  EXPECT_TRUE(pr_adobe.AddStringMatch(IF, 0, L"c:\\adobe\\ver?.?\\",
-                                      CASE_SENSITIVE));
+  EXPECT_TRUE(
+      pr_adobe.AddStringMatch(IF, 0, L"c:\\adobe\\ver?.?\\", CASE_SENSITIVE));
   EXPECT_TRUE(pr_adobe.AddNumberMatch(IF, 2, FILE_ATTRIBUTE_NORMAL, EQUAL));
 
   size_t opc4 = pr_adobe.GetOpcodeCount();
@@ -448,14 +447,14 @@
   EXPECT_TRUE(policyGen.Done());
 
   // Inspect the policy structure manually.
-  EXPECT_TRUE(NULL == policy->entry[0]);
-  EXPECT_TRUE(NULL == policy->entry[1]);
-  EXPECT_TRUE(NULL == policy->entry[2]);
-  EXPECT_TRUE(NULL == policy->entry[3]);
-  EXPECT_TRUE(NULL != policy->entry[4]);  // kNtFakeNone.
-  EXPECT_TRUE(NULL != policy->entry[5]);  // kNtFakeCreateFile.
-  EXPECT_TRUE(NULL != policy->entry[6]);  // kNtFakeOpenFile.
-  EXPECT_TRUE(NULL == policy->entry[7]);
+  EXPECT_FALSE(policy->entry[0]);
+  EXPECT_FALSE(policy->entry[1]);
+  EXPECT_FALSE(policy->entry[2]);
+  EXPECT_FALSE(policy->entry[3]);
+  EXPECT_TRUE(policy->entry[4]);  // kNtFakeNone.
+  EXPECT_TRUE(policy->entry[5]);  // kNtFakeCreateFile.
+  EXPECT_TRUE(policy->entry[6]);  // kNtFakeOpenFile.
+  EXPECT_FALSE(policy->entry[7]);
 
   // The total per service opcode counts now must take in account one
   // extra opcode (action opcode) per rule.
@@ -477,26 +476,27 @@
 
   EXPECT_EQ(OP_NUMBER_AND_MATCH,
             policy->entry[kNtFakeNone]->opcodes[0].GetID());
-  EXPECT_EQ(OP_ACTION, policy->entry[kNtFakeNone]->opcodes[tc1-1].GetID());
+  EXPECT_EQ(OP_ACTION, policy->entry[kNtFakeNone]->opcodes[tc1 - 1].GetID());
   EXPECT_EQ(OP_WSTRING_MATCH,
             policy->entry[kNtFakeCreateFile]->opcodes[0].GetID());
   EXPECT_EQ(OP_ACTION,
-            policy->entry[kNtFakeCreateFile]->opcodes[tc2-1].GetID());
+            policy->entry[kNtFakeCreateFile]->opcodes[tc2 - 1].GetID());
   EXPECT_EQ(OP_WSTRING_MATCH,
             policy->entry[kNtFakeOpenFile]->opcodes[0].GetID());
-  EXPECT_EQ(OP_ACTION, policy->entry[kNtFakeOpenFile]->opcodes[tc3-1].GetID());
+  EXPECT_EQ(OP_ACTION,
+            policy->entry[kNtFakeOpenFile]->opcodes[tc3 - 1].GetID());
 
   // Test the policy evaluation.
 
   const wchar_t* filename = L"";
   uint32_t creation_mode = OPEN_EXISTING;
   uint32_t flags = FILE_ATTRIBUTE_NORMAL;
-  void* security_descriptor = NULL;
+  void* security_descriptor = nullptr;
 
   POLPARAMS_BEGIN(params)
-    POLPARAM(filename)                // Argument 0
-    POLPARAM(creation_mode)           // Argument 1
-    POLPARAM(flags)                   // Argument 2
+    POLPARAM(filename)       // Argument 0
+    POLPARAM(creation_mode)  // Argument 1
+    POLPARAM(flags)          // Argument 2
     POLPARAM(security_descriptor)
   POLPARAMS_END;
 
@@ -573,7 +573,7 @@
   EXPECT_EQ(POLICY_MATCH, result);
   EXPECT_EQ(FAKE_SUCCESS, eval_OpenFile.GetAction());
 
-  delete [] reinterpret_cast<char*>(policy);
+  delete[] reinterpret_cast<char*>(policy);
 }
 
 TEST(PolicyEngineTest, PolicyRuleCopyConstructorTwoStrings) {
@@ -592,7 +592,7 @@
   EXPECT_TRUE(policyGen.AddRule(2, &pr_copy));
   EXPECT_TRUE(policyGen.Done());
 
-  const wchar_t* name = NULL;
+  const wchar_t* name = nullptr;
   POLPARAMS_BEGIN(eval_params)
     POLPARAM(name)
   POLPARAMS_END;