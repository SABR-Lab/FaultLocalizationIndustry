# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/MediaManager.cpp
# Commit: dc3e09fb750b
# Full Hash: dc3e09fb750bd5eea290e6acb81f31c4e20d74fd
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-07-10 15:45:05
# Regressor Bug: 1560907
# File Overlap Count: 1
# Description:
#   Bug 1560907 - Remove default value for mediaSource constraint. r=jib,smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D36087
# ==============================================================================

diff -r be4f68034abd -r dc3e09fb750b dom/media/MediaManager.cpp
--- a/dom/media/MediaManager.cpp	Wed Jul 10 09:43:53 2019 +0000
+++ b/dom/media/MediaManager.cpp	Wed Jul 10 09:45:26 2019 +0000
@@ -2290,8 +2290,9 @@
 
   // Keep mediaSource, ignore all other constraints.
   auto& c = aConstraint.GetAsMediaTrackConstraints();
-  nsString mediaSource = c.mMediaSource;
-  aConstraint.SetAsMediaTrackConstraints().mMediaSource = mediaSource;
+  MOZ_DIAGNOSTIC_ASSERT(c.mMediaSource.WasPassed());
+  nsString mediaSource = c.mMediaSource.Value();
+  aConstraint.SetAsMediaTrackConstraints().mMediaSource.Construct(mediaSource);
 }
 
 /**
@@ -2435,8 +2436,12 @@
 
   if (c.mVideo.IsMediaTrackConstraints()) {
     auto& vc = c.mVideo.GetAsMediaTrackConstraints();
+    if (!vc.mMediaSource.WasPassed()) {
+      vc.mMediaSource.Construct().AssignASCII(EnumToASCII(
+          dom::MediaSourceEnumValues::strings, MediaSourceEnum::Camera));
+    }
     videoType = StringToEnum(dom::MediaSourceEnumValues::strings,
-                             vc.mMediaSource, MediaSourceEnum::Other);
+                             vc.mMediaSource.Value(), MediaSourceEnum::Other);
     Telemetry::Accumulate(Telemetry::WEBRTC_GET_USER_MEDIA_TYPE,
                           (uint32_t)videoType);
     switch (videoType) {
@@ -2479,17 +2484,6 @@
       }
     }
 
-    if (vc.mAdvanced.WasPassed() && videoType != MediaSourceEnum::Camera) {
-      // iterate through advanced, forcing all unset mediaSources to match
-      // "root"
-      const char* unset = EnumToASCII(dom::MediaSourceEnumValues::strings,
-                                      MediaSourceEnum::Camera);
-      for (MediaTrackConstraintSet& cs : vc.mAdvanced.Value()) {
-        if (cs.mMediaSource.EqualsASCII(unset)) {
-          cs.mMediaSource = vc.mMediaSource;
-        }
-      }
-    }
     if (!privileged) {
       // Only allow privileged content to explicitly pick full-screen,
       // application or tabsharing, since these modes are still available for
@@ -2513,7 +2507,7 @@
       if (videoType == MediaSourceEnum::Screen ||
           videoType == MediaSourceEnum::Browser) {
         videoType = MediaSourceEnum::Window;
-        vc.mMediaSource.AssignASCII(
+        vc.mMediaSource.Value().AssignASCII(
             EnumToASCII(dom::MediaSourceEnumValues::strings, videoType));
       }
       // only allow privileged content to set the window id
@@ -2536,15 +2530,12 @@
 
   if (c.mAudio.IsMediaTrackConstraints()) {
     auto& ac = c.mAudio.GetAsMediaTrackConstraints();
+    if (!ac.mMediaSource.WasPassed()) {
+      ac.mMediaSource.Construct(NS_ConvertASCIItoUTF16(EnumToASCII(
+          dom::MediaSourceEnumValues::strings, MediaSourceEnum::Microphone)));
+    }
     audioType = StringToEnum(dom::MediaSourceEnumValues::strings,
-                             ac.mMediaSource, MediaSourceEnum::Other);
-    // Work around WebIDL default since spec uses same dictionary w/audio &
-    // video.
-    if (audioType == MediaSourceEnum::Camera) {
-      audioType = MediaSourceEnum::Microphone;
-      ac.mMediaSource.AssignASCII(
-          EnumToASCII(dom::MediaSourceEnumValues::strings, audioType));
-    }
+                             ac.mMediaSource.Value(), MediaSourceEnum::Other);
     Telemetry::Accumulate(Telemetry::WEBRTC_GET_USER_MEDIA_TYPE,
                           (uint32_t)audioType);
 
@@ -2571,17 +2562,6 @@
             __func__);
       }
     }
-    if (ac.mAdvanced.WasPassed()) {
-      // iterate through advanced, forcing all unset mediaSources to match
-      // "root"
-      const char* unset = EnumToASCII(dom::MediaSourceEnumValues::strings,
-                                      MediaSourceEnum::Camera);
-      for (MediaTrackConstraintSet& cs : ac.mAdvanced.Value()) {
-        if (cs.mMediaSource.EqualsASCII(unset)) {
-          cs.mMediaSource = ac.mMediaSource;
-        }
-      }
-    }
   } else if (IsOn(c.mAudio)) {
     audioType = MediaSourceEnum::Microphone;
     Telemetry::Accumulate(Telemetry::WEBRTC_GET_USER_MEDIA_TYPE,
@@ -2953,8 +2933,9 @@
   //
   // If this is a non-priviliged call, GetUserMedia() will change it to "window"
   // for us.
-  vc.mMediaSource.AssignASCII(EnumToASCII(dom::MediaSourceEnumValues::strings,
-                                          MediaSourceEnum::Screen));
+  vc.mMediaSource.Reset();
+  vc.mMediaSource.Construct().AssignASCII(EnumToASCII(
+      dom::MediaSourceEnumValues::strings, MediaSourceEnum::Screen));
 
   return MediaManager::GetUserMedia(aWindow, c, aCallerType);
 }