# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/layers/client/ClientLayerManager.cpp
# Commit: 641765261f49
# Full Hash: 641765261f499a1a4712c0c02a14b58b69ecabaa
# Author: sotaro <sotaro.ikeda.g@gmail.com>
# Date: 2019-07-26 21:36:38
# Regressor Bug: 1569110
# File Overlap Count: 1
# Description:
#   Bug 1569110 - Add ClientLayerManager::Initialize() r=nical
#   
#   Some initialization handlings of ClientLayerManager exists in nsBaseWidget::CreateCompositor(). It is not good. Move them to ClientLayerManager::Initialize().
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D39476
# ==============================================================================

diff -r a6fa09658817 -r 641765261f49 gfx/layers/client/ClientLayerManager.cpp
--- a/gfx/layers/client/ClientLayerManager.cpp	Fri Jul 26 13:25:35 2019 +0000
+++ b/gfx/layers/client/ClientLayerManager.cpp	Fri Jul 26 09:31:57 2019 +0000
@@ -83,6 +83,36 @@
   MOZ_COUNT_DTOR(ClientLayerManager);
 }
 
+bool ClientLayerManager::Initialize(
+    PCompositorBridgeChild* aCBChild, bool aShouldAccelerate,
+    TextureFactoryIdentifier* aTextureFactoryIdentifier) {
+  MOZ_ASSERT(mForwarder);
+  MOZ_ASSERT(aTextureFactoryIdentifier);
+
+  nsTArray<LayersBackend> backendHints;
+  gfxPlatform::GetPlatform()->GetCompositorBackends(aShouldAccelerate,
+                                                    backendHints);
+  if (backendHints.IsEmpty()) {
+    gfxCriticalNote << "Failed to get backend hints.";
+    return false;
+  }
+
+  PLayerTransactionChild* shadowManager =
+      aCBChild->SendPLayerTransactionConstructor(backendHints, LayersId{0});
+
+  TextureFactoryIdentifier textureFactoryIdentifier;
+  shadowManager->SendGetTextureFactoryIdentifier(&textureFactoryIdentifier);
+  if (textureFactoryIdentifier.mParentBackend == LayersBackend::LAYERS_NONE) {
+    gfxCriticalNote << "Failed to create an OMT compositor.";
+    return false;
+  }
+
+  mForwarder->SetShadowManager(shadowManager);
+  UpdateTextureFactoryIdentifier(textureFactoryIdentifier);
+  *aTextureFactoryIdentifier = textureFactoryIdentifier;
+  return true;
+}
+
 void ClientLayerManager::Destroy() {
   MOZ_DIAGNOSTIC_ASSERT(!mNotifyingWidgetListener,
                         "Try to avoid destroying widgets and layer managers "