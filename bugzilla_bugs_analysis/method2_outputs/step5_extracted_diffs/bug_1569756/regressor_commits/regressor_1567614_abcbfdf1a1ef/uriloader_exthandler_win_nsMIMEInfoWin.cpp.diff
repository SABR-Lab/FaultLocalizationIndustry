# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: uriloader/exthandler/win/nsMIMEInfoWin.cpp
# Commit: abcbfdf1a1ef
# Full Hash: abcbfdf1a1efad1d852db7889ebda328c4e8b73d
# Author: Toshihito Kikuchi <tkikuchi@mozilla.com>
# Date: 2019-11-15 09:53:19
# Regressor Bug: 1567614
# File Overlap Count: 1
# Description:
#   Bug 1588975 - Replace ShellExecuteExW with mozilla::ShellExecuteByExplorer. r=aklotz,asuth
#   
#   The launcher process turns on the `PreferSystem32Images` mitigation policy for
#   the browser process.  Since the mitigation policy is inherited, a process launched
#   by the browser process also has `PreferSystem32Images`.  If an application which
# ==============================================================================

diff -r 36bef03d2b69 -r abcbfdf1a1ef uriloader/exthandler/win/nsMIMEInfoWin.cpp
--- a/uriloader/exthandler/win/nsMIMEInfoWin.cpp	Thu Nov 14 18:36:28 2019 +0000
+++ b/uriloader/exthandler/win/nsMIMEInfoWin.cpp	Thu Nov 14 19:47:29 2019 +0000
@@ -40,6 +40,37 @@
   return aFile->Launch();
 }
 
+// Helper routine to call mozilla::ShellExecuteByExplorer
+static nsresult ShellExecuteWithIFile(const nsCOMPtr<nsIFile>& aExecutable,
+                                      const _variant_t& aArgs) {
+  nsresult rv;
+
+  nsAutoString execPath;
+  rv = aExecutable->GetTarget(execPath);
+  if (NS_FAILED(rv) || execPath.IsEmpty()) {
+    rv = aExecutable->GetPath(execPath);
+  }
+  if (NS_FAILED(rv)) {
+    return rv;
+  }
+
+  _bstr_t execPathBStr(execPath.get());
+  _variant_t verb(L"open");
+  _variant_t workingDir;
+  _variant_t showCmd(SW_SHOWNORMAL);
+
+  // Ask Explorer to ShellExecute on our behalf, as some applications such as
+  // Skype for Business do not start correctly when inheriting our process's
+  // migitation policies.
+  mozilla::LauncherVoidResult shellExecuteOk = mozilla::ShellExecuteByExplorer(
+      execPathBStr, aArgs, verb, workingDir, showCmd);
+  if (shellExecuteOk.isErr()) {
+    return NS_ERROR_FILE_EXECUTION_FAILED;
+  }
+
+  return NS_OK;
+}
+
 NS_IMETHODIMP
 nsMIMEInfoWin::LaunchWithFile(nsIFile* aFile) {
   nsresult rv;
@@ -130,7 +161,7 @@
         return NS_ERROR_FILE_EXECUTION_FAILED;
       }
     }
-    return LaunchWithIProcess(executable, path);
+    return ShellExecuteWithIFile(executable, _variant_t(path.get()));
   }
 
   return NS_ERROR_INVALID_ARG;