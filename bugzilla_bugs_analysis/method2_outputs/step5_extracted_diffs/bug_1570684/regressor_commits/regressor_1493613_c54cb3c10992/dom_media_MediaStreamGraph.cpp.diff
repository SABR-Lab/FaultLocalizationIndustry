# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/MediaStreamGraph.cpp
# Commit: c54cb3c10992
# Full Hash: c54cb3c109922bc15fb6d0ca67e5f2a05980c1a5
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-07-31 15:46:43
# Regressor Bug: 1493613
# File Overlap Count: 2
# Description:
#   Bug 1493613 - Move MediaStream control from DOMMediaStream to MediaStreamTrack. r=padenot
#   
#   This is inherently large, because modifying these bits of DOMMediaStream and
#   MediaStreamTrack affects all consumers and producers of all DOMMediaStreams and
#   MediaStreamTracks.
# ==============================================================================

diff -r 0b03dd9d20ac -r c54cb3c10992 dom/media/MediaStreamGraph.cpp
--- a/dom/media/MediaStreamGraph.cpp	Wed Jul 31 09:35:06 2019 +0000
+++ b/dom/media/MediaStreamGraph.cpp	Wed Jul 31 07:58:17 2019 +0000
@@ -1863,7 +1863,6 @@
       mMainThreadFinished(false),
       mFinishedNotificationSent(false),
       mMainThreadDestroyed(false),
-      mNrOfMainThreadUsers(0),
       mGraph(nullptr) {
   MOZ_COUNT_CTOR(MediaStream);
 }
@@ -2015,8 +2014,6 @@
 }
 
 void MediaStream::Destroy() {
-  NS_ASSERTION(mNrOfMainThreadUsers == 0,
-               "Do not mix Destroy() and RegisterUser()/UnregisterUser()");
   // Keep this stream alive until we leave this method
   RefPtr<MediaStream> kungFuDeathGrip = this;
 
@@ -2038,23 +2035,6 @@
   mMainThreadDestroyed = true;
 }
 
-void MediaStream::RegisterUser() {
-  MOZ_ASSERT(NS_IsMainThread());
-  ++mNrOfMainThreadUsers;
-}
-
-void MediaStream::UnregisterUser() {
-  MOZ_ASSERT(NS_IsMainThread());
-
-  --mNrOfMainThreadUsers;
-  NS_ASSERTION(mNrOfMainThreadUsers >= 0, "Double-removal of main thread user");
-  NS_ASSERTION(!IsDestroyed(),
-               "Do not mix Destroy() and RegisterUser()/UnregisterUser()");
-  if (mNrOfMainThreadUsers == 0) {
-    Destroy();
-  }
-}
-
 void MediaStream::AddAudioOutput(void* aKey) {
   class Message : public ControlMessage {
    public:
@@ -3524,7 +3504,7 @@
   return stream;
 }
 
-ProcessedMediaStream* MediaStreamGraph::CreateAudioCaptureStream(
+AudioCaptureStream* MediaStreamGraph::CreateAudioCaptureStream(
     TrackID aTrackId) {
   AudioCaptureStream* stream = new AudioCaptureStream(aTrackId);
   AddStream(stream);