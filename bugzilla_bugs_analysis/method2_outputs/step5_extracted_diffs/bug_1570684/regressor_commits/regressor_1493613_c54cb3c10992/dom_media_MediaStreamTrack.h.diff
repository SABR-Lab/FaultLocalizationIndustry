# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/MediaStreamTrack.h
# Commit: c54cb3c10992
# Full Hash: c54cb3c109922bc15fb6d0ca67e5f2a05980c1a5
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-07-31 15:46:43
# Regressor Bug: 1493613
# File Overlap Count: 2
# Description:
#   Bug 1493613 - Move MediaStream control from DOMMediaStream to MediaStreamTrack. r=padenot
#   
#   This is inherently large, because modifying these bits of DOMMediaStream and
#   MediaStreamTrack affects all consumers and producers of all DOMMediaStreams and
#   MediaStreamTracks.
# ==============================================================================

diff -r 0b03dd9d20ac -r c54cb3c10992 dom/media/MediaStreamTrack.h
--- a/dom/media/MediaStreamTrack.h	Wed Jul 31 09:35:06 2019 +0000
+++ b/dom/media/MediaStreamTrack.h	Wed Jul 31 07:58:17 2019 +0000
@@ -40,7 +40,6 @@
 
 class AudioStreamTrack;
 class VideoStreamTrack;
-class TrackSink;
 enum class CallerType : uint32_t;
 
 /**
@@ -98,6 +97,12 @@
      */
     virtual void MutedChanged(bool aNewState) = 0;
 
+    /**
+     * Called when the MediaStreamTrackSource where this sink is registered has
+     * stopped producing data for good, i.e., it has ended.
+     */
+    virtual void OverrideEnded() = 0;
+
    protected:
     virtual ~Sink() = default;
   };
@@ -285,6 +290,23 @@
     }
   }
 
+  /**
+   * Called by a sub class when the source has stopped producing data for good,
+   * i.e., it has ended. Notifies all sinks.
+   */
+  void OverrideEnded() {
+    MOZ_ASSERT(NS_IsMainThread());
+    nsTArray<WeakPtr<Sink>> sinks(mSinks);
+    for (auto& sink : sinks) {
+      if (!sink) {
+        MOZ_ASSERT_UNREACHABLE("Sink was not explicitly removed");
+        mSinks.RemoveElement(sink);
+        continue;
+      }
+      sink->OverrideEnded();
+    }
+  }
+
   // Principal identifying who may access the contents of this source.
   nsCOMPtr<nsIPrincipal> mPrincipal;
 
@@ -339,15 +361,45 @@
   virtual void NotifyEnded(MediaStreamTrack* aTrack){};
 };
 
+// clang-format off
 /**
- * Class representing a track in a DOMMediaStream.
+ * DOM wrapper for MediaStreamGraph-MediaStreams.
+ *
+ * To account for cloning, a MediaStreamTrack wraps two internal (and chained)
+ * MediaStreams:
+ *   1. mInputStream
+ *      - Controlled by the producer of the data in the track. The producer
+ *        decides on lifetime of the MediaStream and the track inside it.
+ *      - It can be any type of MediaStream.
+ *      - Contains one track only.
+ *   2. mStream
+ *      - A TrackUnionStream representing this MediaStreamTrack.
+ *      - Its data is piped from mInputStream through mPort.
+ *      - Contains one track only.
+ *      - When this MediaStreamTrack is enabled/disabled this is reflected in
+ *        the chunks in the track in mStream.
+ *      - When this MediaStreamTrack has ended, mStream gets destroyed.
+ *        Note that mInputStream is unaffected, such that any clones of mStream
+ *        can live on. When all clones are ended, this is signaled to the
+ *        producer via our MediaStreamTrackSource. It is then likely to destroy
+ *        mInputStream.
+ *
+ * A graphical representation of how tracks are connected when cloned follows:
+ *
+ * MediaStreamTrack A
+ *       mInputStream     mStream
+ *            t1 ---------> t1
+ *               \
+ *                -----
+ * MediaStreamTrack B  \  (clone of A)
+ *       mInputStream   \ mStream
+ *            *          -> t1
+ *
+ *   (*) is a copy of A's mInputStream
  */
+// clang-format on
 class MediaStreamTrack : public DOMEventTargetHelper,
                          public SupportsWeakPtr<MediaStreamTrack> {
-  // DOMMediaStream owns MediaStreamTrack instances, and requires access to
-  // some internal state, e.g., GetInputStream(), GetOwnedStream().
-  friend class mozilla::DOMMediaStream;
-
   // PeerConnection and friends need to know our owning DOMStream and track id.
   friend class mozilla::PeerConnectionImpl;
   friend class mozilla::PeerConnectionMedia;
@@ -355,14 +407,14 @@
   friend class mozilla::RemoteSourceStreamInfo;
 
   class MSGListener;
+  class TrackSink;
 
  public:
   /**
-   * aTrackID is the MediaStreamGraph track ID for the track in the
-   * MediaStream owned by aStream.
+   * aTrackID is the MediaStreamGraph track ID for the track in aInputStream.
    */
   MediaStreamTrack(
-      DOMMediaStream* aStream, TrackID aTrackID, TrackID aInputTrackID,
+      nsPIDOMWindowInner* aWindow, MediaStream* aInputStream, TrackID aTrackID,
       MediaStreamTrackSource* aSource,
       const MediaTrackConstraints& aConstraints = MediaTrackConstraints());
 
@@ -372,7 +424,7 @@
 
   MOZ_DECLARE_WEAKREFERENCE_TYPENAME(MediaStreamTrack)
 
-  nsPIDOMWindowInner* GetParentObject() const;
+  nsPIDOMWindowInner* GetParentObject() const { return mWindow; }
   JSObject* WrapObject(JSContext* aCx,
                        JS::Handle<JSObject*> aGivenProto) override;
 
@@ -411,47 +463,20 @@
   bool Ended() const { return mReadyState == MediaStreamTrackState::Ended; }
 
   /**
-   * Forces the ready state to a particular value, for instance when we're
-   * cloning an already ended track.
-   */
-  void SetReadyState(MediaStreamTrackState aState);
-
-  /**
-   * Notified by the MediaStreamGraph, through our owning MediaStream on the
-   * main thread.
-   *
-   * Note that this sets the track to ended and raises the "ended" event
-   * synchronously.
-   */
-  void OverrideEnded();
-
-  /**
    * Get this track's principal.
    */
   nsIPrincipal* GetPrincipal() const { return mPrincipal; }
 
   /**
-   * Called by the MSGListener when this track's PrincipalHandle changes on
-   * the MediaStreamGraph thread. When the PrincipalHandle matches the pending
-   * principal we know that the principal change has propagated to consumers.
-   */
-  void NotifyPrincipalHandleChanged(const PrincipalHandle& aPrincipalHandle);
-
-  /**
-   * Called when this track's readyState transitions to "ended".
-   * Notifies all MediaStreamTrackConsumers that this track ended.
-   */
-  void NotifyEnded();
-
-  /**
    * Get this track's PeerIdentity.
    */
   const PeerIdentity* GetPeerIdentity() const {
     return GetSource().GetPeerIdentity();
   }
 
-  MediaStreamGraph* Graph();
-  MediaStreamGraphImpl* GraphImpl();
+  ProcessedMediaStream* GetStream() const;
+  MediaStreamGraph* Graph() const;
+  MediaStreamGraphImpl* GraphImpl() const;
 
   MediaStreamTrackSource& GetSource() const {
     MOZ_RELEASE_ASSERT(mSource,
@@ -464,16 +489,6 @@
   void AssignId(const nsAString& aID) { mID = aID; }
 
   /**
-   * Called when mSource's principal has changed.
-   */
-  void PrincipalChanged();
-
-  /**
-   * Called when mSource's muted state has changed.
-   */
-  void MutedChanged(bool aNewState);
-
-  /**
    * Add a PrincipalChangeObserver to this track.
    *
    * Returns true if it was successfully added.
@@ -530,62 +545,90 @@
    * MediaStreamTrack represents, to aStream, and returns it.
    */
   already_AddRefed<MediaInputPort> ForwardTrackContentsTo(
-      ProcessedMediaStream* aStream, TrackID aDestinationTrackID = TRACK_ANY);
+      ProcessedMediaStream* aStream);
 
-  /**
-   * Returns true if this track is connected to aPort and forwarded to aPort's
-   * output stream.
-   */
-  bool IsForwardedThrough(MediaInputPort* aPort);
-
-  void SetMediaStreamSizeListener(DirectMediaStreamTrackListener* aListener);
-
-  // Returns the original DOMMediaStream's underlying input stream.
-  MediaStream* GetInputStream();
-
-  TrackID GetInputTrackId() const { return mInputTrackID; }
+  TrackID GetTrackID() const { return mTrackID; }
 
  protected:
   virtual ~MediaStreamTrack();
 
   /**
+   * Forces the ready state to a particular value, for instance when we're
+   * cloning an already ended track.
+   */
+  void SetReadyState(MediaStreamTrackState aState);
+
+  /**
+   * Notified by the MediaStreamGraph, through our owning MediaStream on the
+   * main thread.
+   *
+   * Note that this sets the track to ended and raises the "ended" event
+   * synchronously.
+   */
+  void OverrideEnded();
+
+  /**
+   * Called by the MSGListener when this track's PrincipalHandle changes on
+   * the MediaStreamGraph thread. When the PrincipalHandle matches the pending
+   * principal we know that the principal change has propagated to consumers.
+   */
+  void NotifyPrincipalHandleChanged(const PrincipalHandle& aNewPrincipalHandle);
+
+  /**
+   * Called when this track's readyState transitions to "ended".
+   * Notifies all MediaStreamTrackConsumers that this track ended.
+   */
+  void NotifyEnded();
+
+  /**
+   * Called when mSource's principal has changed.
+   */
+  void PrincipalChanged();
+
+  /**
+   * Called when mSource's muted state has changed.
+   */
+  void MutedChanged(bool aNewState);
+
+  /**
    * Sets this track's muted state without raising any events.
    */
   void SetMuted(bool aMuted) { mMuted = aMuted; }
 
   virtual void Destroy();
 
-  // Returns the owning DOMMediaStream's underlying owned stream.
-  ProcessedMediaStream* GetOwnedStream();
-
-  // Returns the original DOMMediaStream. If this track is a clone,
-  // the original track's owning DOMMediaStream is returned.
-  DOMMediaStream* GetInputDOMStream();
-
   /**
    * Sets the principal and notifies PrincipalChangeObservers if it changes.
    */
   void SetPrincipal(nsIPrincipal* aPrincipal);
 
   /**
-   * Creates a new MediaStreamTrack with the same type, input track ID and
-   * source as this MediaStreamTrack.
-   * aTrackID is the TrackID the new track will have in its owned stream.
+   * Creates a new MediaStreamTrack with the same kind, input stream, input
+   * track ID and source as this MediaStreamTrack.
    */
-  virtual already_AddRefed<MediaStreamTrack> CloneInternal(
-      DOMMediaStream* aOwningStream, TrackID aTrackID) = 0;
+  virtual already_AddRefed<MediaStreamTrack> CloneInternal() = 0;
 
   nsTArray<PrincipalChangeObserver<MediaStreamTrack>*>
       mPrincipalChangeObservers;
 
   nsTArray<WeakPtr<MediaStreamTrackConsumer>> mConsumers;
 
-  RefPtr<DOMMediaStream> mOwningStream;
-  TrackID mTrackID;
-  TrackID mInputTrackID;
+  // We need this to track our parent object.
+  nsCOMPtr<nsPIDOMWindowInner> mWindow;
+
+  // The input MediaStream assigned us by the data producer. Valid until we end.
+  // Owned by the producer.
+  RefPtr<MediaStream> mInputStream;
+  // The MediaStream representing this MediaStreamTrack in the MediaStreamGraph.
+  // Valid until we end. Owned by us.
+  RefPtr<ProcessedMediaStream> mStream;
+  // The MediaInputPort connecting mInputStream to mStream. Valid until we end.
+  // Owned by us.
+  RefPtr<MediaInputPort> mPort;
+  // The TrackID of this track in mInputStream and mStream.
+  const TrackID mTrackID;
   RefPtr<MediaStreamTrackSource> mSource;
   const UniquePtr<TrackSink> mSink;
-  RefPtr<MediaStreamTrack> mOriginalTrack;
   nsCOMPtr<nsIPrincipal> mPrincipal;
   nsCOMPtr<nsIPrincipal> mPendingPrincipal;
   RefPtr<MSGListener> mMSGListener;