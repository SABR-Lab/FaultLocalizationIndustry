# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/MediaStreamWindowCapturer.h
# Commit: c54cb3c10992
# Full Hash: c54cb3c109922bc15fb6d0ca67e5f2a05980c1a5
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-07-31 15:46:43
# Regressor Bug: 1493613
# File Overlap Count: 2
# Description:
#   Bug 1493613 - Move MediaStream control from DOMMediaStream to MediaStreamTrack. r=padenot
#   
#   This is inherently large, because modifying these bits of DOMMediaStream and
#   MediaStreamTrack affects all consumers and producers of all DOMMediaStreams and
#   MediaStreamTracks.
# ==============================================================================

diff -r 0b03dd9d20ac -r c54cb3c10992 dom/media/MediaStreamWindowCapturer.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/media/MediaStreamWindowCapturer.h	Wed Jul 31 07:58:17 2019 +0000
@@ -0,0 +1,49 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-*/
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef MediaStreamWindowCapturer_h
+#define MediaStreamWindowCapturer_h
+
+#include "DOMMediaStream.h"
+
+namespace mozilla {
+namespace dom {
+class AudioStreamTrack;
+class MediaStreamTrack;
+}  // namespace dom
+
+/**
+ * Given a DOMMediaStream and a window id, this class will pipe the audio from
+ * all live audio tracks in the stream to the MediaStreamGraph's window capture
+ * mechanism.
+ */
+class MediaStreamWindowCapturer : public DOMMediaStream::TrackListener {
+ public:
+  MediaStreamWindowCapturer(DOMMediaStream* aStream, uint64_t aWindowId);
+  ~MediaStreamWindowCapturer();
+
+  void NotifyTrackAdded(const RefPtr<dom::MediaStreamTrack>& aTrack) override;
+  void NotifyTrackRemoved(const RefPtr<dom::MediaStreamTrack>& aTrack) override;
+
+  struct CapturedTrack {
+    CapturedTrack(dom::MediaStreamTrack* aTrack, uint64_t aWindowID);
+    ~CapturedTrack();
+
+    const WeakPtr<dom::MediaStreamTrack> mTrack;
+    const RefPtr<MediaInputPort> mPort;
+  };
+
+  const WeakPtr<DOMMediaStream> mStream;
+  const uint64_t mWindowId;
+
+ protected:
+  void AddTrack(dom::AudioStreamTrack* aTrack);
+  void RemoveTrack(dom::AudioStreamTrack* aTrack);
+
+  nsTArray<UniquePtr<CapturedTrack>> mTracks;
+};
+}  // namespace mozilla
+
+#endif /* MediaStreamWindowCapturer_h */