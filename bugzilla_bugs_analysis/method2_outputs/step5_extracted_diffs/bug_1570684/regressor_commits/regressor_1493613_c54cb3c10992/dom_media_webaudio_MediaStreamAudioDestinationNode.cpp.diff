# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webaudio/MediaStreamAudioDestinationNode.cpp
# Commit: c54cb3c10992
# Full Hash: c54cb3c109922bc15fb6d0ca67e5f2a05980c1a5
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-07-31 15:46:43
# Regressor Bug: 1493613
# File Overlap Count: 2
# Description:
#   Bug 1493613 - Move MediaStream control from DOMMediaStream to MediaStreamTrack. r=padenot
#   
#   This is inherently large, because modifying these bits of DOMMediaStream and
#   MediaStreamTrack affects all consumers and producers of all DOMMediaStreams and
#   MediaStreamTracks.
# ==============================================================================

diff -r 0b03dd9d20ac -r c54cb3c10992 dom/media/webaudio/MediaStreamAudioDestinationNode.cpp
--- a/dom/media/webaudio/MediaStreamAudioDestinationNode.cpp	Wed Jul 31 09:35:06 2019 +0000
+++ b/dom/media/webaudio/MediaStreamAudioDestinationNode.cpp	Wed Jul 31 07:58:17 2019 +0000
@@ -9,8 +9,8 @@
 #include "mozilla/dom/MediaStreamAudioDestinationNodeBinding.h"
 #include "AudioNodeEngine.h"
 #include "AudioNodeStream.h"
+#include "AudioStreamTrack.h"
 #include "DOMMediaStream.h"
-#include "MediaStreamTrack.h"
 #include "TrackUnionStream.h"
 
 namespace mozilla {
@@ -23,10 +23,19 @@
                                            MediaStreamTrackSource)
 
   AudioDestinationTrackSource(MediaStreamAudioDestinationNode* aNode,
+                              MediaStream* aInputStream,
+                              ProcessedMediaStream* aStream,
                               nsIPrincipal* aPrincipal)
-      : MediaStreamTrackSource(aPrincipal, nsString()), mNode(aNode) {}
+      : MediaStreamTrackSource(aPrincipal, nsString()),
+        mStream(aStream),
+        mPort(mStream->AllocateInputPort(aInputStream)),
+        mNode(aNode) {}
 
   void Destroy() override {
+    if (!mStream->IsDestroyed()) {
+      mStream->Destroy();
+      mPort->Destroy();
+    }
     if (mNode) {
       mNode->DestroyMediaStream();
       mNode = nullptr;
@@ -43,6 +52,9 @@
 
   void Enable() override {}
 
+  const RefPtr<ProcessedMediaStream> mStream;
+  const RefPtr<MediaInputPort> mPort;
+
  private:
   ~AudioDestinationTrackSource() = default;
 
@@ -69,8 +81,7 @@
     AudioContext* aContext)
     : AudioNode(aContext, 2, ChannelCountMode::Explicit,
                 ChannelInterpretation::Speakers),
-      mDOMStream(DOMAudioNodeMediaStream::CreateTrackUnionStreamAsInput(
-          GetOwner(), this, aContext->Graph())) {
+      mDOMStream(MakeAndAddRef<DOMMediaStream>(GetOwner())) {
   // Ensure an audio track with the correct ID is exposed to JS. If we can't get
   // a principal here because the document is not available, pass in a null
   // principal. This happens in edge cases when the document is being unloaded
@@ -81,21 +92,14 @@
     Document* doc = aContext->GetParentObject()->GetExtantDoc();
     principal = doc->NodePrincipal();
   }
-  RefPtr<MediaStreamTrackSource> source =
-      new AudioDestinationTrackSource(this, principal);
-  RefPtr<MediaStreamTrack> track = mDOMStream->CreateDOMTrack(
-      AudioNodeStream::AUDIO_TRACK, MediaSegment::AUDIO, source,
-      MediaTrackConstraints());
+  mStream = AudioNodeStream::Create(aContext, new AudioNodeEngine(this),
+                                    AudioNodeStream::EXTERNAL_OUTPUT,
+                                    aContext->Graph());
+  auto source = MakeRefPtr<AudioDestinationTrackSource>(
+      this, mStream, aContext->Graph()->CreateTrackUnionStream(), principal);
+  auto track = MakeRefPtr<AudioStreamTrack>(
+      GetOwner(), source->mStream, AudioNodeStream::AUDIO_TRACK, source);
   mDOMStream->AddTrackInternal(track);
-
-  ProcessedMediaStream* outputStream =
-      mDOMStream->GetInputStream()->AsProcessedStream();
-  MOZ_ASSERT(!!outputStream);
-  AudioNodeEngine* engine = new AudioNodeEngine(this);
-  mStream = AudioNodeStream::Create(
-      aContext, engine, AudioNodeStream::EXTERNAL_OUTPUT, aContext->Graph());
-  mPort =
-      outputStream->AllocateInputPort(mStream, AudioNodeStream::AUDIO_TRACK);
 }
 
 /* static */
@@ -124,7 +128,6 @@
   // Future:
   // - mDOMStream
   size_t amount = AudioNode::SizeOfExcludingThis(aMallocSizeOf);
-  amount += mPort->SizeOfIncludingThis(aMallocSizeOf);
   return amount;
 }
 
@@ -135,10 +138,6 @@
 
 void MediaStreamAudioDestinationNode::DestroyMediaStream() {
   AudioNode::DestroyMediaStream();
-  if (mPort) {
-    mPort->Destroy();
-    mPort = nullptr;
-  }
 }
 
 JSObject* MediaStreamAudioDestinationNode::WrapObject(