# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/mediacapabilities/DecoderBenchmark.cpp
# Commit: 0d5c063c17b4
# Full Hash: 0d5c063c17b49d4be792578849376d95a7e5e40a
# Author: Alex Chronopoulos <achronop@gmail.com>
# Date: 2019-09-10 15:48:08
# Description:
#   Bug 1571821 - Use total frames instead of parsed frames to calculate benchmark. r=alwu
#   
#   The problem reproduces when the system is loaded and the decoder is dropping most of the frames. When there are two benchmark calculations close to each other, the measured parsed frames of the first calculation can be buffered in the decoder and reported as dropped frames on the second calculation. Then on the second calculation, the number of dropped frames can be greater than the parsed frame which will hit the assert. The number of total frames is a better measure since it counts the frames that appeared in the in VideoSink plus the total dropped frames.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D44478
# ==============================================================================

diff -r 3b9e96b71449 -r 0d5c063c17b4 dom/media/mediacapabilities/DecoderBenchmark.cpp
--- a/dom/media/mediacapabilities/DecoderBenchmark.cpp	Tue Sep 10 07:05:14 2019 +0000
+++ b/dom/media/mediacapabilities/DecoderBenchmark.cpp	Mon Sep 09 20:08:59 2019 +0000
@@ -13,27 +13,27 @@
 void DecoderBenchmark::StoreScore(const nsACString& aDecoderName,
                                   const nsACString& aKey,
                                   RefPtr<FrameStatistics> aStats) {
-  uint64_t parsedFrames = aStats->GetParsedFrames();
+  uint64_t totalFrames = aStats->GetTotalFrames();
   uint64_t droppedFrames = aStats->GetDroppedFrames();
 
-  MOZ_ASSERT(droppedFrames <= parsedFrames);
-  MOZ_ASSERT(parsedFrames >= mLastParsedFrames);
+  MOZ_ASSERT(droppedFrames <= totalFrames);
+  MOZ_ASSERT(totalFrames >= mLastTotalFrames);
   MOZ_ASSERT(droppedFrames >= mLastDroppedFrames);
 
-  uint64_t diffParsedFrames = parsedFrames - mLastParsedFrames;
+  uint64_t diffTotalFrames = totalFrames - mLastTotalFrames;
   uint64_t diffDroppedFrames = droppedFrames - mLastDroppedFrames;
 
   /* Update now in case the method returns at the if check bellow. */
-  mLastParsedFrames = parsedFrames;
+  mLastTotalFrames = totalFrames;
   mLastDroppedFrames = droppedFrames;
 
   /* A minimum number of 10 frames is required to store the score. */
-  if (diffParsedFrames < 10) {
+  if (diffTotalFrames < 10) {
     return;
   }
 
   int32_t percentage =
-      100 - 100 * float(diffDroppedFrames) / float(diffParsedFrames);
+      100 - 100 * float(diffDroppedFrames) / float(diffTotalFrames);
 
   MOZ_ASSERT(percentage >= 0);
 