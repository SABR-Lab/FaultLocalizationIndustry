# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/svg/SVGRect.h
# Commit: b848ca90888e
# Full Hash: b848ca90888ee8e446f3d54b65c3ef68c71a1451
# Author: longsonr <longsonr@gmail.com>
# Date: 2019-06-20 22:06:31
# Regressor Bug: 1551030
# File Overlap Count: 2
# Description:
#   Bug 1551030 - Merge all SVGRect classes r=dholbert
# ==============================================================================

diff -r 20956a783e08 -r b848ca90888e dom/svg/SVGRect.h
--- a/dom/svg/SVGRect.h	Thu Jun 20 14:19:57 2019 +0300
+++ b/dom/svg/SVGRect.h	Thu Jun 20 07:03:54 2019 -0700
@@ -7,10 +7,8 @@
 #ifndef mozilla_dom_SVGRect_h
 #define mozilla_dom_SVGRect_h
 
-#include "mozilla/dom/SVGIRect.h"
+#include "mozilla/dom/SVGElement.h"
 #include "mozilla/gfx/Rect.h"
-#include "nsCOMPtr.h"
-#include "SVGElement.h"
 
 ////////////////////////////////////////////////////////////////////////
 // SVGRect class
@@ -18,50 +16,71 @@
 namespace mozilla {
 namespace dom {
 
-class SVGRect final : public SVGIRect {
+class SVGSVGElement;
+
+class SVGRect final : public nsISupports, public nsWrapperCache {
  public:
-  explicit SVGRect(nsIContent* aParent, float x = 0.0f, float y = 0.0f,
-                   float w = 0.0f, float h = 0.0f);
+  typedef enum { BaseValue, AnimValue, CreatedValue } RectType;
 
   NS_DECL_CYCLE_COLLECTING_ISUPPORTS
   NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS(SVGRect)
 
-  // WebIDL
-  float X() const final { return mX; }
-
-  void SetX(float aX, ErrorResult& aRv) final { mX = aX; }
+  /**
+   * Generic ctor for objects that are created for an attribute.
+   */
+  SVGRect(SVGAnimatedViewBox* aVal, SVGElement* aSVGElement, RectType aType)
+      : mVal(aVal), mParent(aSVGElement), mType(aType) {
+    MOZ_ASSERT(mParent);
+    MOZ_ASSERT(mType == BaseValue || mType == AnimValue);
+  }
 
-  float Y() const final { return mY; }
+  /**
+   * Ctor for creating the objects returned by SVGSVGElement.createSVGRect(),
+   * which do not initially belong to an attribute.
+   */
+  explicit SVGRect(SVGSVGElement* aSVGElement);
 
-  void SetY(float aY, ErrorResult& aRv) final { mY = aY; }
+  /**
+   * Ctor for all other non-attribute usage i.e getBBox, getExtentOfChar etc.
+   */
+  SVGRect(nsIContent* aParent, const gfx::Rect& aRect)
+      : mVal(nullptr), mRect(aRect), mParent(aParent), mType(CreatedValue) {
+    MOZ_ASSERT(mParent);
+  }
 
-  float Width() const final { return mWidth; }
+  JSObject* WrapObject(JSContext* aCx,
+                       JS::Handle<JSObject*> aGivenProto) override;
 
-  void SetWidth(float aWidth, ErrorResult& aRv) final { mWidth = aWidth; }
+  float X();
+  float Y();
+  float Width();
+  float Height();
 
-  float Height() const final { return mHeight; }
-
-  void SetHeight(float aHeight, ErrorResult& aRv) final { mHeight = aHeight; }
+  void SetX(float aX, mozilla::ErrorResult& aRv);
+  void SetY(float aY, mozilla::ErrorResult& aRv);
+  void SetWidth(float aWidth, mozilla::ErrorResult& aRv);
+  void SetHeight(float aHeight, mozilla::ErrorResult& aRv);
 
-  virtual nsIContent* GetParentObject() const override { return mParent; }
+  nsIContent* GetParentObject() const {
+    MOZ_ASSERT(mParent);
+    return mParent;
+  }
+
+ private:
+  virtual ~SVGRect();
 
- protected:
-  ~SVGRect() = default;
+  // If we're actually representing a viewBox rect then our value
+  // will come from that element's viewBox attribute's value.
+  SVGAnimatedViewBox* mVal;  // kept alive because it belongs to content
+  gfx::Rect mRect;
 
-  nsCOMPtr<nsIContent> mParent;
-  float mX, mY, mWidth, mHeight;
+  // If mType is AnimValue or BaseValue this will be an element that
+  // has a viewBox, otherwise it could be any nsIContent.
+  RefPtr<nsIContent> mParent;
+  const RectType mType;
 };
 
 }  // namespace dom
 }  // namespace mozilla
 
-already_AddRefed<mozilla::dom::SVGRect> NS_NewSVGRect(nsIContent* aParent,
-                                                      float x = 0.0f,
-                                                      float y = 0.0f,
-                                                      float width = 0.0f,
-                                                      float height = 0.0f);
-
-already_AddRefed<mozilla::dom::SVGRect> NS_NewSVGRect(
-    nsIContent* aParent, const mozilla::gfx::Rect& rect);
-
 #endif  // mozilla_dom_SVGRect_h