# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/html/HTMLListAccessible.cpp
# Commit: 8647528a4e9d
# Full Hash: 8647528a4e9d6350ba9b1ce6245d51476081c5e4
# Author: Mats Palmgren <mats@mozilla.com>
# Date: 2019-08-14 21:57:52
# Regressor Bug: 1105868
# File Overlap Count: 2
# Description:
#   Bug 1105868 part 4 - Accessibility support for inline list-items.  r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D39833
# ==============================================================================

diff -r b517c3b51b9a -r 8647528a4e9d accessible/html/HTMLListAccessible.cpp
--- a/accessible/html/HTMLListAccessible.cpp	Wed Aug 14 14:37:03 2019 +0000
+++ b/accessible/html/HTMLListAccessible.cpp	Wed Aug 14 14:37:16 2019 +0000
@@ -11,8 +11,8 @@
 #include "Role.h"
 #include "States.h"
 
-#include "nsBlockFrame.h"
-#include "nsBulletFrame.h"
+#include "nsContainerFrame.h"
+#include "nsLayoutUtils.h"
 
 using namespace mozilla;
 using namespace mozilla::a11y;
@@ -38,8 +38,8 @@
     : HyperTextAccessibleWrap(aContent, aDoc), mBullet(nullptr) {
   mType = eHTMLLiType;
 
-  nsBlockFrame* blockFrame = do_QueryFrame(GetFrame());
-  if (blockFrame && blockFrame->HasMarker()) {
+  nsIContent* marker = nsLayoutUtils::GetMarkerPseudo(aContent);
+  if (marker && marker->GetPrimaryFrame()) {
     mBullet = new HTMLListBulletAccessible(mContent, mDoc);
     Document()->BindToDocument(mBullet, nullptr);
     AppendChild(mBullet);
@@ -119,17 +119,16 @@
 // HTMLListBulletAccessible: Accessible
 
 nsIFrame* HTMLListBulletAccessible::GetFrame() const {
-  nsBlockFrame* blockFrame = do_QueryFrame(mContent->GetPrimaryFrame());
-  return blockFrame ? blockFrame->GetMarker() : nullptr;
+  nsIContent* marker = nsLayoutUtils::GetMarkerPseudo(mContent);
+  return marker ? marker->GetPrimaryFrame() : nullptr;
 }
 
 ENameValueFlag HTMLListBulletAccessible::Name(nsString& aName) const {
   aName.Truncate();
 
   // Native anonymous content, ARIA can't be used. Get list bullet text.
-  nsBlockFrame* blockFrame = do_QueryFrame(mContent->GetPrimaryFrame());
-  if (blockFrame) {
-    blockFrame->GetSpokenMarkerText(aName);
+  if (nsContainerFrame* frame = do_QueryFrame(mContent->GetPrimaryFrame())) {
+    frame->GetSpokenMarkerText(aName);
   }
 
   return eNameOK;
@@ -145,9 +144,7 @@
                                             uint32_t aStartOffset,
                                             uint32_t aLength) {
   nsAutoString bulletText;
-  nsBlockFrame* blockFrame = do_QueryFrame(mContent->GetPrimaryFrame());
-  if (blockFrame) blockFrame->GetSpokenMarkerText(bulletText);
-
+  Name(bulletText);
   aText.Append(Substring(bulletText, aStartOffset, aLength));
 }
 
@@ -155,6 +152,9 @@
 // HTMLListBulletAccessible: public
 
 bool HTMLListBulletAccessible::IsInside() const {
-  nsBlockFrame* blockFrame = do_QueryFrame(mContent->GetPrimaryFrame());
-  return blockFrame ? blockFrame->HasInsideMarker() : false;
+  if (nsIFrame* frame = mContent->GetPrimaryFrame()) {
+    return frame->StyleList()->mListStylePosition ==
+        NS_STYLE_LIST_STYLE_POSITION_INSIDE;
+  }
+  return false;
 }