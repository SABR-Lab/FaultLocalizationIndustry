# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: toolkit/components/url-classifier/Classifier.cpp
# Commit: 6d946d2a7a31
# Full Hash: 6d946d2a7a313e4ccb8aadb4b1a86e78d1e68301
# Author: dlee <dlee@mozilla.com>
# Date: 2019-08-23 15:36:51
# Description:
#   Bug 1575842 - Do not use |ResetTables| when detecting Safe Browing database corruption in GetLookupCache. r=gcp
#   
#   This patch replaces |ResetTables|(clear table's in-memory and on-disk
#   data) with |DeleteTables|(clear table's on-disk data) in GetLookupCache to avoid infinite
#   loop.
# ==============================================================================

diff -r d8038c9cac36 -r 6d946d2a7a31 toolkit/components/url-classifier/Classifier.cpp
--- a/toolkit/components/url-classifier/Classifier.cpp	Fri Aug 23 11:06:45 2019 +0300
+++ b/toolkit/components/url-classifier/Classifier.cpp	Fri Aug 23 08:19:18 2019 +0000
@@ -362,6 +362,9 @@
   }
 }
 
+// |DeleteTables| is used by |GetLookupCache| to remove on-disk data when
+// we detect prefix file corruption. So make sure not to call |GetLookupCache|
+// again in this function to avoid infinite loop.
 void Classifier::DeleteTables(nsIFile* aDirectory,
                               const nsTArray<nsCString>& aTables) {
   nsCOMPtr<nsIDirectoryEnumerator> entries;
@@ -1566,7 +1569,8 @@
     // Remove all the on-disk data when the table's prefix file is corrupted.
     LOG(("Failed to get prefixes from file for table %s, delete on-disk data!",
          aTable.BeginReading()));
-    ResetTables(Clear_All, nsTArray<nsCString>{nsCString(aTable)});
+
+    DeleteTables(mRootStoreDirectory, nsTArray<nsCString>{nsCString(aTable)});
   }
   return nullptr;
 }
