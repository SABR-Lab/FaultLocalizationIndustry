# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/SharedFontList.cpp
# Commit: 6af07e63a001
# Full Hash: 6af07e63a001dfc667a952727551a80b16797339
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2019-08-13 09:54:32
# Regressor Bug: 1565966
# File Overlap Count: 1
# Description:
#   Bug 1565966 - part 2 - Include Family attributes in mAliasTable when collecting font-name aliases, so that fontEntry instantiation on Windows can work correctly for the Aliases eventually stored in the font-list. r=jwatt
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D41243
# ==============================================================================

diff -r 277876c31869 -r 6af07e63a001 gfx/thebes/SharedFontList.cpp
--- a/gfx/thebes/SharedFontList.cpp	Mon Aug 12 17:49:09 2019 +0000
+++ b/gfx/thebes/SharedFontList.cpp	Mon Aug 12 17:49:28 2019 +0000
@@ -634,15 +634,19 @@
 }
 
 void FontList::SetAliases(
-    nsClassHashtable<nsCStringHashKey, nsTArray<Pointer>>& aAliasTable) {
+    nsClassHashtable<nsCStringHashKey, AliasData>& aAliasTable) {
   MOZ_ASSERT(XRE_IsParentProcess());
 
   Header& header = GetHeader();
 
+  // Build an array of Family::InitData records based on the entries in
+  // aAliasTable, then sort them and store into the fontlist.
   nsTArray<Family::InitData> aliasArray;
   aliasArray.SetCapacity(aAliasTable.Count());
   for (auto i = aAliasTable.Iter(); !i.Done(); i.Next()) {
-    aliasArray.AppendElement(Family::InitData(i.Key(), i.Key()));
+    aliasArray.AppendElement(Family::InitData(
+        i.Key(), i.Key(), i.Data()->mIndex, i.Data()->mHidden,
+        i.Data()->mBundled, i.Data()->mBadUnderline, i.Data()->mForceClassic));
   }
   aliasArray.Sort();
 
@@ -658,9 +662,9 @@
     (void)new (&aliases[i]) Family(this, aliasArray[i]);
     LOG_FONTLIST(("(shared-fontlist) alias family %u (%s)", (unsigned)i,
                   aliasArray[i].mName.get()));
-    aliases[i].SetFacePtrs(this, *aAliasTable.Get(aliasArray[i].mName));
+    aliases[i].SetFacePtrs(this, aAliasTable.Get(aliasArray[i].mName)->mFaces);
     if (LOG_FONTLIST_ENABLED()) {
-      const auto& faces = *aAliasTable.Get(aliasArray[i].mName);
+      const auto& faces = aAliasTable.Get(aliasArray[i].mName)->mFaces;
       for (unsigned j = 0; j < faces.Length(); j++) {
         auto face = static_cast<const fontlist::Face*>(faces[j].ToPtr(this));
         const nsCString& desc = face->mDescriptor.AsString(this);