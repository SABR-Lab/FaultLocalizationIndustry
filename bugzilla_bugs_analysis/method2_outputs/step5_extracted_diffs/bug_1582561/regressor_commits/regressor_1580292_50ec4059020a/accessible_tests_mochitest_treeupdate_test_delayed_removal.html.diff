# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/tests/mochitest/treeupdate/test_delayed_removal.html
# Commit: 50ec4059020a
# Full Hash: 50ec4059020abd34f64c60e59849e803e4adfbf6
# Author: Eitan Isaacson <eitan@monotonous.org>
# Date: 2019-09-18 09:56:40
# Regressor Bug: 1580292
# File Overlap Count: 1
# Description:
#   Bug 1580292 - Check for pruned descendants of reframed body. r=Jamie
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D45423
# ==============================================================================

diff -r 9aab8ce7d9f1 -r 50ec4059020a accessible/tests/mochitest/treeupdate/test_delayed_removal.html
--- a/accessible/tests/mochitest/treeupdate/test_delayed_removal.html	Thu Sep 12 01:00:15 2019 +0000
+++ b/accessible/tests/mochitest/treeupdate/test_delayed_removal.html	Wed Sep 11 18:32:07 2019 +0000
@@ -213,6 +213,49 @@
       window.windowUtils.restoreNormalRefresh();
     }
 
+    // Check to see that a reframed body gets its children pruned correctly.
+    async function bodyReframe(argument) {
+      // Load sub-document in iframe.
+      let event = waitForEvent(EVENT_REORDER, "iframe", "bodyReframe");
+      getNode("iframe").src =
+        `data:text/html,<div>Hello</div><div style="display: none">World</div>`;
+      await event;
+
+      // Initial tree should have one section leaf.
+      testAccessibleTree("c10",{ SECTION: [
+        { INTERNAL_FRAME: [
+          { DOCUMENT: [
+            { SECTION: [
+              { role: ROLE_TEXT_LEAF, name: "Hello" }
+            ] }
+          ]}
+        ] }
+      ] });
+
+
+      let iframeDoc = getNode("iframe").contentWindow.document;
+
+      // Trigger coalesced reframing. Both the body node and its children
+      // will need reframing.
+      event = waitForEvent(EVENT_REORDER, iframeDoc, "bodyReframe");
+      iframeDoc.body.style.display = "inline-block";
+      iframeDoc.querySelector("div:first-child").style.display = "none";
+      iframeDoc.querySelector("div:last-child").style.display = "block";
+
+      await event;
+
+      // Only the second section should be showing
+      testAccessibleTree("c10",{ SECTION: [
+        { INTERNAL_FRAME: [
+          { DOCUMENT: [
+            { SECTION: [
+              { role: ROLE_TEXT_LEAF, name: "World" }
+            ] }
+          ]}
+        ] }
+      ] });
+    }
+
     async function doTest() {
       await hideDivFromInsideSpan();
 
@@ -234,6 +277,8 @@
 
       listItemReframe();
 
+      await bodyReframe();
+
       SimpleTest.finish();
     }
 
@@ -293,6 +338,10 @@
     </ul>
   </div>
 
+  <div id="c10">
+    <iframe id="iframe"></iframe>
+  </div>
+
   <div id="eventdump"></div>
 </body>
 </html>
