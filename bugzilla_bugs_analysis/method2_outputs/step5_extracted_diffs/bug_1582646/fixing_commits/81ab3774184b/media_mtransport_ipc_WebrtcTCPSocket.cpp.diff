# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: media/mtransport/ipc/WebrtcTCPSocket.cpp
# Commit: 81ab3774184b
# Full Hash: 81ab3774184b5f52eda50608e0a311f873df78af
# Author: Byron Campen [:bwc] <docfaraday@gmail.com>
# Date: 2019-09-24 03:42:17
# Description:
#   Bug 1582646: Cancel proxy lookup when socket closes. r=mjf
#   
#   Also, since OnProxyAvailable always happens on main regardless of the target we
#   set, don't bother setting the target.
#   
# ==============================================================================

diff -r c8bbd3388d4e -r 81ab3774184b media/mtransport/ipc/WebrtcTCPSocket.cpp
--- a/media/mtransport/ipc/WebrtcTCPSocket.cpp	Mon Sep 23 18:15:58 2019 +0000
+++ b/media/mtransport/ipc/WebrtcTCPSocket.cpp	Fri Sep 20 15:13:44 2019 +0000
@@ -201,14 +201,10 @@
     return rv;
   }
 
-  nsCOMPtr<nsIEventTarget> target =
-      SystemGroup::EventTargetFor(TaskCategory::Network);
-  nsCOMPtr<nsICancelable> proxyRequest;
-
   rv = pps->AsyncResolve(channel,
                          nsIProtocolProxyService::RESOLVE_PREFER_HTTPS_PROXY |
                              nsIProtocolProxyService::RESOLVE_ALWAYS_TUNNEL,
-                         this, target, getter_AddRefs(proxyRequest));
+                         this, nullptr, getter_AddRefs(mProxyRequest));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -222,6 +218,9 @@
                                                 nsIChannel* aChannel,
                                                 nsIProxyInfo* aProxyinfo,
                                                 nsresult aResult) {
+  MOZ_ASSERT(NS_IsMainThread());
+  mProxyRequest = nullptr;
+
   nsresult rv;
 
   if (NS_SUCCEEDED(aResult) && aProxyinfo) {
@@ -430,6 +429,11 @@
 
   MOZ_ASSERT(mProxyCallbacks, "webrtc TCP callback should be non-null");
 
+  if (mProxyRequest) {
+    mProxyRequest->Cancel(aReason);
+    mProxyRequest = nullptr;
+  }
+
   mProxyCallbacks->OnClose(aReason);
   mProxyCallbacks = nullptr;
 }