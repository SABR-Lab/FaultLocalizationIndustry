# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h
# Commit: 6e1eba5c88ad
# Full Hash: 6e1eba5c88ad47f0a2a3aa37b4c2cae9f31c2ef3
# Author: Byron Campen [:bwc] <docfaraday@gmail.com>
# Date: 2019-09-18 21:49:27
# Regressor Bug: 1569183
# File Overlap Count: 1
# Description:
#   Bug 1569183: Stop doing a proxy lookup to determine whether we're configured to use a proxy (for the proxy_only_if_behind_proxy pref), and instead look at whether we loaded the doc using a proxy. r=mjf,mayhemer,jld
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D45289
# ==============================================================================

diff -r c43589fd0f90 -r 6e1eba5c88ad media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h
--- a/media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h	Tue Sep 17 18:18:33 2019 +0000
+++ b/media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h	Wed Sep 18 14:27:42 2019 +0000
@@ -12,8 +12,8 @@
 #include "mozilla/RefPtr.h"
 #include "mozilla/UniquePtr.h"
 #include "mozilla/net/StunAddrsRequestChild.h"
-#include "nsIProtocolProxyCallback.h"
 #include "MediaTransportHandler.h"
+#include "nsIHttpChannelInternal.h"
 
 #include "TransceiverImpl.h"
 
@@ -125,12 +125,11 @@
   }
 
   nsPIDOMWindowInner* GetWindow() const;
+  already_AddRefed<nsIHttpChannelInternal> GetChannel() const;
 
   void AlpnNegotiated_s(const std::string& aAlpn);
   void AlpnNegotiated_m(const std::string& aAlpn);
 
-  void ProxySettingReceived(bool aProxied);
-
   // TODO: Move to PeerConnectionImpl
   RefPtr<WebRtcCallWrapper> mCall;
 
@@ -139,7 +138,7 @@
 
  private:
   void InitLocalAddrs();  // for stun local address IPC request
-  nsresult InitProxy();
+  bool ShouldForceProxy() const;
   std::unique_ptr<NrSocketProxyConfig> GetProxyConfig() const;
 
   class StunAddrsHandler : public net::StunAddrsListener {
@@ -185,9 +184,7 @@
   void OnCandidateFound_m(const std::string& aTransportId,
                           const CandidateInfo& aCandidateInfo);
 
-  bool IsIceCtxReady() const {
-    return !mWaitingOnProxyLookup && mLocalAddrsCompleted;
-  }
+  bool IsIceCtxReady() const { return mLocalAddrsCompleted; }
 
   // The parent PC
   PeerConnectionImpl* mParent;
@@ -209,9 +206,7 @@
   // gathering or start checking)
   std::vector<nsCOMPtr<nsIRunnable>> mQueuedIceCtxOperations;
 
-  // If the "media.peerconnection.ice.proxy_only_if_behind_proxy" pref is set,
-  // we need to test this before we can know what proxy policy to use.
-  bool mWaitingOnProxyLookup;
+  // Set if prefs dictate that we should force the use of a web proxy.
   bool mForceProxy;
 
   // Used to cancel incoming stun addrs response