# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h
# Commit: f5353ea9f1df
# Full Hash: f5353ea9f1dfe15a65076bc7aa272d688ebdb8ca
# Author: Byron Campen [:bwc] <docfaraday@gmail.com>
# Date: 2019-09-18 21:49:27
# Regressor Bug: 1569183
# File Overlap Count: 2
# Description:
#   Bug 1569183: Add a proxy policy argument to NrSocketProxyConfig, and always set this config on the NrIceCtx. r=mjf
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D45101
# ==============================================================================

diff -r ed1ae6a85255 -r f5353ea9f1df media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h
--- a/media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h	Tue Sep 17 18:17:13 2019 +0000
+++ b/media/webrtc/signaling/src/peerconnection/PeerConnectionMedia.h	Tue Sep 17 18:17:14 2019 +0000
@@ -140,7 +140,7 @@
  private:
   void InitLocalAddrs();  // for stun local address IPC request
   nsresult InitProxy();
-  void SetProxy();
+  std::unique_ptr<NrSocketProxyConfig> GetProxyConfig() const;
 
   class StunAddrsHandler : public net::StunAddrsListener {
    public:
@@ -186,7 +186,7 @@
                           const CandidateInfo& aCandidateInfo);
 
   bool IsIceCtxReady() const {
-    return mProxyResolveCompleted && mLocalAddrsCompleted;
+    return !mWaitingOnProxyLookup && mLocalAddrsCompleted;
   }
 
   // The parent PC
@@ -209,11 +209,10 @@
   // gathering or start checking)
   std::vector<nsCOMPtr<nsIRunnable>> mQueuedIceCtxOperations;
 
-  // Used to track the state of the request.
-  bool mProxyResolveCompleted;
-
-  // Used to track proxy existence and socket proxy configuration.
-  std::unique_ptr<NrSocketProxyConfig> mProxyConfig;
+  // If the "media.peerconnection.ice.proxy_only_if_behind_proxy" pref is set,
+  // we need to test this before we can know what proxy policy to use.
+  bool mWaitingOnProxyLookup;
+  bool mForceProxy;
 
   // Used to cancel incoming stun addrs response
   RefPtr<net::StunAddrsRequestChild> mStunAddrsRequest;
