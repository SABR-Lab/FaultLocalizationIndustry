# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: tools/profiler/tests/gtest/ThreadProfileTest.cpp
# Commit: fd3a29881783
# Full Hash: fd3a29881783aad22258c96c6ea04220a40f2648
# Author: Gerald Squelart <gsquelart@mozilla.com>
# Date: 2019-09-18 09:56:40
# Regressor Bug: 1576551
# File Overlap Count: 1
# Description:
#   Bug 1576551 - Store BlocksRingBuffer outside of ProfileBuffer - r=gregtatum
#   
#   The main `BlocksRingBuffer`s will be stored in `CorePS` (outside of
#   `ProfileBuffer`s), as we need to be able to safely access the underlying buffers
#   when profilers are not enabled.
# ==============================================================================

diff -r 3dfc76ea7bd9 -r fd3a29881783 tools/profiler/tests/gtest/ThreadProfileTest.cpp
--- a/tools/profiler/tests/gtest/ThreadProfileTest.cpp	Wed Sep 18 01:19:14 2019 +0000
+++ b/tools/profiler/tests/gtest/ThreadProfileTest.cpp	Wed Sep 18 01:19:21 2019 +0000
@@ -14,7 +14,10 @@
 // Make sure we can record one entry and read it
 TEST(ThreadProfile, InsertOneEntry)
 {
+  mozilla::BlocksRingBuffer blocksRingBuffer(
+      BlocksRingBuffer::ThreadSafety::WithMutex);
   auto pb = MakeUnique<ProfileBuffer>(
+      blocksRingBuffer,
       mozilla::PowerOfTwo32(2 * (1 + uint32_t(sizeof(ProfileBufferEntry)))));
   pb->AddEntry(ProfileBufferEntry::Time(123.1));
   ProfileBufferEntry entry = pb->GetEntry(pb->BufferRangeStart());
@@ -25,7 +28,10 @@
 // See if we can insert some entries
 TEST(ThreadProfile, InsertEntriesNoWrap)
 {
+  mozilla::BlocksRingBuffer blocksRingBuffer(
+      BlocksRingBuffer::ThreadSafety::WithMutex);
   auto pb = MakeUnique<ProfileBuffer>(
+      blocksRingBuffer,
       mozilla::PowerOfTwo32(100 * (1 + uint32_t(sizeof(ProfileBufferEntry)))));
   const int test_size = 50;
   for (int i = 0; i < test_size; i++) {
