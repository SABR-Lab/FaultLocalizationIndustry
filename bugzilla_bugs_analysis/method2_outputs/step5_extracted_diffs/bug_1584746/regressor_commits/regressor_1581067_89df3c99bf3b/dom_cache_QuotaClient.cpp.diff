# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/cache/QuotaClient.cpp
# Commit: 89df3c99bf3b
# Full Hash: 89df3c99bf3bb8ba1918b2685ac8fa4df6ff9e98
# Author: Tom Tung <shes050117@gmail.com>
# Date: 2019-09-28 09:46:05
# Regressor Bug: 1581067
# File Overlap Count: 1
# Description:
#   Bug 1581067 - P2 - Extract similar to reuse the code; r=asuth
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D46780
# ==============================================================================

diff -r fbfdd8ee1b42 -r 89df3c99bf3b dom/cache/QuotaClient.cpp
--- a/dom/cache/QuotaClient.cpp	Fri Sep 27 16:54:22 2019 +0000
+++ b/dom/cache/QuotaClient.cpp	Fri Sep 27 16:54:45 2019 +0000
@@ -68,56 +68,30 @@
       continue;
     }
 
-    nsCOMPtr<nsIDirectoryEnumerator> subEntries;
-    rv = bodyDir->GetDirectoryEntries(getter_AddRefs(subEntries));
-    if (NS_WARN_IF(NS_FAILED(rv))) {
-      return rv;
-    }
-
-    bool isEmpty = true;
-    nsCOMPtr<nsIFile> bodyFile;
-    while (
-        NS_SUCCEEDED(rv = subEntries->GetNextFile(getter_AddRefs(bodyFile))) &&
-        bodyFile && !aCanceled) {
-      bool isDirectory;
-      rv = bodyFile->IsDirectory(&isDirectory);
-      if (NS_WARN_IF(NS_FAILED(rv))) {
-        return rv;
-      }
-
-      if (isDirectory) {
-        QuotaInfo dummy;
-        mozilla::DebugOnly<nsresult> result =
-            RemoveNsIFileRecursively(dummy, bodyFile, /* aTrackQuota */ false);
-        // Try to remove the unexpected files, and keep moving on even if it
-        // fails because it might be created by virus or the operation system
-        MOZ_ASSERT(NS_SUCCEEDED(result));
-        continue;
-      }
-
-      isEmpty = false;
+    const QuotaInfo dummy;
+    const auto getUsage = [&aUsageInfo](nsIFile* bodyFile,
+                                        const nsACString& leafName,
+                                        bool& fileDeleted) {
+      MOZ_DIAGNOSTIC_ASSERT(bodyFile);
+      Unused << leafName;
 
       int64_t fileSize;
-      rv = bodyFile->GetFileSize(&fileSize);
+      nsresult rv = bodyFile->GetFileSize(&fileSize);
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
       }
       MOZ_DIAGNOSTIC_ASSERT(fileSize >= 0);
+      aUsageInfo->AppendToFileUsage(Some(fileSize));
 
-      aUsageInfo->AppendToFileUsage(Some(fileSize));
-    }
+      fileDeleted = false;
+
+      return NS_OK;
+    };
+    rv = mozilla::dom::cache::BodyTraverseFiles(dummy, bodyDir, getUsage,
+                                                /* aTrackQuota */ false);
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
-
-    if (isEmpty) {
-      QuotaInfo dummy;
-      mozilla::DebugOnly<nsresult> result =
-          RemoveNsIFileRecursively(dummy, bodyDir, /* aTrackQuota */ false);
-      // Try to remove the unexpected files, and keep moving on even if it
-      // fails because it might be created by virus or the operation system
-      MOZ_ASSERT(NS_SUCCEEDED(result));
-    }
   }
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
