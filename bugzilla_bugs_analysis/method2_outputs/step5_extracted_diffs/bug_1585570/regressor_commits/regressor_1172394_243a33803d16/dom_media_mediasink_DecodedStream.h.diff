# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/mediasink/DecodedStream.h
# Commit: 243a33803d16
# Full Hash: 243a33803d16d50cfcc8cf0a5c4739a5ed08dc55
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2018-11-23 21:37:23
# Regressor Bug: 1172394
# File Overlap Count: 1
# Description:
#   Bug 1423241 - Refactor DecodedStream. r=jya
#   
#   This removes DecodedStream's use of MediaStreamListener in favor of
#   MediaStreamTrackListener. This change has however rippled through to a lot
#   more cleanup, per below.
# ==============================================================================

diff -r 12f91d8a1f69 -r 243a33803d16 dom/media/mediasink/DecodedStream.h
--- a/dom/media/mediasink/DecodedStream.h	Fri Nov 23 15:01:48 2018 +0000
+++ b/dom/media/mediasink/DecodedStream.h	Fri Nov 23 15:02:03 2018 +0000
@@ -16,6 +16,7 @@
 #include "mozilla/Maybe.h"
 #include "mozilla/MozPromise.h"
 #include "mozilla/RefPtr.h"
+#include "mozilla/StateMirroring.h"
 #include "mozilla/UniquePtr.h"
 
 namespace mozilla {
@@ -40,8 +41,7 @@
                 MediaQueue<AudioData>& aAudioQueue,
                 MediaQueue<VideoData>& aVideoQueue,
                 OutputStreamManager* aOutputStreamManager,
-                const bool& aSameOrigin,
-                const PrincipalHandle& aPrincipalHandle);
+                const bool& aSameOrigin);
 
   // MediaSink functions.
   const PlaybackParams& GetPlaybackParams() const override;
@@ -65,6 +65,7 @@
   void Stop() override;
   bool IsStarted() const override;
   bool IsPlaying() const override;
+  void Shutdown() override;
 
   nsCString GetDebugInfo() override;
 
@@ -76,17 +77,21 @@
     return media::TimeUnit::FromMicroseconds(aTime);
   }
   void DestroyData(UniquePtr<DecodedStreamData> aData);
-  void AdvanceTracks();
   void SendAudio(double aVolume, bool aIsSameOrigin,
                  const PrincipalHandle& aPrincipalHandle);
   void SendVideo(bool aIsSameOrigin, const PrincipalHandle& aPrincipalHandle);
+  StreamTime SentDuration();
+  void AdvanceTracks();
   void SendData();
   void NotifyOutput(int64_t aTime);
+  void NotifyTrackEnd(StreamTime aEndTime);
 
   void AssertOwnerThread() const {
     MOZ_ASSERT(mOwnerThread->IsCurrentThreadIn());
   }
 
+  void PlayingChanged();
+
   void ConnectListener();
   void DisconnectListener();
 
@@ -103,17 +108,20 @@
   /*
    * Worker thread only members.
    */
+  WatchManager<DecodedStream> mWatchManager;
   UniquePtr<DecodedStreamData> mData;
-  RefPtr<GenericPromise> mFinishPromise;
+  RefPtr<GenericPromise> mAudioEndPromise;
+  RefPtr<GenericPromise> mVideoEndPromise;
 
-  bool mPlaying;
-  const bool& mSameOrigin;                  // valid until Shutdown() is called.
-  const PrincipalHandle& mPrincipalHandle;  // valid until Shutdown() is called.
+  Watchable<bool> mPlaying;
+  const bool& mSameOrigin;  // valid until Shutdown() is called.
+  Mirror<PrincipalHandle> mPrincipalHandle;
 
   PlaybackParams mParams;
 
   media::NullableTimeUnit mStartTime;
   media::TimeUnit mLastOutputTime;
+  StreamTime mStreamTimeOffset = 0;
   MediaInfo mInfo;
 
   MediaQueue<AudioData>& mAudioQueue;