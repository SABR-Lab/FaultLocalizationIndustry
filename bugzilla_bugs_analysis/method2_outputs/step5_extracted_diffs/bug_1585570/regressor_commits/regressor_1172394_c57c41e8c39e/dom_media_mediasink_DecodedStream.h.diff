# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/mediasink/DecodedStream.h
# Commit: c57c41e8c39e
# Full Hash: c57c41e8c39ea51e96c13af8ecdcbe1640e2a9d6
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-11-14 17:12:31
# Regressor Bug: 1172394
# File Overlap Count: 1
# Description:
#   Bug 1172394 - Refactor how DecodedStream is set up. r=padenot
#   
#   This patch removes the responsibility of js-facing MediaStreamTracks from the
#   MediaDecoder stack, and moves the machinery for setting up DecodedStream to
#   higher order functions like state mirroring and watchables.
# ==============================================================================

diff -r a796541fe5ef -r c57c41e8c39e dom/media/mediasink/DecodedStream.h
--- a/dom/media/mediasink/DecodedStream.h	Wed Nov 13 08:55:29 2019 +0000
+++ b/dom/media/mediasink/DecodedStream.h	Wed Nov 13 08:55:39 2019 +0000
@@ -22,9 +22,9 @@
 namespace mozilla {
 
 class DecodedStreamData;
+class MediaDecoderStateMachine;
 class AudioData;
 class VideoData;
-class OutputStreamManager;
 struct PlaybackInfoInit;
 class ProcessedMediaTrack;
 class TimeStamp;
@@ -36,10 +36,10 @@
   using MediaSink::PlaybackParams;
 
  public:
-  DecodedStream(AbstractThread* aOwnerThread, AbstractThread* aMainThread,
+  DecodedStream(MediaDecoderStateMachine* aStateMachine,
+                nsTArray<RefPtr<ProcessedMediaTrack>> aOutputTracks,
                 MediaQueue<AudioData>& aAudioQueue,
-                MediaQueue<VideoData>& aVideoQueue,
-                OutputStreamManager* aOutputStreamManager);
+                MediaQueue<VideoData>& aVideoQueue);
 
   // MediaSink functions.
   const PlaybackParams& GetPlaybackParams() const override;
@@ -88,14 +88,6 @@
 
   const RefPtr<AbstractThread> mOwnerThread;
 
-  const RefPtr<AbstractThread> mAbstractMainThread;
-
-  /*
-   * Main thread only members.
-   */
-  // Data about MediaStreams that are being fed by the decoder.
-  const RefPtr<OutputStreamManager> mOutputStreamManager;
-
   /*
    * Worker thread only members.
    */
@@ -106,6 +98,7 @@
 
   Watchable<bool> mPlaying;
   Mirror<PrincipalHandle> mPrincipalHandle;
+  const nsTArray<RefPtr<ProcessedMediaTrack>> mOutputTracks;
 
   PlaybackParams mParams;
 