# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/antitracking/AntiTrackingCommon.cpp
# Commit: f2df73fda468
# Full Hash: f2df73fda46859150605f33bcdaeb49ab7037720
# Author: Jean-Yves Avenard <jyavenard@mozilla.com>
# Date: 2019-10-19 21:40:34
# Regressor Bug: 1588899
# File Overlap Count: 1
# Description:
#   Bug 1588899 - P1. Move classification flags related method to nsIClassifiedChannel. r=Ehsan,baku
#   
#   This is where it should have been in the first place. Those attributes belong there.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D49577
# ==============================================================================

diff -r b98968eb71d3 -r f2df73fda468 toolkit/components/antitracking/AntiTrackingCommon.cpp
--- a/toolkit/components/antitracking/AntiTrackingCommon.cpp	Thu Oct 17 15:24:31 2019 +0000
+++ b/toolkit/components/antitracking/AntiTrackingCommon.cpp	Sat Oct 19 04:30:24 2019 +0000
@@ -21,6 +21,7 @@
 #include "mozIThirdPartyUtil.h"
 #include "nsContentUtils.h"
 #include "nsGlobalWindowInner.h"
+#include "nsIClassifiedChannel.h"
 #include "nsICookiePermission.h"
 #include "nsICookieService.h"
 #include "nsIDocShell.h"
@@ -892,22 +893,23 @@
       nsIWebProgressListener::STATE_COOKIES_LOADED, aReportingChannel, false,
       aURI, aTrackingChannel);
 
-  nsCOMPtr<nsIHttpChannel> httpChannel = do_QueryInterface(aTrackingChannel);
-  if (!httpChannel) {
+  nsCOMPtr<nsIClassifiedChannel> classifiedChannel =
+      do_QueryInterface(aTrackingChannel);
+  if (!classifiedChannel) {
     return;
   }
 
   uint32_t classificationFlags =
-      httpChannel->GetThirdPartyClassificationFlags();
+      classifiedChannel->GetThirdPartyClassificationFlags();
   if (classificationFlags &
-      nsIHttpChannel::ClassificationFlags::CLASSIFIED_TRACKING) {
+      nsIClassifiedChannel::ClassificationFlags::CLASSIFIED_TRACKING) {
     aWindow->NotifyContentBlockingEvent(
         nsIWebProgressListener::STATE_COOKIES_LOADED_TRACKER, aReportingChannel,
         false, aURI, aTrackingChannel);
   }
 
   if (classificationFlags &
-      nsIHttpChannel::ClassificationFlags::CLASSIFIED_SOCIALTRACKING) {
+      nsIClassifiedChannel::ClassificationFlags::CLASSIFIED_SOCIALTRACKING) {
     aWindow->NotifyContentBlockingEvent(
         nsIWebProgressListener::STATE_COOKIES_LOADED_SOCIALTRACKER,
         aReportingChannel, false, aURI, aTrackingChannel);
@@ -1683,15 +1685,19 @@
       nsIWebProgressListener::STATE_COOKIES_BLOCKED_TRACKER;
 
   // Not a tracker.
+  nsCOMPtr<nsIClassifiedChannel> classifiedChannel =
+      do_QueryInterface(aChannel);
   if (behavior == nsICookieService::BEHAVIOR_REJECT_TRACKER) {
-    if (httpChannel && !httpChannel->IsThirdPartyTrackingResource()) {
+    if (classifiedChannel &&
+        !classifiedChannel->IsThirdPartyTrackingResource()) {
       LOG(("Our channel isn't a third-party tracking channel"));
       return true;
     }
   } else {
     MOZ_ASSERT(behavior ==
                nsICookieService::BEHAVIOR_REJECT_TRACKER_AND_PARTITION_FOREIGN);
-    if (httpChannel && httpChannel->IsThirdPartyTrackingResource()) {
+    if (classifiedChannel &&
+        classifiedChannel->IsThirdPartyTrackingResource()) {
       // fall through
     } else if (nsContentUtils::IsThirdPartyWindowOrChannel(nullptr, aChannel,
                                                            aURI)) {