# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/indexedDB/ActorsParent.cpp
# Commit: 13e00068cb2b
# Full Hash: 13e00068cb2bf553f6badfbacbbc7decfcfdf4bf
# Author: Birunthan Mohanathas <birunthan@mohanathas.com>
# Date: 2015-08-23 21:18:49
# Regressor Bug: 1168606
# File Overlap Count: 1
# Description:
#   Bug 1168606 - Part 5: Send two records with every ObjectStoreCursorResponse. r=khuey
# ==============================================================================

diff -r 8e9fb56cc22a -r 13e00068cb2b dom/indexedDB/ActorsParent.cpp
--- a/dom/indexedDB/ActorsParent.cpp	Wed Aug 19 14:59:28 2015 -0700
+++ b/dom/indexedDB/ActorsParent.cpp	Wed Aug 19 14:59:29 2015 -0700
@@ -14778,8 +14778,6 @@
 #endif
     ;
 
-  MOZ_ASSERT(aKey.IsUnset());
-
   if (!trustParams && !VerifyRequestParams(aParams)) {
     ASSERT_UNLESS_FUZZING();
     return false;
@@ -25284,33 +25282,30 @@
 
   // Note: Changing the number or order of SELECT columns in the query will
   // require changes to CursorOpBase::PopulateResponseFromStatement.
-  nsCString query;
-  nsAutoCString countString;
-
   bool hasContinueKey = false;
-  uint32_t advanceCount;
+  uint32_t advanceCount = 1;
 
   if (mParams.type() == CursorRequestParams::TContinueParams) {
     // Always go to the next result.
-    advanceCount = 1;
-    countString.AppendLiteral("1");
-
     if (mParams.get_ContinueParams().key().IsUnset()) {
-      query = mCursor->mContinueQuery + countString;
       hasContinueKey = false;
     } else {
-      query = mCursor->mContinueToQuery + countString;
       hasContinueKey = true;
     }
   } else {
     advanceCount = mParams.get_AdvanceParams().count();
-    MOZ_ASSERT(advanceCount > 0);
-    countString.AppendInt(advanceCount);
-
-    query = mCursor->mContinueQuery + countString;
     hasContinueKey = false;
   }
 
+  const nsCString& continueQuery =
+    hasContinueKey ? mCursor->mContinueToQuery : mCursor->mContinueQuery;
+
+  MOZ_ASSERT(advanceCount > 0);
+  nsAutoCString countString;
+  countString.AppendInt(advanceCount);
+
+  nsCString query = continueQuery + countString;
+
   NS_NAMED_LITERAL_CSTRING(currentKeyName, "current_key");
   NS_NAMED_LITERAL_CSTRING(rangeKeyName, "range_key");
   NS_NAMED_LITERAL_CSTRING(objectKeyName, "object_key");
@@ -25380,6 +25375,23 @@
     return rv;
   }
 
+  uint32_t extraCount = 1;
+  for (uint32_t i = 0; i < extraCount; i++) {
+    rv = stmt->ExecuteStep(&hasResult);
+    if (NS_WARN_IF(NS_FAILED(rv))) {
+      return rv;
+    }
+
+    if (!hasResult) {
+      break;
+    }
+
+    rv = PopulateResponseFromStatement(stmt, false);
+    if (NS_WARN_IF(NS_FAILED(rv))) {
+      return rv;
+    }
+  }
+
   return NS_OK;
 }
 