# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/indexedDB/IDBObjectStore.cpp
# Commit: 300dc3034eeb
# Full Hash: 300dc3034eebd2fc8bcf24e47d886b27b793703e
# Author: Simon Giesecke <sgiesecke@mozilla.com>
# Date: 2019-09-10 15:51:07
# Regressor Bug: 1168606
# File Overlap Count: 1
# Description:
#   Bug 1168606 - Reduce code duplication for different open cursor variants. r=ttung
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D40956
# ==============================================================================

diff -r d6aa1c5bc7d9 -r 300dc3034eeb dom/indexedDB/IDBObjectStore.cpp
--- a/dom/indexedDB/IDBObjectStore.cpp	Tue Sep 10 16:47:26 2019 +0300
+++ b/dom/indexedDB/IDBObjectStore.cpp	Tue Sep 10 16:47:41 2019 +0300
@@ -2270,22 +2270,14 @@
 
   IDBCursor::Direction direction = IDBCursor::ConvertDirection(aDirection);
 
-  OpenCursorParams params;
-  if (aKeysOnly) {
-    ObjectStoreOpenKeyCursorParams openParams;
-    openParams.commonParams().objectStoreId() = objectStoreId;
-    openParams.commonParams().optionalKeyRange() = std::move(optionalKeyRange);
-    openParams.commonParams().direction() = direction;
-
-    params = std::move(openParams);
-  } else {
-    ObjectStoreOpenCursorParams openParams;
-    openParams.commonParams().objectStoreId() = objectStoreId;
-    openParams.commonParams().optionalKeyRange() = std::move(optionalKeyRange);
-    openParams.commonParams().direction() = direction;
-
-    params = std::move(openParams);
-  }
+  const CommonOpenCursorParams commonParams = {
+      objectStoreId, std::move(optionalKeyRange), direction};
+
+  // TODO: It would be great if the IPDL generator created a constructor
+  // accepting a CommonOpenCursorParams by value or rvalue reference.
+  const auto params =
+      aKeysOnly ? OpenCursorParams{ObjectStoreOpenKeyCursorParams{commonParams}}
+                : OpenCursorParams{ObjectStoreOpenCursorParams{commonParams}};
 
   RefPtr<IDBRequest> request = GenerateRequest(aCx, this);
   MOZ_ASSERT(request);
