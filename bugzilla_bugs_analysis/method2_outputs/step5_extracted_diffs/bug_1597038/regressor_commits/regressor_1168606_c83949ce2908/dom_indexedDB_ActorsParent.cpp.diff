# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/indexedDB/ActorsParent.cpp
# Commit: c83949ce2908
# Full Hash: c83949ce29083a570fd5883240c7c1a0e9e29694
# Author: Simon Giesecke <sgiesecke@mozilla.com>
# Date: 2019-10-17 15:35:53
# Regressor Bug: 1168606
# File Overlap Count: 1
# Description:
#   Bug 1168606 - Fix code generation issue on Mac OS X. r=acreskey,ttung
#   
#   As reported in https://bugzilla.mozilla.org/show_bug.cgi?id=1168606#c110,
#   some Mac OS X release build crashes with the original code, probably due
#   to some temporary string being destroyed prematurely. Assigning to a
# ==============================================================================

diff -r fe00ae5e7187 -r c83949ce2908 dom/indexedDB/ActorsParent.cpp
--- a/dom/indexedDB/ActorsParent.cpp	Thu Oct 17 09:31:21 2019 +0000
+++ b/dom/indexedDB/ActorsParent.cpp	Thu Oct 17 09:55:03 2019 +0000
@@ -26082,13 +26082,16 @@
 
   NS_NAMED_LITERAL_CSTRING(sortColumn, "sort_column");
 
-  const nsCString sortColumnAlias =
-      NS_LITERAL_CSTRING("SELECT ") +
-      MakeColumnPairSelectionList(
-          NS_LITERAL_CSTRING("index_table.value"),
-          NS_LITERAL_CSTRING("index_table.value_locale"), sortColumn,
-          mCursor->IsLocaleAware()) +
-      NS_LITERAL_CSTRING(", ");
+  // The result of MakeColumnPairSelectionList is stored in a local variable,
+  // since inlining it into the next statement causes a crash on some Mac OS X
+  // builds (see https://bugzilla.mozilla.org/show_bug.cgi?id=1168606#c110).
+  const auto columnPairSelectionList = MakeColumnPairSelectionList(
+      NS_LITERAL_CSTRING("index_table.value"),
+      NS_LITERAL_CSTRING("index_table.value_locale"), sortColumn,
+      mCursor->IsLocaleAware());
+  const nsCString sortColumnAlias = NS_LITERAL_CSTRING("SELECT ") +
+                                    columnPairSelectionList +
+                                    NS_LITERAL_CSTRING(", ");
 
   nsAutoCString queryStart = sortColumnAlias +
                              NS_LITERAL_CSTRING(
@@ -26201,12 +26204,15 @@
 
   NS_NAMED_LITERAL_CSTRING(sortColumn, "sort_column");
 
-  const nsCString sortColumnAlias =
-      NS_LITERAL_CSTRING("SELECT ") +
-      MakeColumnPairSelectionList(NS_LITERAL_CSTRING("value"),
-                                  NS_LITERAL_CSTRING("value_locale"),
-                                  sortColumn, mCursor->IsLocaleAware()) +
-      NS_LITERAL_CSTRING(", ");
+  // The result of MakeColumnPairSelectionList is stored in a local variable,
+  // since inlining it into the next statement causes a crash on some Mac OS X
+  // builds (see https://bugzilla.mozilla.org/show_bug.cgi?id=1168606#c110).
+  const auto columnPairSelectionList = MakeColumnPairSelectionList(
+      NS_LITERAL_CSTRING("value"), NS_LITERAL_CSTRING("value_locale"),
+      sortColumn, mCursor->IsLocaleAware());
+  const nsCString sortColumnAlias = NS_LITERAL_CSTRING("SELECT ") +
+                                    columnPairSelectionList +
+                                    NS_LITERAL_CSTRING(", ");
 
   nsAutoCString queryStart = sortColumnAlias +
                              NS_LITERAL_CSTRING(
