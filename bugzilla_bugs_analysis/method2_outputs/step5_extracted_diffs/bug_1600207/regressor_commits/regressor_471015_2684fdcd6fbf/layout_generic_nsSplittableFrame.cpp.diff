# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/generic/nsSplittableFrame.cpp
# Commit: 2684fdcd6fbf
# Full Hash: 2684fdcd6fbff5abe54a3e1c018e7188abb4076c
# Author: Mats Palmgren <mats@mozilla.com>
# Date: 2019-11-26 09:34:48
# Regressor Bug: 471015
# File Overlap Count: 1
# Description:
#   Bug 471015 - [css-break] Implement <fieldset> fragmentation.  r=TYLin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D53709
# ==============================================================================

diff -r e29eecc5147c -r 2684fdcd6fbf layout/generic/nsSplittableFrame.cpp
--- a/layout/generic/nsSplittableFrame.cpp	Mon Nov 25 15:28:50 2019 +0000
+++ b/layout/generic/nsSplittableFrame.cpp	Mon Nov 25 21:45:22 2019 +0000
@@ -11,6 +11,7 @@
 
 #include "nsSplittableFrame.h"
 #include "nsContainerFrame.h"
+#include "nsFieldSetFrame.h"
 #include "nsIFrameInlines.h"
 
 using namespace mozilla;
@@ -205,6 +206,18 @@
 
   bSize -= aConsumedBSize;
 
+  // nsFieldSetFrame's inner frames are special since some of their content-box
+  // BSize may be consumed by positioning it below the legend.  So we always
+  // report zero for true overflow containers here.
+  // XXXmats: hmm, can we fix this so that the sizes actually adds up instead?
+  if (IS_TRUE_OVERFLOW_CONTAINER(this) &&
+      Style()->GetPseudoType() == PseudoStyleType::fieldsetContent) {
+    for (nsFieldSetFrame* fieldset = do_QueryFrame(GetParent()); fieldset;
+         fieldset = static_cast<nsFieldSetFrame*>(fieldset->GetPrevInFlow())) {
+      bSize -= fieldset->LegendSpace();
+    }
+  }
+
   // We may have stretched the frame beyond its computed height. Oh well.
   return std::max(0, bSize);
 }