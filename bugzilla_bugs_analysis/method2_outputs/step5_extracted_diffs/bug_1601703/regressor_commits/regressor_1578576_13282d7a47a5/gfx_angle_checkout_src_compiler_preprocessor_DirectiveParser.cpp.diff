# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/angle/checkout/src/compiler/preprocessor/DirectiveParser.cpp
# Commit: 13282d7a47a5
# Full Hash: 13282d7a47a57a73be8d060efd9645b4d642f03e
# Author: Miko Mynttinen <mikokm@gmail.com>
# Date: 2019-09-08 09:46:52
# Regressor Bug: 1578576
# File Overlap Count: 4
# Description:
#   Bug 1578576 - Part 2: Update to ANGLE 3865 r=jgilbert
#   
#   Depends on D44561
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D44579
# ==============================================================================

diff -r 3064469c073d -r 13282d7a47a5 gfx/angle/checkout/src/compiler/preprocessor/DirectiveParser.cpp
--- a/gfx/angle/checkout/src/compiler/preprocessor/DirectiveParser.cpp	Sat Sep 07 13:36:46 2019 +0000
+++ b/gfx/angle/checkout/src/compiler/preprocessor/DirectiveParser.cpp	Sat Sep 07 13:38:36 2019 +0000
@@ -10,6 +10,7 @@
 #include <cstdlib>
 #include <sstream>
 
+#include "GLSLANG/ShaderLang.h"
 #include "common/debug.h"
 #include "compiler/preprocessor/DiagnosticsBase.h"
 #include "compiler/preprocessor/DirectiveHandlerBase.h"
@@ -668,16 +669,16 @@
     }
     if (valid && mSeenNonPreprocessorToken)
     {
-        if (mShaderVersion >= 300)
+        if (mSettings.shaderSpec == SH_WEBGL_SPEC && mShaderVersion < 300)
         {
-            mDiagnostics->report(Diagnostics::PP_NON_PP_TOKEN_BEFORE_EXTENSION_ESSL3,
+            mDiagnostics->report(Diagnostics::PP_NON_PP_TOKEN_BEFORE_EXTENSION_WEBGL,
                                  token->location, token->text);
-            valid = false;
         }
         else
         {
-            mDiagnostics->report(Diagnostics::PP_NON_PP_TOKEN_BEFORE_EXTENSION_ESSL1,
+            mDiagnostics->report(Diagnostics::PP_NON_PP_TOKEN_BEFORE_EXTENSION_ESSL,
                                  token->location, token->text);
+            valid = false;
         }
     }
     if (valid)
@@ -699,7 +700,8 @@
     enum State
     {
         VERSION_NUMBER,
-        VERSION_PROFILE,
+        VERSION_PROFILE_ES,
+        VERSION_PROFILE_GL,
         VERSION_ENDLINE
     };
 
@@ -727,10 +729,22 @@
                 }
                 if (valid)
                 {
-                    state = (version < 300) ? VERSION_ENDLINE : VERSION_PROFILE;
+                    if (sh::IsDesktopGLSpec(mSettings.shaderSpec))
+                    {
+                        state = VERSION_PROFILE_GL;
+                    }
+                    else if (version < 300)
+                    {
+                        state = VERSION_ENDLINE;
+                    }
+                    else
+                    {
+                        state = VERSION_PROFILE_ES;
+                    }
                 }
                 break;
-            case VERSION_PROFILE:
+            case VERSION_PROFILE_ES:
+                ASSERT(!sh::IsDesktopGLSpec(mSettings.shaderSpec));
                 if (token->type != Token::IDENTIFIER || token->text != "es")
                 {
                     mDiagnostics->report(Diagnostics::PP_INVALID_VERSION_DIRECTIVE, token->location,
@@ -739,6 +753,16 @@
                 }
                 state = VERSION_ENDLINE;
                 break;
+            case VERSION_PROFILE_GL:
+                ASSERT(sh::IsDesktopGLSpec(mSettings.shaderSpec));
+                if (token->type != Token::IDENTIFIER || token->text != "core")
+                {
+                    mDiagnostics->report(Diagnostics::PP_INVALID_VERSION_DIRECTIVE, token->location,
+                                         token->text);
+                    valid = false;
+                }
+                state = VERSION_ENDLINE;
+                break;
             default:
                 mDiagnostics->report(Diagnostics::PP_UNEXPECTED_TOKEN, token->location,
                                      token->text);
@@ -747,6 +771,11 @@
         }
 
         mTokenizer->lex(token);
+
+        if (token->type == '\n' && state == VERSION_PROFILE_GL)
+        {
+            state = VERSION_ENDLINE;
+        }
     }
 
     if (valid && (state != VERSION_ENDLINE))
@@ -765,7 +794,7 @@
 
     if (valid)
     {
-        mDirectiveHandler->handleVersion(token->location, version);
+        mDirectiveHandler->handleVersion(token->location, version, mSettings.shaderSpec);
         mShaderVersion = version;
         PredefineMacro(mMacroSet, "__VERSION__", version);
     }