# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/angle/checkout/src/libANGLE/renderer/d3d/DynamicImage2DHLSL.cpp
# Commit: 13282d7a47a5
# Full Hash: 13282d7a47a57a73be8d060efd9645b4d642f03e
# Author: Miko Mynttinen <mikokm@gmail.com>
# Date: 2019-09-08 09:46:52
# Regressor Bug: 1578576
# File Overlap Count: 4
# Description:
#   Bug 1578576 - Part 2: Update to ANGLE 3865 r=jgilbert
#   
#   Depends on D44561
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D44579
# ==============================================================================

diff -r 3064469c073d -r 13282d7a47a5 gfx/angle/checkout/src/libANGLE/renderer/d3d/DynamicImage2DHLSL.cpp
--- a/gfx/angle/checkout/src/libANGLE/renderer/d3d/DynamicImage2DHLSL.cpp	Sat Sep 07 13:36:46 2019 +0000
+++ b/gfx/angle/checkout/src/libANGLE/renderer/d3d/DynamicImage2DHLSL.cpp	Sat Sep 07 13:38:36 2019 +0000
@@ -325,7 +325,7 @@
     }
 }
 
-std::string getImageMetadataLayer(Image2DHLSLGroup group)
+std::string getImageMetadata(Image2DHLSLGroup group)
 {
     switch (group)
     {
@@ -334,13 +334,13 @@
         case IMAGE2D_R_SNORM:
         case IMAGE2D_R_UINT4:
         case IMAGE2D_R_INT4:
-            return "readonlyImageMetadata[imageIndex - readonlyImageIndexStart].layer";
+            return "readonlyImageMetadata[imageIndex - readonlyImageIndexStart]";
         case IMAGE2D_W_FLOAT4:
         case IMAGE2D_W_UNORM:
         case IMAGE2D_W_SNORM:
         case IMAGE2D_W_UINT4:
         case IMAGE2D_W_INT4:
-            return "imageMetadata[imageIndex - imageIndexStart].layer";
+            return "imageMetadata[imageIndex - imageIndexStart]";
         default:
             UNREACHABLE();
             return "unknown image method";
@@ -390,7 +390,8 @@
                                unsigned int texture3DCount,
                                unsigned int texture2DArrayCount,
                                const std::string &offsetStr,
-                               const std::string &declarationStr)
+                               const std::string &declarationStr,
+                               bool getDimensionsIgnoresBaseLevel)
 {
     out << getImage2DGroupReturnType(textureGroup, IMAGE2DSIZE) << " "
         << Image2DHLSLGroupFunctionName(textureGroup, IMAGE2DSIZE) << "(";
@@ -404,7 +405,17 @@
         if (texture2DCount == totalCount)
         {
             out << "    const uint index = imageIndex -  " << offsetStr << "2D;\n";
-            out << "    " << declarationStr << "2D[index].GetDimensions(width, height);\n";
+            if (getDimensionsIgnoresBaseLevel)
+            {
+                out << "    uint levelCount;\n";
+                out << "    const uint level = " << getImageMetadata(textureGroup) << ".level;\n";
+                out << "    " << declarationStr
+                    << "2D[index].GetDimensions(level, width, height, levelCount);\n";
+            }
+            else
+            {
+                out << "    " << declarationStr << "2D[index].GetDimensions(width, height);\n";
+            }
         }
         else
         {
@@ -519,7 +530,7 @@
         {
             out << "    const uint index = imageIndex -  " << offsetStr << "3D;\n";
             out << "    result = " << declarationStr << "3D[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")];\n";
+                << getImageMetadata(textureGroup) << ".layer)];\n";
         }
         else
         {
@@ -543,7 +554,7 @@
             out << "    {\n";
             out << "        const uint index = imageIndex -  " << offsetStr << "3D;\n";
             out << "        result = " << declarationStr << "3D[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")];\n";
+                << getImageMetadata(textureGroup) << ".layer)];\n";
             out << "    }\n";
         }
     }
@@ -554,7 +565,7 @@
         {
             out << "    const uint index = imageIndex -  " << offsetStr << "2DArray;\n";
             out << "    result = " << declarationStr << "2DArray[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")];\n";
+                << getImageMetadata(textureGroup) << ".layer)];\n";
         }
         else
         {
@@ -562,7 +573,7 @@
             out << "    {\n";
             out << "        const uint index = imageIndex -  " << offsetStr << "2DArray;\n";
             out << "        result = " << declarationStr << "2DArray[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")];\n";
+                << getImageMetadata(textureGroup) << ".layer)];\n";
             out << "    }\n";
         }
     }
@@ -610,7 +621,7 @@
         {
             out << "    const uint index = imageIndex -  " << offsetStr << "3D;\n";
             out << "    " << declarationStr << "3D[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")] = data;\n";
+                << getImageMetadata(textureGroup) << ".layer)] = data;\n";
         }
         else
         {
@@ -634,7 +645,7 @@
             out << "    {\n";
             out << "        const uint index = imageIndex -  " << offsetStr << "3D;\n";
             out << "        " << declarationStr << "3D[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")] = data;\n";
+                << getImageMetadata(textureGroup) << ".layer)] = data;\n";
             out << "    }\n";
         }
     }
@@ -645,7 +656,7 @@
         {
             out << "    const uint index = imageIndex -  " << offsetStr << "2DArray;\n";
             out << "    " << declarationStr << "2DArray[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")] = data;\n";
+                << getImageMetadata(textureGroup) << ".layer)] = data;\n";
         }
         else
         {
@@ -653,7 +664,7 @@
             out << "    {\n";
             out << "        const uint index = imageIndex -  " << offsetStr << "2DArray;\n";
             out << "        " << declarationStr << "2DArray[index][uint3(p.x, p.y, "
-                << getImageMetadataLayer(textureGroup) << ")] = data;\n";
+                << getImageMetadata(textureGroup) << ".layer)] = data;\n";
             out << "    }\n";
         }
     }
@@ -814,13 +825,15 @@
         out << "};\n";
     }
 
-    gl::Shader *shaderGL       = programData.getAttachedShader(shaderType);
-    const ShaderD3D *shaderD3D = GetImplAs<ShaderD3D>(shaderGL);
+    gl::Shader *shaderGL                     = programData.getAttachedShader(shaderType);
+    const ShaderD3D *shaderD3D               = GetImplAs<ShaderD3D>(shaderGL);
+    const bool getDimensionsIgnoresBaseLevel = programD3D.usesGetDimensionsIgnoresBaseLevel();
 
     if (shaderD3D->useImage2DFunction(Image2DHLSLGroupFunctionName(textureGroup, IMAGE2DSIZE)))
     {
         OutputImage2DSizeFunction(out, textureGroup, totalCount, texture2DCount, texture3DCount,
-                                  texture2DArrayCount, offsetStr, declarationStr);
+                                  texture2DArrayCount, offsetStr, declarationStr,
+                                  getDimensionsIgnoresBaseLevel);
     }
     if (shaderD3D->useImage2DFunction(Image2DHLSLGroupFunctionName(textureGroup, IMAGE2DLOAD)))
     {