# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/angle/checkout/src/common/debug.cpp
# Commit: 3a91885d47e0
# Full Hash: 3a91885d47e0ef7fba9749562d52300eea67c651
# Author: Miko Mynttinen <mikokm@gmail.com>
# Date: 2019-11-11 21:52:52
# Regressor Bug: 1578576
# File Overlap Count: 4
# Description:
#   Bug 1578576 - Part 2: Update to ANGLE 3865 r=jgilbert
#   
#   Depends on D44561
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D44579
# ==============================================================================

diff -r 77cee77c0307 -r 3a91885d47e0 gfx/angle/checkout/src/common/debug.cpp
--- a/gfx/angle/checkout/src/common/debug.cpp	Fri Nov 08 16:41:42 2019 +0000
+++ b/gfx/angle/checkout/src/common/debug.cpp	Fri Nov 08 17:06:00 2019 +0000
@@ -23,6 +23,7 @@
 
 #include "common/Optional.h"
 #include "common/angleutils.h"
+#include "common/system_utils.h"
 
 namespace gl
 {
@@ -35,7 +36,7 @@
 std::mutex *g_debugMutex = nullptr;
 
 constexpr std::array<const char *, LOG_NUM_SEVERITIES> g_logSeverityNames = {
-    {"EVENT", "WARN", "ERR"}};
+    {"EVENT", "INFO", "WARN", "ERR", "FATAL"}};
 
 constexpr const char *LogSeverityName(int severity)
 {
@@ -157,7 +158,7 @@
         lock = std::unique_lock<std::mutex>(*g_debugMutex);
     }
 
-    if (DebugAnnotationsInitialized() && (mSeverity == LOG_ERR || mSeverity == LOG_WARN))
+    if (DebugAnnotationsInitialized() && (mSeverity >= LOG_INFO))
     {
         g_debugAnnotator->logMessage(*this);
     }
@@ -165,6 +166,18 @@
     {
         Trace(getSeverity(), getMessage().c_str());
     }
+
+    if (mSeverity == LOG_FATAL)
+    {
+        if (angle::IsDebuggerAttached())
+        {
+            angle::BreakDebugger();
+        }
+        else
+        {
+            ANGLE_CRASH();
+        }
+    }
 }
 
 void Trace(LogSeverity severity, const char *message)
@@ -190,14 +203,33 @@
         }
     }
 
-    if (severity == LOG_ERR || severity == LOG_WARN)
+    if (severity == LOG_FATAL || severity == LOG_ERR || severity == LOG_WARN ||
+        severity == LOG_INFO)
     {
 #if defined(ANGLE_PLATFORM_ANDROID)
-        __android_log_print((severity == LOG_ERR) ? ANDROID_LOG_ERROR : ANDROID_LOG_WARN, "ANGLE",
-                            "%s: %s\n", LogSeverityName(severity), str.c_str());
+        android_LogPriority android_priority = ANDROID_LOG_ERROR;
+        switch (severity)
+        {
+            case LOG_INFO:
+                android_priority = ANDROID_LOG_INFO;
+                break;
+            case LOG_WARN:
+                android_priority = ANDROID_LOG_WARN;
+                break;
+            case LOG_ERR:
+                android_priority = ANDROID_LOG_ERROR;
+                break;
+            case LOG_FATAL:
+                android_priority = ANDROID_LOG_FATAL;
+                break;
+            default:
+                UNREACHABLE();
+        }
+        __android_log_print(android_priority, "ANGLE", "%s: %s\n", LogSeverityName(severity),
+                            str.c_str());
 #else
         // Note: we use fprintf because <iostream> includes static initializers.
-        fprintf((severity == LOG_ERR) ? stderr : stdout, "%s: %s\n", LogSeverityName(severity),
+        fprintf((severity >= LOG_ERR) ? stderr : stdout, "%s: %s\n", LogSeverityName(severity),
                 str.c_str());
 #endif
     }
@@ -205,7 +237,7 @@
 #if defined(ANGLE_PLATFORM_WINDOWS) && \
     (defined(ANGLE_ENABLE_DEBUG_TRACE_TO_DEBUGGER) || !defined(NDEBUG))
 #    if !defined(ANGLE_ENABLE_DEBUG_TRACE_TO_DEBUGGER)
-    if (severity == LOG_ERR)
+    if (severity >= LOG_ERR)
 #    endif  // !defined(ANGLE_ENABLE_DEBUG_TRACE_TO_DEBUGGER)
     {
         OutputDebugStringA(str.c_str());
@@ -214,7 +246,7 @@
 
 #if defined(ANGLE_ENABLE_DEBUG_TRACE)
 #    if defined(NDEBUG)
-    if (severity == LOG_EVENT || severity == LOG_WARN)
+    if (severity == LOG_EVENT || severity == LOG_WARN || severity == LOG_INFO)
     {
         return;
     }