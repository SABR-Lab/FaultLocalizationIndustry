# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/angle/checkout/src/gpu_info_util/SystemInfo.cpp
# Commit: 3a91885d47e0
# Full Hash: 3a91885d47e0ef7fba9749562d52300eea67c651
# Author: Miko Mynttinen <mikokm@gmail.com>
# Date: 2019-11-11 21:52:52
# Regressor Bug: 1578576
# File Overlap Count: 4
# Description:
#   Bug 1578576 - Part 2: Update to ANGLE 3865 r=jgilbert
#   
#   Depends on D44561
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D44579
# ==============================================================================

diff -r 77cee77c0307 -r 3a91885d47e0 gfx/angle/checkout/src/gpu_info_util/SystemInfo.cpp
--- a/gfx/angle/checkout/src/gpu_info_util/SystemInfo.cpp	Fri Nov 08 16:41:42 2019 +0000
+++ b/gfx/angle/checkout/src/gpu_info_util/SystemInfo.cpp	Fri Nov 08 17:06:00 2019 +0000
@@ -9,6 +9,7 @@
 #include "gpu_info_util/SystemInfo.h"
 
 #include <cstring>
+#include <iostream>
 #include <sstream>
 
 #include "common/debug.h"
@@ -16,7 +17,35 @@
 
 namespace angle
 {
-
+namespace
+{
+std::string VendorName(VendorID vendor)
+{
+    switch (vendor)
+    {
+        case kVendorID_AMD:
+            return "AMD";
+        case kVendorID_Intel:
+            return "Intel";
+        case kVendorID_ImgTec:
+            return "ImgTec";
+        case kVendorID_NVIDIA:
+            return "NVIDIA";
+        case kVendorID_Qualcomm:
+            return "Qualcomm";
+        case kVendorID_Vivante:
+            return "Vivante";
+        case kVendorID_VeriSilicon:
+            return "VeriSilicon";
+        case kVendorID_VMWare:
+            return "VMWare";
+        case kVendorID_Kazan:
+            return "Kazan";
+        default:
+            return "Unknown (" + std::to_string(vendor) + ")";
+    }
+}
+}  // anonymous namespace
 GPUDeviceInfo::GPUDeviceInfo() = default;
 
 GPUDeviceInfo::~GPUDeviceInfo() = default;
@@ -29,6 +58,42 @@
 
 SystemInfo::SystemInfo(const SystemInfo &other) = default;
 
+bool SystemInfo::hasNVIDIAGPU() const
+{
+    for (const GPUDeviceInfo &gpu : gpus)
+    {
+        if (IsNVIDIA(gpu.vendorId))
+        {
+            return true;
+        }
+    }
+    return false;
+}
+
+bool SystemInfo::hasIntelGPU() const
+{
+    for (const GPUDeviceInfo &gpu : gpus)
+    {
+        if (IsIntel(gpu.vendorId))
+        {
+            return true;
+        }
+    }
+    return false;
+}
+
+bool SystemInfo::hasAMDGPU() const
+{
+    for (const GPUDeviceInfo &gpu : gpus)
+    {
+        if (IsAMD(gpu.vendorId))
+        {
+            return true;
+        }
+    }
+    return false;
+}
+
 bool IsAMD(VendorID vendorId)
 {
     return vendorId == kVendorID_AMD;
@@ -54,9 +119,9 @@
     return vendorId == kVendorID_Intel;
 }
 
-bool IsNvidia(VendorID vendorId)
+bool IsNVIDIA(VendorID vendorId)
 {
-    return vendorId == kVendorID_Nvidia;
+    return vendorId == kVendorID_NVIDIA;
 }
 
 bool IsQualcomm(VendorID vendorId)
@@ -69,6 +134,11 @@
     return vendorId == kVendorID_VeriSilicon;
 }
 
+bool IsVMWare(VendorID vendorId)
+{
+    return vendorId == kVendorID_VMWare;
+}
+
 bool IsVivante(VendorID vendorId)
 {
     return vendorId == kVendorID_Vivante;
@@ -168,12 +238,12 @@
     return success;
 }
 
-void FindPrimaryGPU(SystemInfo *info)
+void FindActiveGPU(SystemInfo *info)
 {
     ASSERT(!info->gpus.empty());
 
-    // On dual-GPU systems we assume the non-Intel GPU is the primary one.
-    int primary   = 0;
+    // On dual-GPU systems we assume the non-Intel GPU is the graphics one.
+    int active    = 0;
     bool hasIntel = false;
     for (size_t i = 0; i < info->gpus.size(); ++i)
     {
@@ -181,16 +251,62 @@
         {
             hasIntel = true;
         }
-        if (IsIntel(info->gpus[primary].vendorId))
+        if (IsIntel(info->gpus[active].vendorId))
         {
-            primary = static_cast<int>(i);
+            active = static_cast<int>(i);
         }
     }
 
-    // Assume that a combination of AMD or Nvidia with Intel means Optimus or AMD Switchable
-    info->primaryGPUIndex = primary;
-    info->isOptimus       = hasIntel && IsNvidia(info->gpus[primary].vendorId);
-    info->isAMDSwitchable = hasIntel && IsAMD(info->gpus[primary].vendorId);
+    // Assume that a combination of NVIDIA or AMD with Intel means Optimus or AMD Switchable
+    info->activeGPUIndex  = active;
+    info->isOptimus       = hasIntel && IsNVIDIA(info->gpus[active].vendorId);
+    info->isAMDSwitchable = hasIntel && IsAMD(info->gpus[active].vendorId);
 }
 
+void PrintSystemInfo(const SystemInfo &info)
+{
+    std::cout << info.gpus.size() << " GPUs:\n";
+
+    for (size_t i = 0; i < info.gpus.size(); i++)
+    {
+        const auto &gpu = info.gpus[i];
+
+        std::cout << "  " << i << " - " << VendorName(gpu.vendorId) << " device id: 0x" << std::hex
+                  << std::uppercase << gpu.deviceId << std::dec << "\n";
+        if (!gpu.driverVendor.empty())
+        {
+            std::cout << "       Driver Vendor: " << gpu.driverVendor << "\n";
+        }
+        if (!gpu.driverVersion.empty())
+        {
+            std::cout << "       Driver Version: " << gpu.driverVersion << "\n";
+        }
+        if (!gpu.driverDate.empty())
+        {
+            std::cout << "       Driver Date: " << gpu.driverDate << "\n";
+        }
+    }
+
+    std::cout << "\n";
+    std::cout << "Active GPU: " << info.activeGPUIndex << "\n";
+
+    std::cout << "\n";
+    std::cout << "Optimus: " << (info.isOptimus ? "true" : "false") << "\n";
+    std::cout << "AMD Switchable: " << (info.isAMDSwitchable ? "true" : "false") << "\n";
+
+    std::cout << "\n";
+    if (!info.machineManufacturer.empty())
+    {
+        std::cout << "Machine Manufacturer: " << info.machineManufacturer << "\n";
+    }
+    if (!info.machineModelName.empty())
+    {
+        std::cout << "Machine Model: " << info.machineModelName << "\n";
+    }
+    if (!info.machineModelVersion.empty())
+    {
+        std::cout << "Machine Model Version: " << info.machineModelVersion << "\n";
+    }
+    std::cout << std::endl;
+}
 }  // namespace angle