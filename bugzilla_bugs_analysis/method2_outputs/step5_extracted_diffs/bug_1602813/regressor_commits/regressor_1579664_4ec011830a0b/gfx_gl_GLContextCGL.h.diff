# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/gl/GLContextCGL.h
# Commit: 4ec011830a0b
# Full Hash: 4ec011830a0b2649d70b58d30e30edb8babfc6f1
# Author: Markus Stange <mstange@themasta.com>
# Date: 2019-11-20 09:47:58
# Regressor Bug: 1579664
# File Overlap Count: 1
# Description:
#   Bug 1579664 - Migrate compositor GLContexts to the active GPU after a GPU switch. r=jgilbert
#   
#   MigrateToActiveGPU is only called on compositor GLContexts, not for WebGL.
#   See bug 1597547 for WebGL.
#   
# ==============================================================================

diff -r e318a3f2027c -r 4ec011830a0b gfx/gl/GLContextCGL.h
--- a/gfx/gl/GLContextCGL.h	Mon Nov 18 12:17:19 2019 +0000
+++ b/gfx/gl/GLContextCGL.h	Tue Nov 19 08:52:00 2019 +0000
@@ -17,6 +17,10 @@
 typedef void NSOpenGLContext;
 #endif
 
+#include <CoreGraphics/CGDisplayConfiguration.h>
+
+#include "mozilla/Atomics.h"
+
 class nsIWidget;
 
 namespace mozilla {
@@ -27,6 +31,8 @@
 
   NSOpenGLContext* mContext;
 
+  mozilla::Atomic<bool> mActiveGPUSwitchMayHaveOccurred;
+
  public:
   MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME(GLContextCGL, override)
   GLContextCGL(CreateContextFlags flags, const SurfaceCaps& caps,
@@ -46,6 +52,16 @@
   NSOpenGLContext* GetNSOpenGLContext() const { return mContext; }
   CGLContextObj GetCGLContext() const;
 
+  // Can be called on any thread
+  static void DisplayReconfigurationCallback(CGDirectDisplayID aDisplay,
+                                             CGDisplayChangeSummaryFlags aFlags,
+                                             void* aUserInfo);
+
+  // Call at the beginning of a frame, on contexts that should stay on the
+  // active GPU. This method will migrate the context to the new active GPU, if
+  // the active GPU has changed since the last call.
+  void MigrateToActiveGPU();
+
   virtual bool MakeCurrentImpl() const override;
 
   virtual bool IsCurrentImpl() const override;