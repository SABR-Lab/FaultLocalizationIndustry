# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/cocoa/nsChildView.mm
# Commit: 4ec011830a0b
# Full Hash: 4ec011830a0b2649d70b58d30e30edb8babfc6f1
# Author: Markus Stange <mstange@themasta.com>
# Date: 2019-11-20 09:47:58
# Regressor Bug: 1579664
# File Overlap Count: 1
# Description:
#   Bug 1579664 - Migrate compositor GLContexts to the active GPU after a GPU switch. r=jgilbert
#   
#   MigrateToActiveGPU is only called on compositor GLContexts, not for WebGL.
#   See bug 1597547 for WebGL.
#   
# ==============================================================================

diff -r e318a3f2027c -r 4ec011830a0b widget/cocoa/nsChildView.mm
--- a/widget/cocoa/nsChildView.mm	Mon Nov 18 12:17:19 2019 +0000
+++ b/widget/cocoa/nsChildView.mm	Tue Nov 19 08:52:00 2019 +0000
@@ -1708,6 +1708,12 @@
   // composition is done, thus keeping the GL context locked forever.
   mViewTearDownLock.Lock();
 
+  UniquePtr<GLManager> manager(GLManager::CreateGLManager(aContext->mLayerManager));
+  gl::GLContext* gl = manager ? manager->gl() : aContext->mGL;
+  if (gl) {
+    GLContextCGL::Cast(gl)->MigrateToActiveGPU();
+  }
+
   return true;
 }
 
