# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/storage/SessionStorageManager.cpp
# Commit: de6b543ce6d7
# Full Hash: de6b543ce6d7b0b59aa0d78ea793a93919a737c3
# Author: Yaron Tausky <ytausky@mozilla.com>
# Date: 2019-12-11 03:34:51
# Regressor Bug: 1593246
# File Overlap Count: 1
# Description:
#   Bug 1593246 - Part 4: Overload SessionStorageManager::GetSessionStorageCacheHelper r=dom-workers-and-storage-reviewers,asuth
#   
#   Depends on D55660
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D55661
# ==============================================================================

diff -r 44fb598d3ad8 -r de6b543ce6d7 dom/storage/SessionStorageManager.cpp
--- a/dom/storage/SessionStorageManager.cpp	Mon Dec 09 19:38:34 2019 +0000
+++ b/dom/storage/SessionStorageManager.cpp	Mon Dec 09 19:38:34 2019 +0000
@@ -89,8 +89,6 @@
 nsresult SessionStorageManager::GetSessionStorageCacheHelper(
     nsIPrincipal* aPrincipal, bool aMakeIfNeeded,
     SessionStorageCache* aCloneFrom, RefPtr<SessionStorageCache>* aRetVal) {
-  *aRetVal = nullptr;
-
   nsAutoCString originKey;
   nsAutoCString originAttributes;
   nsresult rv = GenerateOriginKey(aPrincipal, originAttributes, originKey);
@@ -98,25 +96,35 @@
     return NS_ERROR_NOT_AVAILABLE;
   }
 
+  return GetSessionStorageCacheHelper(originAttributes, originKey,
+                                      aMakeIfNeeded, aCloneFrom, aRetVal);
+}
+
+nsresult SessionStorageManager::GetSessionStorageCacheHelper(
+    const nsACString& aOriginAttrs, const nsACString& aOriginKey,
+    bool aMakeIfNeeded, SessionStorageCache* aCloneFrom,
+    RefPtr<SessionStorageCache>* aRetVal) {
+  *aRetVal = nullptr;
+
   OriginKeyHashTable* table;
-  if (!mOATable.Get(originAttributes, &table)) {
+  if (!mOATable.Get(aOriginAttrs, &table)) {
     if (aMakeIfNeeded) {
       table = new OriginKeyHashTable();
-      mOATable.Put(originAttributes, table);
+      mOATable.Put(aOriginAttrs, table);
     } else {
       return NS_OK;
     }
   }
 
   RefPtr<SessionStorageCache> cache;
-  if (!table->Get(originKey, getter_AddRefs(cache))) {
+  if (!table->Get(aOriginKey, getter_AddRefs(cache))) {
     if (aMakeIfNeeded) {
       if (aCloneFrom) {
         cache = aCloneFrom->Clone();
       } else {
         cache = new SessionStorageCache();
       }
-      table->Put(originKey, cache);
+      table->Put(aOriginKey, cache);
     } else {
       return NS_OK;
     }