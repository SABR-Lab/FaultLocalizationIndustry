# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/2d/DrawTargetRecording.cpp
# Commit: f3be461cff92
# Full Hash: f3be461cff92fc1ffc883560405f692d9a0a023b
# Author: Bob Owen <bobowencode@gmail.com>
# Date: 2020-01-16 21:45:49
# Description:
#   Bug 1604180: Use original surface for GetDataSurface after DrawTargetRecording::OptimizeSourceSurface. r=jrmuizel
#   
#   We return a SourceSurfaceRecdording from OptimizeSourceSurface to represent
#   the optimized surface. However, GetDataSurface might be called on this
#   SourceSurfaceRecdording, so we hold the original SourceSurface we optimized in
# ==============================================================================

diff -r 347043d2f799 -r f3be461cff92 gfx/2d/DrawTargetRecording.cpp
--- a/gfx/2d/DrawTargetRecording.cpp	Thu Jan 16 15:41:18 2020 +0000
+++ b/gfx/2d/DrawTargetRecording.cpp	Thu Jan 16 15:53:08 2020 +0000
@@ -58,8 +58,12 @@
   MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME(SourceSurfaceRecording, override)
 
   SourceSurfaceRecording(IntSize aSize, SurfaceFormat aFormat,
-                         DrawEventRecorderPrivate* aRecorder)
-      : mSize(aSize), mFormat(aFormat), mRecorder(aRecorder) {
+                         DrawEventRecorderPrivate* aRecorder,
+                         SourceSurface* aOriginalSurface = nullptr)
+      : mSize(aSize),
+        mFormat(aFormat),
+        mRecorder(aRecorder),
+        mOriginalSurface(aOriginalSurface) {
     mRecorder->AddStoredObject(this);
   }
 
@@ -73,12 +77,20 @@
   IntSize GetSize() const override { return mSize; }
   SurfaceFormat GetFormat() const override { return mFormat; }
   already_AddRefed<DataSourceSurface> GetDataSurface() override {
+    if (mOriginalSurface) {
+      return mOriginalSurface->GetDataSurface();
+    }
+
     return nullptr;
   }
 
   IntSize mSize;
   SurfaceFormat mFormat;
   RefPtr<DrawEventRecorderPrivate> mRecorder;
+  // If a SourceSurfaceRecording is returned from an OptimizeSourceSurface call
+  // we need GetDataSurface to work, so we hold the original surface we
+  // optimized to return its GetDataSurface.
+  RefPtr<SourceSurface> mOriginalSurface;
 };
 
 class DataSourceSurfaceRecording : public DataSourceSurface {
@@ -516,7 +528,7 @@
   EnsureSurfaceStoredRecording(mRecorder, aSurface, "OptimizeSourceSurface");
 
   RefPtr<SourceSurface> retSurf = new SourceSurfaceRecording(
-      aSurface->GetSize(), aSurface->GetFormat(), mRecorder);
+      aSurface->GetSize(), aSurface->GetFormat(), mRecorder, aSurface);
 
   mRecorder->RecordEvent(
       RecordedOptimizeSourceSurface(aSurface, this, retSurf));
