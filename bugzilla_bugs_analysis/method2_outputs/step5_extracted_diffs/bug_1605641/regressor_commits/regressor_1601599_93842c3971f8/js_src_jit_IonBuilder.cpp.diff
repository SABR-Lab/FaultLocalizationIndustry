# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/IonBuilder.cpp
# Commit: 93842c3971f8
# Full Hash: 93842c3971f8e612537cba5d6d25b482c0d67a66
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2019-12-15 21:49:48
# Regressor Bug: 1601599
# File Overlap Count: 1
# Description:
#   Bug 1601599 part 3 - Simplify loop phi code in IonBuilder. r=tcampbell
#   
#   Before this bug:
#   
#   * We did not add phis for expression stack slots that aren't part of the loop.
# ==============================================================================

diff -r 4903b1b93526 -r 93842c3971f8 js/src/jit/IonBuilder.cpp
--- a/js/src/jit/IonBuilder.cpp	Sun Dec 15 11:39:00 2019 +0000
+++ b/js/src/jit/IonBuilder.cpp	Sun Dec 15 11:33:36 2019 +0000
@@ -1802,7 +1802,7 @@
   //
   //    LOOPHEAD
   //    ...
-  //    IFNE/IFEQ/GOTO to LOOPHEAD
+  //    IFNE/GOTO to LOOPHEAD
 
   MOZ_ASSERT(*pc == JSOP_LOOPHEAD);
 
@@ -1811,28 +1811,9 @@
     return Ok();
   }
 
-  jssrcnote* sn = GetSrcNote(gsn, script(), pc);
-  MOZ_ASSERT(sn);
-
-  uint32_t stackPhiCount;
-  switch (SN_TYPE(sn)) {
-    case SRC_FOR_OF:
-      stackPhiCount = 3;
-      break;
-    case SRC_FOR_IN:
-    case SRC_FOR:
-    case SRC_WHILE:
-    case SRC_DO_WHILE:
-      stackPhiCount = 0;
-      break;
-    default:
-      MOZ_CRASH("Unexpected source note");
-  }
-
-  bool canOsr = LoopHeadCanIonOsr(pc);
   bool osr = pc == info().osrPc();
   if (osr) {
-    MOZ_ASSERT(canOsr);
+    MOZ_ASSERT(LoopHeadCanIonOsr(pc));
 
     MBasicBlock* preheader;
     MOZ_TRY_VAR(preheader, newOsrPreheader(current, pc));
@@ -1842,8 +1823,7 @@
 
   loopDepth_++;
   MBasicBlock* header;
-  MOZ_TRY_VAR(header,
-              newPendingLoopHeader(current, pc, osr, canOsr, stackPhiCount));
+  MOZ_TRY_VAR(header, newPendingLoopHeader(current, pc, osr));
   current->end(MGoto::New(alloc(), header));
 
   if (!loopStack_.emplaceBack(header)) {
@@ -7820,16 +7800,9 @@
 }
 
 AbortReasonOr<MBasicBlock*> IonBuilder::newPendingLoopHeader(
-    MBasicBlock* predecessor, jsbytecode* pc, bool osr, bool canOsr,
-    unsigned stackPhiCount) {
-  // If this site can OSR, all values on the expression stack are part of the
-  // loop.
-  if (canOsr) {
-    stackPhiCount = predecessor->stackDepth() - info().firstStackSlot();
-  }
-
+    MBasicBlock* predecessor, jsbytecode* pc, bool osr) {
   MBasicBlock* block = MBasicBlock::NewPendingLoopHeader(
-      graph(), info(), predecessor, bytecodeSite(pc), stackPhiCount);
+      graph(), info(), predecessor, bytecodeSite(pc));
   if (!block) {
     return abort(AbortReason::Alloc);
   }