# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/MediaEngineTabVideoSource.cpp
# Commit: 709eb7380309
# Full Hash: 709eb73803095ab21843a39412290cfacb149b3a
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2019-10-07 16:27:18
# Regressor Bug: 1583463
# File Overlap Count: 1
# Description:
#   Bug 1583463 - End the tab source's track when the draw timer is guaranteed to have stopped. r=jib
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D47685
# ==============================================================================

diff -r f453f2d11453 -r 709eb7380309 dom/media/webrtc/MediaEngineTabVideoSource.cpp
--- a/dom/media/webrtc/MediaEngineTabVideoSource.cpp	Thu Oct 03 19:50:31 2019 +0000
+++ b/dom/media/webrtc/MediaEngineTabVideoSource.cpp	Thu Oct 03 19:50:42 2019 +0000
@@ -91,8 +91,6 @@
   if (mVideoSource->mTabSource) {
     mVideoSource->mTabSource->NotifyStreamStop(mVideoSource->mWindow);
   }
-  mVideoSource->mPrincipalHandle = PRINCIPAL_HANDLE_NONE;
-  mVideoSource->mTrackMain = nullptr;
   return NS_OK;
 }
 
@@ -102,6 +100,12 @@
   mVideoSource->mWindow = nullptr;
   mVideoSource->mTabSource = nullptr;
 
+  if (mVideoSource->mTrackMain) {
+    mVideoSource->mTrackMain->End();
+  }
+  mVideoSource->mPrincipalHandle = PRINCIPAL_HANDLE_NONE;
+  mVideoSource->mTrackMain = nullptr;
+
   return NS_OK;
 }
 
@@ -217,10 +221,6 @@
   AssertIsOnOwningThread();
   MOZ_ASSERT(mState == kAllocated || mState == kStopped);
 
-  if (mTrack) {
-    mTrack->End();
-  }
-
   NS_DispatchToMainThread(do_AddRef(new DestroyRunnable(this)));
   mState = kReleased;
 
