# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/base/Document.cpp
# Commit: aa3c61d28ac8
# Full Hash: aa3c61d28ac88aa98335dea24c7e61a016976e95
# Author: Johann Hofmann <jhofmann@mozilla.com>
# Date: 2020-01-14 21:43:07
# Description:
#   Bug 1607159 - Without e10s, don't crash the parent process in Document::GetFailedCertSecurityInfo. r=baku
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D59864
# ==============================================================================

diff -r cbb1fd48d429 -r aa3c61d28ac8 dom/base/Document.cpp
--- a/dom/base/Document.cpp	Wed Jan 08 10:25:44 2020 +0000
+++ b/dom/base/Document.cpp	Tue Jan 14 14:37:37 2020 +0000
@@ -1808,13 +1808,28 @@
   attrs = nsContentUtils::GetOriginAttributes(this);
   nsCOMPtr<nsIURI> aURI;
   mFailedChannel->GetURI(getter_AddRefs(aURI));
-  ContentChild* cc = ContentChild::GetSingleton();
-  mozilla::ipc::URIParams uri;
-  SerializeURI(aURI, uri);
-  cc->SendIsSecureURI(nsISiteSecurityService::HEADER_HSTS, uri, flags, attrs,
-                      &aInfo.mHasHSTS);
-  cc->SendIsSecureURI(nsISiteSecurityService::HEADER_HPKP, uri, flags, attrs,
-                      &aInfo.mHasHPKP);
+  if (XRE_IsContentProcess()) {
+    ContentChild* cc = ContentChild::GetSingleton();
+    MOZ_ASSERT(cc);
+    mozilla::ipc::URIParams uri;
+    SerializeURI(aURI, uri);
+    cc->SendIsSecureURI(nsISiteSecurityService::HEADER_HSTS, uri, flags, attrs,
+                        &aInfo.mHasHSTS);
+    cc->SendIsSecureURI(nsISiteSecurityService::HEADER_HPKP, uri, flags, attrs,
+                        &aInfo.mHasHPKP);
+  } else {
+    nsCOMPtr<nsISiteSecurityService> sss =
+        do_GetService(NS_SSSERVICE_CONTRACTID);
+    if (NS_WARN_IF(!sss)) {
+      return;
+    }
+    Unused << NS_WARN_IF(NS_FAILED(
+        sss->IsSecureURI(nsISiteSecurityService::HEADER_HSTS, aURI, flags,
+                         attrs, nullptr, nullptr, &aInfo.mHasHSTS)));
+    Unused << NS_WARN_IF(NS_FAILED(
+        sss->IsSecureURI(nsISiteSecurityService::HEADER_HPKP, aURI, flags,
+                         attrs, nullptr, nullptr, &aInfo.mHasHPKP)));
+  }
 }
 
 bool Document::IsAboutPage() const {
