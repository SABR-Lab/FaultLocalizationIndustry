# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/gc/Cell.h
# Commit: a0d1fb0a86b0
# Full Hash: a0d1fb0a86b04c74a8809c35230382f90cdfe779
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2020-01-07 21:57:58
# Regressor Bug: 1530372
# File Overlap Count: 1
# Description:
#   Bug 1530372 - Part 4: Support nursery allocation for BigInt. r=sfink,jandem
#   
#   Most of the code was copied from the String nursery allocation code paths and
#   then adjusted to work with BigInts. Where applicable, the newly added BigInt
#   functions were placed right next to the String functions, so it's easier to
# ==============================================================================

diff -r 9ae1e055de13 -r a0d1fb0a86b0 js/src/gc/Cell.h
--- a/js/src/gc/Cell.h	Thu Jan 02 13:04:45 2020 +0000
+++ b/js/src/gc/Cell.h	Mon Jan 06 12:49:45 2020 +0000
@@ -124,11 +124,15 @@
   static constexpr uintptr_t FORWARD_BIT = Bit(0);
 
   // When a Cell is in the nursery, this will indicate if it is a JSString (1)
-  // or JSObject (0). When not in nursery, this bit is still reserved for
+  // or JSObject/BigInt (0). When not in nursery, this bit is still reserved for
   // JSString to use as JSString::NON_ATOM bit. This may be removed by Bug
   // 1376646.
   static constexpr uintptr_t JSSTRING_BIT = Bit(1);
 
+  // When a Cell is in the nursery, this will indicate if it is a BigInt (1)
+  // or JSObject/JSString (0).
+  static constexpr uintptr_t BIGINT_BIT = Bit(2);
+
   MOZ_ALWAYS_INLINE bool isTenured() const { return !IsInsideNursery(this); }
   MOZ_ALWAYS_INLINE const TenuredCell& asTenured() const;
   MOZ_ALWAYS_INLINE TenuredCell& asTenured();
@@ -173,6 +177,12 @@
     return firstWord & JSSTRING_BIT;
   }
 
+  inline bool nurseryCellIsBigInt() const {
+    MOZ_ASSERT(!isTenured());
+    uintptr_t firstWord = *reinterpret_cast<const uintptr_t*>(this);
+    return firstWord & BIGINT_BIT;
+  }
+
   template <class T>
   inline bool is() const {
     return getTraceKind() == JS::MapTypeToTraceKind<T>::kind;
@@ -358,6 +368,11 @@
                                      JS::TraceKind::String);
     return JS::TraceKind::String;
   }
+  if (nurseryCellIsBigInt()) {
+    MOZ_ASSERT_IF(isForwarded(), UninlinedForwarded(this)->getTraceKind() ==
+                                     JS::TraceKind::BigInt);
+    return JS::TraceKind::BigInt;
+  }
   MOZ_ASSERT_IF(isForwarded(), UninlinedForwarded(this)->getTraceKind() ==
                                    JS::TraceKind::Object);
   return JS::TraceKind::Object;