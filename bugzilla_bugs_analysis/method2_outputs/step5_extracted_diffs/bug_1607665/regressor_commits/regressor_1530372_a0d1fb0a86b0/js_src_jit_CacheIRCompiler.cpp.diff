# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/CacheIRCompiler.cpp
# Commit: a0d1fb0a86b0
# Full Hash: a0d1fb0a86b04c74a8809c35230382f90cdfe779
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2020-01-07 21:57:58
# Regressor Bug: 1530372
# File Overlap Count: 1
# Description:
#   Bug 1530372 - Part 4: Support nursery allocation for BigInt. r=sfink,jandem
#   
#   Most of the code was copied from the String nursery allocation code paths and
#   then adjusted to work with BigInts. Where applicable, the newly added BigInt
#   functions were placed right next to the String functions, so it's easier to
# ==============================================================================

diff -r 9ae1e055de13 -r a0d1fb0a86b0 js/src/jit/CacheIRCompiler.cpp
--- a/js/src/jit/CacheIRCompiler.cpp	Thu Jan 02 13:04:45 2020 +0000
+++ b/js/src/jit/CacheIRCompiler.cpp	Mon Jan 06 12:49:45 2020 +0000
@@ -3623,11 +3623,17 @@
   return true;
 }
 
+static bool CanNurseryAllocateBigInt(JSContext* cx) {
+  JS::Zone* zone = cx->zone();
+  return zone->runtimeFromAnyThread()->gc.nursery().canAllocateBigInts() &&
+         zone->allocNurseryBigInts;
+}
+
 static void EmitAllocateBigInt(MacroAssembler& masm, Register result,
                                Register temp, const LiveRegisterSet& liveSet,
-                               Label* fail) {
+                               Label* fail, bool attemptNursery) {
   Label fallback, done;
-  masm.newGCBigInt(result, temp, &fallback);
+  masm.newGCBigInt(result, temp, &fallback, attemptNursery);
   masm.jump(&done);
   {
     masm.bind(&fallback);
@@ -3636,6 +3642,8 @@
     masm.setupUnalignedABICall(temp);
     masm.loadJSContext(temp);
     masm.passABIArg(temp);
+    masm.move32(Imm32(attemptNursery), result);
+    masm.passABIArg(result);
     masm.callWithABI(JS_FUNC_TO_DATA_PTR(void*, jit::AllocateBigIntNoGC));
     masm.storeCallPointerResult(result);
 
@@ -3705,7 +3713,9 @@
     save.takeUnchecked(scratch2);
     save.takeUnchecked(output);
 
-    EmitAllocateBigInt(masm, *bigInt, scratch1, save, failure->label());
+    bool attemptNursery = CanNurseryAllocateBigInt(cx_);
+    EmitAllocateBigInt(masm, *bigInt, scratch1, save, failure->label(),
+                       attemptNursery);
   }
 
   // Load the elements vector.
@@ -3874,7 +3884,9 @@
       save.takeUnchecked(scratch2);
       save.takeUnchecked(output);
 
-      EmitAllocateBigInt(masm, *bigInt, scratch1, save, failure->label());
+      bool attemptNursery = CanNurseryAllocateBigInt(cx_);
+      EmitAllocateBigInt(masm, *bigInt, scratch1, save, failure->label(),
+                         attemptNursery);
     }
   }
 
@@ -4802,7 +4814,8 @@
 
   TypedOrValueRegister reg = val.reg();
   if (reg.hasTyped()) {
-    if (reg.type() != MIRType::Object && reg.type() != MIRType::String) {
+    if (reg.type() != MIRType::Object && reg.type() != MIRType::String &&
+        reg.type() != MIRType::BigInt) {
       return;
     }
   }