# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/actors/PrintingChild.jsm
# Commit: e650c0acb702
# Full Hash: e650c0acb7027d22d04aeb6525834e5f89eedd92
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-19 21:28:29
# Regressor Bug: 1602410
# File Overlap Count: 1
# Description:
#   Bug 1602410 - Make window.print() work with tab-modal printing. r=nika,geckoview-reviewers,agi
#   
#   Do this by spinning the event loop until we've done the clone for
#   preview as appropriate.
#   
# ==============================================================================

diff -r 1f9187fefcb6 -r e650c0acb702 toolkit/actors/PrintingChild.jsm
--- a/toolkit/actors/PrintingChild.jsm	Tue Aug 18 21:33:15 2020 +0000
+++ b/toolkit/actors/PrintingChild.jsm	Wed Aug 19 09:27:18 2020 +0000
@@ -83,7 +83,7 @@
     switch (message.name) {
       case "Printing:Preview:Enter": {
         this.enterPrintPreview(
-          Services.wm.getOuterWindowWithId(data.windowID),
+          BrowsingContext.get(data.browsingContextId),
           data.simplifiedMode,
           data.changingBrowsers,
           data.lastUsedPrinterName,
@@ -308,14 +308,16 @@
   }
 
   enterPrintPreview(
-    contentWindow,
+    browsingContext,
     simplifiedMode,
     changingBrowsers,
     lastUsedPrinterName,
     outputFormat
   ) {
     const { docShell } = this;
+
     try {
+      let contentWindow = browsingContext.window;
       let printSettings = this.getPrintSettings(lastUsedPrinterName);
 
       // Disable the progress dialog for generating previews.
@@ -347,6 +349,7 @@
           this.mm.sendAsyncMessage("Printing:Preview:Entered", {
             failed: true,
           });
+          browsingContext.isAwaitingPrint = false;
           return;
         }
         try {
@@ -365,6 +368,8 @@
             failed: true,
           });
         }
+
+        browsingContext.isAwaitingPrint = false;
       };
 
       // If printPreviewInitializingInfo.entered is not set we are still in the
@@ -384,6 +389,7 @@
       // In that case, we inform the parent to bail out of print preview.
       Cu.reportError(error);
       this.mm.sendAsyncMessage("Printing:Preview:Entered", { failed: true });
+      browsingContext.isAwaitingPrint = false;
     }
   }
 