# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/printing/content/print.js
# Commit: e650c0acb702
# Full Hash: e650c0acb7027d22d04aeb6525834e5f89eedd92
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-19 21:28:29
# Regressor Bug: 1602410
# File Overlap Count: 1
# Description:
#   Bug 1602410 - Make window.print() work with tab-modal printing. r=nika,geckoview-reviewers,agi
#   
#   Do this by spinning the event loop until we've done the clone for
#   preview as appropriate.
#   
# ==============================================================================

diff -r 1f9187fefcb6 -r e650c0acb702 toolkit/components/printing/content/print.js
--- a/toolkit/components/printing/content/print.js	Tue Aug 18 21:33:15 2020 +0000
+++ b/toolkit/components/printing/content/print.js	Wed Aug 19 09:27:18 2020 +0000
@@ -195,7 +195,7 @@
 
   async _updatePrintPreview() {
     let numPages = await PrintUtils.updatePrintPreview(
-      this.sourceBrowser,
+      this.getSourceBrowsingContext(),
       this.previewBrowser,
       this.settings
     );
@@ -213,17 +213,21 @@
     }
   },
 
-  getSourceBrowser() {
+  getSourceBrowsingContext() {
     let params = new URLSearchParams(location.search);
     let browsingContextId = params.get("browsingContextId");
     if (!browsingContextId) {
       return null;
     }
-    let browsingContext = BrowsingContext.get(browsingContextId);
+    return BrowsingContext.get(browsingContextId);
+  },
+
+  getSourceBrowser() {
+    let browsingContext = this.getSourceBrowsingContext();
     if (!browsingContext) {
       return null;
     }
-    return browsingContext.embedderElement;
+    return browsingContext.top.embedderElement;
   },
 
   getPreviewBrowser() {