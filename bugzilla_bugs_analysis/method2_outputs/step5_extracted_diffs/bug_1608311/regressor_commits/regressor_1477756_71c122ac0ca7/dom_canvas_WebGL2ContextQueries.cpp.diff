# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGL2ContextQueries.cpp
# Commit: 71c122ac0ca7
# Full Hash: 71c122ac0ca73391866b1ef19f4f82bc2d28568b
# Author: David Parks <davidp99@gmail.com>
# Date: 2020-01-09 03:40:18
# Regressor Bug: 1477756
# File Overlap Count: 1
# Description:
#   Bug 1477756 - Initial out-of-process WebGL implementation. r=mccr8,handyman
#   
#   Splits WebGLContext into ClientWebGLContext and HostWebGLContext.  The Client enables the JS-control of a WebGL context in a content procecss while the Host executes the WebGL graphics operations (via a WebGLContext that maintains much of the existing code) in the compositor process.  At this point, the cross-process behavior is disabled -- this series of patches is an incremental step toward that final goal.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D54018
# ==============================================================================

diff -r 5cbf5bb11c58 -r 71c122ac0ca7 dom/canvas/WebGL2ContextQueries.cpp
--- a/dom/canvas/WebGL2ContextQueries.cpp	Wed Jan 08 21:52:03 2020 +0000
+++ b/dom/canvas/WebGL2ContextQueries.cpp	Wed Jan 08 22:19:14 2020 +0000
@@ -98,12 +98,10 @@
   query->EndQuery();
 }
 
-void WebGLContext::GetQuery(JSContext* cx, GLenum target, GLenum pname,
-                            JS::MutableHandleValue retval) {
+MaybeWebGLVariant WebGLContext::GetQuery(GLenum target, GLenum pname) {
   const FuncScope funcScope(*this, "getQuery");
 
-  retval.setNull();
-  if (IsContextLost()) return;
+  if (IsContextLost()) return Nothing();
 
   switch (pname) {
     case LOCAL_GL_CURRENT_QUERY_EXT: {
@@ -112,20 +110,17 @@
         // Doesn't seem illegal to ask about, but is always null.
         // TIMESTAMP has no slot, so ValidateQuerySlotByTarget would generate
         // INVALID_ENUM.
-        return;
+        return Nothing();
       }
 
       const auto& slot = ValidateQuerySlotByTarget(target);
-      if (!slot || !*slot) return;
+      if (!slot || !*slot) return Nothing();
 
       const auto& query = *slot;
-      if (target != query->Target()) return;
+      if (target != query->Target()) return Nothing();
 
-      JS::Rooted<JS::Value> v(cx);
-      dom::GetOrCreateDOMReflector(cx, slot->get(), &v);
-      retval.set(v);
+      return AsSomeVariant(std::move(query));
     }
-      return;
 
     case LOCAL_GL_QUERY_COUNTER_BITS_EXT:
       if (!IsExtensionEnabled(WebGLExtensionID::EXT_disjoint_timer_query))
@@ -134,7 +129,7 @@
       if (target != LOCAL_GL_TIME_ELAPSED_EXT &&
           target != LOCAL_GL_TIMESTAMP_EXT) {
         ErrorInvalidEnumInfo("target", target);
-        return;
+        return Nothing();
       }
 
       {
@@ -144,27 +139,25 @@
         if (!Has64BitTimestamps() && bits > 32) {
           bits = 32;
         }
-        retval.set(JS::Int32Value(bits));
+        return AsSomeVariant(bits);
       }
-      return;
 
     default:
       break;
   }
 
   ErrorInvalidEnumInfo("pname", pname);
+  return Nothing();
 }
 
-void WebGLContext::GetQueryParameter(JSContext*, const WebGLQuery& query,
-                                     GLenum pname,
-                                     JS::MutableHandleValue retval) {
+MaybeWebGLVariant WebGLContext::GetQueryParameter(const WebGLQuery& query,
+                                                  GLenum pname) {
   const FuncScope funcScope(*this, "getQueryParameter");
-  retval.setNull();
-  if (IsContextLost()) return;
+  if (IsContextLost()) return Nothing();
 
-  if (!ValidateObject("query", query)) return;
+  if (!ValidateObject("query", query)) return Nothing();
 
-  query.GetQueryParameter(pname, retval);
+  return query.GetQueryParameter(pname);
 }
 
 }  // namespace mozilla