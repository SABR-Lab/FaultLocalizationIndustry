# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLBuffer.cpp
# Commit: ccfa767dba64
# Full Hash: ccfa767dba644dc193e0246eb8e8ff3377e8b8a5
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-01-09 03:40:18
# Regressor Bug: 1477756
# File Overlap Count: 1
# Description:
#   Bug 1477756 - Client-side bindings mirror for precise CC, and merge similar codepaths. r=handyman
#   
#   * Context loss using RAII
#   * Move Program reflection Client-side
#   
# ==============================================================================

diff -r 71c122ac0ca7 -r ccfa767dba64 dom/canvas/WebGLBuffer.cpp
--- a/dom/canvas/WebGLBuffer.cpp	Wed Jan 08 22:19:14 2020 +0000
+++ b/dom/canvas/WebGLBuffer.cpp	Wed Jan 08 22:19:16 2020 +0000
@@ -12,12 +12,19 @@
 namespace mozilla {
 
 WebGLBuffer::WebGLBuffer(WebGLContext* webgl, GLuint buf)
-    : WebGLRefCountedObject(webgl), mGLName(buf) {
-  mContext->mBuffers.insertBack(this);
+    : WebGLContextBoundObject(webgl), mGLName(buf) {}
+
+WebGLBuffer::~WebGLBuffer() {
+  mByteLength = 0;
+  mFetchInvalidator.InvalidateCaches();
+
+  mIndexCache = nullptr;
+  mIndexRanges.clear();
+
+  if (!mContext) return;
+  mContext->gl->fDeleteBuffers(1, &mGLName);
 }
 
-WebGLBuffer::~WebGLBuffer() { DeleteOnce(); }
-
 void WebGLBuffer::SetContentAfterBind(GLenum target) {
   if (mContent != Kind::Undefined) return;
 
@@ -41,17 +48,6 @@
   }
 }
 
-void WebGLBuffer::Delete() {
-  mContext->gl->fDeleteBuffers(1, &mGLName);
-
-  mByteLength = 0;
-  mFetchInvalidator.InvalidateCaches();
-
-  mIndexCache = nullptr;
-  mIndexRanges.clear();
-  LinkedListElement<WebGLBuffer>::remove();  // remove from mContext->mBuffers
-}
-
 ////////////////////////////////////////
 
 static bool ValidateBufferUsageEnum(WebGLContext* webgl, GLenum usage) {
@@ -95,8 +91,17 @@
   }
 #endif
 
+  UniqueBuffer maybeCalloc;
+  if (!data) {
+    maybeCalloc = calloc(1, AssertedCast<size_t>(size));
+    if (!maybeCalloc) {
+      mContext->ErrorOutOfMemory("Failed to alloc zeros.");
+      return;
+    }
+    data = maybeCalloc.get();
+  }
+
   const void* uploadData = data;
-
   UniqueBuffer newIndexCache;
   if (target == LOCAL_GL_ELEMENT_ARRAY_BUFFER &&
       mContext->mNeedsIndexValidation) {