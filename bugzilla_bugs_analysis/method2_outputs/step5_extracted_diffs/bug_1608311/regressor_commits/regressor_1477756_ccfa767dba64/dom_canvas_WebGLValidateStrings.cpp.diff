# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLValidateStrings.cpp
# Commit: ccfa767dba64
# Full Hash: ccfa767dba644dc193e0246eb8e8ff3377e8b8a5
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-01-09 03:40:18
# Regressor Bug: 1477756
# File Overlap Count: 1
# Description:
#   Bug 1477756 - Client-side bindings mirror for precise CC, and merge similar codepaths. r=handyman
#   
#   * Context loss using RAII
#   * Move Program reflection Client-side
#   
# ==============================================================================

diff -r 71c122ac0ca7 -r ccfa767dba64 dom/canvas/WebGLValidateStrings.cpp
--- a/dom/canvas/WebGLValidateStrings.cpp	Wed Jan 08 22:19:14 2020 +0000
+++ b/dom/canvas/WebGLValidateStrings.cpp	Wed Jan 08 22:19:16 2020 +0000
@@ -98,7 +98,7 @@
 
 ////////////////////////////////////////////////////////////////////////////////
 
-static bool IsValidGLSLChar(char16_t c) {
+static bool IsValidGLSLChar(const char c) {
   if (('a' <= c && c <= 'z') || ('A' <= c && c <= 'Z') ||
       ('0' <= c && c <= '9')) {
     return true;
@@ -143,7 +143,7 @@
   }
 }
 
-static bool IsValidGLSLPreprocChar(char16_t c) {
+static bool IsValidGLSLPreprocChar(const char c) {
   if (IsValidGLSLChar(c)) return true;
 
   switch (c) {
@@ -158,10 +158,8 @@
 
 ////
 
-bool ValidateGLSLPreprocString(WebGLContext* webgl, const nsAString& string) {
-  for (size_t i = 0; i < string.Length(); ++i) {
-    const auto& cur = string[i];
-
+bool ValidateGLSLPreprocString(WebGLContext* webgl, const std::string& string) {
+  for (const auto cur : string) {
     if (!IsValidGLSLPreprocChar(cur)) {
       webgl->ErrorInvalidValue("String contains the illegal character 0x%x.",
                                cur);
@@ -179,20 +177,19 @@
   return true;
 }
 
-bool ValidateGLSLVariableName(const nsAString& name, WebGLContext* webgl) {
-  if (name.IsEmpty()) return false;
+bool ValidateGLSLVariableName(const std::string& name, WebGLContext* webgl) {
+  if (name.empty()) return false;
 
   const uint32_t maxSize = webgl->IsWebGL2() ? 1024 : 256;
-  if (name.Length() > maxSize) {
+  if (name.size() > maxSize) {
     webgl->ErrorInvalidValue(
-        "Identifier is %u characters long, exceeds the"
+        "Identifier is %tu characters long, exceeds the"
         " maximum allowed length of %u characters.",
-        name.Length(), maxSize);
+        name.size(), maxSize);
     return false;
   }
 
-  for (size_t i = 0; i < name.Length(); ++i) {
-    const auto& cur = name[i];
+  for (const auto cur : name) {
     if (!IsValidGLSLChar(cur)) {
       webgl->ErrorInvalidValue("String contains the illegal character 0x%x'.",
                                cur);
@@ -203,8 +200,7 @@
   nsString prefix1 = NS_LITERAL_STRING("webgl_");
   nsString prefix2 = NS_LITERAL_STRING("_webgl_");
 
-  if (Substring(name, 0, prefix1.Length()).Equals(prefix1) ||
-      Substring(name, 0, prefix2.Length()).Equals(prefix2)) {
+  if (name.find("webgl_") == 0 || name.find("_webgl_") == 0) {
     webgl->ErrorInvalidOperation("String contains a reserved GLSL prefix.");
     return false;
   }