# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/ProducerConsumerQueue.h
# Commit: 7e2a2b1b416f
# Full Hash: 7e2a2b1b416f1a64c6548aab29e92acc9554ae7d
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-01-09 03:40:18
# Regressor Bug: 1477756
# File Overlap Count: 1
# Description:
#   Bug 1477756 - Fix all webgl regression tests according to CI. r=handyman
#   
#   (This is a combination of 31 commits)
#   
#   * Fix Linux compilation.
# ==============================================================================

diff -r ccfa767dba64 -r 7e2a2b1b416f dom/canvas/ProducerConsumerQueue.h
--- a/dom/canvas/ProducerConsumerQueue.h	Wed Jan 08 22:19:16 2020 +0000
+++ b/dom/canvas/ProducerConsumerQueue.h	Wed Jan 08 22:19:23 2020 +0000
@@ -1020,7 +1020,7 @@
   using PeekOrRemoveOperation = std::function<PcqStatus(ConsumerView&)>;
 
   template <bool isRemove, typename... Args>
-  PcqStatus TryPeekOrRemove(PeekOrRemoveOperation aOperation) {
+  PcqStatus TryPeekOrRemove(const PeekOrRemoveOperation& aOperation) {
     size_t write = mWrite->load(std::memory_order_acquire);
     size_t read = mRead->load(std::memory_order_relaxed);
     const size_t initRead = read;
@@ -1485,7 +1485,7 @@
       return false;
     }
 
-    MOZ_ASSERT(notEmptyHandle && notFullHandle);
+    MOZ_ASSERT(IsHandleValid(notEmptyHandle) && IsHandleValid(notFullHandle));
     aResult->Set(shmem, aActor->OtherPid(), queueSize,
                  MakeRefPtr<detail::PcqRCSemaphore>(
                      CrossProcessSemaphore::Create(notEmptyHandle)),
@@ -1530,7 +1530,7 @@
 
   template <PcqTypeInfoID ArgTypeId = PcqTypeInfo<Arg>::ID>
   static PcqStatus Read(ConsumerView& aConsumerView, ParamType* aArg) {
-    MOZ_ASSERT(aArg.mRead);
+    MOZ_ASSERT(aArg->mRead);
     PcqTypeInfoID typeId;
     if (!aConsumerView.ReadParam(&typeId)) {
       return aConsumerView.Status();