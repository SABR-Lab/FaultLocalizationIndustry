# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/vr/ipc/VRLayerChild.cpp
# Commit: ccfa767dba64
# Full Hash: ccfa767dba644dc193e0246eb8e8ff3377e8b8a5
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-01-09 03:40:18
# Regressor Bug: 1477756
# File Overlap Count: 1
# Description:
#   Bug 1477756 - Client-side bindings mirror for precise CC, and merge similar codepaths. r=handyman
#   
#   * Context loss using RAII
#   * Move Program reflection Client-side
#   
# ==============================================================================

diff -r 71c122ac0ca7 -r ccfa767dba64 gfx/vr/ipc/VRLayerChild.cpp
--- a/gfx/vr/ipc/VRLayerChild.cpp	Wed Jan 08 22:19:14 2020 +0000
+++ b/gfx/vr/ipc/VRLayerChild.cpp	Wed Jan 08 22:19:16 2020 +0000
@@ -5,8 +5,11 @@
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "VRLayerChild.h"
+
 #include "gfxPlatform.h"
+#include "../../../dom/canvas/ClientWebGLContext.h"
 #include "mozilla/dom/HTMLCanvasElement.h"
+#include "mozilla/dom/WebGLChild.h"
 
 namespace mozilla {
 namespace gfx {
@@ -44,12 +47,16 @@
 
   mLastSubmittedFrameId = frameId;
 
-  PWebGLChild* webGLChild = mCanvasElement->GetWebGLChild();
-  if (!webGLChild) {
+  const auto webgl = mCanvasElement->GetWebGLContext();
+  if (!webgl) {
+    return;
+  }
+  const auto webglChild = webgl->GetChild();
+  if (!webglChild) {
     return;
   }
 
-  SendSubmitFrame(webGLChild, frameId,
+  SendSubmitFrame(webglChild, frameId,
                   aDisplayInfo.mDisplayState.lastSubmittedFrameId, mLeftEyeRect,
                   mRightEyeRect);
 }
@@ -57,7 +64,10 @@
 bool VRLayerChild::IsIPCOpen() { return mIPCOpen; }
 
 void VRLayerChild::ClearSurfaces() {
-  mCanvasElement->ClearVRFrame();
+  const auto webgl = mCanvasElement->GetWebGLContext();
+  if (webgl) {
+    webgl->ClearVRFrame();
+  }
   SendClearSurfaces();
 }
 