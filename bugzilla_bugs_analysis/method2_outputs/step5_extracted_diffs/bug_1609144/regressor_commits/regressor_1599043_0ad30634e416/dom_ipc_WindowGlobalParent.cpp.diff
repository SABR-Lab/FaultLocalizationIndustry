# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/ipc/WindowGlobalParent.cpp
# Commit: 0ad30634e416
# Full Hash: 0ad30634e416aee9f79814406105dcfbaf6866db
# Author: Tim Huang <tihuang@mozilla.com>
# Date: 2019-12-12 21:50:40
# Regressor Bug: 1599043
# File Overlap Count: 1
# Description:
#   Bug 1599043 - Part 2: Allow the WindowGlobalParent to send OnContentBlockingEvent in parent. r=dimi,Ehsan
#   
#   This patch makes the WindowGlobalParent to be able to send the
#   OnContentBlockingEvent in the parent process.
#   
# ==============================================================================

diff -r 68219c132efc -r 0ad30634e416 dom/ipc/WindowGlobalParent.cpp
--- a/dom/ipc/WindowGlobalParent.cpp	Wed Dec 11 15:00:20 2019 +0000
+++ b/dom/ipc/WindowGlobalParent.cpp	Thu Dec 12 08:56:25 2019 +0000
@@ -13,6 +13,7 @@
 #include "mozilla/dom/ContentParent.h"
 #include "mozilla/dom/BrowserHost.h"
 #include "mozilla/dom/BrowserParent.h"
+#include "mozilla/dom/RemoteWebProgress.h"
 #include "mozilla/dom/WindowGlobalActorsBinding.h"
 #include "mozilla/dom/WindowGlobalChild.h"
 #include "mozilla/dom/ChromeUtils.h"
@@ -30,6 +31,7 @@
 #include "nsQueryObject.h"
 #include "nsFrameLoaderOwner.h"
 #include "nsSerializationHelper.h"
+#include "nsIBrowser.h"
 #include "nsITransportSecurityInfo.h"
 #include "nsISharePicker.h"
 
@@ -315,8 +317,37 @@
   Maybe<uint32_t> event = GetContentBlockingLog()->RecordLogParent(
       origin, aEvent, aBlocked, aReason, aTrackingFullHashes);
 
+  // Notify the OnContentBlockingEvent if necessary.
   if (event) {
-    // Notify the OnContentBlockingEvent.
+    // Get the browser parent from the manager directly since the content
+    // blocking event could happen in the early stage of loading, i.e.
+    // accessing cookies for the http header. At this stage, the actor is
+    // not ready, so we would get a nullptr from GetBrowserParent(). But,
+    // we can actually get it from the manager.
+    RefPtr<BrowserParent> browserParent =
+        static_cast<BrowserParent*>(Manager());
+    if (NS_WARN_IF(!browserParent)) {
+      return;
+    }
+
+    nsCOMPtr<nsIBrowser> browser;
+    nsCOMPtr<nsIWebProgress> manager;
+    nsCOMPtr<nsIWebProgressListener> managerAsListener;
+
+    if (!browserParent->GetWebProgressListener(
+            getter_AddRefs(browser), getter_AddRefs(manager),
+            getter_AddRefs(managerAsListener))) {
+      return;
+    }
+
+    MOZ_DIAGNOSTIC_ASSERT(!IsInProcess());
+
+    nsCOMPtr<nsIWebProgress> webProgress =
+        new RemoteWebProgress(manager, OuterWindowId(), InnerWindowId(), 0,
+                              false, BrowsingContext()->IsTopContent());
+
+    Unused << managerAsListener->OnContentBlockingEvent(webProgress, aRequest,
+                                                        event.value());
   }
 }
 
