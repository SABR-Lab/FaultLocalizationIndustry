# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/nsHttpChannel.cpp
# Commit: bc2b36de8f33
# Full Hash: bc2b36de8f33a7705e0c672987128159f8f4427c
# Author: Paul Bone <pbone@mozilla.com>
# Date: 2020-03-18 04:14:11
# Description:
#   Bug 1611907 - Remove AssertNotDocumentChannel r=mattwoodrow
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D67093
# ==============================================================================

diff -r 02ef6cee073c -r bc2b36de8f33 netwerk/protocol/http/nsHttpChannel.cpp
--- a/netwerk/protocol/http/nsHttpChannel.cpp	Tue Mar 17 23:38:28 2020 +0000
+++ b/netwerk/protocol/http/nsHttpChannel.cpp	Tue Mar 17 19:20:58 2020 +0000
@@ -2581,8 +2581,6 @@
     return NS_OK;
   }
 
-  AssertNotDocumentChannel();
-
   // Check if request was cancelled during http-on-examine-response.
   if (mCanceled) {
     return CallOnStartRequest();
@@ -2649,61 +2647,6 @@
   return ContinueProcessResponse2(rv);
 }
 
-void nsHttpChannel::AssertNotDocumentChannel() {
-  if (!IsDocument()) {
-    return;
-  }
-
-#ifndef DEBUG
-  if (!StaticPrefs::fission_autostart()) {
-    // This assertion is firing in the wild (Bug 1593545) and its not clear
-    // why. Disable the assertion in non-fission non-debug configurations to
-    // avoid crashing user's browsers until we're done dogfooding fission.
-    return;
-  }
-#endif
-
-  nsCOMPtr<nsIParentChannel> parentChannel;
-  NS_QueryNotificationCallbacks(this, parentChannel);
-  RefPtr<DocumentLoadListener> documentChannelParent =
-      do_QueryObject(parentChannel);
-  if (documentChannelParent) {
-    // The load is using document channel.
-    return;
-  }
-
-  RefPtr<HttpChannelParent> httpParent = do_QueryObject(parentChannel);
-  if (!httpParent) {
-    // The load was initiated in the parent and doesn't need document
-    // channel.
-    return;
-  }
-
-  auto contentPolicy = mLoadInfo->GetExternalContentPolicyType();
-  if (contentPolicy != nsIContentPolicy::TYPE_DOCUMENT &&
-      contentPolicy != nsIContentPolicy::TYPE_SUBDOCUMENT) {
-    return;
-  }
-
-  RefPtr<BrowsingContext> bc;
-  MOZ_ALWAYS_SUCCEEDS(mLoadInfo->GetTargetBrowsingContext(getter_AddRefs(bc)));
-  MOZ_ASSERT(bc);  // It shouldn't be possible.
-  if (!bc) {
-    return;
-  }
-
-  if (mLoadInfo->LoadingPrincipal() &&
-      mLoadInfo->LoadingPrincipal()->IsSystemPrincipal()) {
-    // Loads with the system principal can skip document channel
-    return;
-  }
-
-  // The load was supposed to use document channel but didn't.
-  MOZ_DIAGNOSTIC_ASSERT(
-      !StaticPrefs::browser_tabs_documentchannel(),
-      "DocumentChannel is enabled but this load was done without it");
-}
-
 nsresult nsHttpChannel::ContinueProcessResponse2(nsresult rv) {
   if (NS_FAILED(rv) && !mCanceled) {
     // The process switch failed, cancel this channel.
@@ -7883,8 +7826,6 @@
     return NS_OK;
   }
 
-  AssertNotDocumentChannel();
-
   // No process change is needed, so continue on to ContinueOnStartRequest1.
   return ContinueOnStartRequest1(rv);
 }