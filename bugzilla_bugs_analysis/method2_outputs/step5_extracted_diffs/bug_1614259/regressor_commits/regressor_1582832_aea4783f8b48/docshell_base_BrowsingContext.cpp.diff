# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: docshell/base/BrowsingContext.cpp
# Commit: aea4783f8b48
# Full Hash: aea4783f8b4867167607f8ba00eadc4aaa45d61d
# Author: Kris Maglione <maglione.k@gmail.com>
# Date: 2020-02-07 03:55:51
# Regressor Bug: 1582832
# File Overlap Count: 1
# Description:
#   Bug 1582832: Part 3 - Correctly handle windowless BCs created for printing. r=nika
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D61006
# ==============================================================================

diff -r cefac6461948 -r aea4783f8b48 docshell/base/BrowsingContext.cpp
--- a/docshell/base/BrowsingContext.cpp	Thu Feb 06 19:08:04 2020 +0000
+++ b/docshell/base/BrowsingContext.cpp	Thu Feb 06 19:08:06 2020 +0000
@@ -208,6 +208,20 @@
   return bc.forget();
 }
 
+already_AddRefed<BrowsingContext> BrowsingContext::CreateWindowless(
+    BrowsingContext* aParent, BrowsingContext* aOpener, const nsAString& aName,
+    Type aType) {
+  RefPtr<BrowsingContext> bc(CreateDetached(aParent, aOpener, aName, aType));
+  bc->mWindowless = true;
+  bc->EnsureAttached();
+  return bc.forget();
+}
+
+void BrowsingContext::SetWindowless() {
+  MOZ_DIAGNOSTIC_ASSERT(!mEverAttached);
+  mWindowless = true;
+}
+
 void BrowsingContext::EnsureAttached() {
   if (!mEverAttached) {
     Register(this);
@@ -239,9 +253,9 @@
   RefPtr<BrowsingContext> context;
   if (XRE_IsParentProcess()) {
     // If the new BrowsingContext has a parent, it is a sub-frame embedded in
-    // whatever process sent the message. If it doesn't, it is a new window or
-    // tab, and will be embedded in the parent process.
-    uint64_t embedderProcessId = parent ? originId : 0;
+    // whatever process sent the message. If it doesn't, and is not windowless,
+    // it is a new window or tab, and will be embedded in the parent process.
+    uint64_t embedderProcessId = (aInit.mWindowless || parent) ? originId : 0;
     context = new CanonicalBrowsingContext(parent, aGroup, aInit.mId, originId,
                                            embedderProcessId, Type::Content,
                                            std::move(aInit.mFields));
@@ -250,6 +264,8 @@
                                   std::move(aInit.mFields));
   }
 
+  context->mWindowless = aInit.mWindowless;
+
   Register(context);
 
   // Caller handles attaching us to the tree.
@@ -273,6 +289,7 @@
       mEverAttached(false),
       mIsInProcess(false),
       mIsDiscarded(false),
+      mWindowless(false),
       mDanglingRemoteOuterProxies(false),
       mPendingInitialization(false) {
   MOZ_RELEASE_ASSERT(!mParent || mParent->Group() == mGroup);
@@ -1235,6 +1252,7 @@
   init.mId = Id();
   init.mParentId = mParent ? mParent->Id() : 0;
   init.mCached = IsCached();
+  init.mWindowless = mWindowless;
   init.mFields = mFields.Fields();
   return init;
 }
@@ -1555,6 +1573,7 @@
   WriteIPDLParam(aMessage, aActor, aInit.mId);
   WriteIPDLParam(aMessage, aActor, aInit.mParentId);
   WriteIPDLParam(aMessage, aActor, aInit.mCached);
+  WriteIPDLParam(aMessage, aActor, aInit.mWindowless);
   WriteIPDLParam(aMessage, aActor, aInit.mFields);
 }
 
@@ -1565,6 +1584,7 @@
   if (!ReadIPDLParam(aMessage, aIterator, aActor, &aInit->mId) ||
       !ReadIPDLParam(aMessage, aIterator, aActor, &aInit->mParentId) ||
       !ReadIPDLParam(aMessage, aIterator, aActor, &aInit->mCached) ||
+      !ReadIPDLParam(aMessage, aIterator, aActor, &aInit->mWindowless) ||
       !ReadIPDLParam(aMessage, aIterator, aActor, &aInit->mFields)) {
     return false;
   }