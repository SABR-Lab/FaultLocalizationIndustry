# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: security/certverifier/CertVerifier.h
# Commit: 16350e08d34f
# Full Hash: 16350e08d34ff06c7f46745c6b160c7a7bda9140
# Author: Dana Keeler <dkeeler@mozilla.com>
# Date: 2019-12-06 04:43:57
# Regressor Bug: 1586855
# File Overlap Count: 6
# Description:
#   bug 1586855 - incorporate CRLite filters into cert_storage r=jcj,kjacobs
#   
#   This patch implements CRLite lookups for TLS server certificate revocation
#   information in telemetry-only mode. It adds a new preference
#   "security.pki.crlite_mode" to control the behavior of this feature. Setting
# ==============================================================================

diff -r 64fd40663930 -r 16350e08d34f security/certverifier/CertVerifier.h
--- a/security/certverifier/CertVerifier.h	Thu Dec 05 22:23:54 2019 +0000
+++ b/security/certverifier/CertVerifier.h	Thu Dec 05 22:41:53 2019 +0000
@@ -79,6 +79,12 @@
 // update this to account for new entries in DistrustedCAPolicy.
 const uint32_t DistrustedCAPolicyMaxAllowedValueMask = 0b0011;
 
+enum class CRLiteMode {
+  Disabled = 0,
+  TelemetryOnly = 1,
+  Enforce = 2,
+};
+
 enum class NetscapeStepUpPolicy : uint32_t;
 
 class PinningTelemetryInfo {
@@ -134,6 +140,16 @@
   uint32_t authKeyBits;
 };
 
+enum class CRLiteTelemetryInfo {
+  NeverChecked = 0,
+  FilterNotAvailable = 1,
+  IssuerNotEnrolled = 2,
+  CertificateTooNew = 3,
+  CertificateValid = 4,
+  CertificateRevoked = 5,
+  LibraryFailure = 6,
+};
+
 class NSSCertDBTrustDomain;
 
 class CertVerifier {
@@ -173,7 +189,8 @@
       /*optional out*/ KeySizeStatus* keySizeStatus = nullptr,
       /*optional out*/ SHA1ModeResult* sha1ModeResult = nullptr,
       /*optional out*/ PinningTelemetryInfo* pinningTelemetryInfo = nullptr,
-      /*optional out*/ CertificateTransparencyInfo* ctInfo = nullptr);
+      /*optional out*/ CertificateTransparencyInfo* ctInfo = nullptr,
+      /*optional out*/ CRLiteTelemetryInfo* crliteInfo = nullptr);
 
   mozilla::pkix::Result VerifySSLServerCert(
       const UniqueCERTCertificate& peerCert, mozilla::pkix::Time time,
@@ -194,7 +211,8 @@
       /*optional out*/ KeySizeStatus* keySizeStatus = nullptr,
       /*optional out*/ SHA1ModeResult* sha1ModeResult = nullptr,
       /*optional out*/ PinningTelemetryInfo* pinningTelemetryInfo = nullptr,
-      /*optional out*/ CertificateTransparencyInfo* ctInfo = nullptr);
+      /*optional out*/ CertificateTransparencyInfo* ctInfo = nullptr,
+      /*optional out*/ CRLiteTelemetryInfo* crliteInfo = nullptr);
 
   enum PinningMode {
     pinningDisabled = 0,
@@ -229,7 +247,7 @@
                SHA1Mode sha1Mode, BRNameMatchingPolicy::Mode nameMatchingMode,
                NetscapeStepUpPolicy netscapeStepUpPolicy,
                CertificateTransparencyMode ctMode,
-               DistrustedCAPolicy distrustedCAPolicy,
+               DistrustedCAPolicy distrustedCAPolicy, CRLiteMode crliteMode,
                const Vector<EnterpriseCert>& thirdPartyCerts);
   ~CertVerifier();
 
@@ -246,6 +264,7 @@
   const NetscapeStepUpPolicy mNetscapeStepUpPolicy;
   const CertificateTransparencyMode mCTMode;
   const DistrustedCAPolicy mDistrustedCAPolicy;
+  const CRLiteMode mCRLiteMode;
 
  private:
   OCSPCache mOCSPCache;