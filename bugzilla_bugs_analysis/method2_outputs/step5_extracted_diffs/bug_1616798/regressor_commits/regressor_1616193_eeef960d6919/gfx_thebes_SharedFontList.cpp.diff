# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/SharedFontList.cpp
# Commit: eeef960d6919
# Full Hash: eeef960d6919c98b20dd900cecb874645273ce50
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2020-02-19 21:50:02
# Regressor Bug: 1616193
# File Overlap Count: 1
# Description:
#   Bug 1616193 - If Face::SetCharacterMap is called from a stylo thread, make it post a runnable instead of attempting to do IPC itself. r=jwatt
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D63210
# ==============================================================================

diff -r 3d2241d9040e -r eeef960d6919 gfx/thebes/SharedFontList.cpp
--- a/gfx/thebes/SharedFontList.cpp	Wed Feb 19 12:37:02 2020 +0000
+++ b/gfx/thebes/SharedFontList.cpp	Wed Feb 19 11:28:07 2020 +0000
@@ -89,11 +89,43 @@
   mIndex = aData.mIndex | (aData.mBundled ? 0x80000000u : 0u);
 }
 
+class SetCharMapRunnable : public mozilla::Runnable {
+ public:
+  SetCharMapRunnable(uint32_t aListGeneration, Face* aFace,
+                     const gfxSparseBitSet* aCharMap)
+      : Runnable("SetCharMapRunnable"),
+        mListGeneration(aListGeneration),
+        mFace(aFace),
+        mCharMap(aCharMap) {}
+
+  NS_IMETHOD Run() override {
+    auto* list = gfxPlatformFontList::PlatformFontList()->SharedFontList();
+    if (!list || list->GetGeneration() != mListGeneration) {
+      return NS_OK;
+    }
+    dom::ContentChild::GetSingleton()->SendSetCharacterMap(
+        mListGeneration, list->ToSharedPointer(mFace), *mCharMap);
+    return NS_OK;
+  }
+
+ private:
+  uint32_t mListGeneration;
+  Face* mFace;
+  const gfxSparseBitSet* mCharMap;
+};
+
 void Face::SetCharacterMap(FontList* aList, const gfxSparseBitSet* aCharMap) {
   if (!XRE_IsParentProcess()) {
-    Pointer ptr = aList->ToSharedPointer(this);
-    dom::ContentChild::GetSingleton()->SendSetCharacterMap(
-        aList->GetGeneration(), ptr, *aCharMap);
+    if (NS_IsMainThread()) {
+      Pointer ptr = aList->ToSharedPointer(this);
+      dom::ContentChild::GetSingleton()->SendSetCharacterMap(
+          aList->GetGeneration(), ptr, *aCharMap);
+    } else {
+      // aCharMap is kept alive by our caller until it has been successfully
+      // recorded in the Face, so we don't need to make/pass a copy.
+      NS_DispatchToMainThread(
+          new SetCharMapRunnable(aList->GetGeneration(), this, aCharMap));
+    }
     return;
   }
   auto pfl = gfxPlatformFontList::PlatformFontList();
