# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/RemoteBackbuffer.h
# Commit: ddce7f4b64d9
# Full Hash: ddce7f4b64d96e68a86d7a519f1828d06e37176d
# Author: Chris Martin <cmartin@mozilla.com>
# Date: 2020-02-13 18:21:33
# Regressor Bug: 1604412
# File Overlap Count: 2
# Description:
#   Bug 1604412 - Enable remote backbuffer GDI compositing r=jmathies,jld
#   
#   This change adds new "remote backbuffer" logic when compositing without
#   HW acceleration on Windows (IE compositing through Cairo using the Win32
#   GDI)
# ==============================================================================

diff -r ecc5c853bb77 -r ddce7f4b64d9 widget/windows/RemoteBackbuffer.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/widget/windows/RemoteBackbuffer.h	Thu Feb 13 14:32:37 2020 +0000
@@ -0,0 +1,81 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef widget_windows_RemoteBackbuffer_h
+#define widget_windows_RemoteBackbuffer_h
+
+#include <thread>
+#include <windows.h>
+#include "mozilla/Maybe.h"
+
+namespace mozilla {
+namespace widget {
+namespace remote_backbuffer {
+
+struct SharedData;
+struct BorrowResponseData;
+struct PresentResponseData;
+class SharedImage;
+class PresentableSharedImage;
+
+class Provider {
+ public:
+  Provider();
+  ~Provider();
+
+  bool Initialize(HWND aWindowHandle, DWORD aTargetProcessId);
+
+  Maybe<RemoteBackbufferHandles> CreateRemoteHandles();
+
+  Provider(const Provider&) = delete;
+  Provider(Provider&&) = delete;
+  Provider& operator=(const Provider&) = delete;
+  Provider& operator=(Provider&&) = delete;
+
+ private:
+  void ThreadMain();
+
+  void HandleBorrowRequest(BorrowResponseData* aResponseData);
+  void HandlePresentRequest(PresentResponseData* aResponseData);
+
+  HWND mWindowHandle;
+  DWORD mTargetProcessId;
+  HANDLE mFileMapping;
+  HANDLE mRequestReadyEvent;
+  HANDLE mResponseReadyEvent;
+  SharedData* mSharedDataPtr;
+  bool mStopServiceThread;
+  std::thread mServiceThread;
+  std::unique_ptr<PresentableSharedImage> mBackbuffer;
+};
+
+class Client {
+ public:
+  Client();
+  ~Client();
+
+  bool Initialize(const RemoteBackbufferHandles& aRemoteHandles);
+
+  already_AddRefed<gfx::DrawTarget> BorrowDrawTarget();
+  bool PresentDrawTarget();
+
+  Client(const Client&) = delete;
+  Client(Client&&) = delete;
+  Client& operator=(const Client&) = delete;
+  Client& operator=(Client&&) = delete;
+
+ private:
+  HANDLE mFileMapping;
+  HANDLE mRequestReadyEvent;
+  HANDLE mResponseReadyEvent;
+  SharedData* mSharedDataPtr;
+  std::unique_ptr<SharedImage> mBackbuffer;
+};
+
+}  // namespace remote_backbuffer
+}  // namespace widget
+}  // namespace mozilla
+
+#endif  // widget_windows_RemoteBackbuffer_h
\ No newline at end of file