# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/src/jsapi.cpp
# Commit: 9364941c6d53
# Full Hash: 9364941c6d538953131262f5d2c78163df803b3d
# Author: Boris Zbarsky <bzbarsky@mit.edu>
# Date: 2020-02-27 03:39:37
# Description:
#   Bug 1617527.  Remove the same-compartment checks when setting an exception on a JSContext r=sfink
#   
#   The exception is not guaranteed to be in the context compartment anyway (e.g. changing the compartment does not wrap the exception), so there isn't much point checking it up front.  And the exception stack is always stored as an unwrapped object, so again there's no point checking it on set, since we just plan to UncheckedUnwrap it.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D64004
# ==============================================================================

diff -r 5fc409bc3530 -r 9364941c6d53 js/src/jsapi.cpp
--- a/js/src/jsapi.cpp	Wed Feb 26 23:39:02 2020 +0200
+++ b/js/src/jsapi.cpp	Wed Feb 26 21:17:15 2020 +0000
@@ -4941,7 +4941,9 @@
                                           JS::ExceptionStackBehavior behavior) {
   AssertHeapIsIdle();
   CHECK_THREAD(cx);
-  cx->releaseCheck(value);
+  // We don't check the compartment of `value` here, because we're not
+  // doing anything with it other than storing it, and stored
+  // exception values can be in an abitrary compartment.
 
   if (behavior == JS::ExceptionStackBehavior::Capture) {
     cx->setPendingExceptionAndCaptureStack(value);
@@ -4960,8 +4962,11 @@
                                                    HandleObject stack) {
   AssertHeapIsIdle();
   CHECK_THREAD(cx);
-  cx->releaseCheck(value);
-  cx->releaseCheck(stack);
+  // We don't check the compartments of `value` and `stack` here,
+  // because we're not doing anything with them other than storing
+  // them, and stored exception values can be in an abitrary
+  // compartment while stored stack values are always the unwrapped
+  // object anyway.
 
   RootedSavedFrame nstack(cx);
   if (stack) {