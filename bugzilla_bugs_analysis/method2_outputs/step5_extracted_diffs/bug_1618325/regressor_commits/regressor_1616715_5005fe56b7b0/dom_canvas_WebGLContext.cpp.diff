# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLContext.cpp
# Commit: 5005fe56b7b0
# Full Hash: 5005fe56b7b0153d2069d25c6f1f4e311e2c1eb1
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-02-21 05:56:31
# Regressor Bug: 1616715
# File Overlap Count: 1
# Description:
#   Bug 1616715 - SurfaceFromElement gets alpha Premult unless opt-in to NonPremult. r=lsalzman
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D63421
# ==============================================================================

diff -r 985dccd11e97 -r 5005fe56b7b0 dom/canvas/WebGLContext.cpp
--- a/dom/canvas/WebGLContext.cpp	Thu Feb 20 21:12:05 2020 +0000
+++ b/dom/canvas/WebGLContext.cpp	Thu Feb 20 20:52:10 2020 +0000
@@ -1252,56 +1252,6 @@
   mHost->OnContextLoss(reason);
 }
 
-RefPtr<gfx::SourceSurface> WebGLContext::GetSurfaceSnapshot(
-    gfxAlphaType* const out_alphaType) {
-  const FuncScope funcScope(*this, "<GetSurfaceSnapshot>");
-  if (IsContextLost()) return nullptr;
-
-  if (!BindDefaultFBForRead()) return nullptr;
-
-  const auto surfFormat = mOptions.alpha ? gfx::SurfaceFormat::B8G8R8A8
-                                         : gfx::SurfaceFormat::B8G8R8X8;
-  const auto& size = mDefaultFB->mSize;
-  RefPtr<gfx::DataSourceSurface> surf;
-  surf = gfx::Factory::CreateDataSourceSurfaceWithStride(size, surfFormat,
-                                                         size.width * 4);
-  if (NS_WARN_IF(!surf)) return nullptr;
-
-  ReadPixelsIntoDataSurface(gl, surf);
-
-  gfxAlphaType alphaType;
-  if (!mOptions.alpha) {
-    alphaType = gfxAlphaType::Opaque;
-  } else if (mOptions.premultipliedAlpha) {
-    alphaType = gfxAlphaType::Premult;
-  } else {
-    alphaType = gfxAlphaType::NonPremult;
-  }
-
-  if (out_alphaType) {
-    *out_alphaType = alphaType;
-  } else {
-    // Expects Opaque or Premult
-    if (alphaType == gfxAlphaType::NonPremult) {
-      gfxUtils::PremultiplyDataSurface(surf, surf);
-    }
-  }
-
-  RefPtr<gfx::DrawTarget> dt = gfx::Factory::CreateDrawTarget(
-      gfxPlatform::GetPlatform()->GetSoftwareBackend(), size,
-      gfx::SurfaceFormat::B8G8R8A8);
-  if (!dt) return nullptr;
-
-  dt->SetTransform(
-      gfx::Matrix::Translation(0.0, size.height).PreScale(1.0, -1.0));
-
-  const gfx::Rect rect{0, 0, float(size.width), float(size.height)};
-  dt->DrawSurface(surf, rect, rect, gfx::DrawSurfaceOptions(),
-                  gfx::DrawOptions(1.0f, gfx::CompositionOp::OP_SOURCE));
-
-  return dt->Snapshot();
-}
-
 void WebGLContext::DidRefresh() {
   if (gl) {
     gl->FlushIfHeavyGLCallsSinceLastFlush();