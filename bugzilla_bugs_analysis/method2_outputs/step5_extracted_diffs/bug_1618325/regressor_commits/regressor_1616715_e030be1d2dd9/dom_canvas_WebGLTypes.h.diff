# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLTypes.h
# Commit: e030be1d2dd9
# Full Hash: e030be1d2dd9b0bb47680fac29f20447c9d66f8c
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-02-21 09:51:10
# Regressor Bug: 1616715
# File Overlap Count: 1
# Description:
#   Bug 1616715 - Make ReadPixelDesc per-call. r=lsalzman
#   
#   GetSurfaceSnapshot (and similar) want to ReadPixels the backbuffer,
#   without having to navigate the GL PIXEL_PACK state.
#   Since this is cold cold code, it's nice to reduce the backend state by
# ==============================================================================

diff -r adc841b3e204 -r e030be1d2dd9 dom/canvas/WebGLTypes.h
--- a/dom/canvas/WebGLTypes.h	Fri Feb 21 02:27:08 2020 +0000
+++ b/dom/canvas/WebGLTypes.h	Fri Feb 21 03:12:41 2020 +0000
@@ -349,17 +349,13 @@
   }
 };
 
-struct WebGLPixelStore {
+struct WebGLPixelStore final {
   uint32_t mUnpackImageHeight = 0;
   uint32_t mUnpackSkipImages = 0;
   uint32_t mUnpackRowLength = 0;
   uint32_t mUnpackSkipRows = 0;
   uint32_t mUnpackSkipPixels = 0;
   uint32_t mUnpackAlignment = 0;
-  uint32_t mPackRowLength = 0;
-  uint32_t mPackSkipRows = 0;
-  uint32_t mPackSkipPixels = 0;
-  uint32_t mPackAlignment = 0;
   GLenum mColorspaceConversion = 0;
   bool mFlipY = false;
   bool mPremultiplyAlpha = false;
@@ -465,6 +461,43 @@
 
 namespace webgl {
 
+struct PackingInfo final {
+  GLenum format = 0;
+  GLenum type = 0;
+
+  bool operator<(const PackingInfo& x) const {
+    if (format != x.format) return format < x.format;
+
+    return type < x.type;
+  }
+
+  bool operator==(const PackingInfo& x) const {
+    return (format == x.format && type == x.type);
+  }
+};
+
+struct DriverUnpackInfo final {
+  GLenum internalFormat = 0;
+  GLenum unpackFormat = 0;
+  GLenum unpackType = 0;
+
+  PackingInfo ToPacking() const { return {unpackFormat, unpackType}; }
+};
+
+struct PixelPackState final {
+  uint32_t alignment = 4;
+  uint32_t rowLength = 0;
+  uint32_t skipRows = 0;
+  uint32_t skipPixels = 0;
+};
+
+struct ReadPixelsDesc final {
+  ivec2 srcOffset;
+  uvec2 size;
+  PackingInfo pi = {LOCAL_GL_RGBA, LOCAL_GL_UNSIGNED_BYTE};
+  PixelPackState packState;
+};
+
 class ExtensionBits final {
   uint64_t mBits = 0;
 
