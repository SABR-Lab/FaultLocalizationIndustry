# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp
# Commit: a599c79ed651
# Full Hash: a599c79ed65176fd4e66394d1144f61931def4c9
# Author: Martin Stransky <stransky@redhat.com>
# Date: 2020-03-04 16:19:40
# Description:
#   Bug 1619544 [Wayland] Do locking in VA-API codec creation, r=jya
#   
#   We need to lock codec creation as ffmpeg/libva does not provide any kind of synchronization here.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D65089
# ==============================================================================

diff -r bf8c2eefd9b2 -r a599c79ed651 dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp
--- a/dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp	Wed Mar 04 07:13:47 2020 +0000
+++ b/dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp	Wed Mar 04 07:09:47 2020 +0000
@@ -190,6 +190,8 @@
     return NS_ERROR_DOM_MEDIA_FATAL_ERR;
   }
 
+  StaticMutexAutoLock mon(sMonitor);
+
   if (!(mCodecContext = mLib->avcodec_alloc_context3(codec))) {
     FFMPEG_LOG("Couldn't init VA-API ffmpeg context");
     return NS_ERROR_OUT_OF_MEMORY;
