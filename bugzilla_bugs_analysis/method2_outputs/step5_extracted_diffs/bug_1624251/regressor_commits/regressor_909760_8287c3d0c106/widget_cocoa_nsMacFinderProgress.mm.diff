# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/cocoa/nsMacFinderProgress.mm
# Commit: 8287c3d0c106
# Full Hash: 8287c3d0c1064096ee7c162060e6615d72722ee0
# Author: Christoph Walcher <christoph-wa@gmx.de>
# Date: 2019-06-20 09:46:31
# Regressor Bug: 909760
# File Overlap Count: 1
# Description:
#   Bug 909760 - Show download progress in the MacOS Finder r=spohl,mak
#   
#   Show download progress in the MacOS Finder
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D30688
# ==============================================================================

diff -r 5b9a3de04646 -r 8287c3d0c106 widget/cocoa/nsMacFinderProgress.mm
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/widget/cocoa/nsMacFinderProgress.mm	Wed Jun 19 18:48:49 2019 +0000
@@ -0,0 +1,88 @@
+/* -*- Mode: Objective-C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#import <Cocoa/Cocoa.h>
+
+#include "nsMacFinderProgress.h"
+#include "nsThreadUtils.h"
+#include "nsString.h"
+#include "nsObjCExceptions.h"
+
+NS_IMPL_ISUPPORTS(nsMacFinderProgress, nsIMacFinderProgress)
+
+nsMacFinderProgress::nsMacFinderProgress() : mProgress(nil) {}
+
+nsMacFinderProgress::~nsMacFinderProgress() {
+  if (mProgress) {
+    [mProgress.cancellationHandler release];
+    [mProgress release];
+  }
+}
+
+NS_IMETHODIMP
+nsMacFinderProgress::Init(const nsAString& path,
+                          nsIMacFinderProgressCanceledCallback* cancellationCallback) {
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
+
+  NSURL* pathUrl = [NSURL
+      fileURLWithPath:[NSString
+                          stringWithCharacters:reinterpret_cast<const unichar*>(path.BeginReading())
+                                        length:path.Length()]];
+  NSDictionary* userInfo = @{
+    @"NSProgressFileOperationKindKey" : @"NSProgressFileOperationKindDownloading",
+    @"NSProgressFileURLKey" : pathUrl
+  };
+
+  mProgress = [[NSProgress alloc] initWithParent:nil userInfo:userInfo];
+  mProgress.kind = NSProgressKindFile;
+  mProgress.cancellable = YES;
+
+  nsMainThreadPtrHandle<nsIMacFinderProgressCanceledCallback> cancellationCallbackHandle(
+      new nsMainThreadPtrHolder<nsIMacFinderProgressCanceledCallback>(
+          "MacFinderProgress::CancellationCallback", cancellationCallback));
+
+  mProgress.cancellationHandler = ^{
+    NS_DispatchToMainThread(
+        NS_NewRunnableFunction("MacFinderProgress::Canceled", [cancellationCallbackHandle] {
+          MOZ_ASSERT(NS_IsMainThread());
+          cancellationCallbackHandle->Canceled();
+        }));
+  };
+
+  [mProgress publish];
+
+  return NS_OK;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
+}
+
+NS_IMETHODIMP
+nsMacFinderProgress::UpdateProgress(uint64_t currentProgress, uint64_t totalProgress) {
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
+  if (mProgress) {
+    mProgress.totalUnitCount = totalProgress;
+    mProgress.completedUnitCount = currentProgress;
+  }
+
+  return NS_OK;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
+}
+
+NS_IMETHODIMP
+nsMacFinderProgress::End() {
+  NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;
+
+  if (mProgress) {
+    [mProgress unpublish];
+    [mProgress release];
+    mProgress = nil;
+  }
+
+  return NS_OK;
+
+  NS_OBJC_END_TRY_ABORT_BLOCK_NSRESULT;
+}