# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/console/Console.cpp
# Commit: c9c7f800aae6
# Full Hash: c9c7f800aae63af1ee1781a16a992461e1c3b7e7
# Author: Andrea Marchesini <amarchesini@mozilla.com>
# Date: 2020-03-20 09:53:53
# Regressor Bug: 1623385
# File Overlap Count: 1
# Description:
#   Bug 1623385 - Console API must support the logging of SharedArrayBuffers, r=smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D67494
# ==============================================================================

diff -r 61b498aa3e35 -r c9c7f800aae6 dom/console/Console.cpp
--- a/dom/console/Console.cpp	Thu Mar 19 16:53:47 2020 +0000
+++ b/dom/console/Console.cpp	Thu Mar 19 16:32:56 2020 +0000
@@ -359,12 +359,7 @@
     }
 
     JS::Rooted<JS::Value> value(aCx, JS::ObjectValue(*arguments));
-
-    if (NS_WARN_IF(!Write(aCx, value))) {
-      return false;
-    }
-
-    return true;
+    return WriteData(aCx, value);
   }
 
   void ProcessCallData(JSContext* aCx, Console* aConsole,
@@ -438,12 +433,7 @@
     }
 
     JS::Rooted<JS::Value> value(aCx, JS::ObjectValue(*arguments));
-
-    if (NS_WARN_IF(!Write(aCx, value))) {
-      return false;
-    }
-
-    return true;
+    return WriteData(aCx, value);
   }
 
   void ProcessProfileData(JSContext* aCx, Console::MethodName aMethodName,
@@ -488,6 +478,24 @@
     Console::ProfileMethodMainthread(aCx, aAction, arguments);
   }
 
+  bool WriteData(JSContext* aCx, JS::Handle<JS::Value> aValue) {
+    // We use structuredClone to send the JSValue to the main-thread, in order
+    // to store it into the Console API Service. The consumer will be the
+    // console panel in the devtools and, because of this, we want to allow the
+    // cloning of sharedArrayBuffers and WASM modules.
+    JS::CloneDataPolicy cloneDataPolicy;
+    cloneDataPolicy.allowIntraClusterClonableSharedObjects();
+    cloneDataPolicy.allowSharedMemoryObjects();
+
+    if (NS_WARN_IF(
+            !Write(aCx, aValue, JS::UndefinedHandleValue, cloneDataPolicy))) {
+      MOZ_CRASH("We should support any kind of data!");
+      return false;
+    }
+
+    return true;
+  }
+
   ConsoleStructuredCloneData mClonedData;
 };
 
