# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/nsWindow.cpp
# Commit: 1bfce9523cb3
# Full Hash: 1bfce9523cb39661c55cb3e4f27dcc5a54b4c8eb
# Author: Botond Ballo <botond@mozilla.com>
# Date: 2021-04-08 09:51:11
# Regressor Bug: 1511901
# File Overlap Count: 1
# Description:
#   Bug 1687636 - Determine whether we need to convert touch events to pan gesture events on a per-device basis. r=cmartin
#   
#   In bug 1511901, we added code to identify certain touch devices as needing
#   their touch events converted to pan gesture events.
#   
# ==============================================================================

diff -r b4a9a44a5e96 -r 1bfce9523cb3 widget/windows/nsWindow.cpp
--- a/widget/windows/nsWindow.cpp	Wed Apr 07 18:55:31 2021 +0000
+++ b/widget/windows/nsWindow.cpp	Wed Apr 07 18:56:38 2021 +0000
@@ -6991,26 +6991,19 @@
   return ret;
 }
 
-// Determine if the touch device that originated |aOSEvent| needs to have
-// touch events representing a two-finger gesture converted to pan
-// gesture events.
-// We only do this for touch devices with a specific name and identifiers.
-bool TouchDeviceNeedsPanGestureConversion(PTOUCHINPUT aOSEvent,
-                                          uint32_t aTouchCount) {
-  if (aTouchCount == 0) {
-    return false;
-  }
-  HANDLE source = aOSEvent[0].hSource;
+// Helper function for TouchDeviceNeedsPanGestureConversion(PTOUCHINPUT,
+// uint32_t).
+static bool TouchDeviceNeedsPanGestureConversion(HANDLE aSource) {
   std::string deviceName;
   UINT dataSize = 0;
   // The first call just queries how long the name string will be.
-  GetRawInputDeviceInfoA(source, RIDI_DEVICENAME, nullptr, &dataSize);
+  GetRawInputDeviceInfoA(aSource, RIDI_DEVICENAME, nullptr, &dataSize);
   if (!dataSize || dataSize > 0x10000) {
     return false;
   }
   deviceName.resize(dataSize);
   // The second call actually populates the string.
-  UINT result = GetRawInputDeviceInfoA(source, RIDI_DEVICENAME, &deviceName[0],
+  UINT result = GetRawInputDeviceInfoA(aSource, RIDI_DEVICENAME, &deviceName[0],
                                        &dataSize);
   if (result == UINT_MAX) {
     return false;
@@ -7032,7 +7025,7 @@
   deviceInfo.cbSize = sizeof(deviceInfo);
   dataSize = sizeof(deviceInfo);
   result =
-      GetRawInputDeviceInfoA(source, RIDI_DEVICEINFO, &deviceInfo, &dataSize);
+      GetRawInputDeviceInfoA(aSource, RIDI_DEVICEINFO, &deviceInfo, &dataSize);
   if (result == UINT_MAX) {
     return false;
   }
@@ -7044,12 +7037,33 @@
          deviceInfo.hid.usUsagePage == 13 && deviceInfo.hid.usUsage == 4;
 }
 
+// Determine if the touch device that originated |aOSEvent| needs to have
+// touch events representing a two-finger gesture converted to pan
+// gesture events.
+// We only do this for touch devices with a specific name and identifiers.
+static bool TouchDeviceNeedsPanGestureConversion(PTOUCHINPUT aOSEvent,
+                                                 uint32_t aTouchCount) {
+  if (aTouchCount == 0) {
+    return false;
+  }
+  HANDLE source = aOSEvent[0].hSource;
+
+  // Cache the result of this computation for each touch device.
+  // Touch devices are identified by the HANDLE stored in the hSource
+  // field of TOUCHINPUT.
+  static std::map<HANDLE, bool> sResultCache;
+  auto [iter, inserted] = sResultCache.emplace(source, false);
+  if (inserted) {
+    iter->second = TouchDeviceNeedsPanGestureConversion(source);
+  }
+  return iter->second;
+}
+
 Maybe<PanGestureInput> nsWindow::ConvertTouchToPanGesture(
     const MultiTouchInput& aTouchInput, PTOUCHINPUT aOSEvent) {
-  // The first time this function is called, perform some checks on the
-  // touch device that originated the touch event, to see if it's a device
+  // Checks if the touch device that originated the touch event is one
   // for which we want to convert the touch events to pang gesture events.
-  static bool shouldConvert = TouchDeviceNeedsPanGestureConversion(
+  bool shouldConvert = TouchDeviceNeedsPanGestureConversion(
       aOSEvent, aTouchInput.mTouches.Length());
   if (!shouldConvert) {
     return Nothing();
