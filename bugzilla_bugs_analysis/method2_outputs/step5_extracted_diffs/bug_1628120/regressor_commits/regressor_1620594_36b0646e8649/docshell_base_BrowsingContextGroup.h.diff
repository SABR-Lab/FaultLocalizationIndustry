# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: docshell/base/BrowsingContextGroup.h
# Commit: 36b0646e8649
# Full Hash: 36b0646e86498662e770756ad54b1fd648a82184
# Author: Andreas Farre <farre@mozilla.com>
# Date: 2020-04-07 21:44:02
# Regressor Bug: 1620594
# File Overlap Count: 1
# Description:
#   Bug 1620594 - Part 7: Remove TabGroup and SystemGroup. r=nika,bas
#   
#   TabGroup never really made any difference in which thread something go
#   dispatched to. This was the intended use, but development of TabGroups
#   with abstract main threads never made it that far. The good thing is
# ==============================================================================

diff -r a5ad3b179c92 -r 36b0646e8649 docshell/base/BrowsingContextGroup.h
--- a/docshell/base/BrowsingContextGroup.h	Tue Apr 07 15:17:14 2020 +0000
+++ b/docshell/base/BrowsingContextGroup.h	Tue Apr 07 15:17:47 2020 +0000
@@ -8,6 +8,7 @@
 #define mozilla_dom_BrowsingContextGroup_h
 
 #include "mozilla/dom/BrowsingContext.h"
+#include "nsRefPtrHashtable.h"
 #include "nsHashKeys.h"
 #include "nsTArray.h"
 #include "nsTHashtable.h"
@@ -23,9 +24,7 @@
 class ContentParent;
 
 // A BrowsingContextGroup represents the Unit of Related Browsing Contexts in
-// the standard. This object currently serves roughly the same purpose as the
-// TabGroup class which already exists, and at some point will likely merge with
-// it.
+// the standard.
 //
 // A BrowsingContext may not hold references to other BrowsingContext objects
 // which are not in the same BrowsingContextGroup.
@@ -119,6 +118,23 @@
 
   void GetDocGroups(nsTArray<DocGroup*>& aDocGroups);
 
+  // Called by Document when a Document needs to be added to a DocGroup.
+  already_AddRefed<DocGroup> AddDocument(const nsACString& aKey,
+                                         Document* aDocument);
+
+  // Called by Document when a Document needs to be removed to a DocGroup.
+  void RemoveDocument(const nsACString& aKey, Document* aDocument);
+
+  auto DocGroups() const { return mDocGroups.ConstIter(); }
+
+  mozilla::ThrottledEventQueue* GetTimerEventQueue() const {
+    return mTimerEventQueue;
+  }
+
+  mozilla::ThrottledEventQueue* GetWorkerEventQueue() const {
+    return mWorkerEventQueue;
+  }
+
  private:
   friend class CanonicalBrowsingContext;
 
@@ -134,6 +150,12 @@
   // The set of toplevel browsing contexts in the current BrowsingContextGroup.
   BrowsingContext::Children mToplevels;
 
+  // DocGroups are thread-safe, and not able to be cycle collected,
+  // but we still keep strong pointers. When all Documents are removed
+  // from DocGroup (by the BrowsingContextGroup), the DocGroup is
+  // removed from here.
+  nsRefPtrHashtable<nsCStringHashKey, DocGroup> mDocGroups;
+
   ContentParents mSubscribers;
 
   // Map of cached contexts that need to stay alive due to bfcache.
@@ -142,6 +164,9 @@
   // A queue to store postMessage events during page load, the queue will be
   // flushed once the page is loaded
   RefPtr<mozilla::ThrottledEventQueue> mPostMessageEventQueue;
+
+  RefPtr<mozilla::ThrottledEventQueue> mTimerEventQueue;
+  RefPtr<mozilla::ThrottledEventQueue> mWorkerEventQueue;
 };
 
 }  // namespace dom