# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/mediasession/MediaSession.cpp
# Commit: a008d3cebfdb
# Full Hash: a008d3cebfdb9d96ab32530b90180141575316a8
# Author: alwu <alwu@mozilla.com>
# Date: 2020-03-17 09:36:40
# Regressor Bug: 1582508
# File Overlap Count: 1
# Description:
#   Bug 1582508 - part4 : propagate declared playback state to media session controller. r=chunmin
#   
#   This patch includes the implementation of propagating declared playback state from the media session in the content process to the media session controller in the chrome process.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D66341
# ==============================================================================

diff -r a73415e9c006 -r a008d3cebfdb dom/media/mediasession/MediaSession.cpp
--- a/dom/media/mediasession/MediaSession.cpp	Tue Mar 17 00:03:44 2020 +0000
+++ b/dom/media/mediasession/MediaSession.cpp	Tue Mar 17 00:17:36 2020 +0000
@@ -45,8 +45,22 @@
     return;
   }
   mDeclaredPlaybackState = aPlaybackState;
-  // TODO : propagate declared state to the media controller in chrome process
-  // in order to call `media session actions update algorithm`.
+
+  RefPtr<BrowsingContext> currentBC = GetParentObject()->GetBrowsingContext();
+  MOZ_ASSERT(currentBC,
+             "Update session playback state after context destroyed!");
+  if (XRE_IsContentProcess()) {
+    ContentChild* contentChild = ContentChild::GetSingleton();
+    Unused << contentChild->SendNotifyMediaSessionPlaybackStateChanged(
+        currentBC, mDeclaredPlaybackState);
+    return;
+  }
+  // This would only happen when we disable e10s.
+  if (RefPtr<MediaController> controller =
+          currentBC->Canonical()->GetMediaController()) {
+    controller->SetDeclaredPlaybackState(currentBC->Id(),
+                                         mDeclaredPlaybackState);
+  }
 }
 
 MediaSessionPlaybackState MediaSession::PlaybackState() const {