# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: editor/libeditor/CreateElementTransaction.cpp
# Commit: 06bcc4f14cfa
# Full Hash: 06bcc4f14cfab44c0b8435aaffabd5d3736ba379
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2020-05-07 16:27:48
# Description:
#   Bug 1633700 - Make `CreateElementTransaction::InsertNewNode()` check the relation between container and child only when the point has child node r=m_kato
#   
#   I guess that this crash may occur in these conditions:
#   
#   1. It pointed end of a node, but the node has fewer children at redo.
# ==============================================================================

diff -r c3c27cb46db6 -r 06bcc4f14cfa editor/libeditor/CreateElementTransaction.cpp
--- a/editor/libeditor/CreateElementTransaction.cpp	Thu May 07 05:07:02 2020 +0000
+++ b/editor/libeditor/CreateElementTransaction.cpp	Thu May 07 02:25:03 2020 +0000
@@ -148,8 +148,14 @@
     return;
   }
 
-  if (NS_WARN_IF(mPointToInsert.GetContainer() !=
-                 mPointToInsert.GetChild()->GetParentNode())) {
+  // We still know a child, but the child is different element's child,
+  // we should just return error.
+  if (NS_WARN_IF(mPointToInsert.GetChild() &&
+                 mPointToInsert.GetContainer() !=
+                     mPointToInsert.GetChild()->GetParentNode())) {
+    // XXX Is NS_ERROR_EDITOR_UNEXPECTED_DOM_TREE better? Since it won't
+    //     cause throwing exception even if editor user throws an error
+    //     returned from editor's public method.
     aError.Throw(NS_ERROR_FAILURE);
     return;
   }