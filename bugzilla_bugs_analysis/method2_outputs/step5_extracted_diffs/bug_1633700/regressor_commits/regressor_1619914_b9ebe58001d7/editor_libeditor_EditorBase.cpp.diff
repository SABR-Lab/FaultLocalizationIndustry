# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: editor/libeditor/EditorBase.cpp
# Commit: b9ebe58001d7
# Full Hash: b9ebe58001d787bb0bbad6d39ae8681966d5a77f
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2020-04-04 09:29:13
# Regressor Bug: 1619914
# File Overlap Count: 1
# Description:
#   Bug 1619914 - part 2: Mark transaction class methods and their caller methods as `MOZ_CAN_RUN_SCRIPT r=m_kato
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D69303
# ==============================================================================

diff -r ce2087ddab5c -r b9ebe58001d7 editor/libeditor/EditorBase.cpp
--- a/editor/libeditor/EditorBase.cpp	Fri Apr 03 08:30:37 2020 +0000
+++ b/editor/libeditor/EditorBase.cpp	Fri Apr 03 08:32:01 2020 +0000
@@ -360,7 +360,7 @@
   // update nsTextStateManager and caret if we have focus
   nsCOMPtr<nsIContent> focusedContent = GetFocusedContent();
   if (focusedContent) {
-    DebugOnly<nsresult> rvIgnored = InitializeSelection(focusedContent);
+    DebugOnly<nsresult> rvIgnored = InitializeSelection(*focusedContent);
     NS_WARNING_ASSERTION(
         NS_SUCCEEDED(rvIgnored),
         "EditorBase::InitializeSelection() failed, but ignored");
@@ -5074,14 +5074,11 @@
   SelectionRefPtr()->SetAncestorLimiter(&aAncestorLimit);
 }
 
-nsresult EditorBase::InitializeSelection(EventTarget* aFocusEventTarget) {
+nsresult EditorBase::InitializeSelection(nsINode& aFocusEventTargetNode) {
   MOZ_ASSERT(IsEditActionDataAvailable());
 
-  nsCOMPtr<nsINode> targetNode = do_QueryInterface(aFocusEventTarget);
-  if (NS_WARN_IF(!targetNode)) {
-    return NS_ERROR_INVALID_ARG;
-  }
-  nsCOMPtr<nsIContent> selectionRootContent = FindSelectionRoot(targetNode);
+  nsCOMPtr<nsIContent> selectionRootContent =
+      FindSelectionRoot(&aFocusEventTargetNode);
   if (!selectionRootContent) {
     return NS_OK;
   }
@@ -5113,7 +5110,8 @@
   // Also, make sure to always ignore it for designMode, since that effectively
   // overrides everything and we allow to edit stuff with
   // contenteditable="false" subtrees in such a document.
-  caret->SetIgnoreUserModify(targetNode->OwnerDoc()->HasFlag(NODE_IS_EDITABLE));
+  caret->SetIgnoreUserModify(
+      aFocusEventTargetNode.OwnerDoc()->HasFlag(NODE_IS_EDITABLE));
 
   // Init selection
   rvIgnored =
@@ -5148,15 +5146,16 @@
     EditorRawDOMPoint atStartOfFirstRange(firstRange->StartRef());
     EditorRawDOMPoint betterInsertionPoint =
         FindBetterInsertionPoint(atStartOfFirstRange);
-    Text* textNode = betterInsertionPoint.GetContainerAsText();
+    RefPtr<Text> textNode = betterInsertionPoint.GetContainerAsText();
     MOZ_ASSERT(textNode,
                "There must be text node if composition string is not empty");
     if (textNode) {
       MOZ_ASSERT(textNode->Length() >= mComposition->XPEndOffsetInTextNode(),
                  "The text node must be different from the old text node");
+      RefPtr<TextRangeArray> ranges = mComposition->GetRanges();
       DebugOnly<nsresult> rvIgnored = CompositionTransaction::SetIMESelection(
           *this, textNode, mComposition->XPOffsetInTextNode(),
-          mComposition->XPLengthInTextNode(), mComposition->GetRanges());
+          mComposition->XPLengthInTextNode(), ranges);
       NS_WARNING_ASSERTION(
           NS_SUCCEEDED(rvIgnored),
           "CompositionTransaction::SetIMESelection() failed, but ignored");
@@ -5215,7 +5214,7 @@
     return;
   }
 
-  OnFocus(&aElement);
+  OnFocus(aElement);
 
   // If previous focused editor turn on spellcheck and this editor doesn't
   // turn on it, spellcheck state is mismatched.  So we need to re-sync it.
@@ -5493,13 +5492,13 @@
   return IsActiveInDOMWindow();
 }
 
-void EditorBase::OnFocus(EventTarget* aFocusEventTarget) {
+void EditorBase::OnFocus(nsINode& aFocusEventTargetNode) {
   AutoEditActionDataSetter editActionData(*this, EditAction::eNotEditing);
   if (NS_WARN_IF(!editActionData.CanHandle())) {
     return;
   }
 
-  InitializeSelection(aFocusEventTarget);
+  InitializeSelection(aFocusEventTargetNode);
   mSpellCheckerDictionaryUpdated = false;
   if (mInlineSpellChecker && CanEnableSpellCheck()) {
     DebugOnly<nsresult> rvIgnored =