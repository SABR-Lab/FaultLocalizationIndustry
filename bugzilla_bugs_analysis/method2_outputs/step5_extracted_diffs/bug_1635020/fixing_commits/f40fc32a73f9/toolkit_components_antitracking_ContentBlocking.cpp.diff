# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: toolkit/components/antitracking/ContentBlocking.cpp
# Commit: f40fc32a73f9
# Full Hash: f40fc32a73f9ea6c1eca3f9a0880a9fab1716e9a
# Author: Dimi Lee <dlee@mozilla.com>
# Date: 2020-05-05 21:38:25
# Description:
#   Bug 1635020 - Check whether browsing context is discarded after returning from an IPC call r=timhuang
#   
#   We keep the reference of BrowsingContext across IPC call. But the
#   BrowsingContext may be discarded when returning from the IPC call.
#   
# ==============================================================================

diff -r b87fcc141628 -r f40fc32a73f9 toolkit/components/antitracking/ContentBlocking.cpp
--- a/toolkit/components/antitracking/ContentBlocking.cpp	Tue May 05 18:48:37 2020 +0000
+++ b/toolkit/components/antitracking/ContentBlocking.cpp	Tue May 05 18:59:26 2020 +0000
@@ -362,7 +362,8 @@
                  // we don't call OnAllowAccessFor in the parent when this is
                  // triggered by the opener heuristic, so we have to do it here.
                  // See storePermission below for the reason.
-                 if (aReason == ContentBlockingNotifier::eOpener) {
+                 if (aReason == ContentBlockingNotifier::eOpener &&
+                     !bc->IsDiscarded()) {
                    MOZ_ASSERT(bc->IsInProcess());
                    ContentBlocking::OnAllowAccessFor(bc, trackingOrigin,
                                                      behavior, aReason);
