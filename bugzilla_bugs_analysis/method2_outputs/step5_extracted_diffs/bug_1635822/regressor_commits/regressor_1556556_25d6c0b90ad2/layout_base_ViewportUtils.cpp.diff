# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/ViewportUtils.cpp
# Commit: 25d6c0b90ad2
# Full Hash: 25d6c0b90ad2a5e3fef0e4628fcc64f7811812b5
# Author: Botond Ballo <botond@mozilla.com>
# Date: 2020-05-06 09:37:16
# Regressor Bug: 1556556
# File Overlap Count: 1
# Description:
#   Bug 1556556 - Support both CSS and LayoutDevice units in GetVisualToLayoutTransform(). r=kats
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D68725
# ==============================================================================

diff -r b76b8d0b94ca -r 25d6c0b90ad2 layout/base/ViewportUtils.cpp
--- a/layout/base/ViewportUtils.cpp	Tue May 05 19:37:26 2020 +0000
+++ b/layout/base/ViewportUtils.cpp	Tue May 05 19:22:42 2020 +0000
@@ -16,8 +16,14 @@
 using layers::InputAPZContext;
 using layers::ScrollableLayerGuid;
 
-CSSToCSSMatrix4x4 ViewportUtils::GetVisualToLayoutTransform(
+template <typename Units>
+gfx::Matrix4x4Typed<Units, Units> ViewportUtils::GetVisualToLayoutTransform(
     ScrollableLayerGuid::ViewID aScrollId) {
+  static_assert(
+      std::is_same_v<Units, CSSPixel> ||
+          std::is_same_v<Units, LayoutDevicePixel>,
+      "GetCallbackTransform() may only be used with CSS or LayoutDevice units");
+
   if (aScrollId == ScrollableLayerGuid::NULL_SCROLL_ID) {
     return {};
   }
@@ -42,10 +48,18 @@
 
   // Now apply the callback-transform. This is only approximately correct,
   // see the comment on GetCumulativeApzCallbackTransform for details.
-  CSSPoint transform = nsLayoutUtils::GetCumulativeApzCallbackTransform(
+  gfx::PointTyped<Units> transform;
+  CSSPoint transformCSS = nsLayoutUtils::GetCumulativeApzCallbackTransform(
       content->GetPrimaryFrame());
+  if constexpr (std::is_same_v<Units, CSSPixel>) {
+    transform = transformCSS;
+  } else {  // Units == LayoutDevicePixel
+    transform = transformCSS *
+                content->GetPrimaryFrame()->PresContext()->CSSToDevPixelScale();
+  }
 
-  return mozilla::CSSToCSSMatrix4x4::Scaling(1 / resolution, 1 / resolution, 1)
+  return gfx::Matrix4x4Typed<Units, Units>::Scaling(1 / resolution,
+                                                    1 / resolution, 1)
       .PostTranslate(transform.x, transform.y, 0);
 }
 
@@ -94,4 +108,13 @@
   return CSSPoint::ToAppUnits(transformed);
 }
 
+// Definitions of the two explicit instantiations forward declared in the header
+// file. This causes code for these instantiations to be emitted into the object
+// file for ViewportUtils.cpp.
+template CSSToCSSMatrix4x4 ViewportUtils::GetVisualToLayoutTransform<CSSPixel>(
+    ScrollableLayerGuid::ViewID);
+template LayoutDeviceToLayoutDeviceMatrix4x4
+    ViewportUtils::GetVisualToLayoutTransform<LayoutDevicePixel>(
+        ScrollableLayerGuid::ViewID);
+
 }  // namespace mozilla
\ No newline at end of file