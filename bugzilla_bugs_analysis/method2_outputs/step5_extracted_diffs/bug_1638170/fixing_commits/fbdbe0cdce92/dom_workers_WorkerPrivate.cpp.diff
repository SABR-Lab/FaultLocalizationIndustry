# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/workers/WorkerPrivate.cpp
# Commit: fbdbe0cdce92
# Full Hash: fbdbe0cdce92c5856678a1f3afd09dfa995c4488
# Author: Yaron Tausky <ytausky@mozilla.com>
# Date: 2020-05-26 21:37:52
# Description:
#   Bug 1638170 - Don't dispatch buggy WorkerRunnables r=asuth,dom-workers-and-storage-reviewers,sg
#   
#   This patch removes the dispatch of ReportGenericErrorRunnables when
#   a worker fails to start, since they were causing crashes and
#   weren't getting run anyway. It also adds an assertion that prevents
# ==============================================================================

diff -r 2bccc3e80006 -r fbdbe0cdce92 dom/workers/WorkerPrivate.cpp
--- a/dom/workers/WorkerPrivate.cpp	Mon May 25 20:31:28 2020 +0000
+++ b/dom/workers/WorkerPrivate.cpp	Tue May 26 11:38:58 2020 +0000
@@ -3712,6 +3712,15 @@
     if (mStatus >= aFailStatus) {
       return false;
     }
+
+    // We shouldn't create strong references to workers before their main loop
+    // begins running. Strong references must be disposed of on the worker
+    // thread, so strong references from other threads use a control runnable
+    // for that purpose. If the worker fails to reach the main loop stage then
+    // no control runnables get run and it would be impossible to get rid of the
+    // reference properly.
+    MOZ_DIAGNOSTIC_ASSERT_IF(aWorkerRef->IsPreventingShutdown(),
+                             mStatus >= WorkerStatus::Running);
   }
 
   MOZ_ASSERT(!data->mWorkerRefs.Contains(aWorkerRef),
