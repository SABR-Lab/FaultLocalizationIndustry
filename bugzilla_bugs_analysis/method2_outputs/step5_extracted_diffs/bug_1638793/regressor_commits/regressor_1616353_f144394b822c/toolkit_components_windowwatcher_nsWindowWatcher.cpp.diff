# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/windowwatcher/nsWindowWatcher.cpp
# Commit: f144394b822c
# Full Hash: f144394b822cea0388dc4cbc0241f17fe2e3faa3
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2020-04-08 03:36:50
# Regressor Bug: 1616353
# File Overlap Count: 1
# Description:
#   Bug 1616353 - Part 4: Don't second-guess CHROME_{REMOTE,FISSION}_WINDOW flags, r=kmag
#   
#   This could cause issues, as we could incorrectly override the decision made by
#   nsWindowWatcher, and then override the decision again after the method returns.
#   This could cause the initial content browser to be configured incorrectly.
# ==============================================================================

diff -r 9bae7eb4e34a -r f144394b822c toolkit/components/windowwatcher/nsWindowWatcher.cpp
--- a/toolkit/components/windowwatcher/nsWindowWatcher.cpp	Tue Apr 07 21:39:04 2020 +0000
+++ b/toolkit/components/windowwatcher/nsWindowWatcher.cpp	Tue Apr 07 21:39:07 2020 +0000
@@ -526,6 +526,10 @@
 
   uint32_t chromeFlags = CalculateChromeFlagsForChild(aFeatures, sizeSpec);
 
+  if (isPrivateBrowsingWindow) {
+    chromeFlags |= nsIWebBrowserChrome::CHROME_PRIVATE_WINDOW;
+  }
+
   // A content process has asked for a new window, which implies
   // that the new window will need to be remote.
   chromeFlags |= nsIWebBrowserChrome::CHROME_REMOTE_WINDOW;
@@ -721,6 +725,10 @@
       if (docShell->UseRemoteSubframes()) {
         chromeFlags |= nsIWebBrowserChrome::CHROME_FISSION_WINDOW;
       }
+    } else if (XRE_IsContentProcess()) {
+      // If we don't have a parent window, but we're loaded in the content
+      // process, force ourselves into a remote window.
+      chromeFlags |= nsIWebBrowserChrome::CHROME_REMOTE_WINDOW;
     }
   }
 