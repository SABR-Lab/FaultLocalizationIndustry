# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/builtin/intl/CommonFunctions.h
# Commit: a6338066da1f
# Full Hash: a6338066da1f1d9bcb3e92ae1997c02c6f0eb49e
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2020-05-20 03:39:31
# Regressor Bug: 1557727
# File Overlap Count: 1
# Description:
#   Bug 1557727 - Part 3: Implement Intl.DisplayNames proposal. r=jwalden
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D52165
# ==============================================================================

diff -r 93aa11dd931b -r a6338066da1f js/src/builtin/intl/CommonFunctions.h
--- a/js/src/builtin/intl/CommonFunctions.h	Tue May 19 11:17:48 2020 +0000
+++ b/js/src/builtin/intl/CommonFunctions.h	Tue May 19 11:18:16 2020 +0000
@@ -116,11 +116,20 @@
   int32_t size = strFn(chars.begin(), chars.length(), &status);
   if (status == U_BUFFER_OVERFLOW_ERROR) {
     MOZ_ASSERT(size >= 0);
+
+    // Some ICU functions (e.g. uloc_getDisplayName) return one less character
+    // than the actual minimum size when U_BUFFER_OVERFLOW_ERROR is raised,
+    // resulting in later reporting U_STRING_NOT_TERMINATED_WARNING. So add plus
+    // one here and then assert U_STRING_NOT_TERMINATED_WARNING isn't raised.
+    size++;
+
     if (!chars.resize(size_t(size))) {
       return -1;
     }
     status = U_ZERO_ERROR;
-    strFn(chars.begin(), size, &status);
+    size = strFn(chars.begin(), size, &status);
+
+    MOZ_ASSERT(status != U_STRING_NOT_TERMINATED_WARNING);
   }
   if (U_FAILURE(status)) {
     ReportInternalError(cx);