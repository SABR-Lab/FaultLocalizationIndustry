# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/base/nsAccUtils.cpp
# Commit: 987e73f47fda
# Full Hash: 987e73f47fda36f43597b6943f4c9d3509094561
# Author: James Teh <jteh@mozilla.com>
# Date: 2020-05-11 21:47:06
# Regressor Bug: 1572860
# File Overlap Count: 1
# Description:
#   Bug 1572860: Remove the ability for an outer document to override live region markup in an inner iframe document. r=MarcoZ
#   
#   This is something that was implemented a long time ago, but it isn't covered in any spec, other browsers don't implement it and I don't know of any usage in the wild.
#   This doesn't work with OOP iframes, since what we're doing here requires the documents to be in the same process.
#   Given it isn't used or specified, the simplest solution is to just remove the behaviour altogether.
# ==============================================================================

diff -r fabe539cdc5e -r 987e73f47fda accessible/base/nsAccUtils.cpp
--- a/accessible/base/nsAccUtils.cpp	Mon May 11 10:33:28 2020 +0000
+++ b/accessible/base/nsAccUtils.cpp	Mon May 11 11:13:43 2020 +0000
@@ -116,9 +116,13 @@
 }
 
 void nsAccUtils::SetLiveContainerAttributes(
-    nsIPersistentProperties* aAttributes, nsIContent* aStartContent,
-    dom::Element* aTopEl) {
+    nsIPersistentProperties* aAttributes, nsIContent* aStartContent) {
   nsAutoString live, relevant, busy;
+  dom::Document* doc = aStartContent->GetComposedDoc();
+  if (!doc) {
+    return;
+  }
+  dom::Element* topEl = doc->GetRootElement();
   nsIContent* ancestor = aStartContent;
   while (ancestor) {
     // container-relevant attribute
@@ -167,10 +171,14 @@
                                        busy))
       SetAccAttr(aAttributes, nsGkAtoms::containerBusy, busy);
 
-    if (ancestor == aTopEl) break;
+    if (ancestor == topEl) {
+      break;
+    }
 
     ancestor = ancestor->GetParent();
-    if (!ancestor) ancestor = aTopEl;  // Use <body>/<frameset>
+    if (!ancestor) {
+      ancestor = topEl;  // Use <body>/<frameset>
+    }
   }
 }
 
@@ -462,69 +470,43 @@
 bool nsAccUtils::IsARIALive(const Accessible* aAccessible) {
   // Get computed aria-live property based on the closest container with the
   // attribute. Inner nodes override outer nodes within the same
-  // document, but nodes in outer documents override nodes in inner documents.
+  // document.
   // This should be the same as the container-live attribute, but we don't need
   // the other container-* attributes, so we can't use the same function.
-  nsAutoString live;
-  nsIContent* startContent = aAccessible->GetContent();
-  while (startContent) {
-    dom::Document* doc = startContent->GetComposedDoc();
-    if (!doc) {
+  nsIContent* ancestor = aAccessible->GetContent();
+  dom::Document* doc = ancestor->GetComposedDoc();
+  if (!doc) {
+    return false;
+  }
+  dom::Element* topEl = doc->GetRootElement();
+  while (ancestor) {
+    const nsRoleMapEntry* role = nullptr;
+    if (ancestor->IsElement()) {
+      role = aria::GetRoleMap(ancestor->AsElement());
+    }
+    nsAutoString live;
+    if (HasDefinedARIAToken(ancestor, nsGkAtoms::aria_live)) {
+      ancestor->AsElement()->GetAttr(kNameSpaceID_None, nsGkAtoms::aria_live,
+                                     live);
+    } else if (role) {
+      GetLiveAttrValue(role->liveAttRule, live);
+    } else if (nsStaticAtom* value = GetAccService()->MarkupAttribute(
+                   ancestor, nsGkAtoms::live)) {
+      value->ToString(live);
+    }
+    if (!live.IsEmpty() && !live.EqualsLiteral("off")) {
+      return true;
+    }
+
+    if (ancestor == topEl) {
       break;
     }
 
-    dom::Element* aTopEl = doc->GetRootElement();
-    nsIContent* ancestor = startContent;
-    while (ancestor) {
-      nsAutoString docLive;
-      const nsRoleMapEntry* role = nullptr;
-      if (ancestor->IsElement()) {
-        role = aria::GetRoleMap(ancestor->AsElement());
-      }
-      if (HasDefinedARIAToken(ancestor, nsGkAtoms::aria_live)) {
-        ancestor->AsElement()->GetAttr(kNameSpaceID_None, nsGkAtoms::aria_live,
-                                       docLive);
-      } else if (role) {
-        GetLiveAttrValue(role->liveAttRule, docLive);
-      } else if (nsStaticAtom* value = GetAccService()->MarkupAttribute(
-                     ancestor, nsGkAtoms::live)) {
-        value->ToString(docLive);
-      }
-      if (!docLive.IsEmpty()) {
-        live = docLive;
-        break;
-      }
-
-      if (ancestor == aTopEl) {
-        break;
-      }
-
-      ancestor = ancestor->GetParent();
-      if (!ancestor) {
-        ancestor = aTopEl;  // Use <body>/<frameset>
-      }
+    ancestor = ancestor->GetParent();
+    if (!ancestor) {
+      ancestor = topEl;  // Use <body>/<frameset>
     }
-
-    // Allow ARIA live region markup from outer documents to override.
-    nsCOMPtr<nsIDocShellTreeItem> docShellTreeItem = doc->GetDocShell();
-    if (!docShellTreeItem) {
-      break;
-    }
-
-    nsCOMPtr<nsIDocShellTreeItem> sameTypeParent;
-    docShellTreeItem->GetInProcessSameTypeParent(
-        getter_AddRefs(sameTypeParent));
-    if (!sameTypeParent || sameTypeParent == docShellTreeItem) {
-      break;
-    }
-
-    dom::Document* parentDoc = doc->GetInProcessParentDocument();
-    if (!parentDoc) {
-      break;
-    }
-
-    startContent = parentDoc->FindContentForSubDocument(doc);
   }
 
-  return !live.IsEmpty() && !live.EqualsLiteral("off");
+  return false;
 }