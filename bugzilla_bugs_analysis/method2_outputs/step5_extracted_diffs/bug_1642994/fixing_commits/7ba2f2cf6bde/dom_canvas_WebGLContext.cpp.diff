# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLContext.cpp
# Commit: 7ba2f2cf6bde
# Full Hash: 7ba2f2cf6bdedd2cafd4e8717fa548e5b54dd184
# Author: Imanol Fernandez <mortimergoro@gmail.com>
# Date: 2020-07-10 09:48:19
# Description:
#   Bug 1642994 - Fix SurfaceTexture assertion failure in WebGLContext::GetFrontBuffer r=jgilbert
#   
#   - WaitForBufferOwnership() must be called before locking the front buffer
#   - Use mDefaultFB->mFB instead of 0 to fix a freeze in the readPixels call
#   - SurfaceTexture.releaseTexImage must be called after each use
# ==============================================================================

diff -r 4879dea5cdd6 -r 7ba2f2cf6bde dom/canvas/WebGLContext.cpp
--- a/dom/canvas/WebGLContext.cpp	Thu Jul 09 14:09:49 2020 +0000
+++ b/dom/canvas/WebGLContext.cpp	Thu Jul 09 18:31:12 2020 +0000
@@ -1035,6 +1035,7 @@
 
   // -
 
+  front->WaitForBufferOwnership();
   front->LockProd();
   front->ProducerReadAcquire();
   auto reset = MakeScopeExit([&] {
@@ -1061,7 +1062,8 @@
     fbTarget = LOCAL_GL_FRAMEBUFFER;
   }
 
-  gl->fBindFramebuffer(fbTarget, front->mFb ? front->mFb->mFB : 0);
+  gl->fBindFramebuffer(fbTarget,
+                       front->mFb ? front->mFb->mFB : mDefaultFB->mFB);
   if (pboWas) {
     BindBuffer(LOCAL_GL_PIXEL_PACK_BUFFER, nullptr);
   }