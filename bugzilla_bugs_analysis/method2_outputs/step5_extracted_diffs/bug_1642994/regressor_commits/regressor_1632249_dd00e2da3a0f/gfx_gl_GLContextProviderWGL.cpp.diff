# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/gl/GLContextProviderWGL.cpp
# Commit: dd00e2da3a0f
# Full Hash: dd00e2da3a0f11a7cc0af9e5ece21a339f4393eb
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-06-11 04:04:33
# Regressor Bug: 1632249
# File Overlap Count: 3
# Description:
#   Bug 1632249 - Support compositing out-of-process WebGL. r=handyman,lsalzman,nical,geckoview-reviewers,agi,imanol
#   
#   * Majorly simplity CanvasRenderer
#   * Replace GLScreenBuffer with trivial GLSwapChain
#   * Use descriptor structs so that future SharedSurface changes aren't so painful
# ==============================================================================

diff -r 69cc1de6f754 -r dd00e2da3a0f gfx/gl/GLContextProviderWGL.cpp
--- a/gfx/gl/GLContextProviderWGL.cpp	Wed Jun 10 21:57:19 2020 +0000
+++ b/gfx/gl/GLContextProviderWGL.cpp	Wed Jun 10 22:21:02 2020 +0000
@@ -265,20 +265,18 @@
   }
 }
 
-GLContextWGL::GLContextWGL(CreateContextFlags flags, const SurfaceCaps& caps,
-                           bool isOffscreen, HDC aDC, HGLRC aContext,
+GLContextWGL::GLContextWGL(const GLContextDesc& desc, HDC aDC, HGLRC aContext,
                            HWND aWindow)
-    : GLContext(flags, caps, nullptr, isOffscreen),
+    : GLContext(desc, nullptr, false),
       mDC(aDC),
       mContext(aContext),
       mWnd(aWindow),
       mPBuffer(nullptr),
       mPixelFormat(0) {}
 
-GLContextWGL::GLContextWGL(CreateContextFlags flags, const SurfaceCaps& caps,
-                           bool isOffscreen, HANDLE aPbuffer, HDC aDC,
+GLContextWGL::GLContextWGL(const GLContextDesc& desc, HANDLE aPbuffer, HDC aDC,
                            HGLRC aContext, int aPixelFormat)
-    : GLContext(flags, caps, nullptr, isOffscreen),
+    : GLContext(desc, nullptr, false),
       mDC(aDC),
       mContext(aContext),
       mWnd(nullptr),
@@ -441,9 +439,7 @@
   const auto context = sWGLLib.CreateContextWithFallback(dc, false);
   if (!context) return nullptr;
 
-  SurfaceCaps caps = SurfaceCaps::ForRGBA();
-  const RefPtr<GLContextWGL> gl = new GLContextWGL(
-      CreateContextFlags::NONE, SurfaceCaps::ForRGBA(), false, dc, context);
+  const RefPtr<GLContextWGL> gl = new GLContextWGL({}, dc, context);
   cleanupDc.release();
   gl->mIsDoubleBuffered = true;
   if (!gl->Init()) return nullptr;
@@ -465,7 +461,7 @@
 
 /*static*/
 already_AddRefed<GLContext> GLContextProviderWGL::CreateHeadless(
-    const CreateContextFlags flags, nsACString* const out_failureId) {
+    const GLContextCreateDesc& desc, nsACString* const out_failureId) {
   auto& wgl = sWGLLib;
   if (!wgl.EnsureInitialized()) return nullptr;
 
@@ -509,10 +505,9 @@
   const auto context = wgl.CreateContextWithFallback(dc, true);
   if (!context) return nullptr;
 
-  const bool isOffscreen = true;
+  const auto fullDesc = GLContextDesc{desc, true};
   const RefPtr<GLContextWGL> gl =
-      new GLContextWGL(flags, SurfaceCaps::Any(), isOffscreen, pbuffer, dc,
-                       context, chosenFormat);
+      new GLContextWGL(fullDesc, pbuffer, dc, context, chosenFormat);
   cleanupPbuffer.release();
   cleanupDc.release();
   if (!gl->Init()) return nullptr;
@@ -522,16 +517,10 @@
 
 /*static*/
 already_AddRefed<GLContext> GLContextProviderWGL::CreateOffscreen(
-    const IntSize& size, const SurfaceCaps& minCaps, CreateContextFlags flags,
+    const IntSize& size, const GLContextCreateDesc& desc,
     nsACString* const out_failureId) {
   *out_failureId = NS_LITERAL_CSTRING("FEATURE_FAILURE_WGL_INIT");
-
-  RefPtr<GLContext> gl = CreateHeadless(flags, out_failureId);
-  if (!gl) return nullptr;
-
-  if (!gl->InitOffscreen(size, minCaps)) return nullptr;
-
-  return gl.forget();
+  return CreateHeadless(desc, out_failureId);
 }
 
 /*static*/