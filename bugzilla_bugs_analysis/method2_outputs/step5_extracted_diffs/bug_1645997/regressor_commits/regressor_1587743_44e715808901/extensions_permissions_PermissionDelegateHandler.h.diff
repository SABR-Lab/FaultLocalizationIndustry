# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: extensions/permissions/PermissionDelegateHandler.h
# Commit: 44e715808901
# Full Hash: 44e71580890195d163912b96f41ef09e32570ec8
# Author: Tim Huang <tihuang@mozilla.com>
# Date: 2020-06-13 03:21:52
# Regressor Bug: 1587743
# File Overlap Count: 1
# Description:
#   Bug 1587743 - Part 1: Pre-compute the delegated permissions for the top-level content and store it in the WindowContext. r=baku,nika
#   
#   In order to delegate the permission to the top-level window, in this
#   patch, we pre-compute the permissions of the top-level context and set
#   them to the top-level WindowContext. So, the cross-origin iframe can
# ==============================================================================

diff -r a890be633ec3 -r 44e715808901 extensions/permissions/PermissionDelegateHandler.h
--- a/extensions/permissions/PermissionDelegateHandler.h	Fri Jun 12 16:18:15 2020 +0000
+++ b/extensions/permissions/PermissionDelegateHandler.h	Fri Jun 12 16:31:49 2020 +0000
@@ -26,6 +26,7 @@
 #ifndef mozilla_PermissionDelegateHandler_h
 #define mozilla_PermissionDelegateHandler_h
 
+#include "mozilla/Array.h"
 #include "nsCycleCollectionParticipant.h"
 #include "nsISupports.h"
 #include "nsIPermissionDelegateHandler.h"
@@ -38,7 +39,8 @@
 namespace mozilla {
 namespace dom {
 class Document;
-}
+class WindowContext;
+}  // namespace dom
 
 class PermissionDelegateHandler final : public nsIPermissionDelegateHandler {
  public:
@@ -50,6 +52,16 @@
   explicit PermissionDelegateHandler() = default;
   explicit PermissionDelegateHandler(mozilla::dom::Document* aDocument);
 
+  static constexpr size_t DELEGATED_PERMISSION_COUNT = 11;
+
+  typedef struct DelegatedPermissionList {
+    Array<uint32_t, DELEGATED_PERMISSION_COUNT> mPermissions;
+
+    bool operator==(const DelegatedPermissionList& aOther) const {
+      return mPermissions == aOther.mPermissions;
+    }
+  } DelegatedPermissionList;
+
   bool Initialize();
 
   /*
@@ -144,6 +156,18 @@
                                        nsIContentPermissionRequest* aRequest,
                                        nsIPrincipal** aResult);
 
+  /**
+   * Populate all delegated permissions to the WindowContext of the associated
+   * document. We only populate the permissions for the top-level content.
+   */
+  void PopulateAllDelegatedPermissions();
+
+  /**
+   * Update the given delegated permission to the WindowContext. We only
+   * update it for the top-level content.
+   */
+  void UpdateDelegatedPermission(const nsACString& aType);
+
  private:
   ~PermissionDelegateHandler() = default;
 
@@ -156,6 +180,17 @@
    */
   bool HasFeaturePolicyAllowed(const PermissionDelegateInfo* info) const;
 
+  /**
+   * A helper function to test the permission and set the result to the given
+   * list. It will return true if the permission is changed, otherwise false.
+   */
+  bool UpdateDelegatePermissionInternal(
+      PermissionDelegateHandler::DelegatedPermissionList& aList,
+      const nsACString& aType, size_t aIdx,
+      nsresult (NS_STDCALL nsIPermissionManager::*aTestFunc)(nsIPrincipal*,
+                                                             const nsACString&,
+                                                             uint32_t*));
+
   // A weak pointer to our document. Nulled out by DropDocumentReference.
   mozilla::dom::Document* mDocument;
 