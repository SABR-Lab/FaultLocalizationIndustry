# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/systemservices/android_video_capture/java/src/org/webrtc/videoengine/VideoCaptureAndroid.java
# Commit: 21569aa4bced
# Full Hash: 21569aa4bcedb149bb3d1f5424f9d1d14e0fe441
# Author: Dan Minor <dminor@mozilla.com>
# Date: 2020-07-03 03:56:55
# Description:
#   Bug 1646220 - Remove unlinkCapturer from VideoCaptureAndroid; r=ng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D81374
# ==============================================================================

diff -r 885d2ba42467 -r 21569aa4bced dom/media/systemservices/android_video_capture/java/src/org/webrtc/videoengine/VideoCaptureAndroid.java
--- a/dom/media/systemservices/android_video_capture/java/src/org/webrtc/videoengine/VideoCaptureAndroid.java	Thu Jul 02 18:07:10 2020 +0000
+++ b/dom/media/systemservices/android_video_capture/java/src/org/webrtc/videoengine/VideoCaptureAndroid.java	Mon Jun 29 18:45:45 2020 +0000
@@ -49,7 +49,7 @@
   private final CountDownLatch capturerStopped = new CountDownLatch(1);
 
  @WebRTCJNITarget
- public VideoCaptureAndroid(String deviceName, long native_capturer) {
+ public VideoCaptureAndroid(String deviceName) {
     // Remove the camera facing information from the name.
     String[] parts = deviceName.split("Facing (front|back):");
     if (parts.length == 2) {
@@ -58,7 +58,6 @@
       Log.e(TAG, "VideoCaptureAndroid: Expected facing mode as part of name: " + deviceName);
       this.deviceName = deviceName;
     }
-    this.native_capturer = native_capturer;
     this.context = GetContext();
 
     CameraEnumerator enumerator;
@@ -89,7 +88,8 @@
   @WebRTCJNITarget
   private synchronized boolean startCapture(
       final int width, final int height,
-      final int min_mfps, final int max_mfps) {
+      final int min_mfps, final int max_mfps,
+      long native_capturer) {
     Log.d(TAG, "startCapture: " + width + "x" + height + "@" +
         min_mfps + ":" + max_mfps);
 
@@ -103,18 +103,12 @@
     } catch (InterruptedException e) {
       return false;
     }
+    if (capturerStartedSucceeded) {
+      this.native_capturer = native_capturer;
+    }
     return capturerStartedSucceeded;
   }
 
-  @WebRTCJNITarget
-  private void unlinkCapturer() {
-    // stopCapture might fail. That might leave the callbacks dangling, so make
-    // sure those don't call into dead code.
-    // Note that onPreviewCameraFrame isn't synchronized, so there's no point in
-    // synchronizing us either. ProvideCameraFrame has to do the null check.
-    native_capturer = 0;
-  }
-
   // Called by native code.  Returns true when camera is known to be stopped.
   @WebRTCJNITarget
   private synchronized boolean stopCapture() {
@@ -123,6 +117,7 @@
       return false;
     }
 
+    native_capturer = 0;
     try {
       cameraVideoCapturer.stopCapture();
       capturerStopped.await();