# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/Document.cpp
# Commit: c5b351d19a30
# Full Hash: c5b351d19a3076dd2b782fdbc6fa0d5c07267adb
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-15 21:48:38
# Regressor Bug: 1599160
# File Overlap Count: 1
# Description:
#   Bug 1599160 - Allow caching stylesheets across documents. r=heycam
#   
#   This patch implements a per-process cache of parsed stylesheets for
#   non-inline sheets. The entries are evicted when the document gets
#   destroyed and there's no other document with the same principal around.
# ==============================================================================

diff -r 3ce9af6580b2 -r c5b351d19a30 dom/base/Document.cpp
--- a/dom/base/Document.cpp	Mon Jun 15 13:53:18 2020 +0000
+++ b/dom/base/Document.cpp	Fri Jun 12 19:31:32 2020 +0000
@@ -2352,10 +2352,6 @@
       static_cast<nsIMutationObserver*>(this));
 
   mOnloadBlocker = new OnloadBlocker();
-  mCSSLoader = new css::Loader(this);
-  // Assume we're not quirky, until we know otherwise
-  mCSSLoader->SetCompatibilityMode(eCompatibility_FullStandards);
-
   mStyleImageLoader = new css::ImageLoader(this);
 
   mNodeInfoManager = new nsNodeInfoManager();
@@ -2370,6 +2366,10 @@
 
   NS_ASSERTION(OwnerDoc() == this, "Our nodeinfo is busted!");
 
+  mCSSLoader = new css::Loader(this);
+  // Assume we're not quirky, until we know otherwise
+  mCSSLoader->SetCompatibilityMode(eCompatibility_FullStandards);
+
   // If after creation the owner js global is not set for a document
   // we use the default compartment for this document, instead of creating
   // wrapper in some random compartment when the document is exposed to js
@@ -3727,9 +3727,14 @@
       mAllowDNSPrefetch = false;
     }
   }
+
+  mCSSLoader->DeregisterFromSheetCache();
+
   mNodeInfoManager->SetDocumentPrincipal(aNewPrincipal);
   mPartitionedPrincipal = aNewPartitionedPrincipal;
 
+  mCSSLoader->RegisterInSheetCache();
+
   ContentBlockingAllowList::ComputePrincipal(
       aNewPrincipal, getter_AddRefs(mContentBlockingAllowListPrincipal));
 