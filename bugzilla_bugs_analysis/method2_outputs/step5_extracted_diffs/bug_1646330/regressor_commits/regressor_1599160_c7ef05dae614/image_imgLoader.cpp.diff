# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: image/imgLoader.cpp
# Commit: c7ef05dae614
# Full Hash: c7ef05dae61432443aafb8e78b31fa1ad314d70e
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-12 03:05:25
# Regressor Bug: 1599160
# File Overlap Count: 1
# Description:
#   Bug 1599160 - Better integration of the shared stylesheet cache with the network cache. r=tnikkel,mayhemer,heycam
#   
#   Make the stylesheet cache respect the same headers as the image cache
#   does. This makes no-cache stylesheets work as they do now, which is
#   useful for developers that want to develop sites locally, and for
# ==============================================================================

diff -r 466cfd0ad5db -r c7ef05dae614 image/imgLoader.cpp
--- a/image/imgLoader.cpp	Thu Jun 11 11:41:59 2020 +0000
+++ b/image/imgLoader.cpp	Thu Jun 11 11:42:01 2020 +0000
@@ -960,11 +960,11 @@
   return NS_OK;
 }
 
+static uint32_t SecondsFromPRTime(PRTime aTime) {
+  return nsContentUtils::SecondsFromPRTime(aTime);
+}
+
 /* static */
-uint32_t imgCacheEntry::SecondsFromPRTime(PRTime prTime) {
-  return uint32_t(int64_t(prTime) / int64_t(PR_USEC_PER_SEC));
-}
-
 imgCacheEntry::imgCacheEntry(imgLoader* loader, imgRequest* request,
                              bool forcePrincipalCheck)
     : mLoader(loader),
@@ -1822,8 +1822,8 @@
   // If the expiration time is zero, then the request has not gotten far enough
   // to know when it will expire.
   uint32_t expiryTime = aEntry->GetExpiryTime();
-  bool hasExpired = expiryTime != 0 &&
-                    expiryTime <= imgCacheEntry::SecondsFromPRTime(PR_Now());
+  bool hasExpired =
+      expiryTime != 0 && expiryTime <= SecondsFromPRTime(PR_Now());
 
   nsresult rv;
 
@@ -1840,8 +1840,7 @@
       if (NS_SUCCEEDED(rv)) {
         // nsIFile uses millisec, NSPR usec
         fileLastMod *= 1000;
-        hasExpired =
-            imgCacheEntry::SecondsFromPRTime((PRTime)fileLastMod) > lastModTime;
+        hasExpired = SecondsFromPRTime((PRTime)fileLastMod) > lastModTime;
       }
     }
   }