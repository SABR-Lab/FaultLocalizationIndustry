# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsContentUtils.cpp
# Commit: f4e67ab1b25f
# Full Hash: f4e67ab1b25f03d695505622f66970736f518fdb
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-15 21:48:38
# Regressor Bug: 1599160
# File Overlap Count: 1
# Description:
#   Bug 1599160 - Better integration of the shared stylesheet cache with the network cache. r=tnikkel,mayhemer,heycam
#   
#   Make the stylesheet cache respect the same headers as the image cache
#   does. This makes no-cache stylesheets work as they do now, which is
#   useful for developers that want to develop sites locally, and for
# ==============================================================================

diff -r a86e9b4f395f -r f4e67ab1b25f dom/base/nsContentUtils.cpp
--- a/dom/base/nsContentUtils.cpp	Fri Jun 12 19:05:56 2020 +0000
+++ b/dom/base/nsContentUtils.cpp	Fri Jun 12 19:06:04 2020 +0000
@@ -153,6 +153,7 @@
 #include "nsHTMLTags.h"
 #include "nsIAnonymousContentCreator.h"
 #include "nsIAsyncVerifyRedirectCallback.h"
+#include "nsICacheInfoChannel.h"
 #include "nsICategoryManager.h"
 #include "nsIChannelEventSink.h"
 #include "nsIConsoleService.h"
@@ -10357,3 +10358,37 @@
 
   return windowSafeAreaInsets;
 }
+
+/* static */
+nsContentUtils::SubresourceCacheValidationInfo
+nsContentUtils::GetSubresourceCacheValidationInfo(nsIRequest* aRequest) {
+  SubresourceCacheValidationInfo info;
+  if (nsCOMPtr<nsICacheInfoChannel> cache = do_QueryInterface(aRequest)) {
+    uint32_t value = 0;
+    if (NS_SUCCEEDED(cache->GetCacheTokenExpirationTime(&value))) {
+      info.mExpirationTime.emplace(value);
+    }
+  }
+
+  // Determine whether the cache entry must be revalidated when we try to use
+  // it. Currently, only HTTP specifies this information...
+  if (nsCOMPtr<nsIHttpChannel> httpChannel = do_QueryInterface(aRequest)) {
+    Unused << httpChannel->IsNoStoreResponse(&info.mMustRevalidate);
+
+    if (!info.mMustRevalidate) {
+      Unused << httpChannel->IsNoCacheResponse(&info.mMustRevalidate);
+    }
+
+    // FIXME(bug 1644173): Why this check?
+    if (!info.mMustRevalidate) {
+      nsAutoCString cacheHeader;
+      Unused << httpChannel->GetResponseHeader(
+          NS_LITERAL_CSTRING("Cache-Control"), cacheHeader);
+      if (PL_strcasestr(cacheHeader.get(), "must-revalidate")) {
+        info.mMustRevalidate = true;
+      }
+    }
+  }
+
+  return info;
+}