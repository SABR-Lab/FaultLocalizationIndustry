# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/StreamLoader.cpp
# Commit: f4e67ab1b25f
# Full Hash: f4e67ab1b25f03d695505622f66970736f518fdb
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-15 21:48:38
# Regressor Bug: 1599160
# File Overlap Count: 1
# Description:
#   Bug 1599160 - Better integration of the shared stylesheet cache with the network cache. r=tnikkel,mayhemer,heycam
#   
#   Make the stylesheet cache respect the same headers as the image cache
#   does. This makes no-cache stylesheets work as they do now, which is
#   useful for developers that want to develop sites locally, and for
# ==============================================================================

diff -r a86e9b4f395f -r f4e67ab1b25f layout/style/StreamLoader.cpp
--- a/layout/style/StreamLoader.cpp	Fri Jun 12 19:05:56 2020 +0000
+++ b/layout/style/StreamLoader.cpp	Fri Jun 12 19:06:04 2020 +0000
@@ -8,6 +8,7 @@
 
 #include "mozilla/Encoding.h"
 #include "mozilla/ScopeExit.h"
+#include "nsContentUtils.h"
 #include "nsIChannel.h"
 #include "nsIInputStream.h"
 #include "nsISupportsPriority.h"
@@ -132,6 +133,15 @@
     }
   }  // run destructor for `bytes`
 
+  auto info = nsContentUtils::GetSubresourceCacheValidationInfo(aRequest);
+
+  // For now, we never cache entries that we have to revalidate.
+  if (!info.mExpirationTime || info.mMustRevalidate) {
+    info.mExpirationTime =
+        Some(nsContentUtils::SecondsFromPRTime(PR_Now()) - 1);
+  }
+  mSheetLoadData->mExpirationTime = *info.mExpirationTime;
+
   // For reasons I don't understand, factoring the below lines into
   // a method on SheetLoadData resulted in a linker error. Hence,
   // accessing fields of mSheetLoadData from here.
