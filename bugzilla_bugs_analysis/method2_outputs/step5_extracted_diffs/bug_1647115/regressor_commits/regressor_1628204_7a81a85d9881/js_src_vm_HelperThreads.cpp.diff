# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/HelperThreads.cpp
# Commit: 7a81a85d9881
# Full Hash: 7a81a85d988158e98b3fd5fb269059cd1bca5063
# Author: Yoshi Cheng-Hao Huang <allstars.chh@gmail.com>
# Date: 2020-06-17 14:49:45
# Regressor Bug: 1628204
# File Overlap Count: 2
# Description:
#   Bug 1628204 - Part 1: Move append to compressionFinishedList inside runTask. r=jonco
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D78461
# ==============================================================================

diff -r e9de35da7a75 -r 7a81a85d9881 js/src/vm/HelperThreads.cpp
--- a/js/src/vm/HelperThreads.cpp	Wed Jun 17 06:54:07 2020 +0000
+++ b/js/src/vm/HelperThreads.cpp	Wed Jun 17 07:37:40 2020 +0000
@@ -2282,18 +2282,9 @@
   {
     AutoUnlockHelperThreadState unlock(locked);
 
-    TraceLoggerThread* logger = TraceLoggerForCurrentThread();
-    AutoTraceLog logCompile(logger, TraceLogger_CompressSource);
-
-    task->runTask();
-  }
-
-  {
-    AutoEnterOOMUnsafeRegion oomUnsafe;
-    if (!HelperThreadState().compressionFinishedList(locked).append(
-            std::move(task))) {
-      oomUnsafe.crash("handleCompressionWorkload");
-    }
+    // release the pointer, inside runTask the SourceCompressTask pointer will
+    // be stored in compressionFinishedList.
+    task.release()->runTask();
   }
 
   currentTask.reset();