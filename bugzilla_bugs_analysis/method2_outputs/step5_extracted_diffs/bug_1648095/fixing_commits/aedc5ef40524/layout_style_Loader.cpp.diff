# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/style/Loader.cpp
# Commit: aedc5ef40524
# Full Hash: aedc5ef4052442461e5408a4f612dd835196f09a
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-26 09:45:40
# Description:
#   Bug 1648095 - Don't defer the same sheet load twice. r=heycam
#   
#   When we call into LoadSheet when starting pending loads for a given
#   loader, it may be the case that the original loader may still not care
#   about the load. However some other loader will, so we can't defer this.
# ==============================================================================

diff -r 5e0244588a91 -r aedc5ef40524 layout/style/Loader.cpp
--- a/layout/style/Loader.cpp	Fri Jun 26 01:06:48 2020 +0000
+++ b/layout/style/Loader.cpp	Fri Jun 26 01:17:40 2020 +0000
@@ -1273,11 +1273,12 @@
   if (mSheets) {
     // If we have at least one other load ongoing, then we can defer it until
     // all non-pending loads are done.
-    if (aSheetState == SheetState::NeedsParser && aLoadData.ShouldDefer() &&
+    if (aSheetState == SheetState::NeedsParser &&
+        aPendingLoad == PendingLoad::No && aLoadData.ShouldDefer() &&
         mOngoingLoadCount > mPendingLoadCount + 1) {
       LOG(("  Deferring sheet load"));
       ++mPendingLoadCount;
-      mSheets->DeferSheetLoad(aLoadData);
+      mSheets->DeferSheetLoad(key, aLoadData);
       return NS_OK;
     }
 