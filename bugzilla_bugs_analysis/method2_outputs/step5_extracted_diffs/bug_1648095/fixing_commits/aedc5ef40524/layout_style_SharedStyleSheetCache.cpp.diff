# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/style/SharedStyleSheetCache.cpp
# Commit: aedc5ef40524
# Full Hash: aedc5ef4052442461e5408a4f612dd835196f09a
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-26 09:45:40
# Description:
#   Bug 1648095 - Don't defer the same sheet load twice. r=heycam
#   
#   When we call into LoadSheet when starting pending loads for a given
#   loader, it may be the case that the original loader may still not care
#   about the load. However some other loader will, so we can't defer this.
# ==============================================================================

diff -r 5e0244588a91 -r aedc5ef40524 layout/style/SharedStyleSheetCache.cpp
--- a/layout/style/SharedStyleSheetCache.cpp	Fri Jun 26 01:06:48 2020 +0000
+++ b/layout/style/SharedStyleSheetCache.cpp	Fri Jun 26 01:17:40 2020 +0000
@@ -230,10 +230,13 @@
   return n;
 }
 
-void SharedStyleSheetCache::DeferSheetLoad(SheetLoadData& aData) {
-  SheetLoadDataHashKey key(aData);
+void SharedStyleSheetCache::DeferSheetLoad(const SheetLoadDataHashKey& aKey,
+                                           SheetLoadData& aData) {
+  MOZ_ASSERT(SheetLoadDataHashKey(aData).KeyEquals(aKey));
+  MOZ_DIAGNOSTIC_ASSERT(!aData.mNext, "Should only defer loads once");
+
   aData.mMustNotify = true;
-  mPendingDatas.Put(key, RefPtr{&aData});
+  mPendingDatas.Put(aKey, RefPtr{&aData});
 }
 
 void SharedStyleSheetCache::LoadStarted(const SheetLoadDataHashKey& aKey,