# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/SharedStyleSheetCache.cpp
# Commit: d07d66ecd6b9
# Full Hash: d07d66ecd6b9ca685444912826f25e9751ef13b5
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-23 21:38:40
# Regressor Bug: 1645122
# File Overlap Count: 3
# Description:
#   Bug 1645122 - Properly block onload when coalescing loads with other documents. r=heycam
#   
#   If two loading documents hit the sheet cache and we coalesce the
#   resource load, there's nothing that prevents the load event on the
#   second document from firing right now, and there should be.
# ==============================================================================

diff -r ce1a126dcf10 -r d07d66ecd6b9 layout/style/SharedStyleSheetCache.cpp
--- a/layout/style/SharedStyleSheetCache.cpp	Mon Jun 22 13:24:19 2020 +0000
+++ b/layout/style/SharedStyleSheetCache.cpp	Tue Jun 23 08:27:54 2020 +0000
@@ -162,6 +162,15 @@
   return {};
 }
 
+void SharedStyleSheetCache::WillStartPendingLoad(SheetLoadData& aData) {
+  SheetLoadData* curr = &aData;
+  do {
+    MOZ_DIAGNOSTIC_ASSERT(curr->mLoader->mPendingLoadCount,
+                          "Where did this pending load come from?");
+    --curr->mLoader->mPendingLoadCount;
+  } while ((curr = curr->mNext));
+}
+
 bool SharedStyleSheetCache::CoalesceLoad(const SheetLoadDataHashKey& aKey,
                                          SheetLoadData& aNewLoad,
                                          SheetState aExistingLoadState) {
@@ -185,6 +194,8 @@
     mPendingDatas.Remove(aKey, getter_AddRefs(removedData));
     MOZ_ASSERT(removedData == existingData, "Bad loading table");
 
+    WillStartPendingLoad(*removedData);
+
     // We insert to the front instead of the back, to keep the invariant that
     // the front sheet always is the one that triggers the load.
     aNewLoad.mNext = std::move(removedData);
@@ -410,6 +421,8 @@
 
 void SharedStyleSheetCache::StartDeferredLoadsForLoader(
     css::Loader& aLoader, StartLoads aStartLoads) {
+  using PendingLoad = css::Loader::PendingLoad;
+
   LoadDataArray arr;
   for (auto iter = mPendingDatas.Iter(); !iter.Done(); iter.Next()) {
     bool startIt = false;
@@ -432,7 +445,8 @@
     }
   }
   for (auto& data : arr) {
-    data->mLoader->LoadSheet(*data, SheetState::NeedsParser);
+    WillStartPendingLoad(*data);
+    data->mLoader->LoadSheet(*data, SheetState::NeedsParser, PendingLoad::Yes);
   }
 }
 