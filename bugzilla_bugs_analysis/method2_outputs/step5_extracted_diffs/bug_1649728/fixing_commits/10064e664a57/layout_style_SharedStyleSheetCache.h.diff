# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/style/SharedStyleSheetCache.h
# Commit: 10064e664a57
# Full Hash: 10064e664a57f5a297dd25ae8c6ba07c03398b2a
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-07-17 03:27:56
# Description:
#   Bug 1649728 - Use WeakPtr in SharedStyleSheetCache::mLoadingDatas. r=firefox-style-system-reviewers,jwatt
#   
#   This is safer in case Necko fails to notify us. The only repro we have
#   is fixed by bug 1651661, but this should hopefully be uncontroversial as
#   well and prevents crashing in release builds.
# ==============================================================================

diff -r dce645f310a5 -r 10064e664a57 layout/style/SharedStyleSheetCache.h
--- a/layout/style/SharedStyleSheetCache.h	Thu Jul 16 17:31:10 2020 +0000
+++ b/layout/style/SharedStyleSheetCache.h	Thu Jul 16 16:31:52 2020 +0000
@@ -124,11 +124,12 @@
 
   nsDataHashtable<SheetLoadDataHashKey, CompleteSheet> mCompleteSheets;
   nsRefPtrHashtable<SheetLoadDataHashKey, css::SheetLoadData> mPendingDatas;
-  // The SheetLoadData pointers in mLoadingDatas below are weak references.
+  // The SheetLoadData pointers in mLoadingDatas below are weak references that
+  // get cleaned up when StreamLoader::OnStopRequest gets called.
   //
   // Note that we hold on to all sheet loads, even if in the end they happen not
   // to be cacheable.
-  nsDataHashtable<SheetLoadDataHashKey, css::SheetLoadData*> mLoadingDatas;
+  nsDataHashtable<SheetLoadDataHashKey, WeakPtr<css::SheetLoadData>> mLoadingDatas;
 
   // An origin-to-number-of-registered-documents count, in order to manage cache
   // eviction as described in RegisterLoader / UnregisterLoader.