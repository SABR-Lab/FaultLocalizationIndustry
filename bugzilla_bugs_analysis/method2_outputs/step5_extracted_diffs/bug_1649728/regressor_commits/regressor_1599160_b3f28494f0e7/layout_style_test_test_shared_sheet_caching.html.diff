# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/test/test_shared_sheet_caching.html
# Commit: b3f28494f0e7
# Full Hash: b3f28494f0e7736db4b9d0f078147641857b064f
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-12 03:05:25
# Regressor Bug: 1599160
# File Overlap Count: 3
# Description:
#   Bug 1599160 - Allow caching stylesheets across documents. r=heycam
#   
#   This patch implements a per-process cache of parsed stylesheets for
#   non-inline sheets. The entries are evicted when the document gets
#   destroyed and there's no other document with the same principal around.
# ==============================================================================

diff -r f4f14bc9ba47 -r b3f28494f0e7 layout/style/test/test_shared_sheet_caching.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/layout/style/test/test_shared_sheet_caching.html	Thu Jun 11 11:42:46 2020 +0000
@@ -0,0 +1,35 @@
+<!doctype html>
+<meta charset="utf-8">
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<script>
+  function childWindowLoaded(childWin) {
+    is(
+      childWin.getComputedStyle(childWin.document.documentElement).backgroundColor,
+      "rgb(0, 255, 0)",
+      "Sheet should apply",
+    )
+    is(
+      SpecialPowers.getDOMWindowUtils(childWin).parsedStyleSheets,
+      0,
+      `Shouldn't need to parse the stylesheet ${childWin.parent == window ? "frame" : "top"}`
+    );
+    if (childWin.top == childWin) {
+      SimpleTest.finish();
+    }
+  }
+</script>
+<link rel="stylesheet" href="file_shared_sheet_caching.css">
+<iframe src="file_shared_sheet_caching.html"></iframe>
+<a rel="opener" href="file_shared_sheet_caching.html" target="_blank">Navigation</a>
+<script>
+SimpleTest.waitForExplicitFinish();
+onload = function() {
+  info("Sheets parsed: " + SpecialPowers.DOMWindowUtils.parsedStyleSheets);
+  is(
+    getComputedStyle(document.documentElement).backgroundColor,
+    "rgb(0, 255, 0)",
+    "Sheet should apply",
+  )
+  document.querySelector("a").click();
+}
+</script>
