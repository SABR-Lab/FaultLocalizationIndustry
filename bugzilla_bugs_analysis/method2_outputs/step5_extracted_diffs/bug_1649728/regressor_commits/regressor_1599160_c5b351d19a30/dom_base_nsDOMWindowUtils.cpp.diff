# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsDOMWindowUtils.cpp
# Commit: c5b351d19a30
# Full Hash: c5b351d19a3076dd2b782fdbc6fa0d5c07267adb
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-06-15 21:48:38
# Regressor Bug: 1599160
# File Overlap Count: 3
# Description:
#   Bug 1599160 - Allow caching stylesheets across documents. r=heycam
#   
#   This patch implements a per-process cache of parsed stylesheets for
#   non-inline sheets. The entries are evicted when the document gets
#   destroyed and there's no other document with the same principal around.
# ==============================================================================

diff -r 3ce9af6580b2 -r c5b351d19a30 dom/base/nsDOMWindowUtils.cpp
--- a/dom/base/nsDOMWindowUtils.cpp	Mon Jun 15 13:53:18 2020 +0000
+++ b/dom/base/nsDOMWindowUtils.cpp	Fri Jun 12 19:31:32 2020 +0000
@@ -25,6 +25,7 @@
 #include "mozilla/dom/Touch.h"
 #include "mozilla/dom/UserActivation.h"
 #include "mozilla/PendingAnimationTracker.h"
+#include "mozilla/SharedStyleSheetCache.h"
 #include "nsIObjectLoadingContent.h"
 #include "nsFrame.h"
 #include "mozilla/layers/APZCCallbackHelper.h"
@@ -988,6 +989,23 @@
 }
 
 NS_IMETHODIMP
+nsDOMWindowUtils::ClearSharedStyleSheetCache() {
+  SharedStyleSheetCache::ClearForTest();
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsDOMWindowUtils::GetParsedStyleSheets(uint32_t* aSheets) {
+  RefPtr<Document> doc = GetDocument();
+  if (!doc) {
+    return NS_ERROR_UNEXPECTED;
+  }
+
+  *aSheets = doc->CSSLoader()->ParsedSheetCount();
+  return NS_OK;
+}
+
+NS_IMETHODIMP
 nsDOMWindowUtils::ClearNativeTouchSequence(nsIObserver* aObserver) {
   nsCOMPtr<nsIWidget> widget = GetWidget();
   if (!widget) {