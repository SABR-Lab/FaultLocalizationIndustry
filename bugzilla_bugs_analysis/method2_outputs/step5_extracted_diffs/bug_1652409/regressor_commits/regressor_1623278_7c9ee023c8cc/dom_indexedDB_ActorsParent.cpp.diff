# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/indexedDB/ActorsParent.cpp
# Commit: 7c9ee023c8cc
# Full Hash: 7c9ee023c8cc72aab0269cebeb7a2f02c5281cd1
# Author: Simon Giesecke <sgiesecke@mozilla.com>
# Date: 2020-04-01 21:26:59
# Regressor Bug: 1623278
# File Overlap Count: 1
# Description:
#   Bug 1623278 - Use SafeRefPtr for FileInfo. r=dom-workers-and-storage-reviewers,asuth
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D65550
# ==============================================================================

diff -r 7e9d56eb485e -r 7c9ee023c8cc dom/indexedDB/ActorsParent.cpp
--- a/dom/indexedDB/ActorsParent.cpp	Wed Apr 01 09:52:54 2020 +0000
+++ b/dom/indexedDB/ActorsParent.cpp	Wed Apr 01 09:53:01 2020 +0000
@@ -4953,12 +4953,12 @@
 };
 
 class DatabaseConnection::UpdateRefcountFunction::FileInfoEntry final {
-  RefPtr<FileInfo> mFileInfo;
+  SafeRefPtr<FileInfo> mFileInfo;
   int32_t mDelta;
   int32_t mSavepointDelta;
 
  public:
-  explicit FileInfoEntry(RefPtr<FileInfo> aFileInfo)
+  explicit FileInfoEntry(SafeRefPtr<FileInfo> aFileInfo)
       : mFileInfo(std::move(aFileInfo)), mDelta(0), mSavepointDelta(0) {
     MOZ_COUNT_CTOR(DatabaseConnection::UpdateRefcountFunction::FileInfoEntry);
   }
@@ -4976,7 +4976,7 @@
     }
   }
   void DecBySavepointDelta() { mDelta -= mSavepointDelta; }
-  RefPtr<FileInfo> ReleaseFileInfo() { return std::move(mFileInfo); }
+  SafeRefPtr<FileInfo> ReleaseFileInfo() { return std::move(mFileInfo); }
   void MaybeUpdateDBRefs() {
     if (mDelta) {
       mFileInfo->UpdateDBRefs(mDelta);
@@ -6017,7 +6017,7 @@
 
   void SetActorAlive();
 
-  void MapBlob(const IPCBlob& aIPCBlob, RefPtr<FileInfo> aFileInfo);
+  void MapBlob(const IPCBlob& aIPCBlob, SafeRefPtr<FileInfo> aFileInfo);
 
   bool IsActorAlive() const {
     AssertIsOnBackgroundThread();
@@ -6067,7 +6067,7 @@
                     mFactory.forget());
   }
 
-  MOZ_MUST_USE RefPtr<FileInfo> GetBlob(const IPCBlob& aID);
+  MOZ_MUST_USE SafeRefPtr<FileInfo> GetBlob(const IPCBlob& aID);
 
   void UnmapBlob(const nsID& aID);
 
@@ -6220,15 +6220,21 @@
   // - Cleared on the connection thread once the file has successfully been
   //   written to disk.
   InitializedOnce<const RefPtr<BlobImpl>> mBlobImpl;
-  const RefPtr<FileInfo> mFileInfo;
+  const SafeRefPtr<FileInfo> mFileInfo;
 
  public:
   NS_INLINE_DECL_THREADSAFE_REFCOUNTING(mozilla::dom::indexedDB::DatabaseFile);
 
-  const RefPtr<FileInfo>& GetFileInfo() const {
-    AssertIsOnBackgroundThread();
-
-    return mFileInfo;
+  const FileInfo& GetFileInfo() const {
+    AssertIsOnBackgroundThread();
+
+    return *mFileInfo;
+  }
+
+  SafeRefPtr<FileInfo> GetFileInfoPtr() const {
+    AssertIsOnBackgroundThread();
+
+    return mFileInfo.clonePtr();
   }
 
   /**
@@ -6254,15 +6260,15 @@
 
  public:
   // Called when sending to the child.
-  explicit DatabaseFile(FileInfo* aFileInfo)
-      : mBlobImpl{nullptr}, mFileInfo(aFileInfo) {
+  explicit DatabaseFile(SafeRefPtr<FileInfo> aFileInfo)
+      : mBlobImpl{nullptr}, mFileInfo(std::move(aFileInfo)) {
     AssertIsOnBackgroundThread();
     MOZ_ASSERT(mFileInfo);
   }
 
   // Called when receiving from the child.
-  DatabaseFile(RefPtr<BlobImpl> aBlobImpl, FileInfo* aFileInfo)
-      : mBlobImpl(std::move(aBlobImpl)), mFileInfo(aFileInfo) {
+  DatabaseFile(RefPtr<BlobImpl> aBlobImpl, SafeRefPtr<FileInfo> aFileInfo)
+      : mBlobImpl(std::move(aBlobImpl)), mFileInfo(std::move(aFileInfo)) {
     AssertIsOnBackgroundThread();
     MOZ_ASSERT(*mBlobImpl);
     MOZ_ASSERT(mFileInfo);
@@ -6675,12 +6681,11 @@
 
 class MutableFile : public BackgroundMutableFileParentBase {
   const RefPtr<Database> mDatabase;
-  const RefPtr<FileInfo> mFileInfo;
-
- public:
-  static MOZ_MUST_USE RefPtr<MutableFile> Create(nsIFile* aFile,
-                                                 Database* aDatabase,
-                                                 RefPtr<FileInfo> aFileInfo);
+  const SafeRefPtr<FileInfo> mFileInfo;
+
+ public:
+  static MOZ_MUST_USE RefPtr<MutableFile> Create(
+      nsIFile* aFile, Database* aDatabase, SafeRefPtr<FileInfo> aFileInfo);
 
   const Database& GetDatabase() const {
     AssertIsOnBackgroundThread();
@@ -6688,10 +6693,10 @@
     return *mDatabase;
   }
 
-  const RefPtr<FileInfo>& GetFileInfo() const {
-    AssertIsOnBackgroundThread();
-
-    return mFileInfo;
+  SafeRefPtr<FileInfo> GetFileInfoPtr() const {
+    AssertIsOnBackgroundThread();
+
+    return mFileInfo.clonePtr();
   }
 
   void NoteActiveState() override;
@@ -6706,7 +6711,7 @@
 
  private:
   MutableFile(nsIFile* aFile, RefPtr<Database> aDatabase,
-              RefPtr<FileInfo> aFileInfo);
+              SafeRefPtr<FileInfo> aFileInfo);
 
   ~MutableFile() override;
 
@@ -7180,7 +7185,7 @@
 class CreateFileOp final : public DatabaseOp {
   const CreateFileParams mParams;
 
-  InitializedOnce<const RefPtr<FileInfo>, LazyInit::Allow> mFileInfo;
+  InitializedOnce<const SafeRefPtr<FileInfo>, LazyInit::Allow> mFileInfo;
 
  public:
   CreateFileOp(Database* aDatabase, const DatabaseRequestParams& aParams);
@@ -7427,7 +7432,7 @@
   typedef mozilla::dom::quota::PersistenceType PersistenceType;
 
   class StoredFileInfo final {
-    InitializedOnceMustBeTrue<const RefPtr<FileInfo>> mFileInfo;
+    InitializedOnceMustBeTrue<const SafeRefPtr<FileInfo>> mFileInfo;
     // Either nothing, a file actor or a non-Blob-backed inputstream to write to
     // disk.
     using FileActorOrInputStream =
@@ -7439,11 +7444,12 @@
 
     void AssertInvariants() const;
 
-    explicit StoredFileInfo(RefPtr<FileInfo> aFileInfo);
-
-    StoredFileInfo(RefPtr<FileInfo> aFileInfo, RefPtr<DatabaseFile> aFileActor);
-
-    StoredFileInfo(RefPtr<FileInfo> aFileInfo,
+    explicit StoredFileInfo(SafeRefPtr<FileInfo> aFileInfo);
+
+    StoredFileInfo(SafeRefPtr<FileInfo> aFileInfo,
+                   RefPtr<DatabaseFile> aFileActor);
+
+    StoredFileInfo(SafeRefPtr<FileInfo> aFileInfo,
                    nsCOMPtr<nsIInputStream> aInputStream);
 
    public:
@@ -7461,11 +7467,11 @@
     StoredFileInfo(StoredFileInfo&&) = default;
 #endif
 
-    static StoredFileInfo CreateForMutableFile(RefPtr<FileInfo> aFileInfo);
-    static StoredFileInfo CreateForBlob(RefPtr<FileInfo> aFileInfo,
+    static StoredFileInfo CreateForMutableFile(SafeRefPtr<FileInfo> aFileInfo);
+    static StoredFileInfo CreateForBlob(SafeRefPtr<FileInfo> aFileInfo,
                                         RefPtr<DatabaseFile> aFileActor);
     static StoredFileInfo CreateForStructuredClone(
-        RefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream);
+        SafeRefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream);
 
 #if defined(DEBUG) || defined(NS_BUILD_REFCNT_LOGGING)
     ~StoredFileInfo() {
@@ -7567,7 +7573,7 @@
 }
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::StoredFileInfo(
-    RefPtr<FileInfo> aFileInfo)
+    SafeRefPtr<FileInfo> aFileInfo)
     : mFileInfo{std::move(aFileInfo)}, mFileActorOrInputStream {
   Nothing {}
 }
@@ -7582,7 +7588,7 @@
 }
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::StoredFileInfo(
-    RefPtr<FileInfo> aFileInfo, RefPtr<DatabaseFile> aFileActor)
+    SafeRefPtr<FileInfo> aFileInfo, RefPtr<DatabaseFile> aFileActor)
     : mFileInfo{std::move(aFileInfo)}, mFileActorOrInputStream {
   std::move(aFileActor)
 }
@@ -7597,7 +7603,7 @@
 }
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::StoredFileInfo(
-    RefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream)
+    SafeRefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream)
     : mFileInfo{std::move(aFileInfo)}, mFileActorOrInputStream {
   std::move(aInputStream)
 }
@@ -7613,19 +7619,19 @@
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::CreateForMutableFile(
-    RefPtr<FileInfo> aFileInfo) {
+    SafeRefPtr<FileInfo> aFileInfo) {
   return StoredFileInfo{std::move(aFileInfo)};
 }
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::CreateForBlob(
-    RefPtr<FileInfo> aFileInfo, RefPtr<DatabaseFile> aFileActor) {
+    SafeRefPtr<FileInfo> aFileInfo, RefPtr<DatabaseFile> aFileActor) {
   return {std::move(aFileInfo), std::move(aFileActor)};
 }
 
 ObjectStoreAddOrPutRequestOp::StoredFileInfo
 ObjectStoreAddOrPutRequestOp::StoredFileInfo::CreateForStructuredClone(
-    RefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream) {
+    SafeRefPtr<FileInfo> aFileInfo, nsCOMPtr<nsIInputStream> aInputStream) {
   return {std::move(aFileInfo), std::move(aInputStream)};
 }
 
@@ -9191,7 +9197,7 @@
     return Err(rv);
   }
 
-  RefPtr<FileInfo> fileInfo = aFileManager.GetFileInfo(id);
+  SafeRefPtr<FileInfo> fileInfo = aFileManager.GetFileInfo(id);
   MOZ_ASSERT(fileInfo);
   // XXX In bug 1432133, for some reasons FileInfo object cannot be got. This
   // is just a short-term fix, and we are working on finding the real cause
@@ -10253,7 +10259,7 @@
           mgr->GetFileManager(aPersistenceType, aOrigin, aDatabaseName);
 
       if (fileManager) {
-        const RefPtr<FileInfo> fileInfo = fileManager->GetFileInfo(aFileId);
+        const SafeRefPtr<FileInfo> fileInfo = fileManager->GetFileInfo(aFileId);
 
         if (fileInfo) {
           fileInfo->GetReferences(aMemRefCnt, aDBRefCnt);
@@ -13917,7 +13923,8 @@
   AddRef();
 }
 
-void Database::MapBlob(const IPCBlob& aIPCBlob, RefPtr<FileInfo> aFileInfo) {
+void Database::MapBlob(const IPCBlob& aIPCBlob,
+                       SafeRefPtr<FileInfo> aFileInfo) {
   AssertIsOnBackgroundThread();
 
   const IPCBlobStream& stream = aIPCBlob.inputStream();
@@ -13927,7 +13934,7 @@
       stream.get_PIPCBlobInputStreamParent());
 
   MOZ_ASSERT(!mMappedBlobs.GetWeak(actor->ID()));
-  mMappedBlobs.Put(actor->ID(), std::move(aFileInfo));
+  mMappedBlobs.Put(actor->ID(), AsRefPtr(std::move(aFileInfo)));
 
   RefPtr<UnmapBlobCallback> callback = new UnmapBlobCallback(this);
   actor->SetCallback(callback);
@@ -13973,7 +13980,7 @@
   aResult.AppendInt(mActorDestroyed);
 }
 
-RefPtr<FileInfo> Database::GetBlob(const IPCBlob& aIPCBlob) {
+SafeRefPtr<FileInfo> Database::GetBlob(const IPCBlob& aIPCBlob) {
   AssertIsOnBackgroundThread();
 
   const IPCBlobStream& stream = aIPCBlob.inputStream();
@@ -13994,7 +14001,7 @@
     return nullptr;
   }
 
-  return fileInfo;
+  return SafeRefPtr{std::move(fileInfo)};
 }
 
 void Database::UnmapBlob(const nsID& aID) {
@@ -14143,17 +14150,18 @@
 Database::AllocPBackgroundIDBDatabaseFileParent(const IPCBlob& aIPCBlob) {
   AssertIsOnBackgroundThread();
 
-  RefPtr<FileInfo> fileInfo = GetBlob(aIPCBlob);
+  SafeRefPtr<FileInfo> fileInfo = GetBlob(aIPCBlob);
   RefPtr<DatabaseFile> actor;
 
   if (fileInfo) {
-    actor = new DatabaseFile(fileInfo);
+    actor = new DatabaseFile(std::move(fileInfo));
   } else {
     // This is a blob we haven't seen before.
     fileInfo = mFileManager->CreateFileInfo();
     MOZ_ASSERT(fileInfo);
 
-    actor = new DatabaseFile(IPCBlobUtils::Deserialize(aIPCBlob), fileInfo);
+    actor = new DatabaseFile(IPCBlobUtils::Deserialize(aIPCBlob),
+                             std::move(fileInfo));
   }
 
   MOZ_ASSERT(actor);
@@ -20295,7 +20303,7 @@
 }
 
 MutableFile::MutableFile(nsIFile* aFile, RefPtr<Database> aDatabase,
-                         RefPtr<FileInfo> aFileInfo)
+                         SafeRefPtr<FileInfo> aFileInfo)
     : BackgroundMutableFileParentBase(FILE_HANDLE_STORAGE_IDB, aDatabase->Id(),
                                       IntString(aFileInfo->Id()), aFile),
       mDatabase(std::move(aDatabase)),
@@ -20308,7 +20316,7 @@
 MutableFile::~MutableFile() { mDatabase->UnregisterMutableFile(this); }
 
 RefPtr<MutableFile> MutableFile::Create(nsIFile* aFile, Database* aDatabase,
-                                        RefPtr<FileInfo> aFileInfo) {
+                                        SafeRefPtr<FileInfo> aFileInfo) {
   AssertIsOnBackgroundThread();
 
   RefPtr<MutableFile> newMutableFile =
@@ -23595,7 +23603,7 @@
   }
 
   RefPtr<MutableFile> mutableFile =
-      MutableFile::Create(file, mDatabase, *mFileInfo);
+      MutableFile::Create(file, mDatabase, mFileInfo->clonePtr());
   if (NS_WARN_IF(!mutableFile)) {
     IDB_REPORT_INTERNAL_ERR();
     return NS_ERROR_DOM_INDEXEDDB_UNKNOWN_ERR;
@@ -25324,7 +25332,7 @@
           MOZ_ASSERT(fileActor);
 
           mStoredFileInfos.EmplaceBack(StoredFileInfo::CreateForBlob(
-              fileActor->GetFileInfo(), fileActor));
+              fileActor->GetFileInfoPtr(), fileActor));
           break;
         }
 
@@ -25337,7 +25345,7 @@
           MOZ_ASSERT(mutableFileActor);
 
           mStoredFileInfos.EmplaceBack(StoredFileInfo::CreateForMutableFile(
-              mutableFileActor->GetFileInfo()));
+              mutableFileActor->GetFileInfoPtr()));
 
           break;
         }