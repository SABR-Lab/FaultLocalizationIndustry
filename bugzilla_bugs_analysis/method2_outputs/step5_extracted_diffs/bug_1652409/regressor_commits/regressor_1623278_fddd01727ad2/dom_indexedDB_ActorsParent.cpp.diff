# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/indexedDB/ActorsParent.cpp
# Commit: fddd01727ad2
# Full Hash: fddd01727ad2f5c097b4d750bba958d0cdfc1340
# Author: Simon Giesecke <sgiesecke@mozilla.com>
# Date: 2020-05-14 16:15:31
# Regressor Bug: 1623278
# File Overlap Count: 1
# Description:
#   Bug 1623278 - Use MovingNotNull in ActorsParent. r=dom-workers-and-storage-reviewers,janv
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D73033
# ==============================================================================

diff -r 5f5964262d18 -r fddd01727ad2 dom/indexedDB/ActorsParent.cpp
--- a/dom/indexedDB/ActorsParent.cpp	Thu May 14 09:14:04 2020 +0000
+++ b/dom/indexedDB/ActorsParent.cpp	Thu May 14 09:14:17 2020 +0000
@@ -921,14 +921,13 @@
                                                  aIndexValues);
 }
 
-nsresult CreateFileTables(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult CreateFileTables(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("CreateFileTables", DOM);
 
   // Table `file`
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE file ("
                          "id INTEGER PRIMARY KEY, "
                          "refcount INTEGER NOT NULL"
@@ -937,7 +936,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_insert_trigger "
                          "AFTER INSERT ON object_data "
                          "FOR EACH ROW "
@@ -949,7 +948,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TRIGGER object_data_update_trigger "
       "AFTER UPDATE OF file_ids ON object_data "
       "FOR EACH ROW "
@@ -961,7 +960,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_delete_trigger "
                          "AFTER DELETE ON object_data "
                          "FOR EACH ROW WHEN OLD.file_ids IS NOT NULL "
@@ -972,7 +971,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER file_update_trigger "
                          "AFTER UPDATE ON file "
                          "FOR EACH ROW WHEN NEW.refcount = 0 "
@@ -986,9 +985,8 @@
   return NS_OK;
 }
 
-nsresult CreateTables(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult CreateTables(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("CreateTables", DOM);
 
@@ -1000,7 +998,7 @@
   // origins exactly match. Second, chrome code crawling through the idb
   // directory can figure out the origin of every db without having to
   // reverse-engineer our hash scheme.
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE database"
                          "( name TEXT PRIMARY KEY"
                          ", origin TEXT NOT NULL"
@@ -1014,7 +1012,7 @@
   }
 
   // Table `object_store`
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE object_store"
                          "( id INTEGER PRIMARY KEY"
                          ", auto_increment INTEGER NOT NULL DEFAULT 0"
@@ -1026,7 +1024,7 @@
   }
 
   // Table `object_store_index`
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE object_store_index"
                          "( id INTEGER PRIMARY KEY"
                          ", object_store_id INTEGER NOT NULL"
@@ -1044,7 +1042,7 @@
   }
 
   // Table `object_data`
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE object_data"
                          "( object_store_id INTEGER NOT NULL"
                          ", key BLOB NOT NULL"
@@ -1060,7 +1058,7 @@
   }
 
   // Table `index_data`
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE index_data"
                          "( index_id INTEGER NOT NULL"
                          ", value BLOB NOT NULL"
@@ -1077,7 +1075,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE INDEX index_data_value_locale_index "
       "ON index_data (index_id, value_locale, object_data_key, value) "
       "WHERE value_locale IS NOT NULL;"));
@@ -1086,7 +1084,7 @@
   }
 
   // Table `unique_index_data`
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE unique_index_data"
                          "( index_id INTEGER NOT NULL"
                          ", value BLOB NOT NULL"
@@ -1103,7 +1101,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE INDEX unique_index_data_value_locale_index "
       "ON unique_index_data (index_id, value_locale, object_data_key, value) "
       "WHERE value_locale IS NOT NULL;"));
@@ -1116,17 +1114,16 @@
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(kSQLiteSchemaVersion);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom4To5(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(kSQLiteSchemaVersion);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom4To5(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom4To5", DOM);
 
@@ -1135,7 +1132,7 @@
   // All we changed is the type of the version column, so lets try to
   // convert that to an integer, and if we fail, set it to 0.
   nsCOMPtr<mozIStorageStatement> stmt;
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT name, version, dataVersion "
                          "FROM database"),
       getter_AddRefs(stmt));
@@ -1181,12 +1178,12 @@
     }
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING("DROP TABLE database"));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING("DROP TABLE database"));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE database ("
                          "name TEXT NOT NULL, "
                          "version INTEGER NOT NULL DEFAULT 0, "
@@ -1198,7 +1195,7 @@
 
   // The parameter names are not used, parameters are bound by index only
   // locally in the same function.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("INSERT INTO database (name, version, dataVersion) "
                          "VALUES (:name, :version, :dataVersion)"),
       getter_AddRefs(stmt));
@@ -1230,40 +1227,39 @@
     }
   }
 
-  rv = aConnection->SetSchemaVersion(5);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom5To6(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(5);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom5To6(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom5To6", DOM);
 
   // First, drop all the indexes we're no longer going to use.
-  nsresult rv = aConnection->ExecuteSimpleSQL(
-      NS_LITERAL_CSTRING("DROP INDEX key_index;"));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv =
+      aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING("DROP INDEX key_index;"));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP INDEX ai_key_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP INDEX value_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP INDEX ai_value_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1272,7 +1268,7 @@
   // Now, reorder the columns of object_data to put the blob data last. We do
   // this by copying into a temporary table, dropping the original, then copying
   // back into a newly created table.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id INTEGER PRIMARY KEY, "
                          "object_store_id, "
@@ -1283,7 +1279,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT id, object_store_id, key_value, data "
                          "FROM object_data;"));
@@ -1291,13 +1287,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE object_data ("
       "id INTEGER PRIMARY KEY, "
       "object_store_id INTEGER NOT NULL, "
@@ -1311,7 +1307,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO object_data "
                          "SELECT id, object_store_id, key_value, data "
                          "FROM temp_upgrade;"));
@@ -1319,7 +1315,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1327,7 +1323,7 @@
 
   // We need to add a unique constraint to our ai_object_data table. Copy all
   // the data out of it using a temporary table as before.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id INTEGER PRIMARY KEY, "
                          "object_store_id, "
@@ -1337,7 +1333,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT id, object_store_id, data "
                          "FROM ai_object_data;"));
@@ -1345,13 +1341,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_object_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE ai_object_data ("
       "id INTEGER PRIMARY KEY AUTOINCREMENT, "
       "object_store_id INTEGER NOT NULL, "
@@ -1364,7 +1360,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO ai_object_data "
                          "SELECT id, object_store_id, data "
                          "FROM temp_upgrade;"));
@@ -1372,7 +1368,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1380,7 +1376,7 @@
 
   // Fix up the index_data table. We're reordering the columns as well as
   // changing the primary key from being a simple id to being a composite.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -1391,7 +1387,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO temp_upgrade "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM index_data;"));
@@ -1399,13 +1395,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE index_data ("
       "index_id INTEGER NOT NULL, "
       "value NOT NULL, "
@@ -1421,7 +1417,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT OR IGNORE INTO index_data "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM temp_upgrade;"));
@@ -1429,13 +1425,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE INDEX index_data_object_data_id_index "
                          "ON index_data (object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -1444,7 +1440,7 @@
 
   // Fix up the unique_index_data table. We're reordering the columns as well as
   // changing the primary key from being a simple id to being a composite.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -1455,7 +1451,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO temp_upgrade "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM unique_index_data;"));
@@ -1463,13 +1459,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE unique_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE unique_index_data ("
       "index_id INTEGER NOT NULL, "
       "value NOT NULL, "
@@ -1486,7 +1482,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO unique_index_data "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM temp_upgrade;"));
@@ -1494,13 +1490,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE INDEX unique_index_data_object_data_id_index "
                          "ON unique_index_data (object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -1509,7 +1505,7 @@
 
   // Fix up the ai_index_data table. We're reordering the columns as well as
   // changing the primary key from being a simple id to being a composite.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -1519,7 +1515,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT index_id, value, ai_object_data_id "
                          "FROM ai_index_data;"));
@@ -1527,13 +1523,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE ai_index_data ("
       "index_id INTEGER NOT NULL, "
       "value NOT NULL, "
@@ -1548,7 +1544,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT OR IGNORE INTO ai_index_data "
                          "SELECT index_id, value, ai_object_data_id "
                          "FROM temp_upgrade;"));
@@ -1556,13 +1552,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE INDEX ai_index_data_ai_object_data_id_index "
                          "ON ai_index_data (ai_object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -1571,7 +1567,7 @@
 
   // Fix up the ai_unique_index_data table. We're reordering the columns as well
   // as changing the primary key from being a simple id to being a composite.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -1581,7 +1577,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT index_id, value, ai_object_data_id "
                          "FROM ai_unique_index_data;"));
@@ -1589,13 +1585,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_unique_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE ai_unique_index_data ("
       "index_id INTEGER NOT NULL, "
       "value NOT NULL, "
@@ -1611,7 +1607,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO ai_unique_index_data "
                          "SELECT index_id, value, ai_object_data_id "
                          "FROM temp_upgrade;"));
@@ -1619,34 +1615,33 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE INDEX ai_unique_index_data_ai_object_data_id_index "
       "ON ai_unique_index_data (ai_object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(6);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom6To7(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(6);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom6To7(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom6To7", DOM);
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id, "
                          "name, "
@@ -1657,7 +1652,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT id, name, key_path, auto_increment "
                          "FROM object_store;"));
@@ -1665,13 +1660,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_store;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TABLE object_store ("
                          "id INTEGER PRIMARY KEY, "
                          "auto_increment INTEGER NOT NULL DEFAULT 0, "
@@ -1683,7 +1678,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO object_store "
       "SELECT id, auto_increment, name, nullif(key_path, '') "
       "FROM temp_upgrade;"));
@@ -1691,27 +1686,26 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(7);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom7To8(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(7);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom7To8(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom7To8", DOM);
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id, "
                          "object_store_id, "
@@ -1724,7 +1718,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT id, object_store_id, name, key_path, "
                          "unique_index, object_store_autoincrement "
@@ -1733,13 +1727,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_store_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE object_store_index ("
       "id INTEGER, "
       "object_store_id INTEGER NOT NULL, "
@@ -1757,7 +1751,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO object_store_index "
                          "SELECT id, object_store_id, name, key_path, "
                          "unique_index, 0, object_store_autoincrement "
@@ -1766,13 +1760,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(8);
+  rv = aConnection.SetSchemaVersion(8);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -1845,14 +1839,13 @@
   }
 };
 
-nsresult UpgradeSchemaFrom8To9_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult UpgradeSchemaFrom8To9_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom8To9_0", DOM);
 
   // We no longer use the dataVersion column.
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("UPDATE database SET dataVersion = 0;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1862,50 +1855,49 @@
 
   NS_NAMED_LITERAL_CSTRING(compressorName, "compress");
 
-  rv = aConnection->CreateFunction(compressorName, 1, compressor);
+  rv = aConnection.CreateFunction(compressorName, 1, compressor);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
   // Turn off foreign key constraints before we do anything here.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("UPDATE object_data SET data = compress(data);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("UPDATE ai_object_data SET data = compress(data);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->RemoveFunction(compressorName);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(9, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom9_0To10_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.RemoveFunction(compressorName);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(9, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom9_0To10_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom9_0To10_0", DOM);
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE object_data ADD COLUMN file_ids TEXT;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "ALTER TABLE ai_object_data ADD COLUMN file_ids TEXT;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1916,21 +1908,20 @@
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(10, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom10_0To11_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(10, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom10_0To11_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom10_0To11_0", DOM);
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id, "
                          "object_store_id, "
@@ -1943,7 +1934,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO temp_upgrade "
                          "SELECT id, object_store_id, name, key_path, "
                          "unique_index, multientry "
@@ -1952,13 +1943,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_store_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE object_store_index ("
       "id INTEGER PRIMARY KEY, "
       "object_store_id INTEGER NOT NULL, "
@@ -1974,7 +1965,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO object_store_index "
                          "SELECT id, object_store_id, name, key_path, "
                          "unique_index, multientry "
@@ -1983,19 +1974,19 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TRIGGER object_data_insert_trigger;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO object_data (object_store_id, key_value, data, file_ids) "
       "SELECT object_store_id, id, data, file_ids "
       "FROM ai_object_data;"));
@@ -2003,7 +1994,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_insert_trigger "
                          "AFTER INSERT ON object_data "
                          "FOR EACH ROW "
@@ -2015,7 +2006,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO index_data (index_id, value, object_data_key, "
       "object_data_id) "
       "SELECT ai_index_data.index_id, ai_index_data.value, "
@@ -2030,7 +2021,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO unique_index_data (index_id, value, object_data_key, "
       "object_data_id) "
       "SELECT ai_unique_index_data.index_id, ai_unique_index_data.value, "
@@ -2045,7 +2036,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "UPDATE object_store "
       "SET auto_increment = (SELECT max(id) FROM ai_object_data) + 1 "
       "WHERE auto_increment;"));
@@ -2053,25 +2044,25 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_unique_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE ai_object_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(11, 0));
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(11, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -2142,9 +2133,8 @@
   }
 };
 
-nsresult UpgradeSchemaFrom11_0To12_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult UpgradeSchemaFrom11_0To12_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom11_0To12_0", DOM);
 
@@ -2152,12 +2142,12 @@
 
   nsCOMPtr<mozIStorageFunction> encoder = new EncodeKeysFunction();
 
-  nsresult rv = aConnection->CreateFunction(encoderName, 1, encoder);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.CreateFunction(encoderName, 1, encoder);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "id INTEGER PRIMARY KEY, "
                          "object_store_id, "
@@ -2169,7 +2159,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO temp_upgrade "
       "SELECT id, object_store_id, encode(key_value), data, file_ids "
       "FROM object_data;"));
@@ -2177,13 +2167,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE object_data ("
       "id INTEGER PRIMARY KEY, "
       "object_store_id INTEGER NOT NULL, "
@@ -2198,7 +2188,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO object_data "
       "SELECT id, object_store_id, key_value, file_ids, data "
       "FROM temp_upgrade;"));
@@ -2206,13 +2196,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_insert_trigger "
                          "AFTER INSERT ON object_data "
                          "FOR EACH ROW "
@@ -2224,7 +2214,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TRIGGER object_data_update_trigger "
       "AFTER UPDATE OF file_ids ON object_data "
       "FOR EACH ROW "
@@ -2236,7 +2226,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_delete_trigger "
                          "AFTER DELETE ON object_data "
                          "FOR EACH ROW WHEN OLD.file_ids IS NOT NULL "
@@ -2247,7 +2237,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -2258,7 +2248,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO temp_upgrade "
       "SELECT index_id, encode(value), encode(object_data_key), object_data_id "
       "FROM index_data;"));
@@ -2266,13 +2256,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE index_data ("
       "index_id INTEGER NOT NULL, "
       "value BLOB NOT NULL, "
@@ -2288,7 +2278,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO index_data "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM temp_upgrade;"));
@@ -2296,20 +2286,20 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE INDEX index_data_object_data_id_index "
                          "ON index_data (object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TEMPORARY TABLE temp_upgrade ("
                          "index_id, "
                          "value, "
@@ -2320,7 +2310,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO temp_upgrade "
       "SELECT index_id, encode(value), encode(object_data_key), object_data_id "
       "FROM unique_index_data;"));
@@ -2328,13 +2318,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE unique_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TABLE unique_index_data ("
       "index_id INTEGER NOT NULL, "
       "value BLOB NOT NULL, "
@@ -2351,7 +2341,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "INSERT INTO unique_index_data "
       "SELECT index_id, value, object_data_key, object_data_id "
       "FROM temp_upgrade;"));
@@ -2359,36 +2349,35 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE temp_upgrade;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE INDEX unique_index_data_object_data_id_index "
                          "ON unique_index_data (object_data_id);"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->RemoveFunction(encoderName);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(12, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom12_0To13_0(mozIStorageConnection* aConnection,
+  rv = aConnection.RemoveFunction(encoderName);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(12, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom12_0To13_0(mozIStorageConnection& aConnection,
                                      bool* aVacuumNeeded) {
   AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom12_0To13_0", DOM);
 
@@ -2396,7 +2385,7 @@
 
 #ifdef IDB_MOBILE
   int32_t defaultPageSize;
-  rv = aConnection->GetDefaultPageSize(&defaultPageSize);
+  rv = aConnection.GetDefaultPageSize(&defaultPageSize);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -2405,7 +2394,7 @@
   nsAutoCString upgradeQuery("PRAGMA auto_vacuum = FULL; PRAGMA page_size = ");
   upgradeQuery.AppendInt(defaultPageSize);
 
-  rv = aConnection->ExecuteSimpleSQL(upgradeQuery);
+  rv = aConnection.ExecuteSimpleSQL(upgradeQuery);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -2413,54 +2402,53 @@
   *aVacuumNeeded = true;
 #endif
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(13, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom13_0To14_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(13, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom13_0To14_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   // The only change between 13 and 14 was a different structured
   // clone format, but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(14, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom14_0To15_0(mozIStorageConnection* aConnection) {
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(14, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom14_0To15_0(mozIStorageConnection& aConnection) {
   // The only change between 14 and 15 was a different structured
   // clone format, but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(15, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom15_0To16_0(mozIStorageConnection* aConnection) {
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(15, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom15_0To16_0(mozIStorageConnection& aConnection) {
   // The only change between 15 and 16 was a different structured
   // clone format, but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(16, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom16_0To17_0(mozIStorageConnection* aConnection) {
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(16, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom16_0To17_0(mozIStorageConnection& aConnection) {
   // The only change between 16 and 17 was a different structured
   // clone format, but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(17, 0));
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(17, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -2473,11 +2461,11 @@
   class UpgradeKeyFunction;
 
  public:
-  static nsresult DoUpgrade(mozIStorageConnection* aConnection,
+  static nsresult DoUpgrade(mozIStorageConnection& aConnection,
                             const nsACString& aOrigin);
 
  private:
-  static nsresult DoUpgradeInternal(mozIStorageConnection* aConnection,
+  static nsresult DoUpgradeInternal(mozIStorageConnection& aConnection,
                                     const nsACString& aOrigin);
 
   UpgradeSchemaFrom17_0To18_0Helper() = delete;
@@ -2793,8 +2781,7 @@
 
 // static
 nsresult UpgradeSchemaFrom17_0To18_0Helper::DoUpgrade(
-    mozIStorageConnection* aConnection, const nsACString& aOrigin) {
-  MOZ_ASSERT(aConnection);
+    mozIStorageConnection& aConnection, const nsACString& aOrigin) {
   MOZ_ASSERT(!aOrigin.IsEmpty());
 
   // Register the |upgrade_key| function.
@@ -2803,7 +2790,7 @@
   NS_NAMED_LITERAL_CSTRING(upgradeKeyFunctionName, "upgrade_key");
 
   nsresult rv =
-      aConnection->CreateFunction(upgradeKeyFunctionName, 1, updateFunction);
+      aConnection.CreateFunction(upgradeKeyFunctionName, 1, updateFunction);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -2814,16 +2801,16 @@
 
   NS_NAMED_LITERAL_CSTRING(insertIDVFunctionName, "insert_idv");
 
-  rv = aConnection->CreateFunction(insertIDVFunctionName, 4, insertIDVFunction);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    MOZ_ALWAYS_SUCCEEDS(aConnection->RemoveFunction(upgradeKeyFunctionName));
+  rv = aConnection.CreateFunction(insertIDVFunctionName, 4, insertIDVFunction);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    MOZ_ALWAYS_SUCCEEDS(aConnection.RemoveFunction(upgradeKeyFunctionName));
     return rv;
   }
 
   rv = DoUpgradeInternal(aConnection, aOrigin);
 
-  MOZ_ALWAYS_SUCCEEDS(aConnection->RemoveFunction(upgradeKeyFunctionName));
-  MOZ_ALWAYS_SUCCEEDS(aConnection->RemoveFunction(insertIDVFunctionName));
+  MOZ_ALWAYS_SUCCEEDS(aConnection.RemoveFunction(upgradeKeyFunctionName));
+  MOZ_ALWAYS_SUCCEEDS(aConnection.RemoveFunction(insertIDVFunctionName));
 
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -2834,11 +2821,10 @@
 
 // static
 nsresult UpgradeSchemaFrom17_0To18_0Helper::DoUpgradeInternal(
-    mozIStorageConnection* aConnection, const nsACString& aOrigin) {
-  MOZ_ASSERT(aConnection);
+    mozIStorageConnection& aConnection, const nsACString& aOrigin) {
   MOZ_ASSERT(!aOrigin.IsEmpty());
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  nsresult rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Drop these triggers to avoid unnecessary work during the upgrade
       // process.
       "DROP TRIGGER object_data_insert_trigger;"
@@ -2848,7 +2834,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Drop these indexes before we do anything else to free disk space.
       "DROP INDEX index_data_object_data_id_index;"
       "DROP INDEX unique_index_data_object_data_id_index;"));
@@ -2858,7 +2844,7 @@
 
   // Create the new tables and triggers first.
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |database| table.
       "CREATE TABLE database_upgrade "
       "( name TEXT PRIMARY KEY"
@@ -2872,7 +2858,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |object_store| table.
       "CREATE TABLE object_store_upgrade"
       "( id INTEGER PRIMARY KEY"
@@ -2884,7 +2870,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |object_store_index| table.
       "CREATE TABLE object_store_index_upgrade"
       "( id INTEGER PRIMARY KEY"
@@ -2900,7 +2886,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |object_data| table.
       "CREATE TABLE object_data_upgrade"
       "( object_store_id INTEGER NOT NULL"
@@ -2916,7 +2902,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |index_data| table.
       "CREATE TABLE index_data_upgrade"
       "( index_id INTEGER NOT NULL"
@@ -2933,7 +2919,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // This will eventually become the |unique_index_data| table.
       "CREATE TABLE unique_index_data_upgrade"
       "( index_id INTEGER NOT NULL"
@@ -2950,7 +2936,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Temporarily store |index_data_values| that we build during the upgrade
       // of the index tables. We will later move this to the |object_data|
       // table.
@@ -2964,7 +2950,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // These two triggers help build the |index_data_values| blobs. The nested
       // SELECT statements help us achieve an "INSERT OR UPDATE"-like behavior.
       "CREATE TEMPORARY TRIGGER unique_index_data_upgrade_insert_trigger "
@@ -2989,7 +2975,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TEMPORARY TRIGGER index_data_upgrade_insert_trigger "
       "AFTER INSERT ON index_data_upgrade "
       "BEGIN "
@@ -3015,7 +3001,7 @@
 
   // Update the |unique_index_data| table to change the column order, remove the
   // ON DELETE CASCADE clauses, and to apply the WITHOUT ROWID optimization.
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Insert all the data.
       "INSERT INTO unique_index_data_upgrade "
       "SELECT "
@@ -3030,21 +3016,21 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The trigger is no longer needed.
       "DROP TRIGGER unique_index_data_upgrade_insert_trigger;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The old table is no longer needed.
       "DROP TABLE unique_index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Rename the table.
       "ALTER TABLE unique_index_data_upgrade "
       "RENAME TO unique_index_data;"));
@@ -3054,7 +3040,7 @@
 
   // Update the |index_data| table to change the column order, remove the ON
   // DELETE CASCADE clauses, and to apply the WITHOUT ROWID optimization.
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Insert all the data.
       "INSERT INTO index_data_upgrade "
       "SELECT "
@@ -3069,21 +3055,21 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The trigger is no longer needed.
       "DROP TRIGGER index_data_upgrade_insert_trigger;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The old table is no longer needed.
       "DROP TABLE index_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Rename the table.
       "ALTER TABLE index_data_upgrade "
       "RENAME TO index_data;"));
@@ -3094,7 +3080,7 @@
   // Update the |object_data| table to add the |index_data_values| column,
   // remove the ON DELETE CASCADE clause, and apply the WITHOUT ROWID
   // optimization.
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Insert all the data.
       "INSERT INTO object_data_upgrade "
       "SELECT "
@@ -3113,21 +3099,21 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The temporary table is no longer needed.
       "DROP TABLE temp_index_data_values;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // The old table is no longer needed.
       "DROP TABLE object_data;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       // Rename the table.
       "ALTER TABLE object_data_upgrade "
       "RENAME TO object_data;"));
@@ -3137,7 +3123,7 @@
 
   // Update the |object_store_index| table to remove the UNIQUE constraint and
   // the ON DELETE CASCADE clause.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO object_store_index_upgrade "
                          "SELECT * "
                          "FROM object_store_index;"));
@@ -3145,13 +3131,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_store_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE object_store_index_upgrade "
                          "RENAME TO object_store_index;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -3159,7 +3145,7 @@
   }
 
   // Update the |object_store| table to remove the UNIQUE constraint.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("INSERT INTO object_store_upgrade "
                          "SELECT * "
                          "FROM object_store;"));
@@ -3167,13 +3153,13 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TABLE object_store;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE object_store_upgrade "
                          "RENAME TO object_store;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -3186,7 +3172,7 @@
 
   // The parameter names are not used, parameters are bound by index only
   // locally in the same function.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("INSERT INTO database_upgrade "
                          "SELECT name, :origin, version, 0, 0, 0 "
                          "FROM database;"),
@@ -3205,13 +3191,12 @@
     return rv;
   }
 
-  rv =
-      aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING("DROP TABLE database;"));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING("DROP TABLE database;"));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE database_upgrade "
                          "RENAME TO database;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -3223,9 +3208,9 @@
     // Make sure there's only one entry in the |database| table.
     nsCOMPtr<mozIStorageStatement> stmt;
     MOZ_ASSERT(NS_SUCCEEDED(
-        aConnection->CreateStatement(NS_LITERAL_CSTRING("SELECT COUNT(*) "
-                                                        "FROM database;"),
-                                     getter_AddRefs(stmt))));
+        aConnection.CreateStatement(NS_LITERAL_CSTRING("SELECT COUNT(*) "
+                                                       "FROM database;"),
+                                    getter_AddRefs(stmt))));
 
     bool hasResult;
     MOZ_ASSERT(NS_SUCCEEDED(stmt->ExecuteStep(&hasResult)));
@@ -3238,7 +3223,7 @@
 #endif
 
   // Recreate file table triggers.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_insert_trigger "
                          "AFTER INSERT ON object_data "
                          "WHEN NEW.file_ids IS NOT NULL "
@@ -3249,7 +3234,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TRIGGER object_data_update_trigger "
       "AFTER UPDATE OF file_ids ON object_data "
       "WHEN OLD.file_ids IS NOT NULL OR NEW.file_ids IS NOT NULL "
@@ -3260,7 +3245,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("CREATE TRIGGER object_data_delete_trigger "
                          "AFTER DELETE ON object_data "
                          "WHEN OLD.file_ids IS NOT NULL "
@@ -3274,7 +3259,7 @@
   // Finally, turn on auto_vacuum mode. We use full auto_vacuum mode to reclaim
   // disk space on mobile devices (at the cost of some COMMIT speed), and
   // incremental auto_vacuum mode on desktop builds.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
 #ifdef IDB_MOBILE
       NS_LITERAL_CSTRING("PRAGMA auto_vacuum = FULL;")
 #else
@@ -3285,17 +3270,16 @@
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(18, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom17_0To18_0(mozIStorageConnection* aConnection,
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(18, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom17_0To18_0(mozIStorageConnection& aConnection,
                                      const nsACString& aOrigin) {
-  MOZ_ASSERT(aConnection);
   MOZ_ASSERT(!aOrigin.IsEmpty());
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom17_0To18_0", DOM);
@@ -3303,42 +3287,41 @@
   return UpgradeSchemaFrom17_0To18_0Helper::DoUpgrade(aConnection, aOrigin);
 }
 
-nsresult UpgradeSchemaFrom18_0To19_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult UpgradeSchemaFrom18_0To19_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   nsresult rv;
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom18_0To19_0", DOM);
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE object_store_index "
                          "ADD COLUMN locale TEXT;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE object_store_index "
                          "ADD COLUMN is_auto_locale BOOLEAN;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE index_data "
                          "ADD COLUMN value_locale BLOB;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("ALTER TABLE unique_index_data "
                          "ADD COLUMN value_locale BLOB;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE INDEX index_data_value_locale_index "
       "ON index_data (index_id, value_locale, object_data_key, value) "
       "WHERE value_locale IS NOT NULL;"));
@@ -3346,7 +3329,7 @@
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE INDEX unique_index_data_value_locale_index "
       "ON unique_index_data (index_id, value_locale, object_data_key, value) "
       "WHERE value_locale IS NOT NULL;"));
@@ -3354,7 +3337,7 @@
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(19, 0));
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(19, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3368,7 +3351,7 @@
  public:
   UpgradeFileIdsFunction() { AssertIsOnIOThread(); }
 
-  nsresult Init(nsIFile* aFMDirectory, mozIStorageConnection* aConnection);
+  nsresult Init(nsIFile* aFMDirectory, mozIStorageConnection& aConnection);
 
   NS_DECL_ISUPPORTS
 
@@ -3387,14 +3370,13 @@
 };
 
 nsresult UpgradeSchemaFrom19_0To20_0(nsIFile* aFMDirectory,
-                                     mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+                                     mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom19_0To20_0", DOM);
 
   nsCOMPtr<mozIStorageStatement> stmt;
-  nsresult rv = aConnection->CreateStatement(
+  nsresult rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT count(*) "
                          "FROM object_data "
                          "WHERE file_ids IS NOT NULL"),
@@ -3428,7 +3410,7 @@
 
   if (count == 0) {
     // Nothing to upgrade.
-    rv = aConnection->SetSchemaVersion(MakeSchemaVersion(20, 0));
+    rv = aConnection.SetSchemaVersion(MakeSchemaVersion(20, 0));
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
@@ -3445,19 +3427,19 @@
 
   NS_NAMED_LITERAL_CSTRING(functionName, "upgrade");
 
-  rv = aConnection->CreateFunction(functionName, 2, function);
+  rv = aConnection.CreateFunction(functionName, 2, function);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
   // Disable update trigger.
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("DROP TRIGGER object_data_update_trigger;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
-  rv = aConnection->ExecuteSimpleSQL(
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("UPDATE object_data "
                          "SET file_ids = upgrade(file_ids, data) "
                          "WHERE file_ids IS NOT NULL;"));
@@ -3466,7 +3448,7 @@
   }
 
   // Enable update trigger.
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE TRIGGER object_data_update_trigger "
       "AFTER UPDATE OF file_ids ON object_data "
       "FOR EACH ROW "
@@ -3478,12 +3460,12 @@
     return rv;
   }
 
-  rv = aConnection->RemoveFunction(functionName);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(20, 0));
+  rv = aConnection.RemoveFunction(functionName);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(20, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3642,13 +3624,12 @@
   return NS_OK;
 }
 
-nsresult UpgradeSchemaFrom20_0To21_0(mozIStorageConnection* aConnection) {
+nsresult UpgradeSchemaFrom20_0To21_0(mozIStorageConnection& aConnection) {
   // This should have been part of the 18 to 19 upgrade, where we changed the
   // layout of the index_data_values blobs but didn't upgrade the existing data.
   // See bug 1202788.
 
   AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom20_0To21_0", DOM);
 
@@ -3657,12 +3638,12 @@
 
   NS_NAMED_LITERAL_CSTRING(functionName, "upgrade_idv");
 
-  nsresult rv = aConnection->CreateFunction(functionName, 1, function);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  nsresult rv = aConnection.CreateFunction(functionName, 1, function);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "UPDATE object_data "
       "SET index_data_values = upgrade_idv(index_data_values) "
       "WHERE index_data_values IS NOT NULL;"));
@@ -3670,34 +3651,34 @@
     return rv;
   }
 
-  rv = aConnection->RemoveFunction(functionName);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(21, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom21_0To22_0(mozIStorageConnection* aConnection) {
+  rv = aConnection.RemoveFunction(functionName);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(21, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom21_0To22_0(mozIStorageConnection& aConnection) {
   // The only change between 21 and 22 was a different structured clone format,
   // but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(22, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom22_0To23_0(mozIStorageConnection* aConnection,
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(22, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom22_0To23_0(mozIStorageConnection& aConnection,
                                      const nsACString& aOrigin) {
   AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+
   MOZ_ASSERT(!aOrigin.IsEmpty());
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom22_0To23_0", DOM);
@@ -3706,9 +3687,9 @@
   // The parameter names are not used, parameters are bound by index only
   // locally in the same function.
   nsresult rv =
-      aConnection->CreateStatement(NS_LITERAL_CSTRING("UPDATE database "
-                                                      "SET origin = :origin;"),
-                                   getter_AddRefs(stmt));
+      aConnection.CreateStatement(NS_LITERAL_CSTRING("UPDATE database "
+                                                     "SET origin = :origin;"),
+                                  getter_AddRefs(stmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3723,30 +3704,30 @@
     return rv;
   }
 
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(23, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom23_0To24_0(mozIStorageConnection* aConnection) {
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(23, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom23_0To24_0(mozIStorageConnection& aConnection) {
   // The only change between 23 and 24 was a different structured clone format,
   // but it's backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(24, 0));
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  return NS_OK;
-}
-
-nsresult UpgradeSchemaFrom24_0To25_0(mozIStorageConnection* aConnection) {
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(24, 0));
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  return NS_OK;
+}
+
+nsresult UpgradeSchemaFrom24_0To25_0(mozIStorageConnection& aConnection) {
   // The changes between 24 and 25 were an upgraded snappy library, a different
   // structured clone format and a different file_ds format. But everything is
   // backwards-compatible.
-  nsresult rv = aConnection->SetSchemaVersion(MakeSchemaVersion(25, 0));
+  nsresult rv = aConnection.SetSchemaVersion(MakeSchemaVersion(25, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3809,9 +3790,8 @@
   }
 };
 
-nsresult UpgradeSchemaFrom25_0To26_0(mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+nsresult UpgradeSchemaFrom25_0To26_0(mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
 
   AUTO_PROFILER_LABEL("UpgradeSchemaFrom25_0To26_0", DOM);
 
@@ -3820,14 +3800,14 @@
   nsCOMPtr<mozIStorageFunction> stripObsoleteAttributes =
       new StripObsoleteOriginAttributesFunction();
 
-  nsresult rv = aConnection->CreateFunction(functionName,
-                                            /* aNumArguments */ 1,
-                                            stripObsoleteAttributes);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.CreateFunction(functionName,
+                                           /* aNumArguments */ 1,
+                                           stripObsoleteAttributes);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("UPDATE DATABASE "
                          "SET origin = strip_obsolete_attributes(origin) "
                          "WHERE origin LIKE '%^%';"));
@@ -3835,12 +3815,12 @@
     return rv;
   }
 
-  rv = aConnection->RemoveFunction(functionName);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return rv;
-  }
-
-  rv = aConnection->SetSchemaVersion(MakeSchemaVersion(26, 0));
+  rv = aConnection.RemoveFunction(functionName);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return rv;
+  }
+
+  rv = aConnection.SetSchemaVersion(MakeSchemaVersion(26, 0));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3902,9 +3882,8 @@
   return result;
 }
 
-nsresult SetDefaultPragmas(mozIStorageConnection* aConnection) {
+nsresult SetDefaultPragmas(mozIStorageConnection& aConnection) {
   MOZ_ASSERT(!NS_IsMainThread());
-  MOZ_ASSERT(aConnection);
 
   static constexpr auto kBuiltInPragmas = NS_LITERAL_CSTRING(
       // We use foreign keys in DEBUG builds only because there is a performance
@@ -3928,7 +3907,7 @@
       // overwriting the WAL with 0 during active periods.
       "PRAGMA secure_delete = OFF;");
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(kBuiltInPragmas);
+  nsresult rv = aConnection.ExecuteSimpleSQL(kBuiltInPragmas);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3943,7 +3922,7 @@
   }
   pragmaStmt.Append(';');
 
-  rv = aConnection->ExecuteSimpleSQL(pragmaStmt);
+  rv = aConnection.ExecuteSimpleSQL(pragmaStmt);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -3952,8 +3931,7 @@
   if (kSQLiteGrowthIncrement) {
     // This is just an optimization so ignore the failure if the disk is
     // currently too full.
-    rv =
-        aConnection->SetGrowthIncrement(kSQLiteGrowthIncrement, EmptyCString());
+    rv = aConnection.SetGrowthIncrement(kSQLiteGrowthIncrement, EmptyCString());
     if (rv != NS_ERROR_FILE_TOO_BIG && NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
@@ -3963,9 +3941,8 @@
   return NS_OK;
 }
 
-nsresult SetJournalMode(mozIStorageConnection* aConnection) {
+nsresult SetJournalMode(mozIStorageConnection& aConnection) {
   MOZ_ASSERT(!NS_IsMainThread());
-  MOZ_ASSERT(aConnection);
 
   // Try enabling WAL mode. This can fail in various circumstances so we have to
   // check the results here.
@@ -3973,7 +3950,7 @@
   NS_NAMED_LITERAL_CSTRING(journalModeWAL, "wal");
 
   nsCOMPtr<mozIStorageStatement> stmt;
-  nsresult rv = aConnection->CreateStatement(
+  nsresult rv = aConnection.CreateStatement(
       journalModeQueryStart + journalModeWAL, getter_AddRefs(stmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -3999,7 +3976,7 @@
       nsAutoCString pageCount;
       pageCount.AppendInt(kMaxWALPages);
 
-      rv = aConnection->ExecuteSimpleSQL(
+      rv = aConnection.ExecuteSimpleSQL(
           NS_LITERAL_CSTRING("PRAGMA wal_autocheckpoint = ") + pageCount);
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
@@ -4008,8 +3985,8 @@
   } else {
     NS_WARNING("Failed to set WAL mode, falling back to normal journal mode.");
 #ifdef IDB_MOBILE
-    rv = aConnection->ExecuteSimpleSQL(journalModeQueryStart +
-                                       NS_LITERAL_CSTRING("truncate"));
+    rv = aConnection.ExecuteSimpleSQL(journalModeQueryStart +
+                                      NS_LITERAL_CSTRING("truncate"));
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
@@ -4020,8 +3997,9 @@
 }
 
 template <typename V>
-auto ValOrErr(V&& aVal, const nsresult aRv) {
-  return NS_SUCCEEDED(aRv) ? aVal : Result<V, nsresult>{Err(aRv)};
+auto ValOrErr(V aVal, const nsresult aRv) {
+  return NS_SUCCEEDED(aRv) ? WrapMovingNotNull(std::move(aVal))
+                           : Result<MovingNotNull<V>, nsresult>{Err(aRv)};
 }
 
 template <class FileOrURLType>
@@ -4029,7 +4007,7 @@
 
 template <>
 struct StorageOpenTraits<nsIFileURL> {
-  static Result<nsCOMPtr<mozIStorageConnection>, nsresult> Open(
+  static Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult> Open(
       mozIStorageService& aStorageService, nsIFileURL& aFileURL) {
     nsCOMPtr<mozIStorageConnection> connection;
     nsresult rv = aStorageService.OpenDatabaseWithFileURL(
@@ -4046,7 +4024,7 @@
 
 template <>
 struct StorageOpenTraits<nsIFile> {
-  static Result<nsCOMPtr<mozIStorageConnection>, nsresult> Open(
+  static Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult> Open(
       mozIStorageService& aStorageService, nsIFile& aFile) {
     nsCOMPtr<mozIStorageConnection> connection;
     nsresult rv = aStorageService.OpenUnsharedDatabase(
@@ -4065,8 +4043,9 @@
 };
 
 template <class FileOrURLType>
-Result<nsCOMPtr<mozIStorageConnection>, nsresult> OpenDatabaseAndHandleBusy(
-    mozIStorageService& aStorageService, FileOrURLType& aFileOrURL) {
+Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult>
+OpenDatabaseAndHandleBusy(mozIStorageService& aStorageService,
+                          FileOrURLType& aFileOrURL) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
 
@@ -4113,10 +4092,11 @@
   return connectionOrErr;
 }
 
-Result<nsCOMPtr<mozIStorageConnection>, nsresult> CreateStorageConnection(
-    nsIFile& aDBFile, nsIFile& aFMDirectory, const nsAString& aName,
-    const nsACString& aOrigin, const int64_t aDirectoryLockId,
-    const uint32_t aTelemetryId) {
+Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult>
+CreateStorageConnection(nsIFile& aDBFile, nsIFile& aFMDirectory,
+                        const nsAString& aName, const nsACString& aOrigin,
+                        const int64_t aDirectoryLockId,
+                        const uint32_t aTelemetryId) {
   AssertIsOnIOThread();
   MOZ_ASSERT(aDirectoryLockId >= -1);
 
@@ -4185,9 +4165,9 @@
     }
   }
 
-  auto connection = connectionOrErr.unwrap();
-
-  rv = SetDefaultPragmas(connection);
+  auto connection = connectionOrErr.unwrap().unwrapBasePtr();
+
+  rv = SetDefaultPragmas(*connection);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return Err(rv);
   }
@@ -4250,7 +4230,7 @@
         return Err(rv);
       }
 
-      rv = SetJournalMode(connection);
+      rv = SetJournalMode(*connection);
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return Err(rv);
       }
@@ -4268,10 +4248,10 @@
     bool vacuumNeeded = false;
 
     mozStorageTransaction transaction(
-        connection, false, mozIStorageConnection::TRANSACTION_IMMEDIATE);
+        connection.get(), false, mozIStorageConnection::TRANSACTION_IMMEDIATE);
 
     if (newDatabase) {
-      rv = CreateTables(connection);
+      rv = CreateTables(*connection);
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return Err(rv);
       }
@@ -4312,72 +4292,72 @@
       while (schemaVersion != kSQLiteSchemaVersion) {
         switch (schemaVersion) {
           case 4:
-            rv = UpgradeSchemaFrom4To5(connection);
+            rv = UpgradeSchemaFrom4To5(*connection);
             break;
           case 5:
-            rv = UpgradeSchemaFrom5To6(connection);
+            rv = UpgradeSchemaFrom5To6(*connection);
             break;
           case 6:
-            rv = UpgradeSchemaFrom6To7(connection);
+            rv = UpgradeSchemaFrom6To7(*connection);
             break;
           case 7:
-            rv = UpgradeSchemaFrom7To8(connection);
+            rv = UpgradeSchemaFrom7To8(*connection);
             break;
           case 8:
-            rv = UpgradeSchemaFrom8To9_0(connection);
+            rv = UpgradeSchemaFrom8To9_0(*connection);
             vacuumNeeded = true;
             break;
           case MakeSchemaVersion(9, 0):
-            rv = UpgradeSchemaFrom9_0To10_0(connection);
+            rv = UpgradeSchemaFrom9_0To10_0(*connection);
             break;
           case MakeSchemaVersion(10, 0):
-            rv = UpgradeSchemaFrom10_0To11_0(connection);
+            rv = UpgradeSchemaFrom10_0To11_0(*connection);
             break;
           case MakeSchemaVersion(11, 0):
-            rv = UpgradeSchemaFrom11_0To12_0(connection);
+            rv = UpgradeSchemaFrom11_0To12_0(*connection);
             break;
           case MakeSchemaVersion(12, 0):
-            rv = UpgradeSchemaFrom12_0To13_0(connection, &vacuumNeeded);
+            rv = UpgradeSchemaFrom12_0To13_0(*connection, &vacuumNeeded);
             break;
           case MakeSchemaVersion(13, 0):
-            rv = UpgradeSchemaFrom13_0To14_0(connection);
+            rv = UpgradeSchemaFrom13_0To14_0(*connection);
             break;
           case MakeSchemaVersion(14, 0):
-            rv = UpgradeSchemaFrom14_0To15_0(connection);
+            rv = UpgradeSchemaFrom14_0To15_0(*connection);
             break;
           case MakeSchemaVersion(15, 0):
-            rv = UpgradeSchemaFrom15_0To16_0(connection);
+            rv = UpgradeSchemaFrom15_0To16_0(*connection);
             break;
           case MakeSchemaVersion(16, 0):
-            rv = UpgradeSchemaFrom16_0To17_0(connection);
+            rv = UpgradeSchemaFrom16_0To17_0(*connection);
             break;
           case MakeSchemaVersion(17, 0):
-            rv = UpgradeSchemaFrom17_0To18_0(connection, aOrigin);
+            rv = UpgradeSchemaFrom17_0To18_0(*connection, aOrigin);
             vacuumNeeded = true;
             break;
           case MakeSchemaVersion(18, 0):
-            rv = UpgradeSchemaFrom18_0To19_0(connection);
+            rv = UpgradeSchemaFrom18_0To19_0(*connection);
             break;
           case MakeSchemaVersion(19, 0):
-            rv = UpgradeSchemaFrom19_0To20_0(&aFMDirectory, connection);
+            rv = UpgradeSchemaFrom19_0To20_0(&aFMDirectory, *connection);
             break;
           case MakeSchemaVersion(20, 0):
-            rv = UpgradeSchemaFrom20_0To21_0(connection);
+            rv = UpgradeSchemaFrom20_0To21_0(*connection);
             break;
           case MakeSchemaVersion(21, 0):
-            rv = UpgradeSchemaFrom21_0To22_0(connection);
+            rv = UpgradeSchemaFrom21_0To22_0(*connection);
             break;
           case MakeSchemaVersion(22, 0):
-            rv = UpgradeSchemaFrom22_0To23_0(connection, aOrigin);
+            rv = UpgradeSchemaFrom22_0To23_0(*connection, aOrigin);
             break;
           case MakeSchemaVersion(23, 0):
-            rv = UpgradeSchemaFrom23_0To24_0(connection);
+            rv = UpgradeSchemaFrom23_0To24_0(*connection);
             break;
           case MakeSchemaVersion(24, 0):
-            rv = UpgradeSchemaFrom24_0To25_0(connection);
+            rv = UpgradeSchemaFrom24_0To25_0(*connection);
             break;
           case MakeSchemaVersion(25, 0):
-            rv = UpgradeSchemaFrom25_0To26_0(connection);
+            rv = UpgradeSchemaFrom25_0To26_0(*connection);
             break;
           default:
             IDB_WARNING(
@@ -4554,13 +4534,13 @@
   }
 
   if (!journalModeSet) {
-    rv = SetJournalMode(connection);
+    rv = SetJournalMode(*connection);
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return Err(rv);
     }
   }
 
-  return connection;
+  return WrapMovingNotNullUnchecked(std::move(connection));
 }
 
 nsCOMPtr<nsIFile> GetFileForPath(const nsAString& aPath) {
@@ -4574,9 +4554,9 @@
   return fileOrErr.unwrap();
 }
 
-Result<nsCOMPtr<mozIStorageConnection>, nsresult> GetStorageConnection(
-    nsIFile& aDatabaseFile, const int64_t aDirectoryLockId,
-    const uint32_t aTelemetryId) {
+Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult>
+GetStorageConnection(nsIFile& aDatabaseFile, const int64_t aDirectoryLockId,
+                     const uint32_t aTelemetryId) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
   MOZ_ASSERT(aDirectoryLockId >= 0);
@@ -4612,24 +4592,25 @@
     return Err(connectionOrErr.unwrapErr());
   }
 
-  auto connection = connectionOrErr.unwrap();
-
-  rv = SetDefaultPragmas(connection);
+  auto connection = connectionOrErr.unwrap().unwrapBasePtr();
+
+  rv = SetDefaultPragmas(*connection);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    return Err(rv);
+  }
+
+  rv = SetJournalMode(*connection);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return Err(rv);
   }
 
-  rv = SetJournalMode(connection);
-  if (NS_WARN_IF(NS_FAILED(rv))) {
-    return Err(rv);
-  }
-
-  return connection;
-}
-
-Result<nsCOMPtr<mozIStorageConnection>, nsresult> GetStorageConnection(
-    const nsAString& aDatabaseFilePath, const int64_t aDirectoryLockId,
-    const uint32_t aTelemetryId) {
+  return WrapMovingNotNullUnchecked(std::move(connection));
+}
+
+Result<MovingNotNull<nsCOMPtr<mozIStorageConnection>>, nsresult>
+GetStorageConnection(const nsAString& aDatabaseFilePath,
+                     const int64_t aDirectoryLockId,
+                     const uint32_t aTelemetryId) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
   MOZ_ASSERT(!aDatabaseFilePath.IsEmpty());
@@ -4739,8 +4720,9 @@
   void EnableQuotaChecks();
 
  private:
-  DatabaseConnection(nsCOMPtr<mozIStorageConnection> aStorageConnection,
-                     SafeRefPtr<FileManager> aFileManager);
+  DatabaseConnection(
+      MovingNotNull<nsCOMPtr<mozIStorageConnection>> aStorageConnection,
+      MovingNotNull<SafeRefPtr<FileManager>> aFileManager);
 
   ~DatabaseConnection();
 
@@ -5913,9 +5895,8 @@
 
   FileManager& GetFileManager() const { return *mFileManager; }
 
-  SafeRefPtr<FileManager> GetFileManagerPtr() const {
-    MOZ_ASSERT(mFileManager);
-    return mFileManager.clonePtr();
+  MovingNotNull<SafeRefPtr<FileManager>> GetFileManagerPtr() const {
+    return WrapMovingNotNull(mFileManager.clonePtr());
   }
 
   const FullDatabaseMetadata& Metadata() const {
@@ -6954,7 +6935,7 @@
  private:
   ~OpenDatabaseOp() override { MOZ_ASSERT(!mVersionChangeOp); }
 
-  nsresult LoadDatabaseInformation(mozIStorageConnection* aConnection);
+  nsresult LoadDatabaseInformation(mozIStorageConnection& aConnection);
 
   nsresult SendUpgradeNeeded();
 
@@ -6990,7 +6971,7 @@
 
   void SendResults() override;
 
-  static nsresult UpdateLocaleAwareIndex(mozIStorageConnection* aConnection,
+  static nsresult UpdateLocaleAwareIndex(mozIStorageConnection& aConnection,
                                          const IndexMetadata& aIndexMetadata,
                                          const nsCString& aLocale);
 };
@@ -8070,7 +8051,6 @@
         mFileManager(mDatabase->GetFileManagerPtr()),
         mBackgroundParent(WrapNotNull(aTransaction->GetBackgroundParent())) {
     MOZ_ASSERT(mDatabase);
-    MOZ_ASSERT(mFileManager);
   }
 
   void ProcessFiles(CursorResponse& aResponse, const FilesArray& aFiles);
@@ -8078,7 +8058,7 @@
   ~ValueCursorBase() { MOZ_ASSERT(!mBackgroundParent); }
 
   const SafeRefPtr<Database> mDatabase;
-  const SafeRefPtr<FileManager> mFileManager;
+  const NotNull<SafeRefPtr<FileManager>> mFileManager;
 
   InitializedOnce<const NotNull<PBackgroundParent*>> mBackgroundParent;
 };
@@ -8964,18 +8944,18 @@
   void PerformMaintenanceOnDatabase();
 
   // Runs on maintenance thread pool as part of PerformMaintenanceOnDatabase.
-  nsresult CheckIntegrity(mozIStorageConnection* aConnection, bool* aOk);
+  nsresult CheckIntegrity(mozIStorageConnection& aConnection, bool* aOk);
 
   // Runs on maintenance thread pool as part of PerformMaintenanceOnDatabase.
-  nsresult DetermineMaintenanceAction(mozIStorageConnection* aConnection,
+  nsresult DetermineMaintenanceAction(mozIStorageConnection& aConnection,
                                       nsIFile* aDatabaseFile,
                                       MaintenanceAction* aMaintenanceAction);
 
   // Runs on maintenance thread pool as part of PerformMaintenanceOnDatabase.
-  void IncrementalVacuum(mozIStorageConnection* aConnection);
+  void IncrementalVacuum(mozIStorageConnection& aConnection);
 
   // Runs on maintenance thread pool as part of PerformMaintenanceOnDatabase.
-  void FullVacuum(mozIStorageConnection* aConnection, nsIFile* aDatabaseFile);
+  void FullVacuum(mozIStorageConnection& aConnection, nsIFile* aDatabaseFile);
 
   // Runs on the PBackground thread. It dispatches a complete callback and
   // unregisters from Maintenance.
@@ -8992,7 +8972,7 @@
 class MOZ_STACK_CLASS DatabaseMaintenance::AutoProgressHandler final
     : public mozIStorageProgressHandler {
   Maintenance* mMaintenance;
-  mozIStorageConnection* mConnection;
+  LazyInitializedOnce<const NotNull<mozIStorageConnection*>> mConnection;
 
   NS_DECL_OWNINGTHREAD
 
@@ -9006,7 +8986,7 @@
  public:
   explicit AutoProgressHandler(Maintenance* aMaintenance)
       : mMaintenance(aMaintenance),
-        mConnection(nullptr)
+        mConnection()
 #ifdef DEBUG
         ,
         mDEBUGRefCnt(0)
@@ -9028,7 +9008,7 @@
     MOZ_ASSERT(!mDEBUGRefCnt);
   }
 
-  nsresult Register(mozIStorageConnection* aConnection);
+  nsresult Register(NotNull<mozIStorageConnection*> aConnection);
 
   // We don't want the mRefCnt member but this class does not "inherit"
   // nsISupports.
@@ -10106,8 +10086,6 @@
 struct ValuePopulateResponseHelper {
   nsresult MaybeGetCloneInfo(mozIStorageStatement* const aStmt,
                              const ValueCursorBase& aCursor) {
-    MOZ_ASSERT(aCursor.mFileManager);
-
     constexpr auto offset = StatementHasIndexKeyBindings ? 2 : 0;
 
     auto cloneInfoOrErr =
@@ -10678,10 +10656,10 @@
  ******************************************************************************/
 
 DatabaseConnection::DatabaseConnection(
-    nsCOMPtr<mozIStorageConnection> aStorageConnection,
-    SafeRefPtr<FileManager> aFileManager)
-    : mStorageConnection(WrapNotNull(std::move(aStorageConnection))),
-      mFileManager(WrapNotNull(std::move(aFileManager))),
+    MovingNotNull<nsCOMPtr<mozIStorageConnection>> aStorageConnection,
+    MovingNotNull<SafeRefPtr<FileManager>> aFileManager)
+    : mStorageConnection(std::move(aStorageConnection)),
+      mFileManager(std::move(aFileManager)),
       mInReadTransaction(false),
       mInWriteTransaction(false)
 #ifdef DEBUG
@@ -10690,7 +10668,6 @@
 #endif
 {
   AssertIsOnConnectionThread();
-  MOZ_ASSERT(mStorageConnection);
   MOZ_ASSERT(mFileManager);
 }
 
@@ -16428,10 +16405,9 @@
       mEnforcingQuota(aEnforcingQuota) {}
 
 nsresult FileManager::Init(nsIFile* aDirectory,
-                           mozIStorageConnection* aConnection) {
+                           mozIStorageConnection& aConnection) {
   AssertIsOnIOThread();
   MOZ_ASSERT(aDirectory);
-  MOZ_ASSERT(aConnection);
 
   bool exists;
   nsresult rv = aDirectory->Exists(&exists);
@@ -16503,9 +16479,9 @@
   }
 
   nsCOMPtr<mozIStorageStatement> stmt;
-  rv = aConnection->CreateStatement(NS_LITERAL_CSTRING("SELECT id, refcount "
-                                                       "FROM file"),
-                                    getter_AddRefs(stmt));
+  rv = aConnection.CreateStatement(NS_LITERAL_CSTRING("SELECT id, refcount "
+                                                      "FROM file"),
+                                   getter_AddRefs(stmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -16722,9 +16698,9 @@
         return connectionOrErr.unwrapErr();
       }
 
-      auto connection = connectionOrErr.unwrap();
-
-      mozStorageTransaction transaction(connection, false);
+      auto connection = connectionOrErr.unwrap().unwrap();
+
+      mozStorageTransaction transaction(connection.get(), false);
 
       rv = connection->ExecuteSimpleSQL(
           NS_LITERAL_CSTRING("CREATE VIRTUAL TABLE fs USING filesystem;"));
@@ -18654,19 +18630,14 @@
   MOZ_ASSERT(!mOrigin.IsEmpty());
 
   class MOZ_STACK_CLASS AutoClose final {
-    nsCOMPtr<mozIStorageConnection> mConnection;
+    NotNull<nsCOMPtr<mozIStorageConnection>> mConnection;
 
    public:
-    explicit AutoClose(mozIStorageConnection* aConnection)
-        : mConnection(aConnection) {
-      MOZ_ASSERT(aConnection);
-    }
-
-    ~AutoClose() {
-      MOZ_ASSERT(mConnection);
-
-      MOZ_ALWAYS_SUCCEEDS(mConnection->Close());
-    }
+    explicit AutoClose(
+        MovingNotNull<nsCOMPtr<mozIStorageConnection>> aConnection)
+        : mConnection(std::move(aConnection)) {}
+
+    ~AutoClose() { MOZ_ALWAYS_SUCCEEDS(mConnection->Close()); }
   };
 
   if (NS_WARN_IF(QuotaClient::IsShuttingDownOnNonBackgroundThread()) ||
@@ -18683,7 +18654,7 @@
     return;
   }
 
-  const auto connection = connectionOrErr.unwrap();
+  const auto connection = connectionOrErr.unwrap().unwrap();
 
   AutoClose autoClose(connection);
 
@@ -18693,7 +18664,7 @@
   }
 
   bool databaseIsOk;
-  nsresult rv = CheckIntegrity(connection, &databaseIsOk);
+  nsresult rv = CheckIntegrity(*connection, &databaseIsOk);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return;
   }
@@ -18706,7 +18677,8 @@
   }
 
   MaintenanceAction maintenanceAction;
-  rv = DetermineMaintenanceAction(connection, databaseFile, &maintenanceAction);
+  rv =
+      DetermineMaintenanceAction(*connection, databaseFile, &maintenanceAction);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return;
   }
@@ -18716,11 +18688,11 @@
       break;
 
     case MaintenanceAction::IncrementalVacuum:
-      IncrementalVacuum(connection);
+      IncrementalVacuum(*connection);
       break;
 
     case MaintenanceAction::FullVacuum:
-      FullVacuum(connection, databaseFile);
+      FullVacuum(*connection, databaseFile);
       break;
 
     default:
@@ -18728,11 +18700,10 @@
   }
 }
 
-nsresult DatabaseMaintenance::CheckIntegrity(mozIStorageConnection* aConnection,
+nsresult DatabaseMaintenance::CheckIntegrity(mozIStorageConnection& aConnection,
                                              bool* aOk) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
   MOZ_ASSERT(aOk);
 
   if (NS_WARN_IF(QuotaClient::IsShuttingDownOnNonBackgroundThread()) ||
@@ -18746,7 +18717,7 @@
   // later operations require zero live statements.
   {
     nsCOMPtr<mozIStorageStatement> stmt;
-    rv = aConnection->CreateStatement(
+    rv = aConnection.CreateStatement(
         NS_LITERAL_CSTRING("PRAGMA integrity_check(1);"), getter_AddRefs(stmt));
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
@@ -18777,7 +18748,7 @@
     int32_t foreignKeysWereEnabled;
     {
       nsCOMPtr<mozIStorageStatement> stmt;
-      rv = aConnection->CreateStatement(
+      rv = aConnection.CreateStatement(
           NS_LITERAL_CSTRING("PRAGMA foreign_keys;"), getter_AddRefs(stmt));
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
@@ -18798,7 +18769,7 @@
     }
 
     if (!foreignKeysWereEnabled) {
-      rv = aConnection->ExecuteSimpleSQL(
+      rv = aConnection.ExecuteSimpleSQL(
           NS_LITERAL_CSTRING("PRAGMA foreign_keys = ON;"));
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
@@ -18808,7 +18779,7 @@
     bool foreignKeyError;
     {
       nsCOMPtr<mozIStorageStatement> stmt;
-      rv = aConnection->CreateStatement(
+      rv = aConnection.CreateStatement(
           NS_LITERAL_CSTRING("PRAGMA foreign_key_check;"),
           getter_AddRefs(stmt));
       if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -18827,7 +18798,7 @@
       stmtSQL.AppendLiteral("OFF");
       stmtSQL.Append(';');
 
-      rv = aConnection->ExecuteSimpleSQL(stmtSQL);
+      rv = aConnection.ExecuteSimpleSQL(stmtSQL);
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
       }
@@ -18844,11 +18815,10 @@
 }
 
 nsresult DatabaseMaintenance::DetermineMaintenanceAction(
-    mozIStorageConnection* aConnection, nsIFile* aDatabaseFile,
+    mozIStorageConnection& aConnection, nsIFile* aDatabaseFile,
     MaintenanceAction* aMaintenanceAction) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
   MOZ_ASSERT(aDatabaseFile);
   MOZ_ASSERT(aMaintenanceAction);
 
@@ -18858,7 +18828,7 @@
   }
 
   int32_t schemaVersion;
-  nsresult rv = aConnection->GetSchemaVersion(&schemaVersion);
+  nsresult rv = aConnection.GetSchemaVersion(&schemaVersion);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -18873,12 +18843,12 @@
 
   // This method shouldn't make any permanent changes to the database, so make
   // sure everything gets rolled back when we leave.
-  mozStorageTransaction transaction(aConnection,
+  mozStorageTransaction transaction(&aConnection,
                                     /* aCommitOnComplete */ false);
 
   // Check to see when we last vacuumed this database.
   nsCOMPtr<mozIStorageStatement> stmt;
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT last_vacuum_time, last_vacuum_size "
                          "FROM database;"),
       getter_AddRefs(stmt));
@@ -18928,7 +18898,7 @@
 
   // Create a temporary copy of the dbstat table to speed up the queries that
   // come later.
-  rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING(
+  rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING(
       "CREATE VIRTUAL TABLE __stats__ USING dbstat;"
       "CREATE TEMP TABLE __temp_stats__ AS SELECT * FROM __stats__;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -18937,7 +18907,7 @@
 
   // Calculate the percentage of the database pages that are not in contiguous
   // order.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING(
           "SELECT SUM(__ts1__.pageno != __ts2__.pageno + 1) * 100.0 / COUNT(*) "
           "FROM __temp_stats__ AS __ts1__, __temp_stats__ AS __ts2__ "
@@ -18984,8 +18954,8 @@
   }
 
   // See if there are any free pages that we can reclaim.
-  rv = aConnection->CreateStatement(
-      NS_LITERAL_CSTRING("PRAGMA freelist_count;"), getter_AddRefs(stmt));
+  rv = aConnection.CreateStatement(NS_LITERAL_CSTRING("PRAGMA freelist_count;"),
+                                   getter_AddRefs(stmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -19013,7 +18983,7 @@
   }
 
   // Calculate the percentage of unused bytes on pages in the database.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT SUM(unused) * 100.0 / SUM(pgsize) "
                          "FROM __temp_stats__;"),
       getter_AddRefs(stmt));
@@ -19044,28 +19014,26 @@
 }
 
 void DatabaseMaintenance::IncrementalVacuum(
-    mozIStorageConnection* aConnection) {
+    mozIStorageConnection& aConnection) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
 
   if (NS_WARN_IF(QuotaClient::IsShuttingDownOnNonBackgroundThread()) ||
       mMaintenance->IsAborted()) {
     return;
   }
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(
+  nsresult rv = aConnection.ExecuteSimpleSQL(
       NS_LITERAL_CSTRING("PRAGMA incremental_vacuum;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return;
   }
 }
 
-void DatabaseMaintenance::FullVacuum(mozIStorageConnection* aConnection,
+void DatabaseMaintenance::FullVacuum(mozIStorageConnection& aConnection,
                                      nsIFile* aDatabaseFile) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
   MOZ_ASSERT(aDatabaseFile);
 
   if (NS_WARN_IF(QuotaClient::IsShuttingDownOnNonBackgroundThread()) ||
@@ -19073,7 +19041,7 @@
     return;
   }
 
-  nsresult rv = aConnection->ExecuteSimpleSQL(NS_LITERAL_CSTRING("VACUUM;"));
+  nsresult rv = aConnection.ExecuteSimpleSQL(NS_LITERAL_CSTRING("VACUUM;"));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return;
   }
@@ -19092,7 +19060,7 @@
   nsCOMPtr<mozIStorageStatement> stmt;
   // The parameter names are not used, parameters are bound by index only
   // locally in the same function.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("UPDATE database "
                          "SET last_vacuum_time = :time"
                          ", last_vacuum_size = :size;"),
@@ -19151,10 +19119,9 @@
 }
 
 nsresult DatabaseMaintenance::AutoProgressHandler::Register(
-    mozIStorageConnection* aConnection) {
+    NotNull<mozIStorageConnection*> aConnection) {
   MOZ_ASSERT(!NS_IsMainThread());
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
 
   // We want to quickly bail out of any operation if the user becomes active, so
   // use a small granularity here since database performance isn't critical.
@@ -19168,7 +19135,7 @@
   }
 
   MOZ_ASSERT(!oldHandler);
-  mConnection = aConnection;
+  mConnection.init(aConnection);
 
   return NS_OK;
 }
@@ -19179,7 +19146,8 @@
   MOZ_ASSERT(mConnection);
 
   nsCOMPtr<mozIStorageProgressHandler> oldHandler;
-  nsresult rv = mConnection->RemoveProgressHandler(getter_AddRefs(oldHandler));
+  nsresult rv =
+      mConnection->get()->RemoveProgressHandler(getter_AddRefs(oldHandler));
   Unused << NS_WARN_IF(NS_FAILED(rv));
 
   MOZ_ASSERT_IF(NS_SUCCEEDED(rv), oldHandler == this);
@@ -19212,8 +19180,7 @@
 DatabaseMaintenance::AutoProgressHandler::OnProgress(
     mozIStorageConnection* aConnection, bool* _retval) {
   NS_ASSERT_OWNINGTHREAD(DatabaseMaintenance::AutoProgressHandler);
-  MOZ_ASSERT(aConnection);
-  MOZ_ASSERT(mConnection == aConnection);
+  MOZ_ASSERT(*mConnection == aConnection);
   MOZ_ASSERT(_retval);
 
   *_retval = QuotaClient::IsShuttingDownOnNonBackgroundThread() ||
@@ -19231,7 +19198,7 @@
 NS_IMPL_ISUPPORTS(StripObsoleteOriginAttributesFunction, mozIStorageFunction);
 
 nsresult UpgradeFileIdsFunction::Init(nsIFile* aFMDirectory,
-                                      mozIStorageConnection* aConnection) {
+                                      mozIStorageConnection& aConnection) {
   // This file manager doesn't need real origin info, etc. The only purpose is
   // to store file ids without adding more complexity or code duplication.
   auto fileManager =
@@ -20148,7 +20115,6 @@
 DatabaseOperationBase::OnProgress(mozIStorageConnection* aConnection,
                                   bool* _retval) {
   MOZ_ASSERT(!IsOnBackgroundThread());
-  MOZ_ASSERT(aConnection);
   MOZ_ASSERT(_retval);
 
   // This is intentionally racy.
@@ -21372,7 +21338,7 @@
     return connectionOrErr.unwrapErr();
   }
 
-  auto connection = connectionOrErr.unwrap();
+  auto connection = connectionOrErr.unwrap().unwrap();
 
   AutoSetProgressHandler asph;
   rv = asph.Register(*connection, this);
@@ -21380,7 +21346,7 @@
     return rv;
   }
 
-  rv = LoadDatabaseInformation(connection);
+  rv = LoadDatabaseInformation(*connection);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -21415,7 +21381,7 @@
     fileManager = MakeSafeRefPtr<FileManager>(persistenceType, mGroup, mOrigin,
                                               databaseName, mEnforcingQuota);
 
-    rv = fileManager->Init(fmDirectory, connection);
+    rv = fileManager->Init(fmDirectory, *connection);
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
@@ -21446,14 +21412,13 @@
 }
 
 nsresult OpenDatabaseOp::LoadDatabaseInformation(
-    mozIStorageConnection* aConnection) {
-  AssertIsOnIOThread();
-  MOZ_ASSERT(aConnection);
+    mozIStorageConnection& aConnection) {
+  AssertIsOnIOThread();
   MOZ_ASSERT(mMetadata);
 
   // Load version information.
   nsCOMPtr<mozIStorageStatement> stmt;
-  nsresult rv = aConnection->CreateStatement(
+  nsresult rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT name, origin, version "
                          "FROM database"),
       getter_AddRefs(stmt));
@@ -21503,7 +21468,7 @@
   ObjectStoreTable& objectStores = mMetadata->mObjectStores;
 
   // Load object store names and ids.
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING("SELECT id, auto_increment, name, key_path "
                          "FROM object_store"),
       getter_AddRefs(stmt));
@@ -21608,7 +21573,7 @@
   usedNames.reset();
 
   // Load index information
-  rv = aConnection->CreateStatement(
+  rv = aConnection.CreateStatement(
       NS_LITERAL_CSTRING(
           "SELECT "
           "id, object_store_id, name, key_path, unique_index, multientry, "
@@ -21772,7 +21737,7 @@
 
 /* static */
 nsresult OpenDatabaseOp::UpdateLocaleAwareIndex(
-    mozIStorageConnection* aConnection, const IndexMetadata& aIndexMetadata,
+    mozIStorageConnection& aConnection, const IndexMetadata& aIndexMetadata,
     const nsCString& aLocale) {
   nsresult rv;
 
@@ -21789,7 +21754,7 @@
       NS_LITERAL_CSTRING("SELECT value, object_data_key FROM ") + indexTable +
       NS_LITERAL_CSTRING(" WHERE index_id = :index_id");
   nsCOMPtr<mozIStorageStatement> readStmt;
-  rv = aConnection->CreateStatement(readQuery, getter_AddRefs(readStmt));
+  rv = aConnection.CreateStatement(readQuery, getter_AddRefs(readStmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -21813,7 +21778,7 @@
           NS_LITERAL_CSTRING(" AND value = :") + kStmtParamNameValue +
           NS_LITERAL_CSTRING(" AND object_data_key = :") +
           kStmtParamNameObjectDataKey;
-      rv = aConnection->CreateStatement(writeQuery, getter_AddRefs(writeStmt));
+      rv = aConnection.CreateStatement(writeQuery, getter_AddRefs(writeStmt));
       if (NS_WARN_IF(NS_FAILED(rv))) {
         return rv;
       }
@@ -21872,7 +21837,7 @@
       "UPDATE object_store_index SET "
       "locale = :locale WHERE id = :id");
   nsCOMPtr<mozIStorageStatement> metaStmt;
-  rv = aConnection->CreateStatement(metaQuery, getter_AddRefs(metaStmt));
+  rv = aConnection.CreateStatement(metaQuery, getter_AddRefs(metaStmt));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
@@ -22490,7 +22455,7 @@
     return;
   }
 
-  const auto connection = connectionOrErr.unwrap();
+  const auto connection = connectionOrErr.unwrap().unwrap();
 
 #ifdef DEBUG
   {
@@ -26963,7 +26928,6 @@
   MOZ_ASSERT(aConnection);
   aConnection->AssertIsOnConnectionThread();
   MOZ_ASSERT(GetCursor().mObjectStoreId);
-  MOZ_ASSERT(GetCursor().mFileManager);
 
   AUTO_PROFILER_LABEL("Cursor::OpenOp::DoObjectStoreDatabaseWork", DOM);
 