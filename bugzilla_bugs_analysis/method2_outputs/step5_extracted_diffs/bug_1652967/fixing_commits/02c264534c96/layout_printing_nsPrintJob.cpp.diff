# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/printing/nsPrintJob.cpp
# Commit: 02c264534c96
# Full Hash: 02c264534c96d2ceafcaefe6f638a6c225cd526b
# Author: Jonathan Watt <jwatt@jwatt.org>
# Date: 2020-08-01 09:48:10
# Description:
#   Bug 1652967. Fix crash in nsPrintJob::DoPrint. r=bobowen
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D85570
# ==============================================================================

diff -r 170550855ee2 -r 02c264534c96 layout/printing/nsPrintJob.cpp
--- a/layout/printing/nsPrintJob.cpp	Thu Jul 30 08:54:56 2020 +0000
+++ b/layout/printing/nsPrintJob.cpp	Fri Jul 31 12:19:44 2020 +0000
@@ -631,6 +631,13 @@
                                    Document* aSourceDoc) {
   nsresult rv;
 
+  // Grab the new instance with local variable to guarantee that it won't be
+  // deleted during this method.
+  // Note: Methods we call early below rely on mPrt being set.
+  mPrt = new nsPrintData(aIsPrintPreview ? nsPrintData::eIsPrintPreview
+                                         : nsPrintData::eIsPrinting);
+  RefPtr<nsPrintData> printData = mPrt;
+
   if (aIsPrintPreview) {
     // The WebProgressListener can be QI'ed to nsIPrintingPromptService
     // then that means the progress dialog is already being shown.
@@ -640,6 +647,11 @@
 
     mIsCreatingPrintPreview = true;
 
+    // Our new print preview nsPrintData is stored in mPtr until we move it
+    // to mPrtPreview once we've finish creating the print preview. We must
+    // clear mPtrPreview so that code will use mPtr until that happens.
+    mPrtPreview = nullptr;
+
     // ensures docShell tree navigation in frozen
     SetIsPrintPreview(true);
   } else {
@@ -649,19 +661,6 @@
     SetIsPrinting(true);
   }
 
-  // Grab the new instance with local variable to guarantee that it won't be
-  // deleted during this method.
-  mPrt = new nsPrintData(mIsCreatingPrintPreview ? nsPrintData::eIsPrintPreview
-                                                 : nsPrintData::eIsPrinting);
-  RefPtr<nsPrintData> printData = mPrt;
-
-  if (mIsCreatingPrintPreview) {
-    // Our new print preview nsPrintData is stored in mPtr until we move it
-    // to mPrtPreview once we've finish creating the print preview. We must
-    // clear mPtrPreview so that code will use mPtr until that happens.
-    mPrtPreview = nullptr;
-  }
-
   if (aWebProgressListener) {
     printData->mPrintProgressListeners.AppendObject(aWebProgressListener);
   }
@@ -1704,7 +1703,8 @@
   return !pending;
 }
 
-nsresult nsPrintJob::MaybeResumePrintAfterResourcesLoaded(bool aCleanupOnError) {
+nsresult nsPrintJob::MaybeResumePrintAfterResourcesLoaded(
+    bool aCleanupOnError) {
   if (!ShouldResumePrint()) {
     mDidLoadDataForPrinting = true;
     return NS_OK;
