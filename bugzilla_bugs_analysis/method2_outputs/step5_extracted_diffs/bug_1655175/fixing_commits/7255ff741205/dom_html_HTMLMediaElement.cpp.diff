# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/html/HTMLMediaElement.cpp
# Commit: 7255ff741205
# Full Hash: 7255ff741205f16208dcf042614b52259573d605
# Author: alwu <alwu@mozilla.com>
# Date: 2020-07-28 09:47:25
# Description:
#   Bug 1655175 - avoid to access owner media element after unlink. r=bryce
#   
#   `mElement` would be reset during CC unlink [1], so we should avoid to access it after unlink happens.
#   
#   [1] https://searchfox.org/mozilla-central/rev/828f2319c0195d7f561ed35533aef6fe183e68e3/dom/html/HTMLMediaElement.cpp#2027
# ==============================================================================

diff -r faa4b21ccbf2 -r 7255ff741205 dom/html/HTMLMediaElement.cpp
--- a/dom/html/HTMLMediaElement.cpp	Thu Jul 23 18:17:04 2020 +0000
+++ b/dom/html/HTMLMediaElement.cpp	Mon Jul 27 19:37:04 2020 +0000
@@ -569,6 +569,10 @@
   // might be different from the one that we used to initialize
   // `ContentMediaAgent`.
   BrowsingContext* GetCurrentBrowsingContext() const {
+    // Owner has been CCed, which would break the link of the weaker pointer.
+    if (!Owner()) {
+      return nullptr;
+    }
     nsPIDOMWindowInner* window = Owner()->OwnerDoc()->GetInnerWindow();
     return window ? window->GetBrowsingContext() : nullptr;
   }
@@ -589,7 +593,9 @@
   }
 
   HTMLMediaElement* Owner() const {
-    MOZ_ASSERT(mElement);
+    // `mElement` would be clear during CC unlinked, but it would only happen
+    // after stopping the listener.
+    MOZ_ASSERT(mElement || !IsStarted());
     return mElement.get();
   }
 
