# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/printing/nsPrintJob.cpp
# Commit: 6f06512ba3db
# Full Hash: 6f06512ba3db747367e5d16befd0e259f8a71bb2
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-07-27 03:30:00
# Description:
#   Bug 1655179 - Don't attach a progress listener until we've started to set up the print presentation. r=smaug
#   
#   This is afaict a pre-existing (conceptual) issue before my patch, but
#   it was only theoretical because @font-face loads are triggered from
#   styling / layout, so we wouldn't trigger them until we initialize the
# ==============================================================================

diff -r beb139133417 -r 6f06512ba3db layout/printing/nsPrintJob.cpp
--- a/layout/printing/nsPrintJob.cpp	Sun Jul 26 21:30:56 2020 +0000
+++ b/layout/printing/nsPrintJob.cpp	Sun Jul 26 22:16:32 2020 +0000
@@ -908,14 +908,6 @@
 
   MOZ_TRY(EnablePOsForPrinting());
 
-  // Attach progressListener to catch network requests.
-  mDidLoadDataForPrinting = false;
-
-  nsCOMPtr<nsIWebProgress> webProgress =
-      do_QueryInterface(printData->mPrintObject->mDocShell);
-  webProgress->AddProgressListener(static_cast<nsIWebProgressListener*>(this),
-                                   nsIWebProgress::NOTIFY_STATE_REQUEST);
-
   if (mIsCreatingPrintPreview) {
     bool notifyOnInit = false;
     ShowPrintProgress(false, notifyOnInit);
@@ -1676,6 +1668,14 @@
   // So, we should grab it with local variable.
   RefPtr<nsPrintData> printData = mPrt;
 
+  // Attach progressListener to catch network requests.
+  mDidLoadDataForPrinting = false;
+
+  nsCOMPtr<nsIWebProgress> webProgress =
+      do_QueryInterface(printData->mPrintObject->mDocShell);
+  webProgress->AddProgressListener(static_cast<nsIWebProgressListener*>(this),
+                                   nsIWebProgress::NOTIFY_STATE_REQUEST);
+
   MOZ_TRY(ReflowDocList(printData->mPrintObject, DoSetPixelScale()));
 
   FirePrintPreviewUpdateEvent();
