# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/base/nsFrameLoader.cpp
# Commit: 43702cb83da8
# Full Hash: 43702cb83da81df00f837bd543858f1d82de7e54
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-07-30 21:54:52
# Description:
#   Bug 1655746 - Avoid crashing when getting error notifications from printing. r=jwatt
#   
#   We could legitimately get multiple error notifications and we'd try to
#   reject the promise twice and crash.
#   
# ==============================================================================

diff -r 0545a50192b6 -r 43702cb83da8 dom/base/nsFrameLoader.cpp
--- a/dom/base/nsFrameLoader.cpp	Thu Jul 30 17:48:47 2020 +0000
+++ b/dom/base/nsFrameLoader.cpp	Thu Jul 30 17:32:03 2020 +0000
@@ -3128,6 +3128,9 @@
                            uint32_t aStateFlags, nsresult aStatus) override {
     if (aStateFlags & nsIWebProgressListener::STATE_STOP &&
         aStateFlags & nsIWebProgressListener::STATE_IS_DOCUMENT) {
+      MOZ_RELEASE_ASSERT(mPromise,
+                         "Got duplicate load notification, "
+                         "or load after an error");
       mPromise->MaybeResolveWithUndefined();
       mPromise = nullptr;
     }
@@ -3136,7 +3139,7 @@
   NS_IMETHOD OnStatusChange(nsIWebProgress* aWebProgress, nsIRequest* aRequest,
                             nsresult aStatus,
                             const char16_t* aMessage) override {
-    if (aStatus != NS_OK) {
+    if (aStatus != NS_OK && mPromise) {
       mPromise->MaybeReject(ErrorResult(aStatus));
       mPromise = nullptr;
     }
