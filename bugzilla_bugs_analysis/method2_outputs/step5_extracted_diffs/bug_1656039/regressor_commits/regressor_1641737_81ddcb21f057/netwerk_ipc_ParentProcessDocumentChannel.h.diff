# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/ipc/ParentProcessDocumentChannel.h
# Commit: 81ddcb21f057
# Full Hash: 81ddcb21f05754f2b3b4e581e5d4295fada1cc2c
# Author: Jean-Yves Avenard <jyavenard@mozilla.com>
# Date: 2020-06-12 14:56:55
# Regressor Bug: 1641737
# File Overlap Count: 2
# Description:
#   Bug 1641737 - P2. Use MozPromise with DocumentLoadListener and remove cycle. r=mattwoodrow.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D78179
# ==============================================================================

diff -r 02f45f660107 -r 81ddcb21f057 netwerk/ipc/ParentProcessDocumentChannel.h
--- a/netwerk/ipc/ParentProcessDocumentChannel.h	Fri Jun 12 05:56:26 2020 +0000
+++ b/netwerk/ipc/ParentProcessDocumentChannel.h	Fri Jun 12 05:56:28 2020 +0000
@@ -8,7 +8,6 @@
 #define mozilla_net_ParentProcessDocumentChannel_h
 
 #include "ProtocolUtils.h"
-#include "mozilla/net/ADocumentChannelBridge.h"
 #include "mozilla/net/DocumentChannel.h"
 #include "mozilla/net/DocumentLoadListener.h"
 #include "nsIObserver.h"
@@ -18,8 +17,7 @@
 
 class ParentProcessDocumentChannel : public DocumentChannel,
                                      public nsIAsyncVerifyRedirectCallback,
-                                     public nsIObserver,
-                                     public ADocumentChannelBridge {
+                                     public nsIObserver {
  public:
   ParentProcessDocumentChannel(nsDocShellLoadState* aLoadState,
                                class LoadInfo* aLoadInfo,
@@ -37,23 +35,13 @@
   RedirectToRealChannel(
       nsTArray<ipc::Endpoint<extensions::PStreamFilterParent>>&&
           aStreamFilterEndpoints,
-      uint32_t aRedirectFlags, uint32_t aLoadFlags) override;
-
-  void DisconnectChildListeners(nsresult aStatus,
-                                nsresult aLoadGroupStatus) override {
-    DocumentChannel::DisconnectChildListeners(aStatus, aLoadGroupStatus);
-    RemoveObserver();
-    mDocumentLoadListener = nullptr;
-  }
-  void Delete() override {}
+      uint32_t aRedirectFlags, uint32_t aLoadFlags);
   void DeleteIPDL() override {
     mPromise.ResolveIfExists(NS_BINDING_ABORTED, __func__);
   }
-  base::ProcessId OtherPid() const override { return 0; }
 
  private:
   virtual ~ParentProcessDocumentChannel();
-  void DisconnectDocumentLoadListener();
   void RemoveObserver();
 
   RefPtr<DocumentLoadListener> mDocumentLoadListener;
@@ -61,6 +49,7 @@
       mStreamFilterEndpoints;
   MozPromiseHolder<PDocumentChannelParent::RedirectToRealChannelPromise>
       mPromise;
+  MozPromiseRequestHolder<DocumentLoadListener::OpenPromise> mPromiseRequest;
   bool mRequestObserversCalled = false;
 };
 