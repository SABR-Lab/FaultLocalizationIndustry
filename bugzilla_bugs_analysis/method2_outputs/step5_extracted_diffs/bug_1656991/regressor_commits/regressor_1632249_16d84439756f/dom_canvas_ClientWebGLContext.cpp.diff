# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/ClientWebGLContext.cpp
# Commit: 16d84439756f
# Full Hash: 16d84439756fae6ab67f7e874dd61d03d3b28905
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-06-09 09:21:34
# Regressor Bug: 1632249
# File Overlap Count: 1
# Description:
#   Bug 1632249 - WebXR compositing fixes. r=imanol
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D78117
# ==============================================================================

diff -r bbfe23c61add -r 16d84439756f dom/canvas/ClientWebGLContext.cpp
--- a/dom/canvas/ClientWebGLContext.cpp	Mon Jun 08 20:34:15 2020 +0000
+++ b/dom/canvas/ClientWebGLContext.cpp	Mon Jun 08 20:36:14 2020 +0000
@@ -398,7 +398,17 @@
 
 // ------------------------- Composition, etc -------------------------
 
-void ClientWebGLContext::OnBeforePaintTransaction() { Present(); }
+void ClientWebGLContext::OnBeforePaintTransaction() {
+  const RefPtr<layers::ImageBridgeChild> imageBridge =
+      layers::ImageBridgeChild::GetSingleton();
+
+  auto texType = layers::TextureType::Unknown;
+  if (imageBridge) {
+    texType = layers::PreferredCanvasTextureType(*imageBridge);
+  }
+
+  Present(nullptr, texType);
+}
 
 void ClientWebGLContext::EndComposition() {
   // Mark ourselves as no longer invalidated.
@@ -407,43 +417,18 @@
 
 // -
 
-namespace webgl {
-
-void Present(ClientWebGLContext& webgl) { webgl.Present(); }
-
-Maybe<layers::SurfaceDescriptor> GetFrontBuffer(
-    ClientWebGLContext& webgl, layers::KnowsCompositor* const kc) {
-  auto texType = layers::TextureType::Unknown;
-  if (kc) {
-    texType = layers::PreferredCanvasTextureType(*kc);
-  }
-  return webgl.GetFrontBuffer(texType);
-}
-
-}  // namespace webgl
-
-// -
-
-void ClientWebGLContext::Present() {
+void ClientWebGLContext::Present(WebGLFramebufferJS* const fb,
+                                 const layers::TextureType type) {
   if (!mIsCanvasDirty) return;
   mIsCanvasDirty = false;
-  mFrontBufferDesc = nullptr;
   mFrontBufferSnapshot = nullptr;
 
-  Run<RPROC(Present)>();
+  Run<RPROC(Present)>(fb ? fb->mId : 0, type);
 }
 
 Maybe<layers::SurfaceDescriptor> ClientWebGLContext::GetFrontBuffer(
-    const layers::TextureType type) {
-  if (!mFrontBufferDesc) {
-    const auto desc = Run<RPROC(GetFrontBuffer)>(type);
-    if (desc) {
-      mFrontBufferDesc = MakeUnique<layers::SurfaceDescriptor>(*desc);
-    }
-  }
-
-  if (!mFrontBufferDesc) return Nothing();
-  return Some(*mFrontBufferDesc);
+    WebGLFramebufferJS* const fb, const layers::TextureType type) {
+  return Run<RPROC(GetFrontBuffer)>(fb ? fb->mId : 0, type);
 }
 
 // -
@@ -620,9 +605,6 @@
     }
     if (size == curSize) return NS_OK;  // MUST skip no-op resize
 
-    if (mIsCanvasDirty) {
-      Present();
-    }
     state.mDrawingBufferSize = Nothing();
     Run<RPROC(Resize)>(size);
 