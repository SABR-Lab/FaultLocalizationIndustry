# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/WebGLContext.cpp
# Commit: 16d84439756f
# Full Hash: 16d84439756fae6ab67f7e874dd61d03d3b28905
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-06-09 09:21:34
# Regressor Bug: 1632249
# File Overlap Count: 1
# Description:
#   Bug 1632249 - WebXR compositing fixes. r=imanol
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D78117
# ==============================================================================

diff -r bbfe23c61add -r 16d84439756f dom/canvas/WebGLContext.cpp
--- a/dom/canvas/WebGLContext.cpp	Mon Jun 08 20:34:15 2020 +0000
+++ b/dom/canvas/WebGLContext.cpp	Mon Jun 08 20:36:14 2020 +0000
@@ -942,32 +942,46 @@
   return true;
 }
 
-void WebGLContext::Present() {
+void WebGLContext::Present(WebGLFramebuffer* const fb,
+                           const layers::TextureType consumerType) {
   const FuncScope funcScope(*this, "<Present>");
   if (IsContextLost()) return;
 
-  mResolvedDefaultFB = nullptr;
+  auto swapChain = &mSwapChain;
+  if (fb) {
+    swapChain = &fb->mOpaqueSwapChain;
+  } else {
+    mResolvedDefaultFB = nullptr;
+  }
 
-  if (!mSwapChain.mFactory) {
+  if (!swapChain->mFactory) {
+    auto typedFactory = gl::SurfaceFactory::Create(gl, consumerType);
+    if (typedFactory) {
+      swapChain->mFactory = std::move(typedFactory);
+    }
+  }
+  if (!swapChain->mFactory) {
     NS_WARNING("Failed to make an ideal SurfaceFactory.");
-    mSwapChain.mFactory = MakeUnique<gl::SurfaceFactory_Basic>(*gl);
+    swapChain->mFactory = MakeUnique<gl::SurfaceFactory_Basic>(*gl);
   }
-  MOZ_ASSERT(mSwapChain.mFactory);
+  MOZ_ASSERT(swapChain->mFactory);
 
-  (void)PresentInto(mSwapChain);
+  (void)PresentInto(*swapChain);
 }
 
 Maybe<layers::SurfaceDescriptor> WebGLContext::GetFrontBuffer(
-    const layers::TextureType consumerType) {
-  if (mSwapChain.mFactory &&
-      mSwapChain.mFactory->mDesc.consumerType != consumerType) {
-    auto typedFactory = gl::SurfaceFactory::Create(gl, consumerType);
-    if (typedFactory) {
-      mSwapChain.mFactory = std::move(typedFactory);
-    }
+    WebGLFramebuffer* const fb, const layers::TextureType consumerType) {
+  auto swapChain = &mSwapChain;
+  if (fb) {
+    swapChain = &fb->mOpaqueSwapChain;
   }
 
-  const auto& front = mSwapChain.FrontBuffer();
+  if (swapChain->mFactory &&
+      swapChain->mFactory->mDesc.consumerType != consumerType) {
+    swapChain->mFactory = nullptr;  // Better luck next Present.
+  }
+
+  const auto& front = swapChain->FrontBuffer();
   if (!front) return {};
 
   return front->ToSurfaceDescriptor();