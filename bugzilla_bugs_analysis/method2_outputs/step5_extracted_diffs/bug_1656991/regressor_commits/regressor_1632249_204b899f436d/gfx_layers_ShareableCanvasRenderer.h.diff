# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/layers/ShareableCanvasRenderer.h
# Commit: 204b899f436d
# Full Hash: 204b899f436d99f0eae759af3ccfcbaabfbbb428
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-06-11 09:34:54
# Regressor Bug: 1632249
# File Overlap Count: 1
# Description:
#   Bug 1632249 - Support compositing out-of-process WebGL. r=handyman,lsalzman,nical,geckoview-reviewers,agi,imanol
#   
#   * Majorly simplity CanvasRenderer
#   * Replace GLScreenBuffer with trivial GLSwapChain
#   * Use descriptor structs so that future SharedSurface changes aren't so painful
# ==============================================================================

diff -r 3f5baab34b1f -r 204b899f436d gfx/layers/ShareableCanvasRenderer.h
--- a/gfx/layers/ShareableCanvasRenderer.h	Thu Jun 11 06:36:55 2020 +0000
+++ b/gfx/layers/ShareableCanvasRenderer.h	Thu Jun 11 06:37:35 2020 +0000
@@ -8,7 +8,7 @@
 #define GFX_SHAREABLECANVASRENDERER_H
 
 #include "CompositorTypes.h"
-#include "CopyableCanvasRenderer.h"
+#include "CanvasRenderer.h"
 #include "mozilla/layers/CanvasClient.h"
 
 namespace mozilla {
@@ -22,42 +22,38 @@
 
 namespace layers {
 
-class ShareableCanvasRenderer : public CopyableCanvasRenderer {
-  typedef CanvasClient::CanvasClientType CanvasClientType;
+class ShareableCanvasRenderer : public CanvasRenderer {
+  friend class CanvasClient2D;
+  friend class CanvasClientSharedSurface;
+
+ protected:
+  RefPtr<CanvasClient> mCanvasClient;
+
+ private:
+  layers::SurfaceDescriptor mFrontBufferDesc;
+  RefPtr<TextureClient> mFrontBufferFromDesc;
 
  public:
   ShareableCanvasRenderer();
   virtual ~ShareableCanvasRenderer();
 
  public:
-  void Initialize(const CanvasInitializeData& aData) override;
+  void Initialize(const CanvasRendererData&) override;
 
   virtual CompositableForwarder* GetForwarder() = 0;
 
   virtual bool CreateCompositable() = 0;
 
   void ClearCachedResources() override;
-  void Destroy() override;
+  void DisconnectClient() override;
 
   void UpdateCompositableClient();
 
-  const TextureFlags& Flags() const { return mFlags; }
-
   CanvasClient* GetCanvasClient() { return mCanvasClient; }
 
- protected:
-  bool UpdateTarget(gfx::DrawTarget* aDestTarget);
-
-  CanvasClientType GetCanvasClientType();
-
-  RefPtr<CanvasClient> mCanvasClient;
-
-  UniquePtr<gl::SurfaceFactory> mFactory;
-
-  TextureFlags mFlags;
-
-  friend class CanvasClient2D;
-  friend class CanvasClientSharedSurface;
+ private:
+  RefPtr<TextureClient> GetFrontBufferFromDesc(const layers::SurfaceDescriptor&,
+                                               TextureFlags);
 };
 
 }  // namespace layers