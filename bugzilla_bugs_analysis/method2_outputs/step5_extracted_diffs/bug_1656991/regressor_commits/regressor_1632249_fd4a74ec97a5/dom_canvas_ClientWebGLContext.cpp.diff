# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/ClientWebGLContext.cpp
# Commit: fd4a74ec97a5
# Full Hash: fd4a74ec97a5d9540157f30dfc6184031c2499ac
# Author: Jeff Gilbert <jgilbert@mozilla.com>
# Date: 2020-06-15 21:48:38
# Regressor Bug: 1632249
# File Overlap Count: 1
# Description:
#   Bug 1632249 - NON_PREMULT TextureClient iff NON_PREMULT CanvasClient. r=handyman
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D78800
# ==============================================================================

diff -r 4cda148ef28f -r fd4a74ec97a5 dom/canvas/ClientWebGLContext.cpp
--- a/dom/canvas/ClientWebGLContext.cpp	Mon Jun 15 18:26:00 2020 +0000
+++ b/dom/canvas/ClientWebGLContext.cpp	Mon Jun 15 18:26:02 2020 +0000
@@ -421,7 +421,6 @@
                                  const layers::TextureType type) {
   if (!mIsCanvasDirty && !fb) return;
   mIsCanvasDirty = false;
-  mFrontBufferSnapshot = nullptr;
 
   Run<RPROC(Present)>(fb ? fb->mId : 0, type);
 }
@@ -882,7 +881,8 @@
   return ret.forget();
 }
 
-RefPtr<gfx::SourceSurface> ClientWebGLContext::GetFrontBufferSnapshot() {
+RefPtr<gfx::SourceSurface> ClientWebGLContext::GetFrontBufferSnapshot(
+    const bool requireAlphaPremult) {
   const FuncScope funcScope(*this, "<GetSurfaceSnapshot>");
   if (IsContextLost()) return nullptr;
   const auto notLost =
@@ -890,20 +890,19 @@
 
   const auto& options = mNotLost->info.options;
 
-  if (!mFrontBufferSnapshot) {
-    mFrontBufferSnapshot = Run<RPROC(GetFrontBufferSnapshot)>();
-    if (!mFrontBufferSnapshot) return nullptr;
-
-    if (options.alpha && !options.premultipliedAlpha) {
-      const auto nonPremultSurf = mFrontBufferSnapshot;
-      const auto& size = nonPremultSurf->GetSize();
-      const auto format = nonPremultSurf->GetFormat();
-      mFrontBufferSnapshot =
-          gfx::Factory::CreateDataSourceSurface(size, format, /*zero=*/false);
-      gfxUtils::PremultiplyDataSurface(nonPremultSurf, mFrontBufferSnapshot);
-    }
-  }
-  return mFrontBufferSnapshot;
+  auto snapshot = Run<RPROC(GetFrontBufferSnapshot)>();
+  if (!snapshot) return nullptr;
+
+  if (requireAlphaPremult && options.alpha && !options.premultipliedAlpha) {
+    const auto nonPremultSurf = snapshot;
+    const auto& size = nonPremultSurf->GetSize();
+    const auto format = nonPremultSurf->GetFormat();
+    snapshot =
+        gfx::Factory::CreateDataSourceSurface(size, format, /*zero=*/false);
+    gfxUtils::PremultiplyDataSurface(nonPremultSurf, snapshot);
+  }
+
+  return snapshot;
 }
 
 RefPtr<gfx::DataSourceSurface> ClientWebGLContext::BackBufferSnapshot() {