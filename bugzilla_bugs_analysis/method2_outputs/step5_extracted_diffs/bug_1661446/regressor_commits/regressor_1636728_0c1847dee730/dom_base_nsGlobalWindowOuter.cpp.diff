# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsGlobalWindowOuter.cpp
# Commit: 0c1847dee730
# Full Hash: 0c1847dee730f55b184459f5578c67ab45b611c1
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Make calling window.print() before load keep deferring the actual printing and closing the window until load. r=smaug
#   
#   Other engines also do this, but with my previous patch breaks it
#   (because we only hit print() on the print-content-viewer _after_ doing
#   the clone).
# ==============================================================================

diff -r 93e3344dd1f7 -r 0c1847dee730 dom/base/nsGlobalWindowOuter.cpp
--- a/dom/base/nsGlobalWindowOuter.cpp	Tue Aug 25 17:45:12 2020 +0000
+++ b/dom/base/nsGlobalWindowOuter.cpp	Tue Aug 25 17:45:24 2020 +0000
@@ -1325,6 +1325,8 @@
       mAllowScriptsToClose(false),
       mTopLevelOuterContentWindow(false),
       mStorageAccessPermissionGranted(false),
+      mDelayedPrintUntilAfterLoad(false),
+      mShouldDelayPrintUntilAfterLoad(false),
 #ifdef DEBUG
       mSerial(0),
       mSetOpenerWindowCalled(false),
@@ -2065,7 +2067,6 @@
                    GetCurrentInnerWindow()->GetExtantDoc() == mDoc,
                "Uh, mDoc doesn't match the current inner window "
                "document!");
-
   bool wouldReuseInnerWindow = WouldReuseInnerWindow(aDocument);
   if (aForceReuseInnerWindow && !wouldReuseInnerWindow && mDoc &&
       mDoc->NodePrincipal() != aDocument->NodePrincipal()) {
@@ -2122,6 +2123,11 @@
   // document.
   mDoc = aDocument;
 
+  // We drop the print request for the old document on the floor, it never made
+  // it.
+  mShouldDelayPrintUntilAfterLoad = true;
+  mDelayedPrintUntilAfterLoad = false;
+
   // Take this opportunity to clear mSuspendedDoc. Our old inner window is now
   // responsible for unsuspending it.
   mSuspendedDoc = nullptr;
@@ -5215,6 +5221,18 @@
     return aError.ThrowNotAllowedError("Prompt was canceled by the user");
   }
 
+  // If we're loading, queue the print for later. This is a special-case that
+  // only applies to the window.print() call, for compat with other engines and
+  // pre-existing behavior.
+  if (mShouldDelayPrintUntilAfterLoad) {
+    if (nsIDocShell* docShell = GetDocShell()) {
+      if (docShell->GetBusyFlags() & nsIDocShell::BUSY_FLAGS_PAGE_LOADING) {
+        mDelayedPrintUntilAfterLoad = true;
+        return;
+      }
+    }
+  }
+
   const bool isPreview = StaticPrefs::print_tab_modal_enabled() &&
                          !StaticPrefs::print_always_print_silent();
   Print(nullptr, nullptr, nullptr, isPreview, aError);
@@ -6195,7 +6213,9 @@
     nsresult rv = cv->PermitUnload(&canClose);
     if (NS_SUCCEEDED(rv) && !canClose) return false;
 
-    rv = cv->RequestWindowClose(&canClose);
+    rv = cv->RequestWindowClose(
+        mShouldDelayPrintUntilAfterLoad && mDelayedPrintUntilAfterLoad,
+        &canClose);
     if (NS_SUCCEEDED(rv) && !canClose) return false;
   }
 