# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsDocumentViewer.cpp
# Commit: 0c1847dee730
# Full Hash: 0c1847dee730f55b184459f5578c67ab45b611c1
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Make calling window.print() before load keep deferring the actual printing and closing the window until load. r=smaug
#   
#   Other engines also do this, but with my previous patch breaks it
#   (because we only hit print() on the print-content-viewer _after_ doing
#   the clone).
# ==============================================================================

diff -r 93e3344dd1f7 -r 0c1847dee730 layout/base/nsDocumentViewer.cpp
--- a/layout/base/nsDocumentViewer.cpp	Tue Aug 25 17:45:12 2020 +0000
+++ b/layout/base/nsDocumentViewer.cpp	Tue Aug 25 17:45:24 2020 +0000
@@ -464,12 +464,6 @@
   unsigned mClosingWhilePrinting : 1;
 
 #  if NS_PRINT_PREVIEW
-  // These data members support delayed printing when the document is loading
-  unsigned mPrintIsPending : 1;
-  unsigned mPrintDocIsFullyLoaded : 1;
-  nsCOMPtr<nsIPrintSettings> mCachedPrintSettings;
-  nsCOMPtr<nsIWebProgressListener> mCachedPrintWebProgressListner;
-
   RefPtr<nsPrintJob> mPrintJob;
 #  endif  // NS_PRINT_PREVIEW
 
@@ -515,8 +509,6 @@
   mDeferredWindowClose = false;
 
 #ifdef NS_PRINTING
-  mPrintIsPending = false;
-  mPrintDocIsFullyLoaded = false;
   mClosingWhilePrinting = false;
 
   // Make sure we have destroyed it and cleared the data member
@@ -542,11 +534,7 @@
       mInPermitUnloadPrompt(false),
 #ifdef NS_PRINTING
       mClosingWhilePrinting(false),
-#  if NS_PRINT_PREVIEW
-      mPrintIsPending(false),
-      mPrintDocIsFullyLoaded(false),
-#  endif  // NS_PRINT_PREVIEW
-#endif    // NS_PRINTING
+#endif  // NS_PRINTING
       mHintCharsetSource(kCharsetUninitialized),
       mHintCharset(nullptr),
       mIsPageMode(false),
@@ -1177,12 +1165,16 @@
 
 #ifdef NS_PRINTING
   // Check to see if someone tried to print during the load
-  if (mPrintIsPending) {
-    mPrintIsPending = false;
-    mPrintDocIsFullyLoaded = true;
-    Print(mCachedPrintSettings, mCachedPrintWebProgressListner);
-    mCachedPrintSettings = nullptr;
-    mCachedPrintWebProgressListner = nullptr;
+  if (window) {
+    auto* outerWin = nsGlobalWindowOuter::Cast(window);
+    outerWin->StopDelayingPrintingUntilAfterLoad();
+    if (outerWin->DelayedPrintUntilAfterLoad()) {
+      // We call into the inner because it ensures there's an active document
+      // and such.
+      if (RefPtr<nsPIDOMWindowInner> inner = window->GetCurrentInnerWindow()) {
+        nsGlobalWindowInner::Cast(inner)->Print(IgnoreErrors());
+      }
+    }
   }
 #endif
 
@@ -2224,14 +2216,15 @@
 }
 
 NS_IMETHODIMP
-nsDocumentViewer::RequestWindowClose(bool* aCanClose) {
+nsDocumentViewer::RequestWindowClose(bool aIsPrintPending, bool* aCanClose) {
+  *aCanClose = true;
+
 #ifdef NS_PRINTING
-  if (mPrintIsPending || (mPrintJob && mPrintJob->GetIsPrinting())) {
+  if (aIsPrintPending || (mPrintJob && mPrintJob->GetIsPrinting())) {
     *aCanClose = false;
     mDeferredWindowClose = true;
-  } else
+  }
 #endif
-    *aCanClose = true;
 
   return NS_OK;
 }
@@ -3113,25 +3106,6 @@
     return NS_ERROR_FAILURE;
   }
 
-  nsCOMPtr<nsIDocShell> docShell(mContainer);
-  NS_ENSURE_STATE(docShell);
-
-  // Check to see if this document is still busy
-  // If it is busy and we aren't already "queued" up to print then
-  // Indicate there is a print pending and cache the args for later
-  auto busyFlags = docShell->GetBusyFlags();
-  if (busyFlags != nsIDocShell::BUSY_FLAGS_NONE &&
-      busyFlags & nsIDocShell::BUSY_FLAGS_PAGE_LOADING &&
-      !mPrintDocIsFullyLoaded) {
-    if (!mPrintIsPending) {
-      mCachedPrintSettings = aPrintSettings;
-      mCachedPrintWebProgressListner = aWebProgressListener;
-      mPrintIsPending = true;
-    }
-    PR_PL(("Printing Stopped - document is still busy!"));
-    return NS_ERROR_GFX_PRINTER_DOC_IS_BUSY;
-  }
-
   if (!mDocument || !mDeviceContext) {
     PR_PL(("Can't Print without a document and a device context"));
     return NS_ERROR_FAILURE;