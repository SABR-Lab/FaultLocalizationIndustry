# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsGlobalWindowOuter.cpp
# Commit: 168ce28f0049
# Full Hash: 168ce28f004948c7b2646d5f613c1bda7af62de6
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-09-17 10:09:40
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1663826 - Keep freezing navigation during window.print() for compat. r=smaug
#   
#   This broke in bug 1636728 because we started setting the bit in the
#   cloned docshell rather than the original one.
#   
# ==============================================================================

diff -r 092dc1009fdf -r 168ce28f0049 dom/base/nsGlobalWindowOuter.cpp
--- a/dom/base/nsGlobalWindowOuter.cpp	Wed Sep 16 22:49:44 2020 +0000
+++ b/dom/base/nsGlobalWindowOuter.cpp	Wed Sep 16 22:55:19 2020 +0000
@@ -5232,6 +5232,46 @@
   }
 }
 
+#ifdef NS_PRINTING
+static void SetIsPrintingInDocShellTree(nsIDocShellTreeItem* aParentNode,
+                                        bool aIsPrintingOrPP,
+                                        bool aStartAtTop = true) {
+  nsCOMPtr<nsIDocShellTreeItem> parentItem(aParentNode);
+
+  // find top of "same parent" tree
+  if (aStartAtTop) {
+    while (parentItem) {
+      nsCOMPtr<nsIDocShellTreeItem> parent;
+      parentItem->GetInProcessSameTypeParent(getter_AddRefs(parent));
+      if (!parent) {
+        break;
+      }
+      parentItem = parent;
+    }
+  }
+
+  if (nsCOMPtr<nsIDocShell> viewerContainer = do_QueryInterface(parentItem)) {
+    viewerContainer->SetIsPrinting(aIsPrintingOrPP);
+  }
+
+  if (!aParentNode) {
+    return;
+  }
+
+  // Traverse children to see if any of them are printing.
+  int32_t n;
+  aParentNode->GetInProcessChildCount(&n);
+  for (int32_t i = 0; i < n; i++) {
+    nsCOMPtr<nsIDocShellTreeItem> child;
+    aParentNode->GetInProcessChildAt(i, getter_AddRefs(child));
+    NS_ASSERTION(child, "child isn't nsIDocShell");
+    if (child) {
+      SetIsPrintingInDocShellTree(child, aIsPrintingOrPP, false);
+    }
+  }
+}
+#endif
+
 void nsGlobalWindowOuter::PrintOuter(ErrorResult& aError) {
   if (!AreDialogsEnabled()) {
     // We probably want to keep throwing here; silently doing nothing is a bit
@@ -5271,6 +5311,11 @@
     return;
   }
 
+  nsCOMPtr<nsIDocShell> docShell = mDocShell;
+  SetIsPrintingInDocShellTree(docShell, true);
+  auto unset =
+      MakeScopeExit([&] { SetIsPrintingInDocShellTree(docShell, false); });
+
   const bool isPreview = StaticPrefs::print_tab_modal_enabled() &&
                          !StaticPrefs::print_always_print_silent();
   if (isPreview) {