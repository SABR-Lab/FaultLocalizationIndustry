# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: docshell/base/BrowsingContext.cpp
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 docshell/base/BrowsingContext.cpp
--- a/docshell/base/BrowsingContext.cpp	Tue Aug 25 02:58:57 2020 +0000
+++ b/docshell/base/BrowsingContext.cpp	Tue Aug 25 17:45:12 2020 +0000
@@ -2033,60 +2033,6 @@
   }
 }
 
-// We only care about whether we transition from not-awaiting to waiting. In
-// that case, we actually want to trigger the print process in the parent
-// process (which eventually will toggle this back to false, stopping the
-// event-loop-spinning going on in nsGlobalWindowOuter::PrintOuter).
-void BrowsingContext::DidSet(FieldIndex<IDX_IsAwaitingPrint>, bool aOldValue) {
-  if (!GetIsAwaitingPrint() || aOldValue == GetIsAwaitingPrint()) {
-    return;
-  }
-
-  if (!XRE_IsParentProcess()) {
-    return;
-  }
-
-  auto unsetFlagOnFailure = MakeScopeExit([&] {
-    // If we hit this, the print process failed, but let's not leave the event
-    // loop spinning on the child.
-    //
-    // If it fails because of the browsing context being discarded, then that's
-    // fine as well, the child event loop will also stop spinning.
-    Unused << SetIsAwaitingPrint(false);
-  });
-
-  RefPtr<Element> el = Top()->GetEmbedderElement();
-  if (NS_WARN_IF(!el)) {
-    return;
-  }
-
-  nsCOMPtr<nsPIDOMWindowOuter> outerWin = el->OwnerDoc()->GetWindow();
-  if (NS_WARN_IF(!outerWin)) {
-    return;
-  }
-
-  nsCOMPtr<nsIDOMChromeWindow> chromeWin = do_QueryInterface(outerWin);
-  if (NS_WARN_IF(!chromeWin)) {
-    return;
-  }
-
-  nsCOMPtr<nsIBrowserDOMWindow> browserDOMWin;
-  chromeWin->GetBrowserDOMWindow(getter_AddRefs(browserDOMWin));
-  if (NS_WARN_IF(!browserDOMWin)) {
-    return;
-  }
-
-  // TODO(emilio): This may be simpler by importing a JSM via do_ImportModule
-  // rather than nsIBrowserDOMWindow. Also, maybe we should make this return a
-  // promise that unsets the flag when resolved / rejected instead, once the
-  // print codepaths are unified.
-  if (NS_FAILED(browserDOMWin->Print(this))) {
-    return;
-  }
-  // The flag will be unset by the printing code.
-  unsetFlagOnFailure.release();
-}
-
 void BrowsingContext::DidSet(FieldIndex<IDX_Muted>) {
   MOZ_ASSERT(!GetParent(), "Set muted flag on non top-level context!");
   USER_ACTIVATION_LOG("Set audio muted %d for %s browsing context 0x%08" PRIx64,