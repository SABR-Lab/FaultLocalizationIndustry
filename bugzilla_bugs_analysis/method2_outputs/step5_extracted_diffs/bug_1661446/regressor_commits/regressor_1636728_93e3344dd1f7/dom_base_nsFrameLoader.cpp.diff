# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsFrameLoader.cpp
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 dom/base/nsFrameLoader.cpp
--- a/dom/base/nsFrameLoader.cpp	Tue Aug 25 02:58:57 2020 +0000
+++ b/dom/base/nsFrameLoader.cpp	Tue Aug 25 17:45:12 2020 +0000
@@ -3210,23 +3210,19 @@
     return promise.forget();
   }
 
-  nsGlobalWindowOuter* outerWindow =
+  RefPtr<nsGlobalWindowOuter> outerWindow =
       nsGlobalWindowOuter::GetOuterWindowWithId(aOuterWindowID);
   if (NS_WARN_IF(!outerWindow)) {
     promise->MaybeReject(ErrorResult(NS_ERROR_FAILURE));
     return promise.forget();
   }
 
-  nsCOMPtr<nsIWebBrowserPrint> webBrowserPrint =
-      do_GetInterface(ToSupports(outerWindow));
-  if (NS_WARN_IF(!webBrowserPrint)) {
-    promise->MaybeReject(ErrorResult(NS_ERROR_FAILURE));
-    return promise.forget();
-  }
-
-  nsresult rv = webBrowserPrint->Print(aPrintSettings, listener);
-  if (NS_FAILED(rv)) {
-    promise->MaybeReject(ErrorResult(rv));
+  ErrorResult rv;
+  outerWindow->Print(aPrintSettings, listener,
+                     /* aDocShellToCloneInto = */ nullptr,
+                     /* aIsPreview = */ false, rv);
+  if (rv.Failed()) {
+    promise->MaybeReject(std::move(rv));
   }
 
   return promise.forget();