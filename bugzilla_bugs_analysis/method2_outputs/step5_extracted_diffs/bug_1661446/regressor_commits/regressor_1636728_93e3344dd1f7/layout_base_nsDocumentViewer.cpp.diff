# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsDocumentViewer.cpp
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 layout/base/nsDocumentViewer.cpp
--- a/layout/base/nsDocumentViewer.cpp	Tue Aug 25 02:58:57 2020 +0000
+++ b/layout/base/nsDocumentViewer.cpp	Tue Aug 25 17:45:12 2020 +0000
@@ -11,6 +11,7 @@
 #include "mozilla/RestyleManager.h"
 #include "mozilla/ServoStyleSet.h"
 #include "mozilla/Telemetry.h"
+#include "nsThreadUtils.h"
 #include "nscore.h"
 #include "nsCOMPtr.h"
 #include "nsCRT.h"
@@ -3174,14 +3175,11 @@
 
 NS_IMETHODIMP
 nsDocumentViewer::PrintPreview(nsIPrintSettings* aPrintSettings,
-                               mozIDOMWindowProxy* aChildDOMWin,
                                nsIWebProgressListener* aWebProgressListener) {
 #  ifdef NS_PRINT_PREVIEW
-  MOZ_ASSERT(IsInitializedForPrintPreview(),
-             "For print preview nsIWebBrowserPrint must be from "
-             "docshell.initOrReusePrintPreviewViewer!");
-
-  NS_ENSURE_ARG_POINTER(aChildDOMWin);
+  RefPtr<Document> doc = mDocument.get();
+  NS_ENSURE_STATE(doc);
+
   if (GetIsPrinting()) {
     nsPrintJob::CloseProgressDialog(aWebProgressListener);
     return NS_ERROR_FAILURE;
@@ -3193,11 +3191,6 @@
     return NS_ERROR_FAILURE;
   }
 
-  nsCOMPtr<nsPIDOMWindowOuter> window = do_QueryInterface(aChildDOMWin);
-  MOZ_ASSERT(window);
-  nsCOMPtr<Document> doc = window->GetDoc();
-  NS_ENSURE_STATE(doc);
-
   NS_ENSURE_STATE(!GetIsPrinting());
   // beforeprint event may have caused ContentViewer to be shutdown.
   NS_ENSURE_STATE(mContainer);
@@ -3714,11 +3707,10 @@
 // XXX it always returns false for subdocuments
 bool nsDocumentViewer::GetIsPrintPreview() const {
 #ifdef NS_PRINTING
-  if (mPrintJob) {
-    return mPrintJob->CreatedForPrintPreview();
-  }
+  return mPrintJob && mPrintJob->CreatedForPrintPreview();
+#else
+  return false;
 #endif
-  return false;
 }
 
 //------------------------------------------------------------
@@ -3787,8 +3779,13 @@
       printJob->Destroy();
     }
 
-    // We are done printing, now cleanup
-    if (mDeferredWindowClose) {
+    // We are done printing, now cleanup. For non-print-preview jobs, we are
+    // actually responsible for cleaning up our whole <browser> or window (see
+    // the OPEN_PRINT_BROWSER code), so gotta run window.close() too.
+    //
+    // For print preview jobs the front-end code is responsible for cleaning the
+    // UI.
+    if (mDeferredWindowClose || !printJob->CreatedForPrintPreview()) {
       mDeferredWindowClose = false;
       if (mContainer) {
         if (nsCOMPtr<nsPIDOMWindowOuter> win = mContainer->GetWindow()) {
@@ -3910,14 +3907,6 @@
   mPresContext = nullptr;
 }
 
-bool nsDocumentViewer::IsInitializedForPrintPreview() {
-  return mInitializedForPrintPreview;
-}
-
-void nsDocumentViewer::InitializeForPrintPreview() {
-  mInitializedForPrintPreview = true;
-}
-
 void nsDocumentViewer::SetPrintPreviewPresentation(nsViewManager* aViewManager,
                                                    nsPresContext* aPresContext,
                                                    PresShell* aPresShell) {