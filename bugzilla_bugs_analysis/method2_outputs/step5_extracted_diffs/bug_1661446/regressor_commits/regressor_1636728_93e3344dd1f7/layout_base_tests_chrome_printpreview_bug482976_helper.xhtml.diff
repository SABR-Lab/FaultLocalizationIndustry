# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/tests/chrome/printpreview_bug482976_helper.xhtml
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 layout/base/tests/chrome/printpreview_bug482976_helper.xhtml
--- a/layout/base/tests/chrome/printpreview_bug482976_helper.xhtml	Tue Aug 25 02:58:57 2020 +0000
+++ b/layout/base/tests/chrome/printpreview_bug482976_helper.xhtml	Tue Aug 25 17:45:12 2020 +0000
@@ -20,8 +20,8 @@
 var todo = window.arguments[0].todo;
 var SimpleTest = window.arguments[0].SimpleTest;
 var gWbp;
+var gPrintPreviewWin;
 function printpreview() {
-  gWbp = frameElts[1].contentWindow.docShell.initOrReusePrintPreviewViewer();
   var listener = {
     onLocationChange: function(webProgress, request, location, flags) { },
     onProgressChange: function(webProgress, request, curSelfProgress,
@@ -38,14 +38,19 @@
       throw Components.Exception("", Cr.NS_NOINTERFACE);
     }
   }
+
   let settings = Cc["@mozilla.org/gfx/printsettings-service;1"]
                        .getService(Ci.nsIPrintSettingsService).globalPrintSettings;
-  settings.showPrintProgress = false; 
-  gWbp.printPreview(settings, frameElts[0].contentWindow, listener);
+  settings.showPrintProgress = false;
+
+  gPrintPreviewWin = frameElts[0].contentWindow.printPreview(settings, listener);
+  gWbp = gPrintPreviewWin.docShell.contentViewer;
+  gWbp.QueryInterface(Ci.nsIWebBrowserPrint);
 }
 
 function exitprintpreview() {
-  frameElts[1].contentWindow.docShell.exitPrintPreview();
+  gPrintPreviewWin.docShell.exitPrintPreview();
+  gPrintPreviewWin.close();
 }
 
 function finish() {