# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/tests/chrome/printpreview_helper.xhtml
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 layout/base/tests/chrome/printpreview_helper.xhtml
--- a/layout/base/tests/chrome/printpreview_helper.xhtml	Tue Aug 25 02:58:57 2020 +0000
+++ b/layout/base/tests/chrome/printpreview_helper.xhtml	Tue Aug 25 17:45:12 2020 +0000
@@ -28,6 +28,7 @@
 var info = window.arguments[0].info;
 var SimpleTest = window.arguments[0].SimpleTest;
 var gWbp;
+var gPrintPreviewWindow;
 var ctx1;
 var ctx2;
 var counter = 0;
@@ -38,7 +39,6 @@
 filePath = file.path;
 
 function printpreview(options = {}) {
-  gWbp = frameElts[1].docShell.initOrReusePrintPreviewViewer();
   let resolve;
   let promise = new Promise(r => { resolve = r });
   var listener = {
@@ -74,6 +74,8 @@
   settings.printBGColors = true;
   settings.headerStrLeft = "";
   settings.headerStrRight = "";
+  settings.footerStrLeft = "";
+  settings.footerStrRight = "";
   if (options.settings) {
     for (let key in options.settings) {
       settings[key] = options.settings[key];
@@ -85,7 +87,9 @@
   function afterprint() { ++after; }
   frameElts[0].contentWindow.addEventListener("beforeprint", beforeprint, true);
   frameElts[0].contentWindow.addEventListener("afterprint", afterprint, true);
-  gWbp.printPreview(settings, frameElts[0].contentWindow, listener);
+  gPrintPreviewWindow = frameElts[0].contentWindow.printPreview(settings, listener);
+  gWbp = gPrintPreviewWindow.docShell.contentViewer;
+  gWbp.QueryInterface(Ci.nsIWebBrowserPrint);
   is(before, 1, "Should have called beforeprint listener!");
   if (!options.hasMozPrintCallback) {
     // If there's a mozPrintCallback the after print event won't fire until
@@ -98,7 +102,8 @@
 }
 
 function exitprintpreview() {
-  frameElts[1].contentWindow.docShell.exitPrintPreview();
+  gPrintPreviewWindow.docShell.exitPrintPreview();
+  gPrintPreviewWindow.close();
 }
 
 function finish() {
@@ -153,7 +158,7 @@
   frameElts[0].contentDocument.body.firstChild.innerHTML = "Print preview";
 
   let ppfinished = printpreview();
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(256,256,256)");
+  drawPrintPreviewWindow(ctx1);
   frameElts[0].contentDocument.body.firstChild.innerHTML = "Galley presentation";
 
   // Add some elements.
@@ -170,7 +175,7 @@
 
 async function finalizeTest1(ppfinished) {
   await ppfinished;
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(256,256,256)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
   ok(compareCanvases(), "Canvas should be the same!");
   counter = frameElts[0].contentWindow.counter;
@@ -240,13 +245,13 @@
   frameElts[0].contentDocument.body.firstChild.value =
     frameElts[0].contentDocument.body.firstChild.getAttribute('value');
   await printpreview();
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(256,256,256)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
   frameElts[0].contentDocument.body.innerHTML = el2;
   frameElts[0].contentDocument.body.firstChild.value =
     frameElts[0].contentDocument.body.firstChild.getAttribute('value');
   await printpreview();
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(256,256,256)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
   is(compareCanvases(), equals,
      "Comparing print preview didn't succeed [" + el1 + " : " + el2 + "]");
@@ -302,14 +307,14 @@
   frameElts[0].contentDocument.body.firstChild.value =
     frameElts[0].contentDocument.body.firstChild.getAttribute('value');
   await printpreview();
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
 
   frameElts[0].contentDocument.body.innerHTML = "<div></div>";
   var sr = frameElts[0].contentDocument.body.firstChild.attachShadow({mode: "open"});
   sr.innerHTML = contentText;
   await printpreview();
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
   ok(compareCanvases(), "Printing light DOM and shadow DOM should create same output");
 
@@ -326,7 +331,7 @@
     iframeElement.setAttribute("src", "printpreview_font_api_ref.html");
   });
   await printpreview();
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
 
   // Second, snapshot the page with font loaded in JS.
@@ -335,7 +340,7 @@
     iframeElement.setAttribute("src", "printpreview_font_api.html");
   });
   await printpreview();
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
   ok(compareCanvases(), "Printing pages with fonts loaded from CSS and JS should be the same.");
 
@@ -351,7 +356,7 @@
   `;
 
   await printpreview();
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
 
   frameElts[0].contentDocument.body.innerHTML = `
@@ -373,13 +378,19 @@
   frameElts[0].contentDocument.body.offsetTop;
 
   await printpreview();
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
   ok(compareCanvases(), "Printing <use> subtrees should create same output");
 
   requestAnimationFrame(function() { setTimeout(runTest10); } );
 }
 
+function drawPrintPreviewWindow(ctx) {
+  ctx.canvas.width = gPrintPreviewWindow.innerWidth;
+  ctx.canvas.height = gPrintPreviewWindow.innerHeight;
+  ctx.drawWindow(gPrintPreviewWindow, 0, 0, gPrintPreviewWindow.innerWidth, gPrintPreviewWindow.innerHeight, "rgb(255, 255, 255)");
+}
+
 // Test for bug 1524640
 async function runTest10() {
   // Test that fonts loaded during mozprint callback are loaded into the cloned
@@ -396,7 +407,7 @@
   });
   await printpreview({ hasMozPrintCallback: true });
   await mozPrintCallbackDone;
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
 
   // Second, snapshot the page with font loaded in JS.
@@ -410,7 +421,7 @@
   await printpreview({ hasMozPrintCallback: true });
   // Wait for the mozprintcallback to finish.
   await mozPrintCallbackDone;
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx2);
 
   exitprintpreview();
   ok(compareCanvases(), "Printing pages with fonts loaded from a mozPrintCallback should be the same.");
@@ -442,7 +453,7 @@
   }
 
   await printpreview(options.test || options);
-  ctx1.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx1);
   exitprintpreview();
 
   await new Promise((resolve) => {
@@ -451,7 +462,7 @@
   });
 
   await printpreview(options.ref || options);
-  ctx2.drawWindow(frameElts[1].contentWindow, 0, 0, 400, 400, "rgb(255,255,255)");
+  drawPrintPreviewWindow(ctx2);
   exitprintpreview();
 
   ok(compareCanvases(options), `Printing ${src1} and ${src2} should produce the same results`);