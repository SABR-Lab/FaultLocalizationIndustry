# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/printing/nsPrintObject.cpp
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 layout/printing/nsPrintObject.cpp
--- a/layout/printing/nsPrintObject.cpp	Tue Aug 25 02:58:57 2020 +0000
+++ b/layout/printing/nsPrintObject.cpp	Tue Aug 25 17:45:12 2020 +0000
@@ -62,59 +62,13 @@
   NS_ENSURE_STATE(aDocShell);
   NS_ENSURE_STATE(aDoc);
 
-  if (aForPrintPreview) {
-    nsCOMPtr<nsIContentViewer> viewer;
-    aDocShell->GetContentViewer(getter_AddRefs(viewer));
-    if (viewer && viewer->GetDocument() && viewer->GetDocument()->IsShowing()) {
-      // We're about to discard this document, and it needs mIsShowing to be
-      // false to avoid triggering the assertion in its dtor.
-      viewer->GetDocument()->OnPageHide(false, nullptr);
-    }
-    mDocShell = aDocShell;
-  } else {
-    // When doing an actual print, we create a BrowsingContext/nsDocShell that
-    // is detached from any browser window or tab.
-
-    // Create a new BrowsingContext to create our DocShell in.
-    RefPtr<BrowsingContext> bc = BrowsingContext::CreateIndependent(
-        nsDocShell::Cast(aDocShell)->GetBrowsingContext()->GetType());
-
-    // Create a container docshell for printing.
-    mDocShell = nsDocShell::Create(bc);
-    NS_ENSURE_TRUE(mDocShell, NS_ERROR_OUT_OF_MEMORY);
-
-    mDidCreateDocShell = true;
-    MOZ_ASSERT(mDocShell->ItemType() == aDocShell->ItemType());
-
-    mTreeOwner = do_GetInterface(aDocShell);
-    mDocShell->SetTreeOwner(mTreeOwner);
+  MOZ_ASSERT(aDoc->IsStaticDocument());
 
-    // Make sure nsDocShell::EnsureContentViewer() is called:
-    mozilla::Unused << nsDocShell::Cast(mDocShell)->GetDocument();
-  }
+  mDocShell = aDocShell;
+  mDocument = aDoc;
 
-  // If we are cloning from a document in a different BrowsingContext, we need
-  // to make sure to copy over our opener policy information from that
-  // BrowsingContext.
-  BrowsingContext* targetBC = mDocShell->GetBrowsingContext();
-  BrowsingContext* sourceBC = aDoc->GetBrowsingContext();
-  NS_ENSURE_STATE(sourceBC);
-  if (targetBC != sourceBC) {
-    MOZ_ASSERT(targetBC->IsTopContent());
-    // In the case where the source is an iframe, this information needs to be
-    // copied from the toplevel source BrowsingContext, as we may be making a
-    // static clone of a single subframe.
-    MOZ_ALWAYS_SUCCEEDS(
-        targetBC->SetOpenerPolicy(sourceBC->Top()->GetOpenerPolicy()));
-  }
-
-  mDocument = aDoc->CreateStaticClone(mDocShell);
-  NS_ENSURE_STATE(mDocument);
-
-  nsCOMPtr<nsIContentViewer> viewer;
-  mDocShell->GetContentViewer(getter_AddRefs(viewer));
-  NS_ENSURE_STATE(viewer);
-  viewer->SetDocument(mDocument);
+  // Ensure the document has no presentation.
+  DestroyPresentation();
 
   return NS_OK;
 }
@@ -141,20 +95,22 @@
     // Assume something iframe-like, i.e. iframe, object, or embed
     mFrameType = eIFrame;
   }
-
   return NS_OK;
 }
 
 //------------------------------------------------------------------
 // Resets PO by destroying the presentation
 void nsPrintObject::DestroyPresentation() {
-  if (mPresShell) {
-    mPresShell->EndObservingDocument();
-    nsAutoScriptBlocker scriptBlocker;
-    RefPtr<PresShell> presShell = mPresShell;
-    mPresShell = nullptr;
-    presShell->Destroy();
+  if (mDocument) {
+    if (RefPtr<PresShell> ps = mDocument->GetPresShell()) {
+      MOZ_DIAGNOSTIC_ASSERT(!mPresShell || ps == mPresShell);
+      mPresShell = nullptr;
+      nsAutoScriptBlocker scriptBlocker;
+      ps->EndObservingDocument();
+      ps->Destroy();
+    }
   }
+  mPresShell = nullptr;
   mPresContext = nullptr;
   mViewManager = nullptr;
 }