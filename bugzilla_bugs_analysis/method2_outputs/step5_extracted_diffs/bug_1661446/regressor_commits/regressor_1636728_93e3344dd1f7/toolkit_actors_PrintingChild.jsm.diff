# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/actors/PrintingChild.jsm
# Commit: 93e3344dd1f7
# Full Hash: 93e3344dd1f7454dc46c1553dd05e5e3bc78c349
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-26 03:24:37
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1636728 - Centralize printing entry points in nsGlobalWindowOuter, and move cloning out of nsPrintJob. r=jwatt,geckoview-reviewers,smaug,agi
#   
#   This centralizes our print and preview setup in nsGlobalWindowOuter so
#   that we never re-clone a clone, and so that we reuse the window.open()
#   codepath to create the browsing context to clone into.
# ==============================================================================

diff -r 2969f3de028f -r 93e3344dd1f7 toolkit/actors/PrintingChild.jsm
--- a/toolkit/actors/PrintingChild.jsm	Tue Aug 25 02:58:57 2020 +0000
+++ b/toolkit/actors/PrintingChild.jsm	Tue Aug 25 17:45:12 2020 +0000
@@ -360,16 +360,14 @@
           this.mm.sendAsyncMessage("Printing:Preview:Entered", {
             failed: true,
           });
-          browsingContext.isAwaitingPrint = false;
           return;
         }
+
         try {
           let listener = new PrintingListener(this.mm);
 
           this.printPreviewInitializingInfo = { changingBrowsers };
-          docShell
-            .initOrReusePrintPreviewViewer()
-            .printPreview(printSettings, contentWindow, listener);
+          contentWindow.printPreview(printSettings, listener, docShell);
         } catch (error) {
           // This might fail if we, for example, attempt to print a XUL document.
           // In that case, we inform the parent to bail out of print preview.
@@ -379,8 +377,6 @@
             failed: true,
           });
         }
-
-        browsingContext.isAwaitingPrint = false;
       };
 
       // If printPreviewInitializingInfo.entered is not set we are still in the
@@ -400,27 +396,26 @@
       // In that case, we inform the parent to bail out of print preview.
       Cu.reportError(error);
       this.mm.sendAsyncMessage("Printing:Preview:Entered", { failed: true });
-      browsingContext.isAwaitingPrint = false;
     }
   }
 
   exitPrintPreview(glo) {
     this.printPreviewInitializingInfo = null;
-    this.docShell.initOrReusePrintPreviewViewer().exitPrintPreview();
+    this.docShell.exitPrintPreview();
   }
 
   updatePageCount() {
-    let numPages = this.docShell.initOrReusePrintPreviewViewer()
-      .printPreviewNumPages;
+    let cv = this.docShell.contentViewer;
+    cv.QueryInterface(Ci.nsIWebBrowserPrint);
     this.mm.sendAsyncMessage("Printing:Preview:UpdatePageCount", {
-      numPages,
+      numPages: cv.printPreviewNumPages,
     });
   }
 
   navigate(navType, pageNum) {
-    this.docShell
-      .initOrReusePrintPreviewViewer()
-      .printPreviewScrollToPage(navType, pageNum);
+    let cv = this.docShell.contentViewer;
+    cv.QueryInterface(Ci.nsIWebBrowserPrint);
+    cv.printPreviewScrollToPage(navType, pageNum);
   }
 }
 