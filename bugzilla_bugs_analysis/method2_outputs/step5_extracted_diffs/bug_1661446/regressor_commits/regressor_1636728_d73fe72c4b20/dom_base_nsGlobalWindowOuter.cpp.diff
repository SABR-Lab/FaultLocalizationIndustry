# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsGlobalWindowOuter.cpp
# Commit: d73fe72c4b20
# Full Hash: d73fe72c4b20a408d4c0559b7b1dd5d945f3d3b9
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-09-25 21:47:43
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1667342 - Make the "deferred window close" keep making sense after bug 1636728. r=smaug
#   
#   This was only being checked on OnDonePrinting() which isn't called in
#   the original docshell. Move it to the window because we don't need to
#   care about document viewers getting closed during print operations,
# ==============================================================================

diff -r 0bd98379fad4 -r d73fe72c4b20 dom/base/nsGlobalWindowOuter.cpp
--- a/dom/base/nsGlobalWindowOuter.cpp	Thu Sep 24 23:51:42 2020 +0000
+++ b/dom/base/nsGlobalWindowOuter.cpp	Fri Sep 25 13:39:01 2020 +0000
@@ -1330,6 +1330,7 @@
       mTopLevelOuterContentWindow(false),
       mStorageAccessPermissionGranted(false),
       mDelayedPrintUntilAfterLoad(false),
+      mDelayedCloseForPrinting(false),
       mShouldDelayPrintUntilAfterLoad(false),
 #ifdef DEBUG
       mSerial(0),
@@ -2136,8 +2137,9 @@
   nsDocShell::Cast(mDocShell)->MaybeRestoreWindowName();
 
   // We drop the print request for the old document on the floor, it never made
-  // it.
+  // it. We don't close the window here either even if we were asked to.
   mShouldDelayPrintUntilAfterLoad = true;
+  mDelayedCloseForPrinting = false;
   mDelayedPrintUntilAfterLoad = false;
 
   // Take this opportunity to clear mSuspendedDoc. Our old inner window is now
@@ -6251,22 +6253,18 @@
     return true;
   }
 
-  // Ask the content viewer whether the toplevel window can close.
-  // If the content viewer returns false, it is responsible for calling
-  // Close() as soon as it is possible for the window to close.
-  // This allows us to not close the window while printing is happening.
-
   nsCOMPtr<nsIContentViewer> cv;
   mDocShell->GetContentViewer(getter_AddRefs(cv));
   if (cv) {
     bool canClose;
     nsresult rv = cv->PermitUnload(&canClose);
     if (NS_SUCCEEDED(rv) && !canClose) return false;
-
-    rv = cv->RequestWindowClose(
-        mShouldDelayPrintUntilAfterLoad && mDelayedPrintUntilAfterLoad,
-        &canClose);
-    if (NS_SUCCEEDED(rv) && !canClose) return false;
+  }
+
+  // If we still have to print, we delay the closing until print has happened.
+  if (mShouldDelayPrintUntilAfterLoad && mDelayedPrintUntilAfterLoad) {
+    mDelayedCloseForPrinting = true;
+    return false;
   }
 
   return true;