# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsDocumentViewer.cpp
# Commit: d73fe72c4b20
# Full Hash: d73fe72c4b20a408d4c0559b7b1dd5d945f3d3b9
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-09-25 21:47:43
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1667342 - Make the "deferred window close" keep making sense after bug 1636728. r=smaug
#   
#   This was only being checked on OnDonePrinting() which isn't called in
#   the original docshell. Move it to the window because we don't need to
#   care about document viewers getting closed during print operations,
# ==============================================================================

diff -r 0bd98379fad4 -r d73fe72c4b20 layout/base/nsDocumentViewer.cpp
--- a/layout/base/nsDocumentViewer.cpp	Thu Sep 24 23:51:42 2020 +0000
+++ b/layout/base/nsDocumentViewer.cpp	Fri Sep 25 13:39:01 2020 +0000
@@ -1179,10 +1179,16 @@
     outerWin->StopDelayingPrintingUntilAfterLoad();
     if (outerWin->DelayedPrintUntilAfterLoad()) {
       // We call into the inner because it ensures there's an active document
-      // and such.
+      // and such, and it also waits until the whole thing completes, which is
+      // nice because it allows us to close if needed right here.
       if (RefPtr<nsPIDOMWindowInner> inner = window->GetCurrentInnerWindow()) {
         nsGlobalWindowInner::Cast(inner)->Print(IgnoreErrors());
       }
+      if (outerWin->DelayedCloseForPrinting()) {
+        outerWin->Close();
+      }
+    } else {
+      MOZ_ASSERT(!outerWin->DelayedCloseForPrinting());
     }
   }
 #endif
@@ -2225,20 +2231,6 @@
 }
 
 NS_IMETHODIMP
-nsDocumentViewer::RequestWindowClose(bool aIsPrintPending, bool* aCanClose) {
-  *aCanClose = true;
-
-#ifdef NS_PRINTING
-  if (aIsPrintPending || (mPrintJob && mPrintJob->GetIsPrinting())) {
-    *aCanClose = false;
-    mDeferredWindowClose = true;
-  }
-#endif
-
-  return NS_OK;
-}
-
-NS_IMETHODIMP
 nsDocumentViewer::ClearHistoryEntry() {
   if (mDocument) {
     nsJSContext::PokeGC(JS::GCReason::PAGE_HIDE,
@@ -3687,14 +3679,15 @@
       printJob->Destroy();
     }
 
-    // We are done printing, now cleanup. For non-print-preview jobs, we are
-    // actually responsible for cleaning up our whole <browser> or window (see
-    // the OPEN_PRINT_BROWSER code), so gotta run window.close() too.
+    // We are done printing, now clean up.
+    //
+    // For non-print-preview jobs, we are actually responsible for cleaning up
+    // our whole <browser> or window (see the OPEN_PRINT_BROWSER code), so gotta
+    // run window.close(), which will take care of this.
     //
     // For print preview jobs the front-end code is responsible for cleaning the
     // UI.
-    if (mDeferredWindowClose || !printJob->CreatedForPrintPreview()) {
-      mDeferredWindowClose = false;
+    if (!printJob->CreatedForPrintPreview()) {
       if (mContainer) {
         if (nsCOMPtr<nsPIDOMWindowOuter> win = mContainer->GetWindow()) {
           win->Close();