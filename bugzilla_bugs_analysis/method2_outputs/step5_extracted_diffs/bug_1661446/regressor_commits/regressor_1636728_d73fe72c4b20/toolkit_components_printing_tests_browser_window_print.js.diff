# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/printing/tests/browser_window_print.js
# Commit: d73fe72c4b20
# Full Hash: d73fe72c4b20a408d4c0559b7b1dd5d945f3d3b9
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-09-25 21:47:43
# Regressor Bug: 1636728
# File Overlap Count: 1
# Description:
#   Bug 1667342 - Make the "deferred window close" keep making sense after bug 1636728. r=smaug
#   
#   This was only being checked on OnDonePrinting() which isn't called in
#   the original docshell. Move it to the window because we don't need to
#   care about document viewers getting closed during print operations,
# ==============================================================================

diff -r 0bd98379fad4 -r d73fe72c4b20 toolkit/components/printing/tests/browser_window_print.js
--- a/toolkit/components/printing/tests/browser_window_print.js	Thu Sep 24 23:51:42 2020 +0000
+++ b/toolkit/components/printing/tests/browser_window_print.js	Fri Sep 25 13:39:01 2020 +0000
@@ -8,7 +8,7 @@
   "https://example.com"
 );
 
-add_task(async function test() {
+add_task(async function test_print_blocks() {
   // window.print() only shows print preview when print.tab_modal.enabled is
   // true.
   await SpecialPowers.pushPrefEnv({
@@ -74,3 +74,44 @@
     }
   );
 });
+
+add_task(async function test_print_delayed_during_load() {
+  // window.print() only shows print preview when print.tab_modal.enabled is
+  // true.
+  await SpecialPowers.pushPrefEnv({
+    set: [["print.tab_modal.enabled", true]],
+  });
+
+  is(
+    document.querySelector(".printPreviewBrowser"),
+    null,
+    "There shouldn't be any print preview browser"
+  );
+
+  await BrowserTestUtils.withNewTab(
+    `${TEST_PATH}file_window_print_delayed_during_load.html`,
+    async function(browser) {
+      info(
+        "Waiting for the first window.print() to run and ensure we're showing the preview..."
+      );
+
+      await BrowserTestUtils.waitForCondition(
+        () => !!document.querySelector(".printPreviewBrowser")
+      );
+
+      // The print dialog is open, should be open after onload.
+      {
+        let duringLoad = await SpecialPowers.spawn(browser, [], () => {
+          return !!content.document.getElementById("added-during-load");
+        });
+        ok(duringLoad, "Print should've been delayed");
+      }
+
+      gBrowser.getTabDialogBox(browser).abortAllDialogs();
+
+      is(typeof browser.isConnected, "boolean");
+      await BrowserTestUtils.waitForCondition(() => !browser.isConnected);
+      ok(true, "Tab should've been closed after printing");
+    }
+  );
+});