# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/webbrowserpersist/nsWebBrowserPersist.h
# Commit: 577001cf12ad
# Full Hash: 577001cf12adbb122a6618988616ef12ccb354d9
# Author: Gijs Kruitbosch <gijskruitbosch@gmail.com>
# Date: 2020-09-02 03:31:14
# Regressor Bug: 1658202
# File Overlap Count: 2
# Description:
#   Bug 1658202 - move flushes caused by closing the stream away from the main thread, r=valentin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D88731
# ==============================================================================

diff -r bc244bc15836 -r 577001cf12ad dom/webbrowserpersist/nsWebBrowserPersist.h
--- a/dom/webbrowserpersist/nsWebBrowserPersist.h	Tue Sep 01 07:18:38 2020 +0000
+++ b/dom/webbrowserpersist/nsWebBrowserPersist.h	Tue Sep 01 00:14:26 2020 +0000
@@ -31,6 +31,8 @@
 class nsIStorageStream;
 class nsIWebBrowserPersistDocument;
 
+using ClosePromise = mozilla::MozPromise<nsresult, nsresult, true>;
+
 class nsWebBrowserPersist final : public nsIInterfaceRequestor,
                                   public nsIWebBrowserPersist,
                                   public nsIStreamListener,
@@ -124,8 +126,9 @@
 
   nsresult FixRedirectedChannelEntry(nsIChannel* aNewChannel);
 
+  void FinishDownload();
   void EndDownload(nsresult aResult);
-  void FinishDownload();
+  void EndDownloadInternal(nsresult aResult);
   void SerializeNextFile();
   void CalcTotalProgress();
 
@@ -153,6 +156,7 @@
   nsClassHashtable<nsISupportsHashKey, OutputData> mOutputMap;
   nsClassHashtable<nsISupportsHashKey, UploadData> mUploadList;
   nsCOMPtr<nsISerialEventTarget> mBackgroundQueue;
+  nsTArray<RefPtr<ClosePromise>> mFileClosePromises;
   nsClassHashtable<nsCStringHashKey, URIData> mURIMap;
   nsCOMPtr<nsIWebBrowserPersistURIMap> mFlatURIMap;
   nsTArray<mozilla::UniquePtr<WalkData>> mWalkStack;
