# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/webbrowserpersist/nsWebBrowserPersist.h
# Commit: a8b3c33aee21
# Full Hash: a8b3c33aee2195643896a00a9ae69cfa1a849dc7
# Author: Gijs Kruitbosch <gijskruitbosch@gmail.com>
# Date: 2020-09-03 09:45:53
# Regressor Bug: 1658202
# File Overlap Count: 2
# Description:
#   Bug 1658202 - move flushes caused by closing the stream away from the main thread, r=valentin
#   
#   Depends on D88730
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D88731
# ==============================================================================

diff -r 1b44712c42dc -r a8b3c33aee21 dom/webbrowserpersist/nsWebBrowserPersist.h
--- a/dom/webbrowserpersist/nsWebBrowserPersist.h	Wed Sep 02 23:15:06 2020 +0000
+++ b/dom/webbrowserpersist/nsWebBrowserPersist.h	Wed Sep 02 23:15:21 2020 +0000
@@ -31,6 +31,8 @@
 class nsIStorageStream;
 class nsIWebBrowserPersistDocument;
 
+using ClosePromise = mozilla::MozPromise<nsresult, nsresult, true>;
+
 class nsWebBrowserPersist final : public nsIInterfaceRequestor,
                                   public nsIWebBrowserPersist,
                                   public nsIStreamListener,
@@ -124,8 +126,9 @@
 
   nsresult FixRedirectedChannelEntry(nsIChannel* aNewChannel);
 
+  void FinishDownload();
   void EndDownload(nsresult aResult);
-  void FinishDownload();
+  void EndDownloadInternal(nsresult aResult);
   void SerializeNextFile();
   void CalcTotalProgress();
 
@@ -153,6 +156,7 @@
   nsClassHashtable<nsISupportsHashKey, OutputData> mOutputMap;
   nsClassHashtable<nsISupportsHashKey, UploadData> mUploadList;
   nsCOMPtr<nsISerialEventTarget> mBackgroundQueue;
+  nsTArray<RefPtr<ClosePromise>> mFileClosePromises;
   nsClassHashtable<nsCStringHashKey, URIData> mURIMap;
   nsCOMPtr<nsIWebBrowserPersistURIMap> mFlatURIMap;
   nsTArray<mozilla::UniquePtr<WalkData>> mWalkStack;