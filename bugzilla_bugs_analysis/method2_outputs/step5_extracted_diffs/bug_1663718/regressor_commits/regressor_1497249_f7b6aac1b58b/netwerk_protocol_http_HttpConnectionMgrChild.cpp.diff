# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/HttpConnectionMgrChild.cpp
# Commit: f7b6aac1b58b
# Full Hash: f7b6aac1b58bc959e431136e1b23231abe55d0b1
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2020-07-16 21:27:37
# Regressor Bug: 1497249
# File Overlap Count: 4
# Description:
#   Bug 1497249 - P2: ipdl for nsIWebSocketConnection r=michal
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D30624
# ==============================================================================

diff -r 74bb3c2ab767 -r f7b6aac1b58b netwerk/protocol/http/HttpConnectionMgrChild.cpp
--- a/netwerk/protocol/http/HttpConnectionMgrChild.cpp	Thu Jul 16 12:59:23 2020 +0000
+++ b/netwerk/protocol/http/HttpConnectionMgrChild.cpp	Thu Jul 16 13:34:58 2020 +0000
@@ -11,6 +11,7 @@
 #include "HttpTransactionChild.h"
 #include "AltSvcTransactionChild.h"
 #include "EventTokenBucket.h"
+#include "mozilla/net/WebSocketConnectionChild.h"
 #include "nsHttpConnectionInfo.h"
 #include "nsHttpConnectionMgr.h"
 #include "nsHttpHandler.h"
@@ -177,5 +178,25 @@
   return IPC_OK();
 }
 
+already_AddRefed<PWebSocketConnectionChild>
+HttpConnectionMgrChild::AllocPWebSocketConnectionChild(
+    PHttpTransactionChild* aTransWithStickyConn) {
+  RefPtr<WebSocketConnectionChild> actor = new WebSocketConnectionChild();
+  return actor.forget();
+}
+
+mozilla::ipc::IPCResult
+HttpConnectionMgrChild::RecvPWebSocketConnectionConstructor(
+    PWebSocketConnectionChild* aActor,
+    PHttpTransactionChild* aTransWithStickyConn) {
+  RefPtr<WebSocketConnectionChild> child =
+      static_cast<WebSocketConnectionChild*>(aActor);
+  nsCOMPtr<nsIHttpUpgradeListener> listener =
+      static_cast<nsIHttpUpgradeListener*>(child.get());
+  Unused << mConnMgr->CompleteUpgrade(
+      ToRealHttpTransaction(aTransWithStickyConn), listener);
+  return IPC_OK();
+}
+
 }  // namespace net
 }  // namespace mozilla