# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/script/ScriptLoadRequest.cpp
# Commit: 294c4c7bb3e8
# Full Hash: 294c4c7bb3e8fbb73c07886da6ddc3ee6f5f4111
# Author: Denis Palmeiro <dpalmeiro@mozilla.com>
# Date: 2020-09-12 09:26:23
# Regressor Bug: 1652126
# File Overlap Count: 1
# Description:
#   Bug 1652126: Obtain an OffThreadToken immediately so parse tasks can be canceled anytime, and clean up dangling Runnables during cancellation.  r=smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D89465
# ==============================================================================

diff -r c50c7898c277 -r 294c4c7bb3e8 dom/script/ScriptLoadRequest.cpp
--- a/dom/script/ScriptLoadRequest.cpp	Fri Sep 11 15:27:51 2020 +0000
+++ b/dom/script/ScriptLoadRequest.cpp	Fri Sep 11 15:28:04 2020 +0000
@@ -58,6 +58,9 @@
 NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(ScriptLoadRequest)
   NS_IMPL_CYCLE_COLLECTION_UNLINK(mFetchOptions, mCacheInfo)
   tmp->mScript = nullptr;
+  if (Runnable* runnable = tmp->mRunnable.exchange(nullptr)) {
+    runnable->Release();
+  }
   tmp->DropBytecodeCacheReferences();
   tmp->MaybeUnblockOnload();
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
@@ -90,6 +93,7 @@
       mIsTracking(false),
       mFetchOptions(aFetchOptions),
       mOffThreadToken(nullptr),
+      mRunnable(nullptr),
       mScriptTextLength(0),
       mScriptBytecode(),
       mBytecodeOffset(0),
@@ -147,6 +151,14 @@
     MOZ_ASSERT(IsBytecode());
     JS::CancelOffThreadScriptDecoder(cx, mOffThreadToken);
   }
+
+  // Cancellation request above should guarantee removal of the parse task, so
+  // releasing the runnable should be safe to do here.
+  if (Runnable* runnable = mRunnable.exchange(nullptr)) {
+    runnable->Release();
+  }
+
+  MaybeUnblockOnload();
   mOffThreadToken = nullptr;
 }
 