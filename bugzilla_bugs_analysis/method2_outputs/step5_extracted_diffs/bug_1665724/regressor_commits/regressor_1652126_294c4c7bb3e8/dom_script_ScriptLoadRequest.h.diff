# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/script/ScriptLoadRequest.h
# Commit: 294c4c7bb3e8
# Full Hash: 294c4c7bb3e8fbb73c07886da6ddc3ee6f5f4111
# Author: Denis Palmeiro <dpalmeiro@mozilla.com>
# Date: 2020-09-12 09:26:23
# Regressor Bug: 1652126
# File Overlap Count: 1
# Description:
#   Bug 1652126: Obtain an OffThreadToken immediately so parse tasks can be canceled anytime, and clean up dangling Runnables during cancellation.  r=smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D89465
# ==============================================================================

diff -r c50c7898c277 -r 294c4c7bb3e8 dom/script/ScriptLoadRequest.h
--- a/dom/script/ScriptLoadRequest.h	Fri Sep 11 15:27:51 2020 +0000
+++ b/dom/script/ScriptLoadRequest.h	Fri Sep 11 15:28:04 2020 +0000
@@ -7,6 +7,7 @@
 #ifndef mozilla_dom_ScriptLoadRequest_h
 #define mozilla_dom_ScriptLoadRequest_h
 
+#include "mozilla/Atomics.h"
 #include "mozilla/Assertions.h"
 #include "mozilla/CORSMode.h"
 #include "mozilla/dom/Element.h"
@@ -324,6 +325,10 @@
   JS::OffThreadToken* mOffThreadToken;  // Off-thread parsing token.
   Maybe<nsString> mSourceMapURL;  // Holds source map url for loaded scripts
 
+  Atomic<Runnable*> mRunnable;  // Runnable created when dispatching off thread
+                                // compile. Tracked here so that it can be
+                                // properly released during cancellation.
+
   // Holds the top-level JSScript that corresponds to the current source, once
   // it is parsed, and planned to be saved in the bytecode cache.
   JS::Heap<JSScript*> mScript;