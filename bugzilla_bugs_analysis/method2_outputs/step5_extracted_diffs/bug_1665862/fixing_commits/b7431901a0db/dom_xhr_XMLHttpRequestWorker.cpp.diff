# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/xhr/XMLHttpRequestWorker.cpp
# Commit: b7431901a0db
# Full Hash: b7431901a0dbbfdd4803754e9ffb5113ecb80f3b
# Author: Kris Maglione <maglione.k@gmail.com>
# Date: 2020-09-22 03:47:42
# Description:
#   Bug 1665862: Don't use AutoSafeJSContext in XMLHttpRequestWorker. r=nika
#   
#   It crashes if it fails to create the unprivileged junk scope, which is not
#   great when it's being used by a fallible function.
#   
# ==============================================================================

diff -r bd174309203d -r b7431901a0db dom/xhr/XMLHttpRequestWorker.cpp
--- a/dom/xhr/XMLHttpRequestWorker.cpp	Tue Sep 22 00:44:39 2020 +0300
+++ b/dom/xhr/XMLHttpRequestWorker.cpp	Sat Sep 19 16:39:58 2020 +0000
@@ -898,7 +898,12 @@
   }
 
   {
-    AutoSafeJSContext cx;
+    AutoJSAPI jsapi;
+    JSObject* junkScope = xpc::UnprivilegedJunkScope(fallible);
+    if (!junkScope || !jsapi.Init(junkScope)) {
+      return NS_ERROR_FAILURE;
+    }
+    JSContext* cx = jsapi.cx();
 
     JS::Rooted<JS::Value> value(cx);
     if (!GetOrCreateDOMReflectorNoWrap(cx, mXHR, &value)) {
