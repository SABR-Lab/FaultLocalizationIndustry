# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/script/ScriptLoadRequest.h
# Commit: 554b7637fe60
# Full Hash: 554b7637fe60e8a57e5180b5daaa1441f1bea31b
# Author: Denis Palmeiro <dpalmeiro@mozilla.com>
# Date: 2020-05-13 03:44:05
# Regressor Bug: 1501608
# File Overlap Count: 1
# Description:
#   Bug 1501608 - Remove the ELEMENT_SLOT in the ScriptSourceObject and instead use a callback function to return the script element based on the value of the privateValue in the SSO. r=jonco,smaug
#   
#   We can reduce the size of the SSO by removing the element slot entirely, and instead retrieve the element through a callback function.  The callback will take in the value in the private slot of the SSO, which is either a LoadedScript* (from the browser) or a JSObject* (from the shell).  In addition, this removes the requirement of having a script dom element ready when parsing a JS script which can open up new opportunities for performance.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D70417
# ==============================================================================

diff -r 3470d926c02a -r 554b7637fe60 dom/script/ScriptLoadRequest.h
--- a/dom/script/ScriptLoadRequest.h	Tue May 12 09:40:48 2020 +0000
+++ b/dom/script/ScriptLoadRequest.h	Tue May 12 19:28:15 2020 +0000
@@ -9,6 +9,7 @@
 
 #include "mozilla/Assertions.h"
 #include "mozilla/CORSMode.h"
+#include "mozilla/dom/Element.h"
 #include "mozilla/dom/SRIMetadata.h"
 #include "mozilla/LinkedList.h"
 #include "mozilla/Maybe.h"
@@ -45,14 +46,13 @@
   NS_DECL_CYCLE_COLLECTION_NATIVE_CLASS(ScriptFetchOptions)
 
   ScriptFetchOptions(mozilla::CORSMode aCORSMode,
-                     enum ReferrerPolicy aReferrerPolicy,
-                     nsIScriptElement* aElement,
+                     enum ReferrerPolicy aReferrerPolicy, Element* aElement,
                      nsIPrincipal* aTriggeringPrincipal);
 
   const mozilla::CORSMode mCORSMode;
   const enum ReferrerPolicy mReferrerPolicy;
   bool mIsPreload;
-  nsCOMPtr<nsIScriptElement> mElement;
+  nsCOMPtr<Element> mElement;
   nsCOMPtr<nsIPrincipal> mTriggeringPrincipal;
 };
 
@@ -90,15 +90,15 @@
 
   void FireScriptAvailable(nsresult aResult) {
     bool isInlineClassicScript = mIsInline && !IsModuleRequest();
-    Element()->ScriptAvailable(aResult, Element(), isInlineClassicScript, mURI,
-                               mLineNo);
+    GetScriptElement()->ScriptAvailable(aResult, GetScriptElement(),
+                                        isInlineClassicScript, mURI, mLineNo);
   }
   void FireScriptEvaluated(nsresult aResult) {
-    Element()->ScriptEvaluated(aResult, Element(), mIsInline);
+    GetScriptElement()->ScriptEvaluated(aResult, GetScriptElement(), mIsInline);
   }
 
   bool IsPreload() const {
-    MOZ_ASSERT_IF(mFetchOptions->mIsPreload, !Element());
+    MOZ_ASSERT_IF(mFetchOptions->mIsPreload, !GetScriptElement());
     return mFetchOptions->mIsPreload;
   }
 
@@ -242,14 +242,18 @@
   enum ReferrerPolicy ReferrerPolicy() const {
     return mFetchOptions->mReferrerPolicy;
   }
-  nsIScriptElement* Element() const { return mFetchOptions->mElement; }
+  nsIScriptElement* GetScriptElement() const {
+    nsCOMPtr<nsIScriptElement> scriptElement =
+        do_QueryInterface(mFetchOptions->mElement);
+    return scriptElement;
+  }
   nsIPrincipal* TriggeringPrincipal() const {
     return mFetchOptions->mTriggeringPrincipal;
   }
 
   // Make this request a preload (speculative) request.
   void SetIsPreloadRequest() {
-    MOZ_ASSERT(!Element());
+    MOZ_ASSERT(!GetScriptElement());
     MOZ_ASSERT(!IsPreload());
     mFetchOptions->mIsPreload = true;
   }
@@ -257,14 +261,14 @@
   // Make a preload request into an actual load request for the given element.
   void SetIsLoadRequest(nsIScriptElement* aElement) {
     MOZ_ASSERT(aElement);
-    MOZ_ASSERT(!Element());
+    MOZ_ASSERT(!GetScriptElement());
     MOZ_ASSERT(IsPreload());
-    mFetchOptions->mElement = aElement;
+    mFetchOptions->mElement = do_QueryInterface(aElement);
     mFetchOptions->mIsPreload = false;
   }
 
   FromParser GetParserCreated() const {
-    nsIScriptElement* element = Element();
+    nsIScriptElement* element = GetScriptElement();
     if (!element) {
       return NOT_FROM_PARSER;
     }