# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/public/CompileOptions.h
# Commit: 554b7637fe60
# Full Hash: 554b7637fe60e8a57e5180b5daaa1441f1bea31b
# Author: Denis Palmeiro <dpalmeiro@mozilla.com>
# Date: 2020-05-13 03:44:05
# Regressor Bug: 1501608
# File Overlap Count: 1
# Description:
#   Bug 1501608 - Remove the ELEMENT_SLOT in the ScriptSourceObject and instead use a callback function to return the script element based on the value of the privateValue in the SSO. r=jonco,smaug
#   
#   We can reduce the size of the SSO by removing the element slot entirely, and instead retrieve the element through a callback function.  The callback will take in the value in the private slot of the SSO, which is either a LoadedScript* (from the browser) or a JSObject* (from the shell).  In addition, this removes the requirement of having a script dom element ready when parsing a JS script which can open up new opportunities for performance.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D70417
# ==============================================================================

diff -r 3470d926c02a -r 554b7637fe60 js/public/CompileOptions.h
--- a/js/public/CompileOptions.h	Tue May 12 09:40:48 2020 +0000
+++ b/js/public/CompileOptions.h	Tue May 12 19:28:15 2020 +0000
@@ -61,6 +61,7 @@
 #include "jstypes.h"  // JS_PUBLIC_API
 
 #include "js/RootingAPI.h"  // JS::PersistentRooted, JS::Rooted
+#include "js/Value.h"
 
 struct JS_PUBLIC_API JSContext;
 class JS_PUBLIC_API JSObject;
@@ -161,7 +162,7 @@
   const char* filename() const { return filename_; }
   const char* introducerFilename() const { return introducerFilename_; }
   const char16_t* sourceMapURL() const { return sourceMapURL_; }
-  virtual JSObject* element() const = 0;
+  virtual Value privateValue() const = 0;
   virtual JSString* elementAttributeName() const = 0;
   virtual JSScript* introductionScript() const = 0;
 
@@ -232,17 +233,17 @@
  * anything else it entrains, will never be freed.
  */
 class JS_PUBLIC_API OwningCompileOptions final : public ReadOnlyCompileOptions {
-  PersistentRooted<JSObject*> elementRoot;
   PersistentRooted<JSString*> elementAttributeNameRoot;
   PersistentRooted<JSScript*> introductionScriptRoot;
   PersistentRooted<JSScript*> scriptOrModuleRoot;
+  PersistentRooted<Value> privateValueRoot;
 
  public:
   // A minimal constructor, for use with OwningCompileOptions::copy.
   explicit OwningCompileOptions(JSContext* cx);
   ~OwningCompileOptions();
 
-  JSObject* element() const override { return elementRoot; }
+  Value privateValue() const override { return privateValueRoot; }
   JSString* elementAttributeName() const override {
     return elementAttributeNameRoot;
   }
@@ -273,10 +274,10 @@
 class MOZ_STACK_CLASS JS_PUBLIC_API CompileOptions final
     : public ReadOnlyCompileOptions {
  private:
-  Rooted<JSObject*> elementRoot;
   Rooted<JSString*> elementAttributeNameRoot;
   Rooted<JSScript*> introductionScriptRoot;
   Rooted<JSScript*> scriptOrModuleRoot;
+  Rooted<Value> privateValueRoot;
 
  public:
   // Default options determined using the JSContext.
@@ -286,23 +287,23 @@
   // options object.
   CompileOptions(JSContext* cx, const ReadOnlyCompileOptions& rhs)
       : ReadOnlyCompileOptions(),
-        elementRoot(cx),
         elementAttributeNameRoot(cx),
         introductionScriptRoot(cx),
-        scriptOrModuleRoot(cx) {
+        scriptOrModuleRoot(cx),
+        privateValueRoot(cx) {
     copyPODNonTransitiveOptions(rhs);
     copyPODTransitiveOptions(rhs);
 
     filename_ = rhs.filename();
     introducerFilename_ = rhs.introducerFilename();
     sourceMapURL_ = rhs.sourceMapURL();
-    elementRoot = rhs.element();
+    privateValueRoot = rhs.privateValue();
     elementAttributeNameRoot = rhs.elementAttributeName();
     introductionScriptRoot = rhs.introductionScript();
     scriptOrModuleRoot = rhs.scriptOrModule();
   }
 
-  JSObject* element() const override { return elementRoot; }
+  Value privateValue() const override { return privateValueRoot; }
 
   JSString* elementAttributeName() const override {
     return elementAttributeNameRoot;
@@ -335,8 +336,8 @@
     return *this;
   }
 
-  CompileOptions& setElement(JSObject* e) {
-    elementRoot = e;
+  CompileOptions& setPrivateValue(const Value& v) {
+    privateValueRoot = v;
     return *this;
   }
 