# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/JSScript.cpp
# Commit: 554b7637fe60
# Full Hash: 554b7637fe60e8a57e5180b5daaa1441f1bea31b
# Author: Denis Palmeiro <dpalmeiro@mozilla.com>
# Date: 2020-05-13 03:44:05
# Regressor Bug: 1501608
# File Overlap Count: 1
# Description:
#   Bug 1501608 - Remove the ELEMENT_SLOT in the ScriptSourceObject and instead use a callback function to return the script element based on the value of the privateValue in the SSO. r=jonco,smaug
#   
#   We can reduce the size of the SSO by removing the element slot entirely, and instead retrieve the element through a callback function.  The callback will take in the value in the private slot of the SSO, which is either a LoadedScript* (from the browser) or a JSObject* (from the shell).  In addition, this removes the requirement of having a script dom element ready when parsing a JS script which can open up new opportunities for performance.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D70417
# ==============================================================================

diff -r 3470d926c02a -r 554b7637fe60 js/src/vm/JSScript.cpp
--- a/js/src/vm/JSScript.cpp	Tue May 12 09:40:48 2020 +0000
+++ b/js/src/vm/JSScript.cpp	Tue May 12 19:28:15 2020 +0000
@@ -1607,7 +1607,6 @@
   // The slots below should either be populated by a call to initFromOptions or,
   // if this is a non-canonical ScriptSourceObject, they are unused. Poison
   // them.
-  obj->initReservedSlot(ELEMENT_SLOT, MagicValue(JS_GENERIC_MAGIC));
   obj->initReservedSlot(ELEMENT_PROPERTY_SLOT, MagicValue(JS_GENERIC_MAGIC));
   obj->initReservedSlot(INTRODUCTION_SCRIPT_SLOT, MagicValue(JS_GENERIC_MAGIC));
 
@@ -1676,7 +1675,6 @@
     const ReadOnlyCompileOptions& options) {
   cx->releaseCheck(source);
   MOZ_ASSERT(source->isCanonical());
-  MOZ_ASSERT(source->getReservedSlot(ELEMENT_SLOT).isMagic(JS_GENERIC_MAGIC));
   MOZ_ASSERT(
       source->getReservedSlot(ELEMENT_PROPERTY_SLOT).isMagic(JS_GENERIC_MAGIC));
   MOZ_ASSERT(source->getReservedSlot(INTRODUCTION_SCRIPT_SLOT)
@@ -1686,9 +1684,8 @@
     return false;
   }
 
-  RootedObject element(cx, options.element());
   RootedString elementAttributeName(cx, options.elementAttributeName());
-  if (!initElementProperties(cx, source, element, elementAttributeName)) {
+  if (!initElementProperties(cx, source, elementAttributeName)) {
     return false;
   }
 
@@ -1704,11 +1701,18 @@
   }
   source->setReservedSlot(INTRODUCTION_SCRIPT_SLOT, introductionScript);
 
-  // Set the private value to that of the script or module that this source is
-  // part of, if any.
-  RootedValue privateValue(cx);
-  if (JSScript* script = options.scriptOrModule()) {
-    privateValue = script->sourceObject()->canonicalPrivate();
+  RootedValue privateValue(cx, UndefinedValue());
+  if (options.privateValue().isUndefined()) {
+    // Set the private value to that of the script or module that this source is
+    // part of, if any.
+    if (JSScript* script = options.scriptOrModule()) {
+      privateValue = script->sourceObject()->canonicalPrivate();
+    }
+  } else {
+    privateValue = options.privateValue();
+  }
+
+  if (!privateValue.isUndefined()) {
     if (!JS_WrapValue(cx, &privateValue)) {
       return false;
     }
@@ -1721,15 +1725,9 @@
 /* static */
 bool ScriptSourceObject::initElementProperties(JSContext* cx,
                                                HandleScriptSourceObject source,
-                                               HandleObject element,
                                                HandleString elementAttrName) {
   MOZ_ASSERT(source->isCanonical());
 
-  RootedValue elementValue(cx, ObjectOrNullValue(element));
-  if (!cx->compartment()->wrap(cx, &elementValue)) {
-    return false;
-  }
-
   RootedValue nameValue(cx);
   if (elementAttrName) {
     nameValue = StringValue(elementAttrName);
@@ -1738,7 +1736,6 @@
     return false;
   }
 
-  source->setReservedSlot(ELEMENT_SLOT, elementValue);
   source->setReservedSlot(ELEMENT_PROPERTY_SLOT, nameValue);
 
   return true;
@@ -1755,6 +1752,16 @@
   rt->addRefScriptPrivate(value);
 }
 
+JSObject* ScriptSourceObject::unwrappedElement(JSContext* cx) const {
+  JS::RootedValue privateValue(cx, unwrappedCanonical()->canonicalPrivate());
+  if (privateValue.isUndefined()) {
+    return nullptr;
+  }
+
+  MOZ_ASSERT(cx->runtime()->getElementCallback);
+  return (*cx->runtime()->getElementCallback)(cx, privateValue);
+}
+
 class ScriptSource::LoadSourceMatcher {
   JSContext* const cx_;
   ScriptSource* const ss_;