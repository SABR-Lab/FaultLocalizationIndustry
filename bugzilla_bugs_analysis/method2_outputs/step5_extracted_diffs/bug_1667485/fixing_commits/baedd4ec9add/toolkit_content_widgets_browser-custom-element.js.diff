# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: toolkit/content/widgets/browser-custom-element.js
# Commit: baedd4ec9add
# Full Hash: baedd4ec9add5edf5d78168eb46b570fb1edcaf2
# Author: Kris Maglione <maglione.k@gmail.com>
# Date: 2020-10-06 04:10:51
# Description:
#   Bug 1667485: Fix inifinite nested event loop spinning in corner cases. r=nika
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D91886
# ==============================================================================

diff -r 9e904ebcedef -r baedd4ec9add toolkit/content/widgets/browser-custom-element.js
--- a/toolkit/content/widgets/browser-custom-element.js	Tue Oct 06 00:05:00 2020 +0300
+++ b/toolkit/content/widgets/browser-custom-element.js	Mon Oct 05 17:57:48 2020 +0000
@@ -1758,7 +1758,12 @@
           }
         );
 
-        Services.tm.spinEventLoopUntilOrShutdown(() => success !== undefined);
+        // The permitUnload() promise will, alas, not call its resolution
+        // callbacks after the browser window the promise lives in has closed,
+        // so we have to check for that case explicitly.
+        Services.tm.spinEventLoopUntilOrShutdown(
+          () => window.closed || success !== undefined
+        );
         if (success) {
           return result;
         }
