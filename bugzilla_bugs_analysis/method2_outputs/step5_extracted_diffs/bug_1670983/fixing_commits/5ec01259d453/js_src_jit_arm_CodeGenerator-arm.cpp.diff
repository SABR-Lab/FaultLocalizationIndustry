# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/src/jit/arm/CodeGenerator-arm.cpp
# Commit: 5ec01259d453
# Full Hash: 5ec01259d453bbade989a5d5abd399263bf08fb3
# Author: Lars T Hansen <lhansen@mozilla.com>
# Date: 2020-10-14 16:38:28
# Description:
#   Bug 1670983 - Preserve Tls register across callouts to soft div/mod. r=nbp
#   
#   Soft div/mod are supported on ARMv7 with Ion, and the callouts need to
#   preserve the Tls register and pass the Tls register offset to
#   callWithABI.
# ==============================================================================

diff -r 0a6dbd35674b -r 5ec01259d453 js/src/jit/arm/CodeGenerator-arm.cpp
--- a/js/src/jit/arm/CodeGenerator-arm.cpp	Fri Oct 09 12:24:28 2020 +0000
+++ b/js/src/jit/arm/CodeGenerator-arm.cpp	Wed Oct 14 13:33:17 2020 +0000
@@ -585,11 +585,16 @@
   divICommon(mir, lhs, rhs, output, ins->snapshot(), done);
 
   if (gen->compilingWasm()) {
+    masm.Push(WasmTlsReg);
+    int32_t framePushedAfterTls = masm.framePushed();
     masm.setupWasmABICall();
     masm.passABIArg(lhs);
     masm.passABIArg(rhs);
+    int32_t tlsOffset = masm.framePushed() - framePushedAfterTls;
     masm.callWithABI(mir->bytecodeOffset(),
-                     wasm::SymbolicAddress::aeabi_idivmod, mozilla::Nothing());
+                     wasm::SymbolicAddress::aeabi_idivmod,
+                     mozilla::Some(tlsOffset));
+    masm.Pop(WasmTlsReg);
   } else {
     using Fn = int64_t (*)(int, int);
     masm.setupAlignedABICall();
@@ -775,11 +780,16 @@
   modICommon(mir, lhs, rhs, output, ins->snapshot(), done);
 
   if (gen->compilingWasm()) {
+    masm.Push(WasmTlsReg);
+    int32_t framePushedAfterTls = masm.framePushed();
     masm.setupWasmABICall();
     masm.passABIArg(lhs);
     masm.passABIArg(rhs);
+    int32_t tlsOffset = masm.framePushed() - framePushedAfterTls;
     masm.callWithABI(mir->bytecodeOffset(),
-                     wasm::SymbolicAddress::aeabi_idivmod, mozilla::Nothing());
+                     wasm::SymbolicAddress::aeabi_idivmod,
+                     mozilla::Some(tlsOffset));
+    masm.Pop(WasmTlsReg);
   } else {
     using Fn = int64_t (*)(int, int);
     masm.setupAlignedABICall();
@@ -2258,13 +2268,17 @@
   generateUDivModZeroCheck(rhs, output, &done, ins->snapshot(), mod);
 
   if (gen->compilingWasm()) {
+    masm.Push(WasmTlsReg);
+    int32_t framePushedAfterTls = masm.framePushed();
     masm.setupWasmABICall();
     masm.passABIArg(lhs);
     masm.passABIArg(rhs);
     wasm::BytecodeOffset bytecodeOffset =
         (div ? div->bytecodeOffset() : mod->bytecodeOffset());
+    int32_t tlsOffset = masm.framePushed() - framePushedAfterTls;
     masm.callWithABI(bytecodeOffset, wasm::SymbolicAddress::aeabi_uidivmod,
-                     mozilla::Nothing());
+                     mozilla::Some(tlsOffset));
+    masm.Pop(WasmTlsReg);
   } else {
     using Fn = int64_t (*)(int, int);
     masm.setupAlignedABICall();
