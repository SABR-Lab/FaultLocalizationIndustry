# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/nsHttpChannel.cpp
# Commit: aaf5c5213d8d
# Full Hash: aaf5c5213d8db7c9344e8517ae934c55f937e07e
# Author: Christoph Kerschbaumer <ckerschb@christophkerschbaumer.com>
# Date: 2020-10-08 09:49:50
# Regressor Bug: 1665062
# File Overlap Count: 1
# Description:
#   Bug 1665062: HTTPS-Only: Upgraded website creating HTTP auth prompt gets interrupted by error-page r=necko-reviewers,dragana,JulianWels
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D91908
# ==============================================================================

diff -r e4b87a2e0f2c -r aaf5c5213d8d netwerk/protocol/http/nsHttpChannel.cpp
--- a/netwerk/protocol/http/nsHttpChannel.cpp	Tue Oct 06 12:51:16 2020 +0000
+++ b/netwerk/protocol/http/nsHttpChannel.cpp	Wed Oct 07 11:47:07 2020 +0000
@@ -356,6 +356,7 @@
       mCacheOpenWithPriority(false),
       mCacheQueueSizeWhenOpen(0),
       mCachedContentIsValid(false),
+      mIsAuthChannel(false),
       mAuthRetryPending(false),
       mCachedContentIsPartial(false),
       mCacheOnlyMetadata(false),
@@ -2874,6 +2875,7 @@
       if (rv == NS_ERROR_IN_PROGRESS) {
         // authentication prompt has been invoked and result
         // is expected asynchronously
+        mIsAuthChannel = true;
         mAuthRetryPending = true;
         if (httpStatus == 407 ||
             (mTransaction && mTransaction->ProxyConnectFailed()))
@@ -2903,6 +2905,7 @@
         }
         rv = ProcessNormal();
       } else {
+        mIsAuthChannel = true;
         mAuthRetryPending = true;  // see DoAuthRetry
       }
       break;
@@ -6221,6 +6224,7 @@
   // setting mAuthRetryPending flag and resuming the transaction
   // triggers process of throwing away the unauthenticated data already
   // coming from the network
+  mIsAuthChannel = true;
   mAuthRetryPending = true;
   mProxyAuthPending = false;
   LOG(("Resuming the transaction, we got credentials from user"));
@@ -7249,6 +7253,12 @@
 }
 
 NS_IMETHODIMP
+nsHttpChannel::GetIsAuthChannel(bool* aIsAuthChannel) {
+  *aIsAuthChannel = mIsAuthChannel;
+  return NS_OK;
+}
+
+NS_IMETHODIMP
 nsHttpChannel::SetChannelIsForDownload(bool aChannelIsForDownload) {
   if (aChannelIsForDownload) {
     AddClassFlags(nsIClassOfService::Throttleable);