# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/ipc/RemoteAudioDecoder.cpp
# Commit: 9e0809ed54cd
# Full Hash: 9e0809ed54cd2da0e3ebbb0bb143f85bb6ad6b14
# Author: Dan Glastonbury <dan.glastonbury@gmail.com>
# Date: 2020-10-21 09:51:28
# Regressor Bug: 1595994
# File Overlap Count: 1
# Description:
#   Bug 1595994 - P4: Use PDMFactory to create decoders in RDD & GPU process. r=kamidphish
#   
#   Depends on D54876
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D54875
# ==============================================================================

diff -r e3f920da2232 -r 9e0809ed54cd dom/media/ipc/RemoteAudioDecoder.cpp
--- a/dom/media/ipc/RemoteAudioDecoder.cpp	Tue Oct 20 23:24:27 2020 +0000
+++ b/dom/media/ipc/RemoteAudioDecoder.cpp	Tue Oct 20 23:24:40 2020 +0000
@@ -6,10 +6,9 @@
 #include "RemoteAudioDecoder.h"
 
 #include "MediaDataDecoderProxy.h"
-#include "OpusDecoder.h"
+#include "PDMFactory.h"
 #include "RemoteDecoderManagerChild.h"
-#include "VorbisDecoder.h"
-#include "WAVDecoder.h"
+#include "RemoteDecoderManagerParent.h"
 #include "mozilla/PodOperations.h"
 
 namespace mozilla {
@@ -70,19 +69,12 @@
     bool* aSuccess, nsCString* aErrorDescription)
     : RemoteDecoderParent(aParent, aManagerThread, aDecodeTaskQueue),
       mAudioInfo(aAudioInfo) {
-  CreateDecoderParams params(mAudioInfo);
-  params.mOptions = aOptions;
   MediaResult error(NS_OK);
-  params.mError = &error;
+  auto params = CreateDecoderParams{
+      mAudioInfo, aOptions, CreateDecoderParams::NoWrapper(true), &error};
 
-  RefPtr<MediaDataDecoder> decoder;
-  if (VorbisDataDecoder::IsVorbis(params.mConfig.mMimeType)) {
-    decoder = new VorbisDataDecoder(params);
-  } else if (OpusDataDecoder::IsOpus(params.mConfig.mMimeType)) {
-    decoder = new OpusDataDecoder(params);
-  } else if (WaveDataDecoder::IsWave(params.mConfig.mMimeType)) {
-    decoder = new WaveDataDecoder(params);
-  }
+  auto& factory = aParent->EnsurePDMFactory();
+  RefPtr<MediaDataDecoder> decoder = factory.CreateDecoder(params);
 
   if (NS_FAILED(error)) {
     MOZ_ASSERT(aErrorDescription);