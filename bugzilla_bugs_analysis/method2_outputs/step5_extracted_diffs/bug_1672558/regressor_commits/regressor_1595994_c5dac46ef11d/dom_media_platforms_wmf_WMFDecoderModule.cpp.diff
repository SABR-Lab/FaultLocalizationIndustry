# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/platforms/wmf/WMFDecoderModule.cpp
# Commit: c5dac46ef11d
# Full Hash: c5dac46ef11d44762d5eb61610e58f4d52aec88d
# Author: Dan Glastonbury <dan.glastonbury@gmail.com>
# Date: 2020-10-21 09:51:28
# Regressor Bug: 1595994
# File Overlap Count: 1
# Description:
#   Bug 1595994 - PA: Delete GPUDecoderModule wrapper. r=mattwoodrow
#   
#   Moved support logic into WMFDecoderModule.
#   
#   Depends on D54882
# ==============================================================================

diff -r fca05e774f88 -r c5dac46ef11d dom/media/platforms/wmf/WMFDecoderModule.cpp
--- a/dom/media/platforms/wmf/WMFDecoderModule.cpp	Tue Oct 20 23:26:33 2020 +0000
+++ b/dom/media/platforms/wmf/WMFDecoderModule.cpp	Tue Oct 20 23:26:38 2020 +0000
@@ -60,6 +60,18 @@
   }
 }
 
+static bool IsRemoteAcceleratedCompositor(const SupportDecoderParams& aParams) {
+  if (!aParams.mKnowsCompositor) {
+    return false;
+  }
+
+  TextureFactoryIdentifier ident =
+      aParams.mKnowsCompositor->GetTextureFactoryIdentifier();
+  return ident.mParentBackend != LayersBackend::LAYERS_BASIC &&
+         !ident.mUsingSoftwareWebRender &&
+         ident.mParentProcessType == GeckoProcessType_GPU;
+}
+
 static bool CanCreateMFTDecoder(const GUID& aGuid) {
   // The IMFTransform interface used by MFTDecoder is documented to require to
   // run on an MTA thread.
@@ -229,6 +241,12 @@
 
 bool WMFDecoderModule::Supports(const SupportDecoderParams& aParams,
                                 DecoderDoctorDiagnostics* aDiagnostics) const {
+  // In GPU process, only support decoding if an accelerated compositor is
+  // known.
+  if (XRE_IsGPUProcess() && !IsRemoteAcceleratedCompositor(aParams)) {
+    return false;
+  }
+
   const auto& trackInfo = aParams.mConfig;
   const auto* videoInfo = trackInfo.GetAsVideoInfo();
   if (videoInfo && !SupportsColorDepth(videoInfo->mColorDepth, aDiagnostics)) {
