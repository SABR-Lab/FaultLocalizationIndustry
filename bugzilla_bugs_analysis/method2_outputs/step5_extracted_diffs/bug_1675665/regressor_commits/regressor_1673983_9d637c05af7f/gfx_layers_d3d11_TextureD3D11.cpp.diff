# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/layers/d3d11/TextureD3D11.cpp
# Commit: 9d637c05af7f
# Full Hash: 9d637c05af7f8c39af78b290335ca55994849ee8
# Author: Matt Woodrow <mwoodrow@mozilla.com>
# Date: 2020-11-06 04:14:34
# Regressor Bug: 1673983
# File Overlap Count: 2
# Description:
#   Bug 1673983 - Add RenderTextureHostSWGL support to D3D11 RenderTextureHosts. r=lsalzman
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D95799
# ==============================================================================

diff -r ea88b243717a -r 9d637c05af7f gfx/layers/d3d11/TextureD3D11.cpp
--- a/gfx/layers/d3d11/TextureD3D11.cpp	Fri Nov 06 00:00:47 2020 +0000
+++ b/gfx/layers/d3d11/TextureD3D11.cpp	Fri Nov 06 00:01:36 2020 +0000
@@ -999,12 +999,6 @@
     MOZ_ASSERT_UNREACHABLE("unexpected to be called without ANGLE");
     return;
   }
-  // XXX Software WebRender is not handled yet.
-  if (gfx::gfxVars::UseSoftwareWebRender()) {
-    gfxCriticalNoteOnce
-        << "Software WebRender is not suppored by DXGITextureHostD3D11.";
-    return;
-  }
 
   MOZ_ASSERT(mHandle);
   auto method = aOp == TextureHost::ADD_IMAGE
@@ -1019,7 +1013,10 @@
 
       wr::ImageDescriptor descriptor(mSize, GetFormat());
       auto imageType =
-          wr::ExternalImageType::TextureHandle(wr::TextureTarget::External);
+          gfx::gfxVars::UseSoftwareWebRender()
+              ? wr::ExternalImageType::TextureHandle(wr::TextureTarget::Rect)
+              : wr::ExternalImageType::TextureHandle(
+                    wr::TextureTarget::External);
       (aResources.*method)(aImageKeys[0], descriptor, aExtID, imageType, 0);
       break;
     }
@@ -1038,7 +1035,10 @@
                                           ? gfx::SurfaceFormat::R8G8
                                           : gfx::SurfaceFormat::R16G16);
       auto imageType =
-          wr::ExternalImageType::TextureHandle(wr::TextureTarget::External);
+          gfx::gfxVars::UseSoftwareWebRender()
+              ? wr::ExternalImageType::TextureHandle(wr::TextureTarget::Rect)
+              : wr::ExternalImageType::TextureHandle(
+                    wr::TextureTarget::External);
       (aResources.*method)(aImageKeys[0], descriptor0, aExtID, imageType, 0);
       (aResources.*method)(aImageKeys[1], descriptor1, aExtID, imageType, 1);
       break;
@@ -1059,12 +1059,6 @@
     MOZ_ASSERT_UNREACHABLE("unexpected to be called without ANGLE");
     return;
   }
-  // XXX Software WebRender is not handled yet.
-  if (gfx::gfxVars::UseSoftwareWebRender()) {
-    gfxCriticalNoteOnce
-        << "Software WebRender is not suppored by DXGITextureHostD3D11.";
-    return;
-  }
 
   switch (GetFormat()) {
     case gfx::SurfaceFormat::R8G8B8X8:
@@ -1256,8 +1250,8 @@
 
 void DXGIYCbCrTextureHostD3D11::CreateRenderTexture(
     const wr::ExternalImageId& aExternalImageId) {
-  RefPtr<wr::RenderTextureHost> texture =
-      new wr::RenderDXGIYCbCrTextureHost(mHandles, mSizeY, mSizeCbCr);
+  RefPtr<wr::RenderTextureHost> texture = new wr::RenderDXGIYCbCrTextureHost(
+      mHandles, mYUVColorSpace, mColorDepth, mSizeY, mSizeCbCr);
 
   wr::RenderThread::Get()->RegisterExternalImage(wr::AsUint64(aExternalImageId),
                                                  texture.forget());
@@ -1275,12 +1269,6 @@
     MOZ_ASSERT_UNREACHABLE("unexpected to be called without ANGLE");
     return;
   }
-  // XXX Software WebRender is not handled yet.
-  if (gfx::gfxVars::UseSoftwareWebRender()) {
-    gfxCriticalNoteOnce
-        << "Software WebRender is not suppored by DXGIYCbCrTextureHostD3D11.";
-    return;
-  }
 
   MOZ_ASSERT(mHandles[0] && mHandles[1] && mHandles[2]);
   MOZ_ASSERT(aImageKeys.length() == 3);
@@ -1294,7 +1282,9 @@
                     ? &wr::TransactionBuilder::AddExternalImage
                     : &wr::TransactionBuilder::UpdateExternalImage;
   auto imageType =
-      wr::ExternalImageType::TextureHandle(wr::TextureTarget::External);
+      gfx::gfxVars::UseSoftwareWebRender()
+          ? wr::ExternalImageType::TextureHandle(wr::TextureTarget::Rect)
+          : wr::ExternalImageType::TextureHandle(wr::TextureTarget::External);
 
   // y
   wr::ImageDescriptor descriptor0(mSizeY, gfx::SurfaceFormat::A8);
@@ -1313,12 +1303,6 @@
     MOZ_ASSERT_UNREACHABLE("unexpected to be called without ANGLE");
     return;
   }
-  // XXX Software WebRender is not handled yet.
-  if (gfx::gfxVars::UseSoftwareWebRender()) {
-    gfxCriticalNoteOnce
-        << "Software WebRender is not suppored by DXGIYCbCrTextureHostD3D11.";
-    return;
-  }
 
   MOZ_ASSERT(aImageKeys.length() == 3);
 