# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/Http3Session.cpp
# Commit: f2b938e5d8b1
# Full Hash: f2b938e5d8b108dcfb2d5cb972c6884c3ba1e790
# Author: Dragana Damjanovic <dd.mozilla@gmail.com>
# Date: 2020-11-14 09:46:25
# Description:
#   Bug 1676851 - Make sure to return NS_BASE_STREAM_WOULD_BLOCK if number of read/written bytes to neqo stream is 0. r=necko-reviewers,valentin
#   
#   If NS_OK is return, nsBufferedInputStream::ReadSegments may loop.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D96996
# ==============================================================================

diff -r 7a8e1e203b11 -r f2b938e5d8b1 netwerk/protocol/http/Http3Session.cpp
--- a/netwerk/protocol/http/Http3Session.cpp	Fri Nov 13 22:59:30 2020 +0100
+++ b/netwerk/protocol/http/Http3Session.cpp	Fri Nov 13 21:26:14 2020 +0000
@@ -822,9 +822,13 @@
   } else if (NS_FAILED(rv)) {
     // Ignore this error. This may happen if some events are not handled yet.
     // TODO we may try to add an assertion here.
-    rv = NS_OK;
+    // We will pretend that sender is blocked, that will cause the caller to
+    // stop trying.
+    *countRead = 0;
+    rv = NS_BASE_STREAM_WOULD_BLOCK;
   }
 
+  MOZ_ASSERT((*countRead != 0) || NS_FAILED(rv));
   return rv;
 }
 
@@ -1370,9 +1374,13 @@
           " [this=%p]",
           static_cast<uint32_t>(rv), this));
     // This error will be handled by neqo and the whole connection will be
-    // cloed. We will return NS_BASE_STREAM_WOULD_BLOCK here.
+    // closed. We will return NS_BASE_STREAM_WOULD_BLOCK here.
+    *aCountWritten = 0;
+    *aFin = false;
     rv = NS_BASE_STREAM_WOULD_BLOCK;
   }
+
+  MOZ_ASSERT((*aCountWritten != 0) || aFin || NS_FAILED(rv));
   return rv;
 }
 