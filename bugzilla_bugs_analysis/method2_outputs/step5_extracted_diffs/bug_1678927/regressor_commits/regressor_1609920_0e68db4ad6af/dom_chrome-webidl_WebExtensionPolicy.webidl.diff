# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/chrome-webidl/WebExtensionPolicy.webidl
# Commit: 0e68db4ad6af
# Full Hash: 0e68db4ad6afe1f43d97533316d80e5aadd96082
# Author: Luca Greco <lgreco@mozilla.com>
# Date: 2020-07-01 21:32:12
# Regressor Bug: 1609920
# File Overlap Count: 2
# Description:
#   Bug 1609920 - part 1: Allow the WebExtension Framework to register a moz-extension service worker. r=dom-workers-and-storage-reviewers,asuth,mixedpuppy
#   
#   - Adds the new about:config pref "extensions.backgroundServiceWorker.enabled" (currently defaults to false).
#   - Adds the background.service_worker property to the manifest JSON schema definition
#   - Locks background.service_worker manifest property behind the new preference
# ==============================================================================

diff -r 2a107eabe00c -r 0e68db4ad6af dom/chrome-webidl/WebExtensionPolicy.webidl
--- a/dom/chrome-webidl/WebExtensionPolicy.webidl	Mon Jun 29 16:18:44 2020 +0000
+++ b/dom/chrome-webidl/WebExtensionPolicy.webidl	Wed Jun 10 12:13:29 2020 +0000
@@ -117,6 +117,19 @@
   static readonly attribute boolean isExtensionProcess;
 
   /**
+   * Whether the background.service_worker in the extension manifest.json file
+   * is enabled.
+   *
+   * NOTE: **do not use Services.prefs to retrieve the value of the undelying pref**
+   *
+   * It is defined in StaticPrefs.yaml as `mirror: once` and so checking
+   * its current value using Services.prefs doesn't guarantee that it does
+   * match the value as accessible from the C++ layers, and unexpected issue
+   * may be possible if different code has a different idea of its value.
+   */
+  static readonly attribute boolean backgroundServiceWorkerEnabled;
+
+  /**
    * Set based on the manifest.incognito value:
    * If "spanning" or "split" will be true.
    * If "not_allowed" will be false.
@@ -222,6 +235,12 @@
    * type.
    */
   readonly attribute object? readyPromise;
+
+  /**
+   * Returns true if the given worker script URL matches the background
+   * service worker url declared in the extension manifest.json file.
+   */
+  boolean isManifestBackgroundWorker(DOMString workerURL);
 };
 
 dictionary WebExtensionInit {
@@ -249,6 +268,7 @@
   DOMString? contentScriptCSP = null;
 
   sequence<DOMString>? backgroundScripts = null;
+  DOMString? backgroundWorkerScript = null;
 
   Promise<WebExtensionPolicy> readyPromise;
 };