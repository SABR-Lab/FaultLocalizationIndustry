# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/gamepad/GamepadPlatformService.cpp
# Commit: 6f01a26c0296
# Full Hash: 6f01a26c0296d0085f4fc9da09d652c3995789b6
# Author: Chris Martin <cmartin@mozilla.com>
# Date: 2024-12-10 16:36:00
# Regressor Bug: 1657404
# File Overlap Count: 1
# Description:
#   Bug 1657404 - Gamepad: Make a singleton to hold monitoring observers r=handyman
# ==============================================================================

diff -r 948ae9cdc704 -r 6f01a26c0296 dom/gamepad/GamepadPlatformService.cpp
--- a/dom/gamepad/GamepadPlatformService.cpp	Tue Dec 10 08:18:11 2024 +0000
+++ b/dom/gamepad/GamepadPlatformService.cpp	Tue Dec 10 11:52:10 2024 +0200
@@ -28,33 +28,44 @@
 
 }  // namespace
 
-GamepadPlatformService::MonitoringState::~MonitoringState() {
-  AssertIsOnBackgroundThread();
-  MOZ_RELEASE_ASSERT(mObservers.IsEmpty());
+// static
+GamepadMonitoringState& GamepadMonitoringState::GetSingleton() {
+  static GamepadMonitoringState sInstance{};
+  return sInstance;
 }
 
-void GamepadPlatformService::MonitoringState::AddObserver(
-    WeakPtr<GamepadTestChannelParent> aParent) {
+void GamepadMonitoringState::AddObserver(GamepadTestChannelParent* aParent) {
+  AssertIsOnBackgroundThread();
+  MOZ_ASSERT(aParent);
+  MOZ_ALWAYS_TRUE(mObservers.append(aParent));
+}
+
+void GamepadMonitoringState::RemoveObserver(GamepadTestChannelParent* aParent) {
   AssertIsOnBackgroundThread();
   MOZ_ASSERT(aParent);
-  MOZ_ASSERT(!mObservers.Contains(aParent));
-  mObservers.AppendElement(std::move(aParent));
+
+  WeakPtr<GamepadTestChannelParent>* observer = nullptr;
+
+  for (auto& item : mObservers) {
+    if (item == aParent) {
+      observer = &item;
+    }
+  }
+
+  MOZ_ASSERT(
+      observer,
+      "Attempted to remove a GamepadTestChannelParent that was never added");
+
+  std::swap(*observer, mObservers.back());
+  mObservers.popBack();
 }
 
-void GamepadPlatformService::MonitoringState::RemoveObserver(
-    GamepadTestChannelParent* aParent) {
-  AssertIsOnBackgroundThread();
-  MOZ_ASSERT(aParent);
-  MOZ_ASSERT(mObservers.Contains(aParent));
-  mObservers.RemoveElement(aParent);
-}
-
-bool GamepadPlatformService::MonitoringState::IsMonitoring() const {
+bool GamepadMonitoringState::IsMonitoring() const {
   AssertIsOnBackgroundThread();
   return mIsMonitoring;
 }
 
-void GamepadPlatformService::MonitoringState::Set(bool aIsMonitoring) {
+void GamepadMonitoringState::Set(bool aIsMonitoring) {
   AssertIsOnBackgroundThread();
 
   if (mIsMonitoring != aIsMonitoring) {
@@ -262,7 +273,7 @@
 
   StartGamepadMonitoring();
 
-  mMonitoringState.Set(true);
+  GamepadMonitoringState::GetSingleton().Set(true);
 }
 
 void GamepadPlatformService::RemoveChannelParent(
@@ -282,7 +293,7 @@
     }
   }
 
-  mMonitoringState.Set(false);
+  GamepadMonitoringState::GetSingleton().Set(false);
 
   StopGamepadMonitoring();
   ResetGamepadIndexes();