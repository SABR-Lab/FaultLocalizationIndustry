# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/gamepad/GamepadPlatformService.cpp
# Commit: b538d853d883
# Full Hash: b538d853d8838772585e93a6c87a3056435f58f5
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2020-08-24 21:50:21
# Regressor Bug: 1657404
# File Overlap Count: 1
# Description:
#   Bug 1660660 - Fix deadlock in gamepad initialization code. r=cmartin
#   
#   StartGamepadMonitoring() can end up in AddGamepad, and acquire the lock
#   again on the same thread, effectively dead-locking.
#   
# ==============================================================================

diff -r a6b5b4f530d9 -r b538d853d883 dom/gamepad/GamepadPlatformService.cpp
--- a/dom/gamepad/GamepadPlatformService.cpp	Mon Aug 24 17:13:54 2020 +0000
+++ b/dom/gamepad/GamepadPlatformService.cpp	Mon Aug 24 17:06:58 2020 +0000
@@ -207,21 +207,23 @@
   MOZ_ASSERT(!mChannelParents.Contains(aParent));
 
   // We use mutex here to prevent race condition with monitor thread
-  MutexAutoLock autoLock(mMutex);
-  mChannelParents.AppendElement(aParent);
+  {
+    MutexAutoLock autoLock(mMutex);
+    mChannelParents.AppendElement(aParent);
 
-  // For a new GamepadEventChannel, we have to send the exising GamepadAdded
-  // to it to make it can have the same amount of gamepads with others.
-  if (mChannelParents.Length() > 1) {
-    for (const auto& evt : mGamepadAdded) {
-      GamepadChangeEventBody body(evt.second);
-      GamepadChangeEvent e(evt.first, GamepadServiceType::Standard, body);
-      aParent->DispatchUpdateEvent(e);
+    // For a new GamepadEventChannel, we have to send the exising GamepadAdded
+    // to it to make it can have the same amount of gamepads with others.
+    if (mChannelParents.Length() > 1) {
+      for (const auto& evt : mGamepadAdded) {
+        GamepadChangeEventBody body(evt.second);
+        GamepadChangeEvent e(evt.first, GamepadServiceType::Standard, body);
+        aParent->DispatchUpdateEvent(e);
+      }
     }
+
+    FlushPendingEvents();
   }
 
-  FlushPendingEvents();
-
   StartGamepadMonitoring();
 }
 
