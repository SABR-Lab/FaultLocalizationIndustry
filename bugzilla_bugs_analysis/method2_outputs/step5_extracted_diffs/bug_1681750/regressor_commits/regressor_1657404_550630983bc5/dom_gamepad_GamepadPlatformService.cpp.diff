# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/gamepad/GamepadPlatformService.cpp
# Commit: 550630983bc5
# Full Hash: 550630983bc5ad266e8f6ce4e038db8f2bf2c6e6
# Author: Chris Martin <cmartin@mozilla.com>
# Date: 2020-08-07 21:36:18
# Regressor Bug: 1657404
# File Overlap Count: 2
# Description:
#   Bug 1657404 - Refactor gamepad monitoring - Part 1 r=daoshengmu
#   
#   The starting/stopping of gamepad monitoring is probably a decision that
#   should be made at the level of the GamepadPlatformService, not in the IPC
#   actor. This is step 1, later I will expand some of these functions because
# ==============================================================================

diff -r a8087a6f012c -r 550630983bc5 dom/gamepad/GamepadPlatformService.cpp
--- a/dom/gamepad/GamepadPlatformService.cpp	Fri Aug 07 17:13:37 2020 +0300
+++ b/dom/gamepad/GamepadPlatformService.cpp	Fri Aug 07 13:32:17 2020 +0000
@@ -221,6 +221,8 @@
   }
 
   FlushPendingEvents();
+
+  StartGamepadMonitoring();
 }
 
 void GamepadPlatformService::FlushPendingEvents() {
@@ -250,8 +252,12 @@
   MOZ_ASSERT(mChannelParents.Contains(aParent));
 
   // We use mutex here to prevent race condition with monitor thread
-  MutexAutoLock autoLock(mMutex);
-  mChannelParents.RemoveElement(aParent);
+  {
+    MutexAutoLock autoLock(mMutex);
+    mChannelParents.RemoveElement(aParent);
+  }
+
+  MaybeStopGamepadMonitoring();
 }
 
 bool GamepadPlatformService::HasGamepadListeners() {