# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/gamepad/GamepadManager.h
# Commit: ec6a64b639a8
# Full Hash: ec6a64b639a82e957376c09a71aef7ce62b3a5aa
# Author: Chris Martin <cmartin@mozilla.com>
# Date: 2020-12-03 09:47:26
# Regressor Bug: 1657404
# File Overlap Count: 3
# Description:
#   Bug 1657404 - Implement a strongly-typed, service-dependent gamepad handle r=handyman,aklotz
#   
#   Currently, the gamepad code uses a uint32_t as a handle and does some trickery
#   with it by trying to create a unique ID and adding an offset to it for VR code.
#   
# ==============================================================================

diff -r 6792f28b99bd -r ec6a64b639a8 dom/gamepad/GamepadManager.h
--- a/dom/gamepad/GamepadManager.h	Wed Dec 02 22:36:35 2020 +0000
+++ b/dom/gamepad/GamepadManager.h	Wed Dec 02 23:06:05 2020 +0000
@@ -11,7 +11,8 @@
 #include "nsRefPtrHashtable.h"
 // Needed for GamepadMappingType
 #include "mozilla/dom/GamepadBinding.h"
-#include "mozilla/dom/GamepadServiceType.h"
+#include "mozilla/dom/GamepadHandle.h"
+#include <utility>
 
 class nsGlobalWindowInner;
 class nsIGlobalObject;
@@ -37,11 +38,6 @@
   // Get the singleton service
   static already_AddRefed<GamepadManager> GetService();
 
-  // Our gamepad index has VR_GAMEPAD_IDX_OFFSET while GamepadChannelType
-  // is from VRManager.
-  static uint32_t GetGamepadIndexWithServiceType(
-      uint32_t aIndex, GamepadServiceType aServiceType);
-
   void BeginShutdown();
   void StopMonitoring();
 
@@ -51,31 +47,27 @@
   void RemoveListener(nsGlobalWindowInner* aWindow);
 
   // Add a gamepad to the list of known gamepads.
-  void AddGamepad(uint32_t aIndex, const nsAString& aID,
+  void AddGamepad(GamepadHandle aHandle, const nsAString& aID,
                   GamepadMappingType aMapping, GamepadHand aHand,
-                  GamepadServiceType aServiceType, uint32_t aDisplayID,
-                  uint32_t aNumButtons, uint32_t aNumAxes, uint32_t aNumHaptics,
-                  uint32_t aNumLightIndicator, uint32_t aNumTouchEvents);
+                  uint32_t aDisplayID, uint32_t aNumButtons, uint32_t aNumAxes,
+                  uint32_t aNumHaptics, uint32_t aNumLightIndicator,
+                  uint32_t aNumTouchEvents);
 
   // Remove the gamepad at |aIndex| from the list of known gamepads.
-  void RemoveGamepad(uint32_t aIndex, GamepadServiceType aServiceType);
+  void RemoveGamepad(GamepadHandle aHandle);
 
   // Synchronize the state of |aGamepad| to match the gamepad stored at |aIndex|
-  void SyncGamepadState(uint32_t aIndex, nsGlobalWindowInner* aWindow,
+  void SyncGamepadState(GamepadHandle aHandle, nsGlobalWindowInner* aWindow,
                         Gamepad* aGamepad);
 
   // Returns gamepad object if index exists, null otherwise
-  already_AddRefed<Gamepad> GetGamepad(uint32_t aIndex) const;
-
-  // Returns gamepad object if GamepadId exists, null otherwise
-  already_AddRefed<Gamepad> GetGamepad(uint32_t aGamepadId,
-                                       GamepadServiceType aServiceType) const;
+  already_AddRefed<Gamepad> GetGamepad(GamepadHandle aHandle) const;
 
   // Receive GamepadChangeEvent messages from parent process to fire DOM events
   void Update(const GamepadChangeEvent& aGamepadEvent);
 
   // Trigger vibrate haptic event to gamepad channels.
-  already_AddRefed<Promise> VibrateHaptic(uint32_t aControllerIdx,
+  already_AddRefed<Promise> VibrateHaptic(GamepadHandle aHandle,
                                           uint32_t aHapticIndex,
                                           double aIntensity, double aDuration,
                                           nsIGlobalObject* aGlobal,
@@ -84,7 +76,7 @@
   void StopHaptics();
 
   // Set light indicator color event to gamepad channels.
-  already_AddRefed<Promise> SetLightIndicatorColor(uint32_t aControllerIdx,
+  already_AddRefed<Promise> SetLightIndicatorColor(GamepadHandle aHandle,
                                                    uint32_t aLightColorIndex,
                                                    uint8_t aRed, uint8_t aGreen,
                                                    uint8_t aBlue,
@@ -98,7 +90,7 @@
   // Fire a gamepadconnected or gamepaddisconnected event for the gamepad
   // at |aIndex| to all windows that are listening and have received
   // gamepad input.
-  void NewConnectionEvent(uint32_t aIndex, bool aConnected);
+  void NewConnectionEvent(GamepadHandle aHandle, bool aConnected);
 
   // Fire a gamepadaxismove event to the window at |aTarget| for |aGamepad|.
   void FireAxisMoveEvent(EventTarget* aTarget, Gamepad* aGamepad, uint32_t axis,
@@ -134,22 +126,24 @@
   // To avoid unintentionally causing the gamepad be activated.
   // Returns false if this gamepad hasn't been seen by this window
   // and the axis move data is less than AXIS_FIRST_INTENT_THRESHOLD_VALUE.
-  bool AxisMoveIsFirstIntent(nsGlobalWindowInner* aWindow, uint32_t aIndex,
+  bool AxisMoveIsFirstIntent(nsGlobalWindowInner* aWindow,
+                             GamepadHandle aHandle,
                              const GamepadChangeEvent& aEvent);
-  bool MaybeWindowHasSeenGamepad(nsGlobalWindowInner* aWindow, uint32_t aIndex);
+  bool MaybeWindowHasSeenGamepad(nsGlobalWindowInner* aWindow,
+                                 GamepadHandle aHandle);
   // Returns true if we have already sent data from this gamepad
   // to this window. This should only return true if the user
   // explicitly interacted with a gamepad while this window
   // was focused, by pressing buttons or similar actions.
   bool WindowHasSeenGamepad(nsGlobalWindowInner* aWindow,
-                            uint32_t aIndex) const;
+                            GamepadHandle aHandle) const;
   // Indicate that a window has received data from a gamepad.
-  void SetWindowHasSeenGamepad(nsGlobalWindowInner* aWindow, uint32_t aIndex,
-                               bool aHasSeen = true);
+  void SetWindowHasSeenGamepad(nsGlobalWindowInner* aWindow,
+                               GamepadHandle aHandle, bool aHasSeen = true);
 
   // Gamepads connected to the system. Copies of these are handed out
   // to each window.
-  nsRefPtrHashtable<nsUint32HashKey, Gamepad> mGamepads;
+  nsRefPtrHashtable<nsGenericHashKey<GamepadHandle>, Gamepad> mGamepads;
   // Inner windows that are listening for gamepad events.
   // has been sent to that window.
   nsTArray<RefPtr<nsGlobalWindowInner>> mListeners;