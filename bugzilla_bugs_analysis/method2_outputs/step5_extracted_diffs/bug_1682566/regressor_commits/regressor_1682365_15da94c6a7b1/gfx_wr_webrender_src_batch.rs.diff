# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/wr/webrender/src/batch.rs
# Commit: 15da94c6a7b1
# Full Hash: 15da94c6a7b19f971d3dffaa4cab8edb8e41cb62
# Author: Glenn Watson <git@intuitionlibrary.com>
# Date: 2020-12-15 09:29:54
# Regressor Bug: 1682365
# File Overlap Count: 1
# Description:
#   Bug 1682365 - Pt 2 - Remove texture array usage from render task graph. r=nical
#   
#   With this change, all color/alpha intermediate surfaces are individual
#   textures, rather than texture arrays.
#   
# ==============================================================================

diff -r 72ddac486037 -r 15da94c6a7b1 gfx/wr/webrender/src/batch.rs
--- a/gfx/wr/webrender/src/batch.rs	Tue Dec 15 01:46:51 2020 +0200
+++ b/gfx/wr/webrender/src/batch.rs	Mon Dec 14 21:48:41 2020 +0000
@@ -1607,7 +1607,7 @@
                                         ).unwrap();
 
                                         let kind = BatchKind::Brush(
-                                            BrushBatchKind::Image(ImageBufferKind::Texture2DArray)
+                                            BrushBatchKind::Image(ImageBufferKind::Texture2D)
                                         );
                                         let (uv_rect_address, textures) = render_tasks.resolve_surface(
                                             surface_task.expect("bug: surface must be allocated by now"),
@@ -1654,7 +1654,7 @@
 
                                         // The shadows and the content get drawn as a brush image.
                                         let kind = BatchKind::Brush(
-                                            BrushBatchKind::Image(ImageBufferKind::Texture2DArray),
+                                            BrushBatchKind::Image(ImageBufferKind::Texture2D),
                                         );
 
                                         // Gets the saved render task ID of the content, which is
@@ -1665,7 +1665,6 @@
                                             let texture_id = secondary_task.get_target_texture();
                                             TextureSource::TextureCache(
                                                 texture_id,
-                                                ImageBufferKind::Texture2DArray,
                                                 Swizzle::default(),
                                             )
                                         };
@@ -1944,7 +1943,7 @@
                                 );
                                 let key = BatchKey::new(
                                     BatchKind::Brush(
-                                        BrushBatchKind::Image(ImageBufferKind::Texture2DArray),
+                                        BrushBatchKind::Image(ImageBufferKind::Texture2D),
                                     ),
                                     BlendMode::Advanced(mode),
                                     textures,
@@ -2004,12 +2003,10 @@
                                             colors: [
                                                 TextureSource::TextureCache(
                                                     color0,
-                                                    ImageBufferKind::Texture2DArray,
                                                     Swizzle::default(),
                                                 ),
                                                 TextureSource::TextureCache(
                                                     color1,
-                                                    ImageBufferKind::Texture2DArray,
                                                     Swizzle::default(),
                                                 ),
                                                 TextureSource::Invalid,
@@ -2052,7 +2049,6 @@
                                     colors: [
                                         TextureSource::TextureCache(
                                             texture_id,
-                                            ImageBufferKind::Texture2DArray,
                                             Swizzle::default(),
                                         ),
                                         TextureSource::Invalid,
@@ -2060,7 +2056,7 @@
                                     ],
                                 };
                                 let batch_params = BrushBatchParameters::shared(
-                                    BrushBatchKind::Image(ImageBufferKind::Texture2DArray),
+                                    BrushBatchKind::Image(ImageBufferKind::Texture2D),
                                     textures,
                                     ImageBrushData {
                                         color_mode: ShaderColorMode::Image,
@@ -2126,7 +2122,7 @@
                                 ).unwrap();
 
                                 let kind = BatchKind::Brush(
-                                    BrushBatchKind::Image(ImageBufferKind::Texture2DArray)
+                                    BrushBatchKind::Image(ImageBufferKind::Texture2D)
                                 );
                                 let (uv_rect_address, textures) = render_tasks.resolve_surface(
                                     surface_task.expect("bug: surface must be allocated by now"),
@@ -2983,7 +2979,7 @@
                 );
 
                 let batch_key = BatchKey::new(
-                    BatchKind::Brush(BrushBatchKind::Image(ImageBufferKind::Texture2DArray)),
+                    BatchKind::Brush(BrushBatchKind::Image(ImageBufferKind::Texture2D)),
                     BlendMode::PremultipliedAlpha,
                     textures,
                 );
@@ -3345,7 +3341,6 @@
             BatchTextures::prim_textured(
                 TextureSource::TextureCache(
                     task.get_target_texture(),
-                    ImageBufferKind::Texture2DArray,
                     Swizzle::default(),
                 ),
                 clip_mask,
@@ -3828,7 +3823,6 @@
                     task_id.into(),
                     TextureSource::TextureCache(
                         render_tasks[task_id].get_target_texture(),
-                        ImageBufferKind::Texture2DArray,
                         Swizzle::default(),
                     )
                 ))