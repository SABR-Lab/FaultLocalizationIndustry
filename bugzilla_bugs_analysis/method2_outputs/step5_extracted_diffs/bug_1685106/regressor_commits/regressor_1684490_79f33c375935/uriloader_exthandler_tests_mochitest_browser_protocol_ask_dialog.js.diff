# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: uriloader/exthandler/tests/mochitest/browser_protocol_ask_dialog.js
# Commit: 79f33c375935
# Full Hash: 79f33c375935f47f95bf8c0907d58d15691bd358
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-01-05 04:31:31
# Regressor Bug: 1684490
# File Overlap Count: 1
# Description:
#   Bug 1684490 - Check an in-process window context for user interaction. r=smaug,edgar
#   
#   In the case we click a link from inside the frame, we don't want to
#   check for activation from the parent window but ourselves.
#   
# ==============================================================================

diff -r 0bf6c172cbec -r 79f33c375935 uriloader/exthandler/tests/mochitest/browser_protocol_ask_dialog.js
--- a/uriloader/exthandler/tests/mochitest/browser_protocol_ask_dialog.js	Mon Jan 04 23:51:15 2021 +0200
+++ b/uriloader/exthandler/tests/mochitest/browser_protocol_ask_dialog.js	Mon Jan 04 20:54:07 2021 +0000
@@ -310,3 +310,38 @@
   await dialogClosedPromise;
   gBrowser.removeTab(tab);
 });
+
+add_task(async function test_oop_iframe() {
+  const URI = `data:text/html,<div id="root"><iframe src="http://example.com/document-builder.sjs?html=<a href='mailto:help@example.com'>Mail it</a>"></iframe></div>`;
+
+  let tab = await BrowserTestUtils.openNewForegroundTab(gBrowser, URI);
+
+  // Wait for the window and then click the link.
+  let dialogWindowPromise = waitForProtocolAppChooserDialog(
+    tab.linkedBrowser,
+    true
+  );
+
+  BrowserTestUtils.synthesizeMouseAtCenter(
+    "a:link",
+    {},
+    tab.linkedBrowser.browsingContext.children[0]
+  );
+
+  let dialog = await dialogWindowPromise;
+
+  is(
+    dialog._frame.contentDocument.location.href,
+    CONTENT_HANDLING_URL,
+    "Dialog URL is as expected"
+  );
+  let dialogClosedPromise = waitForProtocolAppChooserDialog(
+    tab.linkedBrowser,
+    false
+  );
+
+  info("Removing tab to close the dialog.");
+  gBrowser.removeTab(tab);
+  await dialogClosedPromise;
+  ok(!dialog._frame.contentWindow, "The dialog should have been closed.");
+});
