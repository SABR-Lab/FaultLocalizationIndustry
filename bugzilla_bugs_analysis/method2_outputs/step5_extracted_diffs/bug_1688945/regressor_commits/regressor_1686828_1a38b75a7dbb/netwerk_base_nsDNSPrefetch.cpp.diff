# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/base/nsDNSPrefetch.cpp
# Commit: 1a38b75a7dbb
# Full Hash: 1a38b75a7dbb86fa14d2763e7a983dfd0bde5d50
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2021-01-22 10:17:55
# Regressor Bug: 1686828
# File Overlap Count: 1
# Description:
#   Bug 1686828 - Use https OriginAttributes to fetch HTTPS RR r=necko-reviewers,timhuang,dragana
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D102234
# ==============================================================================

diff -r e83b6fb52b62 -r 1a38b75a7dbb netwerk/base/nsDNSPrefetch.cpp
--- a/netwerk/base/nsDNSPrefetch.cpp	Thu Jan 21 22:08:27 2021 +0000
+++ b/netwerk/base/nsDNSPrefetch.cpp	Thu Jan 21 22:08:26 2021 +0000
@@ -41,7 +41,16 @@
       mTRRMode(aTRRMode),
       mListener(do_GetWeakReference(aListener)) {
   aURI->GetAsciiHost(mHostname);
-  mIsHttps = aURI->SchemeIs("https");
+}
+
+nsDNSPrefetch::nsDNSPrefetch(nsIURI* aURI,
+                             mozilla::OriginAttributes& aOriginAttributes,
+                             nsIRequest::TRRMode aTRRMode)
+    : mOriginAttributes(aOriginAttributes),
+      mStoreTiming(false),
+      mTRRMode(aTRRMode),
+      mListener(nullptr) {
+  aURI->GetAsciiHost(mHostname);
 }
 
 nsresult nsDNSPrefetch::Prefetch(uint32_t flags) {
@@ -114,17 +123,20 @@
 };  // namespace
 
 nsresult nsDNSPrefetch::FetchHTTPSSVC(
-    bool aRefreshDNS, std::function<void(nsIDNSHTTPSSVCRecord*)>&& aCallback) {
+    bool aRefreshDNS, bool aPrefetch,
+    std::function<void(nsIDNSHTTPSSVCRecord*)>&& aCallback) {
   if (!sDNSService) {
     return NS_ERROR_NOT_AVAILABLE;
   }
 
   nsCOMPtr<nsIEventTarget> target = mozilla::GetCurrentEventTarget();
-  uint32_t flags = nsIDNSService::GetFlagsFromTRRMode(mTRRMode) |
-                   nsIDNSService::RESOLVE_SPECULATE;
+  uint32_t flags = nsIDNSService::GetFlagsFromTRRMode(mTRRMode);
   if (aRefreshDNS) {
     flags |= nsIDNSService::RESOLVE_BYPASS_CACHE;
   }
+  if (aPrefetch) {
+    flags |= nsIDNSService::RESOLVE_SPECULATE;
+  }
 
   nsCOMPtr<nsICancelable> tmpOutstanding;
   nsCOMPtr<nsIDNSListener> listener = new HTTPSRRListener(std::move(aCallback));