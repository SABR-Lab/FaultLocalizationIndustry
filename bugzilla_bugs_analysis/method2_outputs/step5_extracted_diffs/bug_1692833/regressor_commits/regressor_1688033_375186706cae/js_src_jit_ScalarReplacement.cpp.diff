# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/ScalarReplacement.cpp
# Commit: 375186706cae
# Full Hash: 375186706caeb4d480bb8c7be78a349601a3e7c1
# Author: Iain Ireland <iireland@mozilla.com>
# Date: 2021-02-13 09:52:34
# Regressor Bug: 1688033
# File Overlap Count: 1
# Description:
#   Bug 1688033: Recover CreateArgumentsObject on bailout r=nbp
#   
#   The original version of this patch only recovered CreateArgumentsObject on bailout if it didn't escape, but I removed that code based on discussion in #warpbuilder.
#   
#   This code is tested by `/ion/dce-with-rinstructions.js`. Prior to this patch, it failed with `--scalar-replace-arguments`.
# ==============================================================================

diff -r adaf366a60fa -r 375186706cae js/src/jit/ScalarReplacement.cpp
--- a/js/src/jit/ScalarReplacement.cpp	Fri Feb 12 20:28:47 2021 +0000
+++ b/js/src/jit/ScalarReplacement.cpp	Fri Feb 12 20:28:48 2021 +0000
@@ -1255,6 +1255,11 @@
       case MDefinition::Opcode::LoadArgumentsObjectArg:
         break;
 
+      // This instruction is a no-op used to test that scalar replacement
+      // is working as expected.
+      case MDefinition::Opcode::AssertRecoveredOnBailout:
+        break;
+
       default:
         JitSpewDef(JitSpew_Escape, "is escaped by\n", def);
         return true;
@@ -1285,6 +1290,7 @@
   }
 
   bool run();
+  void assertSuccess();
 };
 
 // Replacing the arguments object is simpler than replacing an object
@@ -1320,8 +1326,13 @@
     }
   }
 
+  assertSuccess();
+  return true;
+}
+
+void ArgumentsReplacer::assertSuccess() {
+  MOZ_ASSERT(args_->canRecoverOnBailout());
   MOZ_ASSERT(!args_->hasLiveDefUses());
-  return true;
 }
 
 void ArgumentsReplacer::visitGuardToClass(MGuardToClass* ins) {
