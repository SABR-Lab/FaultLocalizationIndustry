# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/xul/nsXULTooltipListener.cpp
# Commit: 344a66b3e7ed
# Full Hash: 344a66b3e7ed89a4786326e4b5e7289d226679a7
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-02-27 09:44:58
# Description:
#   Bug 1695122 - Deal with target being null in nsXULTooltipListener and cleanup a bit. r=jaws
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D106646
# ==============================================================================

diff -r 2265f1fda746 -r 344a66b3e7ed layout/xul/nsXULTooltipListener.cpp
--- a/layout/xul/nsXULTooltipListener.cpp	Fri Feb 26 18:58:01 2021 +0000
+++ b/layout/xul/nsXULTooltipListener.cpp	Fri Feb 26 19:14:25 2021 +0000
@@ -432,9 +432,20 @@
 }
 #endif
 
+static bool IsInTree(const Element& aTarget) {
+  for (nsIContent* p = aTarget.GetParent(); p; p = p->GetParent()) {
+    if (p->IsAnyOfXULElements(nsGkAtoms::tree, nsGkAtoms::treechildren)) {
+      return true;
+    }
+  }
+  return false;
+}
+
 void nsXULTooltipListener::LaunchTooltip() {
-  nsCOMPtr<Element> currentTooltip = do_QueryReferent(mCurrentTooltip);
-  if (!currentTooltip) return;
+  RefPtr<Element> currentTooltip = do_QueryReferent(mCurrentTooltip);
+  if (!currentTooltip) {
+    return;
+  }
 
 #ifdef MOZ_XUL
   if (mIsSourceTree && mNeedTitletip) {
@@ -450,38 +461,47 @@
   } else {
     currentTooltip->UnsetAttr(kNameSpaceID_None, nsGkAtoms::titletip, true);
   }
+
   if (!(currentTooltip = do_QueryReferent(mCurrentTooltip))) {
     // Because of mutation events, currentTooltip can be null.
     return;
   }
 
   nsXULPopupManager* pm = nsXULPopupManager::GetInstance();
-  if (pm) {
-    nsCOMPtr<nsIContent> target = do_QueryReferent(mTargetNode);
-    nsAutoString position;
-    if (!target->AsElement()->Closest("treechildren"_ns, IgnoreErrors()) &&
-        !target->AsElement()->Closest("tree"_ns, IgnoreErrors())) {
-      nsAutoString closest;
-      currentTooltip->GetAttr(nsGkAtoms::anchortoclosest, closest);
-      if (!closest.IsEmpty()) {
-        target = target->AsElement()->Closest(NS_ConvertUTF16toUTF8(closest),
-                                              IgnoreErrors());
-        if (!target) {
-          target = do_QueryReferent(mTargetNode);
-        }
+  if (!pm) {
+    return;
+  }
+
+  auto cleanup = MakeScopeExit([&] {
+    // Clear the current tooltip if the popup was not opened successfully.
+    if (!pm->IsPopupOpen(currentTooltip)) {
+      mCurrentTooltip = nullptr;
+    }
+  });
+
+  RefPtr<Element> target = do_QueryReferent(mTargetNode);
+  if (!target) {
+    return;
+  }
+
+  nsAutoString position;
+  if (!IsInTree(*target)) {
+    nsAutoString closest;
+    currentTooltip->GetAttr(nsGkAtoms::anchortoclosest, closest);
+    if (!closest.IsEmpty()) {
+      if (auto* closestTarget =
+              target->Closest(NS_ConvertUTF16toUTF8(closest), IgnoreErrors())) {
+        target = closestTarget;
       }
-      currentTooltip->GetAttr(nsGkAtoms::position, position);
     }
+    currentTooltip->GetAttr(nsGkAtoms::position, position);
+  }
 
-    if (position.IsEmpty()) {
-      pm->ShowTooltipAtScreen(currentTooltip, target, mMouseScreenX,
-                              mMouseScreenY);
-    } else {
-      pm->ShowTooltipAtPosition(currentTooltip, target, position);
-    }
-
-    // Clear the current tooltip if the popup was not opened successfully.
-    if (!pm->IsPopupOpen(currentTooltip)) mCurrentTooltip = nullptr;
+  if (position.IsEmpty()) {
+    pm->ShowTooltipAtScreen(currentTooltip, target, mMouseScreenX,
+                            mMouseScreenY);
+  } else {
+    pm->ShowTooltipAtPosition(currentTooltip, target, position);
   }
 #endif
 }
