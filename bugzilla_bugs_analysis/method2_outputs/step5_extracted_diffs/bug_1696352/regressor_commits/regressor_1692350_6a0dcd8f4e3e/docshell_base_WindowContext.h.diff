# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: docshell/base/WindowContext.h
# Commit: 6a0dcd8f4e3e
# Full Hash: 6a0dcd8f4e3e35d27edba6a4fef795cf8174ac78
# Author: Sean Feng <sefeng@mozilla.com>
# Date: 2021-02-18 04:16:06
# Regressor Bug: 1692350
# File Overlap Count: 1
# Description:
#   Bug 1692350 - Implement a telemetry probe to collect page load data for documents that use lazyload r=emilio,chutten
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D104912
# ==============================================================================

diff -r 6d7590bfd8d3 -r 6a0dcd8f4e3e docshell/base/WindowContext.h
--- a/docshell/base/WindowContext.h	Wed Feb 17 17:08:51 2021 +0000
+++ b/docshell/base/WindowContext.h	Wed Feb 17 17:17:52 2021 +0000
@@ -82,7 +82,10 @@
   FIELD(HasReportedShadowDOMUsage, bool)                               \
   /* Whether the principal of this window is for a local               \
    * IP address */                                                     \
-  FIELD(IsLocalIP, bool)
+  FIELD(IsLocalIP, bool)                                               \
+  /* Whether the corresponding document has `loading='lazy'`           \
+   * images; It won't become false if the image becomes non-lazy */    \
+  FIELD(HadLazyLoadImage, bool)
 
 class WindowContext : public nsISupports, public nsWrapperCache {
   MOZ_DECL_SYNCED_CONTEXT(WindowContext, MOZ_EACH_WC_FIELD)
@@ -175,6 +178,8 @@
 
   bool CanShowPopup();
 
+  bool HadLazyLoadImage() const { return GetHadLazyLoadImage(); }
+
  protected:
   WindowContext(BrowsingContext* aBrowsingContext, uint64_t aInnerWindowId,
                 uint64_t aOuterWindowId, bool aInProcess,
@@ -262,6 +267,9 @@
   bool CanSet(FieldIndex<IDX_IsLocalIP>, const bool& aValue,
               ContentParent* aSource);
 
+  bool CanSet(FieldIndex<IDX_HadLazyLoadImage>, const bool& aValue,
+              ContentParent* aSource);
+
   void DidSet(FieldIndex<IDX_HasReportedShadowDOMUsage>, bool aOldValue);
 
   void DidSet(FieldIndex<IDX_SHEntryHasUserInteraction>, bool aOldValue);