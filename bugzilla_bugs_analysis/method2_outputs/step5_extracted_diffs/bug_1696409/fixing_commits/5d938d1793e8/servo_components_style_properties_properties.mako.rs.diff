# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: servo/components/style/properties/properties.mako.rs
# Commit: 5d938d1793e8
# Full Hash: 5d938d1793e82665521b6c8e34fc3194ddcf381c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-03-09 09:49:21
# Description:
#   Bug 1696409 - Paper over a crash in non-nightly. r=boris
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D107400
# ==============================================================================

diff -r dac8f270246f -r 5d938d1793e8 servo/components/style/properties/properties.mako.rs
--- a/servo/components/style/properties/properties.mako.rs	Mon Mar 08 23:27:49 2021 +0000
+++ b/servo/components/style/properties/properties.mako.rs	Mon Mar 08 23:29:30 2021 +0000
@@ -1757,7 +1757,21 @@
             shorthand_cache.insert((shorthand, longhand), declaration);
         }
 
-        Cow::Borrowed(&shorthand_cache[&(shorthand, longhand_id)])
+        let key = (shorthand, longhand_id);
+        match shorthand_cache.get(&key) {
+            Some(decl) => Cow::Borrowed(decl),
+            None => {
+                // FIXME: We should always have the key here but it seems
+                // sometimes we don't, see bug 1696409.
+                #[cfg(feature = "gecko")]
+                {
+                    if structs::GECKO_IS_NIGHTLY {
+                        panic!("Expected {:?} to be in the cache but it was not!", key);
+                    }
+                }
+                invalid_at_computed_value_time()
+            }
+        }
     }
 }
 
