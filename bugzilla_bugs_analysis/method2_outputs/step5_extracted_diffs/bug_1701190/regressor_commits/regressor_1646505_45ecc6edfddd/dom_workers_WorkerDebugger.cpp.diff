# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/WorkerDebugger.cpp
# Commit: 45ecc6edfddd
# Full Hash: 45ecc6edfddd1091dd8496db5b6061b29ec6daea
# Author: Andreas Farre <farre@mozilla.com>
# Date: 2020-12-12 09:23:03
# Regressor Bug: 1646505
# File Overlap Count: 1
# Description:
#   Bug 1646505 - Fix about:performance for Fission. r=tarek
#   
#   With fission it's not possible to use
#   nsPIDOMWindowOuter::GetInProcessTop and expect to find the top-level
#   window, since it might be in another process. Instead we use
# ==============================================================================

diff -r 5642ac1f250f -r 45ecc6edfddd dom/workers/WorkerDebugger.cpp
--- a/dom/workers/WorkerDebugger.cpp	Fri Dec 11 16:03:18 2020 +0000
+++ b/dom/workers/WorkerDebugger.cpp	Fri Dec 11 15:56:23 2020 +0000
@@ -6,8 +6,10 @@
 
 #include "WorkerDebugger.h"
 
+#include "mozilla/dom/BrowsingContext.h"
 #include "mozilla/dom/MessageEvent.h"
 #include "mozilla/dom/MessageEventBinding.h"
+#include "mozilla/dom/WindowContext.h"
 #include "mozilla/AbstractThread.h"
 #include "mozilla/PerformanceUtils.h"
 #include "nsProxyRelease.h"
@@ -457,7 +459,7 @@
 
 RefPtr<PerformanceInfoPromise> WorkerDebugger::ReportPerformanceInfo() {
   AssertIsOnMainThread();
-  nsCOMPtr<nsPIDOMWindowOuter> top;
+  RefPtr<BrowsingContext> top;
   RefPtr<WorkerDebugger> self = this;
 
 #if defined(XP_WIN)
@@ -476,12 +478,12 @@
   }
   nsPIDOMWindowInner* win = wp->GetWindow();
   if (win) {
-    nsPIDOMWindowOuter* outer = win->GetOuterWindow();
-    if (outer) {
-      top = outer->GetInProcessTop();
+    BrowsingContext* context = win->GetBrowsingContext();
+    if (context) {
+      top = context->Top();
       if (top) {
-        windowID = top->WindowID();
-        isTopLevel = outer->GetBrowsingContext()->IsTop();
+        windowID = top->GetCurrentWindowContext()->OuterWindowId();
+        isTopLevel = context->IsTop();
       }
     }
   }