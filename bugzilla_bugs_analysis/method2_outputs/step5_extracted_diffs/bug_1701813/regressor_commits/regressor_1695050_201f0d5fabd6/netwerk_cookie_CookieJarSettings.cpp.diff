# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/cookie/CookieJarSettings.cpp
# Commit: 201f0d5fabd6
# Full Hash: 201f0d5fabd61c8eebe7e27e8597021d3618ddea
# Author: Tim Huang <tihuang@mozilla.com>
# Date: 2021-03-29 15:25:22
# Regressor Bug: 1695050
# File Overlap Count: 1
# Description:
#   Bug 1695050 - Part 2: Modify CookieJarSettings::Create() to be able to creat cookieJarSettings according to the browsing mode. r=dimi,preferences-reviewers
#   
#   This patch modifies the current CookieJarSettings::Create() function.
#   It removes the current function and adds two variants. One takes the
#   nsIPrincipal as input and another takes the enum value. The new
# ==============================================================================

diff -r 59cda3c92f48 -r 201f0d5fabd6 netwerk/cookie/CookieJarSettings.cpp
--- a/netwerk/cookie/CookieJarSettings.cpp	Mon Mar 29 11:01:50 2021 +0000
+++ b/netwerk/cookie/CookieJarSettings.cpp	Mon Mar 29 11:01:51 2021 +0000
@@ -98,17 +98,41 @@
 }
 
 // static
-already_AddRefed<nsICookieJarSettings> CookieJarSettings::Create() {
+already_AddRefed<nsICookieJarSettings> CookieJarSettings::Create(
+    CreateMode aMode) {
   MOZ_ASSERT(NS_IsMainThread());
 
-  RefPtr<CookieJarSettings> cookieJarSettings = new CookieJarSettings(
-      nsICookieManager::GetCookieBehavior(),
-      OriginAttributes::IsFirstPartyEnabled(), eProgressive);
+  RefPtr<CookieJarSettings> cookieJarSettings;
+
+  switch (aMode) {
+    case eRegular:
+    case ePrivate:
+      cookieJarSettings = new CookieJarSettings(
+          nsICookieManager::GetCookieBehavior(aMode == ePrivate),
+          OriginAttributes::IsFirstPartyEnabled(), eProgressive);
+      break;
+
+    default:
+      MOZ_CRASH("Unexpected create mode.");
+  }
+
   return cookieJarSettings.forget();
 }
 
 // static
 already_AddRefed<nsICookieJarSettings> CookieJarSettings::Create(
+    nsIPrincipal* aPrincipal) {
+  MOZ_ASSERT(NS_IsMainThread());
+
+  if (aPrincipal && aPrincipal->OriginAttributesRef().mPrivateBrowsingId > 0) {
+    return Create(ePrivate);
+  }
+
+  return Create(eRegular);
+}
+
+// static
+already_AddRefed<nsICookieJarSettings> CookieJarSettings::Create(
     uint32_t aCookieBehavior, const nsAString& aPartitionKey,
     bool aIsFirstPartyIsolated, bool aIsOnContentBlockingAllowList) {
   MOZ_ASSERT(NS_IsMainThread());
@@ -122,6 +146,12 @@
   return cookieJarSettings.forget();
 }
 
+// static
+already_AddRefed<nsICookieJarSettings> CookieJarSettings::CreateForXPCOM() {
+  MOZ_ASSERT(NS_IsMainThread());
+  return Create(eRegular);
+}
+
 CookieJarSettings::CookieJarSettings(uint32_t aCookieBehavior,
                                      bool aIsFirstPartyIsolated, State aState)
     : mCookieBehavior(aCookieBehavior),