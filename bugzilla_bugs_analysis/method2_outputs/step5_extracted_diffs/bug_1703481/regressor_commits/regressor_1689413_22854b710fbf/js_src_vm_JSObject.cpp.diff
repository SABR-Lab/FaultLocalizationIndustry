# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/JSObject.cpp
# Commit: 22854b710fbf
# Full Hash: 22854b710fbfb779ac6b19fe4c9ac2570189cec0
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2021-03-06 09:33:16
# Regressor Bug: 1689413
# File Overlap Count: 1
# Description:
#   Bug 1689413 part 6 - Move Realm* from ObjectGroup to BaseShape. r=jonco
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D106976
# ==============================================================================

diff -r 4531d5c25694 -r 22854b710fbf js/src/vm/JSObject.cpp
--- a/js/src/vm/JSObject.cpp	Fri Mar 05 19:10:06 2021 +0000
+++ b/js/src/vm/JSObject.cpp	Fri Mar 05 19:10:07 2021 +0000
@@ -524,7 +524,7 @@
     // dictionary mode.
     RootedShape last(
         cx, EmptyShape::getInitialShape(
-                cx, nobj->getClass(), nobj->taggedProto(),
+                cx, nobj->getClass(), nobj->realm(), nobj->taggedProto(),
                 nobj->numFixedSlots(), nobj->lastProperty()->objectFlags()));
     if (!last) {
       return false;
@@ -771,8 +771,9 @@
                       ? GetGCKindSlots(gc::GetGCObjectKind(clasp), clasp)
                       : GetGCKindSlots(kind, clasp);
 
-  RootedShape shape(cx, EmptyShape::getInitialShape(cx, clasp, group->proto(),
-                                                    nfixed, objectFlags));
+  RootedShape shape(
+      cx, EmptyShape::getInitialShape(cx, clasp, cx->realm(), group->proto(),
+                                      nfixed, objectFlags));
   if (!shape) {
     return nullptr;
   }
@@ -1194,7 +1195,8 @@
     // We need to generate a new shape for dst that has dst's proto but all
     // the property information from src.  Note that we asserted above that
     // dst's object flags are empty.
-    shape = EmptyShape::getInitialShape(cx, dst->getClass(), dst->taggedProto(),
+    shape = EmptyShape::getInitialShape(cx, dst->getClass(), dst->realm(),
+                                        dst->taggedProto(),
                                         dst->numFixedSlots(), ObjectFlags());
     if (!shape) {
       return false;
@@ -1806,11 +1808,9 @@
     }
   }
 
-  RootedObjectGroup oldGroup(cx, obj->group());
-
   ObjectGroup* newGroup;
   {
-    AutoRealm ar(cx, oldGroup);
+    AutoRealm ar(cx, obj->shape());
     newGroup = ObjectGroup::defaultNewGroup(cx, obj->getClass(), proto);
     if (!newGroup) {
       return false;
@@ -3813,7 +3813,7 @@
                     CanNurseryAllocateFinalizedClass(clasp) ||
                     clasp->isProxyObject());
 
-  MOZ_ASSERT(!group->realm()->hasObjectPendingMetadata());
+  MOZ_ASSERT(!shape->realm()->hasObjectPendingMetadata());
 
   // Non-native classes manage their own data and slots, so numFixedSlots and
   // slotSpan are always 0. Note that proxy classes can have reserved slots