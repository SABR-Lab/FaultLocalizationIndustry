# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/Scope.cpp
# Commit: e9c2f256240a
# Full Hash: e9c2f256240a1f9bb09b10ac641bbd141eedb809
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2021-03-06 09:33:16
# Regressor Bug: 1689413
# File Overlap Count: 1
# Description:
#   Bug 1689413 part 2 - Remove owned BaseShapes. r=jonco
#   
#   At this point all BaseShapes are unowned (= immutable, shared) so we can remove the
#   UnownedBaseShape type and the `BaseShape::unowned_` field.
#   
# ==============================================================================

diff -r 1ae4c30bb931 -r e9c2f256240a js/src/vm/Scope.cpp
--- a/js/src/vm/Scope.cpp	Sat Mar 06 01:05:19 2021 +0000
+++ b/js/src/vm/Scope.cpp	Sat Mar 06 01:05:19 2021 +0000
@@ -102,13 +102,7 @@
 
 static Shape* NextEnvironmentShape(JSContext* cx, HandleAtom name,
                                    BindingKind bindKind, uint32_t slot,
-                                   StackBaseShape& stackBase,
                                    HandleShape shape) {
-  UnownedBaseShape* base = BaseShape::getUnowned(cx, stackBase);
-  if (!base) {
-    return nullptr;
-  }
-
   unsigned attrs = JSPROP_PERMANENT | JSPROP_ENUMERATE;
   switch (bindKind) {
     case BindingKind::Const:
@@ -120,7 +114,7 @@
   }
 
   jsid id = NameToId(name->asPropertyName());
-  Rooted<StackShape> child(cx, StackShape(base, id, slot, attrs));
+  Rooted<StackShape> child(cx, StackShape(shape->base(), id, slot, attrs));
   return cx->zone()->propertyTree().getChild(cx, shape, child);
 }
 
@@ -133,14 +127,12 @@
   }
 
   RootedAtom name(cx);
-  StackBaseShape stackBase(cls, objectFlags);
   for (; bi; bi++) {
     BindingLocation loc = bi.location();
     if (loc.kind() == BindingLocation::Kind::Environment) {
       name = bi.name();
       cx->markAtom(name);
-      shape = NextEnvironmentShape(cx, name, bi.kind(), loc.slot(), stackBase,
-                                   shape);
+      shape = NextEnvironmentShape(cx, name, bi.kind(), loc.slot(), shape);
       if (!shape) {
         return nullptr;
       }
@@ -160,15 +152,13 @@
   }
 
   RootedAtom name(cx);
-  StackBaseShape stackBase(cls, objectFlags);
   for (; bi; bi++) {
     BindingLocation loc = bi.location();
     if (loc.kind() == BindingLocation::Kind::Environment) {
       name = atomCache.getExistingAtomAt(cx, bi.name());
       MOZ_ASSERT(name);
       cx->markAtom(name);
-      shape = NextEnvironmentShape(cx, name, bi.kind(), loc.slot(), stackBase,
-                                   shape);
+      shape = NextEnvironmentShape(cx, name, bi.kind(), loc.slot(), shape);
       if (!shape) {
         return nullptr;
       }