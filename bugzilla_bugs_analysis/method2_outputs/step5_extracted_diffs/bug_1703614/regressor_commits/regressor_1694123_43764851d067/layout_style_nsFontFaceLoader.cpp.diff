# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/nsFontFaceLoader.cpp
# Commit: 43764851d067
# Full Hash: 43764851d067746870a65001786502244d7cf896
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2021-04-07 03:19:44
# Regressor Bug: 1694123
# File Overlap Count: 1
# Description:
#   Bug 1694123 - Pass userfont source index to font loader and decoder tasks, to avoid potential race with the field in the gfxUserFontEntry being reset on the main thread. r=layout-reviewers,emilio
#   
#   This is a preliminary step that is needed in order for the following patch to be safe. (It's
#   mostly just plumbing, although the patch looks big because we need to pass the index through
#   so many functions.)
# ==============================================================================

diff -r 9b111c26978a -r 43764851d067 layout/style/nsFontFaceLoader.cpp
--- a/layout/style/nsFontFaceLoader.cpp	Tue Apr 06 16:20:47 2021 +0000
+++ b/layout/style/nsFontFaceLoader.cpp	Tue Apr 06 16:23:17 2021 +0000
@@ -44,15 +44,21 @@
 }
 
 nsFontFaceLoader::nsFontFaceLoader(gfxUserFontEntry* aUserFontEntry,
-                                   nsIURI* aFontURI, FontFaceSet* aFontFaceSet,
+                                   uint32_t aSrcIndex,
+                                   FontFaceSet* aFontFaceSet,
                                    nsIChannel* aChannel)
     : mUserFontEntry(aUserFontEntry),
-      mFontURI(aFontURI),
       mFontFaceSet(aFontFaceSet),
       mChannel(aChannel),
-      mStreamLoader(nullptr) {
+      mStreamLoader(nullptr),
+      mSrcIndex(aSrcIndex) {
   MOZ_ASSERT(mFontFaceSet,
              "We should get a valid FontFaceSet from the caller!");
+
+  const gfxFontFaceSrc& src = aUserFontEntry->SourceAt(mSrcIndex);
+  MOZ_ASSERT(src.mSourceType == gfxFontFaceSrc::eSourceType_URL);
+
+  mFontURI = src.mURI->get();
   mStartTime = TimeStamp::Now();
 
   // We add an explicit load block rather than just rely on the network
@@ -276,7 +282,8 @@
 
   // FontDataDownloadComplete will load the platform font on a worker thread,
   // and will call FontLoadComplete when it has finished its work.
-  mUserFontEntry->FontDataDownloadComplete(aString, aStringLen, aStatus, this);
+  mUserFontEntry->FontDataDownloadComplete(mSrcIndex, aString, aStringLen,
+                                           aStatus, this);
   return NS_SUCCESS_ADOPTED_DATA;
 }
 