# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/wr/webrender/src/render_task.rs
# Commit: f3b8d237e29a
# Full Hash: f3b8d237e29af262b2042809e13ce6043b75c922
# Author: Lee Salzman <lsalzman@mozilla.com>
# Date: 2021-04-10 03:36:58
# Regressor Bug: 1682195
# File Overlap Count: 1
# Description:
#   Bug 1682195 - Ensure that area outside image mask is cleared if it is first clip. r=gw
#   
#   This fixes a previous bug in the image mask code that the tile rect caused cs_clip_image
#   to use discard on a first clip, the outside area would be left to whatever the initial value
#   of the texture from texture cache was. Since we need to support trimming down to the tile
# ==============================================================================

diff -r b641b7f90108 -r f3b8d237e29a gfx/wr/webrender/src/render_task.rs
--- a/gfx/wr/webrender/src/render_task.rs	Fri Apr 09 22:55:33 2021 +0000
+++ b/gfx/wr/webrender/src/render_task.rs	Fri Apr 09 22:55:34 2021 +0000
@@ -5,7 +5,7 @@
 use api::{CompositeOperator, FilterPrimitive, FilterPrimitiveInput, FilterPrimitiveKind};
 use api::{LineStyle, LineOrientation, ClipMode, MixBlendMode, ColorF, ColorSpace};
 use api::units::*;
-use crate::clip::{ClipDataStore, ClipItemKind, ClipStore, ClipNodeRange, ClipNodeFlags};
+use crate::clip::{ClipDataStore, ClipItemKind, ClipStore, ClipNodeRange};
 use crate::spatial_tree::SpatialNodeIndex;
 use crate::filterdata::SFilterData;
 use crate::frame_builder::FrameBuilderConfig;
@@ -568,24 +568,7 @@
                         }
                     ));
                 }
-                ClipItemKind::Rectangle { mode: ClipMode::Clip, .. } => {
-                    if !clip_instance.flags.contains(ClipNodeFlags::SAME_COORD_SYSTEM) {
-                        // This is conservative - it's only the case that we actually need
-                        // a clear here if we end up adding this mask via add_tiled_clip_mask,
-                        // but for simplicity we will just clear if any of these are encountered,
-                        // since they are rare.
-                        let clip_task = rg_builder.get_task_mut(clip_task_id);
-                        match clip_task.kind {
-                            RenderTaskKind::CacheMask(ref mut task) => {
-                                task.clear_to_one = true;
-                            }
-                            _ => {
-                                unreachable!();
-                            }
-                        }
-                    }
-                }
-                ClipItemKind::Rectangle { mode: ClipMode::ClipOut, .. } |
+                ClipItemKind::Rectangle { .. } |
                 ClipItemKind::RoundedRectangle { .. } |
                 ClipItemKind::Image { .. } => {}
             }
