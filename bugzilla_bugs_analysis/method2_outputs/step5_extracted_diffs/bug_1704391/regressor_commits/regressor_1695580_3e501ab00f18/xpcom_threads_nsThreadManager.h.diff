# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: xpcom/threads/nsThreadManager.h
# Commit: 3e501ab00f18
# Full Hash: 3e501ab00f1855046db1f8db6be58fb35f7c6adc
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-04-07 03:19:44
# Regressor Bug: 1695580
# File Overlap Count: 1
# Description:
#   Bug 1695580 - In xpcom, cancel pending DelayedRunnable timers on shutdown. r=KrisWright
#   
#   Because DelayedRunnables are fire-and-forget, there is no way for a targeted
#   EventTarget to clean them up on shutdown. Thus if a timer fires after
#   EventTarget shutdown it will fail to dispatch the timer event, and avoid
# ==============================================================================

diff -r 2a88ea548a86 -r 3e501ab00f18 xpcom/threads/nsThreadManager.h
--- a/xpcom/threads/nsThreadManager.h	Tue Apr 06 20:15:10 2021 +0000
+++ b/xpcom/threads/nsThreadManager.h	Tue Apr 06 20:15:11 2021 +0000
@@ -67,6 +67,14 @@
   already_AddRefed<nsISerialEventTarget> CreateBackgroundTaskQueue(
       const char* aName);
 
+  // For each background TaskQueue cancel pending DelayedRunnables, and prohibit
+  // creating future DelayedRunnables for them, since we'll soon be shutting
+  // them down.
+  // Pending DelayedRunnables are canceled on their respective TaskQueue.
+  // We block main thread until they are all done, but spin the eventloop in the
+  // meantime.
+  void CancelBackgroundDelayedRunnables();
+
   ~nsThreadManager();
 
   void EnableMainThreadEventPrioritization();
