# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/html/HTMLDialogElement.cpp
# Commit: 130bfa532753
# Full Hash: 130bfa5327532a2b188e4cc06f5e1de7183327e8
# Author: Sean Feng <sefeng@mozilla.com>
# Date: 2021-04-30 09:28:29
# Regressor Bug: 1660271
# File Overlap Count: 1
# Description:
#   Bug 1660271 - Move the focus to the previously focused element when <dialog> is closed r=smaug
#   
#   This change is based on the latest changes for the <dialog> element in
#   https://github.com/whatwg/html/pull/6531, such that closing
#   <dialog> should move the focus to the previously focused element.
# ==============================================================================

diff -r f2ab512468e9 -r 130bfa532753 dom/html/HTMLDialogElement.cpp
--- a/dom/html/HTMLDialogElement.cpp	Thu Apr 29 19:33:02 2021 +0000
+++ b/dom/html/HTMLDialogElement.cpp	Thu Apr 29 19:35:23 2021 +0000
@@ -52,6 +52,18 @@
 
   RemoveFromTopLayerIfNeeded();
 
+  RefPtr<Element> previouslyFocusedElement =
+      do_QueryReferent(mPreviouslyFocusedElement);
+
+  if (previouslyFocusedElement) {
+    mPreviouslyFocusedElement = nullptr;
+
+    FocusOptions options;
+    options.mPreventScroll = true;
+    previouslyFocusedElement->Focus(options, CallerType::NonSystem,
+                                    IgnoredErrorResult());
+  }
+
   RefPtr<AsyncEventDispatcher> eventDispatcher =
       new AsyncEventDispatcher(this, u"close"_ns, CanBubble::eNo);
   eventDispatcher->PostDOMEvent();
@@ -62,6 +74,9 @@
     return;
   }
   SetOpen(true, IgnoreErrors());
+
+  StorePreviouslyFocusedElement();
+
   FocusDialog();
 }
 
@@ -93,6 +108,14 @@
   doc->UnsetBlockedByModalDialog(*this);
 }
 
+void HTMLDialogElement::StorePreviouslyFocusedElement() {
+  if (nsIContent* unretargetedFocus =
+          GetComposedDoc()->GetUnretargetedFocusedContent()) {
+    mPreviouslyFocusedElement =
+        do_GetWeakReference(unretargetedFocus->AsElement());
+  }
+}
+
 void HTMLDialogElement::UnbindFromTree(bool aNullParent) {
   RemoveFromTopLayerIfNeeded();
   nsGenericHTMLElement::UnbindFromTree(aNullParent);
@@ -114,6 +137,8 @@
 
   SetOpen(true, aError);
 
+  StorePreviouslyFocusedElement();
+
   FocusDialog();
 
   aError.SuppressException();