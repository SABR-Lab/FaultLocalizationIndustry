# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/security/test/https-only/file_background_redirect.sjs
# Commit: 9d14d5ae3863
# Full Hash: 9d14d5ae386341911507881b91c4e709795a9395
# Author: lyavor <lyavor@mozilla.com>
# Date: 2021-04-26 15:46:32
# Regressor Bug: 1683015
# File Overlap Count: 1
# Description:
#   Bug 1683015 HTTPS-Only Mode Alert appears on site which supports https. r=ckerschb,JulianWels
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D112702
# ==============================================================================

diff -r 87457b540267 -r 9d14d5ae3863 dom/security/test/https-only/file_background_redirect.sjs
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/security/test/https-only/file_background_redirect.sjs	Mon Apr 26 11:45:20 2021 +0000
@@ -0,0 +1,28 @@
+// Custom *.sjs file specifically for the needs of Bug 1683015
+"use strict";
+
+Cu.import("resource://gre/modules/Timer.jsm");
+
+async function handleRequest(request, response) {
+  // avoid confusing cache behaviour
+  response.setHeader("Cache-Control", "no-cache", false);
+  response.setHeader("Content-Type", "text/html", false);
+
+  let query = request.queryString;
+  if (request.scheme === "https" && query === "start") {
+    // Simulating long repsonse time by processing the https request
+    // using a 5 seconds delay. Note that the http background request
+    // gets send after 3 seconds
+    response.processAsync();
+    setTimeout(() => {
+      response.setStatusLine("1.1", 200, "OK");
+      response.write("<html><body>Test Page for Bug 1683015 loaded</body></html>");
+      response.finish();
+    }, 5000); /* wait 5 seconds */
+    return;
+  }
+
+  // we should never get here, but just in case return something unexpected
+  response.setStatusLine("1.1", 404, "Not Found");
+  response.write("<html><body>SHOULDN'T DISPLAY THIS PAGE</body></html>");
+}
