# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxPlatform.cpp
# Commit: fbe7310ee5f3
# Full Hash: fbe7310ee5f35c9b523ce7c4f6a6887ece5a68b4
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2021-05-18 21:36:28
# Regressor Bug: 1708768
# File Overlap Count: 1
# Description:
#   Bug 1708768 - Create a pref to defer gfxPlatformFontList initialization until first use, and enable this on macOS. r=lsalzman
#   
#   This gives the RegisterFonts thread more time to complete its work, so that
#   the main thread doesn't have to wait for it in InitFontList.
#   
# ==============================================================================

diff -r a01eaeed432a -r fbe7310ee5f3 gfx/thebes/gfxPlatform.cpp
--- a/gfx/thebes/gfxPlatform.cpp	Tue May 18 11:10:42 2021 +0000
+++ b/gfx/thebes/gfxPlatform.cpp	Tue May 18 11:10:43 2021 +0000
@@ -968,8 +968,13 @@
 
   gPlatform->mHasVariationFontSupport = gPlatform->CheckVariationFontSupport();
 
-  if (!gPlatform->CreatePlatformFontList()) {
-    MOZ_CRASH("Could not initialize gfxPlatformFontList");
+  if (!StaticPrefs::gfx_font_list_lazy_init_enabled_AtStartup()) {
+    // On macOS we don't initialize the font list here because we want to allow
+    // more time for the RegisterFonts thread to complete. So it is initialized
+    // lazily on first use; see gfxPlatformFontList::PlatformFontList().
+    if (!gPlatform->CreatePlatformFontList()) {
+      MOZ_CRASH("Could not initialize gfxPlatformFontList");
+    }
   }
 
   gPlatform->mScreenReferenceSurface = gPlatform->CreateOffscreenSurface(