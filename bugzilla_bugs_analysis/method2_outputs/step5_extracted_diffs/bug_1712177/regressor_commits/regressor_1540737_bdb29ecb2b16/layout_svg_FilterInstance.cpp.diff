# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/svg/FilterInstance.cpp
# Commit: bdb29ecb2b16
# Full Hash: bdb29ecb2b16458ca5c84594a5c9a0a6febc6249
# Author: Matt Woodrow <mwoodrow@mozilla.com>
# Date: 2021-05-16 09:17:48
# Regressor Bug: 1540737
# File Overlap Count: 1
# Description:
#   Bug 1540737 - Allow filter painting to take a callback for painting children. r=miko
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D114670
# ==============================================================================

diff -r f54a65e66247 -r bdb29ecb2b16 layout/svg/FilterInstance.cpp
--- a/layout/svg/FilterInstance.cpp	Sat May 15 22:16:48 2021 +0000
+++ b/layout/svg/FilterInstance.cpp	Sat May 15 22:38:43 2021 +0000
@@ -29,7 +29,6 @@
 #include "mozilla/SVGFilterInstance.h"
 #include "mozilla/SVGUtils.h"
 #include "CSSFilterInstance.h"
-#include "SVGFilterPaintCallback.h"
 #include "SVGIntegrationUtils.h"
 
 using namespace mozilla::dom;
@@ -60,12 +59,10 @@
   return MakeUnique<NonSVGFrameUserSpaceMetrics>(aFrame);
 }
 
-void FilterInstance::PaintFilteredFrame(nsIFrame* aFilteredFrame,
-                                        gfxContext* aCtx,
-                                        SVGFilterPaintCallback* aPaintCallback,
-                                        const nsRegion* aDirtyArea,
-                                        imgDrawingParams& aImgParams,
-                                        float aOpacity) {
+void FilterInstance::PaintFilteredFrame(
+    nsIFrame* aFilteredFrame, gfxContext* aCtx,
+    const SVGFilterPaintCallback& aPaintCallback, const nsRegion* aDirtyArea,
+    imgDrawingParams& aImgParams, float aOpacity) {
   auto filterChain = aFilteredFrame->StyleEffects()->mFilters.AsSpan();
   UniquePtr<UserSpaceMetrics> metrics =
       UserSpaceMetricsForFrame(aFilteredFrame);
@@ -437,7 +434,7 @@
 FilterInstance::FilterInstance(
     nsIFrame* aTargetFrame, nsIContent* aTargetContent,
     const UserSpaceMetrics& aMetrics, Span<const StyleFilter> aFilterChain,
-    bool aFilterInputIsTainted, SVGFilterPaintCallback* aPaintCallback,
+    bool aFilterInputIsTainted, const SVGFilterPaintCallback& aPaintCallback,
     const gfxMatrix& aPaintTransform, const nsRegion* aPostFilterDirtyRegion,
     const nsRegion* aPreFilterDirtyRegion,
     const nsRect* aPreFilterInkOverflowRectOverride,
@@ -733,7 +730,7 @@
     imageFlags &= ~imgIContainer::FLAG_HIGH_QUALITY_SCALING;
   }
   imgDrawingParams imgParams(imageFlags);
-  mPaintCallback->Paint(*ctx, mTargetFrame, mPaintTransform, &dirty, imgParams);
+  mPaintCallback(*ctx, mTargetFrame, mPaintTransform, &dirty, imgParams);
   aImgParams.result = imgParams.result;
 
   mSourceGraphic.mSourceSurface = offscreenDT->Snapshot();