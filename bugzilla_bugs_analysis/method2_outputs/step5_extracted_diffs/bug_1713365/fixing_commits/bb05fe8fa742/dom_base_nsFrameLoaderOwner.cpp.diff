# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/base/nsFrameLoaderOwner.cpp
# Commit: bb05fe8fa742
# Full Hash: bb05fe8fa742e7e470509f52a957d3b82ced2acb
# Author: Olli Pettay <Olli.Pettay@helsinki.fi>
# Date: 2021-06-04 10:21:11
# Description:
#   Bug 1713365, don't try to bfcache if the session history entry already has a frameloader, r=peterv
#   
#   The crash happens currently when there are more than one loading session history entries at the same time and when
#   the latter load then accesses current active entry, it has already the bfcached frameloader.
#   
# ==============================================================================

diff -r 52ed1b7f1fb0 -r bb05fe8fa742 dom/base/nsFrameLoaderOwner.cpp
--- a/dom/base/nsFrameLoaderOwner.cpp	Thu Jun 03 20:31:22 2021 +0000
+++ b/dom/base/nsFrameLoaderOwner.cpp	Thu Jun 03 20:34:24 2021 +0000
@@ -132,32 +132,19 @@
       networkCreated = mFrameLoader->IsNetworkCreated();
 
       MOZ_ASSERT_IF(aOptions.mTryUseBFCache, aOptions.mReplaceBrowsingContext);
-      if (aOptions.mTryUseBFCache) {
-        if (bc) {
-          SessionHistoryEntry* she =
-              bc->Canonical()->GetActiveSessionHistoryEntry();
-          if (she) {
-            MOZ_LOG(
-                gSHIPBFCacheLog, LogLevel::Debug,
-                ("nsFrameLoaderOwner::ChangeRemotenessCommon: store the old "
-                 "page in bfcache"));
-            Unused << bc->SetIsInBFCache(true);
-            if (she->GetFrameLoader()) {
-              MOZ_LOG(gSHIPBFCacheLog, LogLevel::Debug,
-                      ("nsFrameLoaderOwner::ChangeRemotenessCommon: active "
-                       "session history entry "
-                       "has already an nsFrameLoader!, FIXME"));
-              MOZ_DIAGNOSTIC_ASSERT(false,
-                                    "The current session history entry has "
-                                    "already an nsFrameLoader!");
-              RefPtr<nsFrameLoader> oldFrameLoader = she->GetFrameLoader();
-              she->SetFrameLoader(nullptr);
-              oldFrameLoader->Destroy();
-            }
-            she->SetFrameLoader(mFrameLoader);
-            // Session history owns now the frameloader.
-            mFrameLoader = nullptr;
-          }
+      if (aOptions.mTryUseBFCache && bc) {
+        SessionHistoryEntry* she =
+            bc->Canonical()->GetActiveSessionHistoryEntry();
+        bool useBFCache = she && she == aOptions.mActiveSessionHistoryEntry &&
+                          !she->GetFrameLoader();
+        if (useBFCache) {
+          MOZ_LOG(gSHIPBFCacheLog, LogLevel::Debug,
+                  ("nsFrameLoaderOwner::ChangeRemotenessCommon: store the old "
+                   "page in bfcache"));
+          Unused << bc->SetIsInBFCache(true);
+          she->SetFrameLoader(mFrameLoader);
+          // Session history owns now the frameloader.
+          mFrameLoader = nullptr;
         }
       }
 