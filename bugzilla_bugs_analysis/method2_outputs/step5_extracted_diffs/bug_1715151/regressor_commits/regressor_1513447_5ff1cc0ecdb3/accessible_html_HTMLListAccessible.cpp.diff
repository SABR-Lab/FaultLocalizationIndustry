# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/html/HTMLListAccessible.cpp
# Commit: 5ff1cc0ecdb3
# Full Hash: 5ff1cc0ecdb3cc503d6e0b6f5509eda78d551c7a
# Author: Eitan Isaacson <eitan@monotonous.org>
# Date: 2021-05-05 04:13:36
# Regressor Bug: 1513447
# File Overlap Count: 1
# Description:
#   Bug 1513447 - Use generated marker elements for list bullet accessibles. r=Jamie
#   
#   In 1513447 there is a demonstrated instance in which the generated
#   marker is replaced with another one and throws the list item bullet
#   state into an unknown state. To remedy this we need to observe when such
# ==============================================================================

diff -r 029a5e8fa8f3 -r 5ff1cc0ecdb3 accessible/html/HTMLListAccessible.cpp
--- a/accessible/html/HTMLListAccessible.cpp	Tue May 04 18:46:44 2021 +0000
+++ b/accessible/html/HTMLListAccessible.cpp	Tue May 04 19:07:59 2021 +0000
@@ -9,6 +9,8 @@
 #include "DocAccessible.h"
 #include "EventTree.h"
 #include "nsAccUtils.h"
+#include "nsPersistentProperties.h"
+#include "nsTextEquivUtils.h"
 #include "Role.h"
 #include "States.h"
 
@@ -36,25 +38,8 @@
 ////////////////////////////////////////////////////////////////////////////////
 
 HTMLLIAccessible::HTMLLIAccessible(nsIContent* aContent, DocAccessible* aDoc)
-    : HyperTextAccessibleWrap(aContent, aDoc), mBullet(nullptr) {
+    : HyperTextAccessibleWrap(aContent, aDoc) {
   mType = eHTMLLiType;
-
-  if (nsBulletFrame* bulletFrame =
-          do_QueryFrame(nsLayoutUtils::GetMarkerFrame(aContent))) {
-    const nsStyleList* styleList = bulletFrame->StyleList();
-    if (!styleList->mListStyleImage.IsNone() ||
-        !styleList->mCounterStyle.IsNone()) {
-      mBullet = new HTMLListBulletAccessible(mContent, mDoc);
-      Document()->BindToDocument(mBullet, nullptr);
-      AppendChild(mBullet);
-    }
-  }
-}
-
-void HTMLLIAccessible::Shutdown() {
-  mBullet = nullptr;
-
-  HyperTextAccessibleWrap::Shutdown();
 }
 
 role HTMLLIAccessible::NativeRole() const {
@@ -68,54 +53,24 @@
 
 nsRect HTMLLIAccessible::BoundsInAppUnits() const {
   nsRect rect = AccessibleWrap::BoundsInAppUnits();
-  if (rect.IsEmpty() || !mBullet || mBullet->IsInside()) {
-    return rect;
+
+  LocalAccessible* bullet = Bullet();
+  if (bullet && GetFrame()->StyleList()->mListStylePosition !=
+                    NS_STYLE_LIST_STYLE_POSITION_INSIDE) {
+    nsRect bulletRect = bullet->BoundsInAppUnits();
+    return rect.Union(bulletRect);
   }
 
-  nsRect bulletRect = mBullet->BoundsInAppUnits();
-  // Move x coordinate of list item over to cover bullet as well
-  rect.SetLeftEdge(bulletRect.X());
   return rect;
 }
 
-bool HTMLLIAccessible::InsertChildAt(uint32_t aIndex, LocalAccessible* aChild) {
-  // Adjust index if there's a bullet.
-  if (mBullet && aIndex == 0 && aChild != mBullet) {
-    return HyperTextAccessible::InsertChildAt(aIndex + 1, aChild);
+LocalAccessible* HTMLLIAccessible::Bullet() const {
+  LocalAccessible* firstChild = LocalFirstChild();
+  if (firstChild && firstChild->NativeRole() == roles::LISTITEM_MARKER) {
+    return firstChild;
   }
 
-  return HyperTextAccessible::InsertChildAt(aIndex, aChild);
-}
-
-void HTMLLIAccessible::RelocateChild(uint32_t aNewIndex,
-                                     LocalAccessible* aChild) {
-  // Don't allow moving a child in front of the bullet.
-  if (mBullet && aChild != mBullet && aNewIndex != 0) {
-    HyperTextAccessible::RelocateChild(aNewIndex, aChild);
-  }
-}
-
-////////////////////////////////////////////////////////////////////////////////
-// HTMLLIAccessible: public
-
-void HTMLLIAccessible::UpdateBullet(bool aHasBullet) {
-  if (aHasBullet == !!mBullet) {
-    MOZ_ASSERT_UNREACHABLE("Bullet and accessible are in sync already!");
-    return;
-  }
-
-  TreeMutation mt(this);
-  if (aHasBullet) {
-    mBullet = new HTMLListBulletAccessible(mContent, mDoc);
-    mDoc->BindToDocument(mBullet, nullptr);
-    InsertChildAt(0, mBullet);
-    mt.AfterInsertion(mBullet);
-  } else {
-    mt.BeforeRemoval(mBullet);
-    RemoveChild(mBullet);
-    mBullet = nullptr;
-  }
-  mt.Done();
+  return nullptr;
 }
 
 ////////////////////////////////////////////////////////////////////////////////
@@ -125,34 +80,30 @@
                                                    DocAccessible* aDoc)
     : LeafAccessible(aContent, aDoc) {
   mGenericTypes |= eText;
-  mStateFlags |= eSharedNode;
 }
 
 ////////////////////////////////////////////////////////////////////////////////
 // HTMLListBulletAccessible: LocalAccessible
 
-nsIFrame* HTMLListBulletAccessible::GetFrame() const {
-  return nsLayoutUtils::GetMarkerFrame(mContent);
-}
-
 ENameValueFlag HTMLListBulletAccessible::Name(nsString& aName) const {
   aName.Truncate();
 
   // Native anonymous content, ARIA can't be used. Get list bullet text.
-  nsBulletFrame* frame = do_QueryFrame(GetFrame());
-  if (!frame) {
-    return eNameOK;
+  if (nsBulletFrame* frame = do_QueryFrame(GetFrame())) {
+    if (!frame->StyleList()->mListStyleImage.IsNone()) {
+      // Bullet is an image, so use default bullet character.
+      const char16_t kDiscCharacter = 0x2022;
+      aName.Assign(kDiscCharacter);
+      aName.Append(' ');
+      return eNameOK;
+    }
+    frame->GetSpokenText(aName);
+  } else {
+    // If marker is not a bullet frame but instead has content
+    nsTextEquivUtils::AppendFromDOMChildren(mContent, &aName);
+    aName.CompressWhitespace();
   }
 
-  if (!frame->StyleList()->mListStyleImage.IsNone()) {
-    // Bullet is an image, so use default bullet character.
-    const char16_t kDiscCharacter = 0x2022;
-    aName.Assign(kDiscCharacter);
-    aName.Append(' ');
-    return eNameOK;
-  }
-
-  frame->GetSpokenText(aName);
   return eNameOK;
 }
 
@@ -164,6 +115,12 @@
   return LeafAccessible::NativeState() | states::READONLY;
 }
 
+already_AddRefed<nsIPersistentProperties>
+HTMLListBulletAccessible::NativeAttributes() {
+  RefPtr<nsPersistentProperties> attributes = new nsPersistentProperties();
+  return attributes.forget();
+}
+
 void HTMLListBulletAccessible::AppendTextTo(nsAString& aText,
                                             uint32_t aStartOffset,
                                             uint32_t aLength) {
@@ -171,14 +128,3 @@
   Name(bulletText);
   aText.Append(Substring(bulletText, aStartOffset, aLength));
 }
-
-////////////////////////////////////////////////////////////////////////////////
-// HTMLListBulletAccessible: public
-
-bool HTMLListBulletAccessible::IsInside() const {
-  if (nsIFrame* frame = mContent->GetPrimaryFrame()) {
-    return frame->StyleList()->mListStylePosition ==
-           NS_STYLE_LIST_STYLE_POSITION_INSIDE;
-  }
-  return false;
-}