# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsWindow.cpp
# Commit: 3c74d415fafd
# Full Hash: 3c74d415fafd4bff5576ed0a2256c1a0232b5937
# Author: Robert Mader <robert.mader@posteo.de>
# Date: 2021-06-11 09:42:05
# Regressor Bug: 1711244
# File Overlap Count: 2
# Description:
#   Bug 1711244 - Integrate NativeLayerWayland with WaylandVsyncSource, r=stransky,gfx-reviewers,jrmuizel
#   
#   Make the vsync source request frame callbacks from opaque native
#   layers. This is necessary as opaque layers may occlude the
#   MozContainer surface, which is normally used for frame callbacks.
# ==============================================================================

diff -r bc5ca21bf534 -r 3c74d415fafd widget/gtk/nsWindow.cpp
--- a/widget/gtk/nsWindow.cpp	Thu Jun 10 14:58:53 2021 +0000
+++ b/widget/gtk/nsWindow.cpp	Thu Jun 10 15:12:54 2021 +0000
@@ -5592,16 +5592,14 @@
     }
     // Dummy call to a function in mozgtk to prevent the linker from removing
     // the dependency with --as-needed.
-    if (GdkIsX11Display()) {
-      XShmQueryExtension(DefaultXDisplay());
-    }
-  }
-#  ifdef MOZ_WAYLAND
-  else if (GdkIsWaylandDisplay()) {
+    XShmQueryExtension(DefaultXDisplay());
+  }
+#endif
+#ifdef MOZ_WAYLAND
+  if (GdkIsWaylandDisplay()) {
     mSurfaceProvider.Initialize(this);
     WaylandStartVsync();
   }
-#  endif
 #endif
 
   // Set default application name when it's empty.
@@ -5841,17 +5839,29 @@
 void nsWindow::WaylandStartVsync() {
 #ifdef MOZ_WAYLAND
   // only use for toplevel windows for now - see bug 1619246
-  if (!StaticPrefs::widget_wayland_vsync_enabled_AtStartup() ||
+  if (!GdkIsWaylandDisplay() ||
+      !StaticPrefs::widget_wayland_vsync_enabled_AtStartup() ||
       mWindowType != eWindowType_toplevel) {
     return;
   }
 
   if (!mWaylandVsyncSource) {
-    mWaylandVsyncSource = new mozilla::WaylandVsyncSource(mContainer);
-  }
+    mWaylandVsyncSource = new WaylandVsyncSource();
+  }
+
   WaylandVsyncSource::WaylandDisplay& display =
       static_cast<WaylandVsyncSource::WaylandDisplay&>(
           mWaylandVsyncSource->GetGlobalDisplay());
+
+  if (mCompositorWidgetDelegate) {
+    if (RefPtr<layers::NativeLayerRoot> nativeLayerRoot =
+            mCompositorWidgetDelegate->AsGtkCompositorWidget()
+                ->GetNativeLayerRoot()) {
+      display.MaybeUpdateSource(nativeLayerRoot->AsNativeLayerRootWayland());
+    } else {
+      display.MaybeUpdateSource(mContainer);
+    }
+  }
   display.EnableMonitor();
 #endif
 }
@@ -5865,6 +5875,7 @@
         static_cast<WaylandVsyncSource::WaylandDisplay&>(
             mWaylandVsyncSource->GetGlobalDisplay());
     display.DisableMonitor();
+    display.MaybeUpdateSource(nullptr);
   }
 #endif
 }
@@ -8170,8 +8181,10 @@
     MOZ_ASSERT(mCompositorWidgetDelegate,
                "nsWindow::SetCompositorWidgetDelegate called with a "
                "non-PlatformCompositorWidgetDelegate");
+    WaylandStartVsync();
     MaybeResumeCompositor();
   } else {
+    WaylandStopVsync();
     mCompositorWidgetDelegate = nullptr;
   }
 }
