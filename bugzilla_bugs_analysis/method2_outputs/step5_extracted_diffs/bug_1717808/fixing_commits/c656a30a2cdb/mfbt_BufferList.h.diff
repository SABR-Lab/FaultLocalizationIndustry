# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: mfbt/BufferList.h
# Commit: c656a30a2cdb
# Full Hash: c656a30a2cdb83dfd42bf7c9964138d7a897df84
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-07-07 21:52:19
# Description:
#   Bug 1717808 - aIter must be valid after extracting last segment of a BufferList, r=glandium
#   
#   When advancing to Beta, we stop adding sentinels after serialized data
#   in IPC::Message objects. These sentinels would cause all Extract calls
#   to not reach the end of the message buffer on Nightly. This patch fixes
# ==============================================================================

diff -r be090a2e202a -r c656a30a2cdb mfbt/BufferList.h
--- a/mfbt/BufferList.h	Wed Jul 07 18:01:05 2021 +0000
+++ b/mfbt/BufferList.h	Wed Jul 07 18:03:03 2021 +0000
@@ -658,6 +658,20 @@
     aIter.mAbsoluteOffset -= removedBytes;
     mSize -= removedBytes;
 
+    // If our iterator is already at the end, we just removed the very last
+    // segment of our buffer list and need to shift the iterator back to point
+    // at the end of the previous segment.
+    if (aIter.Done()) {
+      MOZ_ASSERT(lastSegmentSize.isNothing());
+      if (mSegments.empty()) {
+        MOZ_ASSERT(aIter.mSegment == 0);
+        aIter.mData = aIter.mDataEnd = nullptr;
+      } else {
+        MOZ_ASSERT(aIter.mSegment == mSegments.length() - 1);
+        aIter.mData = aIter.mDataEnd = mSegments.back().End();
+      }
+    }
+
     if (lastSegmentSize.isSome()) {
       // We called reserve() on result.mSegments so infallibleAppend is safe.
       result.mSegments.infallibleAppend(
@@ -673,6 +687,15 @@
   AssertConsistentSize();
   result.AssertConsistentSize();
 
+  // Ensure that the iterator is still valid when Extract returns.
+#ifdef DEBUG
+  if (!mSegments.empty()) {
+    auto& segment = mSegments[aIter.mSegment];
+    MOZ_ASSERT(segment.Start() <= aIter.mData);
+    MOZ_ASSERT(aIter.mDataEnd == segment.End());
+  }
+#endif
+
   *aSuccess = true;
   return result;
 }