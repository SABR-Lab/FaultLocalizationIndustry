# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: mfbt/tests/TestBufferList.cpp
# Commit: c656a30a2cdb
# Full Hash: c656a30a2cdb83dfd42bf7c9964138d7a897df84
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-07-07 21:52:19
# Description:
#   Bug 1717808 - aIter must be valid after extracting last segment of a BufferList, r=glandium
#   
#   When advancing to Beta, we stop adding sentinels after serialized data
#   in IPC::Message objects. These sentinels would cause all Extract calls
#   to not reach the end of the message buffer on Nightly. This patch fixes
# ==============================================================================

diff -r be090a2e202a -r c656a30a2cdb mfbt/tests/TestBufferList.cpp
--- a/mfbt/tests/TestBufferList.cpp	Wed Jul 07 18:01:05 2021 +0000
+++ b/mfbt/tests/TestBufferList.cpp	Wed Jul 07 18:03:03 2021 +0000
@@ -299,6 +299,8 @@
   MOZ_RELEASE_ASSERT(success);
   MOZ_RELEASE_ASSERT(bl11.Size() == 16);
   MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(iter.AdvanceAcrossSegments(bl10, 0));
+  MOZ_RELEASE_ASSERT(iter.Done());
   iter = bl11.Iter();
   MOZ_RELEASE_ASSERT(bl11.ReadBytes(iter, data, 16));
   MOZ_RELEASE_ASSERT(memcmp(data, "abcdefgh12345678", 16) == 0);
