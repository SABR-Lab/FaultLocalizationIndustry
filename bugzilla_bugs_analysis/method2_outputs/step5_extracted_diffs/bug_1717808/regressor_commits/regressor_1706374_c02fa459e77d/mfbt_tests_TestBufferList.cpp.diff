# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: mfbt/tests/TestBufferList.cpp
# Commit: c02fa459e77d
# Full Hash: c02fa459e77d2572b2fe740f20d6070a77383589
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-06-22 21:29:07
# Regressor Bug: 1706374
# File Overlap Count: 2
# Description:
#   Bug 1706374 - Part 13: Remove the event footer from an IPC::Message when deserializing, r=handyman,glandium
#   
#   This unfortunately requires a new method to be added to BufferList to
#   support truncating the buffer to a particular iterator.
#   
# ==============================================================================

diff -r 72dc6537cf0b -r c02fa459e77d mfbt/tests/TestBufferList.cpp
--- a/mfbt/tests/TestBufferList.cpp	Mon Jun 21 21:53:11 2021 +0000
+++ b/mfbt/tests/TestBufferList.cpp	Mon Jun 21 21:53:11 2021 +0000
@@ -367,5 +367,67 @@
   MOZ_RELEASE_ASSERT(iter1.AdvanceAcrossSegments(bl12, 1));
   MOZ_RELEASE_ASSERT(iter1.Done());
 
+  BufferList bl13(0, 0, 8);
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("abcdefgh", 8));
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("12345678", 8));
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("ABCDEFGH", 8));
+  MOZ_RELEASE_ASSERT(bl13.Size() == 24);
+
+  // At segment border
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(iter.AdvanceAcrossSegments(bl13, 8));
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 16);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 8);
+
+  // Restore state
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("12345678", 8));
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("ABCDEFGH", 8));
+  MOZ_RELEASE_ASSERT(bl13.Size() == 24);
+
+  // Before segment border
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(iter.AdvanceAcrossSegments(bl13, 7));
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 17);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 7);
+
+  // Restore state
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("h", 1));
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("12345678", 8));
+  MOZ_ALWAYS_TRUE(bl13.WriteBytes("ABCDEFGH", 8));
+  MOZ_RELEASE_ASSERT(bl13.Size() == 24);
+
+  // In last segment
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(iter.AdvanceAcrossSegments(bl13, 20));
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 4);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 20);
+
+  // No-op truncate
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 0);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 20);
+
+  // No-op truncate with fresh iterator
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(iter.AdvanceAcrossSegments(bl13, 20));
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 0);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 20);
+
+  // Truncate at start of buffer
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 20);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 0);
+
+  // No-op truncate at start of buffer
+  iter = bl13.Iter();
+  MOZ_RELEASE_ASSERT(bl13.Truncate(iter) == 0);
+  MOZ_RELEASE_ASSERT(iter.Done());
+  MOZ_RELEASE_ASSERT(bl13.Size() == 0);
+
   return 0;
 }
