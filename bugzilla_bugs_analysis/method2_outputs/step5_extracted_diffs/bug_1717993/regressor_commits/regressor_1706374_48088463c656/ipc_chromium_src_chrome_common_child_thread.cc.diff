# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: ipc/chromium/src/chrome/common/child_thread.cc
# Commit: 48088463c656
# Full Hash: 48088463c6568b03a3e6a4ca6417dd9b650ced2a
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-06-22 21:29:07
# Regressor Bug: 1706374
# File Overlap Count: 2
# Description:
#   Bug 1706374 - Part 12a: Initialize NodeController when creating IO thread, r=handyman
#   
#   This also consumes the existing channel created when launching a process to
#   create the the conneciton required by NodeController for communicating between
#   processes. In part 12b, consumers of the broken APIs will be adjusted to use
# ==============================================================================

diff -r b09ae4c3a94b -r 48088463c656 ipc/chromium/src/chrome/common/child_thread.cc
--- a/ipc/chromium/src/chrome/common/child_thread.cc	Mon Jun 21 21:53:10 2021 +0000
+++ b/ipc/chromium/src/chrome/common/child_thread.cc	Mon Jun 21 21:53:10 2021 +0000
@@ -7,6 +7,7 @@
 #include "chrome/common/child_thread.h"
 
 #include "chrome/common/child_process.h"
+#include "mozilla/ipc/NodeController.h"
 
 ChildThread::ChildThread(Thread::Options options)
     : Thread("IPC I/O Child"),
@@ -35,12 +36,11 @@
 }
 
 void ChildThread::Init() {
-  channel_ = mozilla::MakeUnique<IPC::Channel>(channel_name_,
-                                               IPC::Channel::MODE_CLIENT, this);
+  auto channel = mozilla::MakeUnique<IPC::Channel>(
+      channel_name_, IPC::Channel::MODE_CLIENT, this);
+
+  initial_port_ =
+      mozilla::ipc::NodeController::InitChildProcess(std::move(channel));
 }
 
-void ChildThread::CleanUp() {
-  // Need to destruct the SyncChannel to the browser before we go away because
-  // it caches a pointer to this thread.
-  channel_ = nullptr;
-}
+void ChildThread::CleanUp() { mozilla::ipc::NodeController::CleanUp(); }