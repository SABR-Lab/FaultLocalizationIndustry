# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: ipc/glue/ScopedPort.cpp
# Commit: b09ae4c3a94b
# Full Hash: b09ae4c3a94b663279189c50172c1f403d499183
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-06-22 21:29:07
# Regressor Bug: 1706374
# File Overlap Count: 1
# Description:
#   Bug 1706374 - Part 11: Add NodeController component bridging IPC and Ports, r=handyman
#   
#   The NodeController and NodeChannel types act as the backbone connecting the
#   existing IPC logic and driving the ports routing code. Individual NodeChannel
#   objects wrap and respond to messages from IPC::Channel, and the NodeController
# ==============================================================================

diff -r 04422175004b -r b09ae4c3a94b ipc/glue/ScopedPort.cpp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/ipc/glue/ScopedPort.cpp	Mon Jun 21 21:53:10 2021 +0000
@@ -0,0 +1,54 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#include "mozilla/ipc/ScopedPort.h"
+#include "mozilla/ipc/NodeController.h"
+
+namespace mozilla::ipc {
+
+void ScopedPort::Reset() {
+  if (mValid) {
+    mController->ClosePort(mPort);
+  }
+  mValid = false;
+  mPort = {};
+  mController = nullptr;
+}
+
+auto ScopedPort::Release() -> PortRef {
+  if (!mValid) {
+    return {};
+  }
+  mValid = false;
+  mController = nullptr;
+  return std::exchange(mPort, PortRef{});
+}
+
+ScopedPort::ScopedPort() = default;
+
+ScopedPort::~ScopedPort() { Reset(); }
+
+ScopedPort::ScopedPort(PortRef aPort, NodeController* aController)
+    : mValid(true), mPort(std::move(aPort)), mController(aController) {
+  MOZ_ASSERT(mPort.is_valid() && mController);
+}
+
+ScopedPort::ScopedPort(ScopedPort&& aOther)
+    : mValid(std::exchange(aOther.mValid, false)),
+      mPort(std::move(aOther.mPort)),
+      mController(std::move(aOther.mController)) {}
+
+ScopedPort& ScopedPort::operator=(ScopedPort&& aOther) {
+  if (this != &aOther) {
+    Reset();
+    mValid = std::exchange(aOther.mValid, false);
+    mPort = std::move(aOther.mPort);
+    mController = std::move(aOther.mController);
+  }
+  return *this;
+}
+
+}  // namespace mozilla::ipc