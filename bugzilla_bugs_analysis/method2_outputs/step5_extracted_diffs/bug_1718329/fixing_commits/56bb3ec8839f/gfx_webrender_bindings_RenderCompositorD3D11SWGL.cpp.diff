# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/webrender_bindings/RenderCompositorD3D11SWGL.cpp
# Commit: 56bb3ec8839f
# Full Hash: 56bb3ec8839f3ef8c762210b325af4f8e0059269
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2021-07-30 03:38:17
# Description:
#   Bug 1718329 - Gracefully handle device reset when mapping tiles with SW-WR + D3D11 compositing. r=jrmuizel
#   
#   If we encounter a device reset in
#   RenderCompositorD3D11SWGL::TileD3D11::Map, we should fail the call, and
#   rely upon the device reset checks at the end of a render pass to
# ==============================================================================

diff -r c55a9d422f8d -r 56bb3ec8839f gfx/webrender_bindings/RenderCompositorD3D11SWGL.cpp
--- a/gfx/webrender_bindings/RenderCompositorD3D11SWGL.cpp	Thu Jul 29 22:40:45 2021 +0000
+++ b/gfx/webrender_bindings/RenderCompositorD3D11SWGL.cpp	Thu Jul 29 22:45:41 2021 +0000
@@ -297,13 +297,15 @@
       }
       hr = context->Map(mRenderCompositor->mCurrentStagingTexture, 0,
                         D3D11_MAP_READ_WRITE, 0, &mappedSubresource);
-      MOZ_RELEASE_ASSERT(SUCCEEDED(hr));
     }
   }
   if (!SUCCEEDED(hr)) {
     gfxCriticalError() << "Failed to map tile: " << gfx::hexa(hr);
+    // This is only expected to fail if we hit a device reset.
+    MOZ_RELEASE_ASSERT(
+        mRenderCompositor->GetDevice()->GetDeviceRemovedReason() != S_OK);
+    return false;
   }
-  MOZ_RELEASE_ASSERT(SUCCEEDED(hr));
 
   // aData is expected to contain a pointer to the first pixel within the valid
   // rect, so take the mapped resource's data (which covers the full tile size)
