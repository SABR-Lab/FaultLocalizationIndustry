# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/src/builtin/RegExp.cpp
# Commit: 38aa248ef576
# Full Hash: 38aa248ef5760830f21cc9c92f4182b8ae1ed81f
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2021-07-16 21:43:02
# Description:
#   Bug 1718842: Use correct compartment and realm for group objects. r=iain
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D119025
# ==============================================================================

diff -r abf91c0aeefd -r 38aa248ef576 js/src/builtin/RegExp.cpp
--- a/js/src/builtin/RegExp.cpp	Fri Jul 16 20:35:55 2021 +0300
+++ b/js/src/builtin/RegExp.cpp	Fri Jul 16 17:31:30 2021 +0000
@@ -47,6 +47,17 @@
     return NewObjectWithGivenProto<PlainObject>(cx, nullptr);
   }
 
+  // The groups template object is stored in RegExpShared, which is shared
+  // across compartments and realms. So watch out for the case when the template
+  // object's realm is different from the current realm.
+  if (cx->realm() != groupsTemplate->realm()) {
+    PlainObject* result;
+    JS_TRY_VAR_OR_RETURN_NULL(
+        cx, result,
+        PlainObject::createWithTemplateFromDifferentRealm(cx, groupsTemplate));
+    return result;
+  }
+
   PlainObject* result;
   JS_TRY_VAR_OR_RETURN_NULL(
       cx, result, PlainObject::createWithTemplate(cx, groupsTemplate));