# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/src/vm/PlainObject.cpp
# Commit: 38aa248ef576
# Full Hash: 38aa248ef5760830f21cc9c92f4182b8ae1ed81f
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2021-07-16 21:43:02
# Description:
#   Bug 1718842: Use correct compartment and realm for group objects. r=iain
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D119025
# ==============================================================================

diff -r abf91c0aeefd -r 38aa248ef576 js/src/vm/PlainObject.cpp
--- a/js/src/vm/PlainObject.cpp	Fri Jul 16 20:35:55 2021 +0300
+++ b/js/src/vm/PlainObject.cpp	Fri Jul 16 17:31:30 2021 +0000
@@ -80,6 +80,33 @@
 }
 #endif
 
+JS::Result<PlainObject*, JS::OOM>
+PlainObject::createWithTemplateFromDifferentRealm(
+    JSContext* cx, HandlePlainObject templateObject) {
+  MOZ_ASSERT(cx->realm() != templateObject->realm(),
+             "Use createWithTemplate() for same-realm objects");
+
+  // Currently only implemented for null-proto.
+  MOZ_ASSERT(templateObject->staticPrototype() == nullptr);
+
+  // The object mustn't be in dictionary mode.
+  MOZ_ASSERT(!templateObject->shape()->isDictionary());
+
+  TaggedProto proto = TaggedProto(nullptr);
+  Shape* templateShape = templateObject->shape();
+  Rooted<SharedPropMap*> map(cx, templateShape->propMap()->asShared());
+
+  RootedShape shape(
+      cx, SharedShape::getInitialOrPropMapShape(
+              cx, &PlainObject::class_, cx->realm(), proto,
+              templateShape->numFixedSlots(), map,
+              templateShape->propMapLength(), templateShape->objectFlags()));
+  if (!shape) {
+    return nullptr;
+  }
+  return createWithShape(cx, shape);
+}
+
 static bool AddPlainObjectProperties(JSContext* cx, HandlePlainObject obj,
                                      IdValuePair* properties,
                                      size_t nproperties) {