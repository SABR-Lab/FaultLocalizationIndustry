# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxXlibSurface.h
# Commit: c1bd0996764c
# Full Hash: c1bd0996764c49174c9169fe5550905ce5dcef88
# Author: Jed Davis <jld@mozilla.com>
# Date: 2021-07-06 21:42:42
# Regressor Bug: 1635451
# File Overlap Count: 1
# Description:
#   Bug 1635451 - Allow GLX to work in headless content processes. r=jgilbert
#   
#   This follows what we're already doing for EGL: a refcounted object
#   which can own the X connection, where we hold a weak reference from
#   the library object so that multiple contexts opportunistically share
# ==============================================================================

diff -r 2974b1ba2beb -r c1bd0996764c gfx/thebes/gfxXlibSurface.h
--- a/gfx/thebes/gfxXlibSurface.h	Tue Jul 06 07:42:41 2021 +0000
+++ b/gfx/thebes/gfxXlibSurface.h	Tue Jul 06 07:42:42 2021 +0000
@@ -13,6 +13,7 @@
 #include "X11UndefineNone.h"
 
 #include "GLXLibrary.h"
+#include "mozilla/gfx/XlibDisplay.h"
 
 #include "nsSize.h"
 
@@ -31,6 +32,9 @@
   // and known width/height.
   gfxXlibSurface(Display* dpy, Drawable drawable, Visual* visual,
                  const mozilla::gfx::IntSize& size);
+  gfxXlibSurface(const std::shared_ptr<mozilla::gfx::XlibDisplay>& dpy,
+                 Drawable drawable, Visual* visual,
+                 const mozilla::gfx::IntSize& size);
 
   // construct a wrapper around the specified drawable with dpy/format,
   // and known width/height.
@@ -46,6 +50,10 @@
   static already_AddRefed<gfxXlibSurface> Create(
       ::Screen* screen, Visual* visual, const mozilla::gfx::IntSize& size,
       Drawable relatedDrawable = X11None);
+  static already_AddRefed<gfxXlibSurface> Create(
+      const std::shared_ptr<mozilla::gfx::XlibDisplay>& display,
+      ::Screen* screen, Visual* visual, const mozilla::gfx::IntSize& size,
+      Drawable relatedDrawable = X11None);
   static cairo_surface_t* CreateCairoSurface(
       ::Screen* screen, Visual* visual, const mozilla::gfx::IntSize& size,
       Drawable relatedDrawable = X11None);
@@ -61,7 +69,7 @@
 
   const mozilla::gfx::IntSize GetSize() const override;
 
-  Display* XDisplay() { return mDisplay; }
+  Display* XDisplay() { return *mDisplay; }
   ::Screen* XScreen();
   Drawable XDrawable() { return mDrawable; }
   XRenderPictFormat* XRenderFormat();
@@ -98,15 +106,15 @@
   bool IsPadSlow() {
     // The test here matches that for buggy_pad_reflect in
     // _cairo_xlib_device_create.
-    return VendorRelease(mDisplay) >= 60700000 ||
-           VendorRelease(mDisplay) < 10699000;
+    return VendorRelease(mDisplay->get()) >= 60700000 ||
+           VendorRelease(mDisplay->get()) < 10699000;
   }
 
  protected:
   // if TakePixmap() has been called on this
   bool mPixmapTaken;
 
-  Display* mDisplay;
+  std::shared_ptr<mozilla::gfx::XlibDisplay> mDisplay;
   Drawable mDrawable;
 
   const mozilla::gfx::IntSize DoSizeQuery();