# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/ipc/CrossProcessPaint.cpp
# Commit: e45261c616ac
# Full Hash: e45261c616ac0f96c0430a52c14399d3cd12b433
# Author: Hiroyuki Ikezoe <hikezoe.birchill@mozilla.com>
# Date: 2021-07-29 03:39:43
# Description:
#   Bug 1722673 - Add a null check for the current WindowGlobalParent in QueuePaint(). r=emilio
#   
#   This may be another source of failing OOP iframe document print. I will try to
#   see whether it can be reproducible locally later.
#   
# ==============================================================================

diff -r cf8a1175abd1 -r e45261c616ac gfx/ipc/CrossProcessPaint.cpp
--- a/gfx/ipc/CrossProcessPaint.cpp	Wed Jul 28 20:58:23 2021 +0000
+++ b/gfx/ipc/CrossProcessPaint.cpp	Wed Jul 28 21:00:32 2021 +0000
@@ -397,6 +397,11 @@
 
   if (!clonePromise) {
     RefPtr<dom::WindowGlobalParent> wgp = aBc->GetCurrentWindowGlobal();
+    if (!wgp) {
+      CPP_LOG("Skipping BrowsingContext(%p) with no current WGP.\n", aBc);
+      return;
+    }
+
     // TODO: Apply some sort of clipping to visible bounds here (Bug 1562720)
     QueuePaint(wgp, Nothing(), NS_RGBA(0, 0, 0, 0),
                CrossProcessPaintFlags::DrawView);
@@ -411,6 +416,11 @@
       GetMainThreadSerialEventTarget(), __func__,
       [self = RefPtr{this}, bc = RefPtr{aBc}]() {
         RefPtr<dom::WindowGlobalParent> wgp = bc->GetCurrentWindowGlobal();
+        if (!wgp) {
+          CPP_LOG("Skipping BrowsingContext(%p) with no current WGP.\n",
+                  bc.get());
+          return;
+        }
         MOZ_ASSERT(!self->mReceivedFragments.Contains(GetTabId(wgp)));
 
         // TODO: Apply some sort of clipping to visible bounds here (Bug
