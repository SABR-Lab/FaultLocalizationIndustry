# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: editor/spellchecker/TextServicesDocument.cpp
# Commit: da317e009565
# Full Hash: da317e0095654ccecf40fec345180dfd4aa4001c
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2021-07-13 21:42:32
# Regressor Bug: 1718924
# File Overlap Count: 2
# Description:
#   Bug 1718924 - part 16: Move `TextServicesDocument::RemoveInvalidOffsetEntries()` to `OffsetEntry` r=m_kato
#   
#   Depends on D119162
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D119163
# ==============================================================================

diff -r b771c6d7f21a -r da317e009565 editor/spellchecker/TextServicesDocument.cpp
--- a/editor/spellchecker/TextServicesDocument.cpp	Tue Jul 13 10:57:48 2021 +0000
+++ b/editor/spellchecker/TextServicesDocument.cpp	Tue Jul 13 11:03:56 2021 +0000
@@ -1058,7 +1058,8 @@
   }
 
   // Now remove any invalid entries from the offset table.
-  return RemoveInvalidOffsetEntries();
+  mOffsetTable.RemoveInvalidElements();
+  return NS_OK;
 }
 
 nsresult TextServicesDocument::InsertText(const nsAString& aText) {
@@ -2558,26 +2559,21 @@
   return IteratorStatus::eDone;
 }
 
-nsresult TextServicesDocument::RemoveInvalidOffsetEntries() {
-  for (size_t i = 0; i < mOffsetTable.Length();) {
-    if (!mOffsetTable[i]->mIsValid) {
-      mOffsetTable.RemoveElementAt(i);
-      if (mOffsetTable.mSelection.IsSet() &&
-          mOffsetTable.mSelection.StartIndex() >= i) {
+void TextServicesDocument::OffsetEntryArray::RemoveInvalidElements() {
+  for (size_t i = 0; i < Length();) {
+    if (!ElementAt(i)->mIsValid) {
+      RemoveElementAt(i);
+      if (mSelection.IsSet() && mSelection.StartIndex() >= i) {
         // We are deleting an entry that comes before
-        // mOffsetTable.mSelection.StartIndex(), decrement it so
+        // mSelection.StartIndex(), decrement it so
         // that it points to the correct entry!
-        NS_ASSERTION(i != mOffsetTable.mSelection.StartIndex(),
-                     "Invalid selection index.");
-        mOffsetTable.mSelection.Set(mOffsetTable.mSelection.StartIndex() - 1,
-                                    mOffsetTable.mSelection.EndIndex() - 1);
+        NS_ASSERTION(i != mSelection.StartIndex(), "Invalid selection index.");
+        mSelection.Set(mSelection.StartIndex() - 1, mSelection.EndIndex() - 1);
       }
     } else {
       i++;
     }
   }
-
-  return NS_OK;
 }
 
 nsresult TextServicesDocument::OffsetEntryArray::SplitElementAt(