# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/painting/nsDisplayList.cpp
# Commit: a70e9e75e47c
# Full Hash: a70e9e75e47cb7d6e9753b0d999649967442acac
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2021-08-25 21:49:19
# Description:
#   Bug 1725743 - Put the use of internal PDF destinations behind a pref, and disable by default due to possible cairo assertions. r=jrmuizel
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D123650
# ==============================================================================

diff -r 5e03ffaad62a -r a70e9e75e47c layout/painting/nsDisplayList.cpp
--- a/layout/painting/nsDisplayList.cpp	Wed Aug 25 16:11:02 2021 +0000
+++ b/layout/painting/nsDisplayList.cpp	Wed Aug 25 16:28:43 2021 +0000
@@ -34,6 +34,7 @@
 #include "mozilla/StaticPrefs_gfx.h"
 #include "mozilla/StaticPrefs_layers.h"
 #include "mozilla/StaticPrefs_layout.h"
+#include "mozilla/StaticPrefs_print.h"
 #include "mozilla/SVGIntegrationUtils.h"
 #include "mozilla/SVGUtils.h"
 #include "mozilla/ViewportUtils.h"
@@ -569,11 +570,14 @@
       }
     }
   };
-  if (elem->HasID()) {
-    maybeGenerateDest(nsGkAtoms::id);
-  }
-  if (elem->HasName()) {
-    maybeGenerateDest(nsGkAtoms::name);
+
+  if (StaticPrefs::print_save_as_pdf_internal_destinations_enabled()) {
+    if (elem->HasID()) {
+      maybeGenerateDest(nsGkAtoms::id);
+    }
+    if (elem->HasName()) {
+      maybeGenerateDest(nsGkAtoms::name);
+    }
   }
 
   // Links don't nest, so if the builder already has a destination, no need to
@@ -591,7 +595,8 @@
   // Is it a local (in-page) destination?
   bool hasRef, eqExRef;
   nsIURI* docURI;
-  if (NS_SUCCEEDED(uri->GetHasRef(&hasRef)) && hasRef &&
+  if (StaticPrefs::print_save_as_pdf_internal_destinations_enabled() &&
+      NS_SUCCEEDED(uri->GetHasRef(&hasRef)) && hasRef &&
       (docURI = aFrame->PresContext()->Document()->GetDocumentURI()) &&
       NS_SUCCEEDED(uri->EqualsExceptRef(docURI, &eqExRef)) && eqExRef) {
     if (NS_FAILED(uri->GetRef(aBuilder->mLinkSpec)) ||