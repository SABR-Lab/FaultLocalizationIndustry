# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/2d/DrawTargetCairo.cpp
# Commit: a79d9a152a6d
# Full Hash: a79d9a152a6d52a71210d4675d3c86b94615cd1b
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2021-08-04 21:45:54
# Regressor Bug: 1722300
# File Overlap Count: 1
# Description:
#   Bug 1722300 - patch 4 - Implement internal destinations when generating PDF output through cairo. r=mattwoodrow
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D120960
# ==============================================================================

diff -r b11f7f6bff04 -r a79d9a152a6d gfx/2d/DrawTargetCairo.cpp
--- a/gfx/2d/DrawTargetCairo.cpp	Wed Aug 04 12:52:37 2021 +0000
+++ b/gfx/2d/DrawTargetCairo.cpp	Wed Aug 04 12:52:38 2021 +0000
@@ -678,8 +678,13 @@
   cairo_user_to_device(mContext, &x, &y);
   cairo_user_to_device_distance(mContext, &w, &h);
 
-  nsPrintfCString attributes("rect=[%f %f %f %f] uri='%s'", x, y, w, h,
-                             dest.get());
+  nsPrintfCString attributes("rect=[%f %f %f %f] ", x, y, w, h);
+  if (dest[0] == '#') {
+    // The actual destination does not have a leading '#'.
+    attributes.AppendPrintf("dest='%s'", dest.get() + 1);
+  } else {
+    attributes.AppendPrintf("uri='%s'", dest.get());
+  }
 
   // We generate a begin/end pair with no content in between, because we are
   // using the rect attribute of the begin tag to specify the link region
@@ -688,6 +693,29 @@
   cairo_tag_end(mContext, CAIRO_TAG_LINK);
 }
 
+void DrawTargetCairo::Destination(const char* aDestination,
+                                  const Point& aPoint) {
+  if (!aDestination || !*aDestination) {
+    // No destination? Just bail out.
+    return;
+  }
+
+  nsAutoCString dest(aDestination);
+  for (size_t i = dest.Length(); i > 0;) {
+    --i;
+    if (dest[i] == '\'') {
+      dest.ReplaceLiteral(i, 1, "\\'");
+    }
+  }
+
+  double x = aPoint.x, y = aPoint.y;
+  cairo_user_to_device(mContext, &x, &y);
+
+  nsPrintfCString attributes("name='%s' x=%f y=%f internal", dest.get(), x, y);
+  cairo_tag_begin(mContext, CAIRO_TAG_DEST, attributes.get());
+  cairo_tag_end(mContext, CAIRO_TAG_DEST);
+}
+
 already_AddRefed<SourceSurface> DrawTargetCairo::Snapshot() {
   if (!IsValid()) {
     gfxCriticalNote << "DrawTargetCairo::Snapshot with bad surface "