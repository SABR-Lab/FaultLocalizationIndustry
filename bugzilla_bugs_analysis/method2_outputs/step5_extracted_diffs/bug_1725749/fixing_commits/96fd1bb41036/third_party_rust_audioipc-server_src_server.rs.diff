# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: third_party/rust/audioipc-server/src/server.rs
# Commit: 96fd1bb41036
# Full Hash: 96fd1bb41036f14d9b18f9d1e462f8382453c6f2
# Author: Matthew Gregan <kinetik@flim.org>
# Date: 2021-09-12 09:05:27
# Description:
#   Bug 1725749 - Update audioipc to fce878ff.  r=chunmin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D125165
# ==============================================================================

diff -r 64212702d9f0 -r 96fd1bb41036 third_party/rust/audioipc-server/src/server.rs
--- a/third_party/rust/audioipc-server/src/server.rs	Sat Sep 11 22:52:58 2021 +0300
+++ b/third_party/rust/audioipc-server/src/server.rs	Sat Sep 11 22:34:31 2021 +0000
@@ -759,7 +759,14 @@
         let user_ptr = server_stream.cbs.as_ref() as *const ServerStreamCallbacks as *mut c_void;
 
         // SharedMem setup message should've been processed by client by now.
-        server_stream.shm_setup.take().wait().unwrap();
+        if let Err(e) = server_stream.shm_setup.take().wait() {
+            // If the client errored before responding, log error and fail stream init.
+            debug!(
+                "Shmem setup for stream {:?} failed (error {:?})",
+                stm_tok, e
+            );
+            return Err(e.into());
+        }
 
         let stream = unsafe {
             let stream = context.stream_init(