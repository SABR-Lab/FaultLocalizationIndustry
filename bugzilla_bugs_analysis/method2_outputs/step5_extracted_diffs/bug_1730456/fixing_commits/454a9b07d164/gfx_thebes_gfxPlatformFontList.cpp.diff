# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxPlatformFontList.cpp
# Commit: 454a9b07d164
# Full Hash: 454a9b07d164c2824388c758ded0036a76c56287
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-09-23 21:45:25
# Description:
#   Bug 1730456 - InitPlatformFontList should reframe. r=jfkthame
#   
#   I don't know why it didn't broadcast the reflow request to child
#   processes... Perhaps it doesn't have to?
#   
# ==============================================================================

diff -r c6819fdea3a5 -r 454a9b07d164 gfx/thebes/gfxPlatformFontList.cpp
--- a/gfx/thebes/gfxPlatformFontList.cpp	Thu Sep 23 16:28:23 2021 +0000
+++ b/gfx/thebes/gfxPlatformFontList.cpp	Thu Sep 23 16:35:32 2021 +0000
@@ -471,22 +471,17 @@
 
     gfxPlatform::PurgeSkiaFontCache();
 
+    // There's no need to broadcast this reflow request to child processes, as
+    // ContentParent::NotifyUpdatedFonts deals with it by re-entering into this
+    // function on child processes.
     if (NS_IsMainThread()) {
-      nsCOMPtr<nsIObserverService> obs =
-          mozilla::services::GetObserverService();
-      if (obs) {
-        // Notify any current presContexts that fonts are being updated, so
-        // existing caches will no longer be valid.
-        obs->NotifyObservers(nullptr, "font-info-updated", nullptr);
-      }
+      gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::Yes,
+                                     gfxPlatform::BroadcastToChildren::No);
     } else {
       NS_DispatchToMainThread(
           NS_NewRunnableFunction("font-info-updated notification callback", [] {
-            nsCOMPtr<nsIObserverService> obs =
-                mozilla::services::GetObserverService();
-            if (obs) {
-              obs->NotifyObservers(nullptr, "font-info-updated", nullptr);
-            }
+            gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::Yes,
+                                           gfxPlatform::BroadcastToChildren::No);
           }));
     }
 
