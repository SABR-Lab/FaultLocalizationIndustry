# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxPlatform.cpp
# Commit: d400d0a16ce6
# Full Hash: d400d0a16ce6c20bfe5addb995f610f4881b31e6
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-08-27 09:43:40
# Regressor Bug: 1722487
# File Overlap Count: 3
# Description:
#   Bug 1722487 - Avoid some work for font list updates. r=jfkthame
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D123363
# ==============================================================================

diff -r ab80197101b9 -r d400d0a16ce6 gfx/thebes/gfxPlatform.cpp
--- a/gfx/thebes/gfxPlatform.cpp	Thu Aug 26 23:10:30 2021 +0000
+++ b/gfx/thebes/gfxPlatform.cpp	Thu Aug 26 23:17:54 2021 +0000
@@ -141,6 +141,7 @@
 #include "SoftwareVsyncSource.h"
 #include "nscore.h"  // for NS_FREE_PERMANENT_DATA
 #include "mozilla/dom/ContentChild.h"
+#include "mozilla/dom/ContentParent.h"
 #include "mozilla/dom/TouchEvent.h"
 #include "gfxVR.h"
 #include "VRManager.h"
@@ -2260,20 +2261,20 @@
 }
 
 /* static */
-void gfxPlatform::ForceGlobalReflow() {
+void gfxPlatform::ForceGlobalReflow(NeedsReframe aNeedsReframe) {
   MOZ_ASSERT(NS_IsMainThread());
+  const bool reframe = aNeedsReframe == NeedsReframe::Yes;
+  // Send a notification that will be observed by PresShells in this process
+  // only.
+  if (nsCOMPtr<nsIObserverService> obs = services::GetObserverService()) {
+    char16_t needsReframe[] = {char16_t(reframe), 0};
+    obs->NotifyObservers(nullptr, "font-info-updated", needsReframe);
+  }
   if (XRE_IsParentProcess()) {
-    // Modify a preference that will trigger reflow everywhere (in all
-    // content processes, as well as the parent).
-    static const char kPrefName[] = "font.internaluseonly.changed";
-    bool fontInternalChange = Preferences::GetBool(kPrefName, false);
-    Preferences::SetBool(kPrefName, !fontInternalChange);
-  } else {
-    // Send a notification that will be observed by PresShells in this
-    // process only.
-    nsCOMPtr<nsIObserverService> obs = services::GetObserverService();
-    if (obs) {
-      obs->NotifyObservers(nullptr, "font-info-updated", nullptr);
+    // Propagate the change to child processes.
+    for (auto* process :
+         dom::ContentParent::AllProcesses(dom::ContentParent::eLive)) {
+      Unused << process->SendForceGlobalReflow(reframe);
     }
   }
 }