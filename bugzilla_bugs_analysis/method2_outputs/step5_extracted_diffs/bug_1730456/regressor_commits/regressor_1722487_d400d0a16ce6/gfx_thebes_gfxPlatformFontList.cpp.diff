# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxPlatformFontList.cpp
# Commit: d400d0a16ce6
# Full Hash: d400d0a16ce6c20bfe5addb995f610f4881b31e6
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-08-27 09:43:40
# Regressor Bug: 1722487
# File Overlap Count: 3
# Description:
#   Bug 1722487 - Avoid some work for font list updates. r=jfkthame
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D123363
# ==============================================================================

diff -r ab80197101b9 -r d400d0a16ce6 gfx/thebes/gfxPlatformFontList.cpp
--- a/gfx/thebes/gfxPlatformFontList.cpp	Thu Aug 26 23:10:30 2021 +0000
+++ b/gfx/thebes/gfxPlatformFontList.cpp	Thu Aug 26 23:17:54 2021 +0000
@@ -170,7 +170,7 @@
                 !strcmp(aPref, "privacy.resistFingerprinting"))) {
     gfxPlatformFontList::PlatformFontList()->SetVisibilityLevel();
     if (XRE_IsParentProcess()) {
-      gfxPlatform::ForceGlobalReflow();
+      gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::No);
     }
   }
 }
@@ -188,7 +188,7 @@
   FontListPrefChanged(nullptr);
 
   if (XRE_IsParentProcess()) {
-    gfxPlatform::ForceGlobalReflow();
+    gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::No);
   }
   return NS_OK;
 }
@@ -336,9 +336,6 @@
   dom::ContentParent::NotifyUpdatedFonts(true);
 }
 
-// number of CSS generic font families
-const uint32_t kNumGenerics = 5;
-
 void gfxPlatformFontList::ApplyWhitelist() {
   uint32_t numFonts = mEnabledFontsList.Length();
   mFontFamilyWhitelistActive = (numFonts > 0);
@@ -637,7 +634,7 @@
     // safe to use: ensure they all get flushed.
     RebuildLocalFonts(/*aForgetLocalFaces*/ true);
   }
-  ForceGlobalReflow();
+  gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::Yes);
 }
 
 void gfxPlatformFontList::GenerateFontListKey(const nsACString& aKeyName,
@@ -857,7 +854,7 @@
     if (mStartedLoadingCmapsFrom != 0xffffffffu) {
       InitializeCodepointsWithNoFonts();
       mStartedLoadingCmapsFrom = 0xffffffffu;
-      gfxPlatform::ForceGlobalReflow();
+      gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::No);
     }
   }
 }
@@ -2491,7 +2488,7 @@
                     FindFamiliesFlags::eNoAddToNamesMissedWhenSearching));
         });
     if (forceReflow) {
-      ForceGlobalReflow();
+      gfxPlatform::ForceGlobalReflow(gfxPlatform::NeedsReframe::No);
     }
 
     mOtherNamesMissed = nullptr;
@@ -2523,10 +2520,6 @@
   }
 }
 
-void gfxPlatformFontList::ForceGlobalReflow() {
-  gfxPlatform::ForceGlobalReflow();
-}
-
 void gfxPlatformFontList::RebuildLocalFonts(bool aForgetLocalFaces) {
   for (auto* fontset : mUserFontSetList) {
     if (aForgetLocalFaces) {