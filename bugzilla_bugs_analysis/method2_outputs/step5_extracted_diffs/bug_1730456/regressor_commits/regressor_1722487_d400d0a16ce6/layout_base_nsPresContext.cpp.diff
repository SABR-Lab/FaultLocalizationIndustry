# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsPresContext.cpp
# Commit: d400d0a16ce6
# Full Hash: d400d0a16ce6c20bfe5addb995f610f4881b31e6
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2021-08-27 09:43:40
# Regressor Bug: 1722487
# File Overlap Count: 3
# Description:
#   Bug 1722487 - Avoid some work for font list updates. r=jfkthame
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D123363
# ==============================================================================

diff -r ab80197101b9 -r d400d0a16ce6 layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp	Thu Aug 26 23:10:30 2021 +0000
+++ b/layout/base/nsPresContext.cpp	Thu Aug 26 23:17:54 2021 +0000
@@ -138,11 +138,42 @@
   return false;
 }
 
-void nsPresContext::ForceReflowForFontInfoUpdate() {
-  // We can trigger reflow by pretending a font.* preference has changed;
-  // this is the same mechanism as gfxPlatform::ForceGlobalReflow() uses
-  // if new fonts are installed during the session, for example.
-  PreferenceChanged("font.internaluseonly.changed");
+void nsPresContext::ForceReflowForFontInfoUpdate(bool aNeedsReframe) {
+  // In the case of a static-clone document used for printing or print-preview,
+  // this is undesirable because the nsPrintJob is holding weak refs to frames
+  // that will get blown away unexpectedly by this reconstruction. So the
+  // prescontext for a print/preview doc ignores the font-list update.
+  //
+  // This means the print document may still be using cached fonts that are no
+  // longer present in the font list, but that should be safe given that all the
+  // required font instances have already been created, so it won't be depending
+  // on access to the font-list entries.
+  //
+  // XXX Actually, I think it's probably a bad idea to do *any* restyling of
+  // print documents in response to pref changes. We could be in the middle
+  // of printing the document, and reflowing all the frames might cause some
+  // kind of unwanted mid-document discontinuity.
+  if (IsPrintingOrPrintPreview()) {
+    return;
+  }
+
+  // If there's a user font set, discard any src:local() faces it may have
+  // loaded because their font entries may no longer be valid.
+  if (auto* fonts = Document()->GetFonts()) {
+    fonts->GetUserFontSet()->ForgetLocalFaces();
+  }
+
+  FlushFontCache();
+
+  nsChangeHint changeHint =
+      aNeedsReframe ? nsChangeHint_ReconstructFrame : NS_STYLE_HINT_REFLOW;
+
+  // We also need to trigger restyling for ex/ch units changes to take effect,
+  // if needed.
+  auto restyleHint =
+      UsesExChUnits() ? RestyleHint::RecascadeSubtree() : RestyleHint{0};
+
+  RebuildAllStyleData(changeHint, restyleHint);
 }
 
 static bool IsVisualCharset(NotNull<const Encoding*> aCharset) {
@@ -567,46 +598,16 @@
       mMissingFonts = nullptr;
     }
   }
-  if (prefName.EqualsLiteral("font.internaluseonly.changed") &&
-      !IsPrintingOrPrintPreview()) {
-    // If there's a user font set, discard any src:local() faces it may have
-    // loaded because their font entries may no longer be valid.
-    if (auto* fonts = Document()->GetFonts()) {
-      fonts->GetUserFontSet()->ForgetLocalFaces();
-    }
-
-    // If there's a change to the font list, we generally need to reconstruct
-    // frames, as the existing frames may be referring to fonts that are no
-    // longer available. But in the case of a static-clone document used for
-    // printing or print-preview, this is undesirable because the nsPrintJob
-    // is holding weak refs to frames that will get blown away unexpectedly by
-    // this reconstruction. So the prescontext for a print/preview doc ignores
-    // the font-list update.
-    //
-    // This means the print document may still be using cached fonts that are
-    // no longer present in the font list, but that should be safe given that
-    // all the required font instances have already been created, so it won't
-    // be depending on access to the font-list entries.
-    //
-    // XXX Actually, I think it's probably a bad idea to do *any* restyling of
-    // print documents in response to pref changes. We could be in the middle
-    // of printing the document, and reflowing all the frames might cause some
-    // kind of unwanted mid-document discontinuity.
-    changeHint |= nsChangeHint_ReconstructFrame;
-    // We also need to trigger restyling for ex/ch units changes to take effect,
-    // if needed.
-    if (UsesExChUnits()) {
-      restyleHint |= RestyleHint::RecascadeSubtree();
-    }
-  } else if (StringBeginsWith(prefName, "font."_ns) ||
-             // Changes to font family preferences don't change anything in the
-             // computed style data, so the style system won't generate a reflow
-             // hint for us.  We need to do that manually.
-             prefName.EqualsLiteral("intl.accept_languages") ||
-             // Changes to bidi prefs need to trigger a reflow (see bug 443629)
-             StringBeginsWith(prefName, "bidi."_ns) ||
-             // Changes to font_rendering prefs need to trigger a reflow
-             StringBeginsWith(prefName, "gfx.font_rendering."_ns)) {
+
+  if (StringBeginsWith(prefName, "font."_ns) ||
+      // Changes to font family preferences don't change anything in the
+      // computed style data, so the style system won't generate a reflow hint
+      // for us.  We need to do that manually.
+      prefName.EqualsLiteral("intl.accept_languages") ||
+      // Changes to bidi prefs need to trigger a reflow (see bug 443629)
+      StringBeginsWith(prefName, "bidi."_ns) ||
+      // Changes to font_rendering prefs need to trigger a reflow
+      StringBeginsWith(prefName, "gfx.font_rendering."_ns)) {
     changeHint |= NS_STYLE_HINT_REFLOW;
     if (UsesExChUnits()) {
       restyleHint |= RestyleHint::RecascadeSubtree();