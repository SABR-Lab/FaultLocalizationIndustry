# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxGDIFontList.cpp
# Commit: a8b9260fbdef
# Full Hash: a8b9260fbdef0f3600dc0b8e2e245cb0f82c3470
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2021-09-08 21:39:05
# Regressor Bug: 1715501
# File Overlap Count: 1
# Description:
#   Bug 1715501 - patch 2 - Pass the presContext to platform font lookup methods so they can query it for font visibility. r=emilio
#   
#   This does not in itself change user-visible behavior, but is a foundation for bug
#   1715507 where we will make the behavior per-context instead of global. This is basically
#   just plumbing, passing a pointer to the presContext that's asking for fonts to be
# ==============================================================================

diff -r bed82cc6a625 -r a8b9260fbdef gfx/thebes/gfxGDIFontList.cpp
--- a/gfx/thebes/gfxGDIFontList.cpp	Wed Sep 08 12:18:17 2021 +0000
+++ b/gfx/thebes/gfxGDIFontList.cpp	Wed Sep 08 12:18:17 2021 +0000
@@ -23,6 +23,7 @@
 #include "nsDirectoryServiceUtils.h"
 #include "nsDirectoryServiceDefs.h"
 #include "nsAppDirectoryServiceDefs.h"
+#include "nsPresContext.h"
 #include "gfxFontConstants.h"
 
 #include "mozilla/MemoryReporting.h"
@@ -665,7 +666,8 @@
   return 1;
 }
 
-gfxFontEntry* gfxGDIFontList::LookupLocalFont(const nsACString& aFontName,
+gfxFontEntry* gfxGDIFontList::LookupLocalFont(nsPresContext* aPresContext,
+                                              const nsACString& aFontName,
                                               WeightRange aWeightForEntry,
                                               StretchRange aStretchForEntry,
                                               SlantStyleRange aStyleForEntry) {
@@ -829,7 +831,8 @@
   return fe;
 }
 
-bool gfxGDIFontList::FindAndAddFamilies(StyleGenericFontFamily aGeneric,
+bool gfxGDIFontList::FindAndAddFamilies(nsPresContext* aPresContext,
+                                        StyleGenericFontFamily aGeneric,
                                         const nsACString& aFamily,
                                         nsTArray<FamilyAndGeneric>* aOutput,
                                         FindFamiliesFlags aFlags,
@@ -840,7 +843,9 @@
   NS_ConvertUTF16toUTF8 keyName(key16);
 
   gfxFontFamily* ff = mFontSubstitutes.GetWeak(keyName);
-  if (ff) {
+  FontVisibility level =
+      aPresContext ? aPresContext->GetFontVisibility() : FontVisibility::User;
+  if (ff && IsVisibleToCSS(*ff, level)) {
     aOutput->AppendElement(FamilyAndGeneric(ff, aGeneric));
     return true;
   }
@@ -850,11 +855,13 @@
   }
 
   return gfxPlatformFontList::FindAndAddFamilies(
-      aGeneric, aFamily, aOutput, aFlags, aStyle, aLanguage, aDevToCssSize);
+      aPresContext, aGeneric, aFamily, aOutput, aFlags, aStyle, aLanguage,
+      aDevToCssSize);
 }
 
-FontFamily gfxGDIFontList::GetDefaultFontForPlatform(const gfxFontStyle* aStyle,
-                                                     nsAtom* aLanguage) {
+FontFamily gfxGDIFontList::GetDefaultFontForPlatform(
+    nsPresContext* aPresContext, const gfxFontStyle* aStyle,
+    nsAtom* aLanguage) {
   FontFamily ff;
 
   // this really shouldn't fail to find a font....
@@ -863,7 +870,8 @@
   BOOL status =
       ::SystemParametersInfoW(SPI_GETNONCLIENTMETRICS, sizeof(ncm), &ncm, 0);
   if (status) {
-    ff = FindFamily(NS_ConvertUTF16toUTF8(ncm.lfMessageFont.lfFaceName));
+    ff = FindFamily(aPresContext,
+                    NS_ConvertUTF16toUTF8(ncm.lfMessageFont.lfFaceName));
     if (!ff.IsNull()) {
       return ff;
     }
@@ -873,7 +881,7 @@
   HGDIOBJ hGDI = ::GetStockObject(DEFAULT_GUI_FONT);
   LOGFONTW logFont;
   if (hGDI && ::GetObjectW(hGDI, sizeof(logFont), &logFont)) {
-    ff = FindFamily(NS_ConvertUTF16toUTF8(logFont.lfFaceName));
+    ff = FindFamily(aPresContext, NS_ConvertUTF16toUTF8(logFont.lfFaceName));
   }
 
   return ff;