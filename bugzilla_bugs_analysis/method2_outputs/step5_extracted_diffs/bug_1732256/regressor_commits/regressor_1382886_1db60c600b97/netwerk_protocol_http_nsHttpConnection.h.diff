# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/nsHttpConnection.h
# Commit: 1db60c600b97
# Full Hash: 1db60c600b971912cfaa392d05535382b876be1c
# Author: Dragana Damjanovic <dd.mozilla@gmail.com>
# Date: 2021-09-17 21:50:08
# Regressor Bug: 1382886
# File Overlap Count: 1
# Description:
#   Bug 1382886 - Remove a busy-wait if the early-data is negotiated and http/1.1 is used but the transaction cannot send early-data. r=necko-reviewers,kershaw
#   
#   In this case necko should poll for read (not for write) and reset the poll flags when the handshake is done.
#   The other option is to inspect the resumption ticket before adding it to the nss socket and find out which alpn will be used and disable the early-data if the version is http/1.1 and the transaction cannot send early-data. This currently only works on Nightly. When we roll out the neckoâ€™s token cache we can consider making this change.
#   
# ==============================================================================

diff -r c922a30d444e -r 1db60c600b97 netwerk/protocol/http/nsHttpConnection.h
--- a/netwerk/protocol/http/nsHttpConnection.h	Fri Sep 17 13:19:01 2021 +0000
+++ b/netwerk/protocol/http/nsHttpConnection.h	Fri Sep 17 13:19:02 2021 +0000
@@ -352,11 +352,20 @@
   // Helper variable for 0RTT handshake;
   // Possible 0RTT has been checked.
   bool m0RTTChecked{false};
-  // We have are sending 0RTT data and we are waiting
-  // for the end of the handsake.
-  bool mWaitingFor0RTTResponse{false};
+  // 0RTT data state.
+  enum EarlyData {
+    NOT_AVAILABLE,
+    USED,
+    CANNOT_BE_USED,
+    DONE,
+  };
+  EarlyData mEarlyDataState{EarlyData::NOT_AVAILABLE};
+  bool EarlyDataAvailable() const {
+    return mEarlyDataState == EarlyData::USED ||
+           mEarlyDataState == EarlyData::CANNOT_BE_USED;
+  }
+  bool EarlyDataUsed() const { return mEarlyDataState == EarlyData::USED; }
   int64_t mContentBytesWritten0RTT{0};
-  bool mEarlyDataNegotiated{false};  // Only used for telemetry
   nsCString mEarlyNegotiatedALPN;
   bool mDid0RTTSpdy{false};
   bool mTlsHandshakeComplitionPending{false};