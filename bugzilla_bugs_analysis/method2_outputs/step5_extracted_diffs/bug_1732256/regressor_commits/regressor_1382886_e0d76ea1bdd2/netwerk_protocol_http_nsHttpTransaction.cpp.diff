# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/nsHttpTransaction.cpp
# Commit: e0d76ea1bdd2
# Full Hash: e0d76ea1bdd2595ccbaa1671848706a6d6980910
# Author: Dragana Damjanovic <dd.mozilla@gmail.com>
# Date: 2021-09-17 21:50:08
# Regressor Bug: 1382886
# File Overlap Count: 1
# Description:
#   Bug 1382886 - Fix fuzzing build, also we cannot set SecurityInfo during read r=necko-reviewers,kershaw
#   
#   Before this bug TLS handshake was only driven by forcing writes. SecurtyInfo was set during a write code path. That is not anymore true and the TLS handshake can be driven by reading from a socket. That causes an issue where the SecurtyInfo was not set in case a TLS handshake fails. This bug added the setting of the SecurtyInfo to the read code path, but that causes problems when the transaction is closed due to corrupted response.
#   This patch fixes this by moving the setting of SecurtyInfo to Close() function.
#   
# ==============================================================================

diff -r 1db60c600b97 -r e0d76ea1bdd2 netwerk/protocol/http/nsHttpTransaction.cpp
--- a/netwerk/protocol/http/nsHttpTransaction.cpp	Fri Sep 17 13:19:02 2021 +0000
+++ b/netwerk/protocol/http/nsHttpTransaction.cpp	Fri Sep 17 13:19:02 2021 +0000
@@ -899,14 +899,6 @@
 
   MOZ_ASSERT(OnSocketThread(), "not on socket thread");
 
-  if (!mConnected && !m0RTTInProgress) {
-    mConnected = true;
-    nsCOMPtr<nsISupports> info;
-    mConnection->GetSecurityInfo(getter_AddRefs(info));
-    MutexAutoLock lock(mLock);
-    mSecurityInfo = info;
-  }
-
   if (mTransactionDone) {
     return NS_SUCCEEDED(mStatus) ? NS_BASE_STREAM_CLOSED : mStatus;
   }
@@ -1397,6 +1389,13 @@
   if (mConnection) {
     connReused = mConnection->IsReused();
     isHttp2or3 = mConnection->Version() >= HttpVersion::v2_0;
+    if (!mConnected) {
+      // Try to get SecurityInfo for this transaction.
+      nsCOMPtr<nsISupports> info;
+      mConnection->GetSecurityInfo(getter_AddRefs(info));
+      MutexAutoLock lock(mLock);
+      mSecurityInfo = info;
+    }
   }
   mConnected = false;
   mTunnelProvider = nullptr;
