# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: docshell/base/BrowsingContext.cpp
# Commit: a166505a2a27
# Full Hash: a166505a2a27296eefc53e241b299b2332dd3ee4
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2021-09-04 09:40:24
# Regressor Bug: 1725572
# File Overlap Count: 1
# Description:
#   Bug 1725572 - Wait for parent ack when discarding BC from child, r=kmag
#   
#   I am not confident that this will fix the underlying issue causing this crash,
#   but given how small of a change it is, I figure it's worth trying to land
#   quickly to see if the crash rate drops with it.
# ==============================================================================

diff -r 5545eced4ad6 -r a166505a2a27 docshell/base/BrowsingContext.cpp
--- a/docshell/base/BrowsingContext.cpp	Fri Sep 03 21:59:00 2021 +0000
+++ b/docshell/base/BrowsingContext.cpp	Fri Sep 03 22:21:49 2021 +0000
@@ -859,7 +859,10 @@
       }
     });
   } else if (!aFromIPC) {
-    auto callback = [](auto) {};
+    // Hold a strong reference to ourself until the responses come back to
+    // ensure the BrowsingContext isn't cleaned up before the parent process
+    // acknowledges the discard request.
+    auto callback = [self = RefPtr{this}](auto) {};
     ContentChild::GetSingleton()->SendDiscardBrowsingContext(this, callback,
                                                              callback);
   }
