# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/moz.configure
# Commit: 63ce829d63b4
# Full Hash: 63ce829d63b4d3cb462c23011be830b966cfdf14
# Author: Lars T Hansen <lhansen@mozilla.com>
# Date: 2021-10-18 16:09:29
# Regressor Bug: 1727084
# File Overlap Count: 1
# Description:
#   Bug 1727084 - Memory64 - Preliminaries. r=yury
#   
#   Scaffolding: Add assertions everywhere execution currently depends on
#   a memory being a memory32.  These assertions will disappear by and by.
#   
# ==============================================================================

diff -r 5315e548b651 -r 63ce829d63b4 js/moz.configure
--- a/js/moz.configure	Mon Oct 18 07:31:53 2021 +0000
+++ b/js/moz.configure	Mon Oct 18 07:31:54 2021 +0000
@@ -898,17 +898,44 @@
 # Support for WebAssembly Memory64.
 # ===========================
 
+
+@depends(milestone.is_nightly, "--enable-cranelift", "--enable-simulator", target)
+def default_wasm_memory64(is_nightly, cranelift, simulator, target):
+    if cranelift:
+        return
+
+    if target.cpu == "mips32" or target.cpu == "mips64":
+        return
+
+    if simulator and (simulator[0] == "mips32" or simulator[0] == "mips64"):
+        return
+
+    if is_nightly:
+        return True
+
+
 option(
     "--enable-wasm-memory64",
-    default=False,
+    default=default_wasm_memory64,
     help="{Enable|Disable} WebAssembly Memory64",
 )
 
 
-@depends("--enable-wasm-memory64")
-def wasm_memory64(value):
-    if value:
-        return True
+@depends("--enable-wasm-memory64", "--enable-cranelift", "--enable-simulator", target)
+def wasm_memory64(value, cranelift, simulator, target):
+    if not value:
+        return
+
+    if cranelift:
+        die("Memory64 is incompatible with Cranelift")
+
+    if target.cpu == "mips32" or target.cpu == "mips64":
+        die("Memory64 is incompatible with MIPS target")
+
+    if simulator and (simulator[0] == "mips32" or simulator[0] == "mips64"):
+        die("Memory64 is incompatible with MIPS simulator")
+
+    return True
 
 
 set_config("ENABLE_WASM_MEMORY64", wasm_memory64)