# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/AudioConduit.cpp
# Commit: b99b71e755e4
# Full Hash: b99b71e755e470a5dd152a5d6313f3002b2b9ba9
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-12-18 09:43:08
# Description:
#   Bug 1744081 - Move VideoConduit::Shutdown asyncness ownership into VideoConduit. r=bryce,ng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D133933
# ==============================================================================

diff -r f69c775a1024 -r b99b71e755e4 dom/media/webrtc/libwebrtcglue/AudioConduit.cpp
--- a/dom/media/webrtc/libwebrtcglue/AudioConduit.cpp	Fri Dec 17 20:29:15 2021 +0000
+++ b/dom/media/webrtc/libwebrtcglue/AudioConduit.cpp	Fri Dec 17 20:34:18 2021 +0000
@@ -74,25 +74,34 @@
       INIT_MIRROR(mRecvCodecs, std::vector<AudioCodecConfig>()) {}
 #undef INIT_MIRROR
 
-void WebrtcAudioConduit::Shutdown() {
-  MOZ_ASSERT(mCallThread->IsOnCurrentThread());
-  mControl.mReceiving.DisconnectIfConnected();
-  mControl.mTransmitting.DisconnectIfConnected();
-  mControl.mLocalSsrcs.DisconnectIfConnected();
-  mControl.mLocalCname.DisconnectIfConnected();
-  mControl.mLocalMid.DisconnectIfConnected();
-  mControl.mRemoteSsrc.DisconnectIfConnected();
-  mControl.mSyncGroup.DisconnectIfConnected();
-  mControl.mLocalRecvRtpExtensions.DisconnectIfConnected();
-  mControl.mLocalSendRtpExtensions.DisconnectIfConnected();
-  mControl.mSendCodec.DisconnectIfConnected();
-  mControl.mRecvCodecs.DisconnectIfConnected();
-  mControl.mOnDtmfEventListener.DisconnectIfExists();
-  mWatchManager.Shutdown();
+RefPtr<GenericPromise> WebrtcAudioConduit::Shutdown() {
+  MOZ_ASSERT(NS_IsMainThread());
 
-  AutoWriteLock lock(mLock);
-  DeleteSendStream();
-  DeleteRecvStream();
+  return InvokeAsync(mCallThread, "WebrtcAudioConduit::Shutdown (main thread)",
+                     [this, self = RefPtr<WebrtcAudioConduit>(this)] {
+                       mControl.mReceiving.DisconnectIfConnected();
+                       mControl.mTransmitting.DisconnectIfConnected();
+                       mControl.mLocalSsrcs.DisconnectIfConnected();
+                       mControl.mLocalCname.DisconnectIfConnected();
+                       mControl.mLocalMid.DisconnectIfConnected();
+                       mControl.mRemoteSsrc.DisconnectIfConnected();
+                       mControl.mSyncGroup.DisconnectIfConnected();
+                       mControl.mLocalRecvRtpExtensions.DisconnectIfConnected();
+                       mControl.mLocalSendRtpExtensions.DisconnectIfConnected();
+                       mControl.mSendCodec.DisconnectIfConnected();
+                       mControl.mRecvCodecs.DisconnectIfConnected();
+                       mControl.mOnDtmfEventListener.DisconnectIfExists();
+                       mWatchManager.Shutdown();
+
+                       {
+                         AutoWriteLock lock(mLock);
+                         DeleteSendStream();
+                         DeleteRecvStream();
+                       }
+
+                       return GenericPromise::CreateAndResolve(
+                           true, "WebrtcAudioConduit::Shutdown (call thread)");
+                     });
 }
 
 WebrtcAudioConduit::WebrtcAudioConduit(