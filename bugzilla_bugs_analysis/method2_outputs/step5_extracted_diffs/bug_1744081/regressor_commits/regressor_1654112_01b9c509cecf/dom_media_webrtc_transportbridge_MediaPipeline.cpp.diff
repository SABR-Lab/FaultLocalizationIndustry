# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/transportbridge/MediaPipeline.cpp
# Commit: 01b9c509cecf
# Full Hash: 01b9c509cecf7b5c0435b5ca063c3b4b492480d7
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 3
# Description:
#   Bug 1654112 - Fix AudioConduit::SendAudioFrame to use the new AudioSendStream API. r=ng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D102280
# ==============================================================================

diff -r 93367fdd03ec -r 01b9c509cecf dom/media/webrtc/transportbridge/MediaPipeline.cpp
--- a/dom/media/webrtc/transportbridge/MediaPipeline.cpp	Fri Jan 29 15:38:10 2021 +0100
+++ b/dom/media/webrtc/transportbridge/MediaPipeline.cpp	Fri Jan 29 15:38:43 2021 +0100
@@ -201,8 +201,12 @@
 
     while (mPacketizer->PacketsAvailable()) {
       mPacketizer->Output(mPacket.get());
-      mConduit->SendAudioFrame(mPacket.get(), mPacketizer->mPacketSize, aRate,
-                               mPacketizer->mChannels, 0);
+      auto frame = std::make_unique<webrtc::AudioFrame>();
+      // UpdateFrame makes a copy of the audio data.
+      frame->UpdateFrame(frame->timestamp_, mPacket.get(),
+                         mPacketizer->mPacketSize, aRate, frame->speech_type_,
+                         frame->vad_activity_, mPacketizer->mChannels);
+      mConduit->SendAudioFrame(std::move(frame));
     }
   }
 
