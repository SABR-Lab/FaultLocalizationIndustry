# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/jsapi/RTCRtpReceiver.cpp
# Commit: 0552c0b4a079
# Full Hash: 0552c0b4a079a695edfca100df68c4ad82481e58
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 5
# Description:
#   Bug 1654112 - Refactor away RtcpEventObserver in favor of MediaEvents. r=bwc
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D123223
# ==============================================================================

diff -r 877a0fcc6da9 -r 0552c0b4a079 dom/media/webrtc/jsapi/RTCRtpReceiver.cpp
--- a/dom/media/webrtc/jsapi/RTCRtpReceiver.cpp	Mon Aug 16 15:57:10 2021 +0200
+++ b/dom/media/webrtc/jsapi/RTCRtpReceiver.cpp	Thu Aug 19 11:49:29 2021 +0200
@@ -114,7 +114,10 @@
   // so we'll disable muting on RTCP BYE and timeout for now.
   if (Preferences::GetBool("media.peerconnection.mute_on_bye_or_timeout",
                            false)) {
-    aConduit->SetRtcpEventObserver(this);
+    mRtcpByeListener = aConduit->RtcpByeEvent().Connect(
+        mMainThread, this, &RTCRtpReceiver::OnRtcpBye);
+    mRtcpTimeoutListener = aConduit->RtcpTimeoutEvent().Connect(
+        mMainThread, this, &RTCRtpReceiver::OnRtcpTimeout);
   }
   if (aConduit->type() == MediaSessionConduit::AUDIO) {
     mPipeline = new MediaPipelineReceiveAudio(
@@ -519,11 +522,12 @@
   ASSERT_ON_THREAD(mMainThread);
   if (mPipeline) {
     mPipeline->Shutdown();
-    mPipeline->mConduit->SetRtcpEventObserver(nullptr);
     mPipeline = nullptr;
   }
   mTransceiverImpl = nullptr;
   mCallThread = nullptr;
+  mRtcpByeListener.DisconnectIfExists();
+  mRtcpTimeoutListener.DisconnectIfExists();
 }
 
 void RTCRtpReceiver::UpdateTransport() {