# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/jsapi/TransceiverImpl.cpp
# Commit: 09db50c8f370
# Full Hash: 09db50c8f370b69f186f3e6b7ce6154a984b40b4
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 9
# Description:
#   Bug 1654112 - Pass codec configs by value/reference instead of pointers. r=ng
#   
#   This patch mainly sets the stage for using codec configs with StateMirroring.
#   It also makes the code a bit simpler, and removes the need to handle the nullptr
#   case.
# ==============================================================================

diff -r d1552c620c11 -r 09db50c8f370 dom/media/webrtc/jsapi/TransceiverImpl.cpp
--- a/dom/media/webrtc/jsapi/TransceiverImpl.cpp	Wed Aug 11 11:33:21 2021 +0200
+++ b/dom/media/webrtc/jsapi/TransceiverImpl.cpp	Wed Apr 14 17:36:40 2021 +0200
@@ -619,7 +619,7 @@
 }
 
 static nsresult JsepCodecDescToAudioCodecConfig(
-    const JsepCodecDescription& aCodec, UniquePtr<AudioCodecConfig>* aConfig) {
+    const JsepCodecDescription& aCodec, Maybe<AudioCodecConfig>* aConfig) {
   MOZ_ASSERT(aCodec.mType == SdpMediaSection::kAudio);
   if (aCodec.mType != SdpMediaSection::kAudio) return NS_ERROR_INVALID_ARG;
 
@@ -633,9 +633,9 @@
     return NS_ERROR_INVALID_ARG;
   }
 
-  aConfig->reset(new AudioCodecConfig(pt, desc.mName, desc.mClock,
-                                      desc.mForceMono ? 1 : desc.mChannels,
-                                      desc.mFECEnabled));
+  *aConfig = Some(AudioCodecConfig(pt, desc.mName, desc.mClock,
+                                   desc.mForceMono ? 1 : desc.mChannels,
+                                   desc.mFECEnabled));
   (*aConfig)->mMaxPlaybackRate = desc.mMaxPlaybackRate;
   (*aConfig)->mDtmfEnabled = desc.mDtmfEnabled;
   (*aConfig)->mDTXEnabled = desc.mDTXEnabled;
@@ -652,19 +652,19 @@
 /*static*/
 nsresult TransceiverImpl::NegotiatedDetailsToAudioCodecConfigs(
     const JsepTrackNegotiatedDetails& aDetails,
-    std::vector<UniquePtr<AudioCodecConfig>>* aConfigs) {
-  UniquePtr<AudioCodecConfig> telephoneEvent;
+    std::vector<AudioCodecConfig>* aConfigs) {
+  Maybe<AudioCodecConfig> telephoneEvent;
 
   if (aDetails.GetEncodingCount()) {
     for (const auto& codec : aDetails.GetEncoding(0).GetCodecs()) {
-      UniquePtr<AudioCodecConfig> config;
+      Maybe<AudioCodecConfig> config;
       if (NS_FAILED(JsepCodecDescToAudioCodecConfig(*codec, &config))) {
         return NS_ERROR_INVALID_ARG;
       }
       if (config->mName == "telephone-event") {
         telephoneEvent = std::move(config);
       } else {
-        aConfigs->push_back(std::move(config));
+        aConfigs->push_back(std::move(*config));
       }
     }
   }
@@ -672,7 +672,7 @@
   // Put telephone event at the back, because webrtc.org crashes if we don't
   // If we need to do even more sorting, we should use std::sort.
   if (telephoneEvent) {
-    aConfigs->push_back(std::move(telephoneEvent));
+    aConfigs->push_back(std::move(*telephoneEvent));
   }
 
   if (aConfigs->empty()) {
@@ -692,7 +692,7 @@
   if (mJsepTransceiver->mSendTrack.GetNegotiatedDetails() &&
       mJsepTransceiver->mSendTrack.GetActive()) {
     const auto& details(*mJsepTransceiver->mSendTrack.GetNegotiatedDetails());
-    std::vector<UniquePtr<AudioCodecConfig>> configs;
+    std::vector<AudioCodecConfig> configs;
     nsresult rv = TransceiverImpl::NegotiatedDetailsToAudioCodecConfigs(
         details, &configs);
 
@@ -705,15 +705,15 @@
     }
 
     for (const auto& value : configs) {
-      if (value->mName == "telephone-event") {
+      if (value.mName == "telephone-event") {
         // we have a telephone event codec, so we need to make sure
         // the dynamic pt is set properly
-        conduit->SetDtmfPayloadType(value->mType, value->mFreq);
+        conduit->SetDtmfPayloadType(value.mType, value.mFreq);
         break;
       }
     }
 
-    auto error = conduit->ConfigureSendMediaCodec(configs[0].get());
+    auto error = conduit->ConfigureSendMediaCodec(configs[0]);
     if (error) {
       MOZ_MTLOG(ML_ERROR, mPCHandle
                               << "[" << mMid << "]: " << __FUNCTION__
@@ -727,7 +727,7 @@
 }
 
 static nsresult JsepCodecDescToVideoCodecConfig(
-    const JsepCodecDescription& aCodec, UniquePtr<VideoCodecConfig>* aConfig) {
+    const JsepCodecDescription& aCodec, Maybe<VideoCodecConfig>* aConfig) {
   MOZ_ASSERT(aCodec.mType == SdpMediaSection::kVideo);
   if (aCodec.mType != SdpMediaSection::kVideo) {
     MOZ_ASSERT(false, "JsepCodecDescription has wrong type");
@@ -757,8 +757,8 @@
     h264Config->tias_bw = 0;  // TODO(bug 1403206)
   }
 
-  aConfig->reset(new VideoCodecConfig(pt, desc.mName, desc.mConstraints,
-                                      h264Config.get()));
+  *aConfig = Some(
+      VideoCodecConfig(pt, desc.mName, desc.mConstraints, h264Config.get()));
 
   (*aConfig)->mAckFbTypes = desc.mAckFbTypes;
   (*aConfig)->mNackFbTypes = desc.mNackFbTypes;
@@ -789,10 +789,10 @@
 /*static*/
 nsresult TransceiverImpl::NegotiatedDetailsToVideoCodecConfigs(
     const JsepTrackNegotiatedDetails& aDetails,
-    std::vector<UniquePtr<VideoCodecConfig>>* aConfigs) {
+    std::vector<VideoCodecConfig>* aConfigs) {
   if (aDetails.GetEncodingCount()) {
     for (const auto& codec : aDetails.GetEncoding(0).GetCodecs()) {
-      UniquePtr<VideoCodecConfig> config;
+      Maybe<VideoCodecConfig> config;
       if (NS_FAILED(JsepCodecDescToVideoCodecConfig(*codec, &config))) {
         return NS_ERROR_INVALID_ARG;
       }
@@ -809,7 +809,7 @@
         }
       }
 
-      aConfigs->push_back(std::move(config));
+      aConfigs->push_back(std::move(*config));
     }
   }
 
@@ -836,7 +836,7 @@
       return rv;
     }
 
-    std::vector<UniquePtr<VideoCodecConfig>> configs;
+    std::vector<VideoCodecConfig> configs;
     rv = TransceiverImpl::NegotiatedDetailsToVideoCodecConfigs(details,
                                                                &configs);
     if (NS_FAILED(rv)) {
@@ -853,7 +853,7 @@
       return NS_OK;
     }
 
-    auto error = conduit->ConfigureSendMediaCodec(configs[0].get(),
+    auto error = conduit->ConfigureSendMediaCodec(configs[0],
                                                   details.GetRtpRtcpConfig());
     if (error) {
       MOZ_MTLOG(ML_ERROR, mPCHandle