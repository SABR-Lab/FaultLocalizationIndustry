# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/VideoConduit.cpp
# Commit: 2f1e8f5b2fc2
# Full Hash: 2f1e8f5b2fc2f5a28fd2f25019108e56de0fbb44
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 5
# Description:
#   Bug 1654112 - Rework GMP PluginID plumbing in VideoCondit. r=bwc
#   
#   This prepares VideoConduit for the decoder/encoder factory and its handling of
#   PluginID.
#   
# ==============================================================================

diff -r 777632b3319a -r 2f1e8f5b2fc2 dom/media/webrtc/libwebrtcglue/VideoConduit.cpp
--- a/dom/media/webrtc/libwebrtcglue/VideoConduit.cpp	Fri Feb 05 10:51:01 2021 +0100
+++ b/dom/media/webrtc/libwebrtcglue/VideoConduit.cpp	Mon Feb 08 17:23:44 2021 +0100
@@ -1212,7 +1212,7 @@
   MOZ_ASSERT(NS_IsMainThread());
 
   std::unique_ptr<webrtc::VideoDecoder> decoder = nullptr;
-  mRecvCodecPluginID = 0;
+  mRecvCodecPluginIDs.Clear();
 
 #ifdef MOZ_WEBRTC_MEDIACODEC
   bool enabled = false;
@@ -1229,8 +1229,8 @@
       // get an external decoder
       decoder.reset(GmpVideoCodec::CreateDecoder());
       if (decoder) {
-        mRecvCodecPluginID =
-            static_cast<WebrtcVideoDecoder*>(decoder.get())->PluginID();
+        mRecvCodecPluginIDs.AppendElement(
+            static_cast<WebrtcVideoDecoder*>(decoder.get())->PluginID());
       }
       break;
 
@@ -1281,7 +1281,7 @@
   MOZ_ASSERT(NS_IsMainThread());
 
   std::unique_ptr<webrtc::VideoEncoder> encoder = nullptr;
-  mSendCodecPluginID = 0;
+  mSendCodecPluginIDs.Clear();
 
 #ifdef MOZ_WEBRTC_MEDIACODEC
   bool enabled = false;
@@ -1299,8 +1299,8 @@
       // get an external encoder
       encoder.reset(GmpVideoCodec::CreateEncoder());
       if (encoder) {
-        mSendCodecPluginID =
-            static_cast<WebrtcVideoEncoder*>(encoder.get())->PluginID();
+        mSendCodecPluginIDs.AppendElement(
+            static_cast<WebrtcVideoEncoder*>(encoder.get())->PluginID());
       }
       break;
 
@@ -1969,17 +1969,11 @@
   }
 }
 
-uint64_t WebrtcVideoConduit::CodecPluginID() {
+bool WebrtcVideoConduit::HasCodecPluginID(uint64_t aPluginID) {
   MOZ_ASSERT(NS_IsMainThread());
 
-  if (mSendCodecPluginID) {
-    return mSendCodecPluginID;
-  }
-  if (mRecvCodecPluginID) {
-    return mRecvCodecPluginID;
-  }
-
-  return 0;
+  return mSendCodecPluginIDs.Contains(aPluginID) ||
+         mRecvCodecPluginIDs.Contains(aPluginID);
 }
 
 bool WebrtcVideoConduit::RequiresNewSendStream(