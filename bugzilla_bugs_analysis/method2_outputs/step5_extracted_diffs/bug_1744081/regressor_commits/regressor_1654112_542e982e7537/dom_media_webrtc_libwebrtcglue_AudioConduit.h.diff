# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/AudioConduit.h
# Commit: 542e982e7537
# Full Hash: 542e982e753711fa0ac5c55da967cb6cbd34e6d5
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 4
# Description:
#   Bug 1654112 - Avoid locking the conduit lock when starting/stopping/reconfiguring streams, and clean up. r=bwc
#   
#   A deadlock may happen when main thread calls into a conduit's
#   GetUpstreamRtpSources() as it grabs the conduit lock, while at the same time a
#   platform codec may be blocked on a sync runnable to main in a stream start()
# ==============================================================================

diff -r c01614dfe8f6 -r 542e982e7537 dom/media/webrtc/libwebrtcglue/AudioConduit.h
--- a/dom/media/webrtc/libwebrtcglue/AudioConduit.h	Wed Sep 01 12:03:36 2021 +0200
+++ b/dom/media/webrtc/libwebrtcglue/AudioConduit.h	Wed Sep 01 15:26:49 2021 +0200
@@ -86,10 +86,10 @@
   Maybe<DOMHighResTimeStamp> LastRtcpReceived() const override;
   DOMHighResTimeStamp GetNow() const override;
 
-  MediaConduitErrorCode StopTransmittingLocked();
-  MediaConduitErrorCode StartTransmittingLocked();
-  MediaConduitErrorCode StopReceivingLocked();
-  MediaConduitErrorCode StartReceivingLocked();
+  void StopTransmitting();
+  void StartTransmitting();
+  void StopReceiving();
+  void StartReceiving();
 
   /**
    * Function to deliver externally captured audio sample for encoding and
@@ -199,9 +199,9 @@
   static webrtc::SdpAudioFormat CodecConfigToLibwebrtcFormat(
       const AudioCodecConfig& aConfig);
 
-  MediaConduitErrorCode CreateSendStream();
+  void CreateSendStream();
   void DeleteSendStream();
-  MediaConduitErrorCode CreateRecvStream();
+  void CreateRecvStream();
   void DeleteRecvStream();
 
   // Const so can be accessed on any thread. Most methods are called on the Call
@@ -228,13 +228,11 @@
   webrtc::AudioSendStream* mSendStream;
 
   // If true => mSendStream started and not stopped
-  // Written only on the Call thread. Guarded by mLock, except for reads on the
-  // Call thread.
-  bool mSendStreamRunning;
+  // Written only on the Call thread.
+  Atomic<bool> mSendStreamRunning;
   // If true => mRecvStream started and not stopped
-  // Written only on the Call thread. Guarded by mLock, except for reads on the
-  // Call thread.
-  bool mRecvStreamRunning;
+  // Written only on the Call thread.
+  Atomic<bool> mRecvStreamRunning;
 
   // Accessed only on the Call thread.
   bool mDtmfEnabled;