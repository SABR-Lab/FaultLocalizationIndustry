# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/gtest/MockCall.h
# Commit: 786ea95e928b
# Full Hash: 786ea95e928b7bcec53a56b50f1d0ff136c76a62
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 1
# Description:
#   Bug 1654112 - Move NoTrialsConfig into SharedWebrtcState and make WebrtcCallWrapper keep a ref to it. r=ng
#   
#   SharedWebrtcState when managed by PeerConnectionCtx is destroyed on main thread.
#   With interactions with call instances being async, there is no guarantee that
#   the objects owned by SharedWebrtcState (and referenced through raw pointers by
# ==============================================================================

diff -r 2a373d864092 -r 786ea95e928b media/webrtc/signaling/gtest/MockCall.h
--- a/media/webrtc/signaling/gtest/MockCall.h	Wed Apr 14 17:40:24 2021 +0200
+++ b/media/webrtc/signaling/gtest/MockCall.h	Fri Apr 16 14:44:09 2021 +0200
@@ -8,6 +8,7 @@
 #include "gmock/gmock.h"
 #include "mozilla/Assertions.h"
 #include "WebrtcCallWrapper.h"
+#include "PeerConnectionCtx.h"
 
 // libwebrtc
 #include "api/call/audio_sink.h"
@@ -256,13 +257,27 @@
 
 class MockCallWrapper : public mozilla::WebrtcCallWrapper {
  public:
-  MockCallWrapper()
+  MockCallWrapper(
+      RefPtr<mozilla::SharedWebrtcState> aSharedState,
+      mozilla::UniquePtr<webrtc::VideoBitrateAllocatorFactory>
+          aVideoBitrateAllocatorFactory,
+      mozilla::UniquePtr<webrtc::RtcEventLog> aEventLog,
+      mozilla::UniquePtr<webrtc::TaskQueueFactory> aTaskQueueFactory,
+      const mozilla::dom::RTCStatsTimestampMaker& aTimestampMaker,
+      mozilla::UniquePtr<mozilla::media::ShutdownBlockingTicket>
+          aShutdownTicket)
       : mozilla::WebrtcCallWrapper(
-            mozilla::AbstractThread::MainThread(), nullptr, nullptr, nullptr,
-            nullptr, mozilla::dom::RTCStatsTimestampMaker(), nullptr) {}
+            std::move(aSharedState), std::move(aVideoBitrateAllocatorFactory),
+            std::move(aEventLog), std::move(aTaskQueueFactory), aTimestampMaker,
+            std::move(aShutdownTicket)) {}
 
-  static RefPtr<testing::NiceMock<MockCallWrapper>> Create() {
-    auto wrapper = mozilla::MakeRefPtr<testing::NiceMock<MockCallWrapper>>();
+  static RefPtr<MockCallWrapper> Create() {
+    auto state = mozilla::MakeRefPtr<mozilla::SharedWebrtcState>(
+        mozilla::AbstractThread::GetCurrent(), webrtc::AudioState::Config(),
+        nullptr, nullptr);
+    auto wrapper = mozilla::MakeRefPtr<MockCallWrapper>(
+        state, nullptr, nullptr, nullptr,
+        mozilla::dom::RTCStatsTimestampMaker(), nullptr);
     wrapper->SetCall(mozilla::WrapUnique(new MockCall));
     return wrapper;
   }