# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/VideoConduit.h
# Commit: 877a0fcc6da9
# Full Hash: 877a0fcc6da9fde4a783cfe30d0aa0b260427ac3
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 9
# Description:
#   Bug 1654112 - Merge conduit controllers into conduits, refactor away setters, and make unittests async. r=bwc,ng
#   
#   The main point of this patch is to harden how conduits handle configuration
#   changes. With conduit controller classes acting in a layer on top of conduits
#   (and their old sync style APIs), for instance
# ==============================================================================

diff -r 970ed33359b5 -r 877a0fcc6da9 dom/media/webrtc/libwebrtcglue/VideoConduit.h
--- a/dom/media/webrtc/libwebrtcglue/VideoConduit.h	Tue Aug 10 14:13:49 2021 +0200
+++ b/dom/media/webrtc/libwebrtcglue/VideoConduit.h	Mon Aug 16 15:57:10 2021 +0200
@@ -9,11 +9,13 @@
 #include "mozilla/Attributes.h"
 #include "mozilla/ReentrantMonitor.h"
 #include "mozilla/SharedThreadPool.h"
+#include "mozilla/StateMirroring.h"
 #include "mozilla/UniquePtr.h"
 #include "nsITimer.h"
 
 #include "MediaConduitInterface.h"
 #include "common/MediaEngineWrapper.h"
+#include "RtpRtcpConfig.h"
 #include "RunningStat.h"
 #include "RtpPacketQueue.h"
 #include "transport/runnable_utils.h"
@@ -71,10 +73,6 @@
   // Returns true when both encoder and decoder are HW accelerated.
   static bool HasH264Hardware();
 
-  MediaConduitErrorCode SetLocalRTPExtensions(
-      MediaSessionConduitLocalDirection aDirection,
-      const RtpExtList& aExtensions) override;
-
   /**
    * Function to attach Renderer end-point for the Media-Video conduit.
    * @param aRenderer : Reference to the concrete mozilla Video renderer
@@ -100,11 +98,6 @@
   Maybe<DOMHighResTimeStamp> LastRtcpReceived() const override;
   DOMHighResTimeStamp GetNow() const override;
 
-  MediaConduitErrorCode StopTransmitting() override;
-  MediaConduitErrorCode StartTransmitting() override;
-  MediaConduitErrorCode StopReceiving() override;
-  MediaConduitErrorCode StartReceiving() override;
-
   void OnFrameDelivered() override;
 
   MediaConduitErrorCode StopTransmittingLocked();
@@ -113,38 +106,6 @@
   MediaConduitErrorCode StartReceivingLocked();
 
   /**
-   * Function to configure sending codec mode for different content
-   */
-  MediaConduitErrorCode ConfigureCodecMode(webrtc::VideoCodecMode) override;
-
-  /**
-   * Function to configure send codec for the video session
-   * @param sendSessionConfig: CodecConfiguration
-   * @result: On Success, the video engine is configured with passed in codec
-   *          for send
-   *          On failure, video engine transmit functionality is disabled.
-   * NOTE: This API can be invoked multiple time. Invoking this API may involve
-   * restarting transmission sub-system on the engine.
-   */
-  MediaConduitErrorCode ConfigureSendMediaCodec(
-      const VideoCodecConfig& codecInfo,
-      const RtpRtcpConfig& aRtpRtcpConfig) override;
-
-  /**
-   * Function to configure list of receive codecs for the video session
-   * @param sendSessionConfig: CodecConfiguration
-   * @result: On Success, the video engine is configured with passed in codec
-   *          for send
-   *          Also the playout is enabled.
-   *          On failure, video engine transmit functionality is disabled.
-   * NOTE: This API can be invoked multiple time. Invoking this API may involve
-   * restarting transmission sub-system on the engine.
-   */
-  MediaConduitErrorCode ConfigureRecvMediaCodecs(
-      const std::vector<VideoCodecConfig>& codecConfigList,
-      const RtpRtcpConfig& aRtpRtcpConfig) override;
-
-  /**
    * Register Transport for this Conduit. RTP and RTCP frames from the
    * VideoEngine shall be passed to the registered transport for transporting
    * externally.
@@ -222,6 +183,12 @@
                      Options aOptions, std::string aPCHandle);
   virtual ~WebrtcVideoConduit();
 
+  // Call thread.
+  void InitControl(VideoConduitControlInterface* aControl) override;
+
+  // Called when a parameter in mControl has changed. Call thread.
+  void OnControlConfigChange();
+
   // Necessary Init steps on main thread.
   MediaConduitErrorCode Init();
   // Necessary Init steps on the Call thread.
@@ -232,16 +199,16 @@
   // Any thread.
   bool GetRemoteSSRC(uint32_t* ssrc) const override;
 
-  // Call thread only.
-  bool SetLocalSSRCs(const std::vector<uint32_t>& ssrcs,
-                     const std::vector<uint32_t>& rtxSsrcs) override;
-  bool SetRemoteSSRC(uint32_t ssrc, uint32_t rtxSsrc) override;
-  bool UnsetRemoteSSRC(uint32_t ssrc) override;
-  bool SetLocalCNAME(const char* cname) override;
-  bool SetLocalMID(const std::string& mid) override;
-  void SetSyncGroup(const std::string& group) override;
+  void UnsetRemoteSSRC(uint32_t ssrc) override;
   bool SetRemoteSSRCLocked(uint32_t ssrc, uint32_t rtxSsrc);
 
+  // Creating a recv stream or a send stream requires a local ssrc to be
+  // configured. This method will generate one if needed.
+  void EnsureLocalSSRC();
+  // Creating a recv stream requires a remote ssrc to be configured. This method
+  // will generate one if needed.
+  void EnsureRemoteSSRC();
+
   Maybe<webrtc::VideoReceiveStream::Stats> GetReceiverStats() const override;
   Maybe<webrtc::VideoSendStream::Stats> GetSenderStats() const override;
   webrtc::Call::Stats GetCallStats() const override;
@@ -308,6 +275,45 @@
   // thread.
   const nsCOMPtr<nsISerialEventTarget> mStsThread;
 
+  struct Control {
+    // Mirrors that map to VideoConduitControlInterface for control. Call thread
+    // only.
+    Mirror<bool> mReceiving;
+    Mirror<bool> mTransmitting;
+    Mirror<Ssrcs> mLocalSsrcs;
+    Mirror<Ssrcs> mLocalRtxSsrcs;
+    Mirror<std::string> mLocalCname;
+    Mirror<std::string> mLocalMid;
+    Mirror<Ssrc> mRemoteSsrc;
+    Mirror<Ssrc> mRemoteRtxSsrc;
+    Mirror<std::string> mSyncGroup;
+    Mirror<RtpExtList> mLocalRecvRtpExtensions;
+    Mirror<RtpExtList> mLocalSendRtpExtensions;
+    Mirror<Maybe<VideoCodecConfig>> mSendCodec;
+    Mirror<Maybe<RtpRtcpConfig>> mSendRtpRtcpConfig;
+    Mirror<std::vector<VideoCodecConfig>> mRecvCodecs;
+    Mirror<Maybe<RtpRtcpConfig>> mRecvRtpRtcpConfig;
+    Mirror<webrtc::VideoCodecMode> mCodecMode;
+
+    // For caching mRemoteSsrc and mRemoteRtxSsrc, since another caller may
+    // change the remote ssrc in the stream config directly.
+    Ssrc mConfiguredRemoteSsrc = 0;
+    Ssrc mConfiguredRemoteRtxSsrc = 0;
+    // For tracking changes to mSendCodec and mSendRtpRtcpConfig.
+    Maybe<VideoCodecConfig> mConfiguredSendCodec;
+    Maybe<RtpRtcpConfig> mConfiguredSendRtpRtcpConfig;
+    // For tracking changes to mRecvCodecs and mRecvRtpRtcpConfig.
+    std::vector<VideoCodecConfig> mConfiguredRecvCodecs;
+    Maybe<RtpRtcpConfig> mConfiguredRecvRtpRtcpConfig;
+
+    Control() = delete;
+    explicit Control(const RefPtr<AbstractThread>& aCallThread);
+  } mControl;
+
+  // WatchManager allowing Mirrors to trigger functions that will update the
+  // webrtc.org configuration.
+  WatchManager<WebrtcVideoConduit> mWatchManager;
+
   mutable Mutex mMutex;
 
   // Decoder factory used by mRecvStream when it needs new decoders. This is
@@ -348,9 +354,6 @@
   mozilla::Atomic<bool>
       mEngineReceiving;  // if true ==> Receive Subsystem up and running
 
-  // Local database of currently applied receive codecs. Call thread only.
-  std::vector<VideoCodecConfig> mRecvCodecList;
-
   // Written only on the Call thread. Guarded by mMutex, except for reads on the
   // Call thread.
   Maybe<VideoCodecConfig> mCurSendCodecConfig;
@@ -409,10 +412,6 @@
   static const unsigned int sAlphaDen = 8;
   static const unsigned int sRoundingPadding = 1024;
 
-  // Call thread only.
-  webrtc::VideoCodecMode mActiveCodecMode;
-  webrtc::VideoCodecMode mCodecMode;
-
   // WEBRTC.ORG Call API
   // Const so can be accessed on any thread. All methods are called on the Call
   // thread.
@@ -427,7 +426,7 @@
   webrtc::VideoEncoderConfig mEncoderConfig;
 
   // Written only on the Call thread. Guarded by mMutex, except for reads on the
-  // Call thread. Calls can happen on any thread.
+  // Call thread. Calls can happen under mMutex on any thread.
   RefPtr<rtc::RefCountedObject<VideoStreamFactory>> mVideoStreamFactory;
 
   // Call thread only.
@@ -438,7 +437,7 @@
   bool mAllowSsrcChange = true;
 
   // Accessed only on mStsThread.
-  bool mWaitingForInitialSsrc = true;
+  bool mWaitingForSignaledSsrc = true;
 
   // Accessed during configuration/signaling (call),
   // and when receiving packets (sts).