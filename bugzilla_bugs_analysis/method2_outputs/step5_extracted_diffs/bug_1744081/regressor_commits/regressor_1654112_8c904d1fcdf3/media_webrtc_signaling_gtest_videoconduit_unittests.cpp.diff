# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/gtest/videoconduit_unittests.cpp
# Commit: 8c904d1fcdf3
# Full Hash: 8c904d1fcdf3aa59578b7de3e843393715a67e50
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 2
# Description:
#   Bug 1654112 - Reinstate usage of mLockScaling in VideoConduit. r=ng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D112849
# ==============================================================================

diff -r 7057437ddf19 -r 8c904d1fcdf3 media/webrtc/signaling/gtest/videoconduit_unittests.cpp
--- a/media/webrtc/signaling/gtest/videoconduit_unittests.cpp	Wed Apr 07 09:44:33 2021 +0200
+++ b/media/webrtc/signaling/gtest/videoconduit_unittests.cpp	Wed Apr 07 09:45:07 2021 +0200
@@ -43,11 +43,12 @@
 
 class VideoConduitTest : public Test {
  public:
-  VideoConduitTest()
+  VideoConduitTest(
+      VideoSessionConduit::Options aOptions = VideoSessionConduit::Options())
       : mCallWrapper(MockCallWrapper::Create()),
         mVideoConduit(MakeRefPtr<WebrtcVideoConduit>(
-            mCallWrapper, GetCurrentSerialEventTarget(),
-            VideoSessionConduit::Options(), "")) {
+            mCallWrapper, GetCurrentSerialEventTarget(), std::move(aOptions),
+            "")) {
     NSS_NoDB_Init(nullptr);
 
     mVideoConduit->SetLocalSSRCs({42}, {43});
@@ -729,6 +730,57 @@
   mVideoConduit->StopTransmitting();
 }
 
+class VideoConduitTestScalingLocked : public VideoConduitTest {
+ public:
+  static VideoSessionConduit::Options CreateOptions() {
+    VideoSessionConduit::Options options;
+    options.mLockScaling = true;
+    return options;
+  }
+  VideoConduitTestScalingLocked() : VideoConduitTest(CreateOptions()) {}
+};
+
+TEST_F(VideoConduitTestScalingLocked, TestOnSinkWantsChanged) {
+  UniquePtr<MockVideoSink> sink(new MockVideoSink());
+  rtc::VideoSinkWants wants;
+  mVideoConduit->AddOrUpdateSink(sink.get(), wants);
+  RtpRtcpConfig rtpConf(webrtc::RtcpMode::kCompound);
+
+  wants.max_pixel_count = 256000;
+  EncodingConstraints constraints;
+  VideoCodecConfig::Encoding encoding;
+  VideoCodecConfig codecConfig(120, "VP8", constraints);
+  codecConfig.mEncodings.push_back(encoding);
+  std::vector<webrtc::VideoStream> videoStreams;
+
+  codecConfig.mEncodingConstraints.maxFs = 0;
+  mVideoConduit->ConfigureSendMediaCodec(&codecConfig, rtpConf);
+  mVideoConduit->StartTransmitting();
+  mVideoConduit->AddOrUpdateSink(sink.get(), wants);
+  SendVideoFrame(1920, 1080, 1);
+  EXPECT_EQ(sink->mVideoFrame.width(), 1920);
+  EXPECT_EQ(sink->mVideoFrame.height(), 1080);
+  videoStreams = Call()->CreateEncoderStreams(sink->mVideoFrame.width(),
+                                              sink->mVideoFrame.height());
+  ASSERT_EQ(videoStreams.size(), 1U);
+  EXPECT_EQ(videoStreams[0].width, 1920U);
+  EXPECT_EQ(videoStreams[0].height, 1080U);
+
+  codecConfig.mEncodingConstraints.maxFs = 500;
+  mVideoConduit->ConfigureSendMediaCodec(&codecConfig, rtpConf);
+  mVideoConduit->AddOrUpdateSink(sink.get(), wants);
+  SendVideoFrame(1920, 1080, 2);
+  EXPECT_LE(sink->mVideoFrame.width() * sink->mVideoFrame.height(),
+            500 * 16 * 16);
+  videoStreams = Call()->CreateEncoderStreams(sink->mVideoFrame.width(),
+                                              sink->mVideoFrame.height());
+  ASSERT_EQ(videoStreams.size(), 1U);
+  EXPECT_EQ(videoStreams[0].width, 360U);
+  EXPECT_EQ(videoStreams[0].height, 201U);
+
+  mVideoConduit->StopTransmitting();
+}
+
 TEST_F(VideoConduitTest, TestConfigureSendMediaCodecSimulcastOddScreen) {
   mVideoConduit->SetLocalSSRCs({42, 43, 44}, {45, 46, 47});
   RtpRtcpConfig rtpConf(webrtc::RtcpMode::kCompound);
