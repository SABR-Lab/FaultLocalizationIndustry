# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/jsapi/PeerConnectionCtx.h
# Commit: 8d80a4ba914c
# Full Hash: 8d80a4ba914c6f81430ba1c55471a8d2b3aac60e
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 2
# Description:
#   Bug 1654112 - Create CallWorkerThread which implements AbstractThread for a TaskQueueWrapper. r=ng
#   
#   Ideally TaskQueueWrapper would implement both webrtc::TaskQueueBase and
#   AbstractThread, but webrtc::TaskQueueBase is not refcounted so implementing both
#   in the same class is not possible.
# ==============================================================================

diff -r e0a2e54e4de8 -r 8d80a4ba914c dom/media/webrtc/jsapi/PeerConnectionCtx.h
--- a/dom/media/webrtc/jsapi/PeerConnectionCtx.h	Thu Apr 08 11:31:43 2021 +0200
+++ b/dom/media/webrtc/jsapi/PeerConnectionCtx.h	Mon Apr 12 14:49:20 2021 +0200
@@ -39,11 +39,18 @@
  public:
   NS_INLINE_DECL_THREADSAFE_REFCOUNTING(SharedWebrtcState)
 
-  SharedWebrtcState(webrtc::AudioState::Config&& aAudioStateConfig,
+  SharedWebrtcState(RefPtr<AbstractThread> aCallWorkerThread,
+                    webrtc::AudioState::Config&& aAudioStateConfig,
                     RefPtr<webrtc::AudioDecoderFactory> aAudioDecoderFactory);
 
   webrtc::SharedModuleThread* GetModuleThread();
 
+  // A global Call worker thread shared between all Call instances. Implements
+  // AbstractThread for running tasks that call into a Call instance through its
+  // webrtc::TaskQueue member, and for using AbstractThread-specific higher
+  // order constructs like StateMirroring.
+  const RefPtr<AbstractThread> mCallWorkerThread;
+
   // AudioState config containing dummy implementations of the audio stack,
   // since we use our own audio stack instead. Shared across all Call instances.
   const webrtc::AudioState::Config mAudioStateConfig;
@@ -53,7 +60,7 @@
   const RefPtr<webrtc::AudioDecoderFactory> mAudioDecoderFactory;
 
  private:
-  virtual ~SharedWebrtcState() = default;
+  virtual ~SharedWebrtcState();
 
   // SharedModuleThread used for processing in all Call instances.
   // Only accessed on the global Call worker task queue. Set on first