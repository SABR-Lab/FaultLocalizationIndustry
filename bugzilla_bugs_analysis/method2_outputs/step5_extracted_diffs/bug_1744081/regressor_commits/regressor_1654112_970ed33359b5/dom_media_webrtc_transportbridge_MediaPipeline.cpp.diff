# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/transportbridge/MediaPipeline.cpp
# Commit: 970ed33359b5
# Full Hash: 970ed33359b5223277984f77c521faaa0079aa88
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 2
# Description:
#   Bug 1654112 - Implement MediaConduitControl for controlling conduits async through state mirroring. r=ng,bwc
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D112868
# ==============================================================================

diff -r ed2e505b5873 -r 970ed33359b5 dom/media/webrtc/transportbridge/MediaPipeline.cpp
--- a/dom/media/webrtc/transportbridge/MediaPipeline.cpp	Wed Apr 21 01:13:43 2021 +0200
+++ b/dom/media/webrtc/transportbridge/MediaPipeline.cpp	Tue Aug 10 14:13:49 2021 +0200
@@ -240,11 +240,13 @@
                              RefPtr<MediaTransportHandler> aTransportHandler,
                              DirectionType aDirection,
                              RefPtr<nsISerialEventTarget> aMainThread,
+                             RefPtr<AbstractThread> aCallThread,
                              RefPtr<nsISerialEventTarget> aStsThread,
                              RefPtr<MediaSessionConduit> aConduit)
     : mConduit(std::move(aConduit)),
       mDirection(aDirection),
       mMainThread(std::move(aMainThread)),
+      mCallThread(std::move(aCallThread)),
       mStsThread(aStsThread),
       mActive(false, "MediaPipeline::mActive"),
       mLevel(0),
@@ -790,11 +792,11 @@
 MediaPipelineTransmit::MediaPipelineTransmit(
     const std::string& aPc, RefPtr<MediaTransportHandler> aTransportHandler,
     RefPtr<nsISerialEventTarget> aMainThread,
-    RefPtr<nsISerialEventTarget> aStsThread, bool aIsVideo,
-    RefPtr<MediaSessionConduit> aConduit)
+    RefPtr<AbstractThread> aCallThread, RefPtr<nsISerialEventTarget> aStsThread,
+    bool aIsVideo, RefPtr<MediaSessionConduit> aConduit)
     : MediaPipeline(aPc, std::move(aTransportHandler), DirectionType::TRANSMIT,
-                    std::move(aMainThread), std::move(aStsThread),
-                    std::move(aConduit)),
+                    std::move(aMainThread), std::move(aCallThread),
+                    std::move(aStsThread), std::move(aConduit)),
       mWatchManager(this, AbstractThread::MainThread()),
       mIsVideo(aIsVideo),
       mListener(new PipelineListener(mConduit)),
@@ -1322,11 +1324,11 @@
 MediaPipelineReceive::MediaPipelineReceive(
     const std::string& aPc, RefPtr<MediaTransportHandler> aTransportHandler,
     RefPtr<nsISerialEventTarget> aMainThread,
-    RefPtr<nsISerialEventTarget> aStsThread,
+    RefPtr<AbstractThread> aCallThread, RefPtr<nsISerialEventTarget> aStsThread,
     RefPtr<MediaSessionConduit> aConduit)
     : MediaPipeline(aPc, std::move(aTransportHandler), DirectionType::RECEIVE,
-                    std::move(aMainThread), std::move(aStsThread),
-                    std::move(aConduit)) {}
+                    std::move(aMainThread), std::move(aCallThread),
+                    std::move(aStsThread), std::move(aConduit)) {}
 
 MediaPipelineReceive::~MediaPipelineReceive() = default;
 
@@ -1509,12 +1511,13 @@
 MediaPipelineReceiveAudio::MediaPipelineReceiveAudio(
     const std::string& aPc, RefPtr<MediaTransportHandler> aTransportHandler,
     RefPtr<nsISerialEventTarget> aMainThread,
-    RefPtr<nsISerialEventTarget> aStsThread,
+    RefPtr<AbstractThread> aCallThread, RefPtr<nsISerialEventTarget> aStsThread,
     RefPtr<AudioSessionConduit> aConduit,
     const RefPtr<dom::MediaStreamTrack>& aTrack,
     const PrincipalHandle& aPrincipalHandle)
     : MediaPipelineReceive(aPc, std::move(aTransportHandler), aMainThread,
-                           std::move(aStsThread), std::move(aConduit)),
+                           std::move(aCallThread), std::move(aStsThread),
+                           std::move(aConduit)),
       mListener(aTrack ? new PipelineListener(std::move(aMainThread), aTrack,
                                               mConduit, aPrincipalHandle)
                        : nullptr),
@@ -1680,12 +1683,13 @@
 MediaPipelineReceiveVideo::MediaPipelineReceiveVideo(
     const std::string& aPc, RefPtr<MediaTransportHandler> aTransportHandler,
     RefPtr<nsISerialEventTarget> aMainThread,
-    RefPtr<nsISerialEventTarget> aStsThread,
+    RefPtr<AbstractThread> aCallThread, RefPtr<nsISerialEventTarget> aStsThread,
     RefPtr<VideoSessionConduit> aConduit,
     const RefPtr<dom::MediaStreamTrack>& aTrack,
     const PrincipalHandle& aPrincipalHandle)
     : MediaPipelineReceive(aPc, std::move(aTransportHandler), aMainThread,
-                           std::move(aStsThread), std::move(aConduit)),
+                           std::move(aCallThread), std::move(aStsThread),
+                           std::move(aConduit)),
       mRenderer(new PipelineRenderer(this)),
       mListener(aTrack ? new PipelineListener(std::move(aMainThread), aTrack,
                                               aPrincipalHandle)