# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/jsapi/RTCRtpReceiver.cpp
# Commit: a64e03b3e760
# Full Hash: a64e03b3e760528372218bc42f3c02f9447c5a38
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 5
# Description:
#   Bug 1654112 - Handle call shutdown in MediaSessionConduit::GetCallStats() and callers. r=ng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D124375
# ==============================================================================

diff -r cc2d56c5c678 -r a64e03b3e760 dom/media/webrtc/jsapi/RTCRtpReceiver.cpp
--- a/dom/media/webrtc/jsapi/RTCRtpReceiver.cpp	Thu Sep 02 12:19:23 2021 +0200
+++ b/dom/media/webrtc/jsapi/RTCRtpReceiver.cpp	Thu Sep 02 13:55:29 2021 +0200
@@ -200,22 +200,23 @@
     promises.AppendElement(InvokeAsync(
         mCallThread, __func__,
         [conduit = mPipeline->mConduit, recvTrackId]() mutable {
-          dom::RTCBandwidthEstimationInternal bw;
-          const auto& stats = conduit->GetCallStats();
-          bw.mTrackIdentifier = recvTrackId;
-          bw.mSendBandwidthBps.Construct(stats.send_bandwidth_bps / 8);
-          bw.mMaxPaddingBps.Construct(stats.max_padding_bitrate_bps / 8);
-          bw.mReceiveBandwidthBps.Construct(stats.recv_bandwidth_bps / 8);
-          bw.mPacerDelayMs.Construct(stats.pacer_delay_ms);
-          if (stats.rtt_ms >= 0) {
-            bw.mRttMs.Construct(stats.rtt_ms);
-          }
-
           auto report = MakeUnique<dom::RTCStatsCollection>();
-          if (!report->mBandwidthEstimations.AppendElement(std::move(bw),
-                                                           fallible)) {
-            mozalloc_handle_oom(0);
-          }
+          const Maybe<webrtc::Call::Stats> stats = conduit->GetCallStats();
+          stats.apply([&](const auto& aStats) {
+            dom::RTCBandwidthEstimationInternal bw;
+            bw.mTrackIdentifier = recvTrackId;
+            bw.mSendBandwidthBps.Construct(aStats.send_bandwidth_bps / 8);
+            bw.mMaxPaddingBps.Construct(aStats.max_padding_bitrate_bps / 8);
+            bw.mReceiveBandwidthBps.Construct(aStats.recv_bandwidth_bps / 8);
+            bw.mPacerDelayMs.Construct(aStats.pacer_delay_ms);
+            if (aStats.rtt_ms >= 0) {
+              bw.mRttMs.Construct(aStats.rtt_ms);
+            }
+            if (!report->mBandwidthEstimations.AppendElement(std::move(bw),
+                                                             fallible)) {
+              mozalloc_handle_oom(0);
+            }
+          });
           return RTCStatsPromise::CreateAndResolve(std::move(report), __func__);
         }));
   }