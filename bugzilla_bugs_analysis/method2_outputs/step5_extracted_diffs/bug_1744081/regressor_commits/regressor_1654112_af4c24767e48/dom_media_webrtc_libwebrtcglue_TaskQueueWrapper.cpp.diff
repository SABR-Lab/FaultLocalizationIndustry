# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/TaskQueueWrapper.cpp
# Commit: af4c24767e48
# Full Hash: af4c24767e48def595991abacc5719eb77e1b27f
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 1
# Description:
#   Bug 1654112 - Make mediapipeline_unittest pass and remove TaskQueueWrapper::MainAsCurrent. r=ng,bwc
#   
#   This patch makes mediapipeline_unittest pass an event target to the Call wrapper
#   but keeps using main thread for that event target, so that it can keep the test
#   cases simpler by allowing sybnc calls into the conduits.
# ==============================================================================

diff -r d621668762f4 -r af4c24767e48 dom/media/webrtc/libwebrtcglue/TaskQueueWrapper.cpp
--- a/dom/media/webrtc/libwebrtcglue/TaskQueueWrapper.cpp	Wed Apr 07 15:01:03 2021 +0200
+++ /dev/null	Thu Jan 01 00:00:00 1970 +0000
@@ -1,47 +0,0 @@
-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-*/
-/* This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this file,
- * You can obtain one at http://mozilla.org/MPL/2.0/. */
-
-#include "TaskQueueWrapper.h"
-
-#include "mozilla/media/MediaUtils.h"
-#include "MediaEventSource.h"
-
-namespace mozilla {
-namespace {
-class MainWorker {
- public:
-  const UniquePtr<TaskQueueWrapper> mTaskQueue;
-  MediaEventListener mShutdownListener;
-  const UniquePtr<media::ShutdownBlockingTicket> mTicket;
-  explicit MainWorker(UniquePtr<TaskQueueWrapper> aTaskQueue)
-      : mTaskQueue(std::move(aTaskQueue)),
-        mTicket(MakeUnique<media::ShutdownBlockingTicket>(
-            u"MainWorker::mTicket"_ns, NS_LITERAL_STRING_FROM_CSTRING(__FILE__),
-            __LINE__)) {}
-};
-
-UniquePtr<MainWorker> gMainWorker;
-}  // namespace
-
-TaskQueueWrapper* TaskQueueWrapper::GetMainWorker() {
-  MOZ_ASSERT(NS_IsMainThread());
-  if (!gMainWorker) {
-    gMainWorker = MakeUnique<MainWorker>(
-        MakeUnique<TaskQueueWrapper>(MakeRefPtr<TaskQueue>(
-            do_AddRef(GetMainThreadEventTarget()), "MainWorker")));
-    gMainWorker->mShutdownListener =
-        gMainWorker->mTicket->ShutdownEvent().Connect(
-            GetMainThreadEventTarget(), [] {
-              gMainWorker->mShutdownListener.Disconnect();
-              // Destroying the main thread worker on main thread will deadlock
-              // if there are pending tasks, since it's sync. Do it async.
-              gMainWorker->mTaskQueue->mTaskQueue->BeginShutdown()->Then(
-                  GetMainThreadSerialEventTarget(), __func__,
-                  [worker = std::move(gMainWorker)] { Unused << worker; });
-            });
-  }
-  return gMainWorker->mTaskQueue.get();
-}
-}  // namespace mozilla