# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/WebrtcCallWrapper.cpp
# Commit: af4c24767e48
# Full Hash: af4c24767e48def595991abacc5719eb77e1b27f
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 1
# Description:
#   Bug 1654112 - Make mediapipeline_unittest pass and remove TaskQueueWrapper::MainAsCurrent. r=ng,bwc
#   
#   This patch makes mediapipeline_unittest pass an event target to the Call wrapper
#   but keeps using main thread for that event target, so that it can keep the test
#   cases simpler by allowing sybnc calls into the conduits.
# ==============================================================================

diff -r d621668762f4 -r af4c24767e48 dom/media/webrtc/libwebrtcglue/WebrtcCallWrapper.cpp
--- a/dom/media/webrtc/libwebrtcglue/WebrtcCallWrapper.cpp	Wed Apr 07 15:01:03 2021 +0200
+++ b/dom/media/webrtc/libwebrtcglue/WebrtcCallWrapper.cpp	Fri Apr 09 10:26:12 2021 +0200
@@ -17,18 +17,19 @@
     UniquePtr<media::ShutdownBlockingTicket> aShutdownTicket,
     const RefPtr<SharedWebrtcState>& aSharedState,
     webrtc::WebRtcKeyValueConfig* aTrials) {
-  return Create(aTimestampMaker, std::move(aShutdownTicket),
-                aSharedState->mCallWorkerThread.get(),
-                aSharedState->GetModuleThread(),
-                aSharedState->mAudioStateConfig,
-                aSharedState->mAudioDecoderFactory, aTrials);
+  return Create(
+      aTimestampMaker, std::move(aShutdownTicket),
+      aSharedState->mCallWorkerThread.get(),
+      [aSharedState] { return aSharedState->GetModuleThread(); },
+      aSharedState->mAudioStateConfig, aSharedState->mAudioDecoderFactory,
+      aTrials);
 }
 
 /* static */ RefPtr<WebrtcCallWrapper> WebrtcCallWrapper::Create(
     const dom::RTCStatsTimestampMaker& aTimestampMaker,
     UniquePtr<media::ShutdownBlockingTicket> aShutdownTicket,
     RefPtr<AbstractThread> aCallThread,
-    rtc::scoped_refptr<webrtc::SharedModuleThread> aModuleThread,
+    std::function<webrtc::SharedModuleThread*()> aModuleThreadGetter,
     const webrtc::AudioState::Config& aAudioStateConfig,
     webrtc::AudioDecoderFactory* aAudioDecoderFactory,
     webrtc::WebRtcKeyValueConfig* aTrials) {
@@ -47,9 +48,9 @@
 
   wrapper->mCallThread->Dispatch(NS_NewRunnableFunction(
       __func__, [wrapper, config = std::move(config),
-                 moduleThread = std::move(aModuleThread)] {
+                 moduleThreadGetter = std::move(aModuleThreadGetter)] {
         wrapper->SetCall(
-            WrapUnique(webrtc::Call::Create(config, moduleThread)));
+            WrapUnique(webrtc::Call::Create(config, moduleThreadGetter())));
       }));
 
   return wrapper;