# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/jsapi/TransceiverImpl.cpp
# Commit: bd3db9010131
# Full Hash: bd3db9010131d8a01ac28b064a05b6661c863238
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 1
# Description:
#   Bug 1654112 - Deliberately choose DTMF codec. r=ng
#   
#   The logic used for choosing codec in this patch mimics the logic of Chromium.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D112858
# ==============================================================================

diff -r 786ea95e928b -r bd3db9010131 dom/media/webrtc/jsapi/TransceiverImpl.cpp
--- a/dom/media/webrtc/jsapi/TransceiverImpl.cpp	Fri Apr 16 14:44:09 2021 +0200
+++ b/dom/media/webrtc/jsapi/TransceiverImpl.cpp	Sun Apr 18 21:47:29 2021 +0200
@@ -4,6 +4,7 @@
 
 #include "jsapi/TransceiverImpl.h"
 #include "mozilla/UniquePtr.h"
+#include <algorithm>
 #include <string>
 #include <vector>
 #include "libwebrtcglue/AudioConduit.h"
@@ -704,13 +705,29 @@
       return rv;
     }
 
-    for (const auto& value : configs) {
-      if (value.mName == "telephone-event") {
-        // we have a telephone event codec, so we need to make sure
-        // the dynamic pt is set properly
-        conduit->SetDtmfPayloadType(value.mType, value.mFreq);
-        break;
+    std::vector<AudioCodecConfig> dtmfConfigs;
+    std::copy_if(
+        configs.begin(), configs.end(), std::back_inserter(dtmfConfigs),
+        [](const auto& value) { return value.mName == "telephone-event"; });
+
+    const AudioCodecConfig& sendCodec = configs[0];
+
+    if (!dtmfConfigs.empty()) {
+      // There is at least one telephone-event codec.
+      // We primarily choose the codec whose frequency matches the send codec.
+      // Secondarily we choose the one with the lowest frequency.
+      auto dtmfIterator =
+          std::find_if(dtmfConfigs.begin(), dtmfConfigs.end(),
+                       [&sendCodec](const auto& dtmfCodec) {
+                         return dtmfCodec.mFreq == sendCodec.mFreq;
+                       });
+      if (dtmfIterator == dtmfConfigs.end()) {
+        dtmfIterator = std::min_element(
+            dtmfConfigs.begin(), dtmfConfigs.end(),
+            [](const auto& a, const auto& b) { return a.mFreq < b.mFreq; });
       }
+      MOZ_ASSERT(dtmfIterator != dtmfConfigs.end());
+      conduit->SetDtmfPayloadType(dtmfIterator->mType, dtmfIterator->mFreq);
     }
 
     auto error = conduit->ConfigureSendMediaCodec(configs[0]);
