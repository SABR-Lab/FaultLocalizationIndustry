# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/VideoConduit.cpp
# Commit: ceed49af0fad
# Full Hash: ceed49af0fad6ee87f64a89adb84c791a74ced14
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 2
# Description:
#   Bug 1654112 - Don't register/unregister conduit with the call wrapper in ctor/dtor. r=ng,bwc
#   
#   Doing this outside of the dtor, especially, removes the requirement of the
#   conduit having to be destroyed on the worker thread (main).
#   
# ==============================================================================

diff -r a1c16b86d3a7 -r ceed49af0fad dom/media/webrtc/libwebrtcglue/VideoConduit.cpp
--- a/dom/media/webrtc/libwebrtcglue/VideoConduit.cpp	Mon Jan 18 16:41:26 2021 +0100
+++ b/dom/media/webrtc/libwebrtcglue/VideoConduit.cpp	Mon Jan 18 17:32:49 2021 +0100
@@ -224,18 +224,12 @@
       ,
       mRecvSSRC(0),
       mRemoteSSRC(0) {
-  mCall->RegisterConduit(this);
   mRecvStreamConfig.renderer = this;
 }
 
 WebrtcVideoConduit::~WebrtcVideoConduit() {
-  MOZ_ASSERT(NS_IsMainThread());
+  CSFLogDebug(LOGTAG, "%s ", __FUNCTION__);
 
-  CSFLogDebug(LOGTAG, "%s ", __FUNCTION__);
-  mCall->UnregisterConduit(this);
-
-  // Release AudioConduit first by dropping reference on MainThread, where it
-  // expects to be
   MOZ_ASSERT(!mSendStream && !mRecvStream,
              "Call DeleteStreams prior to ~WebrtcVideoConduit.");
 }
@@ -762,6 +756,9 @@
     }
   }
 
+  // Remote SSRC set -- listen for unsets from other conduits.
+  mCall->RegisterConduit(this);
+
   mRemoteSSRC = ssrc;
   mRecvStreamConfig.rtp.remote_ssrc = ssrc;
   mRecvStreamConfig.rtp.rtx_ssrc = rtxSsrc;
@@ -769,8 +766,6 @@
       "WebrtcVideoConduit::WaitingForInitialSsrcNoMore",
       [this, self = RefPtr<WebrtcVideoConduit>(this)]() mutable {
         mWaitingForInitialSsrc = false;
-        NS_ReleaseOnMainThread(
-            "WebrtcVideoConduit::WaitingForInitialSsrcNoMore", self.forget());
       }));
   // On the next StartReceiving() or ConfigureRecvMediaCodec, force
   // building a new RecvStream to switch SSRCs.
@@ -998,8 +993,7 @@
     mRecvFramerate.Clear();
   }
 
-  // We can't delete the VideoEngine until all these are released!
-  // And we can't use a Scoped ptr, since the order is arbitrary
+  mCall->UnregisterConduit(this);
   MutexAutoLock lock(mMutex);
   DeleteSendStream();
   DeleteRecvStream();
@@ -1187,7 +1181,8 @@
         // we signal an error.
         return kMediaConduitUnknownError;
       }
-
+      // Remote SSRC set -- listen for unsets from other conduits.
+      mCall->RegisterConduit(this);
       mRecvStreamConfig.rtp.remote_ssrc = ssrc;
       mRecvSSRC = ssrc;
     }
@@ -1656,9 +1651,6 @@
                     return;
                   }
                   mRtpPacketQueue.DequeueAll(this);
-                  NS_ReleaseOnMainThread(
-                      "WebrtcVideoConduit::QueuedPacketsHandler",
-                      self.forget());
                 }));
           }));
       return kMediaConduitNoError;