# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webrtc/libwebrtcglue/MediaConduitInterface.h
# Commit: f7083b863a49
# Full Hash: f7083b863a494947a62bea9504b960f374146d4a
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2021-11-01 18:17:33
# Regressor Bug: 1654112
# File Overlap Count: 1
# Description:
#   Bug 1654112 - Use regular threadsafe refcounting for WebRtcCallWrapper. r=bwc
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D105767
# ==============================================================================

diff -r 98e445343ef6 -r f7083b863a49 dom/media/webrtc/libwebrtcglue/MediaConduitInterface.h
--- a/dom/media/webrtc/libwebrtcglue/MediaConduitInterface.h	Mon Feb 15 14:44:29 2021 +0100
+++ b/dom/media/webrtc/libwebrtcglue/MediaConduitInterface.h	Mon Feb 15 15:10:50 2021 +0100
@@ -240,7 +240,7 @@
 };
 
 // Wrap the webrtc.org Call class adding mozilla add/ref support.
-class WebRtcCallWrapper : public RefCounted<WebRtcCallWrapper> {
+class WebRtcCallWrapper {
  public:
   typedef webrtc::Call::Config Config;
 
@@ -279,6 +279,8 @@
     return new WebRtcCallWrapper(std::move(aCall));
   }
 
+  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(WebRtcCallWrapper)
+
   // Don't allow copying/assigning.
   WebRtcCallWrapper(const WebRtcCallWrapper&) = delete;
   void operator=(const WebRtcCallWrapper&) = delete;
@@ -288,8 +290,6 @@
     return mCall.get();
   }
 
-  virtual ~WebRtcCallWrapper() = default;
-
   bool UnsetRemoteSSRC(uint32_t ssrc) {
     MOZ_ASSERT(TaskQueueWrapper::GetMainWorker()->IsCurrent());
     for (auto conduit : mConduits) {
@@ -340,7 +340,8 @@
     return mTimestampMaker;
   }
 
-  MOZ_DECLARE_REFCOUNTED_TYPENAME(WebRtcCallWrapper)
+ protected:
+  virtual ~WebRtcCallWrapper() { MOZ_ASSERT(!mCall); }
 
  private:
   WebRtcCallWrapper(RefPtr<webrtc::AudioDecoderFactory> aAudioDecoderFactory,
