# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit-test/tests/warp/scalar-replace-array-construct-array.js
# Commit: 2a27eb3a670a
# Full Hash: 2a27eb3a670a7778460c2acdf218c000d6a6f91a
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2021-11-10 09:24:53
# Regressor Bug: 1739650
# File Overlap Count: 1
# Description:
#   Bug 1739650 - Part 2: Support array scalar replacement for MConstructArray. r=iain
#   
#   And also support array scalar replacement for `MConstructArray`.
#   
#   Depends on D130480
# ==============================================================================

diff -r 5806df2b62db -r 2a27eb3a670a js/src/jit-test/tests/warp/scalar-replace-array-construct-array.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/jit-test/tests/warp/scalar-replace-array-construct-array.js	Tue Nov 09 16:30:03 2021 +0000
@@ -0,0 +1,48 @@
+// |jit-test| --fast-warmup; --no-threads
+
+setJitCompilerOption("baseline.warmup.trigger", 0);
+setJitCompilerOption("ion.warmup.trigger", 100);
+
+// Prevent GC from cancelling/discarding Ion compilations.
+gczeal(0);
+
+// Create a fresh set of functions for each argument count to avoid type pollution.
+function makeTest(count) {
+  var args = Array(count).fill(0).join(",");
+
+  return Function(`
+    class Base {
+      constructor() {
+        this.count = arguments.length;
+      }
+    }
+  
+    class C extends Base {
+      constructor(...args) {
+        // When |C| is inlined into its caller, the number of arguments is fixed and
+        // we can scalar replace the inlined rest array.
+        assertRecoveredOnBailout(args, true);
+        return super(...args);
+      }
+    }
+
+    // |C| must be small enough to be inlined into the test function.
+    assertEq(isSmallFunction(C), true);
+
+    function test() {
+      for (let i = 0; i < 1000; ++i) {
+        let obj = new C(${args});
+        assertEq(obj.count, ${count});
+      }
+    }
+
+    return test;
+  `)();
+}
+
+// Limited by gc::CanUseFixedElementsForArray(), see also WarpBuilder::build_Rest().
+const maxRestArgs = 14;
+
+for (let i = 0; i <= maxRestArgs; ++i) {
+  makeTest(i)();
+}