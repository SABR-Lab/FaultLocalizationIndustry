# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: parser/html/nsHtml5SpeculativeLoad.h
# Commit: 9a8abd87cc79
# Full Hash: 9a8abd87cc7935f29b94248c1a6f8203faa14403
# Author: Henri Sivonen <hsivonen@hsivonen.fi>
# Date: 2021-12-08 21:43:06
# Regressor Bug: 1701828
# File Overlap Count: 1
# Description:
#   Bug 1701828 - meta charset rewrite. r=smaug
#   
#   Implements https://github.com/whatwg/html/issues/6962 . Improves performance
#   when <meta charset> occurs in head but after the first kilobyte and aligns
#   behavior better with WebKit and Blink.
# ==============================================================================

diff --git a/parser/html/nsHtml5SpeculativeLoad.h b/parser/html/nsHtml5SpeculativeLoad.h
--- a/parser/html/nsHtml5SpeculativeLoad.h
+++ b/parser/html/nsHtml5SpeculativeLoad.h
@@ -27,17 +27,18 @@ enum eHtml5SpeculativeLoad {
   eSpeculativeLoadNoModuleScript,
   eSpeculativeLoadNoModuleScriptFromHead,
   eSpeculativeLoadStyle,
   eSpeculativeLoadManifest,
   eSpeculativeLoadSetDocumentCharset,
   eSpeculativeLoadSetDocumentMode,
   eSpeculativeLoadPreconnect,
   eSpeculativeLoadFont,
-  eSpeculativeLoadFetch
+  eSpeculativeLoadFetch,
+  eSpeculativeLoadMaybeComplainAboutCharset
 };
 
 class nsHtml5SpeculativeLoad {
   using Encoding = mozilla::Encoding;
   template <typename T>
   using NotNull = mozilla::NotNull<T>;
 
  public:
@@ -270,16 +271,34 @@ class nsHtml5SpeculativeLoad {
                "Trying to reinitialize a speculative load!");
     mOpCode = eSpeculativeLoadSetDocumentCharset;
     mCharsetOrSrcset.~nsString();
     mEncoding = aEncoding;
     mTypeOrCharsetSourceOrDocumentModeOrMetaCSPOrSizesOrIntegrity.Assign(
         (char16_t)aCharsetSource);
   }
 
+  inline void InitMaybeComplainAboutCharset(const char* aMsgId, bool aError,
+                                            int32_t aLineNumber) {
+    MOZ_ASSERT(mOpCode == eSpeculativeLoadUninitialized,
+               "Trying to reinitialize a speculative load!");
+    mOpCode = eSpeculativeLoadMaybeComplainAboutCharset;
+    mCharsetOrSrcset.~nsString();
+    mMsgId = aMsgId;
+    mIsError = aError;
+    // Transport a 32-bit integer as two 16-bit code units of a string
+    // in order to avoid adding an integer field to the object.
+    // See https://bugzilla.mozilla.org/show_bug.cgi?id=1733043 for a better
+    // eventual approach.
+    char16_t high = (char16_t)(((uint32_t)aLineNumber) >> 16);
+    char16_t low = (char16_t)(((uint32_t)aLineNumber) & 0xFFFF);
+    mTypeOrCharsetSourceOrDocumentModeOrMetaCSPOrSizesOrIntegrity.Assign(high);
+    mTypeOrCharsetSourceOrDocumentModeOrMetaCSPOrSizesOrIntegrity.Append(low);
+  }
+
   /**
    * Speculative document mode setting isn't really speculative. Once it
    * happens, we are committed to it. However, this information needs to
    * travel in the speculation queue in order to have this information
    * available before parsing the speculatively loaded style sheets.
    */
   inline void InitSetDocumentMode(nsHtml5DocumentMode aMode) {
     MOZ_ASSERT(mOpCode == eSpeculativeLoadUninitialized,
@@ -301,28 +320,37 @@ class nsHtml5SpeculativeLoad {
 
  private:
   nsHtml5SpeculativeLoad(const nsHtml5SpeculativeLoad&) = delete;
   nsHtml5SpeculativeLoad& operator=(const nsHtml5SpeculativeLoad&) = delete;
 
   eHtml5SpeculativeLoad mOpCode;
 
   /**
-   * Whether the refering element has async and/or defer attributes.
+   * Whether the refering element has async attribute.
    */
   bool mIsAsync;
+
+  /**
+   * Whether the refering element has defer attribute.
+   */
   bool mIsDefer;
 
   /**
    * True if and only if this is a speculative load initiated by <link
    * rel="preload"> tag encounter.  Passed to the handling loader as an
    * indication to raise the priority.
    */
   bool mIsLinkPreload;
 
+  /**
+   * Whether the charset complaint is an error.
+   */
+  bool mIsError;
+
   /* If mOpCode is eSpeculativeLoadPictureSource, this is the value of the
    * "sizes" attribute. If the attribute is not set, this will be a void
    * string. Otherwise it empty or the value of the url.
    */
   nsString mUrlOrSizes;
   /**
    * If mOpCode is eSpeculativeLoadScript[FromHead], this is the value of the
    * "integrity" attribute. If the attribute is not set, this will be a void
@@ -332,20 +360,22 @@ class nsHtml5SpeculativeLoad {
   /**
    * If mOpCode is eSpeculativeLoadStyle or eSpeculativeLoadScript[FromHead]
    * then this is the value of the "charset" attribute. For
    * eSpeculativeLoadSetDocumentCharset it is the charset that the
    * document's charset is being set to. If mOpCode is eSpeculativeLoadImage
    * or eSpeculativeLoadPictureSource, this is the value of the "srcset"
    * attribute. If the attribute is not set, this will be a void string.
    * Otherwise it's empty.
+   * For eSpeculativeLoadMaybeComplainAboutCharset mMsgId is used.
    */
   union {
     nsString mCharsetOrSrcset;
     const Encoding* mEncoding;
+    const char* mMsgId;
   };
   /**
    * If mOpCode is eSpeculativeLoadSetDocumentCharset, this is a
    * one-character string whose single character's code point is to be
    * interpreted as a charset source integer. If mOpCode is
    * eSpeculativeLoadSetDocumentMode, this is a one-character string whose
    * single character's code point is to be interpreted as an
    * nsHtml5DocumentMode. If mOpCode is eSpeculativeLoadCSP, this is a meta