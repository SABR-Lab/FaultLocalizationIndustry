# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: parser/html/nsHtml5TreeOpExecutor.cpp
# Commit: 77388b0795b4
# Full Hash: 77388b0795b4f9a30171c922d6b649c52e5f6c87
# Author: Henri Sivonen <hsivonen@hsivonen.fi>
# Date: 2021-12-23 09:34:36
# Description:
#   Bug 1745142 - Communicate encoding commitment via speculative load queue. r=smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D133996
# ==============================================================================

diff -r a388127095db -r 77388b0795b4 parser/html/nsHtml5TreeOpExecutor.cpp
--- a/parser/html/nsHtml5TreeOpExecutor.cpp	Wed Dec 22 15:47:08 2021 +0000
+++ b/parser/html/nsHtml5TreeOpExecutor.cpp	Wed Dec 22 15:54:49 2021 +0000
@@ -118,7 +118,6 @@
 nsHtml5TreeOpExecutor::nsHtml5TreeOpExecutor()
     : nsHtml5DocumentBuilder(false),
       mSuppressEOF(false),
-      mPendingEncodingCommitment(false),
       mReadingFromStage(false),
       mStreamParser(nullptr),
       mPreloadedURLs(23),  // Mean # of preloadable resources per page on dmoz
@@ -433,7 +432,7 @@
 static bool BackgroundFlushCallback(TimeStamp /*aDeadline*/) {
   RefPtr<nsHtml5TreeOpExecutor> ex = gBackgroundFlushList->popFirst();
   if (ex) {
-    ex->RunFlushLoopOrCommitToInternalEncoding();
+    ex->RunFlushLoop();
   }
   if (gBackgroundFlushList && gBackgroundFlushList->isEmpty()) {
     delete gBackgroundFlushList;
@@ -447,22 +446,10 @@
 
 void nsHtml5TreeOpExecutor::ContinueInterruptedParsingAsync() {
   if (mDocument && !mDocument->IsInBackgroundWindow()) {
-    if (mPendingEncodingCommitment) {
-      // Unlike the general executor flusher, the encoding committer
-      // calls ContinueAfterScriptsOrEncodingCommitment() with the
-      // arguments indicating encoding commitment rather than script
-      // once done. Also, in order to get the correct encoding set
-      // on the document object for speculative load purposes, the
-      // encoding committer doesn't check for throttling.
-      if (mStreamParser) {
-        mStreamParser->PostEncodingCommitter();
-      }
-    } else {
-      nsCOMPtr<nsIRunnable> flusher = new nsHtml5ExecutorReflusher(this);
-      if (NS_FAILED(
-              mDocument->Dispatch(TaskCategory::Network, flusher.forget()))) {
-        NS_WARNING("failed to dispatch executor flush event");
-      }
+    nsCOMPtr<nsIRunnable> flusher = new nsHtml5ExecutorReflusher(this);
+    if (NS_FAILED(
+            mDocument->Dispatch(TaskCategory::Network, flusher.forget()))) {
+      NS_WARNING("failed to dispatch executor flush event");
     }
   } else {
     if (!gBackgroundFlushList) {
@@ -813,45 +800,18 @@
   return rv;
 }
 
-void nsHtml5TreeOpExecutor::RunFlushLoopOrCommitToInternalEncoding() {
-  if (mPendingEncodingCommitment) {
-    CommitToInternalEncoding();
-  } else {
-    RunFlushLoop();
-  }
-}
-
 void nsHtml5TreeOpExecutor::CommitToInternalEncoding() {
   if (MOZ_UNLIKELY(!mParser || !mStreamParser)) {
     // An extension terminated the parser from a HTTP observer.
     ClearOpQueue();  // clear in order to be able to assert in destructor
     return;
   }
-  mPendingEncodingCommitment = false;
-  RunFlushLoop();
-  if (MOZ_UNLIKELY(!mParser || !mStreamParser)) {
-    // The parser got terminated somehow. Perhaps by an extension?
-    ClearOpQueue();  // clear in order to be able to assert in destructor
-    return;
-  }
-  // The above loop is supposed to relate to plain text and View Source only.
-  // As such, it never supposed to runs content scripts. Unfortunately, the
-  // loop may be interrupted by timer and by extension-injected scripts. In
-  // that case, we repost the runnable and return early. :-(
-  if (!mParser->IsParserEnabled()) {
-    mPendingEncodingCommitment = true;
-    return;
-  }
-  if (!mOpQueue.IsEmpty()) {
-    mStreamParser->PostEncodingCommitter();
-    mPendingEncodingCommitment = true;
-    return;
-  }
   mStreamParser->ContinueAfterScriptsOrEncodingCommitment(nullptr, nullptr,
                                                           false);
-  RunFlushLoop();
 }
 
+void nsHtml5TreeOpExecutor::TakeOpsFromStage() { mStage.MoveOpsTo(mOpQueue); }
+
 // copied from HTML content sink
 bool nsHtml5TreeOpExecutor::IsScriptEnabled() {
   // Note that if we have no document or no docshell or no global or whatnot we
@@ -959,6 +919,21 @@
   mStarted = true;
 }
 
+void nsHtml5TreeOpExecutor::UpdateCharsetSource(
+    nsCharsetSource aCharsetSource) {
+  if (mDocument) {
+    mDocument->SetDocumentCharacterSetSource(aCharsetSource);
+  }
+}
+
+void nsHtml5TreeOpExecutor::SetDocumentCharsetAndSource(
+    NotNull<const Encoding*> aEncoding, nsCharsetSource aCharsetSource) {
+  if (mDocument) {
+    mDocument->SetDocumentCharacterSetSource(aCharsetSource);
+    mDocument->SetDocumentCharacterSet(aEncoding);
+  }
+}
+
 void nsHtml5TreeOpExecutor::NeedsCharsetSwitchTo(
     NotNull<const Encoding*> aEncoding, int32_t aSource, uint32_t aLineNumber) {
   nsHtml5AutoPauseUpdate autoPause(this);