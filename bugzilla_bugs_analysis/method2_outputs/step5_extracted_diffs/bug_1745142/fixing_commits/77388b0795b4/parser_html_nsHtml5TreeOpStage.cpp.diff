# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: parser/html/nsHtml5TreeOpStage.cpp
# Commit: 77388b0795b4
# Full Hash: 77388b0795b4f9a30171c922d6b649c52e5f6c87
# Author: Henri Sivonen <hsivonen@hsivonen.fi>
# Date: 2021-12-23 09:34:36
# Description:
#   Bug 1745142 - Communicate encoding commitment via speculative load queue. r=smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D133996
# ==============================================================================

diff -r a388127095db -r 77388b0795b4 parser/html/nsHtml5TreeOpStage.cpp
--- a/parser/html/nsHtml5TreeOpStage.cpp	Wed Dec 22 15:47:08 2021 +0000
+++ b/parser/html/nsHtml5TreeOpStage.cpp	Wed Dec 22 15:54:49 2021 +0000
@@ -23,6 +23,11 @@
   aSpeculativeLoadQueue.AppendElements(std::move(mSpeculativeLoadQueue));
 }
 
+void nsHtml5TreeOpStage::MoveOpsTo(nsTArray<nsHtml5TreeOperation>& aOpQueue) {
+  mozilla::MutexAutoLock autoLock(mMutex);
+  aOpQueue.AppendElements(std::move(mOpQueue));
+}
+
 void nsHtml5TreeOpStage::MoveSpeculativeLoadsFrom(
     nsTArray<nsHtml5SpeculativeLoad>& aSpeculativeLoadQueue) {
   mozilla::MutexAutoLock autoLock(mMutex);
@@ -38,7 +43,6 @@
 #ifdef DEBUG
 void nsHtml5TreeOpStage::AssertEmpty() {
   mozilla::MutexAutoLock autoLock(mMutex);
-  // This shouldn't really need the mutex
-  NS_ASSERTION(mOpQueue.IsEmpty(), "The stage was supposed to be empty.");
+  MOZ_ASSERT(mOpQueue.IsEmpty(), "The stage was supposed to be empty.");
 }
 #endif