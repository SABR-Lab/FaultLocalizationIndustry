# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: parser/html/nsHtml5Highlighter.cpp
# Commit: 9a8abd87cc79
# Full Hash: 9a8abd87cc7935f29b94248c1a6f8203faa14403
# Author: Henri Sivonen <hsivonen@hsivonen.fi>
# Date: 2021-12-08 21:43:06
# Regressor Bug: 1701828
# File Overlap Count: 10
# Description:
#   Bug 1701828 - meta charset rewrite. r=smaug
#   
#   Implements https://github.com/whatwg/html/issues/6962 . Improves performance
#   when <meta charset> occurs in head but after the first kilobyte and aligns
#   behavior better with WebKit and Blink.
# ==============================================================================

diff --git a/parser/html/nsHtml5Highlighter.cpp b/parser/html/nsHtml5Highlighter.cpp
--- a/parser/html/nsHtml5Highlighter.cpp
+++ b/parser/html/nsHtml5Highlighter.cpp
@@ -61,16 +61,40 @@ nsHtml5Highlighter::nsHtml5Highlighter(n
       mSeenBase(false) {
   NS_ASSERTION(NS_IsMainThread(), "Wrong thread!");
 }
 
 nsHtml5Highlighter::~nsHtml5Highlighter() {
   NS_ASSERTION(NS_IsMainThread(), "Wrong thread!");
 }
 
+void nsHtml5Highlighter::SetOpSink(nsAHtml5TreeOpSink* aOpSink) {
+  mOpSink = aOpSink;
+}
+
+void nsHtml5Highlighter::Rewind() {
+  mState = 0;
+  mCStart = INT32_MAX;
+  mPos = 0;
+  mLineNumber = 1;
+  mInlinesOpen = 0;
+  mInCharacters = false;
+  mBuffer = nullptr;
+  mOpQueue.Clear();
+  mCurrentRun = nullptr;
+  mAmpersand = nullptr;
+  mSlash = nullptr;
+  // Pop until we have three elements on the stack:
+  // html, body, and pre.
+  while (mStack.Length() > 3) {
+    Pop();
+  }
+  mSeenBase = false;
+}
+
 void nsHtml5Highlighter::Start(const nsAutoString& aTitle) {
   // Doctype
   opAppendDoctypeToDocument operation(nsGkAtoms::html, u""_ns, u""_ns);
   mOpQueue.AppendElement()->Init(mozilla::AsVariant(operation));
 
   mOpQueue.AppendElement()->Init(mozilla::AsVariant(STANDARDS_MODE));
 
   // <html> uses NS_NewHTMLSharedElement creator
@@ -109,19 +133,22 @@ void nsHtml5Highlighter::Start(const nsA
   Push(nsGkAtoms::body, nsHtml5ViewSourceUtils::NewBodyAttributes(),
        NS_NewHTMLBodyElement);
 
   nsHtml5HtmlAttributes* preAttrs = new nsHtml5HtmlAttributes(0);
   nsHtml5String preId = nsHtml5Portability::newStringFromLiteral("line1");
   preAttrs->addAttribute(nsHtml5AttributeName::ATTR_ID, preId, -1);
   Push(nsGkAtoms::pre, preAttrs, NS_NewHTMLPreElement);
 
-  StartCharacters();
+  // Don't call StartCharacters here in order to be able to put it in
+  // a speculation.
 
   mOpQueue.AppendElement()->Init(mozilla::AsVariant(opStartLayout()));
+
+  FlushOps();
 }
 
 int32_t nsHtml5Highlighter::Transition(int32_t aState, bool aReconsume,
                                        int32_t aPos) {
   mPos = aPos;
   switch (mState) {
     case nsHtml5Tokenizer::SCRIPT_DATA:
     case nsHtml5Tokenizer::RAWTEXT: