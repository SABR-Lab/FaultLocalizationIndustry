# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: third_party/rust/xmldecl/src/lib.rs
# Commit: 9a8abd87cc79
# Full Hash: 9a8abd87cc7935f29b94248c1a6f8203faa14403
# Author: Henri Sivonen <hsivonen@hsivonen.fi>
# Date: 2021-12-08 21:43:06
# Regressor Bug: 1701828
# File Overlap Count: 10
# Description:
#   Bug 1701828 - meta charset rewrite. r=smaug
#   
#   Implements https://github.com/whatwg/html/issues/6962 . Improves performance
#   when <meta charset> occurs in head but after the first kilobyte and aligns
#   behavior better with WebKit and Blink.
# ==============================================================================

diff --git a/third_party/rust/xmldecl/src/lib.rs b/third_party/rust/xmldecl/src/lib.rs
--- a/third_party/rust/xmldecl/src/lib.rs
+++ b/third_party/rust/xmldecl/src/lib.rs
@@ -38,29 +38,24 @@ fn skip_encoding(hay: &[u8]) -> Option<&
             haystack = tail;
         } else {
             return None;
         }
     }
 }
 
 /// Extracts an encoding from an ASCII-based bogo-XML declaration.
-/// `bytes` must the prefix of a `text/html` resource. If it is longer
-/// than 1024 bytes, only the first 1024 bytes are examined.
+/// `bytes` must the prefix of a `text/html` resource.
 ///
 /// The intended use is that when the `meta` prescan fails, the HTML
-/// parser will have buffered the first 1024 bytes at which point they
-/// should be passed to this function.
+/// parser will have buffered the head section or the first 1024
+/// bytes (whichever is larger) at which point the should be passed to
+/// this function.
 pub fn parse(bytes: &[u8]) -> Option<&'static encoding_rs::Encoding> {
-    let up_to_kilobyte = if bytes.len() > 1024 {
-        &bytes[..1024]
-    } else {
-        bytes
-    };
-    if let Some(after_xml) = up_to_kilobyte.strip_prefix(b"<?xml") {
+    if let Some(after_xml) = bytes.strip_prefix(b"<?xml") {
         if let Some(gt) = position(b'>', after_xml) {
             let until_gt = &after_xml[..gt];
             if let Some(tail) = skip_encoding(until_gt) {
                 let mut pos = 0;
                 loop {
                     if pos >= tail.len() {
                         return None;
                     }
@@ -366,11 +361,11 @@ mod tests {
     fn bytes_1025() {
         let mut v = Vec::new();
         v.extend_from_slice(b"<?xml version=\"1.0\" encoding=\"windows-1251\"");
         while v.len() < 1023 {
             v.push(b' ');
         }
         v.extend_from_slice(b"?>AAAA");
         assert_eq!(v.len(), 1029);
-        assert_eq!(parse(&v), None);
+        assert_eq!(parse(&v), Some(encoding_rs::WINDOWS_1251));
     }
 }