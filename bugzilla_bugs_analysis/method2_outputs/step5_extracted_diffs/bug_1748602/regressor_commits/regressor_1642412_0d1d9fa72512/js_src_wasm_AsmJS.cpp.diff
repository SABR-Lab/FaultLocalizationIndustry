# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/AsmJS.cpp
# Commit: 0d1d9fa72512
# Full Hash: 0d1d9fa72512cf8da0bc8c0fdd63f3fb3ff0a468
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2022-03-23 04:09:13
# Regressor Bug: 1642412
# File Overlap Count: 1
# Description:
#   Bug 1642412 - wasm: Don't read a call site line in operations that AsmJS won't emit one for. r=lth
#   
#   AsmJS will emit a call site line number for call, call indirect, and math builtins.
#   We currently read from the call site line number array for more operations than
#   these. This is normally fine, as long as the operations that try the read are
# ==============================================================================

diff -r 285174ef42f1 -r 0d1d9fa72512 js/src/wasm/AsmJS.cpp
--- a/js/src/wasm/AsmJS.cpp	Tue Mar 22 19:59:07 2022 +0000
+++ b/js/src/wasm/AsmJS.cpp	Tue Mar 22 19:59:07 2022 +0000
@@ -2658,6 +2658,7 @@
   }
 
   [[nodiscard]] bool writeCall(ParseNode* pn, Op op) {
+    MOZ_ASSERT(op == Op::Call);
     if (!encoder().writeOp(op)) {
       return false;
     }
@@ -2665,6 +2666,7 @@
     return appendCallSiteLineNumber(pn);
   }
   [[nodiscard]] bool writeCall(ParseNode* pn, MozOp op) {
+    MOZ_ASSERT(op == MozOp::OldCallDirect || op == MozOp::OldCallIndirect);
     if (!encoder().writeOp(op)) {
       return false;
     }