# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/AsmJS.cpp
# Commit: 82ac83afeaea
# Full Hash: 82ac83afeaeaa3665037ea587c614fddaa8b648d
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2022-03-24 21:54:20
# Regressor Bug: 1642412
# File Overlap Count: 1
# Description:
#   Bug 1642412 - wasm: Don't read a call site line in operations that AsmJS won't emit one for. r=lth
#   
#   AsmJS will emit a call site line number for call, call indirect, and math builtins.
#   We currently read from the call site line number array for more operations than
#   these. This is normally fine, as long as the operations that try the read are
# ==============================================================================

diff -r 00b99ec19d1e -r 82ac83afeaea js/src/wasm/AsmJS.cpp
--- a/js/src/wasm/AsmJS.cpp	Thu Mar 24 17:56:52 2022 +0000
+++ b/js/src/wasm/AsmJS.cpp	Thu Mar 24 17:56:53 2022 +0000
@@ -2658,6 +2658,7 @@
   }
 
   [[nodiscard]] bool writeCall(ParseNode* pn, Op op) {
+    MOZ_ASSERT(op == Op::Call);
     if (!encoder().writeOp(op)) {
       return false;
     }
@@ -2665,6 +2666,7 @@
     return appendCallSiteLineNumber(pn);
   }
   [[nodiscard]] bool writeCall(ParseNode* pn, MozOp op) {
+    MOZ_ASSERT(op == MozOp::OldCallDirect || op == MozOp::OldCallIndirect);
     if (!encoder().writeOp(op)) {
       return false;
     }