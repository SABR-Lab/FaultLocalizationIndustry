# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: media/libcubeb/src/cubeb_wasapi.cpp
# Commit: 4531cca1d7f9
# Full Hash: 4531cca1d7f9ff4f8f1fa0ea85409b43ae92d062
# Author: Matthew Gregan <kinetik@flim.org>
# Date: 2022-01-08 22:02:26
# Description:
#   Bug 1749122 - Fix nullptr deref in cubeb wasapi default devices query. a=aryx
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D135447
# ==============================================================================

diff -r a0549c331ce9 -r 4531cca1d7f9 media/libcubeb/src/cubeb_wasapi.cpp
--- a/media/libcubeb/src/cubeb_wasapi.cpp	Sat Jan 08 21:32:24 2022 +0200
+++ b/media/libcubeb/src/cubeb_wasapi.cpp	Sat Jan 08 19:53:45 2022 +0000
@@ -199,6 +199,24 @@
             wasapi_get_default_device_id(eCapture, eCommunications, enumerator))
   {
   }
+
+  bool is_default(EDataFlow flow, ERole role, wchar_t const * id)
+  {
+    wchar_t const * default_id = nullptr;
+    if (flow == eRender && role == eConsole) {
+      default_id = this->render_console_id.get();
+    } else if (flow == eRender && role == eCommunications) {
+      default_id = this->render_comms_id.get();
+    } else if (flow == eCapture && role == eConsole) {
+      default_id = this->capture_console_id.get();
+    } else if (flow == eCapture && role == eCommunications) {
+      default_id = this->capture_comms_id.get();
+    }
+
+    return default_id && wcscmp(id, default_id) == 0;
+  }
+
+private:
   com_heap_ptr<wchar_t> render_console_id;
   com_heap_ptr<wchar_t> render_comms_id;
   com_heap_ptr<wchar_t> capture_console_id;
@@ -3160,17 +3178,11 @@
   }
 
   ret.preferred = CUBEB_DEVICE_PREF_NONE;
-  if ((flow == eRender &&
-       wcscmp(device_id.get(), defaults->render_console_id.get()) == 0) ||
-      (flow == eCapture &&
-       wcscmp(device_id.get(), defaults->capture_console_id.get()) == 0)) {
+  if (defaults->is_default(flow, eConsole, device_id.get())) {
     ret.preferred =
         (cubeb_device_pref)(ret.preferred | CUBEB_DEVICE_PREF_MULTIMEDIA |
                             CUBEB_DEVICE_PREF_NOTIFICATION);
-  } else if ((flow == eRender &&
-              wcscmp(device_id.get(), defaults->render_comms_id.get()) == 0) ||
-             (flow == eCapture &&
-              wcscmp(device_id.get(), defaults->capture_comms_id.get()) == 0)) {
+  } else if (defaults->is_default(flow, eCommunications, device_id.get())) {
     ret.preferred =
         (cubeb_device_pref)(ret.preferred | CUBEB_DEVICE_PREF_VOICE);
   }
