# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp
# Commit: c3d14f2b234a
# Full Hash: c3d14f2b234a7494edf3231113af52f5fc2d2355
# Author: stransky <stransky@redhat.com>
# Date: 2022-01-25 16:37:35
# Regressor Bug: 1724385
# File Overlap Count: 1
# Description:
#   Bug 1724385 [Linux] Try to create EGLImage over decoded VA-API video frame r=alwu,emilio,media-playback-reviewers
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D135460
# ==============================================================================

diff -r 5834c469b533 -r c3d14f2b234a dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp
--- a/dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp	Tue Jan 25 07:03:13 2022 +0000
+++ b/dom/media/platforms/ffmpeg/FFmpegVideoDecoder.cpp	Tue Jan 25 07:08:02 2022 +0000
@@ -405,9 +405,6 @@
   mExtraData->AppendElements(*aConfig.mExtraData);
 #ifdef MOZ_WAYLAND_USE_VAAPI
   InitHWDecodingPrefs();
-  if (mUseDMABufSurfaces || mEnableHardwareDecoding) {
-    mVideoFramePool = MakeUnique<VideoFramePool>(mEnableHardwareDecoding);
-  }
 #endif
 }
 
@@ -867,6 +864,9 @@
       // If VA-API playback failed, just quit. Decoder is going to be restarted
       // without VA-API.
       if (NS_FAILED(rv)) {
+        // Explicitly remove dmabuf surface pool as it's configured
+        // for VA-API support.
+        mVideoFramePool = nullptr;
         return rv;
       }
     } else if (mUseDMABufSurfaces) {
@@ -1119,7 +1119,7 @@
   VADRMPRIMESurfaceDescriptor vaDesc;
   if (!GetVAAPISurfaceDescriptor(&vaDesc)) {
     return MediaResult(
-        NS_ERROR_OUT_OF_MEMORY,
+        NS_ERROR_DOM_MEDIA_DECODE_ERR,
         RESULT_DETAIL("Unable to get frame by vaExportSurfaceHandle()"));
   }
 
@@ -1127,7 +1127,7 @@
   auto surface = mVideoFramePool->GetVideoFrameSurface(vaDesc, mCodecContext,
                                                        mFrame, mLib);
   if (!surface) {
-    return MediaResult(NS_ERROR_OUT_OF_MEMORY,
+    return MediaResult(NS_ERROR_DOM_MEDIA_DECODE_ERR,
                        RESULT_DETAIL("VAAPI dmabuf allocation error"));
   }
   surface->SetYUVColorSpace(GetFrameColorSpace());
@@ -1145,7 +1145,7 @@
       !!mFrame->key_frame, TimeUnit::FromMicroseconds(-1));
 
   if (!vp) {
-    return MediaResult(NS_ERROR_OUT_OF_MEMORY,
+    return MediaResult(NS_ERROR_DOM_MEDIA_DECODE_ERR,
                        RESULT_DETAIL("VAAPI image allocation error"));
   }
 
@@ -1164,7 +1164,7 @@
   auto surface =
       mVideoFramePool->GetVideoFrameSurface(mCodecContext->pix_fmt, mFrame);
   if (!surface) {
-    return MediaResult(NS_ERROR_OUT_OF_MEMORY,
+    return MediaResult(NS_ERROR_DOM_MEDIA_DECODE_ERR,
                        RESULT_DETAIL("dmabuf allocation error"));
   }
   surface->SetYUVColorSpace(GetFrameColorSpace());
@@ -1182,7 +1182,7 @@
       !!mFrame->key_frame, TimeUnit::FromMicroseconds(-1));
 
   if (!vp) {
-    return MediaResult(NS_ERROR_OUT_OF_MEMORY,
+    return MediaResult(NS_ERROR_DOM_MEDIA_DECODE_ERR,
                        RESULT_DETAIL("image allocation error"));
   }
 