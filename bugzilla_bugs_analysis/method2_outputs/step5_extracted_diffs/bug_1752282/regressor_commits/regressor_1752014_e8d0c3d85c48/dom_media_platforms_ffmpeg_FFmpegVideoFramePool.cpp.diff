# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/platforms/ffmpeg/FFmpegVideoFramePool.cpp
# Commit: e8d0c3d85c48
# Full Hash: e8d0c3d85c48bc793ee27bcc9fbd3bcde819781f
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-01-26 16:31:34
# Regressor Bug: 1752014
# File Overlap Count: 1
# Description:
#   Bug 1752014 - Cleanup VideoFramePool::GetFreeVideoFrameSurface. r=stransky,media-playback-reviewers
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D136874
# ==============================================================================

diff -r 5c02a8fc256d -r e8d0c3d85c48 dom/media/platforms/ffmpeg/FFmpegVideoFramePool.cpp
--- a/dom/media/platforms/ffmpeg/FFmpegVideoFramePool.cpp	Tue Jan 25 21:51:17 2022 +0000
+++ b/dom/media/platforms/ffmpeg/FFmpegVideoFramePool.cpp	Tue Jan 25 22:01:38 2022 +0000
@@ -95,17 +95,15 @@
 }
 
 RefPtr<VideoFrameSurface> VideoFramePool::GetFreeVideoFrameSurface() {
-  int len = mDMABufSurfaces.Length();
-  for (int i = 0; i < len; i++) {
-    auto* dmabufSurface = mDMABufSurfaces[i]->AsVideoFrameSurfaceDMABuf();
-    if (!dmabufSurface->IsUsed()) {
-      auto* vaapiSurface = dmabufSurface->AsVideoFrameSurfaceVAAPI();
-      if (vaapiSurface) {
-        vaapiSurface->ReleaseVAAPIData();
-      }
-      dmabufSurface->MarkAsUsed();
-      return mDMABufSurfaces[i];
+  for (auto& surface : mDMABufSurfaces) {
+    if (surface->IsUsed()) {
+      continue;
     }
+    if (auto* vaapiSurface = surface->AsVideoFrameSurfaceVAAPI()) {
+      vaapiSurface->ReleaseVAAPIData();
+    }
+    surface->MarkAsUsed();
+    return surface;
   }
   return nullptr;
 }
@@ -123,7 +121,7 @@
   }
 
   MutexAutoLock lock(mSurfaceLock);
-  auto videoSurface = GetFreeVideoFrameSurface();
+  RefPtr<VideoFrameSurface> videoSurface = GetFreeVideoFrameSurface();
   if (!videoSurface) {
     RefPtr<DMABufSurfaceYUV> surface =
         DMABufSurfaceYUV::CreateYUVSurface(aVaDesc);
@@ -131,6 +129,7 @@
       return nullptr;
     }
     FFMPEG_LOG("Created new VA-API DMABufSurface UID = %d", surface->GetUID());
+    RefPtr<VideoFrameSurfaceDMABuf> surf = new VideoFrameSurfaceVAAPI(surface);
     if (!mTextureCreationWorks) {
       mTextureCreationWorks = Some(surface->VerifyTextureCreation());
     }
@@ -138,8 +137,8 @@
       FFMPEG_LOG("  failed to create texture over DMABuf memory!");
       return nullptr;
     }
-    videoSurface = new VideoFrameSurfaceVAAPI(surface);
-    mDMABufSurfaces.AppendElement(videoSurface);
+    videoSurface = surf;
+    mDMABufSurfaces.AppendElement(std::move(surf));
   } else {
     RefPtr<DMABufSurfaceYUV> surface = videoSurface->GetDMABufSurface();
     if (!surface->UpdateYUVData(aVaDesc)) {
@@ -148,8 +147,7 @@
     FFMPEG_LOG("Reusing VA-API DMABufSurface UID = %d", surface->GetUID());
   }
 
-  auto vaapiSurface = videoSurface->AsVideoFrameSurfaceVAAPI();
-  if (vaapiSurface) {
+  if (auto* vaapiSurface = videoSurface->AsVideoFrameSurfaceVAAPI()) {
     vaapiSurface->LockVAAPIData(aAVCodecContext, aAVFrame, aLib);
   }
   return videoSurface;
@@ -167,32 +165,30 @@
   }
 
   MutexAutoLock lock(mSurfaceLock);
-  auto videoSurface = GetFreeVideoFrameSurface();
-  if (!videoSurface) {
-    RefPtr<DMABufSurfaceYUV> surface = DMABufSurfaceYUV::CreateYUVSurface(
-        aFrame->width, aFrame->height, (void**)aFrame->data, aFrame->linesize);
-    if (!surface) {
+  if (RefPtr<VideoFrameSurface> videoSurface = GetFreeVideoFrameSurface()) {
+    RefPtr<DMABufSurfaceYUV> surface = videoSurface->GetDMABufSurface();
+    if (!surface->UpdateYUVData((void**)aFrame->data, aFrame->linesize)) {
       return nullptr;
     }
-    FFMPEG_LOG("Created new SW DMABufSurface UID = %d", surface->GetUID());
-    videoSurface = new VideoFrameSurfaceDMABuf(surface);
-    if (!mTextureCreationWorks) {
-      mTextureCreationWorks = Some(surface->VerifyTextureCreation());
-    }
-    if (!*mTextureCreationWorks) {
-      FFMPEG_LOG("  failed to create texture over DMABuf memory!");
-      return nullptr;
-    }
-    mDMABufSurfaces.AppendElement(videoSurface);
+    FFMPEG_LOG("Reusing SW DMABufSurface UID = %d", surface->GetUID());
     return videoSurface;
   }
-
-  RefPtr<DMABufSurfaceYUV> surface = videoSurface->GetDMABufSurface();
-  if (!surface->UpdateYUVData((void**)aFrame->data, aFrame->linesize)) {
+  RefPtr<DMABufSurfaceYUV> surface = DMABufSurfaceYUV::CreateYUVSurface(
+      aFrame->width, aFrame->height, (void**)aFrame->data, aFrame->linesize);
+  if (!surface) {
     return nullptr;
   }
-  FFMPEG_LOG("Reusing SW DMABufSurface UID = %d", surface->GetUID());
-  return videoSurface;
+  RefPtr<VideoFrameSurfaceDMABuf> surf = new VideoFrameSurfaceDMABuf(surface);
+  if (!mTextureCreationWorks) {
+    mTextureCreationWorks = Some(surface->VerifyTextureCreation());
+  }
+  if (!*mTextureCreationWorks) {
+    FFMPEG_LOG("  failed to create texture over DMABuf memory!");
+    return nullptr;
+  }
+  FFMPEG_LOG("Created new SW DMABufSurface UID = %d", surface->GetUID());
+  mDMABufSurfaces.AppendElement(surf);
+  return surf;
 }
 
 }  // namespace mozilla