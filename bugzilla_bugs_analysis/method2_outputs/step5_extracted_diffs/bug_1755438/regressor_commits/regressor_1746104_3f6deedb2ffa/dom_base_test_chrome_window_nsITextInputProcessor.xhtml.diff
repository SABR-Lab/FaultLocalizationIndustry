# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/test/chrome/window_nsITextInputProcessor.xhtml
# Commit: 3f6deedb2ffa
# Full Hash: 3f6deedb2ffae2a52c130f68cc7c0bda882bedfd
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-02-08 17:32:27
# Regressor Bug: 1746104
# File Overlap Count: 1
# Description:
#   Bug 1746104 - part 7: Make `eQuerySelectedText` event and `ContentEventHandler` work with no selection ranges r=m_kato
#   
#   Finally, making `WidgetQueryContentEvent::Succeeded` return `true` when there
#   is no selection when its message is `eQuerySelectedText`, and making
#   `ContentEventHandler::OnQuerySelectedText` set the no selection range data even
# ==============================================================================

diff -r 989ad9507a0c -r 3f6deedb2ffa dom/base/test/chrome/window_nsITextInputProcessor.xhtml
--- a/dom/base/test/chrome/window_nsITextInputProcessor.xhtml	Mon Feb 07 22:33:41 2022 +0000
+++ b/dom/base/test/chrome/window_nsITextInputProcessor.xhtml	Mon Feb 07 22:33:41 2022 +0000
@@ -4155,24 +4155,28 @@
     if (aNotification.type != "notify-selection-change") {
       return;
     }
-    is(aNotification.offset, aExpected.offset,
-       aDescription + " should cause selection change notification whose offset is " + aExpected.offset);
-    is(aNotification.text, aExpected.text,
-       aDescription + " should cause selection change notification whose text is '" + aExpected.text + "'");
-    is(aNotification.collapsed, aExpected.text.length == 0,
-       aDescription + " should cause selection change notification whose collapsed is " + (aExpected.text.length == 0));
-    is(aNotification.length, aExpected.text.length,
-       aDescription + " should cause selection change notification whose length is " + aExpected.text.length);
-    is(aNotification.reversed, aExpected.reversed || false,
-       aDescription + " should cause selection change notification whose reversed is " + (aExpected.reversed || false));
+    is(aNotification.hasRange, aExpected.hasRange !== false,
+      `${aDescription} should cause selection change notification whose hasRange is ${aExpected.hasRange}`);
+    if (aNotification.hasRange) {
+      is(aNotification.offset, aExpected.offset,
+        `${aDescription} should cause selection change notification whose offset is ${aExpected.offset}`);
+      is(aNotification.text, aExpected.text,
+        `${aDescription} should cause selection change notification whose text is "${aExpected.text}"`);
+      is(aNotification.length, aExpected.text.length,
+        `${aDescription} should cause selection change notification whose length is ${aExpected.text.length}`);
+      is(aNotification.reversed, aExpected.reversed || false,
+        `${aDescription} should cause selection change notification whose reversed is ${aExpected.reversed || false}`);
+    }
+    is(aNotification.collapsed, aExpected.hasRange === false || aExpected.text.length == 0,
+      `${aDescription} should cause selection change notification whose collapsed is ${aExpected.hasRange === false || aExpected.text.length == 0}`);
     is(aNotification.writingMode, aExpected.writingMode || "horizontal-tb",
-       aDescription + " should cause selection change notification whose writingMode is '" + (aExpected.writingMode || "horizontal-tb"));
+      `${aDescription} should cause selection change notification whose writingMode is ${aExpected.writingMode || "horizontal-tb"}`);
     is(aNotification.causedByComposition, aExpected.causedByComposition || false,
-       aDescription + " should cause selection change notification whose causedByComposition is " + (aExpected.causedByComposition || false));
+      `${aDescription} should cause selection change notification whose causedByComposition is ${aExpected.causedByComposition || false}`);
     is(aNotification.causedBySelectionEvent, aExpected.causedBySelectionEvent || false,
-       aDescription + " should cause selection change notification whose causedBySelectionEvent is " + (aExpected.causedBySelectionEvent || false));
+      `${aDescription} should cause selection change notification whose causedBySelectionEvent is ${aExpected.causedBySelectionEvent || false}`);
     is(aNotification.occurredDuringComposition, aExpected.occurredDuringComposition || false,
-       aDescription + " should cause cause selection change notification whose occurredDuringComposition is " + (aExpected.occurredDuringComposition || false));
+      `${aDescription} should cause cause selection change notification whose occurredDuringComposition is ${aExpected.occurredDuringComposition || false}`);
   }
 
   function checkTextChangeNotification(aNotification, aDescription, aExpected)
@@ -4313,6 +4317,18 @@
   dumpUnexpectedNotifications(1);
 
   notifications = [];
+  input.editor.selection.removeAllRanges();
+  await waitUntilNotificationsReceived();
+  is(notifications.length, 1,
+    `${description}Removing all selection ranges should cause a selection change notification`);
+  checkSelectionChangeNotification(
+    notifications[0],
+    `${description}Removing all selection ranges in editor`,
+    { hasRange: false }
+  );
+  dumpUnexpectedNotifications(1);
+
+  notifications = [];
   let TIP2 = createTIP();
   if (aForTests) {
     TIP2.beginInputTransactionForTests(window, callback);