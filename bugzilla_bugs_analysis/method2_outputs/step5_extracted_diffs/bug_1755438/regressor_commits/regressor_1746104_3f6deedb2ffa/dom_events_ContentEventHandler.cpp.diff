# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/events/ContentEventHandler.cpp
# Commit: 3f6deedb2ffa
# Full Hash: 3f6deedb2ffae2a52c130f68cc7c0bda882bedfd
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-02-08 17:32:27
# Regressor Bug: 1746104
# File Overlap Count: 1
# Description:
#   Bug 1746104 - part 7: Make `eQuerySelectedText` event and `ContentEventHandler` work with no selection ranges r=m_kato
#   
#   Finally, making `WidgetQueryContentEvent::Succeeded` return `true` when there
#   is no selection when its message is `eQuerySelectedText`, and making
#   `ContentEventHandler::OnQuerySelectedText` set the no selection range data even
# ==============================================================================

diff -r 989ad9507a0c -r 3f6deedb2ffa dom/events/ContentEventHandler.cpp
--- a/dom/events/ContentEventHandler.cpp	Mon Feb 07 22:33:41 2022 +0000
+++ b/dom/events/ContentEventHandler.cpp	Mon Feb 07 22:33:41 2022 +0000
@@ -304,7 +304,8 @@
   return NS_OK;
 }
 
-nsresult ContentEventHandler::InitCommon(SelectionType aSelectionType,
+nsresult ContentEventHandler::InitCommon(EventMessage aEventMessage,
+                                         SelectionType aSelectionType,
                                          bool aRequireFlush) {
   if (mSelection && mSelection->Type() == aSelectionType) {
     return NS_OK;
@@ -351,8 +352,9 @@
   }
 
   // Even if there are no selection ranges, it's usual case if aSelectionType
-  // is a special selection.
-  if (aSelectionType != SelectionType::eNormal) {
+  // is a special selection or we're handling eQuerySelectedText.
+  if (aSelectionType != SelectionType::eNormal ||
+      aEventMessage == eQuerySelectedText) {
     MOZ_ASSERT(!mFirstSelectedRawRange.IsPositioned());
     return NS_OK;
   }
@@ -385,7 +387,8 @@
     return NS_ERROR_FAILURE;
   }
 
-  nsresult rv = InitCommon(selectionType, aEvent->NeedsToFlushLayout());
+  nsresult rv =
+      InitCommon(aEvent->mMessage, selectionType, aEvent->NeedsToFlushLayout());
   NS_ENSURE_SUCCESS(rv, rv);
 
   // Be aware, WidgetQueryContentEvent::mInput::mOffset should be made absolute
@@ -439,7 +442,7 @@
 nsresult ContentEventHandler::Init(WidgetSelectionEvent* aEvent) {
   NS_ASSERTION(aEvent, "aEvent must not be null");
 
-  nsresult rv = InitCommon();
+  nsresult rv = InitCommon(aEvent->mMessage);
   NS_ENSURE_SUCCESS(rv, rv);
 
   aEvent->mSucceeded = false;
@@ -1317,7 +1320,6 @@
   MOZ_ASSERT(aEvent->mReply->mOffsetAndData.isNothing());
 
   if (!mFirstSelectedRawRange.IsPositioned()) {
-    MOZ_ASSERT(aEvent->mInput.mSelectionType != SelectionType::eNormal);
     MOZ_ASSERT(aEvent->mReply->mOffsetAndData.isNothing());
     MOZ_ASSERT_IF(mSelection, !mSelection->RangeCount());
     // This is special case that `mReply` is emplaced, but mOffsetAndData is