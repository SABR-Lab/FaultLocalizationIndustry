# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/SourceSurfaceWebgl.h
# Commit: e178aa7d969e
# Full Hash: e178aa7d969e31550222e903b8844f80732d73bd
# Author: Lee Salzman <lsalzman@mozilla.com>
# Date: 2022-02-12 09:47:43
# Regressor Bug: 1754130
# File Overlap Count: 2
# Description:
#   Bug 1754130 - Implement SourceSurfaceWebgl for faster snapshots of DrawTargetWebgl. r=aosmond
#   
#   Now that each DrawTargetWebgl shares the same WebGL context, we can efficiently draw snapshots
#   of one DrawTargetWebgl to another without requiring any readback or error-prone driver-provided
#   shared context/resource mechanism. We just need to simply pass the WebGL texture from one target
# ==============================================================================

diff -r acbba09f0bce -r e178aa7d969e dom/canvas/SourceSurfaceWebgl.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/canvas/SourceSurfaceWebgl.h	Fri Feb 11 19:49:55 2022 +0000
@@ -0,0 +1,69 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef MOZILLA_GFX_SOURCESURFACEWEBGL_H_
+#define MOZILLA_GFX_SOURCESURFACEWEBGL_H_
+
+#include "mozilla/gfx/2D.h"
+#include "mozilla/WeakPtr.h"
+
+namespace mozilla {
+namespace gfx {
+
+class DrawTargetWebgl;
+class TextureHandle;
+
+// SourceSurfaceWebgl holds WebGL resources that can be used to efficiently
+// copy snapshot data between multiple DrawTargetWebgls. It also takes care
+// of copy-on-write behavior when the owner target is modified or destructs.
+class SourceSurfaceWebgl : public DataSourceSurface {
+ public:
+  MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME(SourceSurfaceWebgl, override)
+
+  SourceSurfaceWebgl();
+  virtual ~SourceSurfaceWebgl();
+
+  bool Init(DrawTargetWebgl* aDT);
+
+  SurfaceType GetType() const override { return SurfaceType::WEBGL; }
+  IntSize GetSize() const override { return mSize; }
+  SurfaceFormat GetFormat() const override { return mFormat; }
+
+  uint8_t* GetData() override;
+  int32_t Stride() override;
+
+  bool Map(MapType aType, MappedSurface* aMappedSurface) override;
+  void Unmap() override;
+
+ private:
+  friend class DrawTargetWebgl;
+
+  bool EnsureData();
+
+  void DrawTargetWillChange();
+
+  void GiveTexture(RefPtr<TextureHandle> aHandle);
+
+  void OnUnlinkTexture(typename DrawTargetWebgl::SharedContext* aContext);
+
+  DrawTargetWebgl* GetTarget() const { return mDT.get(); }
+
+  SurfaceFormat mFormat = SurfaceFormat::UNKNOWN;
+  IntSize mSize;
+  // Any data that has been read back from the WebGL context for mapping.
+  RefPtr<DataSourceSurface> mData;
+  // The draw target that currently owns the texture for this surface.
+  WeakPtr<DrawTargetWebgl> mDT;
+  // The actual shared context that any WebGL resources belong to.
+  WeakPtr<typename DrawTargetWebgl::SharedContext> mSharedContext;
+  // If this snapshot has been copied into a cached texture handle.
+  RefPtr<TextureHandle> mHandle;
+};
+
+}  // namespace gfx
+}  // namespace mozilla
+
+#endif /* MOZILLA_GFX_SOURCESURFACEWEBGL_H_ */