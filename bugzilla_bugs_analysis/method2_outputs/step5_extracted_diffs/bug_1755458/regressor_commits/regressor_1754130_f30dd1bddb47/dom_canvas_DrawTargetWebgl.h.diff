# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/canvas/DrawTargetWebgl.h
# Commit: f30dd1bddb47
# Full Hash: f30dd1bddb471a4f3487fe0e55e8c4bad0f8962a
# Author: Lee Salzman <lsalzman@mozilla.com>
# Date: 2022-02-12 09:47:43
# Regressor Bug: 1754130
# File Overlap Count: 2
# Description:
#   Bug 1754130 - Support presenting a WebGLFramebuffer to its own swap chain without opaque FB. r=aosmond,jgilbert
#   
#   Most of the support for presenting a WebGLFramebuffer to a swap chain existed as part of the
#   mechanism for opaque WebXR framebuffer support. However, such "opaque" framebuffer are meant
#   to be opaque in the sense that their attachments can't be inspected or changed, which does
# ==============================================================================

diff -r e178aa7d969e -r f30dd1bddb47 dom/canvas/DrawTargetWebgl.h
--- a/dom/canvas/DrawTargetWebgl.h	Fri Feb 11 19:49:55 2022 +0000
+++ b/dom/canvas/DrawTargetWebgl.h	Fri Feb 11 19:49:56 2022 +0000
@@ -95,6 +95,7 @@
     SharedContext();
     ~SharedContext();
 
+    int32_t mNumTargets = 0;
     WeakPtr<DrawTargetWebgl> mCurrentTarget;
     IntSize mViewportSize;
     IntRect mClipRect;
@@ -205,7 +206,7 @@
     bool FillGlyphsAccel(ScaledFont* aFont, const GlyphBuffer& aBuffer,
                          const Pattern& aPattern, const DrawOptions& aOptions);
 
-    void PruneTextureHandle(RefPtr<TextureHandle> aHandle);
+    void PruneTextureHandle(const RefPtr<TextureHandle>& aHandle);
     bool PruneTextureMemory(size_t aMargin = 0, bool aPruneUnused = true);
 
     bool RemoveSharedTexture(const RefPtr<SharedTexture>& aTexture);
@@ -218,7 +219,7 @@
 
   RefPtr<SharedContext> mSharedContext;
 
-  static WeakPtr<SharedContext> sSharedContext;
+  static RefPtr<SharedContext> sSharedContext;
 
  public:
   DrawTargetWebgl();
@@ -332,6 +333,10 @@
   void SetTransform(const Matrix& aTransform) override;
   void* GetNativeSurface(NativeSurfaceType aType) override;
 
+  Maybe<layers::SurfaceDescriptor> GetFrontBuffer();
+
+  bool CopySnapshotTo(DrawTarget* aDT);
+
   operator std::string() const {
     std::stringstream stream;
     stream << "DrawTargetWebgl(" << this << ")";