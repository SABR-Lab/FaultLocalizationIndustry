# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/script/ModuleLoadRequest.cpp
# Commit: 0ac6d9d26e2b
# Full Hash: 0ac6d9d26e2ba97e31eb1f1a0e75d93071c2cf50
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-02-18 09:08:22
# Regressor Bug: 1742437
# File Overlap Count: 1
# Description:
#   Bug 1742437 - Split ScriptLoadRequest into ScriptLoadRequest and DOMScriptLoadContext; r=jonco,smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D134041
# ==============================================================================

diff -r 5a00e56ade15 -r 0ac6d9d26e2b dom/script/ModuleLoadRequest.cpp
--- a/dom/script/ModuleLoadRequest.cpp	Thu Feb 17 15:45:19 2022 +0000
+++ b/dom/script/ModuleLoadRequest.cpp	Thu Feb 17 15:57:48 2022 +0000
@@ -54,10 +54,13 @@
 ModuleLoadRequest* ModuleLoadRequest::CreateTopLevel(
     nsIURI* aURI, ScriptFetchOptions* aFetchOptions,
     const SRIMetadata& aIntegrity, nsIURI* aReferrer, ScriptLoader* aLoader) {
-  return new ModuleLoadRequest(
+  auto* request = new ModuleLoadRequest(
       aURI, aFetchOptions, aIntegrity, aReferrer, true, /* is top level */
       false,                                            /* is dynamic import */
       aLoader->GetModuleLoader(), NewVisitedSetForTopLevelImport(aURI));
+  DOMScriptLoadContext* context = new DOMScriptLoadContext(request);
+  request->mLoadContext = context;
+  return request;
 }
 
 /* static */
@@ -68,9 +71,11 @@
                             aParent->mURI, false, /* is top level */
                             false,                /* is dynamic import */
                             aParent->mLoader, aParent->mVisitedSet);
+  DOMScriptLoadContext* context = new DOMScriptLoadContext(request);
+  context->mIsInline = false;
+  context->mScriptMode = aParent->GetLoadContext()->mScriptMode;
 
-  request->mIsInline = false;
-  request->mScriptMode = aParent->mScriptMode;
+  request->mLoadContext = context;
 
   return request;
 }
@@ -88,8 +93,10 @@
       true, /* is dynamic import */
       aLoader->GetModuleLoader(), NewVisitedSetForTopLevelImport(aURI));
 
-  request->mIsInline = false;
-  request->mScriptMode = ScriptMode::eAsync;
+  DOMScriptLoadContext* context = new DOMScriptLoadContext(request);
+  context->mIsInline = false;
+  context->mScriptMode = DOMScriptLoadContext::ScriptMode::eAsync;
+  request->mLoadContext = context;
   request->mDynamicReferencingPrivate = aReferencingPrivate;
   request->mDynamicSpecifier = aSpecifier;
   request->mDynamicPromise = aPromise;