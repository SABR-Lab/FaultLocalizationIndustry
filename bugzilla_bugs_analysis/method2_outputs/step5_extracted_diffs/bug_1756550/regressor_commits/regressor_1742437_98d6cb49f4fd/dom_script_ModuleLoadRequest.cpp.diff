# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/script/ModuleLoadRequest.cpp
# Commit: 98d6cb49f4fd
# Full Hash: 98d6cb49f4fd30dd40b42642879b6509fc3ed12c
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-02-21 21:39:46
# Regressor Bug: 1742437
# File Overlap Count: 1
# Description:
#   Bug 1742437 - Create DOM specific Module Loader; r=jonco
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D137298
# ==============================================================================

diff -r e96ec49e3e04 -r 98d6cb49f4fd dom/script/ModuleLoadRequest.cpp
--- a/dom/script/ModuleLoadRequest.cpp	Mon Feb 21 15:39:07 2022 +0000
+++ b/dom/script/ModuleLoadRequest.cpp	Mon Feb 21 15:39:07 2022 +0000
@@ -9,14 +9,15 @@
 #include "mozilla/HoldDropJSObjects.h"
 
 #include "LoadedScript.h"
-#include "ScriptLoader.h"
+#include "ModuleLoaderBase.h"
 
 namespace mozilla {
 namespace dom {
 
 #undef LOG
-#define LOG(args) \
-  MOZ_LOG(ScriptLoader::gScriptLoaderLog, mozilla::LogLevel::Debug, args)
+#define LOG(args)                                                           \
+  MOZ_LOG(ModuleLoaderBase::gModuleLoaderBaseLog, mozilla::LogLevel::Debug, \
+          args)
 
 NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(ModuleLoadRequest)
 NS_INTERFACE_MAP_END_INHERITING(ScriptLoadRequest)
@@ -45,78 +46,18 @@
 NS_IMPL_ADDREF_INHERITED(ModuleLoadRequest, ScriptLoadRequest)
 NS_IMPL_RELEASE_INHERITED(ModuleLoadRequest, ScriptLoadRequest)
 
-static VisitedURLSet* NewVisitedSetForTopLevelImport(nsIURI* aURI) {
+/* static */
+VisitedURLSet* ModuleLoadRequest::NewVisitedSetForTopLevelImport(nsIURI* aURI) {
   auto set = new VisitedURLSet();
   set->PutEntry(aURI);
   return set;
 }
 
-/* static */
-already_AddRefed<ModuleLoadRequest> ModuleLoadRequest::CreateTopLevel(
-    nsIURI* aURI, ScriptFetchOptions* aFetchOptions,
-    const SRIMetadata& aIntegrity, nsIURI* aReferrer, ScriptLoader* aLoader,
-    DOMScriptLoadContext* aContext) {
-  RefPtr<ModuleLoadRequest> request = new ModuleLoadRequest(
-      aURI, aFetchOptions, aIntegrity, aReferrer, aContext, true,
-      /* is top level */ false, /* is dynamic import */
-      aLoader->GetModuleLoader(), NewVisitedSetForTopLevelImport(aURI),
-      nullptr);
-
-  return request.forget();
-}
-
-/* static */
-already_AddRefed<ModuleLoadRequest> ModuleLoadRequest::CreateStaticImport(
-    nsIURI* aURI, ModuleLoadRequest* aParent) {
-  RefPtr<DOMScriptLoadContext> newContext =
-      new DOMScriptLoadContext(aParent->GetLoadContext()->mElement,
-                               aParent->GetLoadContext()->mWebExtGlobal);
-  newContext->mIsInline = false;
-  // Propagated Parent values. TODO: allow child modules to use root module's
-  // script mode.
-  newContext->mScriptMode = aParent->GetLoadContext()->mScriptMode;
-
-  RefPtr<ModuleLoadRequest> request = new ModuleLoadRequest(
-      aURI, aParent->mFetchOptions, SRIMetadata(), aParent->mURI, newContext,
-      false, /* is top level */
-      false, /* is dynamic import */
-      aParent->mLoader, aParent->mVisitedSet, aParent->GetRootModule());
-
-  return request.forget();
-}
-
-/* static */
-already_AddRefed<ModuleLoadRequest> ModuleLoadRequest::CreateDynamicImport(
-    nsIURI* aURI, ScriptFetchOptions* aFetchOptions, nsIURI* aBaseURL,
-    DOMScriptLoadContext* aContext, ScriptLoader* aLoader,
-    JS::Handle<JS::Value> aReferencingPrivate, JS::Handle<JSString*> aSpecifier,
-    JS::Handle<JSObject*> aPromise) {
-  MOZ_ASSERT(aSpecifier);
-  MOZ_ASSERT(aPromise);
-
-  aContext->mIsInline = false;
-  aContext->mScriptMode = DOMScriptLoadContext::ScriptMode::eAsync;
-
-  RefPtr<ModuleLoadRequest> request = new ModuleLoadRequest(
-      aURI, aFetchOptions, SRIMetadata(), aBaseURL, aContext, true,
-      /* is top level */ true, /* is dynamic import */
-      aLoader->GetModuleLoader(), NewVisitedSetForTopLevelImport(aURI),
-      nullptr);
-
-  request->mDynamicReferencingPrivate = aReferencingPrivate;
-  request->mDynamicSpecifier = aSpecifier;
-  request->mDynamicPromise = aPromise;
-
-  HoldJSObjects(request.get());
-
-  return request.forget();
-}
-
 ModuleLoadRequest::ModuleLoadRequest(
     nsIURI* aURI, ScriptFetchOptions* aFetchOptions,
     const SRIMetadata& aIntegrity, nsIURI* aReferrer,
     DOMScriptLoadContext* aContext, bool aIsTopLevel, bool aIsDynamicImport,
-    ModuleLoader* aLoader, VisitedURLSet* aVisitedSet,
+    ModuleLoaderBase* aLoader, VisitedURLSet* aVisitedSet,
     ModuleLoadRequest* aRootModule)
     : ScriptLoadRequest(ScriptKind::eModule, aURI, aFetchOptions, aIntegrity,
                         aReferrer, aContext),