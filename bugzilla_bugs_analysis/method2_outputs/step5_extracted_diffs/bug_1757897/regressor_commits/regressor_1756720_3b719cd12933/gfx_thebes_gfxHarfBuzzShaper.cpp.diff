# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxHarfBuzzShaper.cpp
# Commit: 3b719cd12933
# Full Hash: 3b719cd1293370d843691b3656b52b04042d5ec4
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2022-03-02 04:31:47
# Regressor Bug: 1756720
# File Overlap Count: 1
# Description:
#   Bug 1756720 - When using legacy MS Symbol fonts, map character codes from the U+00xx range to the PUA range U+F0xx found in the cmap subtables. r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D139724
# ==============================================================================

diff -r 9849c6e79fa3 -r 3b719cd12933 gfx/thebes/gfxHarfBuzzShaper.cpp
--- a/gfx/thebes/gfxHarfBuzzShaper.cpp	Tue Mar 01 17:27:27 2022 +0200
+++ b/gfx/thebes/gfxHarfBuzzShaper.cpp	Tue Mar 01 15:22:56 2022 +0000
@@ -54,6 +54,7 @@
       mNumLongVMetrics(0),
       mDefaultVOrg(-1.0),
       mUseFontGetGlyph(aFont->ProvidesGetGlyph()),
+      mIsSymbolFont(false),
       mUseFontGlyphWidths(aFont->ProvidesGlyphWidths()),
       mInitialized(false),
       mVerticalInitialized(false),
@@ -114,6 +115,16 @@
   }
 
   if (!gid) {
+    if (mIsSymbolFont) {
+      // For legacy MS Symbol fonts, we try mapping the given character code
+      // to the PUA range used by these fonts' cmaps.
+      if (auto pua = gfxFontUtils::MapLegacySymbolFontCharToPUA(unicode)) {
+        gid = GetNominalGlyph(pua);
+      }
+      if (gid) {
+        return gid;
+      }
+    }
     switch (unicode) {
       case 0xA0:
         // if there's no glyph for &nbsp;, just use the space glyph instead.
@@ -1123,7 +1134,7 @@
     uint32_t len;
     const uint8_t* data = (const uint8_t*)hb_blob_get_data(mCmapTable, &len);
     mCmapFormat = gfxFontUtils::FindPreferredSubtable(
-        data, len, &mSubtableOffset, &mUVSTableOffset);
+        data, len, &mSubtableOffset, &mUVSTableOffset, &mIsSymbolFont);
     if (mCmapFormat <= 0) {
       return false;
     }