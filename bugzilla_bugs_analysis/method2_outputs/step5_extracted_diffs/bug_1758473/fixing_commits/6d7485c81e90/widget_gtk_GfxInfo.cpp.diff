# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: widget/gtk/GfxInfo.cpp
# Commit: 6d7485c81e90
# Full Hash: 6d7485c81e90e2d2e70dffc5014bcaaf34b18a87
# Author: Robert Mader <robert.mader@posteo.de>
# Date: 2022-06-21 15:52:43
# Description:
#   Bug 1758473 - Move VA-API test into glxtest, r=stransky
#   
#   Some VA-API drivers are so broken that trying to use them
#   crashes Firefox. This is nothing entirely new for GPU drivers
#   and which is why we have `glxtest`.
# ==============================================================================

diff -r 54aff5bcc909 -r 6d7485c81e90 widget/gtk/GfxInfo.cpp
--- a/widget/gtk/GfxInfo.cpp	Tue Jun 21 08:19:37 2022 +0000
+++ b/widget/gtk/GfxInfo.cpp	Tue Jun 21 08:45:27 2022 +0000
@@ -51,6 +51,7 @@
   mIsXWayland = false;
   mHasMultipleGPUs = false;
   mGlxTestError = false;
+  mIsVAAPISupported = false;
   return GfxInfoBase::Init();
 }
 
@@ -162,6 +163,7 @@
   nsCString adapterRam;
 
   nsCString drmRenderDevice;
+  nsCString isVAAPISupported;
 
   nsCString ddxDriver;
 
@@ -207,6 +209,8 @@
       stringToFill = pciDevices.AppendElement();
     } else if (!strcmp(line, "DRM_RENDERDEVICE")) {
       stringToFill = &drmRenderDevice;
+    } else if (!strcmp(line, "VAAPI_SUPPORTED")) {
+      stringToFill = &isVAAPISupported;
     } else if (!strcmp(line, "TEST_TYPE")) {
       stringToFill = &testType;
     } else if (!strcmp(line, "WARNING")) {
@@ -268,6 +272,7 @@
   }
 
   mDrmRenderDevice = std::move(drmRenderDevice);
+  mIsVAAPISupported = isVAAPISupported.Equals("TRUE");
   mTestType = std::move(testType);
 
   // Mesa always exposes itself in the GL_VERSION string, but not always the
@@ -975,6 +980,12 @@
     }
   }
 
+  if (aFeature == nsIGfxInfo::FEATURE_VAAPI && !mIsVAAPISupported) {
+    *aStatus = nsIGfxInfo::FEATURE_BLOCKED_DEVICE;
+    aFailureId = "FEATURE_FAILURE_VAAPI_TEST_FAILED";
+    return NS_OK;
+  }
+
   return GfxInfoBase::GetFeatureStatusImpl(
       aFeature, aStatus, aSuggestedDriverVersion, aDriverInfo, aFailureId, &os);
 }