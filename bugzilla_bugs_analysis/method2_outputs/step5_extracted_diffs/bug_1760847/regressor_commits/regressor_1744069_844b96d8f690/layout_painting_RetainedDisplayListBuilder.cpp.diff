# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/painting/RetainedDisplayListBuilder.cpp
# Commit: 844b96d8f690
# Full Hash: 844b96d8f690c6f0d997c1bed10c9a66c9d2ef85
# Author: Miko Mynttinen <mikokm@gmail.com>
# Date: 2022-03-14 21:49:02
# Regressor Bug: 1744069
# File Overlap Count: 1
# Description:
#   Bug 1744069 - Restore the previous behavior of merging RDL list traversal r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D140920
# ==============================================================================

diff -r 76c68029dfca -r 844b96d8f690 layout/painting/RetainedDisplayListBuilder.cpp
--- a/layout/painting/RetainedDisplayListBuilder.cpp	Mon Mar 14 12:27:48 2022 -0400
+++ b/layout/painting/RetainedDisplayListBuilder.cpp	Mon Mar 14 15:11:05 2022 +0000
@@ -203,8 +203,10 @@
       aList->mDAG.Length() ==
           (initializeOldItems ? aList->Length() : aList->mOldItems.Length()));
 
+  nsDisplayList out(Builder());
+
   size_t i = 0;
-  for (nsDisplayItem* item : aList->TakeItems()) {
+  while (nsDisplayItem* item = aList->RemoveBottom()) {
 #ifdef MOZ_DIAGNOSTIC_ASSERT_ENABLED
     item->SetMergedPreProcessed(false, true);
 #endif
@@ -341,13 +343,17 @@
       if (item->GetType() == DisplayItemType::TYPE_SUBDOCUMENT) {
         IncrementSubDocPresShellPaintCount(item);
       }
-      aList->AppendToTop(item);
+      out.AppendToTop(item);
     }
     i++;
   }
 
   MOZ_RELEASE_ASSERT(aList->mOldItems.Length() == aList->mDAG.Length());
 
+  if (aKeepLinked) {
+    aList->AppendToTop(&out);
+  }
+
   return true;
 }
 