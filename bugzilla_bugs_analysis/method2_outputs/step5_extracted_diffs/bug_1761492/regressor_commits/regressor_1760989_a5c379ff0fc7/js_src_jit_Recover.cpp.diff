# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/Recover.cpp
# Commit: a5c379ff0fc7
# Full Hash: a5c379ff0fc7bc9d64a837bd3fb42dfcac5da10c
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2022-03-24 21:54:20
# Regressor Bug: 1760989
# File Overlap Count: 1
# Description:
#   Bug 1760989 part 5 - Factor out AssertBailoutStackDepth. r=iain
#   
#   We had similar stack depth assertions in two different places. This code is now
#   deduplicated and cleaned up a bit.
#   
# ==============================================================================

diff -r efd9e8d40b4c -r a5c379ff0fc7 js/src/jit/Recover.cpp
--- a/js/src/jit/Recover.cpp	Thu Mar 24 10:08:18 2022 +0000
+++ b/js/src/jit/Recover.cpp	Thu Mar 24 10:08:19 2022 +0000
@@ -10,6 +10,7 @@
 
 #include "builtin/RegExp.h"
 #include "builtin/String.h"
+#include "jit/Bailouts.h"
 #include "jit/CompileInfo.h"
 #include "jit/Ion.h"
 #include "jit/JitSpewer.h"
@@ -68,36 +69,10 @@
 #ifdef DEBUG
   // Ensure that all snapshot which are encoded can safely be used for
   // bailouts.
-  if (GetJitContext()->cx) {
-    uint32_t stackDepth;
-    bool reachablePC;
-    jsbytecode* bailPC = pc();
-
-    if (mode() == ResumeMode::ResumeAfter) {
-      bailPC = GetNextPc(pc());
-    }
-
-    if (!ReconstructStackDepth(GetJitContext()->cx, script, bailPC, &stackDepth,
-                               &reachablePC)) {
+  if (JSContext* cx = GetJitContext()->cx) {
+    if (!AssertBailoutStackDepth(cx, script, pc(), mode(), exprStack)) {
       return false;
     }
-
-    if (reachablePC) {
-      if (mode() == ResumeMode::InlinedFunCall) {
-        // For fun.call(this, ...); the reconstructStackDepth will
-        // include the this. When inlining that is not included.  So the
-        // exprStackSlots will be one less.
-        MOZ_ASSERT(stackDepth - exprStack <= 1);
-      } else {
-        // With accessors, we have different stack depths depending on
-        // whether or not we inlined the accessor, as the inlined stack
-        // contains a callee function that should never have been there
-        // and we might just be capturing an uneventful property site,
-        // in which case there won't have been any violence.
-        MOZ_ASSERT_IF(mode() != ResumeMode::InlinedAccessor,
-                      exprStack == stackDepth);
-      }
-    }
   }
 #endif
 
