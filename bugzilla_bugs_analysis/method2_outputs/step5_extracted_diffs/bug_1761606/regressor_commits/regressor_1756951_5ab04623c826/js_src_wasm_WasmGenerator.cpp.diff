# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmGenerator.cpp
# Commit: 5ab04623c826
# Full Hash: 5ab04623c826b7f4d125fbb936754dd29af0a472
# Author: Lars T Hansen <lhansen@mozilla.com>
# Date: 2022-03-18 16:59:23
# Regressor Bug: 1756951
# File Overlap Count: 2
# Description:
#   Bug 1756951 - Part 1: Do not patch code when debugging. r=yury
#   
#   Instead of emitting a patchable call at entry/exit/breakpoints, emit a
#   conditional call to a per-instance handler that the debugger can
#   install.  The new code is larger than the code it replaces but within
# ==============================================================================

diff -r d209d5f4d95e -r 5ab04623c826 js/src/wasm/WasmGenerator.cpp
--- a/js/src/wasm/WasmGenerator.cpp	Fri Mar 18 07:20:52 2022 +0000
+++ b/js/src/wasm/WasmGenerator.cpp	Fri Mar 18 07:56:07 2022 +0000
@@ -490,6 +490,9 @@
       case CallSiteDesc::Indirect:
       case CallSiteDesc::IndirectFast:
       case CallSiteDesc::Symbolic:
+      case CallSiteDesc::Breakpoint:
+      case CallSiteDesc::EnterFrame:
+      case CallSiteDesc::LeaveFrame:
         break;
       case CallSiteDesc::Func: {
         if (funcIsCompiled(target.funcIndex())) {
@@ -526,31 +529,6 @@
         masm_.patchCall(callerOffset, p->value());
         break;
       }
-      case CallSiteDesc::Breakpoint:
-      case CallSiteDesc::EnterFrame:
-      case CallSiteDesc::LeaveFrame: {
-        Uint32Vector& jumps = metadataTier_->debugTrapFarJumpOffsets;
-        if (jumps.empty() || !InRange(jumps.back(), callerOffset)) {
-          Offsets offsets;
-          offsets.begin = masm_.currentOffset();
-          CodeOffset jumpOffset = masm_.farJumpWithPatch();
-          offsets.end = masm_.currentOffset();
-          if (masm_.oom()) {
-            return false;
-          }
-          if (!metadataTier_->codeRanges.emplaceBack(CodeRange::FarJumpIsland,
-                                                     offsets)) {
-            return false;
-          }
-          if (!debugTrapFarJumps_.emplaceBack(jumpOffset)) {
-            return false;
-          }
-          if (!jumps.emplaceBack(offsets.begin)) {
-            return false;
-          }
-        }
-        break;
-      }
     }
   }
 
@@ -953,9 +931,7 @@
                        funcCodeRange(far.funcIndex).funcUncheckedCallEntry());
   }
 
-  for (CodeOffset farJump : debugTrapFarJumps_) {
-    masm_.patchFarJump(farJump, debugTrapCodeOffset_);
-  }
+  metadataTier_->debugTrapOffset = debugTrapCodeOffset_;
 
   // None of the linking or far-jump operations should emit masm metadata.
 
@@ -1014,13 +990,6 @@
     }
   }
 
-  last = 0;
-  for (uint32_t debugTrapFarJumpOffset :
-       metadataTier_->debugTrapFarJumpOffsets) {
-    MOZ_ASSERT(debugTrapFarJumpOffset >= last);
-    last = debugTrapFarJumpOffset;
-  }
-
   // Try notes should be sorted so that the end of ranges are in rising order
   // so that the innermost catch handler is chosen.
 #  ifdef ENABLE_WASM_EXCEPTIONS
@@ -1040,7 +1009,6 @@
   metadataTier_->codeRanges.shrinkStorageToFit();
   metadataTier_->callSites.shrinkStorageToFit();
   metadataTier_->trapSites.shrinkStorageToFit();
-  metadataTier_->debugTrapFarJumpOffsets.shrinkStorageToFit();
 #ifdef ENABLE_WASM_EXCEPTIONS
   metadataTier_->tryNotes.shrinkStorageToFit();
 #endif