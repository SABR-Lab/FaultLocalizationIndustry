# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmInstance.cpp
# Commit: 5ab04623c826
# Full Hash: 5ab04623c826b7f4d125fbb936754dd29af0a472
# Author: Lars T Hansen <lhansen@mozilla.com>
# Date: 2022-03-18 16:59:23
# Regressor Bug: 1756951
# File Overlap Count: 2
# Description:
#   Bug 1756951 - Part 1: Do not patch code when debugging. r=yury
#   
#   Instead of emitting a patchable call at entry/exit/breakpoints, emit a
#   conditional call to a per-instance handler that the debugger can
#   install.  The new code is larger than the code it replaces but within
# ==============================================================================

diff -r d209d5f4d95e -r 5ab04623c826 js/src/wasm/WasmInstance.cpp
--- a/js/src/wasm/WasmInstance.cpp	Fri Mar 18 07:20:52 2022 +0000
+++ b/js/src/wasm/WasmInstance.cpp	Fri Mar 18 07:56:07 2022 +0000
@@ -1327,7 +1327,8 @@
       code_(std::move(code)),
       memory_(memory),
       tables_(std::move(tables)),
-      maybeDebug_(std::move(maybeDebug))
+      maybeDebug_(std::move(maybeDebug)),
+      debugFilter_(nullptr)
 #ifdef ENABLE_WASM_GC
       ,
       hasGcTypes_(false)
@@ -1386,6 +1387,7 @@
   valueBoxClass_ = &WasmValueBox::class_;
   resetInterrupt(cx);
   jumpTable_ = code_->tieringJumpTable();
+  debugFilter_ = nullptr;
   addressOfNeedsIncrementalBarrier_ =
       cx->compartment()->zone()->addressOfNeedsIncrementalBarrier();
 
@@ -1438,6 +1440,17 @@
   pendingExceptionTag_ = nullptr;
 #endif
 
+  // Add debug filtering table.
+  if (metadata().debugEnabled) {
+    size_t numBytes = (metadata().debugFuncReturnTypes.length() + 7) >> 3;
+    debugFilter_ = (uint32_t*)js_calloc(
+        AlignBytes(numBytes, sizeof(uint32_t)) / sizeof(uint32_t),
+        sizeof(uint32_t));
+    if (!debugFilter_) {
+      return false;
+    }
+  }
+
   // Add observer if our memory base may grow
   if (memory_ && memory_->movingGrowable() &&
       !memory_->addMovingGrowObserver(cx, object_)) {
@@ -1599,6 +1612,10 @@
     }
   }
 
+  if (debugFilter_) {
+    js_free(debugFilter_);
+  }
+
   // Any pending exceptions should have been consumed.
 #ifdef ENABLE_WASM_EXCEPTIONS
   MOZ_ASSERT(!pendingException_);
@@ -1619,6 +1636,22 @@
   stackLimit_ = cx->stackLimitForJitCode(JS::StackForUntrustedScript);
 }
 
+bool Instance::debugFilter(uint32_t funcIndex) const {
+  return (debugFilter_[funcIndex / sizeof(uint32_t)] >>
+          funcIndex % sizeof(uint32_t)) &
+         1;
+}
+
+void Instance::setDebugFilter(uint32_t funcIndex, bool value) {
+  if (value) {
+    debugFilter_[funcIndex / sizeof(uint32_t)] |=
+        (1 << funcIndex % sizeof(uint32_t));
+  } else {
+    debugFilter_[funcIndex / sizeof(uint32_t)] &=
+        ~(1 << funcIndex % sizeof(uint32_t));
+  }
+}
+
 size_t Instance::memoryMappedSize() const {
   return memory_->buffer().wasmMappedSize();
 }