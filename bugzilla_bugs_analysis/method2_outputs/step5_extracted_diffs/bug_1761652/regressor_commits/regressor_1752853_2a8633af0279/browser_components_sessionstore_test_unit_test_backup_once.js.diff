# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: browser/components/sessionstore/test/unit/test_backup_once.js
# Commit: 2a8633af0279
# Full Hash: 2a8633af0279379685ba781c6c469e8b07ec13f4
# Author: Mathew Hodson <mathew.hodson@gmail.com>
# Date: 2022-03-26 09:28:42
# Regressor Bug: 1752853
# File Overlap Count: 1
# Description:
#   Bug 1752853 - Stop using a worker to write session store. r=Gijs,Standard8
#   
#   Remove now unused pref "browser.sessionstore.max_write_failures".
#   Rename and simplify test_shutdown_cleanup.js to make it more clear that
#   it is testing the isFinalWrite option.
# ==============================================================================

diff -r dd81d58d9d5f -r 2a8633af0279 browser/components/sessionstore/test/unit/test_backup_once.js
--- a/browser/components/sessionstore/test/unit/test_backup_once.js	Fri Mar 25 19:19:15 2022 +0000
+++ b/browser/components/sessionstore/test/unit/test_backup_once.js	Fri Mar 25 19:42:36 2022 +0000
@@ -3,15 +3,16 @@
 
 "use strict";
 
-var { XPCOMUtils } = ChromeUtils.import(
-  "resource://gre/modules/XPCOMUtils.jsm"
-);
-var { SessionWorker } = ChromeUtils.import(
-  "resource:///modules/sessionstore/SessionWorker.jsm"
+const { SessionWriter } = ChromeUtils.import(
+  "resource:///modules/sessionstore/SessionWriter.jsm"
 );
 
-var Paths;
-var SessionFile;
+// Make sure that we have a profile before initializing SessionFile.
+const profd = do_get_profile();
+const { SessionFile } = ChromeUtils.import(
+  "resource:///modules/sessionstore/SessionFile.jsm"
+);
+const Paths = SessionFile.Paths;
 
 // We need a XULAppInfo to initialize SessionFile
 const { updateAppInfo } = ChromeUtils.import(
@@ -25,13 +26,6 @@
 });
 
 add_task(async function init() {
-  // Make sure that we have a profile before initializing SessionFile
-  let profd = do_get_profile();
-  SessionFile = ChromeUtils.import(
-    "resource:///modules/sessionstore/SessionFile.jsm"
-  ).SessionFile;
-  Paths = SessionFile.Paths;
-
   let source = do_get_file("data/sessionstore_valid.js");
   source.copyTo(profd, "sessionstore.js");
   await writeCompressedFile(Paths.clean.replace("jsonlz4", "js"), Paths.clean);
@@ -40,10 +34,6 @@
   await SessionFile.read();
 });
 
-var pathStore;
-var pathBackup;
-var decoder;
-
 function promise_check_exist(path, shouldExist) {
   return (async function() {
     info(
@@ -60,11 +50,11 @@
 function promise_check_contents(path, expect) {
   return (async function() {
     info("Checking whether " + path + " has the right contents");
-    let actual = await IOUtils.readUTF8(path, {
+    let actual = await IOUtils.readJSON(path, {
       decompress: true,
     });
     Assert.deepEqual(
-      JSON.parse(actual),
+      actual,
       expect,
       `File ${path} contains the expected data.`
     );
@@ -87,7 +77,7 @@
   await promise_check_exist(Paths.backups, false);
 
   await IOUtils.makeDirectory(Paths.backups);
-  await IOUtils.writeUTF8(Paths.clean, JSON.stringify(initial_content), {
+  await IOUtils.writeJSON(Paths.clean, initial_content, {
     compress: true,
   });
   await SessionFile.write(new_content);
@@ -110,10 +100,9 @@
 // - $Path.recoveryBackup contains the previous data
 add_task(async function test_second_write_no_backup() {
   let new_content = generateFileContents("test_2");
-  let previous_backup_content = await IOUtils.readUTF8(Paths.recovery, {
+  let previous_backup_content = await IOUtils.readJSON(Paths.recovery, {
     decompress: true,
   });
-  previous_backup_content = JSON.parse(previous_backup_content);
 
   await IOUtils.remove(Paths.cleanBackup);
 
@@ -137,12 +126,12 @@
   await IOUtils.writeUTF8(Paths.recovery, "I should disappear");
   await IOUtils.writeUTF8(Paths.recoveryBackup, "I should also disappear");
 
-  await SessionWorker.post("write", [
-    output,
-    { isFinalWrite: true, performShutdownCleanup: true },
-  ]);
+  await SessionWriter.write(output, {
+    isFinalWrite: true,
+    performShutdownCleanup: true,
+  });
 
-  Assert.equal(false, await IOUtils.exists(Paths.recovery));
-  Assert.equal(false, await IOUtils.exists(Paths.recoveryBackup));
+  Assert.ok(!(await IOUtils.exists(Paths.recovery)));
+  Assert.ok(!(await IOUtils.exists(Paths.recoveryBackup)));
   await promise_check_contents(Paths.clean, output);
 });