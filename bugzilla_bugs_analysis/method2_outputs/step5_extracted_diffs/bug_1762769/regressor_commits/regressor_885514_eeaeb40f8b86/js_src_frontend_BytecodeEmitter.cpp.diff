# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/frontend/BytecodeEmitter.cpp
# Commit: eeaeb40f8b86
# Full Hash: eeaeb40f8b869121eff65b1c2d11af423c9a9ecc
# Author: Iain Ireland <iireland@mozilla.com>
# Date: 2022-03-09 09:44:44
# Regressor Bug: 885514
# File Overlap Count: 1
# Description:
#   Bug 885514: Simplify JSOp::Retsub r=jandem
#   
#   Currently, JSOp::Retsub takes two arguments, and uses one to decide whether to throw the second or use it as a resume index. This patch splits out the exception-handling logic into explicit bytecode, leaving JSOp::Retsub as a simple indirect jump.
#   
#   To make the generated bytecode work out nicely, I've swapped the order of the arguments: now `throwing` is on top, and the exception/resumeindex argument is underneath it.
# ==============================================================================

diff -r 1cb0b352b024 -r eeaeb40f8b86 js/src/frontend/BytecodeEmitter.cpp
--- a/js/src/frontend/BytecodeEmitter.cpp	Tue Mar 08 21:10:22 2022 +0000
+++ b/js/src/frontend/BytecodeEmitter.cpp	Tue Mar 08 21:10:22 2022 +0000
@@ -783,7 +783,7 @@
         TryFinallyControl& finallyControl = control->as<TryFinallyControl>();
         if (finallyControl.emittingSubroutine()) {
           /*
-           * There's a [exception or hole, retsub pc-index] pair and the
+           * There's a [resume-index-or-exception, throwing] pair and the
            * possible return value on the stack that we need to pop.
            */
           npops += 3;
@@ -5052,8 +5052,8 @@
 [[nodiscard]] bool BytecodeEmitter::emitJumpToFinally(JumpList* jump) {
   // Emit the following:
   //
+  //     ResumeIndex <resumeIndex>
   //     False
-  //     ResumeIndex <resumeIndex>
   //     Goto <target>
   //   resumeOffset:
   //     JumpTarget
@@ -5061,15 +5061,15 @@
   // The order is important: the Baseline Interpreter relies on JSOp::JumpTarget
   // setting the frame's ICEntry when resuming at resumeOffset.
 
-  if (!emit1(JSOp::False)) {
-    return false;
-  }
-
   BytecodeOffset off;
   if (!emitN(JSOp::ResumeIndex, 3, &off)) {
     return false;
   }
 
+  if (!emit1(JSOp::False)) {
+    return false;
+  }
+
   if (!emitJumpNoFallthrough(JSOp::Goto, jump)) {
     return false;
   }