# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/Opcodes.h
# Commit: eeaeb40f8b86
# Full Hash: eeaeb40f8b869121eff65b1c2d11af423c9a9ecc
# Author: Iain Ireland <iireland@mozilla.com>
# Date: 2022-03-09 09:44:44
# Regressor Bug: 885514
# File Overlap Count: 1
# Description:
#   Bug 885514: Simplify JSOp::Retsub r=jandem
#   
#   Currently, JSOp::Retsub takes two arguments, and uses one to decide whether to throw the second or use it as a resume index. This patch splits out the exception-handling logic into explicit bytecode, leaving JSOp::Retsub as a simple indirect jump.
#   
#   To make the generated bytecode work out nicely, I've swapped the order of the arguments: now `throwing` is on top, and the exception/resumeindex argument is underneath it.
# ==============================================================================

diff -r 1cb0b352b024 -r eeaeb40f8b86 js/src/vm/Opcodes.h
--- a/js/src/vm/Opcodes.h	Tue Mar 08 21:10:22 2022 +0000
+++ b/js/src/vm/Opcodes.h	Tue Mar 08 21:10:22 2022 +0000
@@ -2632,6 +2632,9 @@
      *
      * This value must be used only by `JSOp::Retsub`.
      *
+     * The stack depth when retsub resumes at the given offset must
+     * agree with any other paths to that offset.
+     *
      *   Category: Control flow
      *   Type: Exceptions
      *   Operands: uint24_t resumeIndex
@@ -2648,21 +2651,19 @@
      */ \
     MACRO(Finally, finally, NULL, 1, 0, 0, JOF_BYTE) \
     /*
-     * Jump back to the next instruction, or rethrow an exception, at the end
-     * of a `finally` block. See `JSOp::Gosub` for the explanation.
-     *
-     * If `throwing` is true, throw `v`. Otherwise, `v` must be a resume index;
-     * jump to the corresponding offset within the script.
-     *
-     * The two values popped must be the ones notionally pushed by
-     * `JSOp::Finally`.
+     * Jump to the instruction at the offset given by
+     * `script->resumeOffsets(resumeIndex)`, in bytes from the start of the
+     * current script's bytecode.
+     *
+     * This is used at the end of finally blocks to jump to the correct
+     * continuation.
      *
      *   Category: Control flow
      *   Type: Exceptions
      *   Operands:
-     *   Stack: throwing, v =>
+     *   Stack: resumeIndex =>
      */ \
-    MACRO(Retsub, retsub, NULL, 1, 2, 0, JOF_BYTE) \
+    MACRO(Retsub, retsub, NULL, 1, 1, 0, JOF_BYTE) \
     /*
      * Push `MagicValue(JS_UNINITIALIZED_LEXICAL)`, a magic value used to mark
      * a binding as uninitialized.
