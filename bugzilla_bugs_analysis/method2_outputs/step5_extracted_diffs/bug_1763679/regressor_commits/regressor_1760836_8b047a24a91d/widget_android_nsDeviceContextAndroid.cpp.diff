# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/android/nsDeviceContextAndroid.cpp
# Commit: 8b047a24a91d
# Full Hash: 8b047a24a91df99818fd01165b6b00d05258a3d4
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-03-31 09:35:41
# Regressor Bug: 1760836
# File Overlap Count: 1
# Description:
#   Bug 1760836 - Support printing to an nsIOutputStream. r=jfkthame,jrmuizel,webdriver-reviewers,geckoview-reviewers,agi
#   
#   The trickiest bits are the PrintTargetCG ones, the rest is just plumbing
#   and cleanups and tests, but let me know if you want those to be split
#   out, can do.
# ==============================================================================

diff -r a04583558158 -r 8b047a24a91d widget/android/nsDeviceContextAndroid.cpp
--- a/widget/android/nsDeviceContextAndroid.cpp	Wed Mar 30 18:46:53 2022 +0000
+++ b/widget/android/nsDeviceContextAndroid.cpp	Wed Mar 30 18:51:58 2022 +0000
@@ -11,32 +11,50 @@
 #include "nsIFile.h"
 #include "nsIFileStreams.h"
 #include "nsIPrintSettings.h"
+#include "nsIFileStreams.h"
 #include "nsDirectoryServiceDefs.h"
+#include "nsAnonymousTemporaryFile.h"
 
 using namespace mozilla;
 using namespace mozilla::gfx;
 
 NS_IMPL_ISUPPORTS(nsDeviceContextSpecAndroid, nsIDeviceContextSpec)
 
-already_AddRefed<PrintTarget> nsDeviceContextSpecAndroid::MakePrintTarget() {
-  nsresult rv =
-      NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(mTempFile));
-  NS_ENSURE_SUCCESS(rv, nullptr);
+nsDeviceContextSpecAndroid::~nsDeviceContextSpecAndroid() {
+  if (mTempFile) {
+    mTempFile->Remove(false);
+  }
+}
 
-  nsAutoCString filename("tmp-printing.pdf");
-  mTempFile->AppendNative(filename);
-  rv = mTempFile->CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0660);
-  NS_ENSURE_SUCCESS(rv, nullptr);
+already_AddRefed<PrintTarget> nsDeviceContextSpecAndroid::MakePrintTarget() {
+  double width, height;
+  mPrintSettings->GetEffectiveSheetSize(&width, &height);
+
+  // convert twips to points
+  width /= TWIPS_PER_POINT_FLOAT;
+  height /= TWIPS_PER_POINT_FLOAT;
 
-  nsCOMPtr<nsIFileOutputStream> stream =
-      do_CreateInstance("@mozilla.org/network/file-output-stream;1");
-  rv = stream->Init(mTempFile, -1, -1, 0);
-  NS_ENSURE_SUCCESS(rv, nullptr);
+  auto stream = [&]() -> nsCOMPtr<nsIOutputStream> {
+    if (mPrintSettings->GetOutputDestination() ==
+        nsIPrintSettings::kOutputDestinationStream) {
+      nsCOMPtr<nsIOutputStream> out;
+      mPrintSettings->GetOutputStream(getter_AddRefs(out));
+      return out;
+    }
+    if (NS_FAILED(
+            NS_OpenAnonymousTemporaryNsIFile(getter_AddRefs(mTempFile)))) {
+      return nullptr;
+    }
+    // Print to printer not supported...
+    nsCOMPtr<nsIFileOutputStream> s =
+        do_CreateInstance("@mozilla.org/network/file-output-stream;1");
+    if (NS_FAILED(s->Init(mTempFile, -1, -1, 0))) {
+      return nullptr;
+    }
+    return s;
+  }();
 
-  // XXX: what should we do here for size? screen size?
-  IntSize size(480, 800);
-
-  return PrintTargetPDF::CreateOrNull(stream, size);
+  return PrintTargetPDF::CreateOrNull(stream, IntSize::Ceil(width, height));
 }
 
 NS_IMETHODIMP
@@ -56,24 +74,23 @@
 
 NS_IMETHODIMP
 nsDeviceContextSpecAndroid::EndDocument() {
-  nsString targetPath;
-  nsCOMPtr<nsIFile> destFile;
-  mPrintSettings->GetToFileName(targetPath);
-
-  nsresult rv = NS_NewLocalFile(targetPath, false, getter_AddRefs(destFile));
-  NS_ENSURE_SUCCESS(rv, rv);
+  if (mPrintSettings->GetOutputDestination() ==
+          nsIPrintSettings::kOutputDestinationFile &&
+      mTempFile) {
+    nsAutoString targetPath;
+    mPrintSettings->GetToFileName(targetPath);
+    nsCOMPtr<nsIFile> destFile;
+    MOZ_TRY(NS_NewLocalFile(targetPath, false, getter_AddRefs(destFile)));
+    nsAutoString destLeafName;
+    MOZ_TRY(destFile->GetLeafName(destLeafName));
 
-  nsAutoString destLeafName;
-  rv = destFile->GetLeafName(destLeafName);
-  NS_ENSURE_SUCCESS(rv, rv);
+    nsCOMPtr<nsIFile> destDir;
+    MOZ_TRY(destFile->GetParent(getter_AddRefs(destDir)));
 
-  nsCOMPtr<nsIFile> destDir;
-  rv = destFile->GetParent(getter_AddRefs(destDir));
-  NS_ENSURE_SUCCESS(rv, rv);
+    MOZ_TRY(mTempFile->MoveTo(destDir, destLeafName));
+    destFile->SetPermissions(0666);
 
-  rv = mTempFile->MoveTo(destDir, destLeafName);
-  NS_ENSURE_SUCCESS(rv, rv);
-
-  destFile->SetPermissions(0666);
+    mTempFile = nullptr;
+  }
   return NS_OK;
 }