# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/nsPrintSettingsService.cpp
# Commit: 8b047a24a91d
# Full Hash: 8b047a24a91df99818fd01165b6b00d05258a3d4
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-03-31 09:35:41
# Regressor Bug: 1760836
# File Overlap Count: 1
# Description:
#   Bug 1760836 - Support printing to an nsIOutputStream. r=jfkthame,jrmuizel,webdriver-reviewers,geckoview-reviewers,agi
#   
#   The trickiest bits are the PrintTargetCG ones, the rest is just plumbing
#   and cleanups and tests, but let me know if you want those to be split
#   out, can do.
# ==============================================================================

diff -r a04583558158 -r 8b047a24a91d widget/nsPrintSettingsService.cpp
--- a/widget/nsPrintSettingsService.cpp	Wed Mar 30 18:46:53 2022 +0000
+++ b/widget/nsPrintSettingsService.cpp	Wed Mar 30 18:51:58 2022 +0000
@@ -154,14 +154,15 @@
 
   aSettings->GetPrinterName(data->printerName());
 
-  aSettings->GetPrintToFile(&data->printToFile());
+  data->outputDestination() = aSettings->GetOutputDestination();
 
   aSettings->GetToFileName(data->toFileName());
 
-  aSettings->GetOutputFormat(&data->outputFormat());
-  aSettings->GetPrintPageDelay(&data->printPageDelay());
-  aSettings->GetResolution(&data->resolution());
-  aSettings->GetDuplex(&data->duplex());
+  data->outputFormat() = aSettings->GetOutputFormat();
+  data->printPageDelay() = aSettings->GetPrintPageDelay();
+  data->resolution() = aSettings->GetResolution();
+  data->duplex() = aSettings->GetDuplex();
+
   aSettings->GetIsInitializedFromPrinter(&data->isInitializedFromPrinter());
   aSettings->GetIsInitializedFromPrefs(&data->isInitializedFromPrefs());
 
@@ -241,11 +242,11 @@
   settings->SetNumCopies(data.numCopies());
   settings->SetNumPagesPerSheet(data.numPagesPerSheet());
 
+  settings->SetOutputDestination(
+      nsIPrintSettings::OutputDestinationType(data.outputDestination()));
   settings->SetPrinterName(data.printerName());
-
-  settings->SetPrintToFile(data.printToFile());
-
   settings->SetToFileName(data.toFileName());
+  // Output stream intentionally unset, child processes shouldn't care about it.
 
   settings->SetOutputFormat(data.outputFormat());
   settings->SetPrintPageDelay(data.printPageDelay());
@@ -524,7 +525,9 @@
 
   if (aFlags & nsIPrintSettings::kInitSavePrintToFile) {
     if (GETBOOLPREF(kPrintToFile, &b)) {
-      aPS->SetPrintToFile(b);
+      aPS->SetOutputDestination(
+          b ? nsIPrintSettings::kOutputDestinationFile
+            : nsIPrintSettings::kOutputDestinationPrinter);
       noValidPrefsFound = false;
     }
   }
@@ -740,9 +743,9 @@
   }
 
   if (aFlags & nsIPrintSettings::kInitSavePrintToFile) {
-    if (NS_SUCCEEDED(aPS->GetPrintToFile(&b))) {
-      Preferences::SetBool(GetPrefName(kPrintToFile, aPrinterName), b);
-    }
+    Preferences::SetBool(GetPrefName(kPrintToFile, aPrinterName),
+                         aPS->GetOutputDestination() ==
+                             nsIPrintSettings::kOutputDestinationFile);
   }
 
   if (aFlags & nsIPrintSettings::kInitSaveToFileName) {