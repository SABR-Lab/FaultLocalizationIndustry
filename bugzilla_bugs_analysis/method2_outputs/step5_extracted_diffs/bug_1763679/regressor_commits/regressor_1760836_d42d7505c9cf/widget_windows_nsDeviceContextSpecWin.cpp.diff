# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/nsDeviceContextSpecWin.cpp
# Commit: d42d7505c9cf
# Full Hash: d42d7505c9cf4b0a2f3bae83a007928fee2b596d
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-03-30 03:54:32
# Regressor Bug: 1760836
# File Overlap Count: 1
# Description:
#   Bug 1760836 - Support printing to an nsIOutputStream. r=jfkthame,jrmuizel,webdriver-reviewers,geckoview-reviewers,agi
#   
#   The trickiest bits are the PrintTargetCG ones, the rest is just plumbing
#   and cleanups and tests, but let me know if you want those to be split
#   out, can do.
# ==============================================================================

diff -r 99efc2e54ea0 -r d42d7505c9cf widget/windows/nsDeviceContextSpecWin.cpp
--- a/widget/windows/nsDeviceContextSpecWin.cpp	Tue Mar 29 17:24:11 2022 +0000
+++ b/widget/windows/nsDeviceContextSpecWin.cpp	Tue Mar 29 17:50:58 2022 +0000
@@ -111,7 +111,7 @@
   // Get the Printer Name to be used and output format.
   nsAutoString printerName;
   if (mPrintSettings) {
-    mPrintSettings->GetOutputFormat(&mOutputFormat);
+    mOutputFormat = mPrintSettings->GetOutputFormat();
     mPrintSettings->GetPrinterName(printerName);
   }
 
@@ -272,9 +272,6 @@
 #endif
 
   if (mOutputFormat == nsIPrintSettings::kOutputFormatPDF) {
-    nsString filename;
-    mPrintSettings->GetToFileName(filename);
-
     double width, height;
     mPrintSettings->GetEffectiveSheetSize(&width, &height);
     if (width <= 0 || height <= 0) {
@@ -285,26 +282,37 @@
     width /= TWIPS_PER_POINT_FLOAT;
     height /= TWIPS_PER_POINT_FLOAT;
 
-    nsCOMPtr<nsIFile> file;
-    nsresult rv;
-    if (!filename.IsEmpty()) {
-      file = do_CreateInstance("@mozilla.org/file/local;1");
-      rv = file->InitWithPath(filename);
-    } else {
-      rv = NS_OpenAnonymousTemporaryNsIFile(getter_AddRefs(mTempFile));
-      file = mTempFile;
-    }
+    auto stream = [&]() -> nsCOMPtr<nsIOutputStream> {
+      if (mPrintSettings->GetOutputDestination() ==
+          nsIPrintSettings::kOutputDestinationStream) {
+        nsCOMPtr<nsIOutputStream> out;
+        mPrintSettings->GetOutputStream(getter_AddRefs(out));
+        return out;
+      }
+      nsAutoString filename;
+      mPrintSettings->GetToFileName(filename);
 
-    if (NS_WARN_IF(NS_FAILED(rv))) {
-      return nullptr;
-    }
+      nsCOMPtr<nsIFile> file;
+      nsresult rv;
+      if (!filename.IsEmpty()) {
+        file = do_CreateInstance("@mozilla.org/file/local;1");
+        rv = file->InitWithPath(filename);
+      } else {
+        rv = NS_OpenAnonymousTemporaryNsIFile(getter_AddRefs(mTempFile));
+        file = mTempFile;
+      }
 
-    nsCOMPtr<nsIFileOutputStream> stream =
-        do_CreateInstance("@mozilla.org/network/file-output-stream;1");
-    rv = stream->Init(file, -1, -1, 0);
-    if (NS_FAILED(rv)) {
-      return nullptr;
-    }
+      if (NS_WARN_IF(NS_FAILED(rv))) {
+        return nullptr;
+      }
+
+      nsCOMPtr<nsIFileOutputStream> stream =
+          do_CreateInstance("@mozilla.org/network/file-output-stream;1");
+      if (NS_FAILED(stream->Init(file, -1, -1, 0))) {
+        return nullptr;
+      }
+      return stream;
+    }();
 
     return PrintTargetPDF::CreateOrNull(stream, IntSize::Ceil(width, height));
   }
@@ -606,8 +614,7 @@
   }
 
   // When printing to PDF on Windows there is no associated printer driver.
-  int16_t outputFormat;
-  aPrintSettings->GetOutputFormat(&outputFormat);
+  int16_t outputFormat = aPrintSettings->GetOutputFormat();
   if (outputFormat == nsIPrintSettings::kOutputFormatPDF) {
     return NS_OK;
   }