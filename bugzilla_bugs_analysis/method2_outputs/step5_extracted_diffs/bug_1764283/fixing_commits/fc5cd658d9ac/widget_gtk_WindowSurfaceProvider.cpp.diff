# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: widget/gtk/WindowSurfaceProvider.cpp
# Commit: fc5cd658d9ac
# Full Hash: fc5cd658d9acdeb29486d8e35025d274d0529ebc
# Author: stransky <stransky@redhat.com>
# Date: 2022-04-14 16:04:28
# Description:
#   Bug 1764283 [Wayland] Don't commit to MozContainer when WindowSurfaceProvider internals are released r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D143602
# ==============================================================================

diff -r c11504cea272 -r fc5cd658d9ac widget/gtk/WindowSurfaceProvider.cpp
--- a/widget/gtk/WindowSurfaceProvider.cpp	Thu Apr 14 05:38:36 2022 +0000
+++ b/widget/gtk/WindowSurfaceProvider.cpp	Thu Apr 14 06:14:45 2022 +0000
@@ -161,28 +161,36 @@
 
 void WindowSurfaceProvider::EndRemoteDrawingInRegion(
     gfx::DrawTarget* aDrawTarget, const LayoutDeviceIntRegion& aInvalidRegion) {
-#if defined(MOZ_WAYLAND)
-  if (GdkIsWaylandDisplay() && moz_container_wayland_is_commiting_to_parent(
-                                   mWidget->GetMozContainer())) {
-    // If we're drawing directly to wl_surface owned by Gtk we need to use it
-    // in main thread to sync with Gtk access to it.
-    NS_DispatchToMainThread(NS_NewRunnableFunction(
-        "WindowSurfaceProvider::EndRemoteDrawingInRegion",
-        [RefPtr{mWidget}, this, aInvalidRegion]() {
-          MutexAutoLock lock(mMutex);
-          // Commit to mWindowSurface only when we have a valid one.
-          if (mWindowSurface && mWindowSurfaceValid) {
-            mWindowSurface->Commit(aInvalidRegion);
-          }
-        }));
+  MutexAutoLock lock(mMutex);
+  // Commit to mWindowSurface only if we have a valid one.
+  if (!mWindowSurface || !mWindowSurfaceValid) {
     return;
   }
+#if defined(MOZ_WAYLAND)
+  if (GdkIsWaylandDisplay()) {
+    // We're called too early or we're unmapped.
+    // Don't draw anything.
+    if (!mWidget) {
+      return;
+    }
+    if (moz_container_wayland_is_commiting_to_parent(
+            mWidget->GetMozContainer())) {
+      // If we're drawing directly to wl_surface owned by Gtk we need to use it
+      // in main thread to sync with Gtk access to it.
+      NS_DispatchToMainThread(NS_NewRunnableFunction(
+          "WindowSurfaceProvider::EndRemoteDrawingInRegion",
+          [RefPtr{mWidget}, this, aInvalidRegion]() {
+            MutexAutoLock lock(mMutex);
+            // Commit to mWindowSurface only when we have a valid one.
+            if (mWindowSurface && mWindowSurfaceValid) {
+              mWindowSurface->Commit(aInvalidRegion);
+            }
+          }));
+      return;
+    }
+  }
 #endif
-  MutexAutoLock lock(mMutex);
-  // Commit to mWindowSurface only when we have a valid one.
-  if (mWindowSurface && mWindowSurfaceValid) {
-    mWindowSurface->Commit(aInvalidRegion);
-  }
+  mWindowSurface->Commit(aInvalidRegion);
 }
 
 }  // namespace widget
