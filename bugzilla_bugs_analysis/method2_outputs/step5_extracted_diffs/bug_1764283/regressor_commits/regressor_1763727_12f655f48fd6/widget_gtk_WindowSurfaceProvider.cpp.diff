# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/WindowSurfaceProvider.cpp
# Commit: 12f655f48fd6
# Full Hash: 12f655f48fd64f156651ad4023f6bf92f67d72fc
# Author: stransky <stransky@redhat.com>
# Date: 2022-04-11 21:59:38
# Regressor Bug: 1763727
# File Overlap Count: 1
# Description:
#   Bug 1763727 [Wayland] Paint to Gtk owned wl_surface in main thread r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D143266
# ==============================================================================

diff -r 867aa298cbb3 -r 12f655f48fd6 widget/gtk/WindowSurfaceProvider.cpp
--- a/widget/gtk/WindowSurfaceProvider.cpp	Mon Apr 11 12:17:42 2022 +0000
+++ b/widget/gtk/WindowSurfaceProvider.cpp	Mon Apr 11 12:56:26 2022 +0000
@@ -161,6 +161,23 @@
 
 void WindowSurfaceProvider::EndRemoteDrawingInRegion(
     gfx::DrawTarget* aDrawTarget, const LayoutDeviceIntRegion& aInvalidRegion) {
+#if defined(MOZ_WAYLAND)
+  if (GdkIsWaylandDisplay() && moz_container_wayland_is_commiting_to_parent(
+                                   mWidget->GetMozContainer())) {
+    // If we're drawing directly to wl_surface owned by Gtk we need to use it
+    // in main thread to sync with Gtk access to it.
+    NS_DispatchToMainThread(NS_NewRunnableFunction(
+        "WindowSurfaceProvider::EndRemoteDrawingInRegion",
+        [RefPtr{mWidget}, this, aInvalidRegion]() {
+          MutexAutoLock lock(mMutex);
+          // Commit to mWindowSurface only when we have a valid one.
+          if (mWindowSurface && mWindowSurfaceValid) {
+            mWindowSurface->Commit(aInvalidRegion);
+          }
+        }));
+    return;
+  }
+#endif
   MutexAutoLock lock(mMutex);
   // Commit to mWindowSurface only when we have a valid one.
   if (mWindowSurface && mWindowSurfaceValid) {
