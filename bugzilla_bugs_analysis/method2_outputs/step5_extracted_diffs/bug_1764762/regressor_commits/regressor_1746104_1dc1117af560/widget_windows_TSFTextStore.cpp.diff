# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/TSFTextStore.cpp
# Commit: 1dc1117af560
# Full Hash: 1dc1117af56039488e28d5770e6379d1d89f4d19
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-02-08 17:32:27
# Regressor Bug: 1746104
# File Overlap Count: 1
# Description:
#   Bug 1746104 - part 1-4: Make `TSFTextStore` handle the no selection case r=m_kato
#   
#   Most change has already been done in part 1-2.  This patch does the remaining
#   work.
#   
# ==============================================================================

diff -r 1971c9f47541 -r 1dc1117af560 widget/windows/TSFTextStore.cpp
--- a/widget/windows/TSFTextStore.cpp	Mon Feb 07 22:33:31 2022 +0000
+++ b/widget/windows/TSFTextStore.cpp	Mon Feb 07 22:33:32 2022 +0000
@@ -2930,15 +2930,10 @@
                                                    mWidget);
     mWidget->InitEvent(querySelectedTextEvent);
     DispatchEvent(querySelectedTextEvent);
-    if (NS_WARN_IF(querySelectedTextEvent.DidNotFindSelection())) {
+    if (NS_WARN_IF(querySelectedTextEvent.Failed())) {
       return mSelectionForTSF;
     }
-    MOZ_ASSERT(querySelectedTextEvent.mReply->mOffsetAndData.isSome());
-    mSelectionForTSF =
-        Some(Selection(querySelectedTextEvent.mReply->StartOffset(),
-                       querySelectedTextEvent.mReply->DataLength(),
-                       querySelectedTextEvent.mReply->mReversed,
-                       querySelectedTextEvent.mReply->WritingModeRef()));
+    mSelectionForTSF = Some(Selection(querySelectedTextEvent));
   }
 
   MOZ_LOG(gIMELog, LogLevel::Debug,