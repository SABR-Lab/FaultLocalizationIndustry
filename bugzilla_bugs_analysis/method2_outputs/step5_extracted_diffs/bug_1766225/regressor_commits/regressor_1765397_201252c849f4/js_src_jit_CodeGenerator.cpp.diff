# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/CodeGenerator.cpp
# Commit: 201252c849f4
# Full Hash: 201252c849f427b49422fffea6ca65e36cdade1d
# Author: Andr√© Bargull <andre.bargull@gmail.com>
# Date: 2022-04-21 15:23:18
# Regressor Bug: 1765397
# File Overlap Count: 1
# Description:
#   Bug 1765397 - Part 7: Optimise slice when no end-index is present. r=iain
#   
#   This is the case which actually happens in practice and we should aim to
#   provide support for.
#   
# ==============================================================================

diff -r 257207e109b2 -r 201252c849f4 js/src/jit/CodeGenerator.cpp
--- a/js/src/jit/CodeGenerator.cpp	Thu Apr 21 08:45:47 2022 +0000
+++ b/js/src/jit/CodeGenerator.cpp	Thu Apr 21 08:45:47 2022 +0000
@@ -12094,25 +12094,40 @@
     masm.movePtr(ImmPtr(nullptr), temp2);
   }
 
-  // Compute actuals() + numFormals.
   size_t actualsOffset = frameSize() + JitFrameLayout::offsetOfActualArgs();
   masm.moveStackPtrTo(temp1);
-  masm.addPtr(Imm32(sizeof(Value) * numFormals + actualsOffset), temp1);
 
   // Compute numActuals - numFormals.
-  Label emptyLength, joinLength;
-  masm.movePtr(numActuals, temp0);
-  masm.branch32(Assembler::LessThanOrEqual, temp0, Imm32(numFormals),
-                &emptyLength);
-  {
-    masm.sub32(Imm32(numFormals), temp0);
-    masm.jump(&joinLength);
-  }
-  {
+  if (numFormals) {
+    Label emptyLength, joinLength;
+    masm.movePtr(numActuals, temp0);
+    masm.branch32(Assembler::LessThanOrEqual, temp0, Imm32(numFormals),
+                  &emptyLength);
+    {
+      masm.sub32(Imm32(numFormals), temp0);
+
+      // Compute actuals() + numFormals.
+      masm.addPtr(Imm32(sizeof(Value) * numFormals + actualsOffset), temp1);
+
+      masm.jump(&joinLength);
+    }
     masm.bind(&emptyLength);
-    masm.move32(Imm32(0), temp0);
-  }
-  masm.bind(&joinLength);
+    {
+      masm.move32(Imm32(0), temp0);
+
+      // Point to the start of actuals() when the rest-array length is zero. We
+      // don't use |actuals() + numFormals| because |numFormals| can be any
+      // non-negative int32 value when this MRest was created from scalar
+      // replacement optimizations. And it seems questionable to compute a
+      // Value* pointer which points to who knows where.
+      masm.addPtr(Imm32(actualsOffset), temp1);
+    }
+    masm.bind(&joinLength);
+  } else {
+    // Directly compute both values when there are no formals.
+    masm.addPtr(Imm32(actualsOffset), temp1);
+    masm.move32(numActuals, temp0);
+  }
 
   pushArg(temp2);
   pushArg(temp1);