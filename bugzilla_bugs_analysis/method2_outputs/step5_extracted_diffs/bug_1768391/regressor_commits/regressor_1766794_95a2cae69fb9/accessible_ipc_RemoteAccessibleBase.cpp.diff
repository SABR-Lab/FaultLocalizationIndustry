# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/ipc/RemoteAccessibleBase.cpp
# Commit: 95a2cae69fb9
# Full Hash: 95a2cae69fb9d3763a8a8aba8beba2a78fdd570b
# Author: James Teh <jteh@mozilla.com>
# Date: 2022-05-05 16:11:56
# Regressor Bug: 1766794
# File Overlap Count: 2
# Description:
#   Bug 1766794: Lazily cache HyperText offsets for RemoteAccessibles. r=eeejay
#   
#   We already had a similar cache in local HyperTextAccessible.
#   This improves performance significantly when walking the text attributes of a container with a large number of text leaf children, such as is encountered when using view source.
#   This patch unifies that cache across local and remote.
# ==============================================================================

diff -r 3f8a611b454e -r 95a2cae69fb9 accessible/ipc/RemoteAccessibleBase.cpp
--- a/accessible/ipc/RemoteAccessibleBase.cpp	Thu May 05 10:56:32 2022 +0000
+++ b/accessible/ipc/RemoteAccessibleBase.cpp	Thu May 05 11:14:12 2022 +0000
@@ -13,6 +13,7 @@
 #include "mozilla/a11y/RemoteAccessibleBase.h"
 #include "mozilla/a11y/RemoteAccessible.h"
 #include "mozilla/a11y/Role.h"
+#include "mozilla/BinarySearch.h"
 #include "mozilla/dom/Element.h"
 #include "mozilla/dom/BrowserParent.h"
 #include "mozilla/dom/CanonicalBrowsingContext.h"
@@ -1013,6 +1014,25 @@
   return false;
 }
 
+template <class Derived>
+const nsTArray<int32_t>&
+RemoteAccessibleBase<Derived>::GetCachedHyperTextOffsets() const {
+  if (mCachedFields) {
+    if (auto offsets =
+            mCachedFields->GetAttribute<nsTArray<int32_t>>(nsGkAtoms::offset)) {
+      return *offsets;
+    }
+  }
+  nsTArray<int32_t> newOffsets;
+  BuildCachedHyperTextOffsets(newOffsets);
+  if (!mCachedFields) {
+    const_cast<RemoteAccessibleBase<Derived>*>(this)->mCachedFields =
+        new AccAttributes();
+  }
+  mCachedFields->SetAttribute(nsGkAtoms::offset, std::move(newOffsets));
+  return *mCachedFields->GetAttribute<nsTArray<int32_t>>(nsGkAtoms::offset);
+}
+
 template class RemoteAccessibleBase<RemoteAccessible>;
 
 }  // namespace a11y