# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/ipc/RemoteAccessibleBase.cpp
# Commit: e488a2686d0b
# Full Hash: e488a2686d0b6354c723dd896c6ce20749c8b3d7
# Author: James Teh <jteh@mozilla.com>
# Date: 2022-12-06 03:46:09
# Regressor Bug: 1766794
# File Overlap Count: 1
# Description:
#   Bug 1802268 part 2: Reinstate partial invalidation of cached HyperText offsets for local HyperTextAccessible. r=eeejay
#   
#   In bug 1766794, I replaced partial invalidation of cached offsets with full cache invalidation.
#   I did this to simplify the code, since the offsets cache was being extended to RemoteAccessible.
#   This is fine for RemoteAccessible because offsets are only needed there when clients query them.
# ==============================================================================

diff -r 80097f40fc50 -r e488a2686d0b accessible/ipc/RemoteAccessibleBase.cpp
--- a/accessible/ipc/RemoteAccessibleBase.cpp	Mon Dec 05 23:27:23 2022 +0000
+++ b/accessible/ipc/RemoteAccessibleBase.cpp	Mon Dec 05 23:27:24 2022 +0000
@@ -1731,22 +1731,20 @@
 }
 
 template <class Derived>
-const nsTArray<int32_t>&
-RemoteAccessibleBase<Derived>::GetCachedHyperTextOffsets() const {
+nsTArray<int32_t>& RemoteAccessibleBase<Derived>::GetCachedHyperTextOffsets() {
   if (mCachedFields) {
-    if (auto offsets =
-            mCachedFields->GetAttribute<nsTArray<int32_t>>(nsGkAtoms::offset)) {
+    if (auto offsets = mCachedFields->GetMutableAttribute<nsTArray<int32_t>>(
+            nsGkAtoms::offset)) {
       return *offsets;
     }
   }
   nsTArray<int32_t> newOffsets;
-  BuildCachedHyperTextOffsets(newOffsets);
   if (!mCachedFields) {
-    const_cast<RemoteAccessibleBase<Derived>*>(this)->mCachedFields =
-        new AccAttributes();
+    mCachedFields = new AccAttributes();
   }
   mCachedFields->SetAttribute(nsGkAtoms::offset, std::move(newOffsets));
-  return *mCachedFields->GetAttribute<nsTArray<int32_t>>(nsGkAtoms::offset);
+  return *mCachedFields->GetMutableAttribute<nsTArray<int32_t>>(
+      nsGkAtoms::offset);
 }
 
 template <class Derived>