# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/printing/nsPrintJob.cpp
# Commit: f907e3b915ed
# Full Hash: f907e3b915ede8be7e3efc8888ea26fb095a331e
# Author: Jonathan Watt <jwatt@jwatt.org>
# Date: 2022-05-23 09:52:44
# Regressor Bug: 1770539
# File Overlap Count: 1
# Description:
#   Bug 1770539 p6 - Move nsPrintData::mPrintDocList to nsPrintJob. r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D146978
# ==============================================================================

diff -r 4e05361c6b08 -r f907e3b915ed layout/printing/nsPrintJob.cpp
--- a/layout/printing/nsPrintJob.cpp	Sun May 22 09:37:57 2022 +0000
+++ b/layout/printing/nsPrintJob.cpp	Sun May 22 09:37:57 2022 +0000
@@ -134,7 +134,7 @@
                                        FILE* aFD = nullptr);
 
 #  define DUMP_DOC_LIST(_title) \
-    DumpPrintObjectsListStart((_title), mPrt->mPrintDocList);
+    DumpPrintObjectsListStart((_title), mPrintDocList);
 #  define DUMP_DOC_TREE DumpPrintObjectsTree(mPrt->mPrintObject.get());
 #  define DUMP_DOC_TREELAYOUT \
     DumpPrintObjectsTreeLayout(mPrt->mPrintObject, mPrt->mPrintDC);
@@ -150,7 +150,7 @@
 
 /**
  * Build a tree of nsPrintObjects under aPO. It also appends a (depth first)
- * flat list of all the nsPrintObjects created to mPrt->mPrintDocList. If
+ * flat list of all the nsPrintObjects created to mPrintDocList. If
  * one of the nsPrintObject's document is the focused document, then the print
  * object is set as mPrt->mSelectionRoot.
  * @param aParentPO The parent nsPrintObject to populate, must not be null.
@@ -201,7 +201,7 @@
       MOZ_ASSERT_UNREACHABLE("Init failed?");
     }
 
-    mPrt->mPrintDocList.AppendElement(childPO.get());
+    mPrintDocList.AppendElement(childPO.get());
     BuildNestedPrintObjects(childPO);
     aParentPO->mKids.AppendElement(std::move(childPO));
   }
@@ -412,7 +412,7 @@
                                                    mIsCreatingPrintPreview);
     NS_ENSURE_SUCCESS(rv, rv);
 
-    printData->mPrintDocList.AppendElement(printData->mPrintObject.get());
+    mPrintDocList.AppendElement(printData->mPrintObject.get());
 
     printData->mPrintObject->mFrameType = eDoc;
 
@@ -699,10 +699,7 @@
   // while we're using it & its members!  So we capture it in an owning local
   // reference & use that instead of using mPrt directly.
   RefPtr<nsPrintData> printData = mPrt;
-  for (uint32_t i = 0; i < printData->mPrintDocList.Length(); ++i) {
-    nsPrintObject* po = printData->mPrintDocList.ElementAt(i);
-    NS_ASSERTION(po, "nsPrintObject can't be null!");
-
+  for (nsPrintObject* po : mPrintDocList) {
     if (!po->PrintingIsEnabled() || po->mInvisible) {
       continue;
     }
@@ -741,7 +738,7 @@
     // For all views except the first one, setup the root view.
     // ??? Can there be multiple po for the top-level-document?
     bool documentIsTopLevel = true;
-    if (i != 0) {
+    if (po->mParent) {
       nsSize adjSize;
       bool doReturn;
       nsresult rv = SetRootView(po, doReturn, documentIsTopLevel, adjSize);
@@ -1445,11 +1442,8 @@
 // Figure out how many documents and how many total pages we are printing
 void nsPrintJob::CalcNumPrintablePages(int32_t& aNumPages) {
   aNumPages = 0;
-  // Count the number of printable documents
-  // and printable pages
-  for (uint32_t i = 0; i < mPrt->mPrintDocList.Length(); i++) {
-    nsPrintObject* po = mPrt->mPrintDocList.ElementAt(i);
-    NS_ASSERTION(po, "nsPrintObject can't be null!");
+  // Count the number of printable documents and printable pages
+  for (nsPrintObject* po : mPrintDocList) {
     // Note: The po->mPresContext null-check below is necessary, because it's
     // possible po->mPresContext might never have been set.  (e.g., if
     // PrintingIsEnabled() returns false, ReflowPrintObject bails before setting