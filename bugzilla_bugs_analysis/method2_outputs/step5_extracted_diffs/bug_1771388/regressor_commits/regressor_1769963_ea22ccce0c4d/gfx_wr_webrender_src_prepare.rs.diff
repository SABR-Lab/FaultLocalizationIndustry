# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/wr/webrender/src/prepare.rs
# Commit: ea22ccce0c4d
# Full Hash: ea22ccce0c4dbe8a1c7ace807924275497f6c899
# Author: Glenn Watson <git@intuitionlibrary.com>
# Date: 2022-05-25 09:36:24
# Regressor Bug: 1769963
# File Overlap Count: 2
# Description:
#   Bug 1769963 - Fix backdrop-filter inside complex transform with CSS filter chain r=gfx-reviewers,lsalzman
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D147124
# ==============================================================================

diff -r 60c64f026b6b -r ea22ccce0c4d gfx/wr/webrender/src/prepare.rs
--- a/gfx/wr/webrender/src/prepare.rs	Wed May 25 05:48:08 2022 +0300
+++ b/gfx/wr/webrender/src/prepare.rs	Wed May 25 02:59:32 2022 +0000
@@ -800,11 +800,23 @@
                 prim_instance.clear_visibility();
             }
         }
-        PrimitiveInstanceKind::Backdrop { .. } => {
+        PrimitiveInstanceKind::BackdropCapture { .. } => {
             // Register the owner picture of this backdrop primitive as the
             // target for resolve of the sub-graph
             frame_state.surface_builder.register_resolve_source();
         }
+        PrimitiveInstanceKind::BackdropRender { .. } => {
+            let sub_graph_output_id = frame_state
+                .surface_builder
+                .sub_graph_output_stack
+                .pop()
+                .expect("bug: no sub-graph output");
+
+            frame_state.surface_builder.add_child_render_task(
+                sub_graph_output_id,
+                frame_state.rg_builder,
+            );
+        }
     };
 }
 
@@ -912,7 +924,8 @@
         PrimitiveInstanceKind::TextRun { .. } |
         PrimitiveInstanceKind::Clear { .. } |
         PrimitiveInstanceKind::LineDecoration { .. } |
-        PrimitiveInstanceKind::Backdrop { .. } => {
+        PrimitiveInstanceKind::BackdropCapture { .. } |
+        PrimitiveInstanceKind::BackdropRender { .. } => {
             return None;
         }
         PrimitiveInstanceKind::Image { image_instance_index, .. } => {
@@ -1380,7 +1393,8 @@
         PrimitiveInstanceKind::RadialGradient { .. } |
         PrimitiveInstanceKind::ConicGradient { .. } |
         PrimitiveInstanceKind::LineDecoration { .. } |
-        PrimitiveInstanceKind::Backdrop { .. } => {
+        PrimitiveInstanceKind::BackdropCapture { .. } |
+        PrimitiveInstanceKind::BackdropRender { .. } => {
             // These primitives don't support / need segments.
             return;
         }