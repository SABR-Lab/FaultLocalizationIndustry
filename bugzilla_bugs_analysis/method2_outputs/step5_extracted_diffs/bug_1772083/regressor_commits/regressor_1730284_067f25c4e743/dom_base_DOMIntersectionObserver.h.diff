# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/DOMIntersectionObserver.h
# Commit: 067f25c4e743
# Full Hash: 067f25c4e7430a16e779696c1422732e4994de78
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-05-26 09:33:28
# Regressor Bug: 1730284
# File Overlap Count: 1
# Description:
#   Bug 1730284 - Factor out some IntersectionObserver code. r=smaug,sefeng
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D146573
# ==============================================================================

diff -r 6c44428c0eca -r 067f25c4e743 dom/base/DOMIntersectionObserver.h
--- a/dom/base/DOMIntersectionObserver.h	Wed May 25 20:41:07 2022 +0000
+++ b/dom/base/DOMIntersectionObserver.h	Wed May 25 20:45:55 2022 +0000
@@ -80,6 +80,32 @@
     }                                                \
   }
 
+// An input suitable to compute intersections with multiple targets.
+struct IntersectionInput {
+  // Whether the root is implicit (null, originally).
+  const bool mIsImplicitRoot = false;
+  // The computed root node. For the implicit root, this will be the in-process
+  // root document we can compute coordinates against (along with the remote
+  // document visible rect if appropriate).
+  const nsINode* mRootNode = nullptr;
+  nsIFrame* mRootFrame = nullptr;
+  // The rect of mRootFrame in client coordinates.
+  nsRect mRootRect;
+  // The root margin computed against the root rect.
+  nsMargin mRootMargin;
+  // If this is in an OOP iframe, the visible rect of the OOP frame.
+  Maybe<nsRect> mRemoteDocumentVisibleRect;
+};
+
+struct IntersectionOutput {
+  const bool mIsSimilarOrigin;
+  const nsRect mRootBounds;
+  const nsRect mTargetRect;
+  const Maybe<nsRect> mIntersectionRect;
+
+  bool Intersects() const { return mIntersectionRect.isSome(); }
+};
+
 class DOMIntersectionObserver final : public nsISupports,
                                       public nsWrapperCache {
   virtual ~DOMIntersectionObserver() { Disconnect(); }
@@ -122,6 +148,11 @@
 
   void TakeRecords(nsTArray<RefPtr<DOMIntersectionObserverEntry>>& aRetVal);
 
+  static IntersectionInput ComputeInput(
+      const Document& aDocument, const nsINode* aRoot,
+      const StyleRect<LengthPercentage>* aRootMargin);
+  static IntersectionOutput Intersect(const IntersectionInput&, Element&);
+
   void Update(Document* aDocument, DOMHighResTimeStamp time);
   MOZ_CAN_RUN_SCRIPT void Notify();
 