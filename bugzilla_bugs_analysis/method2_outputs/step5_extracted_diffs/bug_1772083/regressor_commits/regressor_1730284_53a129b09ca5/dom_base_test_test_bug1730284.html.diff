# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/test/test_bug1730284.html
# Commit: 53a129b09ca5
# Full Hash: 53a129b09ca592aaec955eea02ab15664a3adb9c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-05-26 21:36:38
# Regressor Bug: 1730284
# File Overlap Count: 1
# Description:
#   Bug 1730284 - Use whether the embedder element intersects the viewport to decide whether to throttle in-process iframes. r=smaug
#   
#   This is more likely to be understandable by developers, matches other
#   browsers more closely (see bug comments), and seems more in-line with
#   what we do for OOP iframes.
# ==============================================================================

diff -r 79a95b01b69d -r 53a129b09ca5 dom/base/test/test_bug1730284.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/base/test/test_bug1730284.html	Thu May 26 15:45:01 2022 +0000
@@ -0,0 +1,60 @@
+<!DOCTYPE HTML>
+<meta charset="utf-8">
+<title>Test for bug 1730284 (throttling of same-origin iframes)</title>
+<script src="/tests/SimpleTest/SimpleTest.js"></script>
+<link rel="stylesheet" href="/tests/SimpleTest/test.css">
+<style>
+  iframe {
+    width: 10px;
+    height: 10px;
+  }
+  .display-none {
+    display: none;
+  }
+  .vis-hidden {
+    visibility: hidden
+  }
+  .transparent {
+    opacity: 0;
+  }
+  .zero-size {
+    width: 0;
+    height: 0;
+    border: 0;
+  }
+  .offscreen {
+    position: absolute;
+    top: 500%;
+  }
+  .scroller {
+    height: 100px;
+    overflow: auto;
+  }
+  .scroller-padding {
+    height: 500px;
+  }
+</style>
+<iframe class="visible"></iframe>
+<iframe class="display-none" data-throttled-expected></iframe>
+<iframe class="vis-hidden"></iframe>
+<iframe class="transparent"></iframe>
+<iframe class="zero-size"></iframe>
+<div class="scroller">
+  <div class="scroller-padding"></div>
+  <iframe class="scrolled-out-of-view" data-throttled-expected></iframe>
+</div>
+<iframe class="offscreen" data-throttled-expected></iframe>
+<iframe class="offscreen zero-size" data-throttled-expected></iframe>
+<iframe class="offscreen vis-hidden" data-throttled-expected></iframe>
+<iframe class="offscreen transparent" data-throttled-expected></iframe>
+<script>
+add_task(async function() {
+  await SimpleTest.promiseFocus(window);
+  is(SpecialPowers.DOMWindowUtils.effectivelyThrottlesFrameRequests, false, "Should not be throttling main page");
+
+  for (let frame of document.querySelectorAll("iframe")) {
+    let shouldThrottle = frame.getAttribute("data-throttled-expected") !== null;
+    is(SpecialPowers.getDOMWindowUtils(frame.contentWindow).effectivelyThrottlesFrameRequests, shouldThrottle, frame.className);
+  }
+});
+</script>