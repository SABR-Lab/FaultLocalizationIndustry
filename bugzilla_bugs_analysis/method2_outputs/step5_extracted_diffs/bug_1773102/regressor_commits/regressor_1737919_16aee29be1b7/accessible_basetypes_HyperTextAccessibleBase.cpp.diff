# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/basetypes/HyperTextAccessibleBase.cpp
# Commit: 16aee29be1b7
# Full Hash: 16aee29be1b7ae71eae277b97813fe6bf851ac0f
# Author: James Teh <jteh@mozilla.com>
# Date: 2022-05-27 15:58:57
# Regressor Bug: 1737919
# File Overlap Count: 1
# Description:
#   Bug 1737919 part 1: TextLeafPoint::FindTextAttrsStart: Don't allow the caller to supply origin attributes. r=morgan
#   
#   This was done for LocalAccessibles to avoid the need to fetch attributes twice when we're simultaneously fetching boundaries and returning the attributes to a client.
#   However, GetTextAttributes will soon handle spelling errors, so it will no longer return the same data as GetTextAttributesLocalAcc (which doesn't handle spelling errors).
#   This breaks the equality checks in FindTextAttrsStart.
# ==============================================================================

diff -r 27f0da23c937 -r 16aee29be1b7 accessible/basetypes/HyperTextAccessibleBase.cpp
--- a/accessible/basetypes/HyperTextAccessibleBase.cpp	Fri May 27 04:32:40 2022 +0000
+++ b/accessible/basetypes/HyperTextAccessibleBase.cpp	Fri May 27 10:56:40 2022 +0000
@@ -616,17 +616,16 @@
   }
 
   TextLeafPoint origin = ToTextLeafPoint(static_cast<int32_t>(offset));
-  RefPtr<AccAttributes> attributes = origin.GetTextAttributes(aIncludeDefAttrs);
-  TextLeafPoint start = origin.FindTextAttrsStart(
-      eDirPrevious, /* aIncludeOrigin */ true, attributes, aIncludeDefAttrs);
+  TextLeafPoint start =
+      origin.FindTextAttrsStart(eDirPrevious, /* aIncludeOrigin */ true);
   bool ok;
   std::tie(ok, *aStartOffset) = TransformOffset(start.mAcc, start.mOffset,
                                                 /* aIsEndOffset */ false);
-  TextLeafPoint end = origin.FindTextAttrsStart(
-      eDirNext, /* aIncludeOrigin */ false, attributes, aIncludeDefAttrs);
+  TextLeafPoint end =
+      origin.FindTextAttrsStart(eDirNext, /* aIncludeOrigin */ false);
   std::tie(ok, *aEndOffset) = TransformOffset(end.mAcc, end.mOffset,
                                               /* aIsEndOffset */ true);
-  return attributes.forget();
+  return origin.GetTextAttributes(aIncludeDefAttrs);
 }
 
 void HyperTextAccessibleBase::CroppedSelectionRanges(
