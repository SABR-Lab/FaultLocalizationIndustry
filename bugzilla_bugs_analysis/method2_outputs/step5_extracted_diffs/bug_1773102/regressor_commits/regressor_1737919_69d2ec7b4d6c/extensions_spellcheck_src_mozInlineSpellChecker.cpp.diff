# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: extensions/spellcheck/src/mozInlineSpellChecker.cpp
# Commit: 69d2ec7b4d6c
# Full Hash: 69d2ec7b4d6ca35da23f14602cdf78d939da40cb
# Author: James Teh <jteh@mozilla.com>
# Date: 2022-05-27 15:58:57
# Regressor Bug: 1737919
# File Overlap Count: 1
# Description:
#   Bug 1737919 part 4: Update cached spelling errors when a spelling error is added without the text changing. r=morgan,smaug
#   
#   We already have an nsISelectionListener, but that only tells us that a change happened somewhere in the selection, not which range changed.
#   We don't want to push a cache update for all ranges when only one changed.
#   Therefore, this patch adds an accessibility notification in mozInlineSpellChecker::AddRange.
# ==============================================================================

diff -r 388a15605114 -r 69d2ec7b4d6c extensions/spellcheck/src/mozInlineSpellChecker.cpp
--- a/extensions/spellcheck/src/mozInlineSpellChecker.cpp	Fri May 27 10:56:41 2022 +0000
+++ b/extensions/spellcheck/src/mozInlineSpellChecker.cpp	Fri May 27 10:56:41 2022 +0000
@@ -53,6 +53,9 @@
 #include "mozilla/dom/MouseEvent.h"
 #include "mozilla/dom/Selection.h"
 #include "mozInlineSpellWordUtil.h"
+#ifdef ACCESSIBILITY
+#  include "nsAccessibilityService.h"
+#endif
 #include "nsCOMPtr.h"
 #include "nsCRT.h"
 #include "nsGenericHTMLElement.h"
@@ -1879,6 +1882,11 @@
       rv = err.StealNSResult();
     } else {
       mNumWordsInSpellSelection++;
+#ifdef ACCESSIBILITY
+      if (nsAccessibilityService* accService = GetAccService()) {
+        accService->SpellCheckRangeAdded(*aRange);
+      }
+#endif
     }
   }
 
