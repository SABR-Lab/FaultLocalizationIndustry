# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/html/HTMLLinkElement.cpp
# Commit: 635806b9356c
# Full Hash: 635806b9356cd535ff079a4cfceb9ca954ac23da
# Author: Yoshi Cheng-Hao Huang <allstars.chh@gmail.com>
# Date: 2022-07-11 15:47:29
# Description:
#   Bug 1777496 - Check if ModuleLoader exists before calling SetAcquiringImportMaps. r=smaug
#   
#   For the print preview documents, they are cloned from the original document in
#   Document::CreateStaticClone[1]. But the cloned document isn't attched to any
#   nsIContentViewer yet so it won't have any global object. The document is
# ==============================================================================

diff -r d83579bec018 -r 635806b9356c dom/html/HTMLLinkElement.cpp
--- a/dom/html/HTMLLinkElement.cpp	Mon Jul 11 09:34:33 2022 +0000
+++ b/dom/html/HTMLLinkElement.cpp	Mon Jul 11 09:38:55 2022 +0000
@@ -492,6 +492,16 @@
     // https://wicg.github.io/import-maps/#wait-for-import-maps
     // Step 1.2: Set documentâ€™s acquiring import maps to false.
     // When fetch a modulepreload module script graph.
+    if (!OwnerDoc()->ScriptLoader()->GetModuleLoader()) {
+      // For the print preview documents, at this moment it doesn't have module
+      // loader yet, as the (print preview) document is not attached to the
+      // nsIContentViewer yet, so it doesn't have the GlobalObject.
+      // Also, the script elements won't be processed as they are also cloned
+      // from the original document.
+      // So we simply bail out if the module loader is null.
+      return;
+    }
+
     OwnerDoc()->ScriptLoader()->GetModuleLoader()->SetAcquiringImportMaps(
         false);
     return;