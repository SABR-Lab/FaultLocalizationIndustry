# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsContentSink.cpp
# Commit: 110862c2c4da
# Full Hash: 110862c2c4da9f9cb2b6ecc64668fac0b6275350
# Author: Yoshi Cheng-Hao Huang <allstars.chh@gmail.com>
# Date: 2022-06-28 09:16:40
# Regressor Bug: 1774175
# File Overlap Count: 1
# Description:
#   Bug 1774175 - Call SetAcquiringImportMaps(false) when processing modulepreload. r=yulia,smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D149371
# ==============================================================================

diff -r 2841a1ebc685 -r 110862c2c4da dom/base/nsContentSink.cpp
--- a/dom/base/nsContentSink.cpp	Mon Jun 27 21:19:51 2022 +0000
+++ b/dom/base/nsContentSink.cpp	Mon Jun 27 21:20:48 2022 +0000
@@ -327,6 +327,14 @@
                   aHeader.mIntegrity, aHeader.mSrcset, aHeader.mSizes,
                   aHeader.mCrossOrigin, aHeader.mReferrerPolicy);
     }
+
+    if (linkTypes & LinkStyle::eMODULE_PRELOAD) {
+      // https://wicg.github.io/import-maps/#wait-for-import-maps
+      // Step 1.2: Set documentâ€™s acquiring import maps to false.
+      // When fetch a modulepreload module script graph.
+      mDocument->ScriptLoader()->GetModuleLoader()->SetAcquiringImportMaps(
+          false);
+    }
   }
 
   // is it a stylesheet link?