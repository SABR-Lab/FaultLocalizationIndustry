# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/html/HTMLLinkElement.cpp
# Commit: 110862c2c4da
# Full Hash: 110862c2c4da9f9cb2b6ecc64668fac0b6275350
# Author: Yoshi Cheng-Hao Huang <allstars.chh@gmail.com>
# Date: 2022-06-28 09:16:40
# Regressor Bug: 1774175
# File Overlap Count: 1
# Description:
#   Bug 1774175 - Call SetAcquiringImportMaps(false) when processing modulepreload. r=yulia,smaug
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D149371
# ==============================================================================

diff -r 2841a1ebc685 -r 110862c2c4da dom/html/HTMLLinkElement.cpp
--- a/dom/html/HTMLLinkElement.cpp	Mon Jun 27 21:19:51 2022 +0000
+++ b/dom/html/HTMLLinkElement.cpp	Mon Jun 27 21:20:48 2022 +0000
@@ -18,6 +18,7 @@
 #include "mozilla/dom/DocumentInlines.h"
 #include "mozilla/dom/HTMLLinkElementBinding.h"
 #include "mozilla/dom/HTMLDNSPrefetch.h"
+#include "mozilla/dom/ScriptLoader.h"
 #include "nsContentUtils.h"
 #include "nsDOMTokenList.h"
 #include "nsGenericHTMLElement.h"
@@ -313,8 +314,9 @@
     // Keep this and the one below in sync with ToLinkMask in
     // LinkStyle.cpp.
     // "preload" must come first because it can be disabled.
-    "preload",   "prefetch",   "dns-prefetch", "stylesheet", "next",
-    "alternate", "preconnect", "icon",         "search",     nullptr};
+    "preload", "prefetch",      "dns-prefetch", "stylesheet",
+    "next",    "alternate",     "preconnect",   "icon",
+    "search",  "modulepreload", nullptr};
 
 static const DOMTokenListSupportedToken sSupportedRelValuesWithManifest[] = {
     // Keep this in sync with ToLinkMask in LinkStyle.cpp.
@@ -486,6 +488,15 @@
     }
   }
 
+  if (linkTypes & eMODULE_PRELOAD) {
+    // https://wicg.github.io/import-maps/#wait-for-import-maps
+    // Step 1.2: Set documentâ€™s acquiring import maps to false.
+    // When fetch a modulepreload module script graph.
+    OwnerDoc()->ScriptLoader()->GetModuleLoader()->SetAcquiringImportMaps(
+        false);
+    return;
+  }
+
   if (linkTypes & ePRECONNECT) {
     if (nsCOMPtr<nsIURI> uri = GetURI()) {
       OwnerDoc()->MaybePreconnect(