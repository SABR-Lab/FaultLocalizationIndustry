# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsWindow.cpp
# Commit: a6795c151e24
# Full Hash: a6795c151e24eb326631b21d8f0944cc22d915a1
# Author: stransky <stransky@redhat.com>
# Date: 2022-07-01 21:35:54
# Regressor Bug: 1777186
# File Overlap Count: 1
# Description:
#   Bug 1777186 [Wayland] Use correct popup window to calculate parent fit r=jhorak
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D150537
# ==============================================================================

diff -r b8617ce97c45 -r a6795c151e24 widget/gtk/nsWindow.cpp
--- a/widget/gtk/nsWindow.cpp	Fri Jul 01 06:48:47 2022 +0000
+++ b/widget/gtk/nsWindow.cpp	Fri Jul 01 08:09:04 2022 +0000
@@ -1818,7 +1818,7 @@
       if (!useIt) {
         return false;
       }
-      if (WaylandPopupFitsToplevelWindow()) {
+      if (popup->WaylandPopupFitsToplevelWindow()) {
         // Workaround for https://gitlab.gnome.org/GNOME/gtk/-/issues/1986
         // Bug 1760276 - don't use move-to-rect when popup is inside main
         // Firefox window.
@@ -1882,6 +1882,13 @@
 
 void nsWindow::NativeMoveResizeWaylandPopupCallback(
     const GdkRectangle* aFinalSize, bool aFlippedX, bool aFlippedY) {
+#ifdef NIGHTLY_BUILD
+  // We're getting move-to-rect callback without move-to-rect call.
+  // That indicates a compositor bug
+  MOZ_DIAGNOSTIC_ASSERT(mWaitingForMoveToRectCallback,
+                        "Bogus move-to-rect callback! A compositor bug?");
+#endif
+
   mWaitingForMoveToRectCallback = false;
 
   bool movedByLayout = mMovedAfterMoveToRect;
@@ -2075,6 +2082,8 @@
 
   GdkPoint topLeft = DevicePixelsToGdkPointRoundDown(mBounds.TopLeft());
   GdkRectangle size = DevicePixelsToGdkSizeRoundUp(mLastSizeRequest);
+  LOG("  popup topleft %d, %d size %d x %d", topLeft.x, topLeft.y, size.width,
+      size.height);
   int fits = topLeft.x >= 0 && topLeft.y >= 0 &&
              topLeft.x + size.width <= parentWidth &&
              topLeft.y + size.height <= parentHeight;
