# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/android/SessionAccessibility.cpp
# Commit: 4965ca9b7882
# Full Hash: 4965ca9b7882e482c0d5f48de63fad4457a9863f
# Author: Eitan Isaacson <eitan@monotonous.org>
# Date: 2022-07-07 09:37:57
# Regressor Bug: 1771934
# File Overlap Count: 1
# Description:
#   Bug 1771934 - Unregister all SessionAccessibility accessibles when top doc is shut down. r=Jamie
#   
#   The associated PresShell of the root doc can be used for retrieving the
#   SessionAccessibility. If the PresShell is about to go away, we should
#   unregister all the accessibles.
# ==============================================================================

diff -r 3827c37b916d -r 4965ca9b7882 accessible/android/SessionAccessibility.cpp
--- a/accessible/android/SessionAccessibility.cpp	Thu Jul 07 01:47:08 2022 +0300
+++ b/accessible/android/SessionAccessibility.cpp	Wed Jul 06 22:26:08 2022 +0000
@@ -261,7 +261,6 @@
 RefPtr<SessionAccessibility> SessionAccessibility::GetInstanceFor(
     Accessible* aAccessible) {
   MOZ_ASSERT(NS_IsMainThread());
-  PresShell* presShell = nullptr;
   if (LocalAccessible* localAcc = aAccessible->AsLocal()) {
     DocAccessible* docAcc = localAcc->Document();
     // If the accessible is being shutdown from the doc's shutdown
@@ -271,7 +270,7 @@
     dom::Document* doc = docAcc ? docAcc->DocumentNode() : nullptr;
     if (doc && doc->IsContentDocument()) {
       // Only content accessibles should have an associated SessionAccessible.
-      presShell = doc->GetPresShell();
+      return GetInstanceFor(doc->GetPresShell());
     }
   } else {
     dom::CanonicalBrowsingContext* cbc =
@@ -287,15 +286,21 @@
     nsPresContext* presContext =
         bp->GetOwnerElement()->OwnerDoc()->GetPresContext();
     if (presContext) {
-      presShell = presContext->PresShell();
+      return GetInstanceFor(presContext->PresShell());
     }
   }
 
-  if (!presShell) {
+  return nullptr;
+}
+
+RefPtr<SessionAccessibility> SessionAccessibility::GetInstanceFor(
+    PresShell* aPresShell) {
+  MOZ_ASSERT(NS_IsMainThread());
+  if (!aPresShell) {
     return nullptr;
   }
 
-  nsViewManager* vm = presShell->GetViewManager();
+  nsViewManager* vm = aPresShell->GetViewManager();
   if (!vm) {
     return nullptr;
   }
@@ -1037,6 +1042,7 @@
   }
 
   RefPtr<SessionAccessibility> sessionAcc = GetInstanceFor(aAccessible);
+  MOZ_ASSERT(sessionAcc, "Need SessionAccessibility to unregister Accessible!");
   if (sessionAcc) {
     MOZ_ASSERT(sessionAcc->mIDToAccessibleMap.Contains(virtualViewID),
                "Unregistering unregistered accessible");
@@ -1049,3 +1055,30 @@
 
   AccessibleWrap::SetVirtualViewID(aAccessible, kUnsetID);
 }
+
+void SessionAccessibility::UnregisterAll(PresShell* aPresShell) {
+  if (IPCAccessibilityActive()) {
+    // Don't unregister accessible in content process.
+    return;
+  }
+
+  nsAccessibilityService::GetAndroidMonitor().AssertCurrentThreadOwns();
+  RefPtr<SessionAccessibility> sessionAcc = GetInstanceFor(aPresShell);
+
+  if (!sessionAcc) {
+    return;
+  }
+
+  for (auto iter = sessionAcc->mIDToAccessibleMap.Iter(); !iter.Done();
+       iter.Next()) {
+    int32_t virtualViewID = iter.Key();
+    if (virtualViewID > kNoID) {
+      sIDSet.ReleaseID(virtualViewID);
+    }
+
+    Accessible* accessible = iter.Data();
+    AccessibleWrap::SetVirtualViewID(accessible, kUnsetID);
+
+    iter.Remove();
+  }
+}
\ No newline at end of file