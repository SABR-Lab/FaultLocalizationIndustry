# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/mediasink/AudioSink.h
# Commit: 3728fcbd5753
# Full Hash: 3728fcbd575331d537df4b4ab0589d0624bb3535
# Author: Paul Adenot <paul@paul.cx>
# Date: 2022-04-20 21:53:00
# Regressor Bug: 1743834
# File Overlap Count: 1
# Description:
#   Bug 1743834 - Correctly set the start time when the audio callbacks actually are called, the first time audio audio clock starts to be in use. r=alwu,media-playback-reviewers
#   
#   The base clock for the new audio stream is precisely the time when the clock
#   source changes from the system clock to the audio clock, accounting for the time
#   it takes to actually starts the stream. This allows avoiding discontinuities
# ==============================================================================

diff -r 4d427e0ca400 -r 3728fcbd5753 dom/media/mediasink/AudioSink.h
--- a/dom/media/mediasink/AudioSink.h	Wed Apr 20 12:07:10 2022 +0000
+++ b/dom/media/mediasink/AudioSink.h	Wed Apr 20 12:07:10 2022 +0000
@@ -83,6 +83,10 @@
     return mAudioStream && mAudioStream->CallbackStarted();
   }
 
+  void UpdateStartTime(const media::TimeUnit& aStartTime) {
+    mStartTime = aStartTime;
+  }
+
  private:
   // Allocate and initialize mAudioStream. Returns NS_OK on success.
   nsresult InitializeAudioStream(const PlaybackParams& aParams);
@@ -112,7 +116,7 @@
   // The presentation time of the first audio frame that was played.
   // We can add this to the audio stream position to determine
   // the current audio time.
-  const media::TimeUnit mStartTime;
+  media::TimeUnit mStartTime;
 
   // Keep the last good position returned from the audio stream. Used to ensure
   // position returned by GetPosition() is mono-increasing in spite of audio