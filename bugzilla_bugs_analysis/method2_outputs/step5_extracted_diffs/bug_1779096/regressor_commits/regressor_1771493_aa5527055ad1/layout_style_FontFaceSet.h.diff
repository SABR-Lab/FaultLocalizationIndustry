# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/FontFaceSet.h
# Commit: aa5527055ad1
# Full Hash: aa5527055ad1d21aa109bc8a0ceaee3b0a58288c
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2022-06-29 03:44:30
# Regressor Bug: 1771493
# File Overlap Count: 1
# Description:
#   Bug 1771493 - Part 1. Split FontFace(Set) into DOM facing and implementation classes. r=emilio
#   
#   This patch aims to split the implementation details of FontFace(Set)
#   into FontFace(Set)Impl classes. The Impl variants have threadsafe
#   refcounting and are intended to be the basis for worker support for
# ==============================================================================

diff -r e0c50a17b0ff -r aa5527055ad1 layout/style/FontFaceSet.h
--- a/layout/style/FontFaceSet.h	Tue Jun 28 15:45:58 2022 +0000
+++ b/layout/style/FontFaceSet.h	Tue Jun 28 15:58:09 2022 +0000
@@ -9,6 +9,7 @@
 
 #include "mozilla/dom/FontFace.h"
 #include "mozilla/dom/FontFaceSetBinding.h"
+#include "mozilla/dom/FontFaceSetImpl.h"
 #include "mozilla/DOMEventTargetHelper.h"
 #include "gfxUserFontSet.h"
 #include "nsICSSLoaderObserver.h"
@@ -26,124 +27,28 @@
 class PostTraversalTask;
 class SharedFontList;
 namespace dom {
-class FontFace;
 class Promise;
 }  // namespace dom
 }  // namespace mozilla
 
 namespace mozilla::dom {
 
-class FontFaceSet final : public DOMEventTargetHelper,
-                          public nsIDOMEventListener,
-                          public nsICSSLoaderObserver {
+class FontFaceSet final : public DOMEventTargetHelper {
   friend class mozilla::PostTraversalTask;
-  friend class UserFontSet;
 
  public:
-  /**
-   * A gfxUserFontSet that integrates with the layout and style systems to
-   * manage @font-face rules and handle network requests for font loading.
-   *
-   * We would combine this class and FontFaceSet into the one class if it were
-   * possible; it's not because FontFaceSet is cycle collected and
-   * gfxUserFontSet isn't (and can't be, as gfx classes don't use the cycle
-   * collector).  So UserFontSet exists just to override the needed virtual
-   * methods from gfxUserFontSet and to forward them on FontFaceSet.
-   */
-  class UserFontSet final : public gfxUserFontSet {
-    friend class FontFaceSet;
-
-   public:
-    explicit UserFontSet(FontFaceSet* aFontFaceSet)
-        : mFontFaceSet(aFontFaceSet) {}
-
-    FontFaceSet* GetFontFaceSet() { return mFontFaceSet; }
-
-    gfxFontSrcPrincipal* GetStandardFontLoadPrincipal() const final {
-      return mFontFaceSet ? mFontFaceSet->mStandardFontLoadPrincipal.get()
-                          : nullptr;
-    }
-
-    nsPresContext* GetPresContext() const final {
-      return mFontFaceSet ? mFontFaceSet->GetPresContext() : nullptr;
-    }
-
-    bool IsFontLoadAllowed(const gfxFontFaceSrc&) final;
-
-    void DispatchFontLoadViolations(
-        nsTArray<nsCOMPtr<nsIRunnable>>& aViolations) override;
-
-    virtual nsresult StartLoad(gfxUserFontEntry* aUserFontEntry,
-                               uint32_t aSrcIndex) override;
-
-    void RecordFontLoadDone(uint32_t aFontSize, TimeStamp aDoneTime) override;
-
-    bool BypassCache() final {
-      return mFontFaceSet && mFontFaceSet->mBypassCache;
-    }
-
-   protected:
-    virtual bool GetPrivateBrowsing() override;
-    virtual nsresult SyncLoadFontData(gfxUserFontEntry* aFontToLoad,
-                                      const gfxFontFaceSrc* aFontFaceSrc,
-                                      uint8_t*& aBuffer,
-                                      uint32_t& aBufferLength) override;
-    virtual nsresult LogMessage(gfxUserFontEntry* aUserFontEntry,
-                                uint32_t aSrcIndex, const char* aMessage,
-                                uint32_t aFlags = nsIScriptError::errorFlag,
-                                nsresult aStatus = NS_OK) override;
-    virtual void DoRebuildUserFontSet() override;
-    already_AddRefed<gfxUserFontEntry> CreateUserFontEntry(
-        const nsTArray<gfxFontFaceSrc>& aFontFaceSrcList, WeightRange aWeight,
-        StretchRange aStretch, SlantStyleRange aStyle,
-        const nsTArray<gfxFontFeature>& aFeatureSettings,
-        const nsTArray<gfxFontVariation>& aVariationSettings,
-        uint32_t aLanguageOverride, gfxCharacterMap* aUnicodeRanges,
-        StyleFontDisplay aFontDisplay, RangeFlags aRangeFlags,
-        float aAscentOverride, float aDescentOverride, float aLineGapOverride,
-        float aSizeAdjust) override;
-
-   private:
-    RefPtr<FontFaceSet> mFontFaceSet;
-  };
+  using UserFontSet = FontFaceSetImpl::UserFontSet;
 
   NS_DECL_ISUPPORTS_INHERITED
   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(FontFaceSet, DOMEventTargetHelper)
-  NS_DECL_NSIDOMEVENTLISTENER
 
   FontFaceSet(nsPIDOMWindowInner* aWindow, dom::Document* aDocument);
 
   virtual JSObject* WrapObject(JSContext* aCx,
                                JS::Handle<JSObject*> aGivenProto) override;
 
-  UserFontSet* GetUserFontSet() { return mUserFontSet; }
-
-  // Called by nsFontFaceLoader when the loader has completed normally.
-  // It's removed from the mLoaders set.
-  void RemoveLoader(nsFontFaceLoader* aLoader);
-
   bool UpdateRules(const nsTArray<nsFontFaceRuleContainer>& aRules);
 
-  nsPresContext* GetPresContext();
-
-  // search for @font-face rule that matches a platform font entry
-  RawServoFontFaceRule* FindRuleForEntry(gfxFontEntry* aFontEntry);
-
-  void IncrementGeneration(bool aIsRebuild = false);
-
-  /**
-   * Finds an existing entry in the user font cache or creates a new user
-   * font entry for the given FontFace object.
-   */
-  static already_AddRefed<gfxUserFontEntry>
-  FindOrCreateUserFontEntryFromFontFace(FontFace* aFontFace);
-
-  /**
-   * Notification method called by a FontFace to indicate that its loading
-   * status has changed.
-   */
-  void OnFontFaceStatusChanged(FontFace* aFontFace);
-
   /**
    * Notification method called by the nsPresContext to indicate that the
    * refresh driver ticked and flushed style and layout.
@@ -156,22 +61,17 @@
    */
   static bool PrefEnabled();
 
-  // nsICSSLoaderObserver
-  NS_IMETHOD StyleSheetLoaded(StyleSheet* aSheet, bool aWasDeferred,
-                              nsresult aStatus) override;
-
   void FlushUserFontSet();
 
-  static nsPresContext* GetPresContextFor(gfxUserFontSet* aUserFontSet) {
-    FontFaceSet* set = static_cast<UserFontSet*>(aUserFontSet)->mFontFaceSet;
-    return set ? set->GetPresContext() : nullptr;
-  }
-
   void RefreshStandardFontLoadPrincipal();
 
   void CopyNonRuleFacesTo(FontFaceSet* aFontFaceSet) const;
 
-  dom::Document* Document() const { return mDocument; }
+  UserFontSet* GetUserFontSet() const { return mImpl->GetUserFontSet(); }
+
+  void CacheFontLoadability() { mImpl->CacheFontLoadability(); }
+
+  FontFaceSetImpl* GetImpl() const { return mImpl; }
 
   // -- Web IDL --------------------------------------------------------------
 
@@ -199,16 +99,24 @@
   void ForEach(JSContext* aCx, FontFaceSetForEachCallback& aCallback,
                JS::Handle<JS::Value> aThisArg, ErrorResult& aRv);
 
-  // For ServoStyleSet to know ahead of time whether a font is loadable.
-  void CacheFontLoadability();
-
-  void MarkUserFontSetDirty();
-
   /**
    * Unlike Size(), this returns the size including non-Author origin fonts.
    */
   uint32_t SizeIncludingNonAuthorOrigins();
 
+  void MaybeResolve();
+
+  void DispatchLoadingFinishedEvent(
+      const nsAString& aType, nsTArray<OwningNonNull<FontFace>>&& aFontFaces);
+
+  void DispatchLoadingEventAndReplaceReadyPromise();
+  void DispatchCheckLoadingFinishedAfterDelay();
+
+  // Whether mReady is pending, or would be when created.
+  bool ReadyPromiseIsPending() const;
+
+  void InsertRuleFontFace(FontFace* aFontFace, StyleOrigin aOrigin);
+
  private:
   friend mozilla::dom::FontFaceSetIterator;  // needs GetFontFaceAt()
 
@@ -222,33 +130,7 @@
   /**
    * Removes any listeners and observers.
    */
-  void Disconnect();
-
-  void RemoveDOMContentLoadedListener();
-
-  /**
-   * Returns whether there might be any pending font loads, which should cause
-   * the mReady Promise not to be resolved yet.
-   */
-  bool MightHavePendingFontLoads();
-
-  /**
-   * Checks to see whether it is time to replace mReady and dispatch a
-   * "loading" event.
-   */
-  void CheckLoadingStarted();
-
-  /**
-   * Checks to see whether it is time to resolve mReady and dispatch any
-   * "loadingdone" and "loadingerror" events.
-   */
-  void CheckLoadingFinished();
-
-  /**
-   * Callback for invoking CheckLoadingFinished after going through the
-   * event loop.  See OnFontFaceStatusChanged.
-   */
-  void CheckLoadingFinishedAfterDelay();
+  void Destroy();
 
   /**
    * Returns the font at aIndex if it's an Author origin font, or nullptr
@@ -256,12 +138,6 @@
    */
   FontFace* GetFontFaceAt(uint32_t aIndex);
 
-  /**
-   * Dispatches a FontFaceSetLoadEvent to this object.
-   */
-  void DispatchLoadingFinishedEvent(
-      const nsAString& aType, nsTArray<OwningNonNull<FontFace>>&& aFontFaces);
-
   // Note: if you add new cycle collected objects to FontFaceRecord,
   // make sure to update FontFaceSet's cycle collection macros
   // accordingly.
@@ -275,76 +151,12 @@
     bool mLoadEventShouldFire;
   };
 
-  static already_AddRefed<gfxUserFontEntry>
-  FindOrCreateUserFontEntryFromFontFace(const nsACString& aFamilyName,
-                                        FontFace* aFontFace, StyleOrigin);
-
-  // search for @font-face rule that matches a userfont font entry
-  RawServoFontFaceRule* FindRuleForUserFontEntry(
-      gfxUserFontEntry* aUserFontEntry);
-
-  nsresult StartLoad(gfxUserFontEntry* aUserFontEntry, uint32_t aSrcIndex);
-  gfxFontSrcPrincipal* GetStandardFontLoadPrincipal();
-  nsresult CheckFontLoad(const gfxFontFaceSrc* aFontFaceSrc,
-                         gfxFontSrcPrincipal** aPrincipal, bool* aBypassCache);
-  bool IsFontLoadAllowed(const gfxFontFaceSrc& aSrc);
-
-  void DispatchFontLoadViolations(nsTArray<nsCOMPtr<nsIRunnable>>& aViolations);
-  nsresult SyncLoadFontData(gfxUserFontEntry* aFontToLoad,
-                            const gfxFontFaceSrc* aFontFaceSrc,
-                            uint8_t*& aBuffer, uint32_t& aBufferLength);
-  nsresult LogMessage(gfxUserFontEntry* aUserFontEntry, uint32_t aSrcIndex,
-                      const char* aMessage, uint32_t aFlags, nsresult aStatus);
-
-  void InsertRuleFontFace(FontFace* aFontFace, StyleOrigin aOrigin,
-                          nsTArray<FontFaceRecord>& aOldRecords,
-                          bool& aFontSetModified);
-  void InsertNonRuleFontFace(FontFace* aFontFace, bool& aFontSetModified);
-
 #ifdef DEBUG
   bool HasRuleFontFace(FontFace* aFontFace);
 #endif
 
-  /**
-   * Returns whether we have any loading FontFace objects in the FontFaceSet.
-   */
-  bool HasLoadingFontFaces();
-
-  // Whether mReady is pending, or would be when created.
-  bool ReadyPromiseIsPending() const;
-
-  // Helper function for HasLoadingFontFaces.
-  void UpdateHasLoadingFontFaces();
-
-  void ParseFontShorthandForMatching(const nsACString& aFont,
-                                     StyleFontFamilyList& aFamilyList,
-                                     FontWeight& aWeight, FontStretch& aStretch,
-                                     FontSlantStyle& aStyle, ErrorResult& aRv);
-  void FindMatchingFontFaces(const nsACString& aFont, const nsAString& aText,
-                             nsTArray<FontFace*>& aFontFaces, ErrorResult& aRv);
-
-  void DispatchLoadingEventAndReplaceReadyPromise();
-  void DispatchCheckLoadingFinishedAfterDelay();
-
-  TimeStamp GetNavigationStartTimeStamp();
-
-  RefPtr<UserFontSet> mUserFontSet;
-
-  // The document this is a FontFaceSet for.
-  RefPtr<dom::Document> mDocument;
-
-  // The document's node principal, which is the principal font loads for
-  // this FontFaceSet will generally use.  (This principal is not used for
-  // @font-face rules in UA and user sheets, where the principal of the
-  // sheet is used instead.)
-  //
-  // This field is used from GetStandardFontLoadPrincipal.  When on a
-  // style worker thread, we use mStandardFontLoadPrincipal assuming
-  // it is up to date.
-  //
-  // Because mDocument's principal can change over time,
-  // its value must be updated by a call to ResetStandardFontLoadPrincipal.
-  RefPtr<gfxFontSrcPrincipal> mStandardFontLoadPrincipal;
+  // The underlying implementation for FontFaceSet.
+  RefPtr<FontFaceSetImpl> mImpl;
 
   // A Promise that is fulfilled once all of the FontFace objects
   // in mRuleFaces and mNonRuleFaces that started or were loading at the
@@ -355,12 +167,7 @@
   // Note that mReady is created lazily when GetReady() is called.
   RefPtr<dom::Promise> mReady;
   // Whether the ready promise must be resolved when it's created.
-  bool mResolveLazilyCreatedReadyPromise;
-
-  // Set of all loaders pointing to us. These are not strong pointers,
-  // but that's OK because nsFontFaceLoader always calls RemoveLoader on
-  // us before it dies (unless we die first).
-  nsTHashtable<nsPtrHashKey<nsFontFaceLoader>> mLoaders;
+  bool mResolveLazilyCreatedReadyPromise = false;
 
   // The @font-face rule backed FontFace objects in the FontFaceSet.
   nsTArray<FontFaceRecord> mRuleFaces;
@@ -368,40 +175,6 @@
   // The non rule backed FontFace objects that have been added to this
   // FontFaceSet.
   nsTArray<FontFaceRecord> mNonRuleFaces;
-
-  // The overall status of the loading or loaded fonts in the FontFaceSet.
-  dom::FontFaceSetLoadStatus mStatus;
-
-  // A map from gfxFontFaceSrc pointer identity to whether the load is allowed
-  // by CSP or other checks. We store this here because querying CSP off the
-  // main thread is not a great idea.
-  //
-  // We could use just the pointer and use this as a hash set, but then we'd
-  // have no way to verify that we've checked all the loads we should.
-  nsTHashMap<nsPtrHashKey<const gfxFontFaceSrc>, bool> mAllowedFontLoads;
-
-  // Whether mNonRuleFaces has changed since last time UpdateRules ran.
-  bool mNonRuleFacesDirty;
-
-  // Whether any FontFace objects in mRuleFaces or mNonRuleFaces are
-  // loading.  Only valid when mHasLoadingFontFacesIsDirty is false.  Don't use
-  // this variable directly; call the HasLoadingFontFaces method instead.
-  bool mHasLoadingFontFaces;
-
-  // This variable is only valid when mLoadingDirty is false.
-  bool mHasLoadingFontFacesIsDirty;
-
-  // Whether CheckLoadingFinished calls should be ignored.  See comment in
-  // OnFontFaceStatusChanged.
-  bool mDelayedLoadCheck;
-
-  // Whether the docshell for our document indicated that loads should
-  // bypass the cache.
-  bool mBypassCache;
-
-  // Whether the docshell for our document indicates that we are in private
-  // browsing mode.
-  bool mPrivateBrowsing;
 };
 
 }  // namespace mozilla::dom