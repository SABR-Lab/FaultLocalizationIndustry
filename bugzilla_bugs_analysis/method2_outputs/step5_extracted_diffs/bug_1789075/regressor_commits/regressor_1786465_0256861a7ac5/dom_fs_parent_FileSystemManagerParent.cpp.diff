# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/FileSystemManagerParent.cpp
# Commit: 0256861a7ac5
# Full Hash: 0256861a7ac5da2076df7735d1522fca9725b346
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 3
# Description:
#   Bug 1786465 - Implement registration counting of FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   FileSystemDataManager can be now closed when it's still alive (not in the
#   destructor).
#   
# ==============================================================================

diff -r 04e60585a3f0 -r 0256861a7ac5 dom/fs/parent/FileSystemManagerParent.cpp
--- a/dom/fs/parent/FileSystemManagerParent.cpp	Wed Aug 31 09:34:57 2022 +0000
+++ b/dom/fs/parent/FileSystemManagerParent.cpp	Wed Aug 31 09:34:57 2022 +0000
@@ -8,6 +8,7 @@
 #include "nsNetCID.h"
 #include "mozilla/dom/FileSystemDataManager.h"
 #include "mozilla/dom/FileSystemTypes.h"
+#include "mozilla/dom/quota/ForwardDecls.h"
 #include "mozilla/ipc/Endpoint.h"
 
 using IPCResult = mozilla::ipc::IPCResult;
@@ -28,6 +29,10 @@
     const EntryId& aRootEntry)
     : mDataManager(std::move(aDataManager)), mRootEntry(aRootEntry) {}
 
+FileSystemManagerParent::~FileSystemManagerParent() {
+  LOG(("Destroying FileSystemManagerParent %p", this));
+}
+
 IPCResult FileSystemManagerParent::RecvGetRootHandleMsg(
     GetRootHandleMsgResolver&& aResolver) {
   FileSystemGetHandleResponse response(mRootEntry);
@@ -117,14 +122,33 @@
   return IPC_OK();
 }
 
-FileSystemManagerParent::~FileSystemManagerParent() {
-  LOG(("Destroying FileSystemManagerParent %p", this));
+void FileSystemManagerParent::OnChannelClose() {
+  if (!mAllowedToClose) {
+    AllowToClose();
+  }
+
+  PFileSystemManagerParent::OnChannelClose();
+}
+
+void FileSystemManagerParent::OnChannelError() {
+  if (!mAllowedToClose) {
+    AllowToClose();
+  }
 
-  nsCOMPtr<nsISerialEventTarget> target =
-      mDataManager->MutableBackgroundTargetPtr();
+  PFileSystemManagerParent::OnChannelError();
+}
+
+void FileSystemManagerParent::AllowToClose() {
+  mAllowedToClose.Flip();
 
-  NS_ProxyRelease("ReleaseFileSystemDataManager", target,
-                  mDataManager.forget());
+  InvokeAsync(mDataManager->MutableBackgroundTargetPtr(), __func__,
+              [self = RefPtr<FileSystemManagerParent>(this)]() {
+                self->mDataManager->UnregisterActor(WrapNotNull(self));
+
+                self->mDataManager = nullptr;
+
+                return BoolPromise::CreateAndResolve(true, __func__);
+              });
 }
 
 }  // namespace mozilla::dom