# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/FileSystemManagerParent.h
# Commit: 0256861a7ac5
# Full Hash: 0256861a7ac5da2076df7735d1522fca9725b346
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 3
# Description:
#   Bug 1786465 - Implement registration counting of FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   FileSystemDataManager can be now closed when it's still alive (not in the
#   destructor).
#   
# ==============================================================================

diff -r 04e60585a3f0 -r 0256861a7ac5 dom/fs/parent/FileSystemManagerParent.h
--- a/dom/fs/parent/FileSystemManagerParent.h	Wed Aug 31 09:34:57 2022 +0000
+++ b/dom/fs/parent/FileSystemManagerParent.h	Wed Aug 31 09:34:57 2022 +0000
@@ -8,6 +8,7 @@
 #define DOM_FS_PARENT_FILESYSTEMMANAGERPARENT_H_
 
 #include "ErrorList.h"
+#include "mozilla/dom/FlippedOnce.h"
 #include "mozilla/dom/PFileSystemManagerParent.h"
 #include "nsISupports.h"
 
@@ -31,6 +32,8 @@
   FileSystemManagerParent(RefPtr<fs::data::FileSystemDataManager> aDataManager,
                           const EntryId& aRootEntry);
 
+  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(FileSystemManagerParent, override)
+
   mozilla::ipc::IPCResult RecvGetRootHandleMsg(
       GetRootHandleMsgResolver&& aResolver);
 
@@ -67,15 +70,21 @@
   mozilla::ipc::IPCResult RecvNeedQuota(FileSystemQuotaRequest&& aRequest,
                                         NeedQuotaResolver&& aResolver);
 
-  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(FileSystemManagerParent)
+  void OnChannelClose() override;
+
+  void OnChannelError() override;
 
  protected:
   virtual ~FileSystemManagerParent();
 
+  void AllowToClose();
+
  private:
   RefPtr<fs::data::FileSystemDataManager> mDataManager;
 
   const EntryId mRootEntry;
+
+  FlippedOnce<false> mAllowedToClose;
 };
 
 }  // namespace mozilla::dom