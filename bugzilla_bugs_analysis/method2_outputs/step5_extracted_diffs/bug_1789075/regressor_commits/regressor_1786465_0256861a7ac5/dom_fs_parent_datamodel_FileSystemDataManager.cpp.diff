# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/datamodel/FileSystemDataManager.cpp
# Commit: 0256861a7ac5
# Full Hash: 0256861a7ac5da2076df7735d1522fca9725b346
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 3
# Description:
#   Bug 1786465 - Implement registration counting of FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   FileSystemDataManager can be now closed when it's still alive (not in the
#   destructor).
#   
# ==============================================================================

diff -r 04e60585a3f0 -r 0256861a7ac5 dom/fs/parent/datamodel/FileSystemDataManager.cpp
--- a/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:57 2022 +0000
+++ b/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:57 2022 +0000
@@ -86,19 +86,19 @@
     const Origin& aOrigin, MovingNotNull<RefPtr<TaskQueue>> aIOTaskQueue)
     : mOrigin(aOrigin),
       mBackgroundTarget(WrapNotNull(GetCurrentSerialEventTarget())),
-      mIOTaskQueue(std::move(aIOTaskQueue)) {}
+      mIOTaskQueue(std::move(aIOTaskQueue)),
+      mRegCount(0),
+      mState(State::Initial) {}
 
 FileSystemDataManager::~FileSystemDataManager() {
-  mIOTaskQueue->BeginShutdown();
-
-  RemoveFileSystemDataManager(mOrigin);
+  MOZ_ASSERT(mState == State::Closed);
 }
 
 FileSystemDataManager::result_t
 FileSystemDataManager::GetOrCreateFileSystemDataManager(const Origin& aOrigin) {
   if (RefPtr<FileSystemDataManager> dataManager =
           GetFileSystemDataManager(aOrigin)) {
-    return dataManager;
+    return Registered<FileSystemDataManager>(std::move(dataManager));
   }
 
   QM_TRY_UNWRAP(auto streamTransportService,
@@ -116,7 +116,52 @@
 
   AddFileSystemDataManager(aOrigin, dataManager);
 
-  return dataManager;
+  return Registered<FileSystemDataManager>(std::move(dataManager));
+}
+
+void FileSystemDataManager::Register() { mRegCount++; }
+
+void FileSystemDataManager::Unregister() {
+  MOZ_ASSERT(mRegCount > 0);
+
+  mRegCount--;
+
+  if (IsInactive()) {
+    Close();
+  }
+}
+
+void FileSystemDataManager::RegisterActor(
+    NotNull<FileSystemManagerParent*> aActor) {
+  MOZ_ASSERT(!mActors.Contains(aActor));
+
+  mActors.Insert(aActor);
+}
+
+void FileSystemDataManager::UnregisterActor(
+    NotNull<FileSystemManagerParent*> aActor) {
+  MOZ_ASSERT(mActors.Contains(aActor));
+
+  mActors.Remove(aActor);
+
+  if (IsInactive()) {
+    Close();
+  }
+}
+
+bool FileSystemDataManager::IsInactive() const {
+  return !mRegCount && !mActors.Count();
+}
+
+void FileSystemDataManager::Close() {
+  MOZ_ASSERT(mState == State::Initial);
+  MOZ_ASSERT(IsInactive());
+
+  mState = State::Closed;
+
+  mIOTaskQueue->BeginShutdown();
+
+  RemoveFileSystemDataManager(mOrigin);
 }
 
 }  // namespace mozilla::dom::fs::data