# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp
# Commit: 0cc0844f049a
# Full Hash: 0cc0844f049af2d440767f5217f58d04479d03ff
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 2
# Description:
#   Bug 1786465 - Handle pending open/close operations in GetOrCreateFileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D155790
# ==============================================================================

diff -r fbc09d7df86e -r 0cc0844f049a dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp
--- a/dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp	Wed Aug 31 09:34:59 2022 +0000
+++ b/dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp	Wed Aug 31 09:34:59 2022 +0000
@@ -42,4 +42,123 @@
   SpinEventLoopUntil("Promise is fulfilled"_ns, [&done]() { return done; });
 }
 
+TEST(TestFileSystemDataManager, GetOrCreateFileSystemDataManager_PendingOpen)
+{
+  Registered<data::FileSystemDataManager> rdm1;
+
+  Registered<data::FileSystemDataManager> rdm2;
+
+  {
+    bool done1 = false;
+
+    data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
+        Origin(kTestOriginName))
+        ->Then(
+            GetCurrentSerialEventTarget(), __func__,
+            [&rdm1, &done1](
+                Registered<data::FileSystemDataManager> registeredDataManager) {
+              ASSERT_TRUE(registeredDataManager->IsOpen());
+
+              rdm1 = std::move(registeredDataManager);
+
+              done1 = true;
+            },
+            [&done1](nsresult rejectValue) { done1 = true; });
+
+    bool done2 = false;
+
+    data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
+        Origin(kTestOriginName))
+        ->Then(
+            GetCurrentSerialEventTarget(), __func__,
+            [&rdm2, &done2](
+                Registered<data::FileSystemDataManager> registeredDataManager) {
+              ASSERT_TRUE(registeredDataManager->IsOpen());
+
+              rdm2 = std::move(registeredDataManager);
+
+              done2 = true;
+            },
+            [&done2](nsresult rejectValue) { done2 = true; });
+
+    SpinEventLoopUntil("Promise is fulfilled"_ns,
+                       [&done1, &done2]() { return done1 && done2; });
+  }
+
+  RefPtr<data::FileSystemDataManager> dm1 = rdm1.unwrap();
+
+  RefPtr<data::FileSystemDataManager> dm2 = rdm2.unwrap();
+
+  {
+    bool done1 = false;
+
+    dm1->OnClose()->Then(
+        GetCurrentSerialEventTarget(), __func__,
+        [&done1](const BoolPromise::ResolveOrRejectValue&) { done1 = true; });
+
+    bool done2 = false;
+
+    dm2->OnClose()->Then(
+        GetCurrentSerialEventTarget(), __func__,
+        [&done2](const BoolPromise::ResolveOrRejectValue&) { done2 = true; });
+
+    SpinEventLoopUntil("Promise is fulfilled"_ns,
+                       [&done1, &done2]() { return done1 && done2; });
+  }
+}
+
+TEST(TestFileSystemDataManager, GetOrCreateFileSystemDataManager_PendingClose)
+{
+  Registered<data::FileSystemDataManager> rdm;
+
+  {
+    bool done = false;
+
+    data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
+        Origin(kTestOriginName))
+        ->Then(
+            GetCurrentSerialEventTarget(), __func__,
+            [&rdm, &done](
+                Registered<data::FileSystemDataManager> registeredDataManager) {
+              ASSERT_TRUE(registeredDataManager->IsOpen());
+
+              rdm = std::move(registeredDataManager);
+
+              done = true;
+            },
+            [&done](nsresult rejectValue) { done = true; });
+
+    SpinEventLoopUntil("Promise is fulfilled"_ns, [&done]() { return done; });
+  }
+
+  RefPtr<data::FileSystemDataManager> dm = rdm.unwrap();
+
+  Unused << dm;
+
+  {
+    bool done = false;
+
+    data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
+        Origin(kTestOriginName))
+        ->Then(
+            GetCurrentSerialEventTarget(), __func__,
+            [](Registered<data::FileSystemDataManager> registeredDataManager) {
+              RefPtr<data::FileSystemDataManager> dataManager =
+                  registeredDataManager.get();
+
+              registeredDataManager = nullptr;
+
+              return dataManager->OnClose();
+            },
+            [](nsresult rejectValue) {
+              return BoolPromise::CreateAndReject(rejectValue, __func__);
+            })
+        ->Then(
+            GetCurrentSerialEventTarget(), __func__,
+            [&done](const BoolPromise::ResolveOrRejectValue&) { done = true; });
+
+    SpinEventLoopUntil("Promise is fulfilled"_ns, [&done]() { return done; });
+  }
+}
+
 }  // namespace mozilla::dom::fs::test
