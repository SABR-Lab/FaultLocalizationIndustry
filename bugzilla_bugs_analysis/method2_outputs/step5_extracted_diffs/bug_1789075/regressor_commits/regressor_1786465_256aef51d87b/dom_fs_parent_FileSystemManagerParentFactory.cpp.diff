# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/FileSystemManagerParentFactory.cpp
# Commit: 256aef51d87b
# Full Hash: 256aef51d87b1ab1733d8d4fb306a03674b6c22b
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 3
# Description:
#   Bug 1786465 - Move TaskQueue ownership from FileSystemManagerParent to FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   After this change, we will create only one task queue per origin.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D155554
# ==============================================================================

diff -r cfa7bbd206c3 -r 256aef51d87b dom/fs/parent/FileSystemManagerParentFactory.cpp
--- a/dom/fs/parent/FileSystemManagerParentFactory.cpp	Wed Aug 31 09:34:55 2022 +0000
+++ b/dom/fs/parent/FileSystemManagerParentFactory.cpp	Wed Aug 31 09:34:55 2022 +0000
@@ -14,8 +14,6 @@
 #include "mozilla/dom/quota/QuotaManager.h"
 #include "mozilla/ipc/Endpoint.h"
 #include "nsIScriptObjectPrincipal.h"
-#include "nsNetCID.h"
-#include "nsServiceManagerUtils.h"
 #include "nsString.h"
 
 namespace mozilla {
@@ -60,29 +58,21 @@
 
   nsCOMPtr<nsIThread> pbackground = NS_GetCurrentThread();
 
-  nsCOMPtr<nsIEventTarget> target =
-      do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID);
-  MOZ_ASSERT(target);
-
-  nsCString name("OPFS ");
-  name += origin;
-  RefPtr<TaskQueue> taskqueue =
-      TaskQueue::Create(target.forget(), PromiseFlatCString(name).get());
   // We'll have to thread-hop back to this thread to respond.  We could
   // just have the create be one-way, then send the actual request on the
   // new channel, but that's an extra IPC instead.
-  InvokeAsync(
-      taskqueue, __func__,
-      [origin, parentEp = std::move(aParentEndpoint), aResolver, rootId,
-       dataManager = std::move(dataManager), taskqueue, pbackground]() mutable {
-        RefPtr<FileSystemManagerParent> parent = new FileSystemManagerParent(
-            taskqueue, std::move(dataManager), rootId);
-        if (!parentEp.Bind(parent)) {
-          return BoolPromise::CreateAndReject(NS_ERROR_FAILURE, __func__);
-        }
-        // Send response back to pbackground to send to child
-        return BoolPromise::CreateAndResolve(true, __func__);
-      })
+  InvokeAsync(dataManager->MutableIOTargetPtr(), __func__,
+              [origin, parentEp = std::move(aParentEndpoint), aResolver, rootId,
+               dataManager = dataManager, pbackground]() mutable {
+                RefPtr<FileSystemManagerParent> parent =
+                    new FileSystemManagerParent(std::move(dataManager), rootId);
+                if (!parentEp.Bind(parent)) {
+                  return BoolPromise::CreateAndReject(NS_ERROR_FAILURE,
+                                                      __func__);
+                }
+                // Send response back to pbackground to send to child
+                return BoolPromise::CreateAndResolve(true, __func__);
+              })
       ->Then(GetCurrentSerialEventTarget(), __func__,
              [aResolver](const BoolPromise::ResolveOrRejectValue& aValue) {
                if (aValue.IsReject()) {