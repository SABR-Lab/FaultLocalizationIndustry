# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/datamodel/FileSystemDataManager.cpp
# Commit: 256aef51d87b
# Full Hash: 256aef51d87b1ab1733d8d4fb306a03674b6c22b
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 3
# Description:
#   Bug 1786465 - Move TaskQueue ownership from FileSystemManagerParent to FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   After this change, we will create only one task queue per origin.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D155554
# ==============================================================================

diff -r cfa7bbd206c3 -r 256aef51d87b dom/fs/parent/datamodel/FileSystemDataManager.cpp
--- a/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:55 2022 +0000
+++ b/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:55 2022 +0000
@@ -8,8 +8,12 @@
 
 #include "mozilla/Result.h"
 #include "mozilla/StaticPtr.h"
+#include "mozilla/dom/quota/QuotaCommon.h"
+#include "mozilla/dom/quota/ResultExtensions.h"
 #include "nsBaseHashtable.h"
 #include "nsHashKeys.h"
+#include "nsNetCID.h"
+#include "nsServiceManagerUtils.h"
 #include "nsThreadUtils.h"
 
 namespace mozilla::dom::fs::data {
@@ -78,11 +82,15 @@
 
 }  // namespace
 
-FileSystemDataManager::FileSystemDataManager(const Origin& aOrigin)
+FileSystemDataManager::FileSystemDataManager(
+    const Origin& aOrigin, MovingNotNull<RefPtr<TaskQueue>> aIOTaskQueue)
     : mOrigin(aOrigin),
-      mBackgroundTarget(WrapNotNull(GetCurrentSerialEventTarget())) {}
+      mBackgroundTarget(WrapNotNull(GetCurrentSerialEventTarget())),
+      mIOTaskQueue(std::move(aIOTaskQueue)) {}
 
 FileSystemDataManager::~FileSystemDataManager() {
+  mIOTaskQueue->BeginShutdown();
+
   RemoveFileSystemDataManager(mOrigin);
 }
 
@@ -93,7 +101,18 @@
     return dataManager;
   }
 
-  auto dataManager = MakeRefPtr<FileSystemDataManager>(aOrigin);
+  QM_TRY_UNWRAP(auto streamTransportService,
+                MOZ_TO_RESULT_GET_TYPED(nsCOMPtr<nsIEventTarget>,
+                                        MOZ_SELECT_OVERLOAD(do_GetService),
+                                        NS_STREAMTRANSPORTSERVICE_CONTRACTID));
+
+  nsCString taskQueueName("OPFS "_ns + aOrigin);
+
+  RefPtr<TaskQueue> ioTaskQueue =
+      TaskQueue::Create(streamTransportService.forget(), taskQueueName.get());
+
+  auto dataManager = MakeRefPtr<FileSystemDataManager>(
+      aOrigin, WrapMovingNotNull(ioTaskQueue));
 
   AddFileSystemDataManager(aOrigin, dataManager);
 