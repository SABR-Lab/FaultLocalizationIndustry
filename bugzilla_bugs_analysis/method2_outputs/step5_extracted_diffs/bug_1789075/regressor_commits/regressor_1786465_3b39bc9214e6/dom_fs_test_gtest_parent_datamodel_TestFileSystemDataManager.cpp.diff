# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp
# Commit: 3b39bc9214e6
# Full Hash: 3b39bc9214e650428b728f27d377377dcbc1d62d
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 2
# Description:
#   Bug 1786465 - Add support for asynchronous creation of FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D155788
# ==============================================================================

diff -r 6d1f25188b13 -r 3b39bc9214e6 dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp
--- a/dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp	Wed Aug 31 09:34:58 2022 +0000
+++ b/dom/fs/test/gtest/parent/datamodel/TestFileSystemDataManager.cpp	Wed Aug 31 09:34:58 2022 +0000
@@ -7,7 +7,6 @@
 #include "FileSystemDataManager.h"
 #include "gtest/gtest.h"
 #include "mozilla/SpinEventLoopUntil.h"
-#include "TestHelpers.h"
 
 namespace mozilla::dom::fs::test {
 
@@ -19,19 +18,26 @@
 
 TEST(TestFileSystemDataManager, GetOrCreateFileSystemDataManager)
 {
-  TEST_TRY_UNWRAP(Registered<data::FileSystemDataManager> registeredDataManager,
-                  data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
-                      Origin(kTestOriginName)));
-
-  RefPtr<data::FileSystemDataManager> dataManager = registeredDataManager.get();
-
-  registeredDataManager = nullptr;
-
   bool done = false;
 
-  dataManager->OnClose()->Then(
-      GetCurrentSerialEventTarget(), __func__,
-      [&done](const BoolPromise::ResolveOrRejectValue&) { done = true; });
+  data::FileSystemDataManager::GetOrCreateFileSystemDataManager(
+      Origin(kTestOriginName))
+      ->Then(
+          GetCurrentSerialEventTarget(), __func__,
+          [](Registered<data::FileSystemDataManager> registeredDataManager) {
+            RefPtr<data::FileSystemDataManager> dataManager =
+                registeredDataManager.get();
+
+            registeredDataManager = nullptr;
+
+            return dataManager->OnClose();
+          },
+          [](nsresult rejectValue) {
+            return BoolPromise::CreateAndReject(rejectValue, __func__);
+          })
+      ->Then(
+          GetCurrentSerialEventTarget(), __func__,
+          [&done](const BoolPromise::ResolveOrRejectValue&) { done = true; });
 
   SpinEventLoopUntil("Promise is fulfilled"_ns, [&done]() { return done; });
 }
