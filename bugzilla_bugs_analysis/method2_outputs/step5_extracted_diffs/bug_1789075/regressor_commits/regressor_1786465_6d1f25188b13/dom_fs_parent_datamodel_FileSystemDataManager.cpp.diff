# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/parent/datamodel/FileSystemDataManager.cpp
# Commit: 6d1f25188b13
# Full Hash: 6d1f25188b13f5c88f36bcb32caa2b74216f81ab
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-08-31 21:54:47
# Regressor Bug: 1786465
# File Overlap Count: 2
# Description:
#   Bug 1786465 - Add support for asynchronous closing of FileSystemDataManager; r=dom-storage-reviewers,jesup
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D155787
# ==============================================================================

diff -r 0256861a7ac5 -r 6d1f25188b13 dom/fs/parent/datamodel/FileSystemDataManager.cpp
--- a/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:57 2022 +0000
+++ b/dom/fs/parent/datamodel/FileSystemDataManager.cpp	Wed Aug 31 09:34:58 2022 +0000
@@ -98,6 +98,8 @@
 FileSystemDataManager::GetOrCreateFileSystemDataManager(const Origin& aOrigin) {
   if (RefPtr<FileSystemDataManager> dataManager =
           GetFileSystemDataManager(aOrigin)) {
+    // XXX Handle the case when the manager is asynchronouslly closing!
+
     return Registered<FileSystemDataManager>(std::move(dataManager));
   }
 
@@ -127,7 +129,7 @@
   mRegCount--;
 
   if (IsInactive()) {
-    Close();
+    BeginClose();
   }
 }
 
@@ -145,23 +147,44 @@
   mActors.Remove(aActor);
 
   if (IsInactive()) {
-    Close();
+    BeginClose();
   }
 }
 
+RefPtr<BoolPromise> FileSystemDataManager::OnClose() {
+  MOZ_ASSERT(mState == State::Closing);
+
+  return mClosePromiseHolder.Ensure(__func__);
+}
+
 bool FileSystemDataManager::IsInactive() const {
   return !mRegCount && !mActors.Count();
 }
 
-void FileSystemDataManager::Close() {
+RefPtr<BoolPromise> FileSystemDataManager::BeginClose() {
   MOZ_ASSERT(mState == State::Initial);
   MOZ_ASSERT(IsInactive());
 
-  mState = State::Closed;
+  mState = State::Closing;
 
-  mIOTaskQueue->BeginShutdown();
+  InvokeAsync(MutableIOTargetPtr(), __func__,
+              []() { return BoolPromise::CreateAndResolve(true, __func__); })
+      ->Then(MutableBackgroundTargetPtr(), __func__,
+             [self = RefPtr<FileSystemDataManager>(this)](
+                 const BoolPromise::ResolveOrRejectValue&) {
+               return self->mIOTaskQueue->BeginShutdown();
+             })
+      ->Then(MutableBackgroundTargetPtr(), __func__,
+             [self = RefPtr<FileSystemDataManager>(this)](
+                 const ShutdownPromise::ResolveOrRejectValue&) {
+               RemoveFileSystemDataManager(self->mOrigin);
 
-  RemoveFileSystemDataManager(mOrigin);
+               self->mState = State::Closed;
+
+               self->mClosePromiseHolder.ResolveIfExists(true, __func__);
+             });
+
+  return OnClose();
 }
 
 }  // namespace mozilla::dom::fs::data