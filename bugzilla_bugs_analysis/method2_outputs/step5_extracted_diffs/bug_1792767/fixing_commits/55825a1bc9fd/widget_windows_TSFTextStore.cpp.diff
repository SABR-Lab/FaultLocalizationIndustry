# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: widget/windows/TSFTextStore.cpp
# Commit: 55825a1bc9fd
# Full Hash: 55825a1bc9fd5ca8e1568dd1bee6325ccd6127ed
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-09-30 09:35:36
# Description:
#   Bug 1774317 - part 3: Fix forgotten member initializing of `TSFTextStore` r=m_kato
#   
#   The crash tracked in bug 1792767 is caused by uninitialized member of
#   `TSFTextStore`.  Therefore, it runs the cleaning up the TSF objects at
#   setting focus to new `TSFTextStore`, but MS-IME didn't grab the necessary
# ==============================================================================

diff -r 1808f59fe299 -r 55825a1bc9fd widget/windows/TSFTextStore.cpp
--- a/widget/windows/TSFTextStore.cpp	Thu Sep 29 14:06:03 2022 +0000
+++ b/widget/windows/TSFTextStore.cpp	Thu Sep 29 14:06:03 2022 +0000
@@ -28,7 +28,6 @@
 #include "mozilla/WindowsVersion.h"
 #include "nsWindow.h"
 #include "nsPrintfCString.h"
-#include "nsReadableUtils.h"  // for VoidString()
 
 // Workaround for mingw32
 #ifndef TS_SD_INPUTPANEMANUALDISPLAYENABLE
@@ -4097,13 +4096,13 @@
         StaticPrefs::intl_tsf_expose_url_allowed() &&
         (!mInPrivateBrowsing ||
          StaticPrefs::intl_tsf_expose_url_in_private_browsing_allowed());
-    if (!allowed) {
-      MOZ_ASSERT(EmptyString().get());
-      return ::SysAllocString(EmptyString().get());
-    }
-    if (mDocumentURL.IsEmpty()) {
-      MOZ_ASSERT(EmptyString().get());
-      return ::SysAllocString(EmptyString().get());
+    if (!allowed || mDocumentURL.IsEmpty()) {
+      BSTR emptyString = ::SysAllocString(L"");
+      MOZ_ASSERT(
+          emptyString,
+          "We need to return valid BSTR pointer to notify TSF of supporting it "
+          "with a pointer to empty string");
+      return emptyString;
     }
     return ::SysAllocString(mDocumentURL.get());
   };