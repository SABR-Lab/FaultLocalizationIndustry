# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/loader/ScriptLoadRequest.cpp
# Commit: 00e555156df1
# Full Hash: 00e555156df1b498565fae94f2b04357baabca24
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-11-05 09:23:50
# Description:
#   Bug 1798667 - clear cache when finished with service worker scripts; r=asuth
#   
#   I was over eager in introducing the strong pointers to WorkerLoadContext. It turns out that
#   previously when we were cycle collecting our ScriptLoadRequests, we were also cleaning up everything
#   related to WorkerLoadContext. Also, in an attempt to fix the cancellation for workers, We
# ==============================================================================

diff -r dce99b798fd5 -r 00e555156df1 js/loader/ScriptLoadRequest.cpp
--- a/js/loader/ScriptLoadRequest.cpp	Fri Nov 04 14:55:16 2022 +0000
+++ b/js/loader/ScriptLoadRequest.cpp	Fri Nov 04 15:04:27 2022 +0000
@@ -116,10 +116,10 @@
     GetScriptLoadContext()->MaybeCancelOffThreadScript();
   }
   if (HasWorkerLoadContext()) {
-    // Steal and let the worker load context go out of scope, we
-    // no longer need it.
-    RefPtr<mozilla::dom::WorkerLoadContext> droppedContext =
-        StealWorkerLoadContext();
+    // The back reference needs to be cleared for workers, as there is no CC.
+    // However, we don't want to remove our pointer to the worker load
+    // context as it is used to determine load failure information.
+    GetWorkerLoadContext()->mRequest = nullptr;
   }
 }
 
