# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/loader/ScriptLoadRequest.h
# Commit: 5f483f0b842a
# Full Hash: 5f483f0b842afdfad82ea041256f9d8bce37f421
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-11-02 04:41:32
# Regressor Bug: 1797327
# File Overlap Count: 3
# Description:
#   Bug 1797327 - Use RefPtrs for all WorkerLoadContexts; r=asuth
#   
#   As WorkerLoadContexts now inherit from a non-CC'd loadContextBase, we have two outcomes.
#   1) we need to break cycles with ScriptLoadRequests manually, so that ScriptLoadRequests can be collected (ScriptLoadRequests must be CC'd).
#   2) we can now have refptrs to WorkerLoadContexts in the CacheLoadHandler and NetworkLoadHandler classes, and remove any remaining raw pointers to ScriptLoadRequest/WorkerLoadContext. There are cases where the NetworkLoadHandler or CacheLoadHandler might outlive the Worker Loader, so having refpointers here should help us recover in those cases.
# ==============================================================================

diff -r 7ade701781f5 -r 5f483f0b842a js/loader/ScriptLoadRequest.h
--- a/js/loader/ScriptLoadRequest.h	Tue Nov 01 18:03:34 2022 +0000
+++ b/js/loader/ScriptLoadRequest.h	Tue Nov 01 18:03:34 2022 +0000
@@ -305,13 +305,15 @@
   void DropBytecodeCacheReferences();
 
   bool HasLoadContext() const { return mLoadContext; }
+  bool HasScriptLoadContext() const;
+  bool HasWorkerLoadContext() const;
 
-  bool HasScriptLoadContext() const;
   mozilla::dom::ScriptLoadContext* GetScriptLoadContext();
 
   mozilla::loader::ComponentLoadContext* GetComponentLoadContext();
 
   mozilla::dom::WorkerLoadContext* GetWorkerLoadContext();
+  already_AddRefed<mozilla::dom::WorkerLoadContext> StealWorkerLoadContext();
 
   const ScriptKind mKind;  // Whether this is a classic script or a module
                            // script.
