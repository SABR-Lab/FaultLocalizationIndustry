# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/gc/Marking.cpp
# Commit: 8be86d9e2f18
# Full Hash: 8be86d9e2f186c5c34a6c572bdec07ba13c7d9a6
# Author: Jon Coppeard <jcoppeard@mozilla.com>
# Date: 2022-10-28 04:43:55
# Regressor Bug: 1797755
# File Overlap Count: 1
# Description:
#   Bug 1797755 - Part 2: Make delayed marking colors work like normal marking r=sfink
#   
#   Currently the way mark colors work for delayed marking doesn't align with
#   normal marking for gray marking of GC things that can only be marked black
#   (e.g. strings).
# ==============================================================================

diff -r 9a3821fa6bb8 -r 8be86d9e2f18 js/src/gc/Marking.cpp
--- a/js/src/gc/Marking.cpp	Thu Oct 27 18:23:02 2022 +0000
+++ b/js/src/gc/Marking.cpp	Thu Oct 27 18:23:02 2022 +0000
@@ -2009,21 +2009,20 @@
     markLaterArenas++;
 #endif
   }
-  JS::TraceKind kind = MapAllocToTraceKind(arena->getAllocKind());
-  MarkColor colorToMark =
-      TraceKindCanBeMarkedGray(kind) ? markColor() : MarkColor::Black;
-  if (!arena->hasDelayedMarking(colorToMark)) {
-    arena->setHasDelayedMarking(colorToMark, true);
+
+  if (!arena->hasDelayedMarking(markColor())) {
+    arena->setHasDelayedMarking(markColor(), true);
     delayedMarkingWorkAdded = true;
   }
 }
 
 void GCMarker::markDelayedChildren(Arena* arena) {
   JS::TraceKind kind = MapAllocToTraceKind(arena->getAllocKind());
-  MOZ_ASSERT_IF(markColor() == MarkColor::Gray, TraceKindCanBeMarkedGray(kind));
+  MarkColor colorToCheck =
+      TraceKindCanBeMarkedGray(kind) ? markColor() : MarkColor::Black;
 
   for (ArenaCellIterUnderGC cell(arena); !cell.done(); cell.next()) {
-    if (cell->isMarked(markColor())) {
+    if (cell->isMarked(colorToCheck)) {
       JS::TraceChildren(this, JS::GCCellPtr(cell, kind));
     }
   }
