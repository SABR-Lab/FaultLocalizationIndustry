# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/loader/CacheLoadHandler.cpp
# Commit: 1034aeb0f8e2
# Full Hash: 1034aeb0f8e2d86ea04d8e6a8c717f13c9d772eb
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-11-18 15:46:32
# Regressor Bug: 1800496
# File Overlap Count: 2
# Description:
#   Bug 1800496 - Revert mCacheCreator to being defined as part of ScriptLoaderRunnable; r=asuth
#   
#   Previously, in the cancellation refactor, we removed knowledge of the list of scripts being loaded on the main thread. As a result of this, we could no longer clear the cache creator on the main thread after iterating over all requests. We can now do that once again, and it simplifies the code.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D162220
# ==============================================================================

diff -r dfe78c41e4eb -r 1034aeb0f8e2 dom/workers/loader/CacheLoadHandler.cpp
--- a/dom/workers/loader/CacheLoadHandler.cpp	Fri Nov 18 10:02:28 2022 +0000
+++ b/dom/workers/loader/CacheLoadHandler.cpp	Fri Nov 18 10:02:28 2022 +0000
@@ -85,7 +85,7 @@
 
   // This will delete the cache object and will call LoadingFinished() with an
   // error for each ongoing operation.
-  auto cacheCreator = loadContext->GetCacheCreator();
+  auto* cacheCreator = mRequestHandle->GetCacheCreator();
   if (cacheCreator) {
     cacheCreator->DeleteCache(NS_ERROR_FAILURE);
   }
@@ -425,11 +425,10 @@
     loadContext->mCacheStatus = WorkerLoadContext::Cached;
 
     if (mRequestHandle->IsCancelled()) {
-      auto cacheCreator = loadContext->GetCacheCreator();
+      auto* cacheCreator = mRequestHandle->GetCacheCreator();
       if (cacheCreator) {
         cacheCreator->DeleteCache(mRequestHandle->GetCancelResult());
       }
-      loadContext->ClearCacheCreator();
       return;
     }
 
@@ -437,7 +436,6 @@
         (uint8_t*)"", 0, mChannelInfo, std::move(mPrincipalInfo),
         mCSPHeaderValue, mCSPReportOnlyHeaderValue, mReferrerPolicyHeaderValue);
 
-    loadContext->ClearCacheCreator();
     mRequestHandle->OnStreamComplete(rv);
     return;
   }