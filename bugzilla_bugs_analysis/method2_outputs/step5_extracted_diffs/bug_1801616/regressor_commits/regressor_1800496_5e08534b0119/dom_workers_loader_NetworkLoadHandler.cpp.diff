# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/loader/NetworkLoadHandler.cpp
# Commit: 5e08534b0119
# Full Hash: 5e08534b01198760e3521c7600504a32870de1c4
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-11-18 15:46:32
# Regressor Bug: 1800496
# File Overlap Count: 2
# Description:
#   Bug 1800496 - Re-introduce ScriptLoaderRunnable; r=asuth
#   
#   The ScriptLoaderRunnable used to do double duty as both the runnable used to load a script, and as the data structure to hold on to loading information (what kind of worker, debugger status, etc, if we failed). The second half of these responsibilities remains with the WorkerScriptLoader. WorkerScriptLoader acts as a persistent data structure. ScriptLoaderRunnable is per batch of requests (such as ImportScripts, or a single module load). It works together with the ThreadSafeRequestHandle to load the script.
#   
#   In the future, when we move to a single threaded implementation, ThreadSafeRequestHandle will likely be merged with WorkerLoadContext, but ScriptLoaderRunnable will stay as a datastructure to represent the batched request, and most of the existing fields (mSyncTarget, the request list) will stay. There is still some massaging to do here, but it gets closer to a final vision of how this should look.
# ==============================================================================

diff -r 3605681ebb5c -r 5e08534b0119 dom/workers/loader/NetworkLoadHandler.cpp
--- a/dom/workers/loader/NetworkLoadHandler.cpp	Fri Nov 18 10:02:27 2022 +0000
+++ b/dom/workers/loader/NetworkLoadHandler.cpp	Fri Nov 18 10:02:27 2022 +0000
@@ -56,7 +56,7 @@
   // If we have cancelled, or we have no mRequest, it means that the loader has
   // shut down and we can exit early. If the cancel result is still NS_OK
   nsresult rv = DataReceivedFromNetwork(aLoader, aStatus, aStringLen, aString);
-  return mLoader->OnStreamComplete(mRequestHandle, rv);
+  return mRequestHandle->OnStreamComplete(rv);
 }
 
 nsresult NetworkLoadHandler::DataReceivedFromNetwork(nsIStreamLoader* aLoader,
@@ -77,8 +77,8 @@
     return aStatus;
   }
 
-  if (mLoader->IsCancelled()) {
-    return mLoader->GetCancelResult();
+  if (mRequestHandle->IsCancelled()) {
+    return mRequestHandle->GetCancelResult();
   }
 
   NS_ASSERTION(aString, "This should never be null!");
@@ -290,7 +290,7 @@
 
   // If one load info cancels or hits an error, it can race with the start
   // callback coming from another load info.
-  if (mLoader->IsCancelled()) {
+  if (mRequestHandle->IsCancelled()) {
     return NS_ERROR_FAILURE;
   }
 