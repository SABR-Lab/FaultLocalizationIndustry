# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/ScriptLoader.h
# Commit: 9a5e5a1b529d
# Full Hash: 9a5e5a1b529de42db783dc6f8720488c34b28c6e
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-11-18 15:46:32
# Regressor Bug: 1800496
# File Overlap Count: 2
# Description:
#   Bug 1800496 - Introduce ThreadSafeRequestHandle; r=asuth
#   
#   This introduces a new datastructure that wraps the ScriptLoadRequest. Previously, we were using the WorkerLoadContext to access the request, and we made it not cycle collected in order to make it safe across threads. This, of course, broke module behavior, as the cycle needs to be broken in more places, and things get rather complex.
#   
#   In the spirit of making everyone's life easier, the ThreadSafeRequestHandle exists as a way to move the request to the main thread, operate on it, and then return it to the worker. We no longer need to track and free the WorkerLoadContext. Once the ThreadSafeRequestHandle is returned to the worker, we release the request, and the handle is empty. There is a possibility that this will cause issues, so we should keep an eye on this. Alternatively, we can never release the ScriptLoadRequest and let the ThreadSafeRequestHandle clean it up on destruction.
# ==============================================================================

diff -r 879667e24ed7 -r 9a5e5a1b529d dom/workers/ScriptLoader.h
--- a/dom/workers/ScriptLoader.h	Fri Nov 18 10:02:25 2022 +0000
+++ b/dom/workers/ScriptLoader.h	Fri Nov 18 10:02:25 2022 +0000
@@ -10,6 +10,7 @@
 #include "js/loader/ScriptLoadRequest.h"
 #include "js/loader/ModuleLoaderBase.h"
 #include "mozilla/dom/WorkerCommon.h"
+#include "mozilla/dom/WorkerLoadContext.h"
 #include "mozilla/dom/WorkerRef.h"
 #include "mozilla/Maybe.h"
 #include "nsIContentPolicy.h"
@@ -168,7 +169,7 @@
                      WorkerScriptType aWorkerScriptType, ErrorResult& aRv);
 
   void CancelMainThreadWithBindingAborted(
-      nsTArray<WorkerLoadContext*>&& aContextList);
+      nsTArray<ThreadSafeRequestHandle*>&& aContextList);
 
   void CreateScriptRequests(const nsTArray<nsString>& aScriptURLs,
                             const mozilla::Encoding* aDocumentEncoding,
@@ -187,7 +188,7 @@
 
   nsIURI* GetInitialBaseURI();
 
-  void MaybeExecuteFinishedScripts(ScriptLoadRequest* aRequest);
+  void MaybeExecuteFinishedScripts(ThreadSafeRequestHandle* aRequestHandle);
 
   void MaybeMoveToLoadedList(ScriptLoadRequest* aRequest);
 
@@ -199,7 +200,8 @@
     return mLoadingRequests.isEmpty() && mLoadedRequests.isEmpty();
   }
 
-  nsresult OnStreamComplete(ScriptLoadRequest* aRequest, nsresult aStatus);
+  nsresult OnStreamComplete(ThreadSafeRequestHandle* aRequestHandle,
+                            nsresult aStatus);
 
   bool IsDebuggerScript() const { return mWorkerScriptType == DebuggerScript; }
 
@@ -216,11 +218,11 @@
   }
 
   void CancelMainThread(nsresult aCancelResult,
-                        nsTArray<WorkerLoadContext*>* aContextList);
+                        nsTArray<ThreadSafeRequestHandle*>* aContextList);
 
-  nsresult LoadScripts(nsTArray<WorkerLoadContext*>&& aContextList);
+  nsresult LoadScripts(nsTArray<ThreadSafeRequestHandle*>&& aContextList);
 
-  nsresult LoadScript(ScriptLoadRequest* aRequest);
+  nsresult LoadScript(ThreadSafeRequestHandle* aRequestHandle);
 
   void ShutdownScriptLoader(bool aResult, bool aMutedError);
 
@@ -239,15 +241,14 @@
 
   void DispatchAbruptShutdown();
 
-  nsTArray<WorkerLoadContext*> GetLoadingList();
+  nsTArray<ThreadSafeRequestHandle*> GetLoadingList();
 
   nsIGlobalObject* GetGlobal();
 
-  void LoadingFinished(ScriptLoadRequest* aRequest, nsresult aRv);
+  void LoadingFinished(ThreadSafeRequestHandle* aRequestHandle, nsresult aRv);
 
-  void DispatchMaybeMoveToLoadedList(ScriptLoadRequest* aRequest);
+  void DispatchMaybeMoveToLoadedList(ThreadSafeRequestHandle* aRequestHandle);
 
-  bool HasLoadErrors(WorkerLoadContext* aLoadContext);
   bool EvaluateScript(JSContext* aCx, ScriptLoadRequest* aRequest);
 
   nsresult FillCompileOptionsForRequest(