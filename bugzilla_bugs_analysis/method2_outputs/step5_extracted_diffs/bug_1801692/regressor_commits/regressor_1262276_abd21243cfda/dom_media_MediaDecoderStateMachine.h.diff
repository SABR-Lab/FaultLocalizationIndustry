# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/MediaDecoderStateMachine.h
# Commit: abd21243cfda
# Full Hash: abd21243cfda241d4eae6022ebb4d8105772487d
# Author: alwu <alwu@mozilla.com>
# Date: 2022-11-05 21:53:50
# Regressor Bug: 1262276
# File Overlap Count: 1
# Description:
#   Bug 1262276 - part10 : bypass skip to the next frame until media loops back. r=padenot
#   
#   We don't want to trigger skip-to-next-keyframe after reaching video
#   EOS. Because now we've reset the demuxer to 0, and are going to request
#   data from start.
# ==============================================================================

diff -r d122b10f03ad -r abd21243cfda dom/media/MediaDecoderStateMachine.h
--- a/dom/media/MediaDecoderStateMachine.h	Sat Nov 05 02:23:32 2022 +0000
+++ b/dom/media/MediaDecoderStateMachine.h	Sat Nov 05 02:23:32 2022 +0000
@@ -524,6 +524,19 @@
   // Current playback position in the stream in bytes.
   int64_t mPlaybackOffset = 0;
 
+  // For seamless looping video, we don't want to trigger skip-to-next-keyframe
+  // after reaching video EOS. Because we've reset the demuxer to 0, and are
+  // going to request data from start. If playback hasn't looped back, the media
+  // time would still be too large, which makes the reader think the playback is
+  // way behind and performs unnecessary skipping. Eg. Media is 10s long,
+  // reaching EOS at 8s, requesting data at 9s. Assume media's keyframe interval
+  // is 3s, which means keyframes will appear on 0s, 3s, 6s and 9s. If we use
+  // current time as a threshold, the reader sees the next key frame is 3s but
+  // the threashold is 9s, which usually happens when the decoding is too slow.
+  // But that is not the case for us, we should by pass thskip-to-next-keyframe
+  // logic until the media loops back.
+  bool mBypassingSkipToNextKeyFrameCheck = false;
+
  private:
   // Audio stream name
   Mirror<nsAutoString> mStreamName;
