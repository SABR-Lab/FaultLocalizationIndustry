# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: netwerk/base/nsTransportUtils.cpp
# Commit: 5f10387aa113
# Full Hash: 5f10387aa113634100553d4894a80471e00552e5
# Author: Dana Keeler <dkeeler@mozilla.com>
# Date: 2022-12-23 04:32:51
# Description:
#   Bug 1801703 - rework the event to destruct mTransport in ~nsTransportStatusEvent r=kershaw,necko-reviewers
#   
#   It seems like the intermittent failures may have been due to the lambda that
#   destructs mTransport being copied rather than moved.
#   
# ==============================================================================

diff -r 555efa0ad1f0 -r 5f10387aa113 netwerk/base/nsTransportUtils.cpp
--- a/netwerk/base/nsTransportUtils.cpp	Thu Dec 22 22:17:01 2022 +0000
+++ b/netwerk/base/nsTransportUtils.cpp	Thu Dec 22 22:17:25 2022 +0000
@@ -57,14 +57,10 @@
         mProgressMax(progressMax) {}
 
   ~nsTransportStatusEvent() {
-    auto ReleaseTransport = [transport(std::move(mTransport))]() mutable {
-      transport = nullptr;
-    };
-    if (OnSocketThread()) {
-      ReleaseTransport();
-    } else {
+    auto ReleaseTransport = [transport(std::move(mTransport))]() mutable {};
+    if (!OnSocketThread()) {
       gSocketTransportService->Dispatch(NS_NewRunnableFunction(
-          "nsHttpConnection::~nsHttpConnection", ReleaseTransport));
+          "nsHttpConnection::~nsHttpConnection", std::move(ReleaseTransport)));
     }
   }
 
