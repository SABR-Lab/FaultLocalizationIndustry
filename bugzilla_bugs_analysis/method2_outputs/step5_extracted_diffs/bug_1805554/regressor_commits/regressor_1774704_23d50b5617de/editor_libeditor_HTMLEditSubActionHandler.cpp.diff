# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: editor/libeditor/HTMLEditSubActionHandler.cpp
# Commit: 23d50b5617de
# Full Hash: 23d50b5617def9d4152023fd98210c0a9723e3c0
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-08-04 04:34:13
# Regressor Bug: 1774704
# File Overlap Count: 1
# Description:
#   Bug 1774704 - part 4-3: Make `HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction` stop computing editing host with current selection r=m_kato
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D152968
# ==============================================================================

diff -r 310cd44cff95 -r 23d50b5617de editor/libeditor/HTMLEditSubActionHandler.cpp
--- a/editor/libeditor/HTMLEditSubActionHandler.cpp	Thu Aug 04 02:02:46 2022 +0000
+++ b/editor/libeditor/HTMLEditSubActionHandler.cpp	Thu Aug 04 02:12:03 2022 +0000
@@ -8401,7 +8401,8 @@
 }
 
 SplitNodeResult HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction(
-    nsAtom& aTag, const EditorDOMPoint& aStartOfDeepestRightNode) {
+    nsAtom& aTag, const EditorDOMPoint& aStartOfDeepestRightNode,
+    const Element& aEditingHost) {
   MOZ_ASSERT(IsEditActionDataAvailable());
 
   if (NS_WARN_IF(!aStartOfDeepestRightNode.IsSet())) {
@@ -8409,15 +8410,11 @@
   }
   MOZ_ASSERT(aStartOfDeepestRightNode.IsSetAndValid());
 
-  RefPtr<Element> host = ComputeEditingHost();
-  if (NS_WARN_IF(!host)) {
-    return SplitNodeResult(NS_ERROR_FAILURE);
-  }
-
   // The point must be descendant of editing host.
-  if (aStartOfDeepestRightNode.GetContainer() != host &&
+  // XXX Isn't it a valid case if it points a direct child of aEditingHost?
+  if (aStartOfDeepestRightNode.GetContainer() != &aEditingHost &&
       !EditorUtils::IsDescendantOf(*aStartOfDeepestRightNode.GetContainer(),
-                                   *host)) {
+                                   aEditingHost)) {
     NS_WARNING("aStartOfDeepestRightNode was not in editing host");
     return SplitNodeResult(NS_ERROR_INVALID_ARG);
   }
@@ -8428,7 +8425,7 @@
        pointToInsert.Set(pointToInsert.GetContainer())) {
     // We cannot split active editing host and its ancestor.  So, there is
     // no element to contain the specified element.
-    if (pointToInsert.GetChild() == host) {
+    if (pointToInsert.GetChild() == &aEditingHost) {
       NS_WARNING(
           "HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction() reached "
           "editing host");
@@ -8469,7 +8466,8 @@
   MOZ_ASSERT(aPointToInsert.IsSetAndValid());
 
   const SplitNodeResult splitNodeResult =
-      MaybeSplitAncestorsForInsertWithTransaction(aTagName, aPointToInsert);
+      MaybeSplitAncestorsForInsertWithTransaction(aTagName, aPointToInsert,
+                                                  aEditingHost);
   if (splitNodeResult.isErr()) {
     NS_WARNING(
         "HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction() failed");
@@ -10295,7 +10293,7 @@
           //     element at end of the <div> element.
           const SplitNodeResult splitNodeResult =
               MaybeSplitAncestorsForInsertWithTransaction(
-                  MOZ_KnownLive(*ULOrOLOrDLTagName), atContent);
+                  MOZ_KnownLive(*ULOrOLOrDLTagName), atContent, aEditingHost);
           if (splitNodeResult.isOk()) {
             NS_WARNING(
                 "HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction() "
@@ -10405,7 +10403,7 @@
           //     element at end of the <div> element.
           const SplitNodeResult splitNodeResult =
               MaybeSplitAncestorsForInsertWithTransaction(
-                  MOZ_KnownLive(*containerName), atListItem);
+                  MOZ_KnownLive(*containerName), atListItem, aEditingHost);
           if (splitNodeResult.isErr()) {
             NS_WARNING(
                 "HTMLEditor::MaybeSplitAncestorsForInsertWithTransaction() "