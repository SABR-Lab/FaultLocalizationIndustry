# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: editor/libeditor/HTMLAbsPositionEditor.cpp
# Commit: f9d7d41f5043
# Full Hash: f9d7d41f5043cd5e17ebd2e81daeda1a99d78fe0
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2022-08-04 09:46:07
# Regressor Bug: 1774704
# File Overlap Count: 1
# Description:
#   Bug 1774704 - part 7-1: Make `HTMLEditor::EnsureHardLineBeginsWithFirstChildOf` and `HTMLEditor::EnsureHardLineEndsWithLastChildOf` stop touching `Selection` directly r=m_kato
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D152974
# ==============================================================================

diff -r 1e9e0b9b8536 -r f9d7d41f5043 editor/libeditor/HTMLAbsPositionEditor.cpp
--- a/editor/libeditor/HTMLAbsPositionEditor.cpp	Thu Aug 04 04:07:46 2022 +0000
+++ b/editor/libeditor/HTMLAbsPositionEditor.cpp	Thu Aug 04 04:19:46 2022 +0000
@@ -816,31 +816,50 @@
     return NS_OK;
   }
 
+  EditorDOMPoint pointToPutCaret;
   // Make sure the first fild and last child of aElement starts/ends hard
   // line(s) even after removing `aElement`.
-  // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
-  // by the caller because of MOZ_CAN_RUN_SCRIPT method.
-  rv = EnsureHardLineBeginsWithFirstChildOf(MOZ_KnownLive(*styledElement));
-  if (NS_FAILED(rv)) {
-    NS_WARNING("HTMLEditor::EnsureHardLineBeginsWithFirstChildOf() failed");
-    return rv;
+  {
+    // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
+    // by the caller because of MOZ_CAN_RUN_SCRIPT method.
+    CreateElementResult maybeInsertBRElementBeforeFirstChildResult =
+        EnsureHardLineBeginsWithFirstChildOf(MOZ_KnownLive(*styledElement));
+    if (maybeInsertBRElementBeforeFirstChildResult.isErr()) {
+      NS_WARNING("HTMLEditor::EnsureHardLineBeginsWithFirstChildOf() failed");
+      return maybeInsertBRElementBeforeFirstChildResult.unwrapErr();
+    }
+    if (maybeInsertBRElementBeforeFirstChildResult.HasCaretPointSuggestion()) {
+      pointToPutCaret =
+          maybeInsertBRElementBeforeFirstChildResult.UnwrapCaretPoint();
+    }
   }
-  // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
-  // by the caller because of MOZ_CAN_RUN_SCRIPT method.
-  rv = EnsureHardLineEndsWithLastChildOf(MOZ_KnownLive(*styledElement));
-  if (NS_FAILED(rv)) {
-    NS_WARNING("HTMLEditor::EnsureHardLineEndsWithLastChildOf() failed");
-    return rv;
+  {
+    // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
+    // by the caller because of MOZ_CAN_RUN_SCRIPT method.
+    CreateElementResult maybeInsertBRElementAfterLastChildResult =
+        EnsureHardLineEndsWithLastChildOf(MOZ_KnownLive(*styledElement));
+    if (maybeInsertBRElementAfterLastChildResult.isErr()) {
+      NS_WARNING("HTMLEditor::EnsureHardLineEndsWithLastChildOf() failed");
+      return maybeInsertBRElementAfterLastChildResult.unwrapErr();
+    }
+    if (maybeInsertBRElementAfterLastChildResult.HasCaretPointSuggestion()) {
+      pointToPutCaret =
+          maybeInsertBRElementAfterLastChildResult.UnwrapCaretPoint();
+    }
   }
-  // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
-  // by the caller because of MOZ_CAN_RUN_SCRIPT method.
-  const Result<EditorDOMPoint, nsresult> unwrapStyledElementResult =
-      RemoveContainerWithTransaction(MOZ_KnownLive(*styledElement));
-  if (MOZ_UNLIKELY(unwrapStyledElementResult.isErr())) {
-    NS_WARNING("HTMLEditor::RemoveContainerWithTransaction() failed");
-    return unwrapStyledElementResult.inspectErr();
+  {
+    // MOZ_KnownLive(*styledElement): aElement's lifetime must be guarantted
+    // by the caller because of MOZ_CAN_RUN_SCRIPT method.
+    Result<EditorDOMPoint, nsresult> unwrapStyledElementResult =
+        RemoveContainerWithTransaction(MOZ_KnownLive(*styledElement));
+    if (MOZ_UNLIKELY(unwrapStyledElementResult.isErr())) {
+      NS_WARNING("HTMLEditor::RemoveContainerWithTransaction() failed");
+      return unwrapStyledElementResult.unwrapErr();
+    }
+    if (unwrapStyledElementResult.inspect().IsSet()) {
+      pointToPutCaret = unwrapStyledElementResult.unwrap();
+    }
   }
-  const EditorDOMPoint& pointToPutCaret = unwrapStyledElementResult.inspect();
   if (!AllowsTransactionsToChangeSelection() || !pointToPutCaret.IsSet()) {
     return NS_OK;
   }