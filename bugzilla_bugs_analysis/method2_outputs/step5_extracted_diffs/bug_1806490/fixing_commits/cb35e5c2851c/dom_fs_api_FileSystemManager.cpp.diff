# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/fs/api/FileSystemManager.cpp
# Commit: cb35e5c2851c
# Full Hash: cb35e5c2851c84fb955b7c94ae209824a20b7d15
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2023-01-17 16:13:02
# Description:
#   Bug 1806490 - Make it possible to track all CreateFileSystemManagerChild requests in FileSystemManager; r=dom-storage-reviewers,jari
#   
#   It can happen that BeginRequest is called multiple times when the actor doesn't
#   exist yet. Such situations can't be handled by a single MozPromiseRequestHolder.
#   
# ==============================================================================

diff -r e939a80b5b75 -r cb35e5c2851c dom/fs/api/FileSystemManager.cpp
--- a/dom/fs/api/FileSystemManager.cpp	Mon Jan 16 14:46:14 2023 +0000
+++ b/dom/fs/api/FileSystemManager.cpp	Mon Jan 16 14:46:20 2023 +0000
@@ -12,6 +12,7 @@
 #include "mozilla/dom/FileSystemManagerChild.h"
 #include "mozilla/dom/Promise.h"
 #include "mozilla/dom/StorageManager.h"
+#include "mozilla/dom/fs/ManagedMozPromiseRequestHolder.h"
 #include "mozilla/dom/quota/QuotaCommon.h"
 #include "mozilla/dom/quota/ResultExtensions.h"
 
@@ -54,7 +55,20 @@
 
   mBackgroundRequestHandler->Shutdown();
 
-  mCreateFileSystemManagerChildPromiseRequestHolder.DisconnectIfExists();
+  for (RefPtr<PromiseRequestHolder<BoolPromise>> holder :
+       mPromiseRequestHolders.ForwardRange()) {
+    holder->DisconnectIfExists();
+  }
+}
+
+void FileSystemManager::RegisterPromiseRequestHolder(
+    PromiseRequestHolder<BoolPromise>* aHolder) {
+  mPromiseRequestHolders.AppendElement(aHolder);
+}
+
+void FileSystemManager::UnregisterPromiseRequestHolder(
+    PromiseRequestHolder<BoolPromise>* aHolder) {
+  mPromiseRequestHolders.RemoveElement(aHolder);
 }
 
 void FileSystemManager::BeginRequest(
@@ -78,22 +92,23 @@
   QM_TRY_INSPECT(const auto& principalInfo, mGlobal->GetStorageKey(), QM_VOID,
                  [&aFailure](nsresult rv) { aFailure(rv); });
 
+  auto holder = MakeRefPtr<PromiseRequestHolder<BoolPromise>>(this);
+
   mBackgroundRequestHandler->CreateFileSystemManagerChild(principalInfo)
-      ->Then(
-          GetCurrentSerialEventTarget(), __func__,
-          [self = RefPtr<FileSystemManager>(this),
-           success = std::move(aSuccess), failure = std::move(aFailure)](
-              const BoolPromise::ResolveOrRejectValue& aValue) {
-            self->mCreateFileSystemManagerChildPromiseRequestHolder.Complete();
+      ->Then(GetCurrentSerialEventTarget(), __func__,
+             [self = RefPtr<FileSystemManager>(this), holder,
+              success = std::move(aSuccess), failure = std::move(aFailure)](
+                 const BoolPromise::ResolveOrRejectValue& aValue) {
+               holder->Complete();
 
-            if (aValue.IsResolve()) {
-              success(self->mBackgroundRequestHandler
-                          ->FileSystemManagerChildStrongRef());
-            } else {
-              failure(aValue.RejectValue());
-            }
-          })
-      ->Track(mCreateFileSystemManagerChildPromiseRequestHolder);
+               if (aValue.IsResolve()) {
+                 success(self->mBackgroundRequestHandler
+                             ->FileSystemManagerChildStrongRef());
+               } else {
+                 failure(aValue.RejectValue());
+               }
+             })
+      ->Track(*holder);
 }
 
 already_AddRefed<Promise> FileSystemManager::GetDirectory(ErrorResult& aError) {