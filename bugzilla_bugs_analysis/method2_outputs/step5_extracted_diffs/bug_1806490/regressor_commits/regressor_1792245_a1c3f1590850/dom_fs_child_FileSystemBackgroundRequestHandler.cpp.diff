# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/child/FileSystemBackgroundRequestHandler.cpp
# Commit: a1c3f1590850
# Full Hash: a1c3f15908502273c13d28e50bc0448157f2d6f9
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-10-20 21:51:26
# Regressor Bug: 1792245
# File Overlap Count: 2
# Description:
#   Bug 1792245 - Improve FileSystemManager shutdown; r=dom-storage-reviewers,jesup
#   
#   Changes:
#   - new MozPromise requests are not created after shutdown
#   - existing MozPromise requests are disconnected during shutdown
# ==============================================================================

diff -r 214c4d6bf7f9 -r a1c3f1590850 dom/fs/child/FileSystemBackgroundRequestHandler.cpp
--- a/dom/fs/child/FileSystemBackgroundRequestHandler.cpp	Thu Oct 20 04:21:30 2022 +0000
+++ b/dom/fs/child/FileSystemBackgroundRequestHandler.cpp	Thu Oct 20 04:21:30 2022 +0000
@@ -31,9 +31,24 @@
     default;
 
 void FileSystemBackgroundRequestHandler::Shutdown() {
+  mShutdown.Flip();
+
   if (mFileSystemManagerChild) {
+    MOZ_ASSERT(!mCreatingFileSystemManagerChild);
+
     mFileSystemManagerChild->Shutdown();
+
     mFileSystemManagerChild = nullptr;
+
+    return;
+  }
+
+  if (mCreatingFileSystemManagerChild) {
+    MOZ_ASSERT(!mFileSystemManagerChild);
+
+    mCreateFileSystemManagerParentPromiseRequestHolder.Disconnect();
+
+    mCreatingFileSystemManagerChild = false;
   }
 }
 
@@ -46,6 +61,7 @@
 FileSystemBackgroundRequestHandler::CreateFileSystemManagerChild(
     const mozilla::ipc::PrincipalInfo& aPrincipalInfo) {
   MOZ_ASSERT(!mFileSystemManagerChild);
+  MOZ_ASSERT(!mShutdown);
 
   using mozilla::ipc::BackgroundChild;
   using mozilla::ipc::Endpoint;
@@ -71,9 +87,6 @@
 
     mCreatingFileSystemManagerChild = true;
 
-    // XXX do something (register with global?) so that we can Close() the actor
-    // before the event queue starts to shut down.  That will cancel all
-    // outstanding async requests (returns lambdas with errors).
     backgroundChild
         ->SendCreateFileSystemManagerParent(aPrincipalInfo,
                                             std::move(parentEndpoint))
@@ -81,6 +94,9 @@
             GetCurrentSerialEventTarget(), __func__,
             [self = RefPtr<FileSystemBackgroundRequestHandler>(this),
              child](nsresult rv) {
+              self->mCreateFileSystemManagerParentPromiseRequestHolder
+                  .Complete();
+
               self->mCreatingFileSystemManagerChild = false;
 
               if (NS_FAILED(rv)) {
@@ -95,11 +111,15 @@
             },
             [self = RefPtr<FileSystemBackgroundRequestHandler>(this)](
                 const mozilla::ipc::ResponseRejectReason&) {
+              self->mCreateFileSystemManagerParentPromiseRequestHolder
+                  .Complete();
+
               self->mCreatingFileSystemManagerChild = false;
 
               self->mCreateFileSystemManagerChildPromiseHolder.RejectIfExists(
                   NS_ERROR_FAILURE, __func__);
-            });
+            })
+        ->Track(mCreateFileSystemManagerParentPromiseRequestHolder);
   }
 
   return mCreateFileSystemManagerChildPromiseHolder.Ensure(__func__);