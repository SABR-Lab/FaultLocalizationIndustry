# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fs/test/gtest/child/TestFileSystemRequestHandler.cpp
# Commit: a1c3f1590850
# Full Hash: a1c3f15908502273c13d28e50bc0448157f2d6f9
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2022-10-20 21:51:26
# Regressor Bug: 1792245
# File Overlap Count: 2
# Description:
#   Bug 1792245 - Improve FileSystemManager shutdown; r=dom-storage-reviewers,jesup
#   
#   Changes:
#   - new MozPromise requests are not created after shutdown
#   - existing MozPromise requests are disconnected during shutdown
# ==============================================================================

diff -r 214c4d6bf7f9 -r a1c3f1590850 dom/fs/test/gtest/child/TestFileSystemRequestHandler.cpp
--- a/dom/fs/test/gtest/child/TestFileSystemRequestHandler.cpp	Thu Oct 20 04:21:30 2022 +0000
+++ b/dom/fs/test/gtest/child/TestFileSystemRequestHandler.cpp	Thu Oct 20 04:21:30 2022 +0000
@@ -55,6 +55,13 @@
     return result.forget();
   }
 
+  already_AddRefed<Promise> GetSimplePromise() {
+    IgnoredErrorResult rv;
+    RefPtr<Promise> result = Promise::Create(mGlobal, rv);
+
+    return result.forget();
+  }
+
   UniquePtr<FileSystemRequestHandler> GetFileSystemRequestHandler() {
     return MakeUnique<FileSystemRequestHandler>();
   }
@@ -93,6 +100,17 @@
                      [this]() { return mListener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isGetRootHandleBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->GetRootHandle(mManager, GetSimplePromise(),
+                                               error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 TEST_F(TestFileSystemRequestHandler, isGetDirectoryHandleSuccessful) {
   auto fakeResponse = [](const auto& /* aRequest */, auto&& aResolve,
                          auto&& /* aReject */) {
@@ -120,6 +138,17 @@
                      [this]() { return mListener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isGetDirectoryHandleBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->GetDirectoryHandle(
+      mManager, mChild, /* aCreate */ true, GetSimplePromise(), error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 TEST_F(TestFileSystemRequestHandler, isGetFileHandleSuccessful) {
   auto fakeResponse = [](const auto& /* aRequest */, auto&& aResolve,
                          auto&& /* aReject */) {
@@ -146,6 +175,17 @@
                      [this]() { return mListener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isGetFileHandleBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->GetFileHandle(
+      mManager, mChild, /* aCreate */ true, GetSimplePromise(), error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 TEST_F(TestFileSystemRequestHandler, isGetFileSuccessful) {
   auto fakeResponse = [](const auto& /* aRequest */, auto&& aResolve,
                          auto&& /* aReject */) {
@@ -194,6 +234,17 @@
                      [this]() { return mListener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isGetFileBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->GetFile(mManager, mEntry, GetSimplePromise(),
+                                         error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 TEST_F(TestFileSystemRequestHandler, isGetEntriesSuccessful) {
   auto fakeResponse = [](const auto& /* aRequest */, auto&& aResolve,
                          auto&& /* aReject */) {
@@ -230,6 +281,20 @@
                      [listener]() { return listener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isGetEntriesBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  RefPtr<FileSystemEntryMetadataArray> sink;
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->GetEntries(mManager, mEntry.entryId(),
+                                            /* aPage */ 0, GetSimplePromise(),
+                                            sink, error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 TEST_F(TestFileSystemRequestHandler, isRemoveEntrySuccessful) {
   auto fakeResponse = [](const auto& /* aRequest */, auto&& aResolve,
                          auto&& /* aReject */) {
@@ -255,4 +320,15 @@
                      [this]() { return mListener->IsDone(); });
 }
 
+TEST_F(TestFileSystemRequestHandler, isRemoveEntryBlockedAfterShutdown) {
+  mManager->Shutdown();
+
+  IgnoredErrorResult error;
+  GetFileSystemRequestHandler()->RemoveEntry(
+      mManager, mChild, /* aRecursive */ true, GetSimplePromise(), error);
+
+  ASSERT_TRUE(error.Failed());
+  ASSERT_TRUE(error.ErrorCodeIs(NS_ERROR_ILLEGAL_DURING_SHUTDOWN));
+}
+
 }  // namespace mozilla::dom::fs::test
