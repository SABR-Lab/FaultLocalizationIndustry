# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/base/RestyleManager.cpp
# Commit: 10b293db5106
# Full Hash: 10b293db510696dd28c8c25734f7ee4214cf57c4
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-12-24 09:06:45
# Description:
#   Bug 1806898 - Don't reflow elements with dirty styles to update container queries. r=dholbert
#   
#   If style is dirty, we'll do the CQ update after restyling inside the
#   while loop.
#   
# ==============================================================================

diff -r 0734671d309a -r 10b293db5106 layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp	Fri Dec 23 21:26:26 2022 +0000
+++ b/layout/base/RestyleManager.cpp	Fri Dec 23 21:55:40 2022 +0000
@@ -3088,8 +3088,10 @@
   // mActiveTimer and mMostRecentRefresh time.
   presContext->RefreshDriver()->MostRecentRefresh();
 
-  // This might post new restyles, so need to do it here.
-  {
+  if (!doc->GetServoRestyleRoot()) {
+    // This might post new restyles, so need to do it here. Don't do it if we're
+    // already going to restyle tho, so that we don't potentially reflow with
+    // dirty styling.
     presContext->UpdateContainerQueryStyles();
     presContext->FinishedContainerQueryUpdate();
   }