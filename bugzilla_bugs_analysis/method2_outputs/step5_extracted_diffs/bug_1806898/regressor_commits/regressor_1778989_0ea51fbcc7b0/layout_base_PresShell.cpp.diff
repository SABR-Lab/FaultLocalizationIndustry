# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/PresShell.cpp
# Commit: 0ea51fbcc7b0
# Full Hash: 0ea51fbcc7b0c3b09e25a5933bbe9f4f10cc3ae4
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-08-10 15:45:33
# Regressor Bug: 1778989
# File Overlap Count: 1
# Description:
#   Bug 1778989 - Add some basic container query interleaving. r=dholbert
#   
#   This is far from fully perfect (specially when dealing with nested
#   containers, we need to be smarter when updating there), but it's
#   incremental progress.
# ==============================================================================

diff -r 7c95dc77a749 -r 0ea51fbcc7b0 layout/base/PresShell.cpp
--- a/layout/base/PresShell.cpp	Wed Aug 10 14:34:51 2022 +0300
+++ b/layout/base/PresShell.cpp	Wed Aug 10 11:28:08 2022 +0000
@@ -4161,7 +4161,10 @@
 
   FlushType flushType =
       aInterruptible ? FlushType::InterruptibleLayout : FlushType::Layout;
-  if (shouldFlush && !mIsDestroying) {
+  if (shouldFlush && !mIsDestroying && nsContentUtils::IsSafeToRunScript()) {
+    // We don't want to flush when not allowed to run script (e.g., like when
+    // running container query updates), since that trivially executes script.
+    // We'll flush layout again at the end of that process if necessary.
     FlushPendingNotifications(flushType);
   }
 }
@@ -4376,8 +4379,7 @@
                           : FlushType::InterruptibleLayout) &&
         !mIsDestroying) {
       didLayoutFlush = true;
-      mFrameConstructor->RecalcQuotesAndCounters();
-      if (ProcessReflowCommands(flushType < FlushType::Layout)) {
+      if (DoFlushLayout(/* aInterruptible = */ flushType < FlushType::Layout)) {
         if (mContentToScrollTo) {
           DoScrollContentIntoView();
           if (mContentToScrollTo) {
@@ -9846,6 +9848,11 @@
   return !interrupted;
 }
 
+bool PresShell::DoFlushLayout(bool aInterruptible) {
+  mFrameConstructor->RecalcQuotesAndCounters();
+  return ProcessReflowCommands(aInterruptible);
+}
+
 void PresShell::WindowSizeMoveDone() {
   if (mPresContext) {
     EventStateManager::ClearGlobalActiveContent(nullptr);