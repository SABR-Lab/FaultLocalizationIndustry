# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/generic/nsIFrame.cpp
# Commit: 0ea51fbcc7b0
# Full Hash: 0ea51fbcc7b0c3b09e25a5933bbe9f4f10cc3ae4
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-08-10 15:45:33
# Regressor Bug: 1778989
# File Overlap Count: 1
# Description:
#   Bug 1778989 - Add some basic container query interleaving. r=dholbert
#   
#   This is far from fully perfect (specially when dealing with nested
#   containers, we need to be smarter when updating there), but it's
#   incremental progress.
# ==============================================================================

diff -r 7c95dc77a749 -r 0ea51fbcc7b0 layout/generic/nsIFrame.cpp
--- a/layout/generic/nsIFrame.cpp	Wed Aug 10 14:34:51 2022 +0300
+++ b/layout/generic/nsIFrame.cpp	Wed Aug 10 11:28:08 2022 +0000
@@ -721,6 +721,10 @@
     AddStateBits(NS_FRAME_MAY_BE_TRANSFORMED);
   }
 
+  if (disp->mContainerType) {
+    PresContext()->RegisterContainerQueryFrame(this);
+  }
+
   if (disp->IsContainLayout() && disp->GetContainSizeAxes().IsBoth() &&
       // All frames that support contain:layout also support contain:size.
       IsFrameOfType(eSupportsContainLayoutAndPaint) && !IsTableWrapperFrame()) {
@@ -801,14 +805,18 @@
 
   SVGObserverUtils::InvalidateDirectRenderingObservers(this);
 
-  if (StyleDisplay()->mPosition == StylePositionProperty::Sticky) {
-    StickyScrollContainer* ssc =
-        StickyScrollContainer::GetStickyScrollContainerForFrame(this);
-    if (ssc) {
+  const auto* disp = StyleDisplay();
+  if (disp->mPosition == StylePositionProperty::Sticky) {
+    if (auto* ssc =
+            StickyScrollContainer::GetStickyScrollContainerForFrame(this)) {
       ssc->RemoveFrame(this);
     }
   }
 
+  if (disp->mContainerType) {
+    PresContext()->UnregisterContainerQueryFrame(this);
+  }
+
   nsPresContext* presContext = PresContext();
   mozilla::PresShell* presShell = presContext->GetPresShell();
   if (mState & NS_FRAME_OUT_OF_FLOW) {