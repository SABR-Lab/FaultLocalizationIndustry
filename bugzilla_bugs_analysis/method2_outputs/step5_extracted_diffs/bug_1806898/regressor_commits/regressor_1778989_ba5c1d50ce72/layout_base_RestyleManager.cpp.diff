# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/RestyleManager.cpp
# Commit: ba5c1d50ce72
# Full Hash: ba5c1d50ce72828e54b397821429df63ef0c286f
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2022-08-09 21:31:27
# Regressor Bug: 1778989
# File Overlap Count: 1
# Description:
#   Bug 1778989 - Add some basic container query interleaving. r=dholbert
#   
#   This is far from fully perfect (specially when dealing with nested
#   containers, we need to be smarter when updating there), but it's
#   incremental progress.
# ==============================================================================

diff -r bf52569d96ca -r ba5c1d50ce72 layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp	Tue Aug 09 11:38:15 2022 +0000
+++ b/layout/base/RestyleManager.cpp	Tue Aug 09 11:44:39 2022 +0000
@@ -3055,6 +3055,12 @@
   // mActiveTimer and mMostRecentRefresh time.
   presContext->RefreshDriver()->MostRecentRefresh();
 
+  // This might post new restyles, so need to do it here.
+  {
+    presContext->UpdateContainerQueryStyles();
+    presContext->FinishedContainerQueryUpdate();
+  }
+
   // Perform the Servo traversal, and the post-traversal if required. We do this
   // in a loop because certain rare paths in the frame constructor can trigger
   // additional style invalidations.
@@ -3108,6 +3114,7 @@
     }
 
     doc->ClearServoRestyleRoot();
+    ClearSnapshots();
 
     // Process the change hints.
     //
@@ -3160,12 +3167,17 @@
       // case.
       IncrementRestyleGeneration();
     }
+
+    mInStyleRefresh = false;
+    presContext->UpdateContainerQueryStyles();
+    mInStyleRefresh = true;
   }
 
   doc->ClearServoRestyleRoot();
-
+  presContext->FinishedContainerQueryUpdate();
   ClearSnapshots();
   styleSet->AssertTreeIsClean();
+
   mHaveNonAnimationRestyles = false;
   mRestyleForCSSRuleChanges = false;
   mInStyleRefresh = false;