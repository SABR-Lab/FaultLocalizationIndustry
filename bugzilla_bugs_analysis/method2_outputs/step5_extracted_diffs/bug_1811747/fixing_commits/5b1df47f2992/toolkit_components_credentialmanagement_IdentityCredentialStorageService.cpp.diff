# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: toolkit/components/credentialmanagement/IdentityCredentialStorageService.cpp
# Commit: 5b1df47f2992
# Full Hash: 5b1df47f29928efbbe4f6c3e3aaec96572d5faba
# Author: Benjamin VanderSloot <bvandersloot@mozilla.com>
# Date: 2023-01-23 18:05:32
# Description:
#   Bug 1811747 - Fix Crash in [@ mozilla::IdentityCredentialStorageService::Observe] - r=timhuang
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D167549
# ==============================================================================

diff -r 0e4975937eac -r 5b1df47f2992 toolkit/components/credentialmanagement/IdentityCredentialStorageService.cpp
--- a/toolkit/components/credentialmanagement/IdentityCredentialStorageService.cpp	Mon Jan 23 13:54:34 2023 +0000
+++ b/toolkit/components/credentialmanagement/IdentityCredentialStorageService.cpp	Mon Jan 23 14:18:25 2023 +0000
@@ -815,20 +815,23 @@
   AssertIsOnMainThread();
   // Double check that we have the right topic.
   if (!nsCRT::strcmp(aTopic, "last-pb-context-exited")) {
-    nsCOMPtr<mozIStorageFunction> patternMatchFunction(
-        new PrivateBrowsingOriginSQLFunction());
-    nsresult rv = mMemoryDatabaseConnection->CreateFunction(
-        "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN"_ns, 1, patternMatchFunction);
-    NS_ENSURE_SUCCESS(rv, rv);
+    MonitorAutoLock lock(mMonitor);
+    if (mInitialized && mMemoryDatabaseConnection) {
+      nsCOMPtr<mozIStorageFunction> patternMatchFunction(
+          new PrivateBrowsingOriginSQLFunction());
+      nsresult rv = mMemoryDatabaseConnection->CreateFunction(
+          "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN"_ns, 1, patternMatchFunction);
+      NS_ENSURE_SUCCESS(rv, rv);
 
-    rv = mMemoryDatabaseConnection->ExecuteSimpleSQL(
-        "DELETE FROM identity WHERE "
-        "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN(rpOrigin);"_ns);
-    NS_ENSURE_SUCCESS(rv, rv);
+      rv = mMemoryDatabaseConnection->ExecuteSimpleSQL(
+          "DELETE FROM identity WHERE "
+          "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN(rpOrigin);"_ns);
+      NS_ENSURE_SUCCESS(rv, rv);
 
-    rv = mMemoryDatabaseConnection->RemoveFunction(
-        "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN"_ns);
-    NS_ENSURE_SUCCESS(rv, rv);
+      rv = mMemoryDatabaseConnection->RemoveFunction(
+          "PRIVATE_BROWSING_PATTERN_MATCH_ORIGIN"_ns);
+      NS_ENSURE_SUCCESS(rv, rv);
+    }
   }
   return NS_OK;
 }
