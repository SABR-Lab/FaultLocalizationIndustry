# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/credentialmanagement/IdentityCredentialStorageService.h
# Commit: 5da212f7823e
# Full Hash: 5da212f7823e6f844f21b3eb3eafdd61eee0fd01
# Author: Benjamin VanderSloot <bvandersloot@mozilla.com>
# Date: 2023-01-20 21:21:03
# Regressor Bug: 1802920
# File Overlap Count: 1
# Description:
#   Bug 1802920, part 3 - Change the semantics of the disk/memory storage - r=timhuang
#   
#   Memory is no longer just privite browsing data, now it is a cache.
#   This means we have to store more in it, but also that reads don't need to hit disk.
#   We also start using those new member variable databases here.
# ==============================================================================

diff -r 194527504304 -r 5da212f7823e toolkit/components/credentialmanagement/IdentityCredentialStorageService.h
--- a/toolkit/components/credentialmanagement/IdentityCredentialStorageService.h	Fri Jan 20 16:24:07 2023 +0000
+++ b/toolkit/components/credentialmanagement/IdentityCredentialStorageService.h	Fri Jan 20 16:24:07 2023 +0000
@@ -11,7 +11,9 @@
 #include "mozilla/AlreadyAddRefed.h"
 #include "mozilla/dom/FlippedOnce.h"
 #include "mozilla/Monitor.h"
+#include "mozilla/OriginAttributes.h"
 #include "mozIStorageConnection.h"
+#include "mozIStorageFunction.h"
 #include "nsIAsyncShutdown.h"
 #include "nsIIdentityCredentialStorageService.h"
 #include "nsIObserver.h"
@@ -88,6 +90,42 @@
   void IncrementPendingWrites();
   void DecrementPendingWrites();
 
+  // Helper functions for database writes.
+  //   We have helper functions here for all operations we perform on the
+  //   databases that invlolve writes. These are split out and take a connection
+  //   as an argument because we have to write to both the memory database and
+  //   the disk database, where we only read from the memory database after
+  //   initialization. See nsIIdentityCredentialStorageService.idl for more info
+  //   on these functions' semantics
+
+  // Upsert == Update or Insert! Uses some nice SQLite syntax to make this easy.
+  static nsresult UpsertData(mozIStorageConnection* aDatabaseConnection,
+                             nsIPrincipal* aRPPrincipal,
+                             nsIPrincipal* aIDPPrincipal,
+                             nsACString const& aCredentialID, bool aRegistered,
+                             bool aAllowLogout);
+
+  static nsresult DeleteData(mozIStorageConnection* aDatabaseConnection,
+                             nsIPrincipal* aRPPrincipal,
+                             nsIPrincipal* aIDPPrincipal,
+                             nsACString const& aCredentialID);
+
+  static nsresult ClearData(mozIStorageConnection* aDatabaseConnection);
+
+  static nsresult DeleteDataFromOriginAttributesPattern(
+      mozIStorageConnection* aDatabaseConnection,
+      OriginAttributesPattern const& aOriginAttributesPattern);
+
+  static nsresult DeleteDataFromTimeRange(
+      mozIStorageConnection* aDatabaseConnection, int64_t aStart, int64_t aEnd);
+
+  static nsresult DeleteDataFromPrincipal(
+      mozIStorageConnection* aDatabaseConnection, nsIPrincipal* aPrincipal);
+
+  static nsresult DeleteDataFromBaseDomain(
+      mozIStorageConnection* aDatabaseConnection,
+      nsACString const& aBaseDomain);
+
   // Database connections. Guaranteed to be non-null and working once
   // initialized and not-yet finalized
   RefPtr<mozIStorageConnection> mDiskDatabaseConnection;  // Worker thread only
@@ -111,10 +149,37 @@
   Monitor mMonitor;
   FlippedOnce<false> mInitialized MOZ_GUARDED_BY(mMonitor);
   FlippedOnce<false> mErrored MOZ_GUARDED_BY(mMonitor);
+  FlippedOnce<false> mShuttingDown MOZ_GUARDED_BY(mMonitor);
   FlippedOnce<false> mFinalized MOZ_GUARDED_BY(mMonitor);
   uint32_t mPendingWrites MOZ_GUARDED_BY(mMonitor);
 };
 
+class OriginAttrsPatternMatchOriginSQLFunction final
+    : public mozIStorageFunction {
+  NS_DECL_ISUPPORTS
+  NS_DECL_MOZISTORAGEFUNCTION
+
+  explicit OriginAttrsPatternMatchOriginSQLFunction(
+      OriginAttributesPattern const& aPattern)
+      : mPattern(aPattern) {}
+  OriginAttrsPatternMatchOriginSQLFunction() = delete;
+
+ private:
+  ~OriginAttrsPatternMatchOriginSQLFunction() = default;
+
+  OriginAttributesPattern mPattern;
+};
+
+class PrivateBrowsingOriginSQLFunction final : public mozIStorageFunction {
+  NS_DECL_ISUPPORTS
+  NS_DECL_MOZISTORAGEFUNCTION
+
+  PrivateBrowsingOriginSQLFunction() = default;
+
+ private:
+  ~PrivateBrowsingOriginSQLFunction() = default;
+};
+
 }  // namespace mozilla
 
 #endif /* MOZILLA_IDENTITYCREDENTIALSTORAGESERVICE_H_ */
