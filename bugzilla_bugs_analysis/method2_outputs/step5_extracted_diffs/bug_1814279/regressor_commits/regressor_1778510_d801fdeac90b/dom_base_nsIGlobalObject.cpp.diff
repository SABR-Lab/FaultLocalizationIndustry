# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/nsIGlobalObject.cpp
# Commit: d801fdeac90b
# Full Hash: d801fdeac90bc63de7f7efd090ced48bf871121a
# Author: Tom Ritter <tom@mozilla.com>
# Date: 2022-11-29 08:40:32
# Regressor Bug: 1778510
# File Overlap Count: 1
# Description:
#   Bug 1778510: Add RTPCallerType to GlobalObject r=asuth
#   
#   This centralizes the logic in one place.
#   
#   In order to do this, we will need to check the principal
# ==============================================================================

diff -r 5af032c628c0 -r d801fdeac90b dom/base/nsIGlobalObject.cpp
--- a/dom/base/nsIGlobalObject.cpp	Mon Nov 28 18:04:06 2022 +0000
+++ b/dom/base/nsIGlobalObject.cpp	Mon Nov 28 18:04:07 2022 +0000
@@ -5,6 +5,7 @@
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "nsIGlobalObject.h"
+#include "mozilla/BasePrincipal.h"
 #include "mozilla/CycleCollectedJSContext.h"
 #include "mozilla/Result.h"
 #include "mozilla/StorageAccess.h"
@@ -68,7 +69,7 @@
   MOZ_DIAGNOSTIC_ASSERT(mEventTargetObjects.isEmpty());
 }
 
-nsIPrincipal* nsIGlobalObject::PrincipalOrNull() {
+nsIPrincipal* nsIGlobalObject::PrincipalOrNull() const {
   if (!NS_IsMainThread()) {
     return nullptr;
   }
@@ -396,3 +397,26 @@
 
   return mozilla::ipc::StorageKeysEqual(storageKey, aStorageKey);
 }
+
+bool nsIGlobalObject::IsSystemPrincipal() const {
+  MOZ_ASSERT(NS_IsMainThread(),
+             "Cannot ask nsIGlobalObject IsSystemPrincipal off-main-thread");
+
+  return PrincipalOrNull()->IsSystemPrincipal();
+}
+
+RTPCallerType nsIGlobalObject::RTPCallerType() const {
+  if (IsSystemPrincipal()) {
+    return RTPCallerType::SystemPrincipal;
+  }
+
+  if (ShouldResistFingerprinting()) {
+    return RTPCallerType::ResistFingerprinting;
+  }
+
+  if (CrossOriginIsolated()) {
+    return RTPCallerType::CrossOriginIsolated;
+  }
+
+  return RTPCallerType::Normal;
+}