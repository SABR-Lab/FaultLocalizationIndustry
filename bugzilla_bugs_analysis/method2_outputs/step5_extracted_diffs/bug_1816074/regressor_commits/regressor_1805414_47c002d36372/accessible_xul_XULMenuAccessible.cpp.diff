# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/xul/XULMenuAccessible.cpp
# Commit: 47c002d36372
# Full Hash: 47c002d3637247e71ee901f32421deaecc9d8ea3
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-05 03:40:49
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 0c989b2bcd78 -r 47c002d36372 accessible/xul/XULMenuAccessible.cpp
--- a/accessible/xul/XULMenuAccessible.cpp	Wed Jan 04 18:28:34 2023 +0000
+++ b/accessible/xul/XULMenuAccessible.cpp	Wed Jan 04 19:01:13 2023 +0000
@@ -6,6 +6,9 @@
 #include "XULMenuAccessible.h"
 
 #include "LocalAccessible-inl.h"
+#include "XULMenuParentElement.h"
+#include "XULPopupElement.h"
+#include "mozilla/Assertions.h"
 #include "nsAccessibilityService.h"
 #include "nsAccUtils.h"
 #include "DocAccessible.h"
@@ -25,6 +28,7 @@
 #include "mozilla/LookAndFeel.h"
 #include "mozilla/dom/Document.h"
 #include "mozilla/dom/Element.h"
+#include "mozilla/dom/XULButtonElement.h"
 #include "mozilla/dom/KeyboardEventBinding.h"
 
 using namespace mozilla;
@@ -108,12 +112,11 @@
 uint64_t XULMenuitemAccessible::NativeInteractiveState() const {
   if (NativelyUnavailable()) {
     // Note: keep in sinc with nsXULPopupManager::IsValidMenuItem() logic.
+    auto* button = dom::XULButtonElement::FromNode(GetContent());
     bool skipNavigatingDisabledMenuItem = true;
-    nsMenuFrame* menuFrame = do_QueryFrame(GetFrame());
-    if (!menuFrame || !menuFrame->IsOnMenuBar()) {
-      skipNavigatingDisabledMenuItem =
-          LookAndFeel::GetInt(
-              LookAndFeel::IntID::SkipNavigatingDisabledMenuItem, 0) != 0;
+    if (!button || !button->IsOnMenuBar()) {
+      skipNavigatingDisabledMenuItem = LookAndFeel::GetInt(
+          LookAndFeel::IntID::SkipNavigatingDisabledMenuItem);
     }
 
     if (skipNavigatingDisabledMenuItem) return states::UNAVAILABLE;
@@ -279,28 +282,11 @@
 }
 
 LocalAccessible* XULMenuitemAccessible::ContainerWidget() const {
-  nsMenuFrame* menuFrame = do_QueryFrame(GetFrame());
-  if (menuFrame) {
-    nsMenuParent* menuParent = menuFrame->GetMenuParent();
-    if (menuParent) {
-      nsBoxFrame* frame = nullptr;
-      if (menuParent->IsMenuBar()) {  // menubar menu
-        frame = static_cast<nsMenuBarFrame*>(menuParent);
-      } else if (menuParent->IsMenu()) {  // a menupopup or parent menu item
-        frame = static_cast<nsMenuPopupFrame*>(menuParent);
-      }
-      if (frame) {
-        nsIContent* content = frame->GetContent();
-        if (content) {
-          MOZ_ASSERT(mDoc);
-          // We use GetAccessibleOrContainer instead of just GetAccessible
-          // because we strip menupopups from the tree for ATK.
-          return mDoc->GetAccessibleOrContainer(content);
-        }
-      }
-
-      // otherwise it's different kind of popups (like panel or tooltip), it
-      // shouldn't be a real case.
+  if (auto* button = dom::XULButtonElement::FromNode(GetContent())) {
+    if (auto* popup = button->GetMenuParent()) {
+      // We use GetAccessibleOrContainer instead of just GetAccessible because
+      // we strip menupopups from the tree for ATK.
+      return mDoc->GetAccessibleOrContainer(popup);
     }
   }
   return nullptr;
@@ -335,8 +321,11 @@
 XULMenupopupAccessible::XULMenupopupAccessible(nsIContent* aContent,
                                                DocAccessible* aDoc)
     : XULSelectControlAccessible(aContent, aDoc) {
-  nsMenuPopupFrame* menuPopupFrame = do_QueryFrame(GetFrame());
-  if (menuPopupFrame && menuPopupFrame->IsMenu()) mType = eMenuPopupType;
+  if (nsMenuPopupFrame* menuPopupFrame = do_QueryFrame(GetFrame())) {
+    if (menuPopupFrame->PopupType() == ePopupTypeMenu) {
+      mType = eMenuPopupType;
+    }
+  }
 
   // May be the anonymous <menupopup> inside <menulist> (a combobox)
   auto* parent = mContent->GetParentElement();
@@ -425,35 +414,34 @@
   DocAccessible* document = Document();
 
   nsMenuPopupFrame* menuPopupFrame = do_QueryFrame(GetFrame());
-  while (menuPopupFrame) {
-    LocalAccessible* menuPopup =
-        document->GetAccessible(menuPopupFrame->GetContent());
-    if (!menuPopup) {  // shouldn't be a real case
+  MOZ_ASSERT(menuPopupFrame);
+  if (!menuPopupFrame) {
+    return nullptr;
+  }
+
+  auto* cur = dom::XULPopupElement::FromNode(GetContent());
+  while (cur) {
+    auto* menu = cur->GetContainingMenu();
+    if (!menu) {
+      // <panel> / <tooltip> / etc.
       return nullptr;
     }
-
-    nsMenuFrame* menuFrame = do_QueryFrame(menuPopupFrame->GetParent());
-    if (!menuFrame) {  // context menu or popups
-      return nullptr;
+    dom::XULMenuParentElement* parent = menu->GetMenuParent();
+    if (!parent) {
+      LocalAccessible* menuPopup = document->GetAccessible(cur);
+      MOZ_ASSERT(menuPopup);
+      return menuPopup ? menuPopup->LocalParent() : nullptr;
     }
 
-    nsMenuParent* menuParent = menuFrame->GetMenuParent();
-    if (!menuParent) {  // menulist or menubutton
-      return menuPopup->LocalParent();
+    if (parent->IsMenuBar()) {
+      return document->GetAccessible(parent);
     }
 
-    if (menuParent->IsMenuBar()) {  // menubar menu
-      nsMenuBarFrame* menuBarFrame = static_cast<nsMenuBarFrame*>(menuParent);
-      return document->GetAccessible(menuBarFrame->GetContent());
-    }
-
-    // different kind of popups like panel or tooltip
-    if (!menuParent->IsMenu()) return nullptr;
-
-    menuPopupFrame = static_cast<nsMenuPopupFrame*>(menuParent);
+    cur = dom::XULPopupElement::FromNode(parent);
+    MOZ_ASSERT(cur, "Should be a popup");
   }
 
-  MOZ_ASSERT_UNREACHABLE("Shouldn't be a real case.");
+  MOZ_ASSERT_UNREACHABLE("How did we get out of the loop without returning?");
   return nullptr;
 }
 
@@ -483,15 +471,12 @@
 bool XULMenubarAccessible::AreItemsOperable() const { return true; }
 
 LocalAccessible* XULMenubarAccessible::CurrentItem() const {
-  nsMenuBarFrame* menuBarFrame = do_QueryFrame(GetFrame());
-  if (menuBarFrame) {
-    nsMenuFrame* menuFrame = menuBarFrame->GetCurrentMenuItem();
-    if (menuFrame) {
-      nsIContent* menuItemNode = menuFrame->GetContent();
-      return mDoc->GetAccessible(menuItemNode);
-    }
+  auto* content = dom::XULMenuParentElement::FromNode(GetContent());
+  MOZ_ASSERT(content);
+  if (!content || !content->GetActiveMenuChild()) {
+    return nullptr;
   }
-  return nullptr;
+  return mDoc->GetAccessible(content->GetActiveMenuChild());
 }
 
 void XULMenubarAccessible::SetCurrentItem(const LocalAccessible* aItem) {