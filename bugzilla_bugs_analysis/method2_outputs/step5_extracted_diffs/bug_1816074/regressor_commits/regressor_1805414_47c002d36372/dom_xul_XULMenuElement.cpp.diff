# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/XULMenuElement.cpp
# Commit: 47c002d36372
# Full Hash: 47c002d3637247e71ee901f32421deaecc9d8ea3
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-05 03:40:49
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 0c989b2bcd78 -r 47c002d36372 dom/xul/XULMenuElement.cpp
--- a/dom/xul/XULMenuElement.cpp	Wed Jan 04 18:28:34 2023 +0000
+++ b/dom/xul/XULMenuElement.cpp	Wed Jan 04 19:01:13 2023 +0000
@@ -4,17 +4,16 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+#include "mozilla/dom/XULMenuElement.h"
+#include "mozilla/StaticAnalysisFunctions.h"
+#include "mozilla/dom/XULButtonElement.h"
+#include "mozilla/dom/XULMenuElementBinding.h"
+#include "mozilla/dom/XULPopupElement.h"
 #include "mozilla/dom/KeyboardEvent.h"
 #include "mozilla/dom/KeyboardEventBinding.h"
-#include "mozilla/dom/Element.h"
-#include "nsIFrame.h"
-#include "nsMenuBarFrame.h"
 #include "nsMenuBarListener.h"
-#include "nsMenuFrame.h"
+#include "nsXULPopupManager.h"
 #include "nsMenuPopupFrame.h"
-#include "mozilla/dom/XULMenuElement.h"
-#include "mozilla/dom/XULMenuElementBinding.h"
-#include "nsXULPopupManager.h"
 
 namespace mozilla::dom {
 
@@ -23,25 +22,31 @@
   return XULMenuElement_Binding::Wrap(aCx, this, aGivenProto);
 }
 
-already_AddRefed<Element> XULMenuElement::GetActiveChild() {
-  nsMenuFrame* menu = do_QueryFrame(GetPrimaryFrame(FlushType::Frames));
-  if (menu) {
-    RefPtr<Element> el;
-    menu->GetActiveChild(getter_AddRefs(el));
-    return el.forget();
-  }
-  return nullptr;
+Element* XULMenuElement::GetActiveMenuChild() {
+  RefPtr popup = GetMenuPopupContent();
+  return popup ? popup->GetActiveMenuChild() : nullptr;
 }
 
-void XULMenuElement::SetActiveChild(Element* arg) {
-  nsMenuFrame* menu = do_QueryFrame(GetPrimaryFrame(FlushType::Frames));
-  if (menu) {
-    menu->SetActiveChild(arg);
+void XULMenuElement::SetActiveMenuChild(Element* aChild) {
+  RefPtr popup = GetMenuPopupContent();
+  if (NS_WARN_IF(!popup)) {
+    return;
   }
+
+  if (!aChild) {
+    popup->SetActiveMenuChild(nullptr);
+    return;
+  }
+  auto* button = XULButtonElement::FromNode(aChild);
+  if (NS_WARN_IF(!button) || NS_WARN_IF(!button->IsMenu())) {
+    return;
+  }
+  // KnownLive because it's aChild.
+  popup->SetActiveMenuChild(MOZ_KnownLive(button));
 }
 
-bool XULMenuElement::HandleKeyPress(KeyboardEvent& keyEvent) {
-  nsXULPopupManager* pm = nsXULPopupManager::GetInstance();
+bool XULButtonElement::HandleKeyPress(KeyboardEvent& keyEvent) {
+  RefPtr<nsXULPopupManager> pm = nsXULPopupManager::GetInstance();
   if (!pm) {
     return false;
   }
@@ -51,15 +56,12 @@
     return false;
   }
 
-  if (nsMenuBarListener::IsAccessKeyPressed(&keyEvent)) return false;
-
-  nsMenuFrame* menu = do_QueryFrame(GetPrimaryFrame(FlushType::Frames));
-  if (!menu) {
+  if (nsMenuBarListener::IsAccessKeyPressed(keyEvent)) {
     return false;
   }
 
-  nsMenuPopupFrame* popupFrame = menu->GetPopup();
-  if (!popupFrame) {
+  nsMenuPopupFrame* popupFrame = GetMenuPopup(FlushType::Frames);
+  if (NS_WARN_IF(!popupFrame)) {
     return false;
   }
 
@@ -74,25 +76,8 @@
       return pm->HandleKeyboardNavigationInPopup(popupFrame, theDirection);
     }
     default:
-      return pm->HandleShortcutNavigation(&keyEvent, popupFrame);
+      return pm->HandleShortcutNavigation(keyEvent, popupFrame);
   }
 }
 
-bool XULMenuElement::OpenedWithKey() {
-  nsMenuFrame* menuframe = do_QueryFrame(GetPrimaryFrame(FlushType::Frames));
-  if (!menuframe) {
-    return false;
-  }
-
-  nsIFrame* frame = menuframe->GetParent();
-  while (frame) {
-    nsMenuBarFrame* menubar = do_QueryFrame(frame);
-    if (menubar) {
-      return menubar->IsActiveByKeyboard();
-    }
-    frame = frame->GetParent();
-  }
-  return false;
-}
-
 }  // namespace mozilla::dom