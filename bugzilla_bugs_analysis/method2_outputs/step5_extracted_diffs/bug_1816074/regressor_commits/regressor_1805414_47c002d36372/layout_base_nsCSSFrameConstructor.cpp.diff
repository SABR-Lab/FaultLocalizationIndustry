# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsCSSFrameConstructor.cpp
# Commit: 47c002d36372
# Full Hash: 47c002d3637247e71ee901f32421deaecc9d8ea3
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-05 03:40:49
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 0c989b2bcd78 -r 47c002d36372 layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp	Wed Jan 04 18:28:34 2023 +0000
+++ b/layout/base/nsCSSFrameConstructor.cpp	Wed Jan 04 19:01:13 2023 +0000
@@ -202,7 +202,6 @@
 #  define NUM_DEBUG_FLAGS (sizeof(gFlags) / sizeof(gFlags[0]))
 #endif
 
-#include "nsMenuFrame.h"
 #include "nsTreeColFrame.h"
 
 //------------------------------------------------------------------
@@ -4152,15 +4151,10 @@
       SIMPLE_XUL_CREATE(image, NS_NewImageBoxFrame),
       SIMPLE_XUL_CREATE(treechildren, NS_NewTreeBodyFrame),
       SIMPLE_XUL_CREATE(treecol, NS_NewTreeColFrame),
-      SIMPLE_TAG_CHAIN(button, nsCSSFrameConstructor::FindXULButtonData),
-      SIMPLE_TAG_CHAIN(toolbarbutton, nsCSSFrameConstructor::FindXULButtonData),
       SIMPLE_TAG_CHAIN(label,
                        nsCSSFrameConstructor::FindXULLabelOrDescriptionData),
       SIMPLE_TAG_CHAIN(description,
                        nsCSSFrameConstructor::FindXULLabelOrDescriptionData),
-      SIMPLE_XUL_CREATE(menu, NS_NewMenuFrame),
-      SIMPLE_XUL_CREATE(menulist, NS_NewMenuFrame),
-      SIMPLE_XUL_CREATE(menuitem, NS_NewMenuItemFrame),
 #ifdef XP_MACOSX
       SIMPLE_TAG_CHAIN(menubar, nsCSSFrameConstructor::FindXULMenubarData),
 #else
@@ -4183,19 +4177,6 @@
 
 /* static */
 const nsCSSFrameConstructor::FrameConstructionData*
-nsCSSFrameConstructor::FindXULButtonData(const Element& aElement,
-                                         ComputedStyle&) {
-  static constexpr FrameConstructionData sXULMenuData =
-      SIMPLE_XUL_FCDATA(NS_NewMenuFrame);
-  if (aElement.AttrValueIs(kNameSpaceID_None, nsGkAtoms::type, nsGkAtoms::menu,
-                           eCaseMatters)) {
-    return &sXULMenuData;
-  }
-  return nullptr;
-}
-
-/* static */
-const nsCSSFrameConstructor::FrameConstructionData*
 nsCSSFrameConstructor::FindXULLabelOrDescriptionData(const Element& aElement,
                                                      ComputedStyle&) {
   // Follow CSS display value if no value attribute
@@ -5438,9 +5419,7 @@
     return;
   }
 
-  const bool isPopup =
-      (data->mBits & FCDATA_IS_POPUP) && (!aParentFrame ||  // Parent is inline
-                                          !aParentFrame->IsMenuFrame());
+  const bool isPopup = data->mBits & FCDATA_IS_POPUP;
 
   const uint32_t bits = data->mBits;
 
@@ -5932,17 +5911,13 @@
 bool nsCSSFrameConstructor::IsValidSibling(nsIFrame* aSibling,
                                            nsIContent* aContent,
                                            Maybe<StyleDisplay>& aDisplay) {
-  nsIFrame* parentFrame = aSibling->GetParent();
-  LayoutFrameType parentType = parentFrame->Type();
-
   StyleDisplay siblingDisplay = aSibling->GetDisplay();
   if (StyleDisplay::TableColumnGroup == siblingDisplay ||
       StyleDisplay::TableColumn == siblingDisplay ||
       StyleDisplay::TableCaption == siblingDisplay ||
       StyleDisplay::TableHeaderGroup == siblingDisplay ||
       StyleDisplay::TableRowGroup == siblingDisplay ||
-      StyleDisplay::TableFooterGroup == siblingDisplay ||
-      LayoutFrameType::Menu == parentType) {
+      StyleDisplay::TableFooterGroup == siblingDisplay) {
     // if we haven't already, resolve a style to find the display type of
     // aContent.
     if (aDisplay.isNothing()) {