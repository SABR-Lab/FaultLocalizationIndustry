# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: browser/components/places/tests/browser/browser_stayopenmenu.js
# Commit: f11c529b2407
# Full Hash: f11c529b240799df93c4dd8c17ecd8636f9b10de
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-04 09:43:05
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 11d72eaa9cd9 -r f11c529b2407 browser/components/places/tests/browser/browser_stayopenmenu.js
--- a/browser/components/places/tests/browser/browser_stayopenmenu.js	Tue Jan 03 21:55:14 2023 +0000
+++ b/browser/components/places/tests/browser/browser_stayopenmenu.js	Tue Jan 03 22:06:01 2023 +0000
@@ -9,6 +9,7 @@
     node => node.label == "Test1"
   );
   ok(testMenuitem, "Found test bookmark.");
+  ok(BrowserTestUtils.is_visible(testMenuitem), "Should be visible");
   let promiseTabOpened = BrowserTestUtils.waitForNewTab(gBrowser, null);
   EventUtils.synthesizeMouseAtCenter(testMenuitem, { accelKey: true });
   let newTab = await promiseTabOpened;
@@ -27,12 +28,14 @@
   });
   await promiseEvent;
   let promiseTabOpened = BrowserTestUtils.waitForNewTab(gBrowser, null);
+  let hidden = BrowserTestUtils.waitForEvent(cm, "popuphidden");
   cm.activateItem(doc.getElementById("placesContext_open:newtab"));
+  await hidden;
   let newTab = await promiseTabOpened;
   return newTab;
 }
 
-add_task(async function test_setup() {
+add_setup(async function() {
   // Ensure BMB is available in UI.
   let origBMBlocation = CustomizableUI.getPlacementOfWidget(
     "bookmarks-menu-button"