# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/nsXULPopupListener.cpp
# Commit: f11c529b2407
# Full Hash: f11c529b240799df93c4dd8c17ecd8636f9b10de
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-04 09:43:05
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 11d72eaa9cd9 -r f11c529b2407 dom/xul/nsXULPopupListener.cpp
--- a/dom/xul/nsXULPopupListener.cpp	Tue Jan 03 21:55:14 2023 +0000
+++ b/dom/xul/nsXULPopupListener.cpp	Tue Jan 03 22:06:01 2023 +0000
@@ -9,6 +9,7 @@
  */
 
 #include "nsXULPopupListener.h"
+#include "XULButtonElement.h"
 #include "nsCOMPtr.h"
 #include "nsGkAtoms.h"
 #include "nsContentCID.h"
@@ -37,7 +38,6 @@
 #include "nsPIDOMWindow.h"
 #include "nsViewManager.h"
 #include "nsError.h"
-#include "nsMenuFrame.h"
 
 using namespace mozilla;
 using namespace mozilla::dom;
@@ -248,14 +248,16 @@
   }
 
   // return if no popup was found or the popup is the element itself.
-  if (!popup || popup == mElement) return NS_OK;
+  if (!popup || popup == mElement) {
+    return NS_OK;
+  }
 
   // Submenus can't be used as context menus or popups, bug 288763.
   // Similar code also in nsXULTooltipListener::GetTooltipFor.
-  nsIContent* parent = popup->GetParent();
-  if (parent) {
-    nsMenuFrame* menu = do_QueryFrame(parent->GetPrimaryFrame());
-    if (menu) return NS_OK;
+  if (auto* button = XULButtonElement::FromNodeOrNull(popup->GetParent())) {
+    if (button->IsMenu()) {
+      return NS_OK;
+    }
   }
 
   nsXULPopupManager* pm = nsXULPopupManager::GetInstance();