# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/content/tests/widgets/window_menubar.xhtml
# Commit: f11c529b2407
# Full Hash: f11c529b240799df93c4dd8c17ecd8636f9b10de
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-04 09:43:05
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 11d72eaa9cd9 -r f11c529b2407 toolkit/content/tests/widgets/window_menubar.xhtml
--- a/toolkit/content/tests/widgets/window_menubar.xhtml	Tue Jan 03 21:55:14 2023 +0000
+++ b/toolkit/content/tests/widgets/window_menubar.xhtml	Tue Jan 03 22:06:01 2023 +0000
@@ -14,7 +14,7 @@
   Need to investigate these tests a bit more. Some of the accessibility events
   are firing multiple times or in different orders in different circumstances.
   Note that this was also the case before bug 279703.
-  -->
+-->
 
 <hbox style="margin-left: 275px; margin-top: 275px;">
 <menubar id="menubar">
@@ -89,35 +89,39 @@
   startPopupTests(popupTests);
 }, window);
 
+const kIsWindows = navigator.platform.indexOf("Win") == 0;
+const kIsLinux = navigator.platform.includes("Linux");
+
 // On Linux, the first menu opens when F10 is pressed, but on other platforms
 // the menubar is focused but no menu is opened. This means that different events
 // fire.
 function pressF10Events()
 {
-  return navigator.platform.includes("Linux") ?
+  return kIsLinux ?
     [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu", "popupshowing filepopup", "popupshown filepopup"] :
     [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ];
 }
 
-function closeAfterF10Events(extraInactive)
+function closeAfterF10Events()
 {
-  if (navigator.platform.includes("Linux")) {
-    var events = [ "popuphiding filepopup", "popuphidden filepopup",
-                   "DOMMenuInactive filepopup", "DOMMenuBarInactive menubar",
-                   "DOMMenuItemInactive filemenu" ];
-    if (extraInactive)
-      events.push("DOMMenuItemInactive filemenu");
-    return events;
+  if (kIsLinux) {
+    return [
+      "popuphiding filepopup",
+      "popuphidden filepopup",
+      "DOMMenuInactive filepopup",
+      "DOMMenuItemInactive filemenu",
+      "DOMMenuBarInactive menubar",
+    ];
   }
 
-  return [ "DOMMenuBarInactive menubar", "DOMMenuItemInactive filemenu" ];
+  return [ "DOMMenuItemInactive filemenu", "DOMMenuBarInactive menubar" ];
 }
 
 var popupTests = [
 {
   testname: "press on menu",
-  events: [ "popupshowing filepopup", "DOMMenuBarActive menubar",
-            "DOMMenuItemActive filemenu", "popupshown filepopup" ],
+  events: [ "DOMMenuBarActive menubar",
+            "DOMMenuItemActive filemenu", "popupshowing filepopup", "popupshown filepopup" ],
   test() { synthesizeMouse(document.getElementById("filemenu"), 8, 8, { }); },
   result (testname) {
     checkActive(gFilePopup, "", testname);
@@ -172,24 +176,23 @@
       "DOMMenuItemInactive filemenu", "DOMMenuItemActive editmenu",
       "popuphiding filepopup", "popuphidden filepopup",
       // the popupshowing event gets fired when showing the edit menu.
-      // The item from the file menu doesn't get deactivated until the
-      // next item needs to be selected
-      "popupshowing editpopup", "DOMMenuItemInactive item1",
-      // not sure why the menu inactivated event is firing so late
-      "DOMMenuInactive filepopup"
+      "popupshowing editpopup",
+      "DOMMenuItemInactive item1",
+      "DOMMenuInactive filepopup",
     ];
     // finally, the first item is activated and popupshown is fired.
     // On Windows, don't skip disabled items.
-    if (navigator.platform.indexOf("Win") == 0)
+    if (kIsWindows) {
       elist.push("DOMMenuItemActive cut");
-    else
+    } else {
       elist.push("DOMMenuItemActive copy");
+    }
     elist.push("popupshown editpopup");
     return elist;
   },
   test() { synthesizeKey("KEY_ArrowRight"); },
   result(testname) {
-    var expected = (navigator.platform.indexOf("Win") == 0) ? "cut" : "copy";
+    var expected = kIsWindows ? "cut" : "copy";
     checkActive(document.getElementById("editpopup"), expected, testname);
     checkClosed("filemenu", testname);
     checkOpen("editmenu", testname);
@@ -201,16 +204,24 @@
   // the menu but not fire a command event
   testname: "enter on disabled",
   events() {
-    if (navigator.platform.indexOf("Win") == 0)
-      return [ "popuphiding editpopup", "popuphidden editpopup",
-               "DOMMenuItemInactive cut", "DOMMenuInactive editpopup",
-               "DOMMenuBarInactive menubar",
-               "DOMMenuItemInactive editmenu", "DOMMenuItemInactive editmenu" ];
-      return [ "DOMMenuItemInactive copy", "DOMMenuInactive editpopup",
-               "DOMMenuBarInactive menubar",
-               "DOMMenuItemInactive editmenu", "DOMMenuItemInactive editmenu",
-               "command copy", "popuphiding editpopup", "popuphidden editpopup",
-               "DOMMenuItemInactive copy" ];
+    if (kIsWindows) {
+      return [
+        "popuphiding editpopup",
+        "popuphidden editpopup",
+        "DOMMenuItemInactive cut",
+        "DOMMenuInactive editpopup",
+        "DOMMenuItemInactive editmenu",
+        "DOMMenuBarInactive menubar",
+      ];
+    }
+    return [
+      "DOMMenuItemInactive copy",
+      "DOMMenuInactive editpopup",
+      "DOMMenuItemInactive editmenu",
+      "DOMMenuBarInactive menubar",
+      "command copy",
+      "popuphiding editpopup", "popuphidden editpopup",
+    ];
   },
   test() { synthesizeKey("KEY_Enter"); },
   result(testname) {
@@ -222,9 +233,13 @@
   // pressing Alt + a key should open the corresponding menu
   testname: "open with accelerator",
   events() {
-    return [ "DOMMenuBarActive menubar",
-             "popupshowing viewpopup", "DOMMenuItemActive viewmenu",
-             "DOMMenuItemActive toolbar", "popupshown viewpopup" ];
+    return [
+      "DOMMenuBarActive menubar",
+      "DOMMenuItemActive viewmenu",
+      "popupshowing viewpopup",
+      "DOMMenuItemActive toolbar",
+      "popupshown viewpopup",
+    ];
   },
   test() { synthesizeKey("V", { altKey: true }); },
   result(testname) {
@@ -236,11 +251,12 @@
   // open the submenu with the cursor right key
   testname: "open submenu with cursor right",
   events() {
-    // on Windows, the disabled 'navigation' item can stll be highlihted
-    if (navigator.platform.indexOf("Win") == 0)
-      return [ "popupshowing toolbarpopup", "DOMMenuItemActive navigation",
+    // on Windows, the disabled 'navigation' item can still be highlighted
+    if (kIsWindows) {
+      return ["popupshowing toolbarpopup", "DOMMenuItemActive navigation",
                "popupshown toolbarpopup" ];
-      return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
+    }
+    return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
   },
   test() { synthesizeKey("KEY_ArrowRight"); },
   result(testname) {
@@ -252,15 +268,23 @@
   // close the submenu with the cursor left key
   testname: "close submenu with cursor left",
   events() {
-    if (navigator.platform.indexOf("Win") == 0)
-      return [ "popuphiding toolbarpopup", "popuphidden toolbarpopup",
-               "DOMMenuItemInactive navigation", "DOMMenuInactive toolbarpopup",
-               "DOMMenuItemActive toolbar" ];
-      return [ "popuphiding toolbarpopup", "popuphidden toolbarpopup",
-               "DOMMenuInactive toolbarpopup",
-               "DOMMenuItemActive toolbar" ];
+    if (kIsWindows) {
+      return [
+        "popuphiding toolbarpopup",
+        "popuphidden toolbarpopup",
+        "DOMMenuItemInactive navigation",
+        "DOMMenuInactive toolbarpopup",
+      ];
+    }
+    return [
+      "popuphiding toolbarpopup",
+      "popuphidden toolbarpopup",
+      "DOMMenuInactive toolbarpopup",
+    ];
   },
-  test() { synthesizeKey("KEY_ArrowLeft"); },
+  test() {
+    synthesizeKey("KEY_ArrowLeft");
+  },
   result(testname) {
     checkOpen("viewmenu", testname);
     checkClosed("toolbar", testname);
@@ -270,11 +294,12 @@
   // open the submenu with the enter key
   testname: "open submenu with enter",
   events() {
-    // on Windows, the disabled 'navigation' item can stll be highlighted
-    if (navigator.platform.indexOf("Win") == 0)
+    if (kIsWindows) {
+      // on Windows, the disabled 'navigation' item can stll be highlighted
       return [ "popupshowing toolbarpopup", "DOMMenuItemActive navigation",
                "popupshown toolbarpopup" ];
-      return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
+    }
+    return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
   },
   test() { synthesizeKey("KEY_Enter"); },
   result(testname) {
@@ -283,16 +308,21 @@
   },
 },
 {
-  // close the submenu with the escape key
   testname: "close submenu with escape",
   events() {
-    if (navigator.platform.indexOf("Win") == 0)
-      return [ "popuphiding toolbarpopup", "popuphidden toolbarpopup",
-               "DOMMenuItemInactive navigation", "DOMMenuInactive toolbarpopup",
-               "DOMMenuItemActive toolbar" ];
-      return [ "popuphiding toolbarpopup", "popuphidden toolbarpopup",
-               "DOMMenuInactive toolbarpopup",
-               "DOMMenuItemActive toolbar" ];
+    if (kIsWindows) {
+      return [
+        "popuphiding toolbarpopup",
+        "popuphidden toolbarpopup",
+        "DOMMenuItemInactive navigation",
+        "DOMMenuInactive toolbarpopup",
+      ];
+    }
+    return [
+      "popuphiding toolbarpopup",
+      "popuphidden toolbarpopup",
+      "DOMMenuInactive toolbarpopup",
+    ];
   },
   test() { synthesizeKey("KEY_Escape"); },
   result(testname) {
@@ -301,15 +331,18 @@
   },
 },
 {
-  // open the submenu with the enter key again
   testname: "open submenu with enter again",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
+  condition() { return kIsWindows; },
   events() {
     // on Windows, the disabled 'navigation' item can stll be highlighted
-    if (navigator.platform.indexOf("Win") == 0)
-      return [ "popupshowing toolbarpopup", "DOMMenuItemActive navigation",
-               "popupshown toolbarpopup" ];
-      return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
+    if (kIsWindows) {
+      return [
+        "popupshowing toolbarpopup",
+        "DOMMenuItemActive navigation",
+        "popupshown toolbarpopup"
+      ];
+    }
+    return [ "popupshowing toolbarpopup", "popupshown toolbarpopup" ];
   },
   test() { synthesizeKey("KEY_Enter"); },
   result(testname) {
@@ -320,14 +353,22 @@
 {
   // while a submenu is open, switch to the next toplevel menu with the cursor right key
   testname: "while a submenu is open, switch to the next menu with the cursor right",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events: [ "DOMMenuItemInactive viewmenu", "DOMMenuItemActive helpmenu",
-            "popuphiding toolbarpopup", "popuphidden toolbarpopup",
-            "popuphiding viewpopup", "popuphidden viewpopup",
-            "popupshowing helppopup", "DOMMenuItemInactive navigation",
-            "DOMMenuInactive toolbarpopup", "DOMMenuItemInactive toolbar",
-            "DOMMenuInactive viewpopup", "DOMMenuItemActive contents",
-            "popupshown helppopup" ],
+  condition() { return kIsWindows; },
+  events: [
+    "DOMMenuItemInactive viewmenu",
+    "DOMMenuItemActive helpmenu",
+    "popuphiding toolbarpopup",
+    "popuphidden toolbarpopup",
+    "popuphiding viewpopup",
+    "popuphidden viewpopup",
+    "popupshowing helppopup",
+    "DOMMenuItemInactive navigation",
+    "DOMMenuInactive toolbarpopup",
+    "DOMMenuItemInactive toolbar",
+    "DOMMenuInactive viewpopup",
+    "DOMMenuItemActive contents",
+    "popupshown helppopup"
+  ],
   test() { synthesizeKey("KEY_ArrowRight"); },
   result(testname) {
     checkOpen("helpmenu", testname);
@@ -338,23 +379,47 @@
 {
   // close the main menu with the escape key
   testname: "close menubar menu with escape",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events: [ "popuphiding helppopup", "popuphidden helppopup",
-            "DOMMenuItemInactive contents", "DOMMenuInactive helppopup",
-            "DOMMenuBarInactive menubar", "DOMMenuItemInactive helpmenu" ],
+  condition() { return kIsWindows; },
+  events: [
+    "popuphiding helppopup",
+    "popuphidden helppopup",
+    "DOMMenuItemInactive contents",
+    "DOMMenuInactive helppopup",
+  ],
   test() { synthesizeKey("KEY_Escape"); },
-  result(testname) { checkClosed("viewmenu", testname); },
+  result(testname) {
+    checkClosed("helpmenu", testname);
+  },
 },
 {
   // close the main menu with the escape key
   testname: "close menubar menu with escape",
-  condition() { return (navigator.platform.indexOf("Win") != 0) },
-  events: [ "popuphiding viewpopup", "popuphidden viewpopup",
-            "DOMMenuItemInactive toolbar", "DOMMenuInactive viewpopup",
-            "DOMMenuBarInactive menubar",
-            "DOMMenuItemInactive viewmenu" ],
-  test() { synthesizeKey("KEY_Escape"); },
-  result(testname) { checkClosed("viewmenu", testname); },
+  condition() { return !kIsWindows; },
+  events: [
+    "popuphiding viewpopup",
+    "popuphidden viewpopup",
+    "DOMMenuItemInactive toolbar",
+    "DOMMenuInactive viewpopup",
+  ],
+  test() {
+    synthesizeKey("KEY_Escape");
+  },
+  result(testname) {
+    checkClosed("viewmenu", testname);
+  },
+},
+{
+  // Deactivate menubar with the escape key.
+  testname: "deactivate menubar menu with escape",
+  events: [
+    "DOMMenuItemInactive " + (kIsWindows ? "helpmenu" : "viewmenu"),
+    "DOMMenuBarInactive menubar",
+  ],
+  test() {
+    synthesizeKey("KEY_Escape");
+  },
+  result(testname) {
+  },
 },
 {
   // Pressing Alt should highlight the first menu but not open it,
@@ -413,9 +478,13 @@
 {
   // pressing a character should act as an accelerator and open the menu
   testname: "accelerator on active menubar",
-  events: [ "popupshowing helppopup",
-            "DOMMenuItemInactive filemenu", "DOMMenuItemActive helpmenu",
-            "DOMMenuItemActive contents", "popupshown helppopup" ],
+  events: [
+    "DOMMenuItemInactive filemenu",
+    "DOMMenuItemActive helpmenu",
+    "popupshowing helppopup",
+    "DOMMenuItemActive contents",
+    "popupshown helppopup",
+  ],
   test() { sendChar("h"); },
   result(testname) {
     checkOpen("helpmenu", testname);
@@ -439,13 +508,17 @@
 {
   // check that pressing a menuitem's accelerator selects it
   testname: "menuitem accelerator",
-  events: [ "DOMMenuItemInactive contents", "DOMMenuItemActive amenu",
-            "DOMMenuItemInactive amenu", "DOMMenuInactive helppopup",
-            "DOMMenuBarInactive menubar", "DOMMenuItemInactive helpmenu",
-            "DOMMenuItemInactive helpmenu",
-            "command amenu", "popuphiding helppopup", "popuphidden helppopup",
-            "DOMMenuItemInactive amenu",
-           ],
+  events: [
+    "DOMMenuItemInactive contents",
+    "DOMMenuItemActive amenu",
+    "DOMMenuItemInactive amenu",
+    "DOMMenuInactive helppopup",
+    "DOMMenuItemInactive helpmenu",
+    "DOMMenuBarInactive menubar",
+    "command amenu",
+    "popuphiding helppopup",
+    "popuphidden helppopup",
+  ],
   test() { sendChar("m"); },
   result(testname) { checkClosed("helpmenu", testname); }
 },
@@ -456,23 +529,25 @@
   test() { synthesizeKey("KEY_F10"); },
   result(testname) {
     is(document.getElementById("filemenu").openedWithKey, true, testname + " openedWithKey");
-    if (navigator.platform.includes("Linux"))
+    if (kIsLinux) {
       checkOpen("filemenu", testname);
-    else
+    } else {
       checkClosed("filemenu", testname);
+    }
   },
 },
 {
   // pressing cursor left then down should open a menu
   testname: "cursor down on menu",
-  events: (navigator.platform.includes("Linux")) ?
+  events: kIsLinux ?
             [  "DOMMenuItemInactive filemenu", "DOMMenuItemActive helpmenu",
                // This is in a different order than the
                // "accelerator on active menubar" because menus opened from a
                // shortcut key are fired asynchronously
                "popuphiding filepopup", "popuphidden filepopup",
                "popupshowing helppopup",
-               "DOMMenuItemActive item1", "DOMMenuItemInactive item1",
+               "DOMMenuItemActive item1",
+               "DOMMenuItemInactive item1",
                "DOMMenuInactive filepopup",
                "popupshown helppopup" ] :
             [ "popupshowing helppopup", "DOMMenuItemInactive filemenu",
@@ -491,7 +566,7 @@
   // should not close because there is more than one item corresponding to
   // that letter
   testname: "menuitem with no accelerator",
-  events: (navigator.platform.includes("Linux")) ?
+  events: kIsLinux ?
            [ "DOMMenuItemActive one" ] :
            [ "DOMMenuItemInactive contents", "DOMMenuItemActive one" ],
   test() { sendChar("o"); },
@@ -513,7 +588,7 @@
   // pressing the letter again when the next item is disabled should still
   // select the disabled item
   testname: "menuitem with no accelerator disabled",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
+  condition() { return kIsWindows; },
   events: [ "DOMMenuItemInactive only", "DOMMenuItemActive other" ],
   test() { sendChar("o"); },
   result(testname) { }
@@ -523,16 +598,20 @@
   // selected and the menu closed
   testname: "menuitem with no accelerator single",
   events() {
-    var elist = [ "DOMMenuItemInactive other", "DOMMenuItemActive third",
-                  "DOMMenuItemInactive third", "DOMMenuInactive helppopup",
-                  "DOMMenuBarInactive menubar",
-                  "DOMMenuItemInactive helpmenu",
-                  "DOMMenuItemInactive helpmenu",
-                  "command third", "popuphiding helppopup",
-                  "popuphidden helppopup", "DOMMenuItemInactive third",
-                ];
-    if (!navigator.platform.includes("Win"))
+    let elist = [
+      "DOMMenuItemInactive other",
+      "DOMMenuItemActive third",
+      "DOMMenuItemInactive third",
+      "DOMMenuInactive helppopup",
+      "DOMMenuItemInactive helpmenu",
+      "DOMMenuBarInactive menubar",
+      "command third",
+      "popuphiding helppopup",
+      "popuphidden helppopup"
+    ];
+    if (!kIsWindows) {
       elist[0] = "DOMMenuItemInactive only";
+    }
     return elist;
   },
   test() { sendChar("t"); },
@@ -541,7 +620,7 @@
 {
   // pressing F10 should highlight the first menu but not open it
   testname: "F10 to activate menubar again",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
+  condition() { return kIsWindows; },
   events: [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ],
   test() { synthesizeKey("KEY_F10"); },
   result(testname) { checkClosed("filemenu", testname); },
@@ -549,7 +628,7 @@
 {
   // pressing an accelerator for a disabled item should deactivate the menubar
   testname: "accelerator for disabled menu",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
+  condition() { return kIsWindows; },
   events: [ "DOMMenuItemInactive filemenu", "DOMMenuBarInactive menubar" ],
   test() { sendChar("s"); },
   result(testname) {
@@ -568,8 +647,12 @@
 },
 {
   testname: "press on second menu with shift",
-  events: [ "popupshowing editpopup", "DOMMenuBarActive menubar",
-            "DOMMenuItemActive editmenu", "popupshown editpopup" ],
+  events: [
+    "DOMMenuBarActive menubar",
+    "DOMMenuItemActive editmenu",
+    "popupshowing editpopup",
+    "popupshown editpopup",
+  ],
   test() {
     synthesizeMouse(document.getElementById("editmenu"), 8, 8, { shiftKey : true });
   },
@@ -589,13 +672,14 @@
 },
 {
   testname: "press on menuitem",
-  events: [ "DOMMenuInactive editpopup",
-            "DOMMenuBarInactive menubar",
-            "DOMMenuItemInactive editmenu",
-            "DOMMenuItemInactive editmenu",
-            "command copy", "popuphiding editpopup", "popuphidden editpopup",
-            "DOMMenuItemInactive copy",
-           ],
+  events: [
+    "DOMMenuInactive editpopup",
+    "DOMMenuItemInactive editmenu",
+    "DOMMenuBarInactive menubar",
+    "command copy",
+    "popuphiding editpopup",
+    "popuphidden editpopup",
+  ],
   test() {
     synthesizeMouse(document.getElementById("copy"), 8, 8, { });
   },
@@ -607,8 +691,12 @@
   // this test ensures that the menu can still be opened by clicking after selecting
   // a menuitem from the menu. See bug 399350.
   testname: "press on menu after menuitem selected",
-  events: [ "popupshowing editpopup", "DOMMenuBarActive menubar",
-            "DOMMenuItemActive editmenu", "popupshown editpopup" ],
+  events: [
+    "DOMMenuBarActive menubar",
+    "DOMMenuItemActive editmenu",
+    "popupshowing editpopup",
+    "popupshown editpopup",
+  ],
   test() { synthesizeMouse(document.getElementById("editmenu"), 8, 8, { }); },
   result (testname) {
     checkActive(document.getElementById("editpopup"), "", testname);
@@ -617,13 +705,14 @@
 },
 {  // try selecting a different command
   testname: "press on menuitem again",
-  events: [ "DOMMenuInactive editpopup",
-            "DOMMenuBarInactive menubar",
-            "DOMMenuItemInactive editmenu",
-            "DOMMenuItemInactive editmenu",
-            "command paste", "popuphiding editpopup", "popuphidden editpopup",
-            "DOMMenuItemInactive paste",
-           ],
+  events: [
+    "DOMMenuInactive editpopup",
+    "DOMMenuItemInactive editmenu",
+    "DOMMenuBarInactive menubar",
+    "command paste",
+    "popuphiding editpopup",
+    "popuphidden editpopup",
+  ],
   test() {
     synthesizeMouse(document.getElementById("paste"), 8, 8, { });
   },
@@ -638,7 +727,7 @@
 },
 {
   testname: "Deactivate menubar with tab key",
-  events: closeAfterF10Events(true),
+  events: closeAfterF10Events(),
   test() { synthesizeKey("KEY_Tab"); },
   result(testname) {
     is(document.getElementById("filemenu").openedWithKey, false, testname + " openedWithKey");
@@ -651,8 +740,14 @@
 },
 {
   testname: "Deactivate menubar with escape key",
-  events: closeAfterF10Events(false),
-  test() { synthesizeKey("KEY_Escape"); },
+  events: closeAfterF10Events(),
+  test() {
+    synthesizeKey("KEY_Escape");
+    if (kIsLinux) {
+      // One to close the menu, one to deactivate the menubar.
+      synthesizeKey("KEY_Escape");
+    }
+  },
   result(testname) {
     is(document.getElementById("filemenu").openedWithKey, false, testname + " openedWithKey");
   }
@@ -664,7 +759,7 @@
 },
 {
   testname: "Deactivate menubar with f10 key",
-  events: closeAfterF10Events(true),
+  events: closeAfterF10Events(),
   test() { synthesizeKey("KEY_F10"); },
   result(testname) {
     is(document.getElementById("filemenu").openedWithKey, false, testname + " openedWithKey");
@@ -672,14 +767,14 @@
 },
 {
   testname: "F10 to activate menubar for alt deactivation",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
+  condition() { return kIsWindows; },
   events: [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ],
   test() { synthesizeKey("KEY_F10"); },
 },
 {
   testname: "Deactivate menubar with alt key",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events: [ "DOMMenuBarInactive menubar", "DOMMenuItemInactive filemenu"  ],
+  condition() { return kIsWindows; },
+  events: [ "DOMMenuItemInactive filemenu", "DOMMenuBarInactive menubar" ],
   test() { synthesizeKey("KEY_Alt"); },
   result(testname) {
     is(document.getElementById("filemenu").openedWithKey, false, testname + " openedWithKey");
@@ -702,9 +797,13 @@
 
 {
   testname: "Open menu and press alt key by itself - open menu",
-  events: [ "DOMMenuBarActive menubar",
-            "popupshowing filepopup", "DOMMenuItemActive filemenu",
-            "DOMMenuItemActive item1", "popupshown filepopup" ],
+  events: [
+    "DOMMenuBarActive menubar",
+    "DOMMenuItemActive filemenu",
+    "popupshowing filepopup",
+    "DOMMenuItemActive item1",
+    "popupshown filepopup",
+  ],
   test() { synthesizeKey("F", { altKey: true }); },
   result (testname) {
     checkOpen("filemenu", testname);
@@ -712,10 +811,14 @@
 },
 {
   testname: "Open menu and press alt key by itself - close menu",
-  events: [ "popuphiding filepopup", "popuphidden filepopup",
-            "DOMMenuItemInactive item1", "DOMMenuInactive filepopup",
-            "DOMMenuBarInactive menubar", "DOMMenuItemInactive filemenu",
-            "DOMMenuItemInactive filemenu" ],
+  events: [
+    "popuphiding filepopup",
+    "popuphidden filepopup",
+    "DOMMenuItemInactive item1",
+    "DOMMenuInactive filepopup",
+    "DOMMenuItemInactive filemenu",
+    "DOMMenuBarInactive menubar",
+  ],
   test() {
     synthesizeKey("KEY_Alt");
   },
@@ -724,16 +827,18 @@
   }
 },
 
-// Fllowing 4 tests are a test of bug 616797, don't insert any new tests
+// Following 4 tests are a test of bug 616797, don't insert any new tests
 // between them.
 {
   testname: "Open file menu by accelerator",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events() {
-    return [ "DOMMenuBarActive menubar", "popupshowing filepopup",
-             "DOMMenuItemActive filemenu", "DOMMenuItemActive item1",
-             "popupshown filepopup" ];
-  },
+  condition() { return kIsWindows; },
+  events: [
+    "DOMMenuBarActive menubar",
+    "DOMMenuItemActive filemenu",
+    "popupshowing filepopup",
+    "DOMMenuItemActive item1",
+    "popupshown filepopup"
+  ],
   test() {
     synthesizeKey("KEY_Alt", {type: "keydown"});
     synthesizeKey("f", {altKey: true});
@@ -742,24 +847,23 @@
 },
 {
   testname: "Close file menu by click at outside of popup menu",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events() {
-    return [ "popuphiding filepopup", "popuphidden filepopup",
-             "DOMMenuItemInactive item1", "DOMMenuInactive filepopup",
-             "DOMMenuBarInactive menubar", "DOMMenuItemInactive filemenu",
-             "DOMMenuItemInactive filemenu" ];
-  },
+  condition() { return kIsWindows; },
+  events: [
+    "popuphiding filepopup",
+    "popuphidden filepopup",
+    "DOMMenuItemInactive item1",
+    "DOMMenuInactive filepopup",
+    "DOMMenuItemInactive filemenu",
+    "DOMMenuBarInactive menubar",
+  ],
   test() {
-    // XXX hidePopup() causes DOMMenuItemInactive event to be fired twice.
     document.getElementById("filepopup").hidePopup();
   }
 },
 {
   testname: "Alt keydown set focus the menubar",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events() {
-    return [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ];
-  },
+  condition() { return kIsWindows; },
+  events: [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ],
   test() {
     synthesizeKey("KEY_Alt");
   },
@@ -769,10 +873,8 @@
 },
 {
   testname: "unset focus the menubar",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events() {
-    return [ "DOMMenuBarInactive menubar", "DOMMenuItemInactive filemenu" ];
-  },
+  condition() { return kIsWindows; },
+  events: [ "DOMMenuItemInactive filemenu", "DOMMenuBarInactive menubar" ],
   test() {
     synthesizeKey("KEY_Alt");
   }
@@ -782,10 +884,8 @@
 {
   testname: "Alt key state before deactivating the window shouldn't prevent " +
             "next Alt key handling",
-  condition() { return (navigator.platform.indexOf("Win") == 0) },
-  events() {
-    return [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ];
-  },
+  condition() { return kIsWindows; },
+  events: [ "DOMMenuBarActive menubar", "DOMMenuItemActive filemenu" ],
   test() {
     synthesizeKey("KEY_Alt", {type: "keydown"});
     synthesizeKey("KEY_Tab", {type: "keydown"}); // cancels the Alt key