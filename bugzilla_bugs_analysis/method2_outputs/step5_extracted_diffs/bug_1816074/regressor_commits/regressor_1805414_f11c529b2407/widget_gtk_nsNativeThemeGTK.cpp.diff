# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsNativeThemeGTK.cpp
# Commit: f11c529b2407
# Full Hash: f11c529b240799df93c4dd8c17ecd8636f9b10de
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-01-04 09:43:05
# Regressor Bug: 1805414
# File Overlap Count: 2
# Description:
#   Bug 1805414 - Remove nsMenuFrame and nsMenuParent. r=smaug,Jamie,desktop-theme-reviewers,settings-reviewers,dao
#   
#   Move most the event handling stuff to the DOM. I've left nsMenuBarFrame
#   for now, but I will be removing that in the future.
#   
# ==============================================================================

diff -r 11d72eaa9cd9 -r f11c529b2407 widget/gtk/nsNativeThemeGTK.cpp
--- a/widget/gtk/nsNativeThemeGTK.cpp	Tue Jan 03 21:55:14 2023 +0000
+++ b/widget/gtk/nsNativeThemeGTK.cpp	Tue Jan 03 22:06:01 2023 +0000
@@ -17,7 +17,7 @@
 #include "nsNameSpaceManager.h"
 #include "nsGfxCIID.h"
 #include "nsTransform2D.h"
-#include "nsMenuFrame.h"
+#include "nsXULPopupManager.h"
 #include "tree/nsTreeBodyFrame.h"
 #include "prlink.h"
 #include "nsGkAtoms.h"
@@ -31,6 +31,7 @@
 #include <gtk/gtk.h>
 
 #include "gfxContext.h"
+#include "mozilla/dom/XULButtonElement.h"
 #include "mozilla/gfx/BorrowedContext.h"
 #include "mozilla/gfx/HelpersCairo.h"
 #include "mozilla/gfx/PathHelpers.h"
@@ -246,14 +247,9 @@
           aAppearance == StyleAppearance::Radiomenuitem ||
           aAppearance == StyleAppearance::Menuseparator ||
           aAppearance == StyleAppearance::Menuarrow) {
-        bool isTopLevel = false;
-        nsMenuFrame* menuFrame = do_QueryFrame(aFrame);
-        if (menuFrame) {
-          isTopLevel = menuFrame->IsOnMenuBar();
-        }
-
-        if (isTopLevel) {
-          aState->inHover = menuFrame->IsOpen();
+        auto* item = dom::XULButtonElement::FromNode(aFrame->GetContent());
+        if (item && item->IsOnMenuBar()) {
+          aState->inHover = CheckBooleanAttr(aFrame, nsGkAtoms::open);
         } else {
           aState->inHover = CheckBooleanAttr(aFrame, nsGkAtoms::menuactive);
         }
@@ -519,8 +515,8 @@
       aGtkWidgetType = MOZ_GTK_MENUBAR;
       break;
     case StyleAppearance::Menuitem: {
-      nsMenuFrame* menuFrame = do_QueryFrame(aFrame);
-      if (menuFrame && menuFrame->IsOnMenuBar()) {
+      auto* item = dom::XULButtonElement::FromNode(aFrame->GetContent());
+      if (item && item->IsOnMenuBar()) {
         aGtkWidgetType = MOZ_GTK_MENUBARITEM;
         break;
       }