# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsWindow.cpp
# Commit: 3a8608560898
# Full Hash: 3a86085608988058ad0774d0878e5aedfea61f49
# Author: stransky <stransky@redhat.com>
# Date: 2022-11-09 09:58:36
# Regressor Bug: 1761877
# File Overlap Count: 1
# Description:
#   Bug 1761877 [Linux] Add isWaylandDragSource and isWaylandPopup attributes to XULPopupElement r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D161127
# ==============================================================================

diff -r 02c859d135b7 -r 3a8608560898 widget/gtk/nsWindow.cpp
--- a/widget/gtk/nsWindow.cpp	Tue Nov 08 20:27:50 2022 +0000
+++ b/widget/gtk/nsWindow.cpp	Tue Nov 08 20:43:17 2022 +0000
@@ -931,7 +931,12 @@
 
   mIsShown = aState;
 
+#ifdef MOZ_LOGGING
   LOG("nsWindow::Show state %d frame %s\n", aState, GetFrameTag().get());
+  if (!aState && mSourceDragContext && GdkIsWaylandDisplay()) {
+    LOG("  closing Drag&Drop source window, D&D will be canceled!");
+  }
+#endif
 
   if (aState) {
     // Now that this window is shown, mHasMappedToplevel needs to be
@@ -9909,4 +9914,9 @@
 
 void nsWindow::SetDragSource(GdkDragContext* aSourceDragContext) {
   mSourceDragContext = aSourceDragContext;
-}
+  if (IsWaylandPopup()) {
+    if (auto* menuPopupFrame = GetMenuPopupFrame(GetFrame())) {
+      menuPopupFrame->SetIsDragSource(!!aSourceDragContext);
+    }
+  }
+}
