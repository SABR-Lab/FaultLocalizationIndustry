# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/XULButtonElement.cpp
# Commit: 5464978a27a8
# Full Hash: 5464978a27a8e770db08b80e3a98b281f6e78318
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-02-08 09:52:31
# Regressor Bug: 1812329
# File Overlap Count: 1
# Description:
#   Bug 1812329 - Remove nsMenuBarFrame. r=smaug
#   
#   This ended up being a lot more straight-forward than the menu changes.
#   
#   TLDR:
# ==============================================================================

diff -r 38ecc5076ab3 -r 5464978a27a8 dom/xul/XULButtonElement.cpp
--- a/dom/xul/XULButtonElement.cpp	Tue Feb 07 18:08:30 2023 +0000
+++ b/dom/xul/XULButtonElement.cpp	Tue Feb 07 18:09:37 2023 +0000
@@ -18,12 +18,12 @@
 #include "mozilla/dom/MouseEventBinding.h"
 #include "mozilla/dom/NameSpaceConstants.h"
 #include "mozilla/dom/AncestorIterator.h"
+#include "mozilla/dom/XULMenuBarElement.h"
 #include "nsGkAtoms.h"
 #include "nsITimer.h"
 #include "nsLayoutUtils.h"
 #include "nsCaseTreatment.h"
 #include "nsChangeHint.h"
-#include "nsMenuBarFrame.h"
 #include "nsMenuPopupFrame.h"
 #include "nsPlaceholderFrame.h"
 #include "nsPresContext.h"
@@ -444,7 +444,8 @@
             // If we're open we never deselect. PopupClosed will do as needed.
             return false;
           }
-          if (!parent->IsMenuBar()) {
+          auto* menubar = XULMenuBarElement::FromNode(*parent);
+          if (!menubar) {
             // Don't de-select when not in the menubar.
             // NOTE(emilio): Behavior from before bug 1811466 is equivalent to
             // returning true here, consider flipping this.
@@ -452,9 +453,7 @@
           }
           // De-select when exiting a menubar item, if the menubar wasn't
           // activated by keyboard.
-          nsMenuBarFrame* menubar = do_QueryFrame(parent->GetPrimaryFrame());
-          const bool openedByKey = menubar && menubar->IsActiveByKeyboard();
-          return !openedByKey;
+          return !menubar->IsActiveByKeyboard();
         }();
 
         if (shouldDeactivate) {
@@ -756,17 +755,11 @@
   }
 }
 
-nsMenuBarFrame* XULButtonElement::GetMenuBar(FlushType aFlushType) {
+XULMenuBarElement* XULButtonElement::GetMenuBar() const {
   if (!IsMenu()) {
     return nullptr;
   }
-  nsIFrame* frame = GetPrimaryFrame(aFlushType);
-  for (; frame; frame = frame->GetParent()) {
-    if (nsMenuBarFrame* menubar = do_QueryFrame(frame)) {
-      return menubar;
-    }
-  }
-  return nullptr;
+  return FirstAncestorOfType<XULMenuBarElement>();
 }
 
 XULMenuParentElement* XULButtonElement::GetMenuParent() const {
@@ -800,8 +793,8 @@
   return do_QueryFrame(popup->GetPrimaryFrame(aFlushType));
 }
 
-bool XULButtonElement::OpenedWithKey() {
-  nsMenuBarFrame* menubar = GetMenuBar(FlushType::Frames);
+bool XULButtonElement::OpenedWithKey() const {
+  auto* menubar = GetMenuBar();
   return menubar && menubar->IsActiveByKeyboard();
 }
 