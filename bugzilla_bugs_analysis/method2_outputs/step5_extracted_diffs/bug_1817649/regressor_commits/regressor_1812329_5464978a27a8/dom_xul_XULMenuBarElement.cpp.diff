# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/XULMenuBarElement.cpp
# Commit: 5464978a27a8
# Full Hash: 5464978a27a8e770db08b80e3a98b281f6e78318
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-02-08 09:52:31
# Regressor Bug: 1812329
# File Overlap Count: 1
# Description:
#   Bug 1812329 - Remove nsMenuBarFrame. r=smaug
#   
#   This ended up being a lot more straight-forward than the menu changes.
#   
#   TLDR:
# ==============================================================================

diff -r 38ecc5076ab3 -r 5464978a27a8 dom/xul/XULMenuBarElement.cpp
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/xul/XULMenuBarElement.cpp	Tue Feb 07 18:09:37 2023 +0000
@@ -0,0 +1,92 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#include "XULMenuBarElement.h"
+#include "MenuBarListener.h"
+#include "XULButtonElement.h"
+#include "nsXULPopupManager.h"
+#include "mozilla/Assertions.h"
+#include "mozilla/dom/BindContext.h"
+#include "mozilla/AsyncEventDispatcher.h"
+
+namespace mozilla::dom {
+
+NS_IMPL_CYCLE_COLLECTION_INHERITED(XULMenuBarElement, XULMenuParentElement,
+                                   mListener)
+NS_IMPL_ISUPPORTS_CYCLE_COLLECTION_INHERITED_0(XULMenuBarElement,
+                                               XULMenuParentElement)
+
+XULMenuBarElement::XULMenuBarElement(
+    already_AddRefed<class NodeInfo>&& aNodeInfo)
+    : XULMenuParentElement(std::move(aNodeInfo)) {}
+
+XULMenuBarElement::~XULMenuBarElement() { MOZ_DIAGNOSTIC_ASSERT(!mListener); }
+
+void XULMenuBarElement::SetActive(bool aActiveFlag) {
+  // If the activity is not changed, there is nothing to do.
+  if (mIsActive == aActiveFlag) {
+    return;
+  }
+
+  // We can't activate a menubar outside of the document.
+  if (!IsInComposedDoc()) {
+    MOZ_ASSERT(!mIsActive, "How?");
+    return;
+  }
+
+  if (!aActiveFlag) {
+    // If there is a request to deactivate the menu bar, check to see whether
+    // there is a menu popup open for the menu bar. In this case, don't
+    // deactivate the menu bar.
+    if (auto* activeChild = GetActiveMenuChild()) {
+      if (activeChild->IsMenuPopupOpen()) {
+        return;
+      }
+    }
+  }
+
+  mIsActive = aActiveFlag;
+  if (nsXULPopupManager* pm = nsXULPopupManager::GetInstance()) {
+    pm->SetActiveMenuBar(this, aActiveFlag);
+  }
+  if (!aActiveFlag) {
+    mActiveByKeyboard = false;
+    SetActiveMenuChild(nullptr);
+  }
+
+  RefPtr dispatcher = new AsyncEventDispatcher(
+      this, aActiveFlag ? u"DOMMenuBarActive"_ns : u"DOMMenuBarInactive"_ns,
+      CanBubble::eYes, ChromeOnlyDispatch::eNo);
+  DebugOnly<nsresult> rv = dispatcher->PostDOMEvent();
+  NS_ASSERTION(NS_SUCCEEDED(rv), "AsyncEventDispatcher failed to dispatch");
+}
+
+nsresult XULMenuBarElement::BindToTree(BindContext& aContext,
+                                       nsINode& aParent) {
+  MOZ_TRY(XULMenuParentElement::BindToTree(aContext, aParent));
+  MOZ_DIAGNOSTIC_ASSERT(!mListener);
+  if (aContext.InComposedDoc()) {
+    mListener = new MenuBarListener(*this);
+  }
+  return NS_OK;
+}
+
+void XULMenuBarElement::UnbindFromTree(bool aNullParent) {
+  if (mListener) {
+    mListener->Detach();
+    mListener = nullptr;
+  }
+  if (NS_WARN_IF(mIsActive)) {
+    // Clean up silently when getting removed from the document while active.
+    mIsActive = false;
+    if (nsXULPopupManager* pm = nsXULPopupManager::GetInstance()) {
+      pm->SetActiveMenuBar(this, false);
+    }
+  }
+  return XULMenuParentElement::UnbindFromTree(aNullParent);
+}
+
+}  // namespace mozilla::dom