# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/MenuBarListener.cpp
# Commit: d663fc115ab9
# Full Hash: d663fc115ab93893bd89c4666c6d8d1c28feac3c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-02-08 09:52:31
# Regressor Bug: 1812329
# File Overlap Count: 1
# Description:
#   Bug 1812329 - Improve cycle collection of the menubar listener. r=smaug
#   
#   Otherwise we leak in some bc tests.
#   
#   MANUAL PUSH: Orange fix CLOSED TREE
# ==============================================================================

diff -r 851cfc54d98b -r d663fc115ab9 dom/xul/MenuBarListener.cpp
--- a/dom/xul/MenuBarListener.cpp	Tue Feb 07 19:34:35 2023 +0000
+++ b/dom/xul/MenuBarListener.cpp	Tue Feb 07 21:57:34 2023 +0100
@@ -33,7 +33,13 @@
 
 namespace mozilla::dom {
 
-NS_IMPL_CYCLE_COLLECTION(MenuBarListener, mTopWindowEventTarget)
+NS_IMPL_CYCLE_COLLECTION_CLASS(MenuBarListener)
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(MenuBarListener)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mTopWindowEventTarget)
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(MenuBarListener)
+  tmp->Detach();
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 
 NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(MenuBarListener)
   NS_INTERFACE_MAP_ENTRY(nsIDOMEventListener)
@@ -84,22 +90,26 @@
 }
 
 void MenuBarListener::Detach() {
-  mEventTarget->RemoveSystemEventListener(u"keypress"_ns, this, false);
-  mEventTarget->RemoveSystemEventListener(u"keydown"_ns, this, false);
-  mEventTarget->RemoveSystemEventListener(u"keyup"_ns, this, false);
-  mEventTarget->RemoveSystemEventListener(u"mozaccesskeynotfound"_ns, this,
-                                          false);
-  mEventTarget->RemoveEventListener(u"keydown"_ns, this, true);
+  if (mEventTarget) {
+    mEventTarget->RemoveSystemEventListener(u"keypress"_ns, this, false);
+    mEventTarget->RemoveSystemEventListener(u"keydown"_ns, this, false);
+    mEventTarget->RemoveSystemEventListener(u"keyup"_ns, this, false);
+    mEventTarget->RemoveSystemEventListener(u"mozaccesskeynotfound"_ns, this,
+                                            false);
+    mEventTarget->RemoveEventListener(u"keydown"_ns, this, true);
 
-  mEventTarget->RemoveEventListener(u"mousedown"_ns, this, true);
-  mEventTarget->RemoveEventListener(u"mousedown"_ns, this, false);
-  mEventTarget->RemoveEventListener(u"blur"_ns, this, true);
+    mEventTarget->RemoveEventListener(u"mousedown"_ns, this, true);
+    mEventTarget->RemoveEventListener(u"mousedown"_ns, this, false);
+    mEventTarget->RemoveEventListener(u"blur"_ns, this, true);
 
-  mEventTarget->RemoveEventListener(u"MozDOMFullscreen:Entered"_ns, this,
-                                    false);
+    mEventTarget->RemoveEventListener(u"MozDOMFullscreen:Entered"_ns, this,
+                                      false);
+  }
 
-  mTopWindowEventTarget->RemoveSystemEventListener(u"deactivate"_ns, this,
-                                                   true);
+  if (mTopWindowEventTarget) {
+    mTopWindowEventTarget->RemoveSystemEventListener(u"deactivate"_ns, this,
+                                                     true);
+  }
 
   mMenuBar = nullptr;
   mEventTarget = nullptr;