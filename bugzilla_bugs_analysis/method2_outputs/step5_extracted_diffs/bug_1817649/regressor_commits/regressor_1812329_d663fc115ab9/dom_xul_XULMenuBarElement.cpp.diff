# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/xul/XULMenuBarElement.cpp
# Commit: d663fc115ab9
# Full Hash: d663fc115ab93893bd89c4666c6d8d1c28feac3c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-02-08 09:52:31
# Regressor Bug: 1812329
# File Overlap Count: 1
# Description:
#   Bug 1812329 - Improve cycle collection of the menubar listener. r=smaug
#   
#   Otherwise we leak in some bc tests.
#   
#   MANUAL PUSH: Orange fix CLOSED TREE
# ==============================================================================

diff -r 851cfc54d98b -r d663fc115ab9 dom/xul/XULMenuBarElement.cpp
--- a/dom/xul/XULMenuBarElement.cpp	Tue Feb 07 19:34:35 2023 +0000
+++ b/dom/xul/XULMenuBarElement.cpp	Tue Feb 07 21:57:34 2023 +0100
@@ -14,8 +14,18 @@
 
 namespace mozilla::dom {
 
-NS_IMPL_CYCLE_COLLECTION_INHERITED(XULMenuBarElement, XULMenuParentElement,
-                                   mListener)
+NS_IMPL_CYCLE_COLLECTION_CLASS(XULMenuBarElement)
+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(XULMenuBarElement,
+                                                XULMenuParentElement)
+  if (tmp->mListener) {
+    tmp->mListener->Detach();
+    tmp->mListener = nullptr;
+  }
+NS_IMPL_CYCLE_COLLECTION_UNLINK_END
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(XULMenuBarElement,
+                                                  XULMenuParentElement)
+  NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mListener)
+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
 NS_IMPL_ISUPPORTS_CYCLE_COLLECTION_INHERITED_0(XULMenuBarElement,
                                                XULMenuParentElement)
 
