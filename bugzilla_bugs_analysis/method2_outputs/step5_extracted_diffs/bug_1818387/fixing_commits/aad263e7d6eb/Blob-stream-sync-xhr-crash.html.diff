# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: Blob-stream-sync-xhr-crash.html
# Commit: aad263e7d6eb
# Full Hash: aad263e7d6eb4d8a42a82585382e20ed509e1e2c
# Author: Kagami Sascha Rosylight <krosylight@mozilla.com>
# Date: 2023-02-28 08:53:39
# Description:
#   Bug 1818387 - Check mPullPromise again in BodyStream::OnInputStreamReady r=smaug
#   
#   Calling a MOZ_CAN_RUN_SCRIPT function (ReadableStream::EnqueueNative() here) can be very surprising given we have nsAutoMicroTask in the scope. Check if mPullPromise exists before accessing it.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D170867
# ==============================================================================

diff -r 92e31c773138 -r aad263e7d6eb testing/web-platform/tests/FileAPI/blob/Blob-stream-sync-xhr-crash.html
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/testing/web-platform/tests/FileAPI/blob/Blob-stream-sync-xhr-crash.html	Mon Feb 27 18:33:16 2023 +0000
@@ -0,0 +1,13 @@
+<!DOCTYPE html>
+<script>
+  const blob = new Blob([1, 2]);
+  const readable = blob.stream()
+  const writable = new WritableStream({}, {
+    size() {
+      let xhr = new XMLHttpRequest()
+      xhr.open("POST", "1", false)
+      xhr.send()
+    }
+  })
+  readable.pipeThrough({ readable, writable })
+</script>
