# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/BodyStream.h
# Commit: 68fbd6ac34b2
# Full Hash: 68fbd6ac34b27ff6c7c836852623f5a358b7ff5b
# Author: Kagami Sascha Rosylight <krosylight@mozilla.com>
# Date: 2023-02-21 21:26:48
# Regressor Bug: 1813011
# File Overlap Count: 1
# Description:
#   Bug 1813011 - Part 2: Return unsettled promise from BodyStream::PullCallbackImpl r=smaug
#   
#   ... and resolve it after successful enqueue. Note that this never rejects it since ErrorNative will do it for us.
#   
#   eWaiting/eReading/eWriting is merged into eInitialized and the state assertions now use promise state.
# ==============================================================================

diff -r 79f6624bf44c -r 68fbd6ac34b2 dom/base/BodyStream.h
--- a/dom/base/BodyStream.h	Tue Feb 21 12:37:00 2023 +0000
+++ b/dom/base/BodyStream.h	Tue Feb 21 12:37:38 2023 +0000
@@ -140,20 +140,8 @@
     // This is the beginning state before any reading operation.
     eInitializing,
 
-    // RequestDataCallback has not been called yet. We haven't started to read
-    // data from the stream yet.
-    eWaiting,
-
-    // We are reading data in a separate I/O thread.
-    eReading,
-
-    // We are ready to write something in the JS Buffer.
-    eWriting,
-
-    // After a writing, we want to check if the stream is closed. After the
-    // check, we go back to eWaiting. If a reading request happens in the
-    // meantime, we move to eReading state.
-    eChecking,
+    // Stream is initialized and being consumed.
+    eInitialized,
 
     // Operation completed.
     eClosed,
@@ -166,6 +154,9 @@
   nsCOMPtr<nsIGlobalObject> mGlobal;
   RefPtr<BodyStreamHolder> mStreamHolder;
   nsCOMPtr<nsIEventTarget> mOwningEventTarget;
+  // Same as mGlobal but set to nullptr on OnInputStreamReady (on the owning
+  // thread).
+  RefPtr<Promise> mPullPromise;
 
   // This is the original inputStream received during the CTOR. It will be
   // converted into an nsIAsyncInputStream and stored into mInputStream at the
