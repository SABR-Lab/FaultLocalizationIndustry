# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fetch/InternalResponse.cpp
# Commit: 4fd92351d64b
# Full Hash: 4fd92351d64b1cbeb82beaf6228b21c01dc9bc03
# Author: Eden Chuang <echuang@mozilla.com>
# Date: 2023-01-19 04:46:07
# Regressor Bug: 1351231
# File Overlap Count: 1
# Description:
#   Bug 1351231 - FetchService integration for PFetch. r=dom-worker-reviewers,jesup
#   
#   Depends on D142436
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D142437
# ==============================================================================

diff -r 7a4e3f5f674a -r 4fd92351d64b dom/fetch/InternalResponse.cpp
--- a/dom/fetch/InternalResponse.cpp	Wed Jan 18 00:50:19 2023 +0000
+++ b/dom/fetch/InternalResponse.cpp	Wed Jan 18 00:50:20 2023 +0000
@@ -90,6 +90,13 @@
         aIPCResponse.metadata().principalInfo().ref()));
   }
 
+  nsAutoCString bodyBlobURISpec(aIPCResponse.metadata().bodyBlobURISpec());
+  response->SetBodyBlobURISpec(bodyBlobURISpec);
+  nsAutoString bodyLocalPath(aIPCResponse.metadata().bodyLocalPath());
+  response->SetBodyLocalPath(bodyLocalPath);
+
+  response->mCredentialsMode = aIPCResponse.metadata().credentialsMode();
+
   switch (aIPCResponse.metadata().type()) {
     case ResponseType::Basic:
       response = response->BasicResponse();
@@ -124,13 +131,17 @@
   Maybe<mozilla::ipc::PrincipalInfo> principalInfo =
       mPrincipalInfo ? Some(*mPrincipalInfo) : Nothing();
 
+  nsAutoCString bodyBlobURISpec(BodyBlobURISpec());
+  nsAutoString bodyLocalPath(BodyLocalPath());
+
   // Note: all the arguments are copied rather than moved, which would be more
   // efficient, because there's no move-friendly constructor generated.
   nsCOMPtr<nsITransportSecurityInfo> securityInfo(mChannelInfo.SecurityInfo());
   return InternalResponseMetadata(
       mType, GetUnfilteredURLList(), GetUnfilteredStatus(),
       GetUnfilteredStatusText(), headersGuard, headers, mErrorCode,
-      GetAlternativeDataType(), securityInfo, principalInfo);
+      GetAlternativeDataType(), securityInfo, principalInfo, bodyBlobURISpec,
+      bodyLocalPath, GetCredentialsMode());
 }
 
 void InternalResponse::ToChildToParentInternalResponse(
@@ -196,15 +207,16 @@
   GetUnfilteredBody(getter_AddRefs(body), &bodySize);
 
   if (body) {
-    result.body() = Some(
-        ToParentToChildStream(WrapNotNull(body), bodySize, aBackgroundParent));
+    result.body() = Some(ToParentToChildStream(
+        WrapNotNull(body), bodySize, aBackgroundParent, mSerializeAsLazy));
     result.bodySize() = bodySize;
   }
 
   nsCOMPtr<nsIInputStream> alternativeBody = TakeAlternativeBody();
   if (alternativeBody) {
-    result.alternativeBody() = Some(ToParentToChildStream(
-        WrapNotNull(alternativeBody), UNKNOWN_BODY_SIZE, aBackgroundParent));
+    result.alternativeBody() = Some(
+        ToParentToChildStream(WrapNotNull(alternativeBody), UNKNOWN_BODY_SIZE,
+                              aBackgroundParent, mSerializeAsLazy));
   }
 
   return result;