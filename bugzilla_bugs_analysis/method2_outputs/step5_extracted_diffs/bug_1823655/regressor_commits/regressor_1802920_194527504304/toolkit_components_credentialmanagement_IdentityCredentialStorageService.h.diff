# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/credentialmanagement/IdentityCredentialStorageService.h
# Commit: 194527504304
# Full Hash: 194527504304c9b7e29d60f8d5627835d8939627
# Author: Benjamin VanderSloot <bvandersloot@mozilla.com>
# Date: 2023-01-20 21:21:03
# Regressor Bug: 1802920
# File Overlap Count: 1
# Description:
#   Bug 1802920, part 2 - Move database connection objects into members of the singleton - r=timhuang
#   
#   This was challenging because it required variable lifetimes to be sorted out
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D165297
# ==============================================================================

diff -r 10d51d7a7136 -r 194527504304 toolkit/components/credentialmanagement/IdentityCredentialStorageService.h
--- a/toolkit/components/credentialmanagement/IdentityCredentialStorageService.h	Fri Jan 20 16:24:06 2023 +0000
+++ b/toolkit/components/credentialmanagement/IdentityCredentialStorageService.h	Fri Jan 20 16:24:07 2023 +0000
@@ -41,7 +41,8 @@
 
  private:
   IdentityCredentialStorageService()
-      : mMonitor("mozilla::IdentityCredentialStorageService::mMonitor"){};
+      : mMonitor("mozilla::IdentityCredentialStorageService::mMonitor"),
+        mPendingWrites(0){};
   ~IdentityCredentialStorageService() = default;
 
   // Spins up the service. This includes firing off async work in a worker
@@ -66,6 +67,27 @@
   // principal
   static nsresult ValidatePrincipal(nsIPrincipal* aPrincipal);
 
+  // Helper functions to initialize the database connections. Also makes sure
+  // the tables are present and have up to date schemas.
+  nsresult GetMemoryDatabaseConnection();
+  nsresult GetDiskDatabaseConnection();
+  static nsresult GetDatabaseConnectionInternal(
+      mozIStorageConnection** aDatabase, nsIFile* aFile);
+
+  // Helper function for the Get*DatabaseConnection functions to ensure the
+  // tables are present and have up to date schemas.
+  static nsresult EnsureTable(mozIStorageConnection* aDatabase);
+
+  // Grab all data from the disk database and insert it into the memory
+  // database/ This is used at start up
+  nsresult LoadMemoryTableFromDisk();
+
+  // Used to (thread-safely) track how many operations have been launched to the
+  // worker thread so that we can wait for it to hit zero before close the disk
+  // database connection
+  void IncrementPendingWrites();
+  void DecrementPendingWrites();
+
   // Database connections. Guaranteed to be non-null and working once
   // initialized and not-yet finalized
   RefPtr<mozIStorageConnection> mDiskDatabaseConnection;  // Worker thread only
@@ -90,6 +112,7 @@
   FlippedOnce<false> mInitialized MOZ_GUARDED_BY(mMonitor);
   FlippedOnce<false> mErrored MOZ_GUARDED_BY(mMonitor);
   FlippedOnce<false> mFinalized MOZ_GUARDED_BY(mMonitor);
+  uint32_t mPendingWrites MOZ_GUARDED_BY(mMonitor);
 };
 
 }  // namespace mozilla
