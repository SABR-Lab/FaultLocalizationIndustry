# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/ScriptLoader.cpp
# Commit: 15eb9daca661
# Full Hash: 15eb9daca66122a5d891bc721fd554d377238d60
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2023-01-19 04:46:07
# Regressor Bug: 1247687
# File Overlap Count: 1
# Description:
#   Bug 1247687 - Disallow ImportScripts from module workers; r=jonco
#   
#   ImportScripts should be disallowed for module works, which are initialized in the following way:
#   `new Worker("url", { module:true})`. We set the WorkerType for workers accordingly, and can use that
#   to detect if import scripts are being incorrectly used.
# ==============================================================================

diff -r 997e9ca2e1e9 -r 15eb9daca661 dom/workers/ScriptLoader.cpp
--- a/dom/workers/ScriptLoader.cpp	Wed Jan 18 13:46:29 2023 +0000
+++ b/dom/workers/ScriptLoader.cpp	Wed Jan 18 13:46:30 2023 +0000
@@ -258,7 +258,12 @@
     return;
   }
 
-  loader->CreateScriptRequests(aScriptURLs, aDocumentEncoding, aIsMainScript);
+  bool ok = loader->CreateScriptRequests(aScriptURLs, aDocumentEncoding,
+                                         aIsMainScript);
+
+  if (!ok) {
+    return;
+  }
 
   if (loader->DispatchLoadScripts()) {
     syncLoop.Run();
@@ -431,14 +436,31 @@
   mWorkerRef->Private()->DebuggerGlobalScope()->InitModuleLoader(moduleLoader);
 }
 
-void WorkerScriptLoader::CreateScriptRequests(
+bool WorkerScriptLoader::CreateScriptRequests(
     const nsTArray<nsString>& aScriptURLs,
     const mozilla::Encoding* aDocumentEncoding, bool aIsMainScript) {
+  // If a worker has been loaded as a module worker, ImportScripts calls are
+  // disallowed -- then the operation is invalid.
+  //
+  // 10.3.1 Importing scripts and libraries.
+  // Step 1. If worker global scope's type is "module", throw a TypeError
+  //         exception.
+  if (mWorkerRef->Private()->WorkerType() == WorkerType::Module &&
+      !aIsMainScript) {
+    // This should only run for non-main scripts, as only these are
+    // importScripts
+    mRv.ThrowTypeError(
+        "Using `ImportScripts` inside a Module Worker is "
+        "disallowed.");
+    return false;
+  }
   for (const nsString& scriptURL : aScriptURLs) {
     RefPtr<ScriptLoadRequest> request =
         CreateScriptLoadRequest(scriptURL, aDocumentEncoding, aIsMainScript);
     mLoadingRequests.AppendElement(request);
   }
+
+  return true;
 }
 
 nsTArray<RefPtr<ThreadSafeRequestHandle>> WorkerScriptLoader::GetLoadingList() {