# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/ScriptLoader.cpp
# Commit: 7770ec4717fd
# Full Hash: 7770ec4717fdce23c2e399fcbbd93a42a69c7721
# Author: Yulia Startsev <ystartsev@mozilla.com>
# Date: 2022-12-21 21:21:23
# Regressor Bug: 1247687
# File Overlap Count: 1
# Description:
#   Bug 1247687 - Disallow ImportScripts from module workers; r=jonco
#   
#   ImportScripts should be disallowed for module works, which are initialized in the following way:
#   `new Worker("url", { module:true})`. We set the WorkerType for workers accordingly, and can use that
#   to detect if import scripts are being incorrectly used.
# ==============================================================================

diff -r 68b476066248 -r 7770ec4717fd dom/workers/ScriptLoader.cpp
--- a/dom/workers/ScriptLoader.cpp	Tue Dec 20 20:56:12 2022 +0000
+++ b/dom/workers/ScriptLoader.cpp	Tue Dec 20 20:56:12 2022 +0000
@@ -258,7 +258,12 @@
     return;
   }
 
-  loader->CreateScriptRequests(aScriptURLs, aDocumentEncoding, aIsMainScript);
+  bool ok = loader->CreateScriptRequests(aScriptURLs, aDocumentEncoding,
+                                         aIsMainScript);
+
+  if (!ok) {
+    return;
+  }
 
   if (loader->DispatchLoadScripts()) {
     syncLoop.Run();
@@ -427,14 +432,29 @@
       ->InitModuleLoader(moduleLoader);
 }
 
-void WorkerScriptLoader::CreateScriptRequests(
+bool WorkerScriptLoader::CreateScriptRequests(
     const nsTArray<nsString>& aScriptURLs,
     const mozilla::Encoding* aDocumentEncoding, bool aIsMainScript) {
+  // If a worker has been loaded as a module worker, ImportScripts calls are
+  // disallowed -- then the operation is invalid.
+  //
+  // 10.3.1 Importing scripts and libraries.
+  // Step 1. If worker global scope's type is "module", throw a TypeError
+  //         exception.
+  if (!aIsMainScript &&
+      mWorkerRef->Private()->WorkerType() == WorkerType::Module) {
+    mRv.ThrowTypeError(
+        "Using `ImportScripts` inside a Module Worker is "
+        "disallowed.");
+    return false;
+  }
   for (const nsString& scriptURL : aScriptURLs) {
     RefPtr<ScriptLoadRequest> request =
         CreateScriptLoadRequest(scriptURL, aDocumentEncoding, aIsMainScript);
     mLoadingRequests.AppendElement(request);
   }
+
+  return true;
 }
 
 nsTArray<RefPtr<ThreadSafeRequestHandle>> WorkerScriptLoader::GetLoadingList() {