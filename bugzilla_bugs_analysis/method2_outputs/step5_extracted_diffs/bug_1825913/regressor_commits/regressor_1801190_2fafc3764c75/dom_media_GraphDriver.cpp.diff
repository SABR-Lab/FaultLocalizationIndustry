# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/GraphDriver.cpp
# Commit: 2fafc3764c75
# Full Hash: 2fafc3764c75706d044b9393c37bc5fd2c2375c6
# Author: Karl Tomlinson <karlt+@karlt.net>
# Date: 2023-03-31 09:51:00
# Regressor Bug: 1801190
# File Overlap Count: 1
# Description:
#   Bug 1801190 remove racy mAudioStream warning r=pehrsons
#   
#   mAudioStream may be replaced on the CubebOperation thread while the fallback
#   driver hands over the graph to a ThreadedDriver or main thread that may create
#   a SHUTDOWN AsyncCubebTask.
# ==============================================================================

diff -r 16ac83dc9ac5 -r 2fafc3764c75 dom/media/GraphDriver.cpp
--- a/dom/media/GraphDriver.cpp	Thu Mar 30 23:18:44 2023 +0000
+++ b/dom/media/GraphDriver.cpp	Thu Mar 30 23:18:45 2023 +0000
@@ -293,9 +293,10 @@
       mDriver(aDriver),
       mOperation(aOperation),
       mShutdownGrip(aDriver->Graph()) {
-  NS_WARNING_ASSERTION(
-      mDriver->mAudioStream || aOperation == AsyncCubebOperation::INIT,
-      "No audio stream!");
+  MOZ_ASSERT(mDriver->mAudioStreamState ==
+                     AudioCallbackDriver::AudioStreamState::Pending ||
+                 aOperation == AsyncCubebOperation::SHUTDOWN,
+             "Replacing active stream!");
 }
 
 AsyncCubebTask::~AsyncCubebTask() = default;
