# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/gtest/MockCubeb.h
# Commit: f81e1b1615b3
# Full Hash: f81e1b1615b3a9c5ef6c62a291f79029b3807dde
# Author: Karl Tomlinson <karlt+@karlt.net>
# Date: 2023-03-31 09:51:00
# Regressor Bug: 1801190
# File Overlap Count: 1
# Description:
#   Bug 1801190 do not reset mAudioStreamState to None on state changes from an old cubeb_stream r=pehrsons
#   
#   Such resets were preventing transitions to Running for new streams and allowing
#   MaybeStartAudioStream() to start another stream.
#   
# ==============================================================================

diff -r 9592d9865f5a -r f81e1b1615b3 dom/media/gtest/MockCubeb.h
--- a/dom/media/gtest/MockCubeb.h	Fri Mar 31 02:23:14 2023 +0300
+++ b/dom/media/gtest/MockCubeb.h	Thu Mar 30 23:18:44 2023 +0000
@@ -150,6 +150,7 @@
 
   int Start();
   int Stop();
+  void Destroy();
   int RegisterDeviceChangedCallback(
       cubeb_device_changed_callback aDeviceChangedCallback);
 
@@ -193,9 +194,10 @@
 
   void Process10Ms();
 
- public:
+ private:
   cubeb* context = nullptr;
 
+ public:
   const bool mHasInput;
   const bool mHasOutput;
   SmartMockCubebStream* const mSelf;
@@ -458,9 +460,7 @@
 }
 
 void cubeb_mock_stream_destroy(cubeb_stream* stream) {
-  MockCubebStream* mockStream = MockCubebStream::AsMock(stream);
-  MockCubeb* mock = MockCubeb::AsMock(mockStream->context);
-  return mock->StreamDestroy(stream);
+  MockCubebStream::AsMock(stream)->Destroy();
 }
 
 static char const* cubeb_mock_get_backend_id(cubeb* context) {