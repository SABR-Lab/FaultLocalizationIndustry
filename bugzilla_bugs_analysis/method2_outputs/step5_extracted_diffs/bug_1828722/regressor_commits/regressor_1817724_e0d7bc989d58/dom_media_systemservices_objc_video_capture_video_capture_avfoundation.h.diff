# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/systemservices/objc_video_capture/video_capture_avfoundation.h
# Commit: e0d7bc989d58
# Full Hash: e0d7bc989d58bb54c813ca7fa063bea0f231ff2b
# Author: Andreas Pehrson <apehrson@mozilla.com>
# Date: 2023-03-30 15:09:05
# Regressor Bug: 1817724
# File Overlap Count: 1
# Description:
#   Bug 1817724 - Clean up and tighten VideoCaptureAvFoundation somewhat. r=webrtc-reviewers,ng
#   
#   This patch mainly changes VideoCaptureAdapter to use an instance method to set
#   the capturer member under a mutex. It also moves the setting of this capturer
#   to start rather than init (and unsets it on stop). With this we shouldn't need
# ==============================================================================

diff -r fcdd846450bb -r e0d7bc989d58 dom/media/systemservices/objc_video_capture/video_capture_avfoundation.h
--- a/dom/media/systemservices/objc_video_capture/video_capture_avfoundation.h	Thu Mar 30 10:14:01 2023 +0000
+++ b/dom/media/systemservices/objc_video_capture/video_capture_avfoundation.h	Thu Mar 30 10:36:33 2023 +0000
@@ -9,6 +9,7 @@
 
 #import "components/capturer/RTCCameraVideoCapturer.h"
 
+#include "api/scoped_refptr.h"
 #include "api/sequence_checker.h"
 #include "modules/video_capture/video_capture_impl.h"
 #include "mozilla/Maybe.h"
@@ -40,28 +41,27 @@
   int32_t CaptureSettings(VideoCaptureCapability& aSettings) override;
 
   // Callback. This can be called on any thread.
-  int32_t OnFrame(webrtc::VideoFrame& aFrame) MOZ_EXCLUDES(api_lock_);
+  int32_t OnFrame(__strong RTCVideoFrame* _Nonnull aFrame) MOZ_EXCLUDES(api_lock_);
 
   void SetTrackingId(uint32_t aTrackingIdProcId) MOZ_EXCLUDES(api_lock_) override;
 
-  // Allows the capturer to start the recording before calling OnFrame, to cover more operations
-  // under the same measurement.
-  void StartFrameRecording(int32_t aWidth, int32_t aHeight) MOZ_EXCLUDES(api_lock_);
-
   // Registers the current thread with the profiler if not already registered.
   void MaybeRegisterCallbackThread();
 
  private:
+  // Control thread checker.
   SequenceChecker mChecker;
-  AVCaptureDevice* _Nonnull mDevice RTC_GUARDED_BY(mChecker);
-  VideoCaptureAdapter* _Nonnull mAdapter RTC_GUARDED_BY(mChecker);
-  RTC_OBJC_TYPE(RTCCameraVideoCapturer) * _Nullable mCapturer RTC_GUARDED_BY(mChecker);
+  AVCaptureDevice* _Nonnull const mDevice RTC_GUARDED_BY(mChecker);
+  VideoCaptureAdapter* _Nonnull const mAdapter RTC_GUARDED_BY(mChecker);
+  RTCCameraVideoCapturer* _Nonnull const mCapturer RTC_GUARDED_BY(mChecker);
   // If capture has started, this is the capability it was started for. Written on the mChecker
   // thread only.
   mozilla::Maybe<VideoCaptureCapability> mCapability MOZ_GUARDED_BY(api_lock_);
+  // The image type that mCapability maps to. Set in lockstep with mCapability.
+  mozilla::Maybe<mozilla::CaptureStage::ImageType> mImageType MOZ_GUARDED_BY(api_lock_);
   // Id string uniquely identifying this capture source. Written on the mChecker thread only.
   mozilla::Maybe<mozilla::TrackingId> mTrackingId MOZ_GUARDED_BY(api_lock_);
-  // Adds frame specific markers to the profiler while mTrackingId is set.
+  // Adds frame specific markers to the profiler while mTrackingId is set. Callback thread only.
   mozilla::PerformanceRecorderMulti<mozilla::CaptureStage> mCaptureRecorder;
   mozilla::PerformanceRecorderMulti<mozilla::CopyVideoStage> mConversionRecorder;
   std::atomic<ProfilerThreadId> mCallbackThreadId;
@@ -69,8 +69,11 @@
 
 }  // namespace webrtc::videocapturemodule
 
-@interface VideoCaptureAdapter : NSObject <RTC_OBJC_TYPE (RTCVideoCapturerDelegate)>
-@property(nonatomic) webrtc::videocapturemodule::VideoCaptureAvFoundation* _Nullable capturer;
+@interface VideoCaptureAdapter : NSObject <RTCVideoCapturerDelegate> {
+  webrtc::Mutex _mutex;
+  webrtc::videocapturemodule::VideoCaptureAvFoundation* _Nullable _capturer RTC_GUARDED_BY(_mutex);
+}
+- (void)setCapturer:(webrtc::videocapturemodule::VideoCaptureAvFoundation* _Nullable)capturer;
 @end
 
 #endif