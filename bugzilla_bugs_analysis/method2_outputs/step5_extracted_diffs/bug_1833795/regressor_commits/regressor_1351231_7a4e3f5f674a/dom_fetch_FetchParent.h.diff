# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fetch/FetchParent.h
# Commit: 7a4e3f5f674a
# Full Hash: 7a4e3f5f674ad675fa084bf1f30a79a15e8c7d2a
# Author: Eden Chuang <echuang@mozilla.com>
# Date: 2023-01-19 04:46:07
# Regressor Bug: 1351231
# File Overlap Count: 2
# Description:
#   Bug 1351231 - PFetch protocol declaration and implementation. r=dom-worker-reviewers,jesup
#   
#   Depends on D138813
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D142436
# ==============================================================================

diff -r 9da00c1364a5 -r 7a4e3f5f674a dom/fetch/FetchParent.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/fetch/FetchParent.h	Wed Jan 18 00:50:19 2023 +0000
@@ -0,0 +1,91 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef mozilla_dom_fetchParent_h__
+#define mozilla_dom_fetchParent_h__
+
+#include "mozilla/Maybe.h"
+#include "mozilla/MozPromise.h"
+#include "mozilla/RefPtr.h"
+#include "mozilla/dom/FetchService.h"
+#include "mozilla/dom/PFetchParent.h"
+#include "mozilla/dom/SafeRefPtr.h"
+#include "mozilla/ipc/PBackgroundSharedTypes.h"
+#include "nsCOMPtr.h"
+#include "nsIContentSecurityPolicy.h"
+#include "nsISerialEventTarget.h"
+#include "nsString.h"
+
+namespace mozilla::dom {
+
+class ClientInfo;
+class InternalRequest;
+class InternalResponse;
+class ServiceWorkerDescriptor;
+
+class FetchParent final : public PFetchParent {
+  friend class PFetchParent;
+
+ public:
+  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(FetchParent, override);
+
+  mozilla::ipc::IPCResult RecvFetchOp(FetchOpArgs&& aArgs);
+
+  mozilla::ipc::IPCResult RecvAbortFetchOp();
+
+  FetchParent();
+
+  static RefPtr<FetchParent> GetActorByID(const nsID& aID);
+
+  void OnFlushConsoleReport(nsTArray<net::ConsoleReportCollected>&& aReports);
+
+  class FetchParentCSPEventListener final : public nsICSPEventListener {
+   public:
+    NS_DECL_THREADSAFE_ISUPPORTS
+    NS_DECL_NSICSPEVENTLISTENER
+
+    FetchParentCSPEventListener(const nsID& aActorID,
+                                nsCOMPtr<nsISerialEventTarget> aEventTarget);
+
+   private:
+    ~FetchParentCSPEventListener() = default;
+
+    nsID mActorID;
+    nsCOMPtr<nsISerialEventTarget> mEventTarget;
+  };
+
+  nsICSPEventListener* GetCSPEventListener();
+
+  void OnCSPViolationEvent(const nsAString& aJSON);
+
+ private:
+  ~FetchParent();
+
+  void ActorDestroy(ActorDestroyReason aReason) override;
+
+  // The map of FetchParent and ID. Should only access in background thread.
+  static nsTHashMap<nsIDHashKey, RefPtr<FetchParent>> sActorTable;
+
+  // The unique ID of the FetchParent
+  nsID mID;
+  SafeRefPtr<InternalRequest> mRequest;
+  RefPtr<FetchServicePromises> mResponsePromises;
+  RefPtr<GenericPromise::Private> mPromise;
+  PrincipalInfo mPrincipalInfo;
+  nsCString mWorkerScript;
+  Maybe<ClientInfo> mClientInfo;
+  Maybe<ServiceWorkerDescriptor> mController;
+  RefPtr<FetchParentCSPEventListener> mCSPEventListener;
+  bool mNeedOnDataAvailable{false};
+  bool mHasCSPEventListener{false};
+
+  Atomic<bool> mIsDone{false};
+  Atomic<bool> mActorDestroyed{false};
+
+  nsCOMPtr<nsISerialEventTarget> mBackgroundEventTarget;
+};
+
+}  // namespace mozilla::dom
+
+#endif