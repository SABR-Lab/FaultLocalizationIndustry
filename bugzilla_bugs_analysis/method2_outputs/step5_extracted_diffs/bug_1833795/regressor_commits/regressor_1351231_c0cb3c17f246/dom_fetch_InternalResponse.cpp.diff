# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/fetch/InternalResponse.cpp
# Commit: c0cb3c17f246
# Full Hash: c0cb3c17f2461a19203f3b295a6c56b417483b2a
# Author: Eden Chuang <echuang@mozilla.com>
# Date: 2023-01-12 21:30:33
# Regressor Bug: 1351231
# File Overlap Count: 2
# Description:
#   Bug 1351231 - FetchService integration for PFetch. r=dom-worker-reviewers,jesup
#   
#   Depends on D142436
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D142437
# ==============================================================================

diff -r 84162d09eef8 -r c0cb3c17f246 dom/fetch/InternalResponse.cpp
--- a/dom/fetch/InternalResponse.cpp	Thu Jan 12 15:09:45 2023 +0000
+++ b/dom/fetch/InternalResponse.cpp	Thu Jan 12 15:09:45 2023 +0000
@@ -90,6 +90,11 @@
         aIPCResponse.metadata().principalInfo().ref()));
   }
 
+  nsAutoCString bodyBlobURISpec(aIPCResponse.metadata().bodyBlobURISpec());
+  response->SetBodyBlobURISpec(bodyBlobURISpec);
+  nsAutoString bodyLocalPath(aIPCResponse.metadata().bodyLocalPath());
+  response->SetBodyLocalPath(bodyLocalPath);
+
   switch (aIPCResponse.metadata().type()) {
     case ResponseType::Basic:
       response = response->BasicResponse();
@@ -124,13 +129,17 @@
   Maybe<mozilla::ipc::PrincipalInfo> principalInfo =
       mPrincipalInfo ? Some(*mPrincipalInfo) : Nothing();
 
+  nsAutoCString bodyBlobURISpec(BodyBlobURISpec());
+  nsAutoString bodyLocalPath(BodyLocalPath());
+
   // Note: all the arguments are copied rather than moved, which would be more
   // efficient, because there's no move-friendly constructor generated.
   nsCOMPtr<nsITransportSecurityInfo> securityInfo(mChannelInfo.SecurityInfo());
   return InternalResponseMetadata(
       mType, GetUnfilteredURLList(), GetUnfilteredStatus(),
       GetUnfilteredStatusText(), headersGuard, headers, mErrorCode,
-      GetAlternativeDataType(), securityInfo, principalInfo);
+      GetAlternativeDataType(), securityInfo, principalInfo, bodyBlobURISpec,
+      bodyLocalPath);
 }
 
 void InternalResponse::ToChildToParentInternalResponse(
@@ -196,15 +205,16 @@
   GetUnfilteredBody(getter_AddRefs(body), &bodySize);
 
   if (body) {
-    result.body() = Some(
-        ToParentToChildStream(WrapNotNull(body), bodySize, aBackgroundParent));
+    result.body() = Some(ToParentToChildStream(
+        WrapNotNull(body), bodySize, aBackgroundParent, mSerializeAsLazy));
     result.bodySize() = bodySize;
   }
 
   nsCOMPtr<nsIInputStream> alternativeBody = TakeAlternativeBody();
   if (alternativeBody) {
-    result.alternativeBody() = Some(ToParentToChildStream(
-        WrapNotNull(alternativeBody), UNKNOWN_BODY_SIZE, aBackgroundParent));
+    result.alternativeBody() = Some(
+        ToParentToChildStream(WrapNotNull(alternativeBody), UNKNOWN_BODY_SIZE,
+                              aBackgroundParent, mSerializeAsLazy));
   }
 
   return result;