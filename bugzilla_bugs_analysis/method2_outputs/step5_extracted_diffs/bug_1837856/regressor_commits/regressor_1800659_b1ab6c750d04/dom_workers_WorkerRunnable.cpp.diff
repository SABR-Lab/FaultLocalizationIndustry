# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/workers/WorkerRunnable.cpp
# Commit: b1ab6c750d04
# Full Hash: b1ab6c750d04299011c1446b1752c2ff98a92b33
# Author: Eden Chuang <echuang@mozilla.com>
# Date: 2023-06-07 03:30:33
# Regressor Bug: 1800659
# File Overlap Count: 1
# Description:
#   Bug 1800659 - P3 Remove WorkerPrivate::ClearMainEventQueue() r=asuth,smaug
#   
#   Pending->Canceling->Killing (WorkerNeverRan)
#   
#   Need to clear WorkerPrivate::mPreStartRunnables
# ==============================================================================

diff -r 32515f9b41c7 -r b1ab6c750d04 dom/workers/WorkerRunnable.cpp
--- a/dom/workers/WorkerRunnable.cpp	Tue Jun 06 06:36:50 2023 +0000
+++ b/dom/workers/WorkerRunnable.cpp	Tue Jun 06 06:36:50 2023 +0000
@@ -234,7 +234,6 @@
                               mBehavior == WorkerThreadUnchangedBusyCount;
 
 #ifdef DEBUG
-  MOZ_ASSERT_IF(mCallingCancelWithinRun, targetIsWorkerThread);
   if (targetIsWorkerThread) {
     mWorkerPrivate->AssertIsOnWorkerThread();
   } else {
@@ -243,22 +242,14 @@
   }
 #endif
 
-  if (targetIsWorkerThread &&
-      mWorkerPrivate->AllPendingRunnablesShouldBeCanceled() &&
-      !mCallingCancelWithinRun) {
-    LOG(("WorkerRunnable::Run [%p] Cancel runnable...", this));
-    // Prevent recursion.
+  if (targetIsWorkerThread && !mCallingCancelWithinRun &&
+      mWorkerPrivate->CancelBeforeWorkerScopeConstructed()) {
     mCallingCancelWithinRun = true;
-
     Cancel();
-
-    MOZ_ASSERT(mCallingCancelWithinRun);
     mCallingCancelWithinRun = false;
-
     if (mBehavior == WorkerThreadModifyBusyCount) {
       mWorkerPrivate->ModifyBusyCountFromWorker(false);
     }
-
     return NS_OK;
   }
 