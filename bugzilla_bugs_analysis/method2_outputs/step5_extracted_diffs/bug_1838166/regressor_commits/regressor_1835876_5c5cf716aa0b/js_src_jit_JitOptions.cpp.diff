# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/JitOptions.cpp
# Commit: 5c5cf716aa0b
# Full Hash: 5c5cf716aa0b01aecd8702254427825c9de1b8fa
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2023-06-08 03:42:08
# Regressor Bug: 1835876
# File Overlap Count: 1
# Description:
#   Bug 1835876 part 2 - Disable code write protection in content processes. r=nbp
#   
#   We've worked with the security and performance teams to re-evaluate the W^X policy
#   we have in place to mark JIT code memory pages as either writable or executable
#   (but not both).
# ==============================================================================

diff -r 028f981600d7 -r 5c5cf716aa0b js/src/jit/JitOptions.cpp
--- a/js/src/jit/JitOptions.cpp	Wed Jun 07 16:34:51 2023 +0000
+++ b/js/src/jit/JitOptions.cpp	Wed Jun 07 16:34:51 2023 +0000
@@ -280,6 +280,10 @@
   SET_DEFAULT(spectreJitToCxxCalls, true);
 #endif
 
+  // Whether the W^X policy is enforced to mark JIT code pages as either
+  // writable or executable but never both at the same time.
+  SET_DEFAULT(writeProtectCode, true);
+
   // This is set to its actual value in InitializeJit.
   SET_DEFAULT(supportsUnalignedAccesses, false);
 
@@ -410,5 +414,15 @@
   setNormalIonWarmUpThreshold(defaultValues.normalIonWarmUpThreshold);
 }
 
+void DefaultJitOptions::maybeSetWriteProtectCode(bool val) {
+  // For now don't change the default (true) on Apple ARM64 because we can't use
+  // RWX pages there without MAP_JIT. See bug 1837194.
+#if defined(XP_MACOSX) && defined(__aarch64__)
+  MOZ_ASSERT(writeProtectCode);
+#else
+  writeProtectCode = val;
+#endif
+}
+
 }  // namespace jit
 }  // namespace js