# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/basetypes/HyperTextAccessibleBase.cpp
# Commit: c552d41490c7
# Full Hash: c552d41490c7670eb12076a3028b6863c23f4ff0
# Author: Morgan Rae Reschenberg <mreschenberg@mozilla.com>
# Date: 2023-06-13 03:42:25
# Regressor Bug: 1837030
# File Overlap Count: 1
# Description:
#   Bug 1837030: Treat fuzzily-matched text leaves as valid in OffsetAtPoint r=Jamie,nlapre
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D180515
# ==============================================================================

diff -r c33c010f3a4f -r c552d41490c7 accessible/basetypes/HyperTextAccessibleBase.cpp
--- a/accessible/basetypes/HyperTextAccessibleBase.cpp	Mon Jun 12 20:31:07 2023 +0000
+++ b/accessible/basetypes/HyperTextAccessibleBase.cpp	Mon Jun 12 21:01:04 2023 +0000
@@ -292,6 +292,17 @@
       nsAccUtils::ConvertToScreenCoords(aX, aY, aCoordType, thisAcc);
   if (!thisAcc->Bounds().Contains(coords.x, coords.y)) {
     // The requested point does not exist in this accessible.
+    // Check if we used fuzzy hittesting to get here and, if
+    // so, return 0 to indicate this text leaf is a valid match.
+    LayoutDeviceIntPoint p(aX, aY);
+    if (aCoordType != nsIAccessibleCoordinateType::COORDTYPE_SCREEN_RELATIVE) {
+      p = nsAccUtils::ConvertToScreenCoords(aX, aY, aCoordType, thisAcc);
+    }
+    Accessible* hittestMatch = nsAccUtils::DocumentFor(thisAcc)->ChildAtPoint(
+        p.x, p.y, Accessible::EWhichChildAtPoint::DeepestChild);
+    if (thisAcc == hittestMatch->Parent()) {
+      return 0;
+    }
     return -1;
   }
 