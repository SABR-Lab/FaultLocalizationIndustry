# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: third_party/rust/wpf-gpu-raster/src/lib.rs
# Commit: 5762b27d2cc8
# Full Hash: 5762b27d2cc82e6c7f3f0d37bc4bcfdb130f9220
# Author: Lee Salzman <lsalzman@mozilla.com>
# Date: 2023-06-21 04:00:08
# Description:
#   Bug 1839459 - Elide empty closed sub-paths instead of emitting a start point. r=jrmuizel
#   
#   There is a corner case that triggers an assert in wpf-gpu-raster if an empty sub-path
#   starts off a path. Just avoid the problem by eliding the sub-path, but at least handle
#   close correctly as per the Canvas2D closePath spec:
# ==============================================================================

diff -r caa96b0874f4 -r 5762b27d2cc8 third_party/rust/wpf-gpu-raster/src/lib.rs
--- a/third_party/rust/wpf-gpu-raster/src/lib.rs	Tue Jun 20 18:01:09 2023 +0000
+++ b/third_party/rust/wpf-gpu-raster/src/lib.rs	Tue Jun 20 18:04:20 2023 +0000
@@ -177,21 +177,18 @@
         self.curve_to(c1x, c1y, c2x, c2y, x, y);
     }
     pub fn close(&mut self) {
-        if !self.in_shape {
-            match self.initial_point {
-                Some(initial_point) => {
-                    self.types.push(PathPointTypeStart);
-                    self.add_point(initial_point.X, initial_point.Y);
-                    self.in_shape = true;
-                }
-                None => return,
-            }
+        if self.in_shape {
+          // Only close the path if we are inside a shape. Otherwise, the point
+          // should be safe to elide.
+          if let Some(last) = self.types.last_mut() {
+              *last |= PathPointTypeCloseSubpath;
+          }
+          self.in_shape = false;
         }
-        if let Some(last) = self.types.last_mut() {
-            *last |= PathPointTypeCloseSubpath;
-        }
-        self.in_shape = false;
-        self.initial_point = None;
+        // Close must install a new initial point that is the same as the
+        // initial point of the just-closed sub-path. Thus, just leave the
+        // initial point unchanged.
+        self.current_point = self.initial_point;
     }
     pub fn set_fill_mode(&mut self, fill_mode: FillMode) {
         self.fill_mode = fill_mode;
@@ -680,6 +677,8 @@
     #[test]
     fn close_after_move_to() {
         let mut p = PathBuilder::new();
+        p.move_to(10., 0.);
+        p.close();
         p.move_to(0., 0.);
         p.line_to(0., 10.);
         p.line_to(10., 10.);