# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: modules/libpref/Preferences.cpp
# Commit: fa90b889f528
# Full Hash: fa90b889f5287eef0e9c0a72733920715c178ccf
# Author: Sebastian Hengst <archaeopteryx@coole-files.de>
# Date: 2023-07-15 09:36:53
# Description:
#   Bug 1843197 - add some services.* prefs as not to be sanitized, as intended. r=tjr
#   
#   The services.* preferences branch gets sanitizer by default. Exceptions
#   need to be added in the ShouldSanitizePreference method.
#   
# ==============================================================================

diff -r f04d14e8c457 -r fa90b889f528 modules/libpref/Preferences.cpp
--- a/modules/libpref/Preferences.cpp	Fri Jul 14 15:41:31 2023 +0300
+++ b/modules/libpref/Preferences.cpp	Fri Jul 14 12:44:44 2023 +0000
@@ -6034,7 +6034,8 @@
 //      StaticPrefList.yml), a string pref, and it is NOT exempted in
 //      sDynamicPrefOverrideList
 //
-// This behavior is codified in ShouldSanitizePreference() below
+// This behavior is codified in ShouldSanitizePreference() below where
+// exclusions of preferences can be defined.
 static const PrefListEntry sRestrictFromWebContentProcesses[] = {
     // Remove prefs with user data
     PREF_LIST_ENTRY("datareporting.policy."),
@@ -6143,11 +6144,8 @@
     PREF_LIST_ENTRY("print_printer"),
     PREF_LIST_ENTRY("places.interactions.customBlocklist"),
     PREF_LIST_ENTRY("remote.log.level"),
-    PREF_LIST_ENTRY("services.settings.loglevel"),
-    PREF_LIST_ENTRY(
-        "services.settings.preview_enabled"),  // This is really a boolean
-                                               // dynamic pref, but one Nightly
-                                               // user has it set as a string...
+    // services.* preferences should be added in ShouldSanitizePreference - the
+    // whole preference branch gets sanitized by default.
     PREF_LIST_ENTRY("spellchecker.dictionary"),
     PREF_LIST_ENTRY("test.char"),
     PREF_LIST_ENTRY("Test.IPC."),
@@ -6184,6 +6182,10 @@
       const auto* p = prefName;  // This avoids clang-format doing ugly things.
       return !(strncmp("services.settings.clock_skew_seconds", p, 36) == 0 ||
                strncmp("services.settings.last_update_seconds", p, 37) == 0 ||
+               strncmp("services.settings.loglevel", p, 26) == 0 ||
+               // This is really a boolean dynamic pref, but one Nightly user
+               // has it set as a string...
+               strncmp("services.settings.preview_enabled", p, 33) == 0 ||
                strncmp("services.settings.server", p, 24) == 0);
     }
   }
