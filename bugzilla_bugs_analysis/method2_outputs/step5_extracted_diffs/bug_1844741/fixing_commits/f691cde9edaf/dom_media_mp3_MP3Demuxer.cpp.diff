# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/mp3/MP3Demuxer.cpp
# Commit: f691cde9edaf
# Full Hash: f691cde9edaf7a11fc554bbda5aaf30893d80170
# Author: Paul Adenot <paul@paul.cx>
# Date: 2023-07-21 19:39:17
# Description:
#   Bug 1844741 - Consistently use remaining padding when trimming mp3. r=alwu
#   
#   Creating the file was made in the following way:
#   - Create a VBR file
#   - Modify the padding field so that it spans multiple packets (greater than 1152
# ==============================================================================

diff -r 3c7aa15fc461 -r f691cde9edaf dom/media/mp3/MP3Demuxer.cpp
--- a/dom/media/mp3/MP3Demuxer.cpp	Fri Jul 21 17:28:03 2023 +0000
+++ b/dom/media/mp3/MP3Demuxer.cpp	Fri Jul 21 17:55:32 2023 +0000
@@ -165,6 +165,7 @@
 
 RefPtr<MP3TrackDemuxer::SeekPromise> MP3TrackDemuxer::Seek(
     const TimeUnit& aTime) {
+  mRemainingEncoderPadding = AssertedCast<int32_t>(mEncoderPadding);
   // Efficiently seek to the position.
   FastSeek(aTime);
   // Correct seek position by scanning the next frames.
@@ -735,7 +736,7 @@
   } else if (frame->mEOS &&
              mRemainingEncoderPadding <=
                  frame->mDuration.ToTicksAtRate(mSamplesPerSecond)) {
-    frame->mDuration -= Padding();
+    frame->mDuration -= TimeUnit(mRemainingEncoderPadding, mSamplesPerSecond);
     MOZ_ASSERT(frame->mDuration.IsPositiveOrZero());
     MP3LOG("Trimming last packet %s to [%s,%s]", Padding().ToString().get(),
            frame->mTime.ToString().get(), frame->GetEndTime().ToString().get());