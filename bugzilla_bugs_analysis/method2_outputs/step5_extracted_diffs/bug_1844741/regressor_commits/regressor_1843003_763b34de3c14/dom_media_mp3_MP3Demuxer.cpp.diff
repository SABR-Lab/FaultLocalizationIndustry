# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/mp3/MP3Demuxer.cpp
# Commit: 763b34de3c14
# Full Hash: 763b34de3c143cc9777be616395f1e9d95583240
# Author: Paul Adenot <paul@paul.cx>
# Date: 2023-07-20 21:19:23
# Regressor Bug: 1843003
# File Overlap Count: 1
# Description:
#   Bug 1843003 - Keep track of how much padding has been stripped, and don't trim more than necessary. r=alwu
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D183736
# ==============================================================================

diff -r 81c600b19271 -r 763b34de3c14 dom/media/mp3/MP3Demuxer.cpp
--- a/dom/media/mp3/MP3Demuxer.cpp	Thu Jul 20 13:17:58 2023 +0000
+++ b/dom/media/mp3/MP3Demuxer.cpp	Thu Jul 20 13:17:58 2023 +0000
@@ -665,6 +665,8 @@
                mParser.VBRInfo().EncoderDelay());
         mEncoderDelay = mParser.VBRInfo().EncoderDelay();
         mEncoderPadding = mParser.VBRInfo().EncoderPadding();
+        // Padding is encoded as a 12-bit unsigned number so this is fine.
+        mRemainingEncoderPadding = AssertedCast<int32_t>(mEncoderPadding);
         if (mEncoderDelay == 0) {
           // Skip the VBR frame + the decoder delay, that is always 529 frames
           // in practice for the decoder we're using.
@@ -707,7 +709,7 @@
   // packets that aren't the last one.
   // For most files, the padding is less than a packet, it's simply substracted.
   if (mParser.VBRInfo().Type() == FrameParser::VBRHeader::XING &&
-      Padding().IsPositive() &&
+      mRemainingEncoderPadding > 0 &&
       frame->GetEndTime() > Duration().valueOr(TimeUnit::FromInfinity())) {
     TimeUnit duration = Duration().value();
     TimeUnit inPaddingZone = frame->GetEndTime() - duration;
@@ -719,13 +721,20 @@
     if (frame->mDuration.IsNegative()) {
       frame->mDuration = TimeUnit::Zero(mSamplesPerSecond);
     }
-    MP3LOG(
-        "Found padding spanning multiple packets -- trimming [%s, %s] to "
-        "[%s,%s] (stream duration: %s)",
-        originalPts.ToString().get(), originalEnd.ToString().get(),
-        frame->mTime.ToString().get(), frame->GetEndTime().ToString().get(),
-        duration.ToString().get());
-  } else if (frame->mEOS && Padding() <= frame->mDuration) {
+    int32_t paddingFrames =
+        AssertedCast<int32_t>(inPaddingZone.ToTicksAtRate(mSamplesPerSecond));
+    if (mRemainingEncoderPadding >= paddingFrames) {
+      mRemainingEncoderPadding -= paddingFrames;
+    } else {
+      mRemainingEncoderPadding = 0;
+    }
+    MP3LOG("Trimming [%s, %s] to [%s,%s] (padding) (stream duration: %s)",
+           originalPts.ToString().get(), originalEnd.ToString().get(),
+           frame->mTime.ToString().get(), frame->GetEndTime().ToString().get(),
+           duration.ToString().get());
+  } else if (frame->mEOS &&
+             mRemainingEncoderPadding <=
+                 frame->mDuration.ToTicksAtRate(mSamplesPerSecond)) {
     frame->mDuration -= Padding();
     MOZ_ASSERT(frame->mDuration.IsPositiveOrZero());
     MP3LOG("Trimming last packet %s to [%s,%s]", Padding().ToString().get(),