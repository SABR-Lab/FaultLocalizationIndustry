# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/base/nsCSSFrameConstructor.cpp
# Commit: 60dcf69d99e2
# Full Hash: 60dcf69d99e2c2e954e1720f5fe30a5758550d2d
# Author: Martin Robinson <mrobinson@igalia.com>
# Date: 2023-09-15 04:35:42
# Description:
#   Bug 1845223 - Destroy ContainStyleScopes before recalculating counters & quotes during frame destruction r=emilio
#   
#   Instead of recalculating quotes and counter before destroying contain
#   style scopes, calculate them after. This prevents stale frame pointers
#   from sticking around during counter and quote recalculation.
# ==============================================================================

diff -r be325dcc5de7 -r 60dcf69d99e2 layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp	Thu Sep 14 20:38:09 2023 +0000
+++ b/layout/base/nsCSSFrameConstructor.cpp	Thu Sep 14 20:41:45 2023 +0000
@@ -1478,6 +1478,10 @@
 }
 
 void nsCSSFrameConstructor::NotifyDestroyingFrame(nsIFrame* aFrame) {
+  if (aFrame->StyleDisplay()->IsContainStyle()) {
+    mContainStyleScopeManager.DestroyScopesFor(aFrame);
+  }
+
   if (aFrame->HasAnyStateBits(NS_FRAME_GENERATED_CONTENT) &&
       mContainStyleScopeManager.DestroyQuoteNodesFor(aFrame)) {
     QuotesDirty();
@@ -1491,10 +1495,6 @@
     CountersDirty();
   }
 
-  if (aFrame->StyleDisplay()->IsContainStyle()) {
-    mContainStyleScopeManager.DestroyScopesFor(aFrame);
-  }
-
   RestyleManager()->NotifyDestroyingFrame(aFrame);
 }
 
@@ -3703,7 +3703,8 @@
   return &sCanvasData;
 }
 
-static MOZ_NEVER_INLINE void DestroyFramesInList(PresShell* aPs, nsFrameList& aList) {
+static MOZ_NEVER_INLINE void DestroyFramesInList(PresShell* aPs,
+                                                 nsFrameList& aList) {
   nsIFrame::DestroyContext context(aPs);
   aList.DestroyFrames(context);
 }