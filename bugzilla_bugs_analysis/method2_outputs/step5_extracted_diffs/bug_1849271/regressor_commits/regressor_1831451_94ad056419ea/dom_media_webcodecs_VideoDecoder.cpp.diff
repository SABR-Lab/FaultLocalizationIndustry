# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webcodecs/VideoDecoder.cpp
# Commit: 94ad056419ea
# Full Hash: 94ad056419ea1a8575b410af0eb97a6f0f14ca9b
# Author: Chun-Min Chang <chun.m.chang@gmail.com>
# Date: 2023-06-29 15:31:45
# Regressor Bug: 1831451
# File Overlap Count: 1
# Description:
#   Bug 1831451 - Implement VideoDecoder::Close r=padenot
#   
#   This patch implements the close method [1] for WebCodecs' VideoDecoder
#   interface. The implementation has not been completed yet. It will be
#   done by the following patches.
# ==============================================================================

diff -r f615134b7349 -r 94ad056419ea dom/media/webcodecs/VideoDecoder.cpp
--- a/dom/media/webcodecs/VideoDecoder.cpp	Thu Jun 29 04:15:01 2023 +0000
+++ b/dom/media/webcodecs/VideoDecoder.cpp	Thu Jun 29 04:15:01 2023 +0000
@@ -13,6 +13,7 @@
 #include "mozilla/Assertions.h"
 #include "mozilla/Logging.h"
 #include "mozilla/Maybe.h"
+#include "mozilla/dom/DOMException.h"
 #include "mozilla/dom/Promise.h"
 #include "mozilla/dom/WebCodecsUtils.h"
 #include "nsReadableUtils.h"
@@ -225,8 +226,15 @@
   }
 }
 
+// https://w3c.github.io/webcodecs/#dom-videodecoder-close
 void VideoDecoder::Close(ErrorResult& aRv) {
-  aRv.Throw(NS_ERROR_DOM_NOT_SUPPORTED_ERR);
+  AssertIsOnOwningThread();
+
+  LOG("VideoDecoder %p, Close", this);
+
+  if (auto r = Close(NS_ERROR_DOM_ABORT_ERR); r.isErr()) {
+    aRv.Throw(r.unwrapErr());
+  }
 }
 
 // https://w3c.github.io/webcodecs/#dom-videodecoder-isconfigsupported
@@ -286,6 +294,29 @@
   return Ok();
 }
 
+// https://w3c.github.io/webcodecs/#close-videodecoder
+Result<Ok, nsresult> VideoDecoder::Close(const nsresult& aResult) {
+  AssertIsOnOwningThread();
+
+  MOZ_TRY(Reset(aResult));
+  mState = CodecState::Closed;
+  if (aResult != NS_ERROR_DOM_ABORT_ERR) {
+    LOGE("VideoDecoder %p Close on error: 0x%08" PRIx32, this,
+         static_cast<uint32_t>(aResult));
+    // TODO: Schedule the error callback instead of calling it directly.
+    ReportError(aResult);
+  }
+  return Ok();
+}
+
+void VideoDecoder::ReportError(const nsresult& aResult) {
+  AssertIsOnOwningThread();
+
+  RefPtr<DOMException> e = DOMException::Create(aResult);
+  RefPtr<WebCodecsErrorCallback> cb(mErrorCallback);
+  cb->Call(*e);
+}
+
 #undef LOG
 #undef LOGE
 #undef LOG_INTERNAL