# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/events/ContentEventHandler.cpp
# Commit: 3601308f553b
# Full Hash: 3601308f553b3d381a68f6e90a971bd7cb7b1684
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2023-08-10 04:42:07
# Regressor Bug: 1845215
# File Overlap Count: 1
# Description:
#   Bug 1845215 - part 1: Make `ContentIteratorBase` a template class to work without strong pointers r=smaug
#   
#   `ContentEventHandler` works with `PostContentIterator` and `PreContentIterator`
#   when it scans DOM nodes in a range.  While iterating the DOM nodes, script
#   never runs.  Therefore, we can make `ContentEventHandler` work with new
# ==============================================================================

diff -r f2506aaa10bd -r 3601308f553b dom/events/ContentEventHandler.cpp
--- a/dom/events/ContentEventHandler.cpp	Wed Aug 09 23:05:26 2023 +0000
+++ b/dom/events/ContentEventHandler.cpp	Thu Aug 10 00:59:28 2023 +0000
@@ -793,7 +793,7 @@
     return NS_OK;
   }
 
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
   nsresult rv =
       preOrderIter.Init(aRawRange.Start().AsRaw(), aRawRange.End().AsRaw());
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -960,7 +960,7 @@
 
   // baseOffset is the flattened offset of each content node.
   uint32_t baseOffset = 0;
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
   nsresult rv =
       preOrderIter.Init(aRawRange.Start().AsRaw(), aRawRange.End().AsRaw());
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -1091,7 +1091,7 @@
     }
   }
 
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
   nsresult rv = preOrderIter.Init(mRootElement);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
@@ -1565,7 +1565,7 @@
 ContentEventHandler::GetFirstFrameInRangeForTextRect(
     const RawRange& aRawRange) {
   NodePosition nodePosition;
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
   nsresult rv =
       preOrderIter.Init(aRawRange.Start().AsRaw(), aRawRange.End().AsRaw());
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -1628,7 +1628,7 @@
 ContentEventHandler::FrameAndNodeOffset
 ContentEventHandler::GetLastFrameInRangeForTextRect(const RawRange& aRawRange) {
   NodePosition nodePosition;
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
   nsresult rv =
       preOrderIter.Init(aRawRange.Start().AsRaw(), aRawRange.End().AsRaw());
   if (NS_WARN_IF(NS_FAILED(rv))) {
@@ -2393,7 +2393,7 @@
                                          OffsetAndDataFor::EditorString);
 
   // used to iterate over all contents and their frames
-  PostContentIterator postOrderIter;
+  UnsafePostContentIterator postOrderIter;
   rv = postOrderIter.Init(rawRange.Start().AsRaw(), rawRange.End().AsRaw());
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return NS_ERROR_FAILURE;
@@ -2963,7 +2963,7 @@
     return NS_OK;
   }
 
-  PreContentIterator preOrderIter;
+  UnsafePreContentIterator preOrderIter;
 
   // Working with ContentIterator, we may need to adjust the end position for
   // including it forcibly.