# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/MacroAssembler-inl.h
# Commit: 28feda14fdec
# Full Hash: 28feda14fdec962ea68c26a0570ea69042a5ad27
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2023-08-05 09:19:01
# Regressor Bug: 1692065
# File Overlap Count: 3
# Description:
#   Bug 1692065 - wasm: Add tagging for JSString* in AnyRef. r=yury
#   
#   Before this commit we would need to box a JSString* in WasmValueBox
#   when we received one from JS and converted to an AnyRef.
#   
# ==============================================================================

diff -r 85605041672d -r 28feda14fdec js/src/jit/MacroAssembler-inl.h
--- a/js/src/jit/MacroAssembler-inl.h	Fri Aug 04 14:06:50 2023 +0000
+++ b/js/src/jit/MacroAssembler-inl.h	Fri Aug 04 14:06:50 2023 +0000
@@ -391,6 +391,24 @@
 }
 
 // ===============================================================
+// Copy instructions
+
+void MacroAssembler::copy64(const Address& src, const Address& dest,
+                            Register scratch) {
+#if JS_BITS_PER_WORD == 32
+  MOZ_RELEASE_ASSERT(src.base != scratch && dest.base != scratch);
+  load32(LowWord(src), scratch);
+  store32(scratch, LowWord(dest));
+  load32(HighWord(src), scratch);
+  store32(scratch, HighWord(dest));
+#else
+  Register64 scratch64(scratch);
+  load64(src, scratch64);
+  store64(scratch64, dest);
+#endif
+}
+
+// ===============================================================
 // Arithmetic functions
 
 void MacroAssembler::addPtr(ImmPtr imm, Register dest) {
@@ -739,22 +757,6 @@
                Imm32(ShiftedMask), label);
 }
 
-void MacroAssembler::branchTestObjectIsWasmGcObject(bool isGcObject,
-                                                    Register object,
-                                                    Register scratch,
-                                                    Label* label) {
-  constexpr uint32_t ShiftedMask = (Shape::kindMask() << Shape::kindShift());
-  constexpr uint32_t ShiftedKind =
-      (uint32_t(Shape::Kind::WasmGC) << Shape::kindShift());
-  MOZ_ASSERT(object != scratch);
-
-  loadPtr(Address(object, JSObject::offsetOfShape()), scratch);
-  load32(Address(scratch, Shape::offsetOfImmutableFlags()), scratch);
-  and32(Imm32(ShiftedMask), scratch);
-  branch32(isGcObject ? Assembler::Equal : Assembler::NotEqual, scratch,
-           Imm32(ShiftedKind), label);
-}
-
 void MacroAssembler::branchTestProxyHandlerFamily(Condition cond,
                                                   Register proxy,
                                                   Register scratch,