# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmAnyRef.cpp
# Commit: 28feda14fdec
# Full Hash: 28feda14fdec962ea68c26a0570ea69042a5ad27
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2023-08-05 09:19:01
# Regressor Bug: 1692065
# File Overlap Count: 3
# Description:
#   Bug 1692065 - wasm: Add tagging for JSString* in AnyRef. r=yury
#   
#   Before this commit we would need to box a JSString* in WasmValueBox
#   when we received one from JS and converted to an AnyRef.
#   
# ==============================================================================

diff -r 85605041672d -r 28feda14fdec js/src/wasm/WasmAnyRef.cpp
--- a/js/src/wasm/WasmAnyRef.cpp	Fri Aug 04 14:06:50 2023 +0000
+++ b/js/src/wasm/WasmAnyRef.cpp	Fri Aug 04 14:06:50 2023 +0000
@@ -62,6 +62,12 @@
     return true;
   }
 
+  if (value.isString()) {
+    JSString* string = value.toString();
+    result.set(AnyRef::fromJSString(string));
+    return true;
+  }
+
   if (value.isObject()) {
     JSObject& obj = value.toObject();
     MOZ_ASSERT(!obj.is<WasmValueBox>());
@@ -89,6 +95,8 @@
   Value value;
   if (isNull()) {
     value.setNull();
+  } else if (isJSString()) {
+    value.setString(toJSString());
   } else {
     JSObject& obj = toJSObject();
     if (obj.is<WasmValueBox>()) {