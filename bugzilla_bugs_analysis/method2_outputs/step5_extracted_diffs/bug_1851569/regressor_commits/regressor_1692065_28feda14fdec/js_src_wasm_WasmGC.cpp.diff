# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmGC.cpp
# Commit: 28feda14fdec
# Full Hash: 28feda14fdec962ea68c26a0570ea69042a5ad27
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2023-08-05 09:19:01
# Regressor Bug: 1692065
# File Overlap Count: 3
# Description:
#   Bug 1692065 - wasm: Add tagging for JSString* in AnyRef. r=yury
#   
#   Before this commit we would need to box a JSString* in WasmValueBox
#   when we received one from JS and converted to an AnyRef.
#   
# ==============================================================================

diff -r 85605041672d -r 28feda14fdec js/src/wasm/WasmGC.cpp
--- a/js/src/wasm/WasmGC.cpp	Fri Aug 04 14:06:50 2023 +0000
+++ b/js/src/wasm/WasmGC.cpp	Fri Aug 04 14:06:50 2023 +0000
@@ -219,9 +219,9 @@
                 wasm::TrapSite(masm.currentOffset(), *trapOffset));
   }
 
-  // If the previous value is null, we don't need the barrier.
+  // If the previous value is not a GC thing, we don't need the barrier.
   masm.loadPtr(Address(valueAddr, valueOffset), scratch);
-  masm.branchTestPtr(Assembler::Zero, scratch, scratch, skipBarrier);
+  masm.branchWasmAnyRefIsGCThing(false, scratch, skipBarrier);
 }
 
 void wasm::EmitWasmPreBarrierCall(MacroAssembler& masm, Register instance,
@@ -258,9 +258,6 @@
                                     const Maybe<Register>& object,
                                     Register otherScratch, Register setValue,
                                     Label* skipBarrier) {
-  // If the pointer being stored is null, no barrier.
-  masm.branchTestPtr(Assembler::Zero, setValue, setValue, skipBarrier);
-
   // If there is a containing object and it is in the nursery, no barrier.
   if (object) {
     masm.branchPtrInNurseryChunk(Assembler::Equal, *object, otherScratch,
@@ -268,8 +265,8 @@
   }
 
   // If the pointer being stored is to a tenured object, no barrier.
-  masm.branchPtrInNurseryChunk(Assembler::NotEqual, setValue, otherScratch,
-                               skipBarrier);
+  masm.branchWasmAnyRefIsNurseryCell(Assembler::NotEqual, setValue,
+                                     otherScratch, skipBarrier);
 }
 
 #ifdef DEBUG