# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/MacroAssembler.h
# Commit: 72bf9c871ded
# Full Hash: 72bf9c871ded006f56f09b24d0723365516445bb
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2023-08-05 09:19:01
# Regressor Bug: 1692065
# File Overlap Count: 5
# Description:
#   Bug 1692065 - wasm: Add tagging for 31-bit integers and i31ref. r=yury
#   
#   This commit adds a tag 0x1 for 31-bit integers in AnyRef. Any JS value
#   that is losslessly representable (without coercion) in this range is
#   stored without boxing. This is chosen to line up exactly with how the
# ==============================================================================

diff -r 28feda14fdec -r 72bf9c871ded js/src/jit/MacroAssembler.h
--- a/js/src/jit/MacroAssembler.h	Fri Aug 04 14:06:50 2023 +0000
+++ b/js/src/jit/MacroAssembler.h	Fri Aug 04 14:06:50 2023 +0000
@@ -3947,21 +3947,33 @@
 
   // Branch if the wasm anyref `src` is or is not the null value.
   void branchWasmAnyRefIsNull(bool isNull, Register src, Label* label);
+  // Branch if the wasm anyref `src` is or is not an I31.
+  void branchWasmAnyRefIsI31(bool isI31, Register src, Label* label);
   // Branch if the wasm anyref `src` is or is not a JSObject*.
   void branchWasmAnyRefIsObjectOrNull(bool isObject, Register src, Label* label);
   // Branch if the wasm anyref `src` is or is not a GC thing.
   void branchWasmAnyRefIsGCThing(bool isGCThing, Register src, Label* label);
   // Branch if the wasm anyref `src` is or is not pointing to a nursery cell.
-  void branchWasmAnyRefIsNurseryCell(Condition cond, Register src,
+  void branchWasmAnyRefIsNurseryCell(bool isNurseryCell, Register src,
                                      Register scratch, Label* label);
 
+  // Create a wasm i31ref by truncating the 32-bit integer.
+  void truncate32ToWasmI31Ref(Register src, Register dest);
+  // Convert a wasm i31ref to a signed 32-bit integer.
+  void convertWasmI31RefTo32Signed(Register src, Register dest);
+  // Convert a wasm i31ref to an unsigned 32-bit integer.
+  void convertWasmI31RefTo32Unsigned(Register src, Register dest);
+
   // Branch if the JS value `src` would need to be boxed out of line to be
   // converted to a wasm anyref.
-  void branchValueConvertsToWasmAnyRefInline(ValueOperand src, Label* label);
+  void branchValueConvertsToWasmAnyRefInline(ValueOperand src,
+                                             Register scratchInt,
+                                             FloatRegister scratchFloat,
+                                             Label* label);
   // Convert a JS value to a wasm anyref. If the value requires boxing, this
   // will branch to `oolConvert`.
   void convertValueToWasmAnyRef(ValueOperand src, Register dest,
-                                Label* oolConvert);
+                                FloatRegister scratchFloat, Label* oolConvert);
   // Convert a JS object to a wasm anyref. This cannot fail.
   void convertObjectToWasmAnyRef(Register src, Register dest);
   // Convert a JS string to a wasm anyref. This cannot fail.