# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/midi/tests/MIDITestUtils.js
# Commit: 225adb498b09
# Full Hash: 225adb498b091a93ddf7081c1f4356f705594a7b
# Author: Gabriele Svelto <gsvelto@mozilla.com>
# Date: 2022-04-12 15:57:11
# Regressor Bug: 1758468
# File Overlap Count: 1
# Description:
#   Bug 1758468 - Use stable, anonymous IDs for Web MIDI ports r=padenot
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D142550
# ==============================================================================

diff -r 3c6e6d0d7b38 -r 225adb498b09 dom/midi/tests/MIDITestUtils.js
--- a/dom/midi/tests/MIDITestUtils.js	Tue Apr 12 12:31:27 2022 +0000
+++ b/dom/midi/tests/MIDITestUtils.js	Tue Apr 12 12:31:27 2022 +0000
@@ -23,31 +23,41 @@
   // This list needs to stay synced with the ports in
   // dom/midi/TestMIDIPlatformService.
   inputInfo: {
-    id: "b744eebe-f7d8-499b-872b-958f63c8f522",
+    get id() {
+      return MIDITestUtils.stableId(this);
+    },
     name: "Test Control MIDI Device Input Port",
     manufacturer: "Test Manufacturer",
     version: "1.0.0",
   },
   outputInfo: {
-    id: "ab8e7fe8-c4de-436a-a960-30898a7c9a3d",
+    get id() {
+      return MIDITestUtils.stableId(this);
+    },
     name: "Test Control MIDI Device Output Port",
     manufacturer: "Test Manufacturer",
     version: "1.0.0",
   },
   stateTestInputInfo: {
-    id: "a9329677-8588-4460-a091-9d4a7f629a48",
+    get id() {
+      return MIDITestUtils.stableId(this);
+    },
     name: "Test State MIDI Device Input Port",
     manufacturer: "Test Manufacturer",
     version: "1.0.0",
   },
   stateTestOutputInfo: {
-    id: "478fa225-b5fc-4fa6-a543-d32d9cb651e7",
+    get id() {
+      return MIDITestUtils.stableId(this);
+    },
     name: "Test State MIDI Device Output Port",
     manufacturer: "Test Manufacturer",
     version: "1.0.0",
   },
   alwaysClosedTestOutputInfo: {
-    id: "f87d0c76-3c68-49a9-a44f-700f1125c07a",
+    get id() {
+      return MIDITestUtils.stableId(this);
+    },
     name: "Always Closed MIDI Device Output Port",
     manufacturer: "Test Manufacturer",
     version: "1.0.0",
@@ -60,4 +70,27 @@
       is(expected[i], actual[i], "Packet value " + expected[i] + " matches.");
     }
   },
+  stableId: info => {
+    // This computes the stable ID of a MIDI port according to the logic we
+    // use in the Web MIDI implementation. See MIDIPortChild::GenerateStableId()
+    // and nsContentUtils::AnonymizeId().
+    const Cc = SpecialPowers.Cc;
+    const Ci = SpecialPowers.Ci;
+    const id = info.name + info.manufacturer + info.version;
+    const encoder = new TextEncoder();
+    const data = encoder.encode(id);
+    let key = self.origin;
+
+    var digest;
+    let keyObject = Cc["@mozilla.org/security/keyobjectfactory;1"]
+      .getService(Ci.nsIKeyObjectFactory)
+      .keyFromString(Ci.nsIKeyObject.HMAC, key);
+    let cryptoHMAC = Cc["@mozilla.org/security/hmac;1"].createInstance(
+      Ci.nsICryptoHMAC
+    );
+
+    cryptoHMAC.init(Ci.nsICryptoHMAC.SHA256, keyObject);
+    cryptoHMAC.update(data, data.length);
+    return cryptoHMAC.finish(true);
+  },
 };