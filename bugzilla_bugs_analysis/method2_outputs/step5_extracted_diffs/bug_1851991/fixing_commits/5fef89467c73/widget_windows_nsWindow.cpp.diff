# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: widget/windows/nsWindow.cpp
# Commit: 5fef89467c73
# Full Hash: 5fef89467c73cf0f3fdef5dda3f15a100a87bed3
# Author: Bas Schouten <bschouten@mozilla.com>
# Date: 2023-09-15 04:35:42
# Description:
#   Bug 1851991: Do not try to raise the GPU process priority when it hasn't been initialized yet. r=jrmuizel
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D188275
# ==============================================================================

diff -r 41a90b2b2d83 -r 5fef89467c73 widget/windows/nsWindow.cpp
--- a/widget/windows/nsWindow.cpp	Thu Sep 14 19:10:26 2023 +0000
+++ b/widget/windows/nsWindow.cpp	Thu Sep 14 19:12:37 2023 +0000
@@ -5758,7 +5758,13 @@
     } break;
 
     case WM_ACTIVATEAPP: {
-      GPUProcessManager::Get()->SetAppInForeground(wParam);
+      // Bug 1851991: Sometimes this can be called before gfxPlatform::Init
+      // when a window is created very early. In that case we just forego
+      // setting this and accept the GPU process might briefly run at a lower
+      // priority.
+      if (GPUProcessManager::Get()) {
+        GPUProcessManager::Get()->SetAppInForeground(wParam);
+      }
     } break;
 
     case WM_MOUSEACTIVATE:
