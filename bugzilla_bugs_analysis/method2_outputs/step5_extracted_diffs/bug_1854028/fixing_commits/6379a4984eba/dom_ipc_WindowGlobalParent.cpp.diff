# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/ipc/WindowGlobalParent.cpp
# Commit: 6379a4984eba
# Full Hash: 6379a4984ebafb659428ec3e4493f72173b3a70a
# Author: Paul Zuehlcke <pbz@mozilla.com>
# Date: 2023-09-22 04:22:03
# Description:
#   Bug 1854028 - Update BounceTrackingStorageObserver cookie check and remove nsICookieNotification isThirdPartyCookie. r=bvandersloot,cookie-reviewers,anti-tracking-reviewers,timhuang
#   
#   For the BounceTrackingStorageObserver, instead of passing in a third-party flag
#   we can simply check if the changed cookie is partitioned or not.
#   
# ==============================================================================

diff -r 24c5f04d3793 -r 6379a4984eba dom/ipc/WindowGlobalParent.cpp
--- a/dom/ipc/WindowGlobalParent.cpp	Thu Sep 21 14:30:17 2023 +0000
+++ b/dom/ipc/WindowGlobalParent.cpp	Thu Sep 21 14:42:32 2023 +0000
@@ -1641,38 +1641,8 @@
   NS_ENSURE_TRUE(csParent, IPC_OK());
   auto* cs = static_cast<net::CookieServiceParent*>(csParent);
 
-  dom::BrowsingContext* browsingContext = GetBrowsingContext();
-
-  bool isThirdPartyCookie = false;
-  uint64_t browsingContextId = 0;
-
-  if (browsingContext && !browsingContext->IsDiscarded()) {
-    browsingContextId = browsingContext->Id();
-
-    // Check if the cookies being set are third-party to the top level. We do
-    // this by comparing the top level principals base domain with aBaseDomain.
-    if (!browsingContext->IsTop()) {
-      dom::BrowsingContext* topBC = browsingContext->Top();
-      MOZ_ASSERT(topBC);
-
-      RefPtr<WindowGlobalParent> topWGP =
-          topBC->Canonical()->GetEmbedderWindowGlobal();
-
-      if (!NS_WARN_IF(!topWGP)) {
-        nsCOMPtr<nsIPrincipal> topPrincipal = topWGP->DocumentPrincipal();
-        MOZ_ASSERT(topPrincipal);
-        nsAutoCString topBaseDomain;
-        nsresult rv = topPrincipal->GetBaseDomain(topBaseDomain);
-
-        if (!NS_WARN_IF(NS_FAILED(rv))) {
-          isThirdPartyCookie = aBaseDomain.Equals(topBaseDomain);
-        }
-      }
-    }
-  }
-
   return cs->SetCookies(aBaseDomain, aOriginAttributes, aHost, aFromHttp,
-                        aCookies, browsingContextId, isThirdPartyCookie);
+                        aCookies, GetBrowsingContext());
 }
 
 NS_IMPL_CYCLE_COLLECTION_INHERITED(WindowGlobalParent, WindowContext,