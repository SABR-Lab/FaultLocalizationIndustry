# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/cookie/CookieService.cpp
# Commit: 36aa6faea947
# Full Hash: 36aa6faea9477a13b6d94e396596697e56675018
# Author: Paul Zuehlcke <pbz@mozilla.com>
# Date: 2023-09-19 03:53:26
# Regressor Bug: 1839918
# File Overlap Count: 6
# Description:
#   Bug 1839918 - Refactor "cookie-changed" notifications to use nsICookieNotification. r=extension-reviewers,cookie-reviewers,sessionstore-reviewers,bvandersloot,edgul,robwu
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D185300
# ==============================================================================

diff -r 905592ffa91d -r 36aa6faea947 netwerk/cookie/CookieService.cpp
--- a/netwerk/cookie/CookieService.cpp	Mon Sep 18 11:25:24 2023 +0000
+++ b/netwerk/cookie/CookieService.cpp	Mon Sep 18 11:55:08 2023 +0000
@@ -581,9 +581,9 @@
       do_QueryInterface(aDocument->GetChannel());
 
   // add the cookie to the list. AddCookie() takes care of logging.
-  PickStorage(attrs)->AddCookie(crc, baseDomain, attrs, cookie,
-                                currentTimeInUsec, documentURI, aCookieString,
-                                false);
+  PickStorage(attrs)->AddCookie(
+      crc, baseDomain, attrs, cookie, currentTimeInUsec, documentURI,
+      aCookieString, false, aDocument->GetBrowsingContext(), thirdParty);
   return NS_OK;
 }
 
@@ -729,9 +729,12 @@
     cookie->SetCreationTime(
         Cookie::GenerateUniqueCreationTime(currentTimeInUsec));
 
+    RefPtr<BrowsingContext> bc = loadInfo->GetBrowsingContext();
+
     // add the cookie to the list. AddCookie() takes care of logging.
     storage->AddCookie(crc, baseDomain, attrs, cookie, currentTimeInUsec,
-                       aHostURI, aCookieHeader, true);
+                       aHostURI, aCookieHeader, true, bc,
+                       loadInfo->GetIsThirdPartyContextToTopWindow());
   }
 
   return NS_OK;
@@ -859,7 +862,8 @@
 
   CookieStorage* storage = PickStorage(*aOriginAttributes);
   storage->AddCookie(nullptr, baseDomain, *aOriginAttributes, cookie,
-                     currentTimeInUsec, nullptr, VoidCString(), true);
+                     currentTimeInUsec, nullptr, VoidCString(), true, nullptr,
+                     false);
   return NS_OK;
 }
 
@@ -2517,7 +2521,7 @@
         Cookie::GenerateUniqueCreationTime(currentTimeInUsec));
 
     storage->AddCookie(nullptr, aBaseDomain, aAttrs, cookie, currentTimeInUsec,
-                       aHostURI, ""_ns, aFromHttp);
+                       aHostURI, ""_ns, aFromHttp, nullptr, false);
   }
 
   return true;