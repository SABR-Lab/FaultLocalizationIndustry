# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/ipc/BrowserChild.cpp
# Commit: 024cf173d87d
# Full Hash: 024cf173d87dbc5d3b581d2b121e3d8295e4f46f
# Author: Dan Robertson <drobertson@mozilla.com>
# Date: 2023-09-26 09:27:49
# Regressor Bug: 1816473
# File Overlap Count: 3
# Description:
#   Bug 1816473 - Do not delay dispatching synthesized mouse events. r=botond,edgar
#   
#   Do not delay dispatching synthesized mouse events for a single tap
#   gesture.
#   
# ==============================================================================

diff -r 37eee8ccc556 -r 024cf173d87d dom/ipc/BrowserChild.cpp
--- a/dom/ipc/BrowserChild.cpp	Mon Sep 25 19:08:05 2023 +0000
+++ b/dom/ipc/BrowserChild.cpp	Mon Sep 25 19:13:07 2023 +0000
@@ -773,6 +773,11 @@
     }
     mLayersId = layers::LayersId{0};
   }
+
+  if (mAPZEventState) {
+    mAPZEventState->Destroy();
+    mAPZEventState = nullptr;
+  }
 }
 
 void BrowserChild::ActorDestroy(ActorDestroyReason why) {
@@ -1320,10 +1325,7 @@
   // event loop, which may release this, so we hold a strong reference here.
   RefPtr<BrowserChild> kungFuDeathGrip(this);
   RefPtr<PresShell> presShell = GetTopLevelPresShell();
-  if (!presShell) {
-    return IPC_OK();
-  }
-  if (!presShell->GetPresContext()) {
+  if (!presShell || !presShell->GetPresContext() || !mAPZEventState) {
     return IPC_OK();
   }
   CSSToLayoutDeviceScale scale(
@@ -1384,7 +1386,10 @@
     const ViewID& aViewId,
     const layers::GeckoContentController::APZStateChange& aChange,
     const int& aArg, Maybe<uint64_t> aInputBlockId) {
-  mAPZEventState->ProcessAPZStateChange(aViewId, aChange, aArg, aInputBlockId);
+  if (mAPZEventState) {
+    mAPZEventState->ProcessAPZStateChange(aViewId, aChange, aArg,
+                                          aInputBlockId);
+  }
   nsCOMPtr<nsIObserverService> observerService =
       mozilla::services::GetObserverService();
   if (aChange ==
@@ -1656,7 +1661,7 @@
 
   DispatchWidgetEventViaAPZ(localEvent);
 
-  if (aInputBlockId && localEvent.mFlags.mHandledByAPZ) {
+  if (aInputBlockId && localEvent.mFlags.mHandledByAPZ && mAPZEventState) {
     mAPZEventState->ProcessMouseEvent(localEvent, aInputBlockId);
   }
 
@@ -1730,7 +1735,7 @@
     SendRespondStartSwipeEvent(aInputBlockId, localEvent.TriggersSwipe());
   }
 
-  if (aInputBlockId && aEvent.mFlags.mHandledByAPZ) {
+  if (aInputBlockId && aEvent.mFlags.mHandledByAPZ && mAPZEventState) {
     mAPZEventState->ProcessWheelEvent(localEvent, aInputBlockId);
   }
 }
@@ -1830,9 +1835,11 @@
     return IPC_OK();
   }
 
-  mAPZEventState->ProcessTouchEvent(localEvent, aGuid, aInputBlockId,
-                                    aApzResponse, status,
-                                    std::move(allowedTouchBehaviors));
+  if (mAPZEventState) {
+    mAPZEventState->ProcessTouchEvent(localEvent, aGuid, aInputBlockId,
+                                      aApzResponse, status,
+                                      std::move(allowedTouchBehaviors));
+  }
   return IPC_OK();
 }
 