# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/events/EventStateManager.cpp
# Commit: 88bd13bb33d1
# Full Hash: 88bd13bb33d1d623619e8956cc71cde0e3797a4d
# Author: Dan Robertson <drobertson@mozilla.com>
# Date: 2023-08-24 14:56:02
# Regressor Bug: 1816473
# File Overlap Count: 1
# Description:
#   Bug 1816473 - Do not delay dispatching synthesized mouse events. r=botond,edgar
#   
#   Do not delay dispatching synthesized mouse events for a single tap
#   gesture.
#   
# ==============================================================================

diff -r 1d5eb1343cc8 -r 88bd13bb33d1 dom/events/EventStateManager.cpp
--- a/dom/events/EventStateManager.cpp	Wed Aug 23 19:53:47 2023 -0400
+++ b/dom/events/EventStateManager.cpp	Wed Aug 23 23:57:25 2023 +0000
@@ -3642,8 +3642,13 @@
       // we should never be capturing when the mouse button is up
       PresShell::ReleaseCapturingContent();
 
-      ClearGlobalActiveContent(this);
       WidgetMouseEvent* mouseUpEvent = aEvent->AsMouseEvent();
+      // If the mouseup event is a synthesized mouse event due to a touch, do
+      // not clear the activation state. Element activation is handled by APZ.
+      if (!mouseUpEvent || mouseUpEvent->mInputSource !=
+                               dom::MouseEvent_Binding::MOZ_SOURCE_TOUCH) {
+        ClearGlobalActiveContent(this);
+      }
       if (mouseUpEvent && EventCausesClickEvents(*mouseUpEvent)) {
         // Make sure to dispatch the click even if there is no frame for
         // the current target element. This is required for Web compatibility.