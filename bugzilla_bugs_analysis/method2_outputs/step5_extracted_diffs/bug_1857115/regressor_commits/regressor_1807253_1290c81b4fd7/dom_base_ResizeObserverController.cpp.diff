# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/ResizeObserverController.cpp
# Commit: 1290c81b4fd7
# Full Hash: 1290c81b4fd788222a335a1bbe07747b28d22ae9
# Author: Alexander Surkov <surkov.alexander@gmail.com>
# Date: 2023-10-03 15:57:45
# Regressor Bug: 1807253
# File Overlap Count: 1
# Description:
#   Bug 1807253 - get rid of ResizeObserverNotificationHelper, r=emilio
#   
#   Integrate resize observer processing with RefreshDriver to make it
#   more extensible.
#   
# ==============================================================================

diff -r 5502331146fe -r 1290c81b4fd7 dom/base/ResizeObserverController.cpp
--- a/dom/base/ResizeObserverController.cpp	Tue Oct 03 09:40:06 2023 +0000
+++ b/dom/base/ResizeObserverController.cpp	Tue Oct 03 09:48:46 2023 +0000
@@ -18,68 +18,6 @@
 
 namespace mozilla::dom {
 
-void ResizeObserverNotificationHelper::WillRefresh(TimeStamp aTime) {
-  MOZ_DIAGNOSTIC_ASSERT(mOwner, "Should've de-registered on-time!");
-  mOwner->Notify();
-  // Note that mOwner may be null / dead here.
-}
-
-nsRefreshDriver* ResizeObserverNotificationHelper::GetRefreshDriver() const {
-  PresShell* presShell = mOwner->GetPresShell();
-  if (MOZ_UNLIKELY(!presShell)) {
-    return nullptr;
-  }
-
-  nsPresContext* presContext = presShell->GetPresContext();
-  if (MOZ_UNLIKELY(!presContext)) {
-    return nullptr;
-  }
-
-  return presContext->RefreshDriver();
-}
-
-void ResizeObserverNotificationHelper::Register() {
-  if (mRegistered) {
-    return;
-  }
-
-  nsRefreshDriver* refreshDriver = GetRefreshDriver();
-  if (!refreshDriver) {
-    // We maybe navigating away from this page or currently in an iframe with
-    // display: none. Just abort the Register(), no need to do notification.
-    return;
-  }
-
-  refreshDriver->AddRefreshObserver(this, FlushType::Display, "ResizeObserver");
-  mRegistered = true;
-}
-
-void ResizeObserverNotificationHelper::Unregister() {
-  if (!mRegistered) {
-    return;
-  }
-
-  nsRefreshDriver* refreshDriver = GetRefreshDriver();
-  MOZ_RELEASE_ASSERT(
-      refreshDriver,
-      "We should not leave a dangling reference to the observer around");
-
-  bool rv = refreshDriver->RemoveRefreshObserver(this, FlushType::Display);
-  MOZ_DIAGNOSTIC_ASSERT(rv, "Should remove the observer successfully");
-  Unused << rv;
-
-  mRegistered = false;
-}
-
-ResizeObserverNotificationHelper::~ResizeObserverNotificationHelper() {
-  MOZ_RELEASE_ASSERT(!mRegistered, "How can we die when registered?");
-  MOZ_RELEASE_ASSERT(!mOwner, "Forgot to clear weak pointer?");
-}
-
-void ResizeObserverController::ShellDetachedFromDocument() {
-  mResizeObserverNotificationHelper->Unregister();
-}
-
 static void FlushLayoutForWholeBrowsingContextTree(Document& aDoc) {
   if (BrowsingContext* bc = aDoc.GetBrowsingContext()) {
     RefPtr<BrowsingContext> top = bc->Top();
@@ -95,7 +33,7 @@
 }
 
 void ResizeObserverController::Notify() {
-  mResizeObserverNotificationHelper->Unregister();
+  UnscheduleNotification();
   if (mResizeObservers.IsEmpty()) {
     return;
   }
@@ -215,14 +153,38 @@
 }
 
 void ResizeObserverController::ScheduleNotification() {
-  mResizeObserverNotificationHelper->Register();
+  if (mScheduled) {
+    return;
+  }
+
+  nsRefreshDriver* refreshDriver = GetRefreshDriver();
+  if (!refreshDriver) {
+    // We maybe navigating away from this page or currently in an iframe with
+    // display: none. Just abort the Register(), no need to do notification.
+    return;
+  }
+
+  refreshDriver->ResizeObserverControllerAdded();
+  mScheduled = true;
+}
+
+void ResizeObserverController::UnscheduleNotification() {
+  if (!mScheduled) {
+    return;
+  }
+
+  nsRefreshDriver* refreshDriver = GetRefreshDriver();
+  MOZ_RELEASE_ASSERT(
+      refreshDriver,
+      "We should not leave a dangling reference to the observer around");
+
+  refreshDriver->ResizeObserverControllerRemoved();
+  mScheduled = false;
 }
 
 ResizeObserverController::~ResizeObserverController() {
-  MOZ_RELEASE_ASSERT(
-      !mResizeObserverNotificationHelper->IsRegistered(),
-      "Nothing else should keep a reference to our helper when we go away");
-  mResizeObserverNotificationHelper->DetachFromOwner();
+  MOZ_RELEASE_ASSERT(!mScheduled,
+                     "Nothing else should be scheduled when we go away");
 }
 
 void ResizeObserverController::AddSizeOfIncludingThis(
@@ -235,4 +197,18 @@
   aSizes.mDOMSizes.mDOMResizeObserverControllerSize += size;
 }
 
+nsRefreshDriver* ResizeObserverController::GetRefreshDriver() const {
+  PresShell* presShell = mDocument->GetPresShell();
+  if (MOZ_UNLIKELY(!presShell)) {
+    return nullptr;
+  }
+
+  nsPresContext* presContext = presShell->GetPresContext();
+  if (MOZ_UNLIKELY(!presContext)) {
+    return nullptr;
+  }
+
+  return presContext->RefreshDriver();
+}
+
 }  // namespace mozilla::dom