# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/ResizeObserver.cpp
# Commit: 3508e2bd4e3c
# Full Hash: 3508e2bd4e3cbc756cff7da7aee3c60c29c15bd1
# Author: Frédéric Wang <fwang@igalia.com>
# Date: 2024-02-29 21:06:42
# Regressor Bug: 1807253
# File Overlap Count: 1
# Description:
#   Bug 1880928 - Remove last remembered size observer, handle it in Document::DetermineProximityToViewportAndNotifyResizeObservers. r=emilio,layout-reviewers
#   
#   The CSS Box Sizing specification indicates that last remembered sizes
#   are recorded "at the time that ResizeObserver events are determined and
#   delivered" [1].
# ==============================================================================

diff -r 467f563c9ea5 -r 3508e2bd4e3c dom/base/ResizeObserver.cpp
--- a/dom/base/ResizeObserver.cpp	Thu Feb 29 08:50:55 2024 +0000
+++ b/dom/base/ResizeObserver.cpp	Thu Feb 29 08:50:55 2024 +0000
@@ -66,16 +66,9 @@
   return aFrame.GetContentRectRelativeToSelf().Size();
 }
 
-/**
- * Returns |aTarget|'s size in the form of gfx::Size (in pixels).
- * If the target is an SVG that does not participate in CSS layout,
- * its width and height are determined from bounding box.
- *
- * https://www.w3.org/TR/resize-observer-1/#calculate-box-size
- */
-static AutoTArray<LogicalPixelSize, 1> CalculateBoxSize(
+AutoTArray<LogicalPixelSize, 1> ResizeObserver::CalculateBoxSize(
     Element* aTarget, ResizeObserverBoxOptions aBox,
-    const ResizeObserver& aObserver) {
+    bool aForceFragmentHandling) {
   nsIFrame* frame = aTarget->GetPrimaryFrame();
 
   if (!frame) {
@@ -158,7 +151,7 @@
     return CSSPixel::FromAppUnits(GetContentRectSize(*aFrame)).ToUnknownSize();
   };
   if (!StaticPrefs::dom_resize_observer_support_fragments() &&
-      !aObserver.HasNativeCallback()) {
+      !aForceFragmentHandling) {
     return {LogicalPixelSize(frame->GetWritingMode(), GetFrameSize(frame))};
   }
   AutoTArray<LogicalPixelSize, 1> size;
@@ -209,7 +202,7 @@
   }
 
   return mLastReportedSize !=
-         CalculateBoxSize(mTarget, mObservedBox, *mObserver);
+         ResizeObserver::CalculateBoxSize(mTarget, mObservedBox);
 }
 
 void ResizeObservation::UpdateLastReportedSize(
@@ -383,12 +376,12 @@
   for (auto& observation : mActiveTargets) {
     Element* target = observation->Target();
 
-    auto borderBoxSize =
-        CalculateBoxSize(target, ResizeObserverBoxOptions::Border_box, *this);
-    auto contentBoxSize =
-        CalculateBoxSize(target, ResizeObserverBoxOptions::Content_box, *this);
-    auto devicePixelContentBoxSize = CalculateBoxSize(
-        target, ResizeObserverBoxOptions::Device_pixel_content_box, *this);
+    auto borderBoxSize = ResizeObserver::CalculateBoxSize(
+        target, ResizeObserverBoxOptions::Border_box);
+    auto contentBoxSize = ResizeObserver::CalculateBoxSize(
+        target, ResizeObserverBoxOptions::Content_box);
+    auto devicePixelContentBoxSize = ResizeObserver::CalculateBoxSize(
+        target, ResizeObserverBoxOptions::Device_pixel_content_box);
     RefPtr<ResizeObserverEntry> entry =
         new ResizeObserverEntry(mOwner, *target, borderBoxSize, contentBoxSize,
                                 devicePixelContentBoxSize);
@@ -524,61 +517,6 @@
   }
 }
 
-static void LastRememberedSizeCallback(
-    const Sequence<OwningNonNull<ResizeObserverEntry>>& aEntries,
-    ResizeObserver& aObserver) {
-  for (const auto& entry : aEntries) {
-    Element* target = entry->Target();
-    if (!target->IsInComposedDoc()) {
-      aObserver.Unobserve(*target);
-      target->RemoveLastRememberedBSize();
-      target->RemoveLastRememberedISize();
-      continue;
-    }
-    nsIFrame* frame = target->GetPrimaryFrame();
-    if (!frame) {
-      aObserver.Unobserve(*target);
-      continue;
-    }
-    MOZ_ASSERT(!frame->IsLineParticipant() || frame->IsReplaced(),
-               "Should have unobserved non-replaced inline.");
-    MOZ_ASSERT(!frame->HidesContent(),
-               "Should have unobserved element skipping its contents.");
-    const nsStylePosition* stylePos = frame->StylePosition();
-    const WritingMode wm = frame->GetWritingMode();
-    bool canUpdateBSize = stylePos->ContainIntrinsicBSize(wm).HasAuto();
-    bool canUpdateISize = stylePos->ContainIntrinsicISize(wm).HasAuto();
-    MOZ_ASSERT(canUpdateBSize || !target->HasLastRememberedBSize(),
-               "Should have removed the last remembered block size.");
-    MOZ_ASSERT(canUpdateISize || !target->HasLastRememberedISize(),
-               "Should have removed the last remembered inline size.");
-    MOZ_ASSERT(canUpdateBSize || canUpdateISize,
-               "Should have unobserved if we can't update any size.");
-    AutoTArray<RefPtr<ResizeObserverSize>, 1> contentSizeList;
-    entry->GetContentBoxSize(contentSizeList);
-    MOZ_ASSERT(!contentSizeList.IsEmpty());
-    if (canUpdateBSize) {
-      float bSize = 0;
-      for (const auto& current : contentSizeList) {
-        bSize += current->BlockSize();
-      }
-      target->SetLastRememberedBSize(bSize);
-    }
-    if (canUpdateISize) {
-      float iSize = 0;
-      for (const auto& current : contentSizeList) {
-        iSize = std::max(iSize, current->InlineSize());
-      }
-      target->SetLastRememberedISize(iSize);
-    }
-  }
-}
-
-/* static */ already_AddRefed<ResizeObserver>
-ResizeObserver::CreateLastRememberedSizeObserver(Document& aDocument) {
-  return do_AddRef(new ResizeObserver(aDocument, LastRememberedSizeCallback));
-}
-
 NS_IMPL_CYCLE_COLLECTION_WRAPPERCACHE(ResizeObserverSize, mOwner)
 NS_IMPL_CYCLE_COLLECTING_ADDREF(ResizeObserverSize)
 NS_IMPL_CYCLE_COLLECTING_RELEASE(ResizeObserverSize)