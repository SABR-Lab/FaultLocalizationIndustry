# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/svg/SVGLength.cpp
# Commit: 2f48a6566514
# Full Hash: 2f48a65665147ef98c0f1e7d26a99f1931f9470d
# Author: Robert Longson <longsonr@gmail.com>
# Date: 2023-09-12 21:17:53
# Regressor Bug: 1287054
# File Overlap Count: 1
# Description:
#   Bug 1287054 part 1 - support rem, ch, ic and cap units for non-CSS lengths r=emilio,jgilbert
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D180618
# ==============================================================================

diff -r fc9333c3b9f7 -r 2f48a6566514 dom/svg/SVGLength.cpp
--- a/dom/svg/SVGLength.cpp	Tue Sep 12 11:25:16 2023 +0000
+++ b/dom/svg/SVGLength.cpp	Tue Sep 12 11:45:26 2023 +0000
@@ -21,6 +21,10 @@
 namespace mozilla {
 
 const unsigned short SVG_LENGTHTYPE_Q = 11;
+const unsigned short SVG_LENGTHTYPE_CH = 12;
+const unsigned short SVG_LENGTHTYPE_REM = 13;
+const unsigned short SVG_LENGTHTYPE_IC = 14;
+const unsigned short SVG_LENGTHTYPE_CAP = 15;
 
 void SVGLength::GetValueAsString(nsAString& aValue) const {
   nsTextFormatter::ssprintf(aValue, u"%g", (double)mValue);
@@ -65,7 +69,8 @@
 
 /*static*/
 bool SVGLength::IsFontRelativeUnit(uint8_t aUnit) {
-  return aUnit == SVG_LENGTHTYPE_EMS || aUnit == SVG_LENGTHTYPE_EXS;
+  return aUnit == SVG_LENGTHTYPE_EMS || aUnit == SVG_LENGTHTYPE_EXS ||
+         (aUnit >= SVG_LENGTHTYPE_CH && aUnit <= SVG_LENGTHTYPE_CAP);
 }
 
 /**
@@ -166,9 +171,17 @@
     case SVG_LENGTHTYPE_PERCENTAGE:
       return aMetrics.GetAxisLength(aAxis) / 100.0f;
     case SVG_LENGTHTYPE_EMS:
-      return aMetrics.GetEmLength();
+      return aMetrics.GetEmLength(UserSpaceMetrics::Type::This);
     case SVG_LENGTHTYPE_EXS:
-      return aMetrics.GetExLength();
+      return aMetrics.GetExLength(UserSpaceMetrics::Type::This);
+    case SVG_LENGTHTYPE_CH:
+      return aMetrics.GetChSize(UserSpaceMetrics::Type::This);
+    case SVG_LENGTHTYPE_REM:
+      return aMetrics.GetEmLength(UserSpaceMetrics::Type::Root);
+    case SVG_LENGTHTYPE_IC:
+      return aMetrics.GetIcWidth(UserSpaceMetrics::Type::This);
+    case SVG_LENGTHTYPE_CAP:
+      return aMetrics.GetCapHeight(UserSpaceMetrics::Type::This);
     default:
       MOZ_ASSERT(IsAbsoluteUnit(aUnitType));
       return GetAbsUnitsPerAbsUnit(SVG_LENGTHTYPE_PX, aUnitType);
@@ -209,6 +222,18 @@
     case SVG_LENGTHTYPE_Q:
       return nsCSSUnit::eCSSUnit_Quarter;
 
+    case SVG_LENGTHTYPE_CH:
+      return nsCSSUnit::eCSSUnit_Char;
+
+    case SVG_LENGTHTYPE_REM:
+      return nsCSSUnit::eCSSUnit_RootEM;
+
+    case SVG_LENGTHTYPE_IC:
+      return nsCSSUnit::eCSSUnit_Ideographic;
+
+    case SVG_LENGTHTYPE_CAP:
+      return nsCSSUnit::eCSSUnit_CapHeight;
+
     default:
       MOZ_ASSERT_UNREACHABLE("Unknown unit type");
       return nsCSSUnit::eCSSUnit_Pixel;
@@ -251,6 +276,18 @@
     case SVG_LENGTHTYPE_Q:
       aUnit.AssignLiteral("q");
       return;
+    case SVG_LENGTHTYPE_CH:
+      aUnit.AssignLiteral("ch");
+      return;
+    case SVG_LENGTHTYPE_REM:
+      aUnit.AssignLiteral("rem");
+      return;
+    case SVG_LENGTHTYPE_IC:
+      aUnit.AssignLiteral("ic");
+      return;
+    case SVG_LENGTHTYPE_CAP:
+      aUnit.AssignLiteral("cap");
+      return;
   }
   MOZ_ASSERT_UNREACHABLE(
       "Unknown unit type! Someone's using an SVGLength "
@@ -292,6 +329,18 @@
   if (aUnit.LowerCaseEqualsLiteral("q")) {
     return SVG_LENGTHTYPE_Q;
   }
+  if (aUnit.LowerCaseEqualsLiteral("ch")) {
+    return SVG_LENGTHTYPE_CH;
+  }
+  if (aUnit.LowerCaseEqualsLiteral("rem")) {
+    return SVG_LENGTHTYPE_REM;
+  }
+  if (aUnit.LowerCaseEqualsLiteral("ic")) {
+    return SVG_LENGTHTYPE_IC;
+  }
+  if (aUnit.LowerCaseEqualsLiteral("cap")) {
+    return SVG_LENGTHTYPE_CAP;
+  }
   return SVG_LENGTHTYPE_UNKNOWN;
 }
 