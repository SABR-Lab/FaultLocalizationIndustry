# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/platforms/agnostic/bytestreams/H265.cpp
# Commit: c11a6ced9c51
# Full Hash: c11a6ced9c51a8c43592e0bc79a3de96c0b40efe
# Author: alwu <alwu@mozilla.com>
# Date: 2023-10-19 04:20:43
# Description:
#   Bug 1859600 - abort parsing NALU if the NALU size is incorrect. r=media-playback-reviewers,padenot
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D191241
# ==============================================================================

diff -r d3d97163dde6 -r c11a6ced9c51 dom/media/platforms/agnostic/bytestreams/H265.cpp
--- a/dom/media/platforms/agnostic/bytestreams/H265.cpp	Wed Oct 18 17:15:25 2023 +0000
+++ b/dom/media/platforms/agnostic/bytestreams/H265.cpp	Wed Oct 18 17:15:25 2023 +0000
@@ -142,7 +142,12 @@
     for (uint16_t nIdx = 0; nIdx < numNalus; nIdx++) {
       const uint16_t nalUnitLength = reader.ReadBits(16);
       if (reader.BitsLeft() < nalUnitLength * 8) {
-        return mozilla::Err(NS_ERROR_FAILURE);
+        LOG("Aborting parsing, NALU size (%u bits) is larger than remaining "
+            "(%zu bits)!",
+            nalUnitLength * 8u, reader.BitsLeft());
+        // We return what we've parsed so far and ignore the rest.
+        hvcc.mByteBuffer = aExtraData;
+        return hvcc;
       }
       const uint8_t* currentPtr =
           aExtraData->Elements() + reader.BitCount() / 8;