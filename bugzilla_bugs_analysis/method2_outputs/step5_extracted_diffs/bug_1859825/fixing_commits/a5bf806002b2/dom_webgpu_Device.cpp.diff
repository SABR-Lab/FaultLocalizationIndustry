# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/webgpu/Device.cpp
# Commit: a5bf806002b2
# Full Hash: a5bf806002b2602576d298b336972bb453d55f4d
# Author: Brad Werth <bwerth@mozilla.com>
# Date: 2023-10-23 21:53:18
# Description:
#   Bug 1859825: Ensure that WebGPU Buffers are only dropped once. r=webgpu-reviewers,nical
#   
#   In addition to moving the valid check earlier in Buffer::Drop, this
#   patch also ensures that Device clears the tracked buffers set after they
#   have been unmapped, and cleans up the error handling in Device::GetLost.
# ==============================================================================

diff -r f222bdcd6517 -r a5bf806002b2 dom/webgpu/Device.cpp
--- a/dom/webgpu/Device.cpp	Mon Oct 23 15:45:23 2023 +0000
+++ b/dom/webgpu/Device.cpp	Mon Oct 23 15:48:55 2023 +0000
@@ -105,6 +105,7 @@
 void Device::SetLabel(const nsAString& aLabel) { mLabel = aLabel; }
 
 dom::Promise* Device::GetLost(ErrorResult& aRv) {
+  aRv = NS_OK;
   if (!mLostPromise) {
     mLostPromise = dom::Promise::Create(GetParentObject(), aRv);
     if (mLostPromise && !mBridge->CanSend()) {
@@ -118,7 +119,7 @@
 
 void Device::ResolveLost(Maybe<dom::GPUDeviceLostReason> aReason,
                          const nsAString& aMessage) {
-  ErrorResult rv;
+  IgnoredErrorResult rv;
   dom::Promise* lostPromise = GetLost(rv);
   if (!lostPromise) {
     // Promise doesn't exist? Maybe out of memory.
@@ -374,6 +375,8 @@
     for (const auto& buffer : mTrackedBuffers) {
       buffer->Unmap(jsapi.cx(), rv);
     }
+
+    mTrackedBuffers.Clear();
   }
 
   mBridge->SendDeviceDestroy(mId);
