# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/webgpu/ipc/WebGPUChild.cpp
# Commit: f214290956c1
# Full Hash: f214290956c1c17ab7da33be0868521198ad3112
# Author: Brad Werth <bwerth@mozilla.com>
# Date: 2023-10-17 03:58:35
# Regressor Bug: 1838693
# File Overlap Count: 2
# Description:
#   Bug 1838693 Part 2: Rationalize GPUDevice lost promise handling. r=webgpu-reviewers,nical
#   
#   This ensures that both internal and external triggers of "lose the
#   device" resolve the lost promise using the same code path.
#   
# ==============================================================================

diff -r 843c7d19787b -r f214290956c1 dom/webgpu/ipc/WebGPUChild.cpp
--- a/dom/webgpu/ipc/WebGPUChild.cpp	Mon Oct 16 15:31:59 2023 +0000
+++ b/dom/webgpu/ipc/WebGPUChild.cpp	Mon Oct 16 15:32:00 2023 +0000
@@ -1215,17 +1215,7 @@
       continue;
     }
 
-    RefPtr<dom::Promise> promise = device->MaybeGetLost();
-    if (!promise) {
-      continue;
-    }
-
-    auto info = MakeRefPtr<DeviceLostInfo>(device->GetParentObject(),
-                                           u"WebGPUChild destroyed"_ns);
-
-    // We have strong references to both the Device and the DeviceLostInfo and
-    // the Promise objects on the stack which keeps them alive for long enough.
-    promise->MaybeResolve(info);
+    device->ResolveLost(Nothing(), u"WebGPUChild destroyed"_ns);
   }
 }
 
