# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/painting/nsDisplayList.cpp
# Commit: 0fdbf0a455f2
# Full Hash: 0fdbf0a455f26afa0a7a0390d6a380e318fce9d4
# Author: Robert Longson <longsonr@gmail.com>
# Date: 2023-10-24 03:54:44
# Regressor Bug: 1765202
# File Overlap Count: 1
# Description:
#   Bug 1765202 part 3 - ignore clip-path and mask properties that don't point to clipPath and mask elements r=emilio
#   
#   This refactors the logic for testing whether something has a clip-path or mask and what to do about it in one place rather than using many overlapping functions.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D190767
# ==============================================================================

diff -r 2a8d11fcc746 -r 0fdbf0a455f2 layout/painting/nsDisplayList.cpp
--- a/layout/painting/nsDisplayList.cpp	Mon Oct 23 20:32:20 2023 +0000
+++ b/layout/painting/nsDisplayList.cpp	Mon Oct 23 20:32:37 2023 +0000
@@ -7921,13 +7921,7 @@
     return false;
   }
 
-  nsIFrame* firstFrame =
-      nsLayoutUtils::FirstContinuationOrIBSplitSibling(mFrame);
-
-  return !(SVGObserverUtils::GetAndObserveClipPath(firstFrame, nullptr) ==
-               SVGObserverUtils::eHasRefsSomeInvalid ||
-           SVGObserverUtils::GetAndObserveMasks(firstFrame, nullptr) ==
-               SVGObserverUtils::eHasRefsSomeInvalid);
+  return SVGUtils::DetermineMaskUsage(mFrame, false).UsingMaskOrClipPath();
 }
 
 bool nsDisplayMasksAndClipPaths::PaintMask(nsDisplayListBuilder* aBuilder,
@@ -8014,7 +8008,7 @@
   nsIFrame* frame = aDisplayItem.Frame();
   const auto* style = frame->StyleSVGReset();
   MOZ_ASSERT(style->HasClipPath() || style->HasMask());
-  if (!SVGIntegrationUtils::UsingSimpleClipPathForFrame(frame)) {
+  if (!SVGUtils::DetermineMaskUsage(frame, false).IsSimpleClipShape()) {
     return Nothing();
   }
 
@@ -8080,7 +8074,7 @@
       // without using a mask image.
       //
       // And if you _really really_ need to add an exception, add it to
-      // SVGIntegrationUtils::UsingSimpleClipPathForFrame
+      // SVGUtils::DetermineMaskUsage
       MOZ_ASSERT_UNREACHABLE("Unhandled shape id?");
       return Nothing();
   }
@@ -8181,7 +8175,7 @@
     bounds.MoveTo(0, 0);
 
     Maybe<float> opacity =
-        (SVGIntegrationUtils::UsingSimpleClipPathForFrame(mFrame) &&
+        (SVGUtils::DetermineMaskUsage(mFrame, false).IsSimpleClipShape() &&
          aBuilder.GetInheritedOpacity() != 1.0f)
             ? Some(aBuilder.GetInheritedOpacity())
             : Nothing();