# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: ipc/glue/UtilityProcessManager.h
# Commit: d56484304ec3
# Full Hash: d56484304ec3abe3891ede9e8d141c95543d3e37
# Author: Ray Kraesig <rkraesig@mozilla.com>
# Date: 2023-09-16 09:14:45
# Regressor Bug: 1837079
# File Overlap Count: 2
# Description:
#   Bug 1837079 - [5/10] Create WinFileDialog IPDL protocol and implementation  r=gstoll,handyman,ipc-reviewers,nika
#   
#   Create and implement a new top-level IPC protocol, `PWinFileDialog`,
#   using the primitives from bug 1833450 and the new sandboxing type from
#   the previous commit.
# ==============================================================================

diff -r 36d3afd881b4 -r d56484304ec3 ipc/glue/UtilityProcessManager.h
--- a/ipc/glue/UtilityProcessManager.h	Fri Sep 15 18:10:00 2023 +0000
+++ b/ipc/glue/UtilityProcessManager.h	Fri Sep 15 18:10:01 2023 +0000
@@ -23,6 +23,10 @@
 class WindowsUtilsParent;
 }  // namespace dom
 
+namespace widget::filedialog {
+class WinFileDialogParent;
+}  // namespace widget::filedialog
+
 namespace ipc {
 
 class UtilityProcessParent;
@@ -34,12 +38,19 @@
   friend class UtilityProcessParent;
 
  public:
+  template <typename T>
+  using Promise = MozPromise<T, nsresult, true>;
+
   using StartRemoteDecodingUtilityPromise =
-      MozPromise<Endpoint<PRemoteDecoderManagerChild>, nsresult, true>;
+      Promise<Endpoint<PRemoteDecoderManagerChild>>;
   using JSOraclePromise = GenericNonExclusivePromise;
 
-  using WindowsUtilsPromise =
-      MozPromise<RefPtr<dom::WindowsUtilsParent>, nsresult, true>;
+#ifdef XP_WIN
+  using WindowsUtilsPromise = Promise<RefPtr<dom::WindowsUtilsParent>>;
+
+  using WinFileDialogParent = widget::filedialog::WinFileDialogParent;
+  using WinFileDialogPromise = Promise<RefPtr<WinFileDialogParent>>;
+#endif
 
   static RefPtr<UtilityProcessManager> GetSingleton();
 
@@ -64,6 +75,10 @@
   // Releases the WindowsUtils actor so that it can be destroyed.
   // Subsequent attempts to use WindowsUtils will create a new process.
   void ReleaseWindowsUtils();
+
+  // Get a new Windows file-dialog utility-process actor. These are never
+  // reused; this will always return a fresh actor.
+  RefPtr<WinFileDialogPromise> CreateWinFileDialogAsync();
 #endif
 
   void OnProcessUnexpectedShutdown(UtilityProcessHost* aHost);