# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: gfx/layers/ipc/SharedSurfacesChild.h
# Commit: 923dee1aab01
# Full Hash: 923dee1aab0128ea4ff60b876a8626af322084d8
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2023-12-15 05:00:55
# Description:
#   Bug 1869933 - Avoid allocating external image ID until ready for sharing with compositor process. r=gfx-reviewers,lsalzman
#   
#   There are some error paths where we could allocate an external image ID
#   for a SourceSurfaceSharedData before we are able to finish sharing it.
#   This patch makes it so that we defer allocating the ID until the last
# ==============================================================================

diff -r ef864a709ce1 -r 923dee1aab01 gfx/layers/ipc/SharedSurfacesChild.h
--- a/gfx/layers/ipc/SharedSurfacesChild.h	Thu Dec 14 23:17:37 2023 +0200
+++ b/gfx/layers/ipc/SharedSurfacesChild.h	Thu Dec 14 20:08:59 2023 +0000
@@ -135,7 +135,7 @@
 
   class SharedUserData final : public Runnable {
    public:
-    explicit SharedUserData(const wr::ExternalImageId& aId);
+    SharedUserData();
     virtual ~SharedUserData();
 
     SharedUserData(const SharedUserData& aOther) = delete;
@@ -150,16 +150,16 @@
 
     const wr::ExternalImageId& Id() const { return mId; }
 
-    void SetId(const wr::ExternalImageId& aId) {
-      mId = aId;
+    void ClearShared() {
       mKeys.Clear();
       mShared = false;
     }
 
     bool IsShared() const { return mShared; }
 
-    void MarkShared() {
+    void MarkShared(const wr::ExternalImageId& aId) {
       MOZ_ASSERT(!mShared);
+      mId = aId;
       mShared = true;
     }
 