# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/nsStyleTransformMatrix.cpp
# Commit: e215151d2549
# Full Hash: e215151d2549581c23a1d3c8b53d8899f9776114
# Author: Boris Chiou <boris.chiou@gmail.com>
# Date: 2023-08-23 04:21:33
# Regressor Bug: 1819464
# File Overlap Count: 1
# Description:
#   Bug 1819464 - Part 5: Support stroke-box (for SVG layout). r=emilio
#   
#   We should avoid using the SVG shape elements, e.g. path, polygon, which may not
#   have simple bounds, and its stroke bbox contribution may depends on the
#   platform and the drawing backend if using Moz2D. So for now it'd be better to
# ==============================================================================

diff -r 803ea4d17810 -r e215151d2549 layout/style/nsStyleTransformMatrix.cpp
--- a/layout/style/nsStyleTransformMatrix.cpp	Tue Aug 22 19:49:04 2023 +0000
+++ b/layout/style/nsStyleTransformMatrix.cpp	Tue Aug 22 19:49:04 2023 +0000
@@ -73,9 +73,26 @@
         return computeViewBox();
       }
       [[fallthrough]];
-    case StyleTransformBox::StrokeBox:
-      // TODO: Implement this in the following patches.
-      return {};
+    case StyleTransformBox::StrokeBox: {
+      // We are using SVGUtils::PathExtentsToMaxStrokeExtents() to compute the
+      // bbox contribution for stroke box (if it doesn't have simple bounds),
+      // so the |strokeBox| here may be larger than the author's expectation.
+      // Using Moz2D to compute the tighter bounding box is another way but it
+      // has some potential issues (see SVGGeometryFrame::GetBBoxContribution()
+      // for more details), and its result depends on the drawing backend. So
+      // for now we still rely on our default calcuclation for SVG geometry
+      // frame reflow code. At least this works for the shape elements which
+      // have simple bounds.
+      // FIXME: Bug 1849054. We may have to update
+      // SVGGeometryFrame::GetBBoxContribution() to get tighter stroke bounds.
+      nsRect strokeBox = nsLayoutUtils::ComputeGeometryBox(
+          const_cast<nsIFrame*>(aFrame), StyleGeometryBox::StrokeBox);
+      // The |nsIFrame::mRect| includes markers, so we have to compute the
+      // offsets without markers.
+      return nsRect{strokeBox.x - aFrame->GetPosition().x,
+                    strokeBox.y - aFrame->GetPosition().y, strokeBox.width,
+                    strokeBox.height};
+    }
     case StyleTransformBox::ViewBox:
       return computeViewBox();
   }