# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/layers/GLImages.cpp
# Commit: da24abf34123
# Full Hash: da24abf341236e00fa47e9e55dc72c82ae8a8c84
# Author: Jamie Nicol <jnicol@mozilla.com>
# Date: 2023-12-14 17:20:20
# Regressor Bug: 1866020
# File Overlap Count: 1
# Description:
#   Bug 1866020 - Override buggy colorspace conversion on Pixel devices. r=gw,padenot,geckoview-reviewers,owlish
#   
#   Pixel 6, 7, and 8 devices running Android 14 are affected by a bug
#   where video frames with SMPTE 432 color primaries are rendered
#   incorrectly when sampled from an external texture in GLES. To work
# ==============================================================================

diff -r 3a34e7a424e0 -r da24abf34123 gfx/layers/GLImages.cpp
--- a/gfx/layers/GLImages.cpp	Thu Dec 14 10:08:52 2023 +0000
+++ b/gfx/layers/GLImages.cpp	Thu Dec 14 10:45:08 2023 +0000
@@ -111,13 +111,14 @@
 SurfaceTextureImage::SurfaceTextureImage(
     AndroidSurfaceTextureHandle aHandle, const gfx::IntSize& aSize,
     bool aContinuous, gl::OriginPos aOriginPos, bool aHasAlpha,
-    Maybe<gfx::Matrix4x4> aTransformOverride)
+    bool aForceBT709ColorSpace, Maybe<gfx::Matrix4x4> aTransformOverride)
     : GLImage(ImageFormat::SURFACE_TEXTURE),
       mHandle(aHandle),
       mSize(aSize),
       mContinuous(aContinuous),
       mOriginPos(aOriginPos),
       mHasAlpha(aHasAlpha),
+      mForceBT709ColorSpace(aForceBT709ColorSpace),
       mTransformOverride(aTransformOverride) {
   MOZ_ASSERT(mHandle);
 }
@@ -126,7 +127,7 @@
   SurfaceDescriptor sd = SurfaceTextureDescriptor(
       mHandle, mSize,
       mHasAlpha ? gfx::SurfaceFormat::R8G8B8A8 : gfx::SurfaceFormat::R8G8B8X8,
-      false /* NOT continuous */, mTransformOverride);
+      mForceBT709ColorSpace, false /* NOT continuous */, mTransformOverride);
   return Some(sd);
 }
 #endif