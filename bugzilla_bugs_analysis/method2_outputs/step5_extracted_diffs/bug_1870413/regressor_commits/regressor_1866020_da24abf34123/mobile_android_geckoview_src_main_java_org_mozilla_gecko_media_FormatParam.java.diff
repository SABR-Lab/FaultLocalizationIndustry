# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: mobile/android/geckoview/src/main/java/org/mozilla/gecko/media/FormatParam.java
# Commit: da24abf34123
# Full Hash: da24abf341236e00fa47e9e55dc72c82ae8a8c84
# Author: Jamie Nicol <jnicol@mozilla.com>
# Date: 2023-12-14 17:20:20
# Regressor Bug: 1866020
# File Overlap Count: 1
# Description:
#   Bug 1866020 - Override buggy colorspace conversion on Pixel devices. r=gw,padenot,geckoview-reviewers,owlish
#   
#   Pixel 6, 7, and 8 devices running Android 14 are affected by a bug
#   where video frames with SMPTE 432 color primaries are rendered
#   incorrectly when sampled from an external texture in GLES. To work
# ==============================================================================

diff -r 3a34e7a424e0 -r da24abf34123 mobile/android/geckoview/src/main/java/org/mozilla/gecko/media/FormatParam.java
--- a/mobile/android/geckoview/src/main/java/org/mozilla/gecko/media/FormatParam.java	Thu Dec 14 10:08:52 2023 +0000
+++ b/mobile/android/geckoview/src/main/java/org/mozilla/gecko/media/FormatParam.java	Thu Dec 14 10:45:08 2023 +0000
@@ -5,6 +5,7 @@
 package org.mozilla.gecko.media;
 
 import android.media.MediaFormat;
+import android.os.Build;
 import android.os.Bundle;
 import android.os.Parcel;
 import android.os.Parcelable;
@@ -26,6 +27,8 @@
  *   <li>{@link MediaFormat#KEY_I_FRAME_INTERVAL}
  *   <li>{@link MediaFormat#KEY_STRIDE}
  *   <li>{@link MediaFormat#KEY_SLICE_HEIGHT}
+ *   <li>{@link MediaFormat#KEY_COLOR_RANGE
+ *   <li>{@link MediaFormat#KEY_COLOR_STANDARD}
  *   <li>"csd-0"
  *   <li>"csd-1"
  * </ul>
@@ -118,6 +121,15 @@
     if (bundle.containsKey(MediaFormat.KEY_SLICE_HEIGHT)) {
       mFormat.setInteger(MediaFormat.KEY_SLICE_HEIGHT, bundle.getInt(MediaFormat.KEY_SLICE_HEIGHT));
     }
+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
+      if (bundle.containsKey(MediaFormat.KEY_COLOR_RANGE)) {
+        mFormat.setInteger(MediaFormat.KEY_COLOR_RANGE, bundle.getInt(MediaFormat.KEY_COLOR_RANGE));
+      }
+      if (bundle.containsKey(MediaFormat.KEY_COLOR_STANDARD)) {
+        mFormat.setInteger(
+            MediaFormat.KEY_COLOR_STANDARD, bundle.getInt(MediaFormat.KEY_COLOR_STANDARD));
+      }
+    }
   }
 
   @Override
@@ -173,6 +185,15 @@
     if (mFormat.containsKey(MediaFormat.KEY_SLICE_HEIGHT)) {
       bundle.putInt(MediaFormat.KEY_SLICE_HEIGHT, mFormat.getInteger(MediaFormat.KEY_SLICE_HEIGHT));
     }
+    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
+      if (mFormat.containsKey(MediaFormat.KEY_COLOR_RANGE)) {
+        bundle.putInt(MediaFormat.KEY_COLOR_RANGE, mFormat.getInteger(MediaFormat.KEY_COLOR_RANGE));
+      }
+      if (mFormat.containsKey(MediaFormat.KEY_COLOR_STANDARD)) {
+        bundle.putInt(
+            MediaFormat.KEY_COLOR_STANDARD, mFormat.getInteger(MediaFormat.KEY_COLOR_STANDARD));
+      }
+    }
     return bundle;
   }
 }
