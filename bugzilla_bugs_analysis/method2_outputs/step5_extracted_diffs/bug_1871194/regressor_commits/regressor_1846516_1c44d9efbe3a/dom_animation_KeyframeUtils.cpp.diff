# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/animation/KeyframeUtils.cpp
# Commit: 1c44d9efbe3a
# Full Hash: 1c44d9efbe3afe31bbc49e6dfa3d3c29b428df77
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - More fixes on top of bug 1870009. r=zrhoffman
#   
#   This fixes some leaks, and fixes IsAnimatable/IsTransitionable to look
#   at PropertyId.
#   
# ==============================================================================

diff -r e26c8d5274eb -r 1c44d9efbe3a dom/animation/KeyframeUtils.cpp
--- a/dom/animation/KeyframeUtils.cpp	Mon Dec 18 09:24:09 2023 +0000
+++ b/dom/animation/KeyframeUtils.cpp	Mon Dec 18 09:24:10 2023 +0000
@@ -72,10 +72,8 @@
  * BaseKeyframe or BasePropertyIndexedKeyframe object.
  */
 struct AdditionalProperty {
-  AdditionalProperty() : mProperty(eCSSProperty_UNKNOWN), mJsidIndex() {}
-
   AnimatedPropertyID mProperty;
-  size_t mJsidIndex;  // Index into |ids| in GetPropertyValuesPairs.
+  size_t mJsidIndex = 0;  // Index into |ids| in GetPropertyValuesPairs.
 
   struct PropertyComparator {
     bool Equals(const AdditionalProperty& aLhs,
@@ -572,20 +570,16 @@
           propName, CSSEnabledState::ForAllContent);
     }
 
-    AnimatedPropertyID* property;
-    if (propertyID == eCSSPropertyExtra_variable) {
-      // TODO(zrhoffman, bug 1811897) Add test coverage for removing the `--`
-      // prefix here.
-      property = new AnimatedPropertyID(
-          NS_Atomize(Substring(propName, 2, propName.Length() - 2)));
-    } else {
-      property = new AnimatedPropertyID(propertyID);
-    }
+    // TODO(zrhoffman, bug 1811897) Add test coverage for removing the `--`
+    // prefix here.
+    AnimatedPropertyID property =
+        propertyID == eCSSPropertyExtra_variable
+            ? AnimatedPropertyID(
+                  NS_Atomize(Substring(propName, 2, propName.Length() - 2)))
+            : AnimatedPropertyID(propertyID);
 
-    if (KeyframeUtils::IsAnimatableProperty(*property)) {
-      AdditionalProperty* p = properties.AppendElement();
-      p->mProperty = *property;
-      p->mJsidIndex = i;
+    if (KeyframeUtils::IsAnimatableProperty(property)) {
+      properties.AppendElement(AdditionalProperty{std::move(property), i});
     }
   }
 