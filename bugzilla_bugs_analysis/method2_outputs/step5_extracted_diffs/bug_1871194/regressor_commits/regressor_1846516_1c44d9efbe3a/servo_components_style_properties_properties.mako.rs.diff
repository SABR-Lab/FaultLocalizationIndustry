# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: servo/components/style/properties/properties.mako.rs
# Commit: 1c44d9efbe3a
# Full Hash: 1c44d9efbe3afe31bbc49e6dfa3d3c29b428df77
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - More fixes on top of bug 1870009. r=zrhoffman
#   
#   This fixes some leaks, and fixes IsAnimatable/IsTransitionable to look
#   at PropertyId.
#   
# ==============================================================================

diff -r e26c8d5274eb -r 1c44d9efbe3a servo/components/style/properties/properties.mako.rs
--- a/servo/components/style/properties/properties.mako.rs	Mon Dec 18 09:24:09 2023 +0000
+++ b/servo/components/style/properties/properties.mako.rs	Mon Dec 18 09:24:10 2023 +0000
@@ -1039,12 +1039,6 @@
     }
 
     #[inline]
-    fn animatable() -> &'static Self {
-        ${static_longhand_id_set("ANIMATABLE", lambda p: p.animatable)}
-        &ANIMATABLE
-    }
-
-    #[inline]
     fn discrete_animatable() -> &'static Self {
         ${static_longhand_id_set("DISCRETE_ANIMATABLE", lambda p: p.animation_value_type == "discrete")}
         &DISCRETE_ANIMATABLE
@@ -1448,7 +1442,7 @@
     /// Returns whether this property is animatable.
     #[inline]
     pub fn is_animatable(self) -> bool {
-        LonghandIdSet::animatable().contains(self)
+        NonCustomPropertyId::from(self).is_animatable()
     }
 
     /// Returns whether this property is animatable in a discrete way.
@@ -1986,6 +1980,22 @@
         self.non_custom_non_alias_id()?.as_longhand()
     }
 
+    /// Returns true if this property is one of the animatable properties.
+    pub fn is_animatable(&self) -> bool {
+        match self {
+            Self::NonCustom(id) => id.is_animatable(),
+            Self::Custom(..) => true,
+        }
+    }
+
+    /// Returns true if this property is one of the transitionable properties.
+    pub fn is_transitionable(&self) -> bool {
+        match self {
+            Self::NonCustom(id) => id.is_transitionable(),
+            Self::Custom(..) => true,
+        }
+    }
+
     /// Returns a given property from the given name, _regardless of whether it
     /// is enabled or not_, or Err(()) for unknown properties.
     ///
@@ -2092,18 +2102,13 @@
 
     /// Returns a property id from Gecko's AnimatedPropertyID.
     #[cfg(feature = "gecko")]
-    #[allow(non_upper_case_globals)]
     #[inline]
-    pub fn from_gecko_animated_property_id(property: &structs::AnimatedPropertyID) -> Result<Self, ()> {
-        Ok(if property.mID == nsCSSPropertyID::eCSSPropertyExtra_variable {
-            if property.mCustomName.mRawPtr.is_null() {
-                return Err(());
-            }
-            PropertyId::Custom(unsafe {
-                Atom::from_raw(property.mCustomName.mRawPtr)
-            })
+    pub fn from_gecko_animated_property_id(property: &structs::AnimatedPropertyID) -> Option<Self> {
+        Some(if property.mID == nsCSSPropertyID::eCSSPropertyExtra_variable {
+            debug_assert!(!property.mCustomName.mRawPtr.is_null());
+            Self::Custom(unsafe { Atom::from_raw(property.mCustomName.mRawPtr) })
         } else {
-            NonCustomPropertyId::from_nscsspropertyid(property.mID)?.to_property_id()
+            Self::NonCustom(NonCustomPropertyId::from_nscsspropertyid(property.mID)?)
         })
     }
 
@@ -2425,10 +2430,7 @@
 
     /// Returns true if this property declaration is for one of the animatable properties.
     pub fn is_animatable(&self) -> bool {
-        match self.id() {
-            PropertyDeclarationId::Longhand(id) => id.is_animatable(),
-            PropertyDeclarationId::Custom(..) => false,
-        }
+        self.id().is_animatable()
     }
 
     /// Returns true if this property is a custom property, false