# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: servo/components/style/properties/property_declaration.rs
# Commit: 1c44d9efbe3a
# Full Hash: 1c44d9efbe3afe31bbc49e6dfa3d3c29b428df77
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - More fixes on top of bug 1870009. r=zrhoffman
#   
#   This fixes some leaks, and fixes IsAnimatable/IsTransitionable to look
#   at PropertyId.
#   
# ==============================================================================

diff -r e26c8d5274eb -r 1c44d9efbe3a servo/components/style/properties/property_declaration.rs
--- a/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:09 2023 +0000
+++ b/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:10 2023 +0000
@@ -4,7 +4,7 @@
 
 //! Structs used for property declarations.
 
-use super::{LonghandId, NonCustomPropertyId, PropertyFlags, PropertyId, ShorthandId};
+use super::{LonghandId, PropertyFlags, PropertyId, ShorthandId};
 use crate::custom_properties::Name;
 #[cfg(feature = "gecko")]
 use crate::gecko_bindings::structs::{nsCSSPropertyID, AnimatedPropertyID, RefPtr};
@@ -34,15 +34,6 @@
         self.as_borrowed().is_logical()
     }
 
-    /// Returns whether this property is animatable.
-    #[inline]
-    pub fn is_animatable(&self) -> bool {
-        match self {
-            Self::Longhand(id) => id.is_animatable(),
-            Self::Custom(_) => true,
-        }
-    }
-
     /// Returns the corresponding PropertyDeclarationId.
     #[inline]
     pub fn as_borrowed(&self) -> PropertyDeclarationId {
@@ -52,33 +43,15 @@
         }
     }
 
-    /// Returns whether this property is transitionable.
-    #[inline]
-    pub fn is_transitionable(&self) -> bool {
-        match self {
-            Self::Longhand(longhand) => NonCustomPropertyId::from(*longhand).is_transitionable(),
-            // TODO(bug 1846516): Implement this for custom properties.
-            Self::Custom(_) => false,
-        }
-    }
-
     /// Convert an `AnimatedPropertyID` into an `OwnedPropertyDeclarationId`.
     #[cfg(feature = "gecko")]
     #[inline]
-    pub fn from_gecko_animated_property_id(property: &AnimatedPropertyID) -> Result<Self, ()> {
+    pub fn from_gecko_animated_property_id(property: &AnimatedPropertyID) -> Option<Self> {
         if property.mID == nsCSSPropertyID::eCSSPropertyExtra_variable {
-            if property.mCustomName.mRawPtr.is_null() {
-                Err(())
-            } else {
-                Ok(Self::Custom(unsafe {
-                    Atom::from_raw(property.mCustomName.mRawPtr)
-                }))
-            }
-        } else if let Ok(longhand) = LonghandId::from_nscsspropertyid(property.mID) {
-            Ok(Self::Longhand(longhand))
-        } else {
-            Err(())
+            debug_assert!(!property.mCustomName.mRawPtr.is_null());
+            return Some(Self::Custom(unsafe { Atom::from_raw(property.mCustomName.mRawPtr) }));
         }
+        LonghandId::from_nscsspropertyid(property.mID).map(Self::Longhand)
     }
 }
 
@@ -188,10 +161,8 @@
     #[inline]
     pub fn to_physical(&self, wm: WritingMode) -> Self {
         match self {
-            PropertyDeclarationId::Longhand(id) => {
-                PropertyDeclarationId::Longhand(id.to_physical(wm))
-            },
-            PropertyDeclarationId::Custom(_) => self.clone(),
+            Self::Longhand(id) => Self::Longhand(id.to_physical(wm)),
+            Self::Custom(_) => self.clone(),
         }
     }
 
@@ -199,8 +170,8 @@
     #[inline]
     pub fn is_animatable(&self) -> bool {
         match self {
-            PropertyDeclarationId::Longhand(id) => id.is_animatable(),
-            PropertyDeclarationId::Custom(_) => true,
+            Self::Longhand(id) => id.is_animatable(),
+            Self::Custom(_) => true,
         }
     }
 