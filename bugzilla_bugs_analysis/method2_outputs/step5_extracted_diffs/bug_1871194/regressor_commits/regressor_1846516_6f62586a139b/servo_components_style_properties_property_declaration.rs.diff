# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: servo/components/style/properties/property_declaration.rs
# Commit: 6f62586a139b
# Full Hash: 6f62586a139b1fcc4817dddd924400958d89a6bb
# Author: Zach Hoffman <zach@zrhoffman.net>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 2
# Description:
#   Bug 1846516 - [css-properties-values-api] Animate custom properties in a discrete way. r=firefox-style-system-reviewers,emilio
#   
#   This patch also updates the bug ID for a FIXME leftover from bug 1840478
#   to bug 1869476, since the same FIXME is added in D190758.
#   
# ==============================================================================

diff -r 729abedf9bda -r 6f62586a139b servo/components/style/properties/property_declaration.rs
--- a/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:08 2023 +0000
+++ b/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:08 2023 +0000
@@ -4,10 +4,10 @@
 
 //! Structs used for property declarations.
 
-use super::{LonghandId, NonCustomPropertyId, PropertyId, ShorthandId};
+use super::{LonghandId, NonCustomPropertyId, PropertyFlags, PropertyId, ShorthandId};
 use crate::custom_properties::Name;
 #[cfg(feature = "gecko")]
-use crate::gecko_bindings::structs::{nsCSSPropertyID, AnimatedPropertyID};
+use crate::gecko_bindings::structs::{nsCSSPropertyID, AnimatedPropertyID, RefPtr};
 use crate::logical_geometry::WritingMode;
 use crate::values::serialize_atom_name;
 #[cfg(feature = "gecko")]
@@ -39,8 +39,7 @@
     pub fn is_animatable(&self) -> bool {
         match self {
             Self::Longhand(id) => id.is_animatable(),
-            // TODO(bug 1846516): This should return true.
-            Self::Custom(_) => false,
+            Self::Custom(_) => true,
         }
     }
 
@@ -110,6 +109,15 @@
 }
 
 impl<'a> PropertyDeclarationId<'a> {
+    /// Returns PropertyFlags for given property.
+    #[inline(always)]
+    pub fn flags(&self) -> PropertyFlags {
+        match self {
+            Self::Longhand(id) => id.flags(),
+            Self::Custom(_) => PropertyFlags::empty(),
+        }
+    }
+
     /// Convert to an OwnedPropertyDeclarationId.
     pub fn to_owned(&self) -> OwnedPropertyDeclarationId {
         match self {
@@ -192,8 +200,7 @@
     pub fn is_animatable(&self) -> bool {
         match self {
             PropertyDeclarationId::Longhand(id) => id.is_animatable(),
-            // TODO(bug 1846516): This should return true.
-            PropertyDeclarationId::Custom(_) => false,
+            PropertyDeclarationId::Custom(_) => true,
         }
     }
 
@@ -202,8 +209,8 @@
     pub fn is_discrete_animatable(&self) -> bool {
         match self {
             Self::Longhand(longhand) => longhand.is_discrete_animatable(),
-            // TODO(bug 1846516): Implement this for custom properties.
-            Self::Custom(_) => false,
+            // TODO(bug 1846516): Refine this?
+            Self::Custom(_) => true,
         }
     }
 
@@ -217,4 +224,24 @@
             PropertyDeclarationId::Custom(_) => nsCSSPropertyID::eCSSPropertyExtra_variable,
         }
     }
+
+    /// Convert a `PropertyDeclarationId` into an `AnimatedPropertyID`
+    #[cfg(feature = "gecko")]
+    #[inline]
+    pub fn to_gecko_animated_property_id(&self) -> AnimatedPropertyID {
+        match self {
+            Self::Longhand(id) => AnimatedPropertyID {
+                mID: id.to_nscsspropertyid(),
+                mCustomName: RefPtr::null(),
+            },
+            Self::Custom(name) => {
+                let mut property_id = AnimatedPropertyID {
+                    mID: nsCSSPropertyID::eCSSPropertyExtra_variable,
+                    mCustomName: RefPtr::null(),
+                };
+                property_id.mCustomName.mRawPtr = (*name).clone().into_addrefed();
+                property_id
+            },
+        }
+    }
 }