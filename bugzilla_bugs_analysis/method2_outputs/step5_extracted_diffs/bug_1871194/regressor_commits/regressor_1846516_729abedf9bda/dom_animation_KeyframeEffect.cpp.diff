# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/animation/KeyframeEffect.cpp
# Commit: 729abedf9bda
# Full Hash: 729abedf9bda03da3f75ad660fafc2fa92a67bf5
# Author: Zach Hoffman <zach@zrhoffman.net>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - [css-properties-values-api] Use AnimatedPropertyID to communicate between Gecko and Servo. r=emilio,layout-reviewers,firefox-style-system-reviewers
#   
#   Co-authored-by: Frederic Wang <fred.wang@free.fr>
#   Co-authored-by: Emilio Cobos √Ålvarez <emilio@crisal.io>
#   
# ==============================================================================

diff -r 63603267402e -r 729abedf9bda dom/animation/KeyframeEffect.cpp
--- a/dom/animation/KeyframeEffect.cpp	Mon Dec 18 09:24:08 2023 +0000
+++ b/dom/animation/KeyframeEffect.cpp	Mon Dec 18 09:24:08 2023 +0000
@@ -287,8 +287,9 @@
 
   // Check that the value we are about to substitute in is actually for the
   // same property.
-  if (Servo_AnimationValue_GetPropertyId(aStartValue.mServo) !=
-      mProperties[0].mProperty.mID) {
+  AnimatedPropertyID property(eCSSProperty_UNKNOWN);
+  Servo_AnimationValue_GetPropertyId(aStartValue.mServo, &property);
+  if (property != mProperties[0].mProperty) {
     return;
   }
 
@@ -587,7 +588,7 @@
   }
   RefPtr<StyleAnimationValue> baseValue =
       Servo_ComputedValues_ExtractAnimationValue(aBaseComputedStyle,
-                                                 aProperty.mProperty.mID)
+                                                 &aProperty.mProperty)
           .Consume();
   mBaseValues.InsertOrUpdate(aProperty.mProperty.mID, std::move(baseValue));
 }
@@ -604,10 +605,9 @@
                                       const ComputedTiming& aComputedTiming) {
   auto* opaqueTable =
       reinterpret_cast<RawServoAnimationValueTable*>(&mBaseValues);
-  Servo_AnimationCompose(&aAnimationValues, opaqueTable,
-                         aProperty.mProperty.mID, &aSegment,
-                         &aProperty.mSegments.LastElement(), &aComputedTiming,
-                         mEffectOptions.mIterationComposite);
+  Servo_AnimationCompose(&aAnimationValues, opaqueTable, &aProperty.mProperty,
+                         &aSegment, &aProperty.mSegments.LastElement(),
+                         &aComputedTiming, mEffectOptions.mIterationComposite);
 }
 
 void KeyframeEffect::ComposeStyle(StyleAnimationValueMap& aComposeResult,
@@ -1287,7 +1287,7 @@
     // This workaround will be solved by bug 1391537.
     if (isCSSAnimation) {
       for (const PropertyValuePair& propertyValue : keyframe.mPropertyValues) {
-        if (propertyValue.mProperty ==
+        if (propertyValue.mProperty.mID ==
             nsCSSPropertyID::eCSSPropertyExtra_variable) {
           customProperties = propertyValue.mServoDeclarationBlock;
           break;
@@ -1299,17 +1299,17 @@
     for (const PropertyValuePair& propertyValue : keyframe.mPropertyValues) {
       nsAutoCString stringValue;
       // Don't serialize the custom properties for this keyframe.
-      if (propertyValue.mProperty ==
+      if (propertyValue.mProperty.mID ==
           nsCSSPropertyID::eCSSPropertyExtra_variable) {
         continue;
       }
       if (propertyValue.mServoDeclarationBlock) {
         Servo_DeclarationBlock_SerializeOneValue(
-            propertyValue.mServoDeclarationBlock, propertyValue.mProperty,
+            propertyValue.mServoDeclarationBlock, &propertyValue.mProperty,
             &stringValue, computedStyle, customProperties, rawData);
       } else {
-        if (auto* value = mBaseValues.GetWeak(propertyValue.mProperty)) {
-          Servo_AnimationValue_Serialize(value, propertyValue.mProperty,
+        if (auto* value = mBaseValues.GetWeak(propertyValue.mProperty.mID)) {
+          Servo_AnimationValue_Serialize(value, &propertyValue.mProperty,
                                          rawData, &stringValue);
         }
       }
@@ -1322,7 +1322,15 @@
       // "offset" property in BaseKeyframe.)
       // https://drafts.csswg.org/web-animations/#property-name-conversion
       const char* name = nullptr;
-      switch (propertyValue.mProperty) {
+      nsAutoCString customName;
+      nsAutoCString identifier;
+      switch (propertyValue.mProperty.mID) {
+        case nsCSSPropertyID::eCSSPropertyExtra_variable:
+          customName.Append("--");
+          propertyValue.mProperty.mCustomName->ToUTF8String(identifier);
+          customName.Append(identifier);
+          name = customName.get();
+          break;
         case nsCSSPropertyID::eCSSProperty_offset:
           name = "cssOffset";
           break;
@@ -1330,7 +1338,7 @@
           // FIXME: Bug 1582314: Should handle cssFloat manually if we remove it
           // from nsCSSProps::PropertyIDLName().
         default:
-          name = nsCSSProps::PropertyIDLName(propertyValue.mProperty);
+          name = nsCSSProps::PropertyIDLName(propertyValue.mProperty.mID);
       }
 
       JS::Rooted<JS::Value> value(aCx);