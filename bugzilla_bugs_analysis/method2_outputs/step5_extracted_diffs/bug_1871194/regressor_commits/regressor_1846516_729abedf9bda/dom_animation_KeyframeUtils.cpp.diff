# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/animation/KeyframeUtils.cpp
# Commit: 729abedf9bda
# Full Hash: 729abedf9bda03da3f75ad660fafc2fa92a67bf5
# Author: Zach Hoffman <zach@zrhoffman.net>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - [css-properties-values-api] Use AnimatedPropertyID to communicate between Gecko and Servo. r=emilio,layout-reviewers,firefox-style-system-reviewers
#   
#   Co-authored-by: Frederic Wang <fred.wang@free.fr>
#   Co-authored-by: Emilio Cobos √Ålvarez <emilio@crisal.io>
#   
# ==============================================================================

diff -r 63603267402e -r 729abedf9bda dom/animation/KeyframeUtils.cpp
--- a/dom/animation/KeyframeUtils.cpp	Mon Dec 18 09:24:08 2023 +0000
+++ b/dom/animation/KeyframeUtils.cpp	Mon Dec 18 09:24:08 2023 +0000
@@ -334,7 +334,7 @@
                  "Invalid computed offset");
       KeyframeValueEntry* entry = entries.AppendElement();
       entry->mOffset = frame.mComputedOffset;
-      entry->mProperty.mID = value.mProperty;
+      entry->mProperty = value.mProperty;
       entry->mValue = value.mValue;
       entry->mTimingFunction = frame.mTimingFunction;
       // The following assumes that CompositeOperation is a strict subset of
@@ -358,11 +358,7 @@
   if (aProperty.mID == eCSSProperty_display) {
     return false;
   }
-  // TODO(bug 1846516): handle custom property.
-  if (!aProperty.IsCustom()) {
-    return false;
-  }
-  return Servo_Property_IsAnimatable(aProperty.mID);
+  return Servo_Property_IsAnimatable(&aProperty);
 }
 
 // ------------------------------------------------------------------
@@ -698,11 +694,11 @@
   ServoCSSParser::ParsingEnvironment env =
       ServoCSSParser::GetParsingEnvironment(aDocument);
   RefPtr<StyleLockedDeclarationBlock> servoDeclarationBlock =
-      ServoCSSParser::ParseProperty(aProperty.mID, aStringValue, env,
+      ServoCSSParser::ParseProperty(aProperty, aStringValue, env,
                                     StyleParsingMode::DEFAULT);
 
   if (servoDeclarationBlock) {
-    result.emplace(aProperty.mID, std::move(servoDeclarationBlock));
+    result.emplace(aProperty, std::move(servoDeclarationBlock));
   } else {
     ReportInvalidPropertyValueToConsole(aProperty, aStringValue, aDocument);
   }
@@ -741,7 +737,7 @@
  *              a shorthand property.
  */
 static void MarkAsComputeValuesFailureKey(PropertyValuePair& aPair) {
-  MOZ_ASSERT(nsCSSProps::IsShorthand(aPair.mProperty),
+  MOZ_ASSERT(nsCSSProps::IsShorthand(aPair.mProperty.mID),
              "Only shorthand property values can be marked as failure values");
 
   aPair.mSimulateComputeValuesFailure = true;