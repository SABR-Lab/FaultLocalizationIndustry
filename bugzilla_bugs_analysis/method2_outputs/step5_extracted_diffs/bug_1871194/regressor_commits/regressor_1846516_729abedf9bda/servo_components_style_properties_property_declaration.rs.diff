# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: servo/components/style/properties/property_declaration.rs
# Commit: 729abedf9bda
# Full Hash: 729abedf9bda03da3f75ad660fafc2fa92a67bf5
# Author: Zach Hoffman <zach@zrhoffman.net>
# Date: 2023-12-18 17:17:57
# Regressor Bug: 1846516
# File Overlap Count: 1
# Description:
#   Bug 1846516 - [css-properties-values-api] Use AnimatedPropertyID to communicate between Gecko and Servo. r=emilio,layout-reviewers,firefox-style-system-reviewers
#   
#   Co-authored-by: Frederic Wang <fred.wang@free.fr>
#   Co-authored-by: Emilio Cobos √Ålvarez <emilio@crisal.io>
#   
# ==============================================================================

diff -r 63603267402e -r 729abedf9bda servo/components/style/properties/property_declaration.rs
--- a/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:08 2023 +0000
+++ b/servo/components/style/properties/property_declaration.rs	Mon Dec 18 09:24:08 2023 +0000
@@ -4,12 +4,14 @@
 
 //! Structs used for property declarations.
 
-use super::{LonghandId, PropertyId, ShorthandId};
+use super::{LonghandId, NonCustomPropertyId, PropertyId, ShorthandId};
 use crate::custom_properties::Name;
 #[cfg(feature = "gecko")]
-use crate::gecko_bindings::structs::nsCSSPropertyID;
+use crate::gecko_bindings::structs::{nsCSSPropertyID, AnimatedPropertyID};
 use crate::logical_geometry::WritingMode;
 use crate::values::serialize_atom_name;
+#[cfg(feature = "gecko")]
+use crate::Atom;
 use std::{
     borrow::Cow,
     fmt::{self, Write},
@@ -32,12 +34,51 @@
         self.as_borrowed().is_logical()
     }
 
+    /// Returns whether this property is animatable.
+    #[inline]
+    pub fn is_animatable(&self) -> bool {
+        match self {
+            Self::Longhand(id) => id.is_animatable(),
+            // TODO(bug 1846516): This should return true.
+            Self::Custom(_) => false,
+        }
+    }
+
     /// Returns the corresponding PropertyDeclarationId.
     #[inline]
     pub fn as_borrowed(&self) -> PropertyDeclarationId {
         match self {
-            OwnedPropertyDeclarationId::Longhand(id) => PropertyDeclarationId::Longhand(*id),
-            OwnedPropertyDeclarationId::Custom(name) => PropertyDeclarationId::Custom(name),
+            Self::Longhand(id) => PropertyDeclarationId::Longhand(*id),
+            Self::Custom(name) => PropertyDeclarationId::Custom(name),
+        }
+    }
+
+    /// Returns whether this property is transitionable.
+    #[inline]
+    pub fn is_transitionable(&self) -> bool {
+        match self {
+            Self::Longhand(longhand) => NonCustomPropertyId::from(*longhand).is_transitionable(),
+            // TODO(bug 1846516): Implement this for custom properties.
+            Self::Custom(_) => false,
+        }
+    }
+
+    /// Convert an `AnimatedPropertyID` into an `OwnedPropertyDeclarationId`.
+    #[cfg(feature = "gecko")]
+    #[inline]
+    pub fn from_gecko_animated_property_id(property: &AnimatedPropertyID) -> Result<Self, ()> {
+        if property.mID == nsCSSPropertyID::eCSSPropertyExtra_variable {
+            if property.mCustomName.mRawPtr.is_null() {
+                Err(())
+            } else {
+                Ok(Self::Custom(unsafe {
+                    Atom::from_raw(property.mCustomName.mRawPtr)
+                }))
+            }
+        } else if let Ok(longhand) = LonghandId::from_nscsspropertyid(property.mID) {
+            Ok(Self::Longhand(longhand))
+        } else {
+            Err(())
         }
     }
 }
@@ -60,7 +101,7 @@
     {
         match *self {
             PropertyDeclarationId::Longhand(id) => dest.write_str(id.name()),
-            PropertyDeclarationId::Custom(ref name) => {
+            PropertyDeclarationId::Custom(name) => {
                 dest.write_str("--")?;
                 serialize_atom_name(name, dest)
             },
@@ -156,6 +197,16 @@
         }
     }
 
+    /// Returns whether this property is animatable in a discrete way.
+    #[inline]
+    pub fn is_discrete_animatable(&self) -> bool {
+        match self {
+            Self::Longhand(longhand) => longhand.is_discrete_animatable(),
+            // TODO(bug 1846516): Implement this for custom properties.
+            Self::Custom(_) => false,
+        }
+    }
+
     /// Converts from a to an adequate nsCSSPropertyID, returning
     /// eCSSPropertyExtra_variable for custom properties.
     #[cfg(feature = "gecko")]