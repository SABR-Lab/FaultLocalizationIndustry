# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/gc/GCRuntime.h
# Commit: 7da8f779dc24
# Full Hash: 7da8f779dc24489bd423f647c1d60530e9deb24e
# Author: Jon Coppeard <jcoppeard@mozilla.com>
# Date: 2020-12-17 21:49:27
# Regressor Bug: 1681533
# File Overlap Count: 2
# Description:
#   Bug 1681533 - Only collect the nursery when necessary in major GC r=sfink
#   
#   This rearranges a few things so that we can run a minor GC inside a major GC
#   slice, so we don't have to be conservative about collecting the nursery at the
#   start of a slice.
# ==============================================================================

diff -r bc20cf2a3ad8 -r 7da8f779dc24 js/src/gc/GCRuntime.h
--- a/js/src/gc/GCRuntime.h	Thu Dec 17 17:39:25 2020 +0000
+++ b/js/src/gc/GCRuntime.h	Thu Dec 17 17:57:33 2020 +0000
@@ -464,12 +464,10 @@
   }
 
   uint64_t gcNumber() const { return number; }
+  void incGcNumber() { ++number; }
 
   uint64_t minorGCCount() const { return minorGCNumber; }
-  void incMinorGcNumber() {
-    ++minorGCNumber;
-    ++number;
-  }
+  void incMinorGcNumber() { ++minorGCNumber; }
 
   uint64_t majorGCCount() const { return majorGCNumber; }
   void incMajorGcNumber() { ++majorGCNumber; }
@@ -689,12 +687,14 @@
                                          const MaybeInvocationKind& gckind,
                                          JS::GCReason reason);
   bool shouldRepeatForDeadZone(JS::GCReason reason);
+
   void incrementalSlice(SliceBudget& budget, const MaybeInvocationKind& gckind,
-                        JS::GCReason reason, AutoGCSession& session);
-  MOZ_MUST_USE bool shouldCollectNurseryForSlice(bool nonincrementalByAPI,
-                                                 SliceBudget& budget);
+                        JS::GCReason reason);
+
+  void waitForBackgroundTasksBeforeSlice();
   bool mightSweepInThisSlice(bool nonIncremental);
-  bool mightCompactInThisSlice(bool nonIncremental);
+  void collectNurseryFromMajorGC(const MaybeInvocationKind& gckind,
+                                 JS::GCReason reason);
   void collectNursery(JSGCInvocationKind kind, JS::GCReason reason,
                       gcstats::PhaseKind phase);
 