# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsFrameTraversal.h
# Commit: 8b92fb4e3f41
# Full Hash: 8b92fb4e3f41d856629818bd2ecfc25bed23a643
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2023-12-23 09:52:03
# Regressor Bug: 779684
# File Overlap Count: 1
# Description:
#   Bug 779684 - part 3: Make `nsFrameIterator` non-refcountable r=emilio
#   
#   Nobody shares an instance of `nsFrameIterator`.  Therefore, we can make it
#   non-refcountable.  Additionally, `nsVisualIterator` is not required because
#   it overrides only 4 methods which are really simple.  So, once we merge it
# ==============================================================================

diff -r f357b2287591 -r 8b92fb4e3f41 layout/base/nsFrameTraversal.h
--- a/layout/base/nsFrameTraversal.h	Sat Dec 23 05:39:38 2023 +0000
+++ b/layout/base/nsFrameTraversal.h	Sat Dec 23 05:39:39 2023 +0000
@@ -7,15 +7,13 @@
 #ifndef NSFRAMETRAVERSAL_H
 #define NSFRAMETRAVERSAL_H
 
+#include <cstdint>
 #include "mozilla/Attributes.h"
-#include "nsISupportsImpl.h"
 
 class nsIFrame;
 class nsPresContext;
 
-class nsFrameIterator {
-  NS_INLINE_DECL_REFCOUNTING(nsFrameIterator)
-
+class MOZ_STACK_CLASS nsFrameIterator final {
  public:
   void First();
   void Next();
@@ -42,17 +40,12 @@
     // "close tag" order
     PostOrder,
   };
-  static already_AddRefed<nsFrameIterator> Create(
-      nsPresContext* aPresContext, nsIFrame* aStart, Type aType, bool aVisual,
-      bool aLockInScrollView, bool aFollowOOFs, bool aSkipPopupChecks,
-      nsIFrame* aLimiter = nullptr);
+  nsFrameIterator(nsPresContext* aPresContext, nsIFrame* aStart, Type aType,
+                  bool aVisual, bool aLockInScrollView, bool aFollowOOFs,
+                  bool aSkipPopupChecks, nsIFrame* aLimiter = nullptr);
+  ~nsFrameIterator() = default;
 
  protected:
-  nsFrameIterator(nsPresContext* aPresContext, nsIFrame* aStart, Type aType,
-                  bool aLockInScrollView, bool aFollowOOFs,
-                  bool aSkipPopupChecks, nsIFrame* aLimiter);
-  virtual ~nsFrameIterator() = default;
-
   void SetCurrent(nsIFrame* aFrame) { mCurrent = aFrame; }
   nsIFrame* GetCurrent() { return mCurrent; }
   nsIFrame* GetStart() { return mStart; }
@@ -96,11 +89,11 @@
    visual order".
   */
 
-  virtual nsIFrame* GetFirstChildInner(nsIFrame* aFrame);
-  virtual nsIFrame* GetLastChildInner(nsIFrame* aFrame);
+  nsIFrame* GetFirstChildInner(nsIFrame* aFrame);
+  nsIFrame* GetLastChildInner(nsIFrame* aFrame);
 
-  virtual nsIFrame* GetNextSiblingInner(nsIFrame* aFrame);
-  virtual nsIFrame* GetPrevSiblingInner(nsIFrame* aFrame);
+  nsIFrame* GetNextSiblingInner(nsIFrame* aFrame);
+  nsIFrame* GetPrevSiblingInner(nsIFrame* aFrame);
 
   /**
    * Return the placeholder frame for aFrame if it has one, otherwise return
@@ -115,6 +108,7 @@
   const bool mLockScroll;
   const bool mFollowOOFs;
   const bool mSkipPopupChecks;
+  const bool mVisual;
   const Type mType;
 
  private: