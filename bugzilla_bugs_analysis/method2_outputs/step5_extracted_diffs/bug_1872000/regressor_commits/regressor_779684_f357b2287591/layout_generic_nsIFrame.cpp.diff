# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/generic/nsIFrame.cpp
# Commit: f357b2287591
# Full Hash: f357b2287591dd069c8ecdf5091c6a74ca173506
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2023-12-23 09:52:03
# Regressor Bug: 779684
# File Overlap Count: 1
# Description:
#   Bug 779684 - part 2: Get rid of `nsFrameTraversal` and `nsIFrameTraversal` r=emilio
#   
#   The class is used only for creating `nsFrameIterator`, but it's unnecessary
#   so that we can get rid of it and its interface.
#   
# ==============================================================================

diff -r 738fe6bbf913 -r f357b2287591 layout/generic/nsIFrame.cpp
--- a/layout/generic/nsIFrame.cpp	Sat Dec 23 05:39:38 2023 +0000
+++ b/layout/generic/nsIFrame.cpp	Sat Dec 23 05:39:38 2023 +0000
@@ -8600,7 +8600,6 @@
   bool isBeforeFirstFrame, isAfterLastFrame;
   bool found = false;
 
-  nsresult result = NS_OK;
   while (!found) {
     if (aPos->mDirection == eDirPrevious)
       searchingLine--;
@@ -8639,9 +8638,9 @@
     nsPoint newDesiredPos =
         aPos->mDesiredCaretPos -
         offset;  // get desired position into blockframe coords
-    result = it->FindFrameAt(searchingLine, newDesiredPos, &resultFrame,
-                             &isBeforeFirstFrame, &isAfterLastFrame);
-    if (NS_FAILED(result)) {
+    nsresult rv = it->FindFrameAt(searchingLine, newDesiredPos, &resultFrame,
+                                  &isBeforeFirstFrame, &isAfterLastFrame);
+    if (NS_FAILED(rv)) {
       continue;
     }
 
@@ -8653,19 +8652,14 @@
         return NS_OK;
       }
       // resultFrame is not a block frame
-      result = NS_ERROR_FAILURE;
-
-      RefPtr<nsFrameIterator> frameIterator;
-      result = NS_NewFrameTraversal(
-          getter_AddRefs(frameIterator), pc, resultFrame, ePostOrder,
+      RefPtr<nsFrameIterator> frameIterator = nsFrameIterator::Create(
+          pc, resultFrame, nsFrameIterator::Type::PostOrder,
           false,  // aVisual
           aPos->mOptions.contains(PeekOffsetOption::StopAtScroller),
           false,  // aFollowOOFs
           false   // aSkipPopupChecks
       );
-      if (NS_FAILED(result)) {
-        return result;
-      }
+      MOZ_ASSERT(frameIterator);
 
       auto FoundValidFrame = [aPos](const nsIFrame::ContentOffsets& aOffsets,
                                     const nsIFrame* aFrame) {
@@ -8731,14 +8725,14 @@
 
       if (!found) {
         resultFrame = storeOldResultFrame;
-
-        result = NS_NewFrameTraversal(
-            getter_AddRefs(frameIterator), pc, resultFrame, eLeaf,
+        frameIterator = nsFrameIterator::Create(
+            pc, resultFrame, nsFrameIterator::Type::Leaf,
             false,  // aVisual
             aPos->mOptions.contains(PeekOffsetOption::StopAtScroller),
             false,  // aFollowOOFs
             false   // aSkipPopupChecks
         );
+        MOZ_ASSERT(frameIterator);
       }
       while (!found) {
         nsPoint point = aPos->mDesiredCaretPos;
@@ -9623,13 +9617,12 @@
       aOptions.contains(PeekOffsetOption::Visual) && presContext->BidiEnabled();
   const bool followOofs =
       !aOptions.contains(PeekOffsetOption::StopAtPlaceholder);
-  RefPtr<nsFrameIterator> frameIterator;
-  MOZ_TRY(NS_NewFrameTraversal(
-      getter_AddRefs(frameIterator), presContext, this, eLeaf,
-      needsVisualTraversal, aOptions.contains(PeekOffsetOption::StopAtScroller),
-      followOofs,
+  RefPtr<nsFrameIterator> frameIterator = nsFrameIterator::Create(
+      presContext, this, nsFrameIterator::Type::Leaf, needsVisualTraversal,
+      aOptions.contains(PeekOffsetOption::StopAtScroller), followOofs,
       false  // aSkipPopupChecks
-      ));
+  );
+  MOZ_ASSERT(frameIterator);
 
   // Find the prev/next selectable frame
   bool selectable = false;
