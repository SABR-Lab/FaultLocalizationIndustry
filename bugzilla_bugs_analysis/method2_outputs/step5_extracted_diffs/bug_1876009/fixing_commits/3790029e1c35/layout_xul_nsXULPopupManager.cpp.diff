# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/xul/nsXULPopupManager.cpp
# Commit: 3790029e1c35
# Full Hash: 3790029e1c3524fa09691380b24897bdb9f4a322
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-01-29 21:40:18
# Description:
#   Bug 1876009 - Null-check root pres context in nsXULPopupManager code. r=Gijs
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D199867
# ==============================================================================

diff -r e2e05e73ed0e -r 3790029e1c35 layout/xul/nsXULPopupManager.cpp
--- a/layout/xul/nsXULPopupManager.cpp	Mon Jan 29 12:20:00 2024 +0000
+++ b/layout/xul/nsXULPopupManager.cpp	Mon Jan 29 12:26:22 2024 +0000
@@ -213,10 +213,11 @@
   PopupType popupType = aItem->Frame()->GetPopupType();
   if (StaticPrefs::layout_cursor_disable_for_popups() &&
       popupType != PopupType::Tooltip) {
-    nsPresContext* rootPresContext =
-        aItem->Frame()->PresContext()->GetRootPresContext();
-    if (nsCOMPtr<nsIWidget> rootWidget = rootPresContext->GetRootWidget()) {
-      rootWidget->SetCustomCursorAllowed(false);
+    if (nsPresContext* rootPC =
+            aItem->Frame()->PresContext()->GetRootPresContext()) {
+      if (nsCOMPtr<nsIWidget> rootWidget = rootPC->GetRootWidget()) {
+        rootWidget->SetCustomCursorAllowed(false);
+      }
     }
   }
 
@@ -234,17 +235,15 @@
 }
 
 void nsXULPopupManager::RemoveMenuChainItem(nsMenuChainItem* aItem) {
-  nsPresContext* presContext =
-      aItem->Frame()->PresContext()->GetRootPresContext();
+  nsPresContext* rootPC = aItem->Frame()->PresContext()->GetRootPresContext();
   auto matcher = [&](nsMenuChainItem* aChainItem) -> bool {
     return aChainItem != aItem &&
-           presContext ==
-               aChainItem->Frame()->PresContext()->GetRootPresContext();
+           rootPC == aChainItem->Frame()->PresContext()->GetRootPresContext();
   };
-  nsCOMPtr<nsIWidget> rootWidget =
-      presContext->GetRootPresContext()->GetRootWidget();
-  if (!FirstMatchingPopup(matcher) && rootWidget) {
-    rootWidget->SetCustomCursorAllowed(true);
+  if (rootPC && !FirstMatchingPopup(matcher)) {
+    if (nsCOMPtr<nsIWidget> rootWidget = rootPC->GetRootWidget()) {
+      rootWidget->SetCustomCursorAllowed(true);
+    }
   }
 
   auto parent = aItem->Detach();
