# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/media/webcodecs/WebCodecsUtils.cpp
# Commit: 45b561797261
# Full Hash: 45b561797261b18d83e66b09c3bf9be9820e4d09
# Author: Paul Adenot <paul@paul.cx>
# Date: 2024-03-11 21:13:39
# Description:
#   Bug 1878300 - Only accept vp8 for vp8 codec string. r=chunmin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D200678
# ==============================================================================

diff -r 6901b5e67c87 -r 45b561797261 dom/media/webcodecs/WebCodecsUtils.cpp
--- a/dom/media/webcodecs/WebCodecsUtils.cpp	Mon Mar 11 14:01:17 2024 +0000
+++ b/dom/media/webcodecs/WebCodecsUtils.cpp	Mon Mar 11 14:16:41 2024 +0000
@@ -584,4 +584,23 @@
   return data->Length() > 0 ? data : nullptr;
 }
 
+bool IsSupportedVideoCodec(const nsAString& aCodec) {
+  LOG("IsSupportedVideoCodec: %s", NS_ConvertUTF16toUTF8(aCodec).get());
+  // The only codec string accepted for vp8 is "vp8"
+  if (!IsVP9CodecString(aCodec) && !IsH264CodecString(aCodec) &&
+      !IsAV1CodecString(aCodec) && !aCodec.EqualsLiteral("vp8")) {
+    return false;
+  }
+
+  // Gecko allows codec string starts with vp9 or av1 but Webcodecs requires to
+  // starts with av01 and vp09.
+  // https://w3c.github.io/webcodecs/codec_registry.html.
+  if (StringBeginsWith(aCodec, u"vp9"_ns) ||
+      StringBeginsWith(aCodec, u"av1"_ns)) {
+    return false;
+  }
+
+  return true;
+}
+
 }  // namespace mozilla::dom