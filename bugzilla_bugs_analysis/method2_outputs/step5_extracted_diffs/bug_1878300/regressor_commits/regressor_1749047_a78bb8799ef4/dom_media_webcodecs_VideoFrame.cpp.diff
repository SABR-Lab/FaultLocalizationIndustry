# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/media/webcodecs/VideoFrame.cpp
# Commit: a78bb8799ef4
# Full Hash: a78bb8799ef4a23a90f0457dc29bbe32ce1dc799
# Author: Paul Adenot <paul@paul.cx>
# Date: 2023-12-23 09:52:03
# Regressor Bug: 1749047
# File Overlap Count: 3
# Description:
#   Bug 1749047 - Set the color spaces in more cases on VideoFrame. r=chunmin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D195722
# ==============================================================================

diff -r 0595d51073c6 -r a78bb8799ef4 dom/media/webcodecs/VideoFrame.cpp
--- a/dom/media/webcodecs/VideoFrame.cpp	Fri Dec 22 21:39:12 2023 +0000
+++ b/dom/media/webcodecs/VideoFrame.cpp	Fri Dec 22 21:39:12 2023 +0000
@@ -36,6 +36,7 @@
 #include "mozilla/dom/UnionTypes.h"
 #include "mozilla/gfx/2D.h"
 #include "mozilla/gfx/Swizzle.h"
+#include "mozilla/layers/LayersSurfaces.h"
 #include "nsLayoutUtils.h"
 #include "nsIPrincipal.h"
 #include "nsIURI.h"
@@ -1022,8 +1023,12 @@
 
   Maybe<uint64_t> duration = OptionalToMaybe(aInit.mDuration);
 
-  // TODO: WPT will fail if we guess a VideoColorSpace here.
-  const VideoColorSpaceInit colorSpace{};
+  VideoColorSpaceInit colorSpace{};
+  if (IsYUVFormat(SurfaceFormatToVideoPixelFormat(surface->GetFormat()).ref())) {
+    colorSpace = FallbackColorSpaceForVideoContent();
+  } else {
+    colorSpace = FallbackColorSpaceForWebContent();
+  }
   return MakeAndAddRef<VideoFrame>(
       aGlobal, image, format ? Some(format->PixelFormat()) : Nothing(),
       image->GetSize(), visibleRect.value(), displaySize.value(), duration,