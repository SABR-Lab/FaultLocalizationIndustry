# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/webgpu/Queue.cpp
# Commit: 52377aae89ab
# Full Hash: 52377aae89ab697c60f663c36168e40f8e9445a4
# Author: Erich Gubler <erichdongubler@gmail.com>
# Date: 2024-03-11 21:13:39
# Description:
#   Bug 1883791: fix(webgpu): default to elem. size 1 instead of crashing on untyped array buf. views in `GPUQueue.writeBuffer` r=webgpu-reviewers,nical
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D203831
# ==============================================================================

diff -r b32811ea1c61 -r 52377aae89ab dom/webgpu/Queue.cpp
--- a/dom/webgpu/Queue.cpp	Mon Mar 11 13:41:28 2024 +0000
+++ b/dom/webgpu/Queue.cpp	Mon Mar 11 13:48:44 2024 +0000
@@ -69,9 +69,13 @@
     return;
   }
 
-  size_t elementByteSize = aData.IsArrayBufferView()
-                               ? byteSize(aData.GetAsArrayBufferView().Type())
-                               : 1;
+  size_t elementByteSize = 1;
+  if (aData.IsArrayBufferView()) {
+    auto type = aData.GetAsArrayBufferView().Type();
+    if (type != JS::Scalar::MaxTypedArrayViewType) {
+      elementByteSize = byteSize(type);
+    }
+  }
   dom::ProcessTypedArraysFixed(aData, [&, elementByteSize](
                                           const Span<const uint8_t>& aData) {
     uint64_t byteLength = aData.Length();
