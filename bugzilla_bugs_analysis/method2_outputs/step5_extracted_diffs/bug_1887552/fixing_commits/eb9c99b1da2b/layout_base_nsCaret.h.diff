# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/base/nsCaret.h
# Commit: eb9c99b1da2b
# Full Hash: eb9c99b1da2b59ad1888a9710a3d56652bdd850c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-03-26 16:49:15
# Description:
#   Bug 1887552 - Simplify caret visibility code. r=sefeng,geckoview-reviewers
#   
#   Make the "is hidden due to non-collapsed selection" use the regular
#   caret-hiding mechanism, so that we make sure nsCaret and paint are
#   consistent on their caret visibility.
# ==============================================================================

diff -r 66c42f5f482f -r eb9c99b1da2b layout/base/nsCaret.h
--- a/layout/base/nsCaret.h	Tue Mar 26 13:41:00 2024 +0200
+++ b/layout/base/nsCaret.h	Tue Mar 26 10:53:17 2024 +0000
@@ -61,18 +61,17 @@
    *                          those with user-modify: read-only
    */
   void SetIgnoreUserModify(bool aIgnoreUserModify);
-  /** SetVisible will set the visibility of the caret
-   *  @param inMakeVisible true to show the caret, false to hide it
+  /**
+   * SetVisible will set the visibility of the caret
+   *  @param aVisible true to show the caret, false to hide it
    */
   void SetVisible(bool aVisible);
-  /** IsVisible will get the visibility of the caret.
-   *  This returns false if the caret is hidden because it was set
-   *  to not be visible, or because the selection is not collapsed, or
-   *  because an open popup is hiding the caret.
-   *  It does not take account of blinking or the caret being hidden
-   *  because we're in non-editable/disabled content.
+  /**
+   * IsVisible will get the visibility of the caret.
+   * It does not take account of blinking or the caret being hidden because
+   * we're in non-editable/disabled content.
    */
-  bool IsVisible();
+  bool IsVisible() const;
 
   /**
    * AddForceHide() increases mHideCount and hide the caret even if
@@ -190,6 +189,7 @@
   static void CaretBlinkCallback(nsITimer* aTimer, void* aClosure);
 
   void CheckSelectionLanguageChange();
+  void CaretVisibilityMaybeChanged();
 
   void ResetBlinking();
   void StopBlinking();
@@ -203,16 +203,6 @@
   void ComputeCaretRects(nsIFrame* aFrame, int32_t aFrameOffset,
                          nsRect* aCaretRect, nsRect* aHookRect);
 
-  // Returns true if we should not draw the caret because of XUL menu popups.
-  // The caret should be hidden if:
-  // 1. An open popup contains the caret, but a menu popup exists before the
-  //    caret-owning popup in the popup list (i.e. a menu is in front of the
-  //    popup with the caret). If the menu itself contains the caret we don't
-  //    hide it.
-  // 2. A menu popup is open, but there is no caret present in any popup.
-  // 3. The caret selection is empty.
-  bool IsMenuPopupHidingCaret();
-
   // If we're tracking the selection, this updates the caret position and
   // invalidates paint as needed.
   void UpdateCaretPositionFromSelectionIfNeeded();
@@ -274,6 +264,12 @@
    * will not track the selection.
    */
   bool mFixedCaretPosition = false;
+
+  /**
+   * If we're currently hiding the caret due to the selection not being
+   * collapsed. Can only be true if mShowDuringSelection is false.
+   */
+  bool mHiddenDuringSelection = false;
 };
 
 #endif  // nsCaret_h__