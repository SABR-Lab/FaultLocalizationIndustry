# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/Selection.cpp
# Commit: d3946837037d
# Full Hash: d3946837037d31a7b6f83b1977e57c4ea384c904
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-03-19 09:35:23
# Regressor Bug: 1860328
# File Overlap Count: 2
# Description:
#   Bug 1860328 - Track nsCaret position at the DOM level. r=sefeng,masayuki
#   
#   This should avoid a bunch of paint invalidation issues with our caret
#   code (and seems simpler anyways).
#   
# ==============================================================================

diff -r d5855a08e601 -r d3946837037d dom/base/Selection.cpp
--- a/dom/base/Selection.cpp	Mon Mar 18 09:12:57 2024 +0000
+++ b/dom/base/Selection.cpp	Mon Mar 18 09:12:57 2024 +0000
@@ -2501,11 +2501,15 @@
   // Hack to display the caret on the right line (bug 1237236).
   if (frameSelection->GetHint() == CaretAssociationHint::Before &&
       aPoint.Container()->IsContent()) {
-    int32_t frameOffset;
-    nsTextFrame* f = do_QueryFrame(nsCaret::GetFrameAndOffset(
-        this, aPoint.Container(),
-        *aPoint.Offset(RawRangeBoundary::OffsetFilter::kValidOffsets),
-        &frameOffset));
+    const nsCaret::CaretPosition pos{
+        aPoint.Container(),
+        int32_t(*aPoint.Offset(RawRangeBoundary::OffsetFilter::kValidOffsets)),
+        frameSelection->GetHint(), frameSelection->GetCaretBidiLevel()};
+    CaretFrameData frameData = nsCaret::GetFrameAndOffset(pos);
+    if (frameData.mFrame) {
+      frameSelection->SetHint(frameData.mHint);
+    }
+    nsTextFrame* f = do_QueryFrame(frameData.mFrame);
     if (f && f->IsAtEndOfLine() && f->HasSignificantTerminalNewline()) {
       // RawRangeBounary::Offset() causes computing offset if it's not been
       // done yet.  However, it's called only when the container is a text