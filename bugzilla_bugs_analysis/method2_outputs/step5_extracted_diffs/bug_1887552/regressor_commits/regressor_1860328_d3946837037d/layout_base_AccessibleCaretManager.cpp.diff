# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/AccessibleCaretManager.cpp
# Commit: d3946837037d
# Full Hash: d3946837037d31a7b6f83b1977e57c4ea384c904
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-03-19 09:35:23
# Regressor Bug: 1860328
# File Overlap Count: 2
# Description:
#   Bug 1860328 - Track nsCaret position at the DOM level. r=sefeng,masayuki
#   
#   This should avoid a bunch of paint invalidation issues with our caret
#   code (and seems simpler anyways).
#   
# ==============================================================================

diff -r d5855a08e601 -r d3946837037d layout/base/AccessibleCaretManager.cpp
--- a/layout/base/AccessibleCaretManager.cpp	Mon Mar 18 09:12:57 2024 +0000
+++ b/layout/base/AccessibleCaretManager.cpp	Mon Mar 18 09:12:57 2024 +0000
@@ -222,27 +222,17 @@
   if (!caret || !caret->IsVisible()) {
     return false;
   }
-
-  int32_t offset = 0;
-  nsIFrame* frame =
-      nsCaret::GetFrameAndOffset(GetSelection(), nullptr, 0, &offset);
-
-  if (!frame) {
+  auto frameData =
+      nsCaret::GetFrameAndOffset(nsCaret::CaretPositionFor(GetSelection()));
+  if (!GetEditingHostForFrame(frameData.mFrame)) {
     return false;
   }
-
-  if (!GetEditingHostForFrame(frame)) {
-    return false;
+  if (aOutFrame) {
+    *aOutFrame = frameData.mFrame;
   }
-
-  if (aOutFrame) {
-    *aOutFrame = frame;
+  if (aOutOffset) {
+    *aOutOffset = frameData.mOffsetInFrameContent;
   }
-
-  if (aOutOffset) {
-    *aOutOffset = offset;
-  }
-
   return true;
 }
 
@@ -1333,10 +1323,9 @@
     const nsPoint& aPoint) const {
   nsPoint adjustedPoint = aPoint;
 
-  int32_t focusOffset = 0;
-  nsIFrame* focusFrame =
-      nsCaret::GetFrameAndOffset(GetSelection(), nullptr, 0, &focusOffset);
-  Element* editingHost = GetEditingHostForFrame(focusFrame);
+  auto frameData =
+      nsCaret::GetFrameAndOffset(nsCaret::CaretPositionFor(GetSelection()));
+  Element* editingHost = GetEditingHostForFrame(frameData.mFrame);
 
   if (editingHost) {
     nsIFrame* editingHostFrame = editingHost->GetPrimaryFrame();
@@ -1471,8 +1460,7 @@
 
   // Send isEditable info w/ event detail. This info can help determine
   // whether to show cut command on selection dialog or not.
-  init.mSelectionEditable =
-      commonAncestorFrame && GetEditingHostForFrame(commonAncestorFrame);
+  init.mSelectionEditable = GetEditingHostForFrame(commonAncestorFrame);
 
   init.mBoundingClientRect = domRect;
   init.mReason = aReason;