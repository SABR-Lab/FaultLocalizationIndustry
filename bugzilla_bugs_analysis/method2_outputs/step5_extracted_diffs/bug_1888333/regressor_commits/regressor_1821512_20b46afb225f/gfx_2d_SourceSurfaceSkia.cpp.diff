# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/2d/SourceSurfaceSkia.cpp
# Commit: 20b46afb225f
# Full Hash: 20b46afb225f7b0076e3fc0c000ce609ac79e0ba
# Author: Lee Salzman <lsalzman@mozilla.com>
# Date: 2023-04-11 09:27:51
# Regressor Bug: 1821512
# File Overlap Count: 1
# Description:
#   Bug 1821512 - Fix Skia usage for API changes. r=jrmuizel
#   
#   This just tries to address fairly random changes in the Skia API and correct
#   our usage of it in Moz2D and some other places.
#   
# ==============================================================================

diff -r b531f604ea4c -r 20b46afb225f gfx/2d/SourceSurfaceSkia.cpp
--- a/gfx/2d/SourceSurfaceSkia.cpp	Tue Apr 11 05:00:04 2023 +0000
+++ b/gfx/2d/SourceSurfaceSkia.cpp	Tue Apr 11 05:00:05 2023 +0000
@@ -11,6 +11,7 @@
 #include "skia/include/core/SkData.h"
 #include "skia/include/core/SkImage.h"
 #include "skia/include/core/SkSurface.h"
+#include "skia/include/private/base/SkMalloc.h"
 #include "mozilla/CheckedInt.h"
 
 namespace mozilla::gfx {
@@ -134,7 +135,10 @@
   } else if (aFormat != SurfaceFormat::UNKNOWN) {
     mFormat = aFormat;
     SkImageInfo info = MakeSkiaImageInfo(mSize, mFormat);
-    mStride = SkAlign4(info.minRowBytes());
+    mStride = GetAlignedStride<4>(info.width(), info.bytesPerPixel());
+    if (!mStride) {
+      return false;
+    }
   } else {
     return false;
   }
@@ -154,7 +158,10 @@
     return nullptr;
   }
   SkImageInfo info = MakeSkiaImageInfo(aRect.Size(), mFormat);
-  size_t stride = SkAlign4(info.minRowBytes());
+  size_t stride = GetAlignedStride<4>(info.width(), info.bytesPerPixel());
+  if (!stride) {
+    return nullptr;
+  }
   sk_sp<SkImage> subImage = ReadSkImage(mImage, info, stride, aRect.x, aRect.y);
   if (!subImage) {
     return nullptr;
