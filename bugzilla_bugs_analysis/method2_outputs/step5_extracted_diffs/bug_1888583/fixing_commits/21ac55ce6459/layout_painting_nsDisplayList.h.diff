# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: layout/painting/nsDisplayList.h
# Commit: 21ac55ce6459
# Full Hash: 21ac55ce6459f3b6dbc524b186fa8b181063a6ae
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-04-03 09:34:09
# Description:
#   Bug 1888583 - Keep papering over caret invalidation issues. r=sefeng
#   
#   We used to do this before bug 1860328 (see also bug 1547802, which
#   introduced this wallpaper).
#   
# ==============================================================================

diff -r 52bb75377d06 -r 21ac55ce6459 layout/painting/nsDisplayList.h
--- a/layout/painting/nsDisplayList.h	Tue Apr 02 08:54:52 2024 +0000
+++ b/layout/painting/nsDisplayList.h	Tue Apr 02 09:37:42 2024 +0000
@@ -904,6 +904,11 @@
                        const dom::EffectsInfo& aUpdate);
 
   /**
+   * Invalidates the caret frames from previous paints, if they have changed.
+   */
+  void InvalidateCaretFramesIfNeeded();
+
+  /**
    * Allocate memory in our arena. It will only be freed when this display list
    * builder is destroyed. This memory holds nsDisplayItems and
    * DisplayItemClipChain objects.
@@ -1808,6 +1813,9 @@
   // Stores reusable items collected during display list preprocessing.
   nsTHashSet<nsDisplayItem*> mReuseableItems;
 
+  // Tracked carets used for retained display list.
+  AutoTArray<RefPtr<nsCaret>, 1> mPaintedCarets;
+
   // Tracked regions used for retained display list.
   WeakFrameRegion mRetainedWindowDraggingRegion;
   WeakFrameRegion mRetainedWindowNoDraggingRegion;