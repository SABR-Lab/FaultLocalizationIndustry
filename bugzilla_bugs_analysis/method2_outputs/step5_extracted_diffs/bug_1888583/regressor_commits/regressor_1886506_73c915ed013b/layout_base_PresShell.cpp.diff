# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/PresShell.cpp
# Commit: 73c915ed013b
# Full Hash: 73c915ed013b1b6a0435a839e95c38023984612b
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-03-23 09:29:17
# Regressor Bug: 1886506
# File Overlap Count: 1
# Description:
#   Bug 1886506 - Fix caret paint invalidation issues. r=sefeng
#   
#   The caret position is in the DOM, and sometimes can get out of sync.
#   
#   While that is an issue, it's not new: The code before the regressing bug
# ==============================================================================

diff -r dda9d04389e1 -r 73c915ed013b layout/base/PresShell.cpp
--- a/layout/base/PresShell.cpp	Fri Mar 22 12:19:50 2024 +0000
+++ b/layout/base/PresShell.cpp	Fri Mar 22 12:20:14 2024 +0000
@@ -2238,9 +2238,16 @@
   return eventHub.forget();
 }
 
-void PresShell::SetCaret(nsCaret* aNewCaret) { mCaret = aNewCaret; }
-
-void PresShell::RestoreCaret() { mCaret = mOriginalCaret; }
+void PresShell::SetCaret(nsCaret* aNewCaret) {
+  if (mCaret == aNewCaret) {
+    return;
+  }
+  mCaret->SchedulePaint();
+  mCaret = aNewCaret;
+  aNewCaret->SchedulePaint();
+}
+
+void PresShell::RestoreCaret() { SetCaret(mOriginalCaret); }
 
 NS_IMETHODIMP PresShell::SetCaretEnabled(bool aInEnable) {
   bool oldEnabled = mCaretEnabled;
@@ -5647,7 +5654,9 @@
 }
 
 void PresShell::SynthesizeMouseMove(bool aFromScroll) {
-  if (!StaticPrefs::layout_reflow_synthMouseMove()) return;
+  if (!StaticPrefs::layout_reflow_synthMouseMove()) {
+    return;
+  }
 
   if (mPaintingSuppressed || !mIsActive || !mPresContext) {
     return;
@@ -5660,8 +5669,9 @@
     return;
   }
 
-  if (mMouseLocation == nsPoint(NS_UNCONSTRAINEDSIZE, NS_UNCONSTRAINEDSIZE))
-    return;
+  if (mMouseLocation == nsPoint(NS_UNCONSTRAINEDSIZE, NS_UNCONSTRAINEDSIZE)) {
+    return;
+  }
 
   if (!mSynthMouseMoveEvent.IsPending()) {
     RefPtr<nsSynthMouseMoveEvent> ev =