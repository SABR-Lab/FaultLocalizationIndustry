# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsCaret.cpp
# Commit: 73c915ed013b
# Full Hash: 73c915ed013b1b6a0435a839e95c38023984612b
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-03-23 09:29:17
# Regressor Bug: 1886506
# File Overlap Count: 1
# Description:
#   Bug 1886506 - Fix caret paint invalidation issues. r=sefeng
#   
#   The caret position is in the DOM, and sometimes can get out of sync.
#   
#   While that is an issue, it's not new: The code before the regressing bug
# ==============================================================================

diff -r dda9d04389e1 -r 73c915ed013b layout/base/nsCaret.cpp
--- a/layout/base/nsCaret.cpp	Fri Mar 22 12:19:50 2024 +0000
+++ b/layout/base/nsCaret.cpp	Fri Mar 22 12:20:14 2024 +0000
@@ -392,6 +392,10 @@
 }
 
 void nsCaret::SchedulePaint() {
+  if (mLastPaintedFrame) {
+    mLastPaintedFrame->SchedulePaint();
+    mLastPaintedFrame = nullptr;
+  }
   auto data = GetFrameAndOffset(mCaretPosition);
   if (!data.mFrame) {
     return;
@@ -416,9 +420,6 @@
   if (newPos == mCaretPosition) {
     return;
   }
-  // First SchedulePaint call invalidates the old position. Second one the new
-  // one.
-  SchedulePaint();
   mCaretPosition = newPos;
   SchedulePaint();
 }
@@ -427,7 +428,6 @@
   // Schedule a paint with the old position to invalidate.
   mFixedCaretPosition = !!aNode;
   if (mFixedCaretPosition) {
-    SchedulePaint();
     mCaretPosition = {aNode, aOffset};
     SchedulePaint();
   } else {