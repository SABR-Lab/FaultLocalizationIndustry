# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit-test/tests/wasm/tail-calls/bug1865044.js
# Commit: d3022af75b98
# Full Hash: d3022af75b98dc310fd04575f5d5121e18bc69ee
# Author: Yury Delendik <ydelendik@mozilla.com>
# Date: 2023-11-22 21:50:37
# Regressor Bug: 1865044
# File Overlap Count: 1
# Description:
#   Bug 1865044 - [wasm] Skip debugger results cleanup for return stubs. r=rhunt
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D194154
# ==============================================================================

diff -r a799320fe84d -r d3022af75b98 js/src/jit-test/tests/wasm/tail-calls/bug1865044.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/jit-test/tests/wasm/tail-calls/bug1865044.js	Wed Nov 22 18:04:40 2023 +0000
@@ -0,0 +1,34 @@
+// |jit-test| --more-compartments; skip-variant-if: --wasm-test-serialization, true; skip-variant-if: --wasm-compiler=ion, true;
+
+a = newGlobal();
+a.b = this;
+a.eval("(" + function () {
+    Debugger(b).onExceptionUnwind = function () {}
+} + ")()");
+function c(d) {
+  binary = wasmTextToBinary(d)
+  e = new WebAssembly.Module(binary)
+  return new WebAssembly.Instance(e)
+}
+f = c(`
+(type $g 
+  (func (param i64 i64 funcref) (result i64))
+)          
+(func (export "vis") (param i64 i64 funcref) (result i64) 
+  local.get 0 
+  local.get 1
+  local.get 2
+  local.get 2
+  ref.cast (ref $g)
+  return_call_ref $g
+)
+`);
+h = f.exports["vis"];
+i = new WebAssembly.Function({
+  parameters: [ "i64", "i64", "funcref" ], results: ["i64"]   
+}, function () {});
+
+assertErrorMessage(
+  () => h(3n, 1n, i),
+  TypeError, /can't convert undefined to BigInt/
+);