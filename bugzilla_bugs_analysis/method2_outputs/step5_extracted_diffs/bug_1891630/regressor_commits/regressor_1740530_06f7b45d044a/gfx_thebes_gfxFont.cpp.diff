# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/thebes/gfxFont.cpp
# Commit: 06f7b45d044a
# Full Hash: 06f7b45d044ac11b4b34e6bb61c10555998952e6
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2022-08-17 09:10:29
# Regressor Bug: 1740530
# File Overlap Count: 1
# Description:
#   Bug 1740530 - patch 5 - Implement support for COLRv1 glyphs represented as acyclic graphs of paint records. r=gfx-reviewers,lsalzman
#   
#   Depends on D153870
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D152041
# ==============================================================================

diff -r 02d6294b7a6d -r 06f7b45d044a gfx/thebes/gfxFont.cpp
--- a/gfx/thebes/gfxFont.cpp	Tue Aug 16 12:48:33 2022 +0000
+++ b/gfx/thebes/gfxFont.cpp	Tue Aug 16 12:48:33 2022 +0000
@@ -2466,7 +2466,7 @@
                                layout::TextDrawTarget* aTextDrawer,
                                ScaledFont* aScaledFont,
                                DrawOptions aDrawOptions, const Point& aPoint,
-                               uint32_t aGlyphId) const {
+                               uint32_t aGlyphId) {
   auto currentColor = [=]() {
     DeviceColor ctxColor;
     return aContext->GetDeviceColor(ctxColor)
@@ -2474,6 +2474,17 @@
                : sRGBColor::OpaqueBlack();
   };
 
+  if (const auto* paintGraph =
+          COLRFonts::GetGlyphPaintGraph(GetFontEntry()->GetCOLR(), aGlyphId)) {
+    const auto* hbShaper = GetHarfBuzzShaper();
+    if (hbShaper && hbShaper->IsInitialized()) {
+      return COLRFonts::PaintGlyphGraph(
+          GetFontEntry()->GetCOLR(), hbShaper->GetHBFont(), paintGraph,
+          aDrawTarget, aTextDrawer, aScaledFont, aDrawOptions, currentColor(),
+          aPoint, aGlyphId, mFUnitsConvFactor);
+    }
+  }
+
   if (const auto* layers =
           COLRFonts::GetGlyphLayers(GetFontEntry()->GetCOLR(), aGlyphId)) {
     auto face(GetFontEntry()->GetHBFace());
@@ -2509,7 +2520,8 @@
   }
   // Check if there is a COLR/CPAL or SVG glyph for this ID.
   if (fe->TryGetColorGlyphs() &&
-      COLRFonts::GetGlyphLayers(fe->GetCOLR(), gid)) {
+      (COLRFonts::GetGlyphPaintGraph(fe->GetCOLR(), gid) ||
+       COLRFonts::GetGlyphLayers(fe->GetCOLR(), gid))) {
     return true;
   }
   if (fe->TryGetSVGData(this) && fe->HasSVGGlyph(gid)) {
@@ -3613,6 +3625,24 @@
     return;
   }
 
+  if (mFontEntry->TryGetColorGlyphs() && mFontEntry->mCOLR &&
+      COLRFonts::GetColrTableVersion(mFontEntry->mCOLR) == 1) {
+    auto* shaper = GetHarfBuzzShaper();
+    if (shaper && shaper->IsInitialized()) {
+      RefPtr scaledFont = GetScaledFont(aDrawTarget);
+      Rect r = COLRFonts::GetColorGlyphBounds(
+          mFontEntry->mCOLR, shaper->GetHBFont(), aGlyphID, aDrawTarget,
+          scaledFont, mFUnitsConvFactor);
+      if (!r.IsEmpty()) {
+        gfxFloat d2a = aExtents->GetAppUnitsPerDevUnit();
+        aExtents->SetTightGlyphExtents(
+            aGlyphID, gfxRect(r.X() * d2a, r.Y() * d2a, r.Width() * d2a,
+                              r.Height() * d2a));
+        return;
+      }
+    }
+  }
+
   gfxRect bounds;
   GetGlyphBounds(aGlyphID, &bounds, mAntialiasOption == kAntialiasNone);
 