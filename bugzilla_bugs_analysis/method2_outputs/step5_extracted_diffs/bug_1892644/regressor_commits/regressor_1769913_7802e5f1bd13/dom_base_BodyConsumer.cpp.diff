# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/base/BodyConsumer.cpp
# Commit: 7802e5f1bd13
# Full Hash: 7802e5f1bd1395f19f2d78636787c41f64192bd7
# Author: Eden Chuang <echuang@mozilla.com>
# Date: 2024-04-19 15:22:44
# Regressor Bug: 1769913
# File Overlap Count: 3
# Description:
#   Bug 1769913 - P3 Remove WorkerRunnable::mWorkerPrivate. r=dom-worker-reviewers,asuth
#   
#   WorkerRunnable no longer keeps a raw pointer(mWorkerPrivate) for the associated WorkerPrivate in this patch.
#   Removing the WorkerRunnable::mWorkerPrivate needs to fix the following problems.
#   
# ==============================================================================

diff -r ffc69aa8f2c3 -r 7802e5f1bd13 dom/base/BodyConsumer.cpp
--- a/dom/base/BodyConsumer.cpp	Fri Apr 19 09:41:57 2024 +0000
+++ b/dom/base/BodyConsumer.cpp	Fri Apr 19 09:41:58 2024 +0000
@@ -74,7 +74,7 @@
   ContinueConsumeBodyRunnable(BodyConsumer* aBodyConsumer,
                               WorkerPrivate* aWorkerPrivate, nsresult aStatus,
                               uint32_t aLength, uint8_t* aResult)
-      : MainThreadWorkerRunnable(aWorkerPrivate, "ContinueConsumeBodyRunnable"),
+      : MainThreadWorkerRunnable("ContinueConsumeBodyRunnable"),
         mBodyConsumer(aBodyConsumer),
         mStatus(aStatus),
         mLength(aLength),
@@ -97,7 +97,7 @@
  public:
   AbortConsumeBodyControlRunnable(BodyConsumer* aBodyConsumer,
                                   WorkerPrivate* aWorkerPrivate)
-      : MainThreadWorkerControlRunnable(aWorkerPrivate),
+      : MainThreadWorkerControlRunnable("AbortConsumeBodyControlRunnable"),
         mBodyConsumer(aBodyConsumer) {
     MOZ_ASSERT(NS_IsMainThread());
   }
@@ -131,7 +131,7 @@
       RefPtr<AbortConsumeBodyControlRunnable> r =
           new AbortConsumeBodyControlRunnable(mBodyConsumer,
                                               mWorkerRef->Private());
-      if (!r->Dispatch()) {
+      if (!r->Dispatch(mWorkerRef->Private())) {
         MOZ_CRASH("We are going to leak");
       }
       return;
@@ -159,8 +159,7 @@
   ContinueConsumeBlobBodyRunnable(BodyConsumer* aBodyConsumer,
                                   WorkerPrivate* aWorkerPrivate,
                                   BlobImpl* aBlobImpl)
-      : MainThreadWorkerRunnable(aWorkerPrivate,
-                                 "ContinueConsumeBlobBodyRunnable"),
+      : MainThreadWorkerRunnable("ContinueConsumeBlobBodyRunnable"),
         mBodyConsumer(aBodyConsumer),
         mBlobImpl(aBlobImpl) {
     MOZ_ASSERT(NS_IsMainThread());
@@ -182,7 +181,7 @@
  public:
   AbortConsumeBlobBodyControlRunnable(BodyConsumer* aBodyConsumer,
                                       WorkerPrivate* aWorkerPrivate)
-      : MainThreadWorkerControlRunnable(aWorkerPrivate),
+      : MainThreadWorkerControlRunnable("AbortConsumeBlobBodyControlRunnable"),
         mBodyConsumer(aBodyConsumer) {
     MOZ_ASSERT(NS_IsMainThread());
   }
@@ -227,7 +226,7 @@
       RefPtr<ContinueConsumeBodyRunnable> r = new ContinueConsumeBodyRunnable(
           mBodyConsumer, mWorkerRef->Private(), aStatus, aResultLength,
           nonconstResult);
-      if (r->Dispatch()) {
+      if (r->Dispatch(mWorkerRef->Private())) {
         // The caller is responsible for data.
         return NS_SUCCESS_ADOPTED_DATA;
       }
@@ -239,7 +238,7 @@
     RefPtr<AbortConsumeBodyControlRunnable> r =
         new AbortConsumeBodyControlRunnable(mBodyConsumer,
                                             mWorkerRef->Private());
-    if (NS_WARN_IF(!r->Dispatch())) {
+    if (NS_WARN_IF(!r->Dispatch(mWorkerRef->Private()))) {
       return NS_ERROR_FAILURE;
     }
 
@@ -620,14 +619,14 @@
         new ContinueConsumeBlobBodyRunnable(this, aWorkerRef->Private(),
                                             aBlobImpl);
 
-    if (r->Dispatch()) {
+    if (r->Dispatch(aWorkerRef->Private())) {
       return;
     }
   } else {
     RefPtr<ContinueConsumeBodyRunnable> r = new ContinueConsumeBodyRunnable(
         this, aWorkerRef->Private(), NS_ERROR_DOM_ABORT_ERR, 0, nullptr);
 
-    if (r->Dispatch()) {
+    if (r->Dispatch(aWorkerRef->Private())) {
       return;
     }
   }
@@ -638,7 +637,7 @@
   RefPtr<AbortConsumeBlobBodyControlRunnable> r =
       new AbortConsumeBlobBodyControlRunnable(this, aWorkerRef->Private());
 
-  Unused << NS_WARN_IF(!r->Dispatch());
+  Unused << NS_WARN_IF(!r->Dispatch(aWorkerRef->Private()));
 }
 
 /*