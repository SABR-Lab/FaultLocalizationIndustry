# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/cookiebanners/nsCookieBannerTelemetryService.cpp
# Commit: 3a37a1701348
# Full Hash: 3a37a1701348cc5dacf569187f586b0e11c3ed5e
# Author: Tim Huang <tihuang@mozilla.com>
# Date: 2024-03-29 04:51:52
# Regressor Bug: 1874741
# File Overlap Count: 1
# Description:
#   Bug 1874741 - Part 5: Implement the GDPR event telemetry for private browsing windows. r=pbz
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D205900
# ==============================================================================

diff -r 5f5dbfcfc95d -r 3a37a1701348 toolkit/components/cookiebanners/nsCookieBannerTelemetryService.cpp
--- a/toolkit/components/cookiebanners/nsCookieBannerTelemetryService.cpp	Thu Mar 28 20:46:34 2024 +0000
+++ b/toolkit/components/cookiebanners/nsCookieBannerTelemetryService.cpp	Thu Mar 28 20:46:35 2024 +0000
@@ -13,6 +13,7 @@
 #include "nsICookie.h"
 #include "nsICookieManager.h"
 #include "nsICookieNotification.h"
+#include "nsIScriptSecurityManager.h"
 #include "nsISearchService.h"
 #include "nsStringFwd.h"
 #include "nsTArray.h"
@@ -120,6 +121,9 @@
   rv = obsSvc->AddObserver(this, "cookie-changed", false);
   NS_ENSURE_SUCCESS(rv, rv);
 
+  rv = obsSvc->AddObserver(this, "private-cookie-changed", false);
+  NS_ENSURE_SUCCESS(rv, rv);
+
   return NS_OK;
 }
 
@@ -143,6 +147,9 @@
   rv = obsSvc->RemoveObserver(this, "cookie-changed");
   NS_ENSURE_SUCCESS(rv, rv);
 
+  rv = obsSvc->RemoveObserver(this, "private-cookie-changed");
+  NS_ENSURE_SUCCESS(rv, rv);
+
   return NS_OK;
 }
 
@@ -172,9 +179,9 @@
     return MaybeReportGoogleGDPRChoiceTelemetry();
   }
 
-  if (nsCRT::strcmp(aTopic, "cookie-changed") == 0) {
-    MOZ_LOG(gCookieBannerTelemetryLog, LogLevel::Debug,
-            ("Observe cookie-changed"));
+  if (nsCRT::strcmp(aTopic, "cookie-changed") == 0 ||
+      nsCRT::strcmp(aTopic, "private-cookie-changed") == 0) {
+    MOZ_LOG(gCookieBannerTelemetryLog, LogLevel::Debug, ("Observe %s", aTopic));
 
     nsCOMPtr<nsICookieNotification> notification = do_QueryInterface(aSubject);
     NS_ENSURE_TRUE(notification, NS_ERROR_FAILURE);
@@ -258,8 +265,11 @@
   if (aCookie) {
     const auto& attrs = aCookie->AsCookie().OriginAttributesRef();
 
-    // We only report cookies with the default originAttributes.
-    if (attrs == OriginAttributes()) {
+    // We only report cookies for the default originAttributes or private
+    // browsing mode.
+    if (attrs.mPrivateBrowsingId !=
+            nsIScriptSecurityManager::DEFAULT_PRIVATE_BROWSING_ID ||
+        attrs == OriginAttributes()) {
       cookies.AppendElement(RefPtr<nsICookie>(aCookie));
     }
   } else {
@@ -312,24 +322,45 @@
     rv = DecodeSOCSGoogleCookie(value, choice, region);
     NS_ENSURE_SUCCESS(rv, rv);
 
+    bool isPrivateBrowsing =
+        cookie->AsCookie().OriginAttributesRef().mPrivateBrowsingId !=
+        nsIScriptSecurityManager::DEFAULT_PRIVATE_BROWSING_ID;
+
     MOZ_LOG(gCookieBannerTelemetryLog, LogLevel::Debug,
-            ("Record the Google GDPR choice %s on the host %s in region %s",
-             choice.get(), host.get(), region.get()));
+            ("Record the Google GDPR choice %s on the host %s in region %s for "
+             "the %s window",
+             choice.get(), host.get(), region.get(),
+             isPrivateBrowsing ? "private" : "normal"));
 
     // We rely on the dynamical labelled string which can send most 16 different
     // labels per report. In average cases, 16 labels is sufficient because we
     // expect a user might have only 1 or 2 "SOCS" cookies on different Google
     // Search domains.
-    glean::cookie_banners::google_gdpr_choice_cookie.Get(host).Set(choice);
+    //
+    // Note that we only report event telemetry for private browsing windows
+    // because the private session is ephemeral. People can change GDPR
+    // choice across different private sessions, so it's hard to collect the
+    // state correctly.
+    if (!isPrivateBrowsing) {
+      glean::cookie_banners::google_gdpr_choice_cookie.Get(host).Set(choice);
+    }
 
     if (aReportEvent) {
-      glean::cookie_banners::GoogleGdprChoiceCookieEventExtra extra = {
-          .choice = Some(choice),
-          .region = Some(region),
-          .searchDomain = Some(host),
-      };
-      glean::cookie_banners::google_gdpr_choice_cookie_event.Record(
-          Some(extra));
+      if (isPrivateBrowsing) {
+        glean::cookie_banners::GoogleGdprChoiceCookieEventPbmExtra extra = {
+            .choice = Some(choice),
+        };
+        glean::cookie_banners::google_gdpr_choice_cookie_event_pbm.Record(
+            Some(extra));
+      } else {
+        glean::cookie_banners::GoogleGdprChoiceCookieEventExtra extra = {
+            .choice = Some(choice),
+            .region = Some(region),
+            .searchDomain = Some(host),
+        };
+        glean::cookie_banners::google_gdpr_choice_cookie_event.Record(
+            Some(extra));
+      }
     }
   }
 