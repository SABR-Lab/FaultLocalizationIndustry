# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/base/nsRefreshDriver.cpp
# Commit: 22b6ef4463c6
# Full Hash: 22b6ef4463c68ed2a9a22a86cbb36956fc20627a
# Author: Jamie Nicol <jnicol@mozilla.com>
# Date: 2023-09-27 03:49:15
# Regressor Bug: 1850573
# File Overlap Count: 1
# Description:
#   Bug 1850573 - Create/destroy PerformanceHintSession in ContentChild based on process priority. r=smaug
#   
#   We use a PerformanceHintSession where supported to ensure the content
#   process main thread and stylo threads are scheduled at a high
#   priority. Previously we created the session when the
# ==============================================================================

diff -r 653daffe1a6b -r 22b6ef4463c6 layout/base/nsRefreshDriver.cpp
--- a/layout/base/nsRefreshDriver.cpp	Tue Sep 26 16:53:51 2023 +0300
+++ b/layout/base/nsRefreshDriver.cpp	Tue Sep 26 12:55:37 2023 +0000
@@ -65,6 +65,7 @@
 #include "GeckoProfiler.h"
 #include "mozilla/dom/BrowserChild.h"
 #include "mozilla/dom/CallbackDebuggerNotification.h"
+#include "mozilla/dom/ContentChild.h"
 #include "mozilla/dom/Event.h"
 #include "mozilla/dom/Performance.h"
 #include "mozilla/dom/Selection.h"
@@ -630,10 +631,6 @@
     // longer tick this timer.
     mVsyncObserver->Shutdown();
     mVsyncObserver = nullptr;
-
-    if (mClosePerfSessionTimer) {
-      mClosePerfSessionTimer->Cancel();
-    }
   }
 
   bool ShouldGiveNonVsyncTasksMoreTime() {
@@ -784,10 +781,18 @@
     mProcessedVsync = true;
   }
 
-  TimeDuration GetPerformanceHintTarget() {
-    // Estimate that we want to the tick to complete in at most half of the
-    // vsync period. This is fairly arbitrary and can be tweaked later.
-    return GetTimerRate() / int64_t(2);
+  hal::PerformanceHintSession* GetPerformanceHintSession() {
+    // The ContentChild creates/destroys the PerformanceHintSession in response
+    // to the process' priority being foregrounded/backgrounded. We can only use
+    // this session when using a single vsync source for the process, otherwise
+    // these threads may be performing work for multiple
+    // VsyncRefreshDriverTimers and we will misreport the work duration.
+    const ContentChild* contentChild = ContentChild::GetSingleton();
+    if (contentChild && mVsyncChild) {
+      return contentChild->PerformanceHintSession();
+    }
+
+    return nullptr;
   }
 
   void TickRefreshDriver(VsyncId aId, TimeStamp aVsyncTimestamp) {
@@ -800,9 +805,11 @@
     const TimeDuration previousRate = mVsyncRate;
     const TimeDuration rate = GetTimerRate();
 
-    if (mPerformanceHintSession && rate != previousRate) {
-      mPerformanceHintSession->UpdateTargetWorkDuration(
-          GetPerformanceHintTarget());
+    hal::PerformanceHintSession* const performanceHintSession =
+        GetPerformanceHintSession();
+    if (performanceHintSession && rate != previousRate) {
+      performanceHintSession->UpdateTargetWorkDuration(
+          ContentChild::GetPerformanceHintTarget(rate));
     }
 
     if (TimeDuration::FromMilliseconds(nsRefreshDriver::DefaultInterval() / 2) >
@@ -828,8 +835,8 @@
 
     TimeStamp tickEnd = TimeStamp::Now();
 
-    if (mPerformanceHintSession) {
-      mPerformanceHintSession->ReportActualWorkDuration(tickEnd - tickStart);
+    if (performanceHintSession) {
+      performanceHintSession->ReportActualWorkDuration(tickEnd - tickStart);
     }
 
     // Re-read mLastTickStart in case there was a nested tick inside this
@@ -891,35 +898,6 @@
       OnTimerStart();
     }
     mIsTicking = true;
-
-    static bool canUsePerformanceHintSession = true;
-    if (canUsePerformanceHintSession) {
-      if (mClosePerfSessionTimer) {
-        mClosePerfSessionTimer->Cancel();
-      }
-
-      // While the timer is active create a PerformanceHintSession for the main
-      // thread and stylo threads in the content process.  We can only do so
-      // when using a single vsync source for the process, otherwise these
-      // threads may be performing work for multiple VsyncRefreshDriverTimers
-      // and we will misreport the duration.
-      if (XRE_IsContentProcess() && !mPerformanceHintSession && mVsyncChild) {
-        nsTArray<PlatformThreadHandle> threads;
-        Servo_ThreadPool_GetThreadHandles(&threads);
-#ifdef XP_WIN
-        threads.AppendElement(GetCurrentThread());
-#else
-        threads.AppendElement(pthread_self());
-#endif
-
-        mPerformanceHintSession = hal::CreatePerformanceHintSession(
-            threads, GetPerformanceHintTarget());
-
-        // Avoid repeatedly attempting to create a session if it is not
-        // supported.
-        canUsePerformanceHintSession = mPerformanceHintSession != nullptr;
-      }
-    }
   }
 
   void StopTimer() override {
@@ -931,25 +909,6 @@
       mVsyncChild->RemoveChildRefreshTimer(mVsyncObserver);
     }
     mIsTicking = false;
-
-    if (mPerformanceHintSession) {
-      if (!mClosePerfSessionTimer) {
-        mClosePerfSessionTimer = NS_NewTimer();
-      }
-      // If the timer is not restarted within 5 seconds then close the
-      // PerformanceHintSession. This is a balance between wanting to close the
-      // session promptly when timer is inactive to save power, but equally not
-      // wanting to repeatedly create and destroy sessions nor cause frequent
-      // wakeups by the timer repeatedly firing.
-      mClosePerfSessionTimer->InitWithNamedFuncCallback(
-          [](nsITimer* aTimer, void* aClosure) {
-            VsyncRefreshDriverTimer* self =
-                static_cast<VsyncRefreshDriverTimer*>(aClosure);
-            self->mPerformanceHintSession.reset();
-          },
-          this, 5000, nsITimer::TYPE_ONE_SHOT_LOW_PRIORITY,
-          "VsyncRefreshDriverTimer::mClosePerfSessionTimer");
-    }
   }
 
  public:
@@ -1007,12 +966,6 @@
   // The timestamp is effectively mLastProcessedTick + some duration.
   TimeStamp mSuspendVsyncPriorityTicksUntil;
   bool mProcessedVsync;
-
-  UniquePtr<hal::PerformanceHintSession> mPerformanceHintSession;
-  // Used to wait a certain amount of time after the refresh driver timer is
-  // stopped before closing the PerformanceHintSession if the timer has not
-  // been restarted.
-  RefPtr<nsITimer> mClosePerfSessionTimer;
 };  // VsyncRefreshDriverTimer
 
 /**
