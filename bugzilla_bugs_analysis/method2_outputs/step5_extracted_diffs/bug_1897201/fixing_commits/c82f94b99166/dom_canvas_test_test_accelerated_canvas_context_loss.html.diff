# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/canvas/test/test_accelerated_canvas_context_loss.html
# Commit: c82f94b99166
# Full Hash: c82f94b991664b361e4d0abfc407e03d6a91212b
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2024-05-24 09:53:01
# Description:
#   Bug 1897201 - Return identity transform while recovering from context loss with canvas. r=gfx-reviewers,lsalzman
#   
#   When we lose the context for a 2D canvas, we need to silently fail any
#   canvas calls until the context is recovered. Unfortunately that meant we
#   returned a nullptr in CanvasRenderingContext2D::GetTransform which is
# ==============================================================================

diff -r 22edcfdcc72c -r c82f94b99166 dom/canvas/test/test_accelerated_canvas_context_loss.html
--- a/dom/canvas/test/test_accelerated_canvas_context_loss.html	Thu May 23 22:53:45 2024 +0000
+++ b/dom/canvas/test/test_accelerated_canvas_context_loss.html	Thu May 23 22:58:18 2024 +0000
@@ -58,6 +58,12 @@
 
 function onContextLost() {
   ok(context.isContextLost(), "Canvas context should be lost during contextlost event");
+
+  try {
+    let transform = context.getTransform();
+    ok(transform.isIdentity, "Canvas context should return identity transform while context lost");
+  } catch (e) {}
+
   countLostEvents += 1;
 }
 
@@ -88,6 +94,12 @@
 
     ok(!context.isContextLost(), "Canvas context should not be lost after initial fill");
 
+    let transform = context.getTransform();
+    ok(transform.isIdentity, "Canvas context should default to identity transform");
+    context.setTransform(2.0, 3.0, 4.0, 5.0, 6.0, 7.0);
+    transform = context.getTransform();
+    ok(!transform.isIdentity, "Canvas context should have non-identity transform");
+
     const restarted = await restartGPUProcess();
     const expectedEvents = restarted ? 1 : 0;
 
