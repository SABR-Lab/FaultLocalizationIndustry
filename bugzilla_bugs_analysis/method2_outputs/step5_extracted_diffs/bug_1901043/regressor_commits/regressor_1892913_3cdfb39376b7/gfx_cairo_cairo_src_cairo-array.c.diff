# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/cairo/cairo/src/cairo-array.c
# Commit: 3cdfb39376b7
# Full Hash: 3cdfb39376b736597fe658a322389117686b7e82
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2024-05-07 09:13:07
# Regressor Bug: 1892913
# File Overlap Count: 3
# Description:
#   Bug 1892913 - patch 1 - Update cairo source to 1.18.0 r=gfx-reviewers,lsalzman
#   
#   Wholesale replacement of files in gfx/cairo/cairo with contents of the 1.18.0 release tarball,
#   omitting subdirectories that are not part of the core library build.
#   
# ==============================================================================

diff -r 9daa351f875b -r 3cdfb39376b7 gfx/cairo/cairo/src/cairo-array.c
--- a/gfx/cairo/cairo/src/cairo-array.c	Mon May 06 19:22:35 2024 +0000
+++ b/gfx/cairo/cairo/src/cairo-array.c	Mon May 06 19:25:12 2024 +0000
@@ -40,7 +40,7 @@
 #include "cairo-array-private.h"
 #include "cairo-error-private.h"
 
-/**
+/*< private >
  * _cairo_array_init:
  *
  * Initialize a new #cairo_array_t object to store objects each of size
@@ -63,7 +63,7 @@
     array->elements = NULL;
 }
 
-/**
+/*< private >
  * _cairo_array_fini:
  * @array: A #cairo_array_t
  *
@@ -77,7 +77,7 @@
     free (array->elements);
 }
 
-/**
+/*< private >
  * _cairo_array_grow_by:
  * @array: a #cairo_array_t
  *
@@ -125,7 +125,7 @@
     return CAIRO_STATUS_SUCCESS;
 }
 
-/**
+/*< private >
  * _cairo_array_truncate:
  * @array: a #cairo_array_t
  *
@@ -140,17 +140,16 @@
 	array->num_elements = num_elements;
 }
 
-/**
+/*< private >
  * _cairo_array_index:
  * @array: a #cairo_array_t
- * Returns: A pointer to the object stored at @index.
  *
  * If the resulting value is assigned to a pointer to an object of the same
  * element_size as initially passed to _cairo_array_init() then that
  * pointer may be used for further direct indexing with []. For
  * example:
  *
- * <informalexample><programlisting>
+ * |[<!-- language="C" -->
  *	cairo_array_t array;
  *	double *values;
  *
@@ -160,7 +159,9 @@
  *	values = _cairo_array_index (&array, 0);
  *      for (i = 0; i < _cairo_array_num_elements (&array); i++)
  *	    ... use values[i] here ...
- * </programlisting></informalexample>
+ * ]|
+ *
+ * Returns: A pointer to the object stored at @index.
  **/
 void *
 _cairo_array_index (cairo_array_t *array, unsigned int index)
@@ -181,20 +182,19 @@
 
     assert (index < array->num_elements);
 
-    return array->elements + index * array->element_size;
+    return array->elements + (size_t)index * array->element_size;
 }
 
-/**
+/*< private >
  * _cairo_array_index_const:
  * @array: a #cairo_array_t
- * Returns: A pointer to the object stored at @index.
  *
  * If the resulting value is assigned to a pointer to an object of the same
  * element_size as initially passed to _cairo_array_init() then that
  * pointer may be used for further direct indexing with []. For
  * example:
  *
- * <informalexample><programlisting>
+ * |[<!-- language="C" --.
  *	cairo_array_t array;
  *	const double *values;
  *
@@ -204,7 +204,9 @@
  *	values = _cairo_array_index_const (&array, 0);
  *      for (i = 0; i < _cairo_array_num_elements (&array); i++)
  *	    ... read values[i] here ...
- * </programlisting></informalexample>
+ * ]|
+ *
+ * Returns: A pointer to the object stored at @index.
  **/
 const void *
 _cairo_array_index_const (const cairo_array_t *array, unsigned int index)
@@ -225,10 +227,10 @@
 
     assert (index < array->num_elements);
 
-    return array->elements + index * array->element_size;
+    return array->elements + (size_t)index * array->element_size;
 }
 
-/**
+/*< private >
  * _cairo_array_copy_element:
  * @array: a #cairo_array_t
  *
@@ -243,7 +245,7 @@
     memcpy (dst, _cairo_array_index_const (array, index), array->element_size);
 }
 
-/**
+/*< private >
  * _cairo_array_append:
  * @array: a #cairo_array_t
  *
@@ -265,7 +267,7 @@
     return _cairo_array_append_multiple (array, element, 1);
 }
 
-/**
+/*< private >
  * _cairo_array_append_multiple:
  * @array: a #cairo_array_t
  *
@@ -289,12 +291,12 @@
     if (unlikely (status))
 	return status;
 
-    memcpy (dest, elements, num_elements * array->element_size);
+    memcpy (dest, elements, (size_t)num_elements * array->element_size);
 
     return CAIRO_STATUS_SUCCESS;
 }
 
-/**
+/*< private >
  * _cairo_array_allocate:
  * @array: a #cairo_array_t
  *
@@ -320,19 +322,20 @@
 
     assert (array->num_elements + num_elements <= array->size);
 
-    *elements = array->elements + array->num_elements * array->element_size;
+    *elements = array->elements + (size_t)array->num_elements * array->element_size;
 
     array->num_elements += num_elements;
 
     return CAIRO_STATUS_SUCCESS;
 }
 
-/**
+/*< private >
  * _cairo_array_num_elements:
  * @array: a #cairo_array_t
- * Returns: The number of elements stored in @array.
  *
  * This space was left intentionally blank, but gtk-doc filled it.
+ *
+ * Returns: The number of elements stored in @array.
  **/
 unsigned int
 _cairo_array_num_elements (const cairo_array_t *array)
@@ -340,13 +343,14 @@
     return array->num_elements;
 }
 
-/**
+/*< private >
  * _cairo_array_size:
  * @array: a #cairo_array_t
+ *
+ * This space was left intentionally blank, but gtk-doc filled it.
+ *
  * Returns: The number of elements for which there is currently space
  * allocated in @array.
- *
- * This space was left intentionally blank, but gtk-doc filled it.
  **/
 unsigned int
 _cairo_array_size (const cairo_array_t *array)
@@ -354,7 +358,7 @@
     return array->size;
 }
 
-/**
+/*< private >
  * _cairo_user_data_array_init:
  * @array: a #cairo_user_data_array_t
  *
@@ -369,7 +373,7 @@
     _cairo_array_init (array, sizeof (cairo_user_data_slot_t));
 }
 
-/**
+/*< private >
  * _cairo_user_data_array_fini:
  * @array: a #cairo_user_data_array_t
  *
@@ -396,7 +400,7 @@
     _cairo_array_fini (array);
 }
 
-/**
+/*< private >
  * _cairo_user_data_array_get_data:
  * @array: a #cairo_user_data_array_t
  * @key: the address of the #cairo_user_data_key_t the user data was
@@ -412,7 +416,7 @@
 _cairo_user_data_array_get_data (cairo_user_data_array_t     *array,
 				 const cairo_user_data_key_t *key)
 {
-    int i, num_slots;
+    unsigned int i, num_slots;
     cairo_user_data_slot_t *slots;
 
     /* We allow this to support degenerate objects such as cairo_surface_nil. */
@@ -429,7 +433,7 @@
     return NULL;
 }
 
-/**
+/*< private >
  * _cairo_user_data_array_set_data:
  * @array: a #cairo_user_data_array_t
  * @key: the address of a #cairo_user_data_key_t to attach the user data to
@@ -452,7 +456,7 @@
 				 cairo_destroy_func_t	      destroy)
 {
     cairo_status_t status;
-    int i, num_slots;
+    unsigned int i, num_slots;
     cairo_user_data_slot_t *slots, *slot, new_slot;
 
     if (user_data) {
@@ -523,7 +527,7 @@
 				void *closure)
 {
     cairo_user_data_slot_t *slots;
-    int i, num_slots;
+    unsigned int i, num_slots;
 
     num_slots = array->num_elements;
     slots = _cairo_array_index (array, 0);
@@ -538,3 +542,39 @@
 {
     qsort (array->elements, array->num_elements, array->element_size, compar);
 }
+
+/*< private >
+ * _cairo_array_pop_element:
+ * @array: a #cairo_array_t
+ * Returns: A TRUE if element successfully popped, FALSE if the array is empty.
+ *
+ * Copy the last element out of the array from index @index into the
+ * location pointed to by @dst and remove the element from the array.
+ **/
+cairo_bool_t
+_cairo_array_pop_element (cairo_array_t *array, void *dst)
+{
+    if (array->num_elements > 0) {
+	_cairo_array_copy_element (array, array->num_elements - 1, dst);
+	array->num_elements--;
+	return TRUE;
+    }
+
+    return FALSE;
+}
+
+/*< private >
+ * _cairo_array_top_element:
+ * @array: a #cairo_array_t
+ * Returns: A pointer to the last of object or NULL if array is empty.
+ *
+ * Get the pointer to the last element of of the array.
+ **/
+void *
+_cairo_array_last_element (cairo_array_t *array)
+{
+    if (array->num_elements > 0)
+	return _cairo_array_index (array, array->num_elements - 1);
+
+    return NULL;
+}