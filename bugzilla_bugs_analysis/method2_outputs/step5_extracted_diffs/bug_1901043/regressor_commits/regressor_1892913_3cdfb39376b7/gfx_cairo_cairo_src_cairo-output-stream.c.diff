# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/cairo/cairo/src/cairo-output-stream.c
# Commit: 3cdfb39376b7
# Full Hash: 3cdfb39376b736597fe658a322389117686b7e82
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2024-05-07 09:13:07
# Regressor Bug: 1892913
# File Overlap Count: 3
# Description:
#   Bug 1892913 - patch 1 - Update cairo source to 1.18.0 r=gfx-reviewers,lsalzman
#   
#   Wholesale replacement of files in gfx/cairo/cairo with contents of the 1.18.0 release tarball,
#   omitting subdirectories that are not part of the core library build.
#   
# ==============================================================================

diff -r 9daa351f875b -r 3cdfb39376b7 gfx/cairo/cairo/src/cairo-output-stream.c
--- a/gfx/cairo/cairo/src/cairo-output-stream.c	Mon May 06 19:22:35 2024 +0000
+++ b/gfx/cairo/cairo/src/cairo-output-stream.c	Mon May 06 19:25:12 2024 +0000
@@ -1,3 +1,4 @@
+/* -*- Mode: c; tab-width: 8; c-basic-offset: 4; indent-tabs-mode: t; -*- */
 /* cairo-output-stream.c: Output stream abstraction
  *
  * Copyright Â© 2005 Red Hat, Inc
@@ -258,11 +259,13 @@
 _cairo_output_stream_write (cairo_output_stream_t *stream,
 			    const void *data, size_t length)
 {
-    if (length == 0)
+    if (length == 0 || stream->status)
 	return;
 
-    if (stream->status)
+    if (stream->closed) {
+	stream->status = CAIRO_STATUS_WRITE_ERROR;
 	return;
+    }
 
     stream->status = stream->write_func (stream, data, length);
     stream->position += length;
@@ -277,9 +280,6 @@
     char buffer[2];
     unsigned int i, column;
 
-    if (stream->status)
-	return;
-
     for (i = 0, column = 0; i < length; i++, column++) {
 	if (column == 38) {
 	    _cairo_output_stream_write (stream, "\n", 1);
@@ -382,7 +382,8 @@
 }
 
 enum {
-    LENGTH_MODIFIER_LONG = 0x100
+    LENGTH_MODIFIER_LONG = 0x100,
+    LENGTH_MODIFIER_LONG_LONG = 0x200
 };
 
 /* Here's a limited reimplementation of printf.  The reason for doing
@@ -405,9 +406,6 @@
     int length_modifier, width;
     cairo_bool_t var_width;
 
-    if (stream->status)
-	return;
-
     f = fmt;
     p = buffer;
     while (*f != '\0') {
@@ -440,6 +438,10 @@
 	if (*f == 'l') {
 	    length_modifier = LENGTH_MODIFIER_LONG;
 	    f++;
+	    if (*f == 'l') {
+		length_modifier = LENGTH_MODIFIER_LONG_LONG;
+		f++;
+	    }
 	}
 
 	/* The only format strings exist in the cairo implementation
@@ -490,6 +492,20 @@
                           single_fmt, va_arg (ap, long int));
             }
 	    break;
+	case 'd' | LENGTH_MODIFIER_LONG_LONG:
+	case 'u' | LENGTH_MODIFIER_LONG_LONG:
+	case 'o' | LENGTH_MODIFIER_LONG_LONG:
+	case 'x' | LENGTH_MODIFIER_LONG_LONG:
+	case 'X' | LENGTH_MODIFIER_LONG_LONG:
+	    if (var_width) {
+		width = va_arg (ap, int);
+		snprintf (buffer, sizeof buffer,
+			  single_fmt, width, va_arg (ap, long long int));
+	    } else {
+		snprintf (buffer, sizeof buffer,
+			  single_fmt, va_arg (ap, long long int));
+	    }
+	    break;
 	case 's': {
 	    /* Write out strings as they may be larger than the buffer. */
 	    const char *s = va_arg (ap, const char *);
@@ -570,7 +586,7 @@
 				 m.xx, m.yx, m.xy, m.yy, m.x0, m.y0);
 }
 
-long
+long long
 _cairo_output_stream_get_position (cairo_output_stream_t *stream)
 {
     return stream->position;
@@ -766,9 +782,6 @@
 {
     memory_stream_t *stream = (memory_stream_t *) base;
 
-    if (dest->status)
-	return;
-
     if (base->status) {
 	dest->status = base->status;
 	return;