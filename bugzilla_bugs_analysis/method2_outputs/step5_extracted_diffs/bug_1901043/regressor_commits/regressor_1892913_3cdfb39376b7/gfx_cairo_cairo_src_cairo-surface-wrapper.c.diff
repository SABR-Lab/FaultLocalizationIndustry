# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/cairo/cairo/src/cairo-surface-wrapper.c
# Commit: 3cdfb39376b7
# Full Hash: 3cdfb39376b736597fe658a322389117686b7e82
# Author: Jonathan Kew <jkew@mozilla.com>
# Date: 2024-05-07 09:13:07
# Regressor Bug: 1892913
# File Overlap Count: 3
# Description:
#   Bug 1892913 - patch 1 - Update cairo source to 1.18.0 r=gfx-reviewers,lsalzman
#   
#   Wholesale replacement of files in gfx/cairo/cairo with contents of the 1.18.0 release tarball,
#   omitting subdirectories that are not part of the core library build.
#   
# ==============================================================================

diff -r 9daa351f875b -r 3cdfb39376b7 gfx/cairo/cairo/src/cairo-surface-wrapper.c
--- a/gfx/cairo/cairo/src/cairo-surface-wrapper.c	Mon May 06 19:22:35 2024 +0000
+++ b/gfx/cairo/cairo/src/cairo-surface-wrapper.c	Mon May 06 19:25:12 2024 +0000
@@ -1,3 +1,4 @@
+/* -*- Mode: c; tab-width: 8; c-basic-offset: 4; indent-tabs-mode: t; -*- */
 /* cairo - a vector graphics library with display and print output
  *
  * Copyright Â© 2005 Red Hat, Inc
@@ -47,12 +48,18 @@
 static void
 _copy_transformed_pattern (cairo_pattern_t *pattern,
 			   const cairo_pattern_t *original,
-			   const cairo_matrix_t  *ctm_inverse)
+			   const cairo_matrix_t  *ctm_inverse,
+			   unsigned int region_id)
 {
     _cairo_pattern_init_static_copy (pattern, original);
 
     if (! _cairo_matrix_is_identity (ctm_inverse))
 	_cairo_pattern_transform (pattern, ctm_inverse);
+
+    if (pattern->type == CAIRO_PATTERN_TYPE_SURFACE) {
+	cairo_surface_pattern_t *surface_pattern = (cairo_surface_pattern_t *) pattern;
+	surface_pattern->region_array_id = region_id;
+    }
 }
 
 cairo_status_t
@@ -129,9 +136,10 @@
 
 cairo_status_t
 _cairo_surface_wrapper_paint (cairo_surface_wrapper_t *wrapper,
-			      cairo_operator_t	 op,
-			      const cairo_pattern_t *source,
-			      const cairo_clip_t    *clip)
+			      cairo_operator_t	       op,
+			      const cairo_pattern_t   *source,
+			      unsigned int             source_region_id,
+			      const cairo_clip_t      *clip)
 {
     cairo_status_t status;
     cairo_clip_t *dev_clip;
@@ -144,7 +152,7 @@
     if (_cairo_clip_is_all_clipped (dev_clip))
 	return CAIRO_INT_STATUS_NOTHING_TO_DO;
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || source_region_id != 0) {
 	cairo_matrix_t m;
 
 	_cairo_surface_wrapper_get_transform (wrapper, &m);
@@ -152,7 +160,7 @@
 	status = cairo_matrix_invert (&m);
 	assert (status == CAIRO_STATUS_SUCCESS);
 
-	_copy_transformed_pattern (&source_copy.base, source, &m);
+	_copy_transformed_pattern (&source_copy.base, source, &m, source_region_id);
 	source = &source_copy.base;
     }
 
@@ -162,13 +170,14 @@
     return status;
 }
 
-
 cairo_status_t
 _cairo_surface_wrapper_mask (cairo_surface_wrapper_t *wrapper,
-			     cairo_operator_t	 op,
-			     const cairo_pattern_t *source,
-			     const cairo_pattern_t *mask,
-			     const cairo_clip_t	    *clip)
+			     cairo_operator_t	      op,
+			     const cairo_pattern_t   *source,
+                             unsigned int             source_region_id,
+			     const cairo_pattern_t   *mask,
+                             unsigned int             mask_region_id,
+			     const cairo_clip_t	     *clip)
 {
     cairo_status_t status;
     cairo_clip_t *dev_clip;
@@ -182,7 +191,7 @@
     if (_cairo_clip_is_all_clipped (dev_clip))
 	return CAIRO_INT_STATUS_NOTHING_TO_DO;
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || source_region_id != 0 || mask_region_id != 0) {
 	cairo_matrix_t m;
 
 	_cairo_surface_wrapper_get_transform (wrapper, &m);
@@ -190,10 +199,10 @@
 	status = cairo_matrix_invert (&m);
 	assert (status == CAIRO_STATUS_SUCCESS);
 
-	_copy_transformed_pattern (&source_copy.base, source, &m);
+	_copy_transformed_pattern (&source_copy.base, source, &m, source_region_id);
 	source = &source_copy.base;
 
-	_copy_transformed_pattern (&mask_copy.base, mask, &m);
+	_copy_transformed_pattern (&mask_copy.base, mask, &m, mask_region_id);
 	mask = &mask_copy.base;
     }
 
@@ -204,16 +213,17 @@
 }
 
 cairo_status_t
-_cairo_surface_wrapper_stroke (cairo_surface_wrapper_t *wrapper,
-			       cairo_operator_t		 op,
-			       const cairo_pattern_t	*source,
-			       const cairo_path_fixed_t	*path,
-			       const cairo_stroke_style_t	*stroke_style,
-			       const cairo_matrix_t		*ctm,
-			       const cairo_matrix_t		*ctm_inverse,
-			       double			 tolerance,
-			       cairo_antialias_t	 antialias,
-			       const cairo_clip_t		*clip)
+_cairo_surface_wrapper_stroke (cairo_surface_wrapper_t    *wrapper,
+			       cairo_operator_t		   op,
+			       const cairo_pattern_t	  *source,
+			       unsigned int                source_region_id,
+			       const cairo_path_fixed_t	  *path,
+			       const cairo_stroke_style_t *stroke_style,
+			       const cairo_matrix_t	  *ctm,
+			       const cairo_matrix_t	  *ctm_inverse,
+			       double			   tolerance,
+			       cairo_antialias_t	   antialias,
+			       const cairo_clip_t	  *clip)
 {
     cairo_status_t status;
     cairo_path_fixed_t path_copy, *dev_path = (cairo_path_fixed_t *) path;
@@ -229,7 +239,7 @@
     if (_cairo_clip_is_all_clipped (dev_clip))
 	return CAIRO_INT_STATUS_NOTHING_TO_DO;
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || source_region_id != 0) {
 	cairo_matrix_t m;
 
 	_cairo_surface_wrapper_get_transform (wrapper, &m);
@@ -248,7 +258,7 @@
 
 	cairo_matrix_multiply (&dev_ctm_inverse, &m, &dev_ctm_inverse);
 
-	_copy_transformed_pattern (&source_copy.base, source, &m);
+	_copy_transformed_pattern (&source_copy.base, source, &m, source_region_id);
 	source = &source_copy.base;
     }
 
@@ -266,21 +276,23 @@
 }
 
 cairo_status_t
-_cairo_surface_wrapper_fill_stroke (cairo_surface_wrapper_t *wrapper,
-				    cairo_operator_t	     fill_op,
-				    const cairo_pattern_t   *fill_source,
-				    cairo_fill_rule_t	     fill_rule,
-				    double		     fill_tolerance,
-				    cairo_antialias_t	     fill_antialias,
-				    const cairo_path_fixed_t*path,
-				    cairo_operator_t	     stroke_op,
-				    const cairo_pattern_t   *stroke_source,
-				    const cairo_stroke_style_t    *stroke_style,
-				    const cairo_matrix_t	    *stroke_ctm,
-				    const cairo_matrix_t	    *stroke_ctm_inverse,
-				    double		     stroke_tolerance,
-				    cairo_antialias_t	     stroke_antialias,
-				    const cairo_clip_t	    *clip)
+_cairo_surface_wrapper_fill_stroke (cairo_surface_wrapper_t    *wrapper,
+				    cairo_operator_t	        fill_op,
+				    const cairo_pattern_t      *fill_source,
+				    unsigned int                fill_region_id,
+				    cairo_fill_rule_t	        fill_rule,
+				    double		        fill_tolerance,
+				    cairo_antialias_t	        fill_antialias,
+				    const cairo_path_fixed_t   *path,
+				    cairo_operator_t	        stroke_op,
+				    const cairo_pattern_t      *stroke_source,
+				    unsigned int                stroke_region_id,
+				    const cairo_stroke_style_t *stroke_style,
+				    const cairo_matrix_t       *stroke_ctm,
+				    const cairo_matrix_t       *stroke_ctm_inverse,
+				    double		        stroke_tolerance,
+				    cairo_antialias_t	        stroke_antialias,
+				    const cairo_clip_t	       *clip)
 {
     cairo_status_t status;
     cairo_path_fixed_t path_copy, *dev_path = (cairo_path_fixed_t *)path;
@@ -297,7 +309,7 @@
     if (_cairo_clip_is_all_clipped (dev_clip))
 	return CAIRO_INT_STATUS_NOTHING_TO_DO;
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || fill_region_id != 0 || stroke_region_id != 0) {
 	cairo_matrix_t m;
 
 	_cairo_surface_wrapper_get_transform (wrapper, &m);
@@ -316,10 +328,10 @@
 
 	cairo_matrix_multiply (&dev_ctm_inverse, &m, &dev_ctm_inverse);
 
-	_copy_transformed_pattern (&stroke_source_copy.base, stroke_source, &m);
+	_copy_transformed_pattern (&stroke_source_copy.base, stroke_source, &m, fill_region_id);
 	stroke_source = &stroke_source_copy.base;
 
-	_copy_transformed_pattern (&fill_source_copy.base, fill_source, &m);
+	_copy_transformed_pattern (&fill_source_copy.base, fill_source, &m, stroke_region_id);
 	fill_source = &fill_source_copy.base;
     }
 
@@ -341,14 +353,15 @@
 }
 
 cairo_status_t
-_cairo_surface_wrapper_fill (cairo_surface_wrapper_t	*wrapper,
-			     cairo_operator_t	 op,
-			     const cairo_pattern_t *source,
-			     const cairo_path_fixed_t	*path,
-			     cairo_fill_rule_t	 fill_rule,
-			     double		 tolerance,
-			     cairo_antialias_t	 antialias,
-			     const cairo_clip_t	*clip)
+_cairo_surface_wrapper_fill (cairo_surface_wrapper_t  *wrapper,
+			     cairo_operator_t	       op,
+			     const cairo_pattern_t    *source,
+			     unsigned int              source_region_id,
+			     const cairo_path_fixed_t *path,
+			     cairo_fill_rule_t	       fill_rule,
+			     double		       tolerance,
+			     cairo_antialias_t	       antialias,
+			     const cairo_clip_t	      *clip)
 {
     cairo_status_t status;
     cairo_path_fixed_t path_copy, *dev_path = (cairo_path_fixed_t *) path;
@@ -362,7 +375,7 @@
     if (_cairo_clip_is_all_clipped (dev_clip))
 	return CAIRO_INT_STATUS_NOTHING_TO_DO;
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || source_region_id != 0) {
 	cairo_matrix_t m;
 
 	_cairo_surface_wrapper_get_transform (wrapper, &m);
@@ -377,7 +390,7 @@
 	status = cairo_matrix_invert (&m);
 	assert (status == CAIRO_STATUS_SUCCESS);
 
-	_copy_transformed_pattern (&source_copy.base, source, &m);
+	_copy_transformed_pattern (&source_copy.base, source, &m, source_region_id);
 	source = &source_copy.base;
     }
 
@@ -394,9 +407,10 @@
 }
 
 cairo_status_t
-_cairo_surface_wrapper_show_text_glyphs (cairo_surface_wrapper_t *wrapper,
+_cairo_surface_wrapper_show_text_glyphs (cairo_surface_wrapper_t    *wrapper,
 					 cairo_operator_t	     op,
 					 const cairo_pattern_t	    *source,
+					 unsigned int                source_region_id,
 					 const char		    *utf8,
 					 int			     utf8_len,
 					 const cairo_glyph_t	    *glyphs,
@@ -425,7 +439,7 @@
     cairo_surface_get_font_options (wrapper->target, &options);
     cairo_font_options_merge (&options, &scaled_font->options);
 
-    if (wrapper->needs_transform) {
+    if (wrapper->needs_transform || source_region_id != 0) {
 	cairo_matrix_t m;
 	int i;
 
@@ -460,7 +474,7 @@
 	status = cairo_matrix_invert (&m);
 	assert (status == CAIRO_STATUS_SUCCESS);
 
-	_copy_transformed_pattern (&source_copy.base, source, &m);
+	_copy_transformed_pattern (&source_copy.base, source, &m, source_region_id);
 	source = &source_copy.base;
     } else {
 	if (! cairo_font_options_equal (&options, &scaled_font->options)) {
@@ -622,6 +636,8 @@
     wrapper->has_extents = FALSE;
     wrapper->extents.x = wrapper->extents.y = 0;
     wrapper->clip = NULL;
+    wrapper->source_region_id = 0;
+    wrapper->mask_region_id = 0;
 
     wrapper->needs_transform = FALSE;
     if (target) {