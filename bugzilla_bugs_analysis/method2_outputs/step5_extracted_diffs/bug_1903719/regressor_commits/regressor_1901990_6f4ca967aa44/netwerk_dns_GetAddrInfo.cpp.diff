# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/dns/GetAddrInfo.cpp
# Commit: 6f4ca967aa44
# Full Hash: 6f4ca967aa446cf24f4224576f51803c982f3d7b
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2024-06-14 20:49:45
# Regressor Bug: 1901990
# File Overlap Count: 2
# Description:
#   Bug 1901990 - Introduce a pref for setting a mock HTTPS RR, r=necko-reviewers,valentin
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D213559
# ==============================================================================

diff -r 8a2bdb44382a -r 6f4ca967aa44 netwerk/dns/GetAddrInfo.cpp
--- a/netwerk/dns/GetAddrInfo.cpp	Fri Jun 14 13:27:36 2024 +0000
+++ b/netwerk/dns/GetAddrInfo.cpp	Fri Jun 14 13:42:37 2024 +0000
@@ -422,7 +422,6 @@
 
   DNSPacket packet;
   nsAutoCString host(aHost);
-  nsAutoCString cname;
 
   LOG("resolving %s\n", host.get());
   // Perform the query
@@ -488,6 +487,65 @@
   return ResolveHTTPSRecordImpl(aHost, aFlags, aResult, aTTL);
 }
 
+nsresult CreateAndResolveMockHTTPSRecord(const nsACString& aHost,
+                                         uint16_t aFlags,
+                                         TypeRecordResultType& aResult,
+                                         uint32_t& aTTL) {
+  nsCString buffer;
+  buffer += '\0';
+  buffer += '\0';  // 16 bit id
+  buffer += 0x80;
+  buffer += '\0';  // Flags
+  buffer += '\0';
+  buffer += '\0';  // Question count
+  buffer += '\0';
+  buffer += 0x1;  // Answer count
+  buffer += '\0';
+  buffer += '\0';
+  buffer += '\0';
+  buffer += '\0';
+
+  nsresult rv = DNSPacket::EncodeHost(buffer, aHost);
+  if (NS_FAILED(rv)) {
+    return rv;
+  }
+
+  buffer += '\0';
+  buffer += 0x41;  // TYPE 65
+
+  buffer += '\0';
+  buffer += 0x1;  // Class
+
+  buffer += '\0';
+  buffer += '\0';
+  buffer += '\0';
+  buffer += 0xFF;  // TTL
+  buffer += '\0';
+  buffer += 0x03;  // RDLENGTH
+  buffer += '\0';
+  buffer += 0x01;  // SvcPriority
+  buffer += '\0';
+
+  DNSPacket packet;
+  nsAutoCString host(aHost);
+
+  LOG("resolving %s\n", host.get());
+  // Perform the query
+  rv = packet.FillBuffer(
+      [&](unsigned char response[DNSPacket::MAX_SIZE]) -> int {
+        if (buffer.Length() > DNSPacket::MAX_SIZE) {
+          return -1;
+        }
+        memcpy(response, buffer.BeginReading(), buffer.Length());
+        return buffer.Length();
+      });
+  if (NS_FAILED(rv)) {
+    return rv;
+  }
+
+  return ParseHTTPSRecord(host, packet, aResult, aTTL);
+}
+
 // static
 already_AddRefed<nsINativeDNSResolverOverride>
 NativeDNSResolverOverride::GetSingleton() {