# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/webgpu/ComputePassEncoder.cpp
# Commit: e98d0558c0bf
# Full Hash: e98d0558c0bf2c4e145c07c4c8da145bbde6f05b
# Author: Brad Werth <bwerth@mozilla.com>
# Date: 2024-04-23 21:41:25
# Regressor Bug: 1712963
# File Overlap Count: 3
# Description:
#   Bug 1712963: Simplify mValid handling in some WebGPU classes. r=webgpu-reviewers,nical
#   
#   Primarily this standardizes ComputePassEncoder, RenderBundleEncoder and
#   RenderPassEncoder on the "if (!mValid)" pattern for early exits for ffi
#   functions. It also attempts to make each class have at most two ways to
# ==============================================================================

diff -r d1cde4aa5f35 -r e98d0558c0bf dom/webgpu/ComputePassEncoder.cpp
--- a/dom/webgpu/ComputePassEncoder.cpp	Tue Apr 23 15:21:21 2024 +0000
+++ b/dom/webgpu/ComputePassEncoder.cpp	Tue Apr 23 15:28:22 2024 +0000
@@ -38,65 +38,73 @@
     CommandEncoder* const aParent, const dom::GPUComputePassDescriptor& aDesc)
     : ChildOf(aParent), mPass(BeginComputePass(aParent->mId, aDesc)) {}
 
-ComputePassEncoder::~ComputePassEncoder() {
+ComputePassEncoder::~ComputePassEncoder() { Cleanup(); }
+
+void ComputePassEncoder::Cleanup() {
   if (mValid) {
-    mValid = false;
+    End();
   }
 }
 
 void ComputePassEncoder::SetBindGroup(
     uint32_t aSlot, const BindGroup& aBindGroup,
     const dom::Sequence<uint32_t>& aDynamicOffsets) {
-  if (mValid) {
-    mUsedBindGroups.AppendElement(&aBindGroup);
-    ffi::wgpu_recorded_compute_pass_set_bind_group(
-        mPass.get(), aSlot, aBindGroup.mId, aDynamicOffsets.Elements(),
-        aDynamicOffsets.Length());
+  if (!mValid) {
+    return;
   }
+  mUsedBindGroups.AppendElement(&aBindGroup);
+  ffi::wgpu_recorded_compute_pass_set_bind_group(
+      mPass.get(), aSlot, aBindGroup.mId, aDynamicOffsets.Elements(),
+      aDynamicOffsets.Length());
 }
 
 void ComputePassEncoder::SetPipeline(const ComputePipeline& aPipeline) {
-  if (mValid) {
-    mUsedPipelines.AppendElement(&aPipeline);
-    ffi::wgpu_recorded_compute_pass_set_pipeline(mPass.get(), aPipeline.mId);
+  if (!mValid) {
+    return;
   }
+  mUsedPipelines.AppendElement(&aPipeline);
+  ffi::wgpu_recorded_compute_pass_set_pipeline(mPass.get(), aPipeline.mId);
 }
 
 void ComputePassEncoder::DispatchWorkgroups(uint32_t workgroupCountX,
                                             uint32_t workgroupCountY,
                                             uint32_t workgroupCountZ) {
-  if (mValid) {
-    ffi::wgpu_recorded_compute_pass_dispatch_workgroups(
-        mPass.get(), workgroupCountX, workgroupCountY, workgroupCountZ);
+  if (!mValid) {
+    return;
   }
+  ffi::wgpu_recorded_compute_pass_dispatch_workgroups(
+      mPass.get(), workgroupCountX, workgroupCountY, workgroupCountZ);
 }
 
 void ComputePassEncoder::DispatchWorkgroupsIndirect(
     const Buffer& aIndirectBuffer, uint64_t aIndirectOffset) {
-  if (mValid) {
-    ffi::wgpu_recorded_compute_pass_dispatch_workgroups_indirect(
-        mPass.get(), aIndirectBuffer.mId, aIndirectOffset);
+  if (!mValid) {
+    return;
   }
+  ffi::wgpu_recorded_compute_pass_dispatch_workgroups_indirect(
+      mPass.get(), aIndirectBuffer.mId, aIndirectOffset);
 }
 
 void ComputePassEncoder::PushDebugGroup(const nsAString& aString) {
-  if (mValid) {
-    const NS_ConvertUTF16toUTF8 utf8(aString);
-    ffi::wgpu_recorded_compute_pass_push_debug_group(mPass.get(), utf8.get(),
-                                                     0);
+  if (!mValid) {
+    return;
   }
+  const NS_ConvertUTF16toUTF8 utf8(aString);
+  ffi::wgpu_recorded_compute_pass_push_debug_group(mPass.get(), utf8.get(), 0);
 }
 void ComputePassEncoder::PopDebugGroup() {
-  if (mValid) {
-    ffi::wgpu_recorded_compute_pass_pop_debug_group(mPass.get());
+  if (!mValid) {
+    return;
   }
+  ffi::wgpu_recorded_compute_pass_pop_debug_group(mPass.get());
 }
 void ComputePassEncoder::InsertDebugMarker(const nsAString& aString) {
-  if (mValid) {
-    const NS_ConvertUTF16toUTF8 utf8(aString);
-    ffi::wgpu_recorded_compute_pass_insert_debug_marker(mPass.get(), utf8.get(),
-                                                        0);
+  if (!mValid) {
+    return;
   }
+  const NS_ConvertUTF16toUTF8 utf8(aString);
+  ffi::wgpu_recorded_compute_pass_insert_debug_marker(mPass.get(), utf8.get(),
+                                                      0);
 }
 
 void ComputePassEncoder::End() {