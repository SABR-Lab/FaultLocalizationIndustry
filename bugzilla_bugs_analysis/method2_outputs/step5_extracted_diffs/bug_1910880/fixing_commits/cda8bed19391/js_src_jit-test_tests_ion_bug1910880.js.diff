# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: js/src/jit-test/tests/ion/bug1910880.js
# Commit: cda8bed19391
# Full Hash: cda8bed193914e4e6bedf875aecd9abbcc74606e
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2024-08-02 15:37:12
# Description:
#   Bug 1910880 - Use a real JIT exit frame for Wasm JitEntry stub. r=rhunt
#   
#   JS JIT callers can call Wasm code either directly from Ion or through the JitEntry stub.
#   In the JitEntry case, we didn't have a real JS JIT exit frame. To make JS frame iteration
#   still work in this case, a special `JSJitToWasm` frame type was used to transition from Wasm
# ==============================================================================

diff -r 9b92adc2e91f -r cda8bed19391 js/src/jit-test/tests/ion/bug1910880.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/js/src/jit-test/tests/ion/bug1910880.js	Fri Aug 02 07:14:08 2024 +0000
@@ -0,0 +1,38 @@
+// |jit-test| --fast-warmup; skip-if: !wasmIsSupported()
+
+gczeal(2);
+
+function wasmEvalText(str) {
+    var bin = wasmTextToBinary(str);
+    var m = new WebAssembly.Module(bin);
+    return new WebAssembly.Instance(m);
+}
+function test() {
+    var instance = wasmEvalText(`
+        (module (type $a (array (mut i32)))
+        (func (export "createDefault") (param i32) (result eqref)
+            local.get 0
+            array.new_default $a
+        )
+        )
+    `);
+    var createDefault = instance.exports.createDefault;
+
+    var g = newGlobal({newCompartment: true});
+    g.debuggeeGlobal = this;
+    g.eval("(" + function () {
+        var dbg = new Debugger(debuggeeGlobal);
+        dbg.onExceptionUnwind = function () {
+            throw new Error("x");
+        };
+    } + ")();");
+
+    for (var i = 0; i < 8; i++) {
+        try {
+            createDefault(-1);
+        } catch (e) {
+        }
+    }
+}
+test();
+quit(0); // Ensure exit code is 0, not 3.