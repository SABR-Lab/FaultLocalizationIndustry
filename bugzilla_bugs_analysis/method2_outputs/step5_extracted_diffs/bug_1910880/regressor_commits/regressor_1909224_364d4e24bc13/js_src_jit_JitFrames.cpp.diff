# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/jit/JitFrames.cpp
# Commit: 364d4e24bc13
# Full Hash: 364d4e24bc13eafbb893adf6381a6cbb862d405f
# Author: Jan de Mooij <jdemooij@mozilla.com>
# Date: 2024-07-29 20:43:57
# Regressor Bug: 1909224
# File Overlap Count: 2
# Description:
#   Bug 1909224 part 3 - Remove checks for FailInstanceReg on JIT => Wasm call path. r=rhunt
#   
#   Because we now unwind JS JIT frames after unwinding Wasm frames, we no longer
#   return to the JIT => Wasm entry code from the exception handler.
#   
# ==============================================================================

diff -r 6eb32b942a04 -r 364d4e24bc13 js/src/jit/JitFrames.cpp
--- a/js/src/jit/JitFrames.cpp	Mon Jul 29 13:14:47 2024 +0000
+++ b/js/src/jit/JitFrames.cpp	Mon Jul 29 13:14:48 2024 +0000
@@ -667,7 +667,7 @@
 static JitFrameLayout* GetLastProfilingFrame(ResumeFromException* rfe) {
   switch (rfe->kind) {
     case ExceptionResumeKind::EntryFrame:
-    case ExceptionResumeKind::Wasm:
+    case ExceptionResumeKind::WasmInterpEntry:
     case ExceptionResumeKind::WasmCatch:
       return nullptr;
 
@@ -851,13 +851,13 @@
         iter.asJSJit().fp() + CommonFrameLayout::offsetOfReturnAddress();
   } else {
     MOZ_ASSERT(iter.isWasm());
-    // In case of no handler, exit wasm via ret().
-    // FailInstanceReg signals to the interpreter entry stub to do a failure
-    // return.
-    rfe->kind = ExceptionResumeKind::Wasm;
+    // In case of no handler, exit wasm via ret(). The exception handling
+    // trampoline will return InterpFailInstanceReg in InstanceReg to signal
+    // to the interpreter entry stub to do a failure return.
+    rfe->kind = ExceptionResumeKind::WasmInterpEntry;
     rfe->framePointer = (uint8_t*)iter.asWasm().unwoundCallerFP();
     rfe->stackPointer = (uint8_t*)iter.asWasm().unwoundAddressOfReturnAddress();
-    rfe->instance = (wasm::Instance*)wasm::FailInstanceReg;
+    rfe->instance = nullptr;
     rfe->target = nullptr;
   }
 }