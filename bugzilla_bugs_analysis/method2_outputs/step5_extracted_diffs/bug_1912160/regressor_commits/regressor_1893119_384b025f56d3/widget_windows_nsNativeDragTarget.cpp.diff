# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/nsNativeDragTarget.cpp
# Commit: 384b025f56d3
# Full Hash: 384b025f56d3f87e045ecede6b1a16b71c0b5d4f
# Author: David P <daparks@mozilla.com>
# Date: 2024-07-04 16:09:52
# Regressor Bug: 1893119
# File Overlap Count: 1
# Description:
#   Bug 1893119: Part 21 - Separate nsIDragService and nsIDragSession implementations r=gstoll,geckoview-reviewers,rkraesig,win-reviewers,m_kato
#   
#   Split the class inheritance trees for nsIDragService and nsIDragSession.
#   Remember that, before the start of this patch series, the inheritance
#   diagram was:
# ==============================================================================

diff -r beeda5ef3712 -r 384b025f56d3 widget/windows/nsNativeDragTarget.cpp
--- a/widget/windows/nsNativeDragTarget.cpp	Thu Jul 04 07:48:11 2024 +0000
+++ b/widget/windows/nsNativeDragTarget.cpp	Thu Jul 04 07:48:11 2024 +0000
@@ -16,6 +16,7 @@
 #include "nsClipboard.h"
 #include "KeyboardLayout.h"
 
+#include "mozilla/dom/MouseEventBinding.h"
 #include "mozilla/MouseEvents.h"
 
 using namespace mozilla;
@@ -152,8 +153,13 @@
   ModifierKeyState modifierKeyState;
   modifierKeyState.InitInputEvent(event);
 
-  event.mInputSource =
-      static_cast<nsBaseDragService*>(mDragService.get())->GetInputSource();
+  nsDragSession* currSession =
+      static_cast<nsDragSession*>(mDragService->GetCurrentSession(mWidget));
+  if (currSession) {
+    event.mInputSource = currSession->GetInputSource();
+  } else {
+    event.mInputSource = dom::MouseEvent_Binding::MOZ_SOURCE_MOUSE;
+  }
 
   mWidget->DispatchInputEvent(&event);
 }
@@ -426,14 +432,12 @@
     return S_OK;  // DragCancel() was called.
   }
 
-  // Let the win drag service know whether this session experienced
+  // Let the win drag session know whether it experienced
   // a drop event within the application. Drop will not oocur if the
   // drop landed outside the app. (used in tab tear off, bug 455884)
-  RefPtr<nsDragService> winDragService =
-      static_cast<nsDragService*>(mDragService.get());
-  winDragService->SetDroppedLocal();
+  currentDragSession->SetDroppedLocal();
 
-  // tell the drag service we're done with the session
+  // Tell the drag session we're done with it.
   // Use GetMessagePos to get the position of the mouse at the last message
   // seen by the event loop. (Bug 489729)
   DWORD pos = ::GetMessagePos();
