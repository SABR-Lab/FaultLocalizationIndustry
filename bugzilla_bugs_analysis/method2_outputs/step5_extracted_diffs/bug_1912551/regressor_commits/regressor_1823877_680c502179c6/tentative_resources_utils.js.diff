# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: tentative/resources/utils.js
# Commit: 680c502179c6
# Full Hash: 680c502179c6a98e8e6960fbab016d3aea44ff4c
# Author: Andreas Farre <farre@mozilla.com>
# Date: 2023-05-10 21:37:01
# Regressor Bug: 1823877
# File Overlap Count: 1
# Description:
#   Bug 1823877 - Part 1: Filter opaque results from fetch() in the parent for ORB. r=sefeng,smaug,necko-reviewers,edenchuang,valentin
#   
#   We make sure to not send any data to the content process in case of
#   fetching an opaque resource. This is way to remain more web
#   compatible, but is also in conflict with the ORB specification.
# ==============================================================================

diff -r 8295c1c7bfa0 -r 680c502179c6 testing/web-platform/mozilla/tests/fetch/orb/tentative/resources/utils.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/testing/web-platform/mozilla/tests/fetch/orb/tentative/resources/utils.js	Wed May 10 14:35:52 2023 +0000
@@ -0,0 +1,21 @@
+function promise_internal_response_is_filtered(fetchPromise, message) {
+  return promise_test(async () => {
+    const response = await fetchPromise;
+
+    // A parent filtered opaque response is defined here as a response that isn't just an
+    // opaque response, but also where the internal response has been made unavailable.
+    // `Response.cloneUnfiltered` is used to inspect the state of the internal response,
+    // which is exactly what we want to be missing in this case.
+    const unfiltered = SpecialPowers.wrap(response).cloneUnfiltered();
+    assert_equals(
+      await SpecialPowers.unwrap(unfiltered).text(),
+      "",
+      "The internal response should be empty"
+    );
+    assert_equals(
+      Array.from(await SpecialPowers.unwrap(unfiltered).headers).length,
+      0,
+      "The internal response should have no headers"
+    );
+  }, message);
+}