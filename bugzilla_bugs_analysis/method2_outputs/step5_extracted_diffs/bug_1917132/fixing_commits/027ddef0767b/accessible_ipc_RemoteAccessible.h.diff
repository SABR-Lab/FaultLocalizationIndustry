# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: accessible/ipc/RemoteAccessible.h
# Commit: 027ddef0767b
# Full Hash: 027ddef0767b43fa1f76ea7e56c1e04c64c27a88
# Author: James Teh <jteh@mozilla.com>
# Date: 2024-09-06 21:37:32
# Description:
#   Bug 1917132: When clearing a RemoteAccessible's parent, set its cached IndexInParent to -1. r=nlapre
#   
#   We set the cached IndexInParent to -1 in RemoveChild, among other places.
#   However, when a RemoteAccessible is moved, we clear its children array without calling RemoveChild (in DocAccessibleParent::ShutdownOrPrepareForMove).
#   We already call SetParent(nullptr) on the children to clear the parent, so set the cached IndexInParent to -1 in SetParent when the supplied new parent is null.
# ==============================================================================

diff -r 94c97b3688bc -r 027ddef0767b accessible/ipc/RemoteAccessible.h
--- a/accessible/ipc/RemoteAccessible.h	Fri Sep 06 09:39:03 2024 +0000
+++ b/accessible/ipc/RemoteAccessible.h	Fri Sep 06 09:54:46 2024 +0000
@@ -63,7 +63,7 @@
   RemoteAccessible* RemotePrevSibling() const {
     if (IsDoc()) {
       // The normal code path doesn't work for documents because the parent
-      // might be a local OuterDoc, but IndexInParent() will return 1.
+      // might be a local OuterDoc, but IndexInParent() will return 0.
       // A document is always a single child of an OuterDoc anyway.
       return nullptr;
     }
@@ -71,12 +71,13 @@
     if (idx == -1) {
       return nullptr;  // No parent.
     }
+    MOZ_ASSERT(RemoteParent());
     return idx > 0 ? RemoteParent()->mChildren[idx - 1] : nullptr;
   }
   RemoteAccessible* RemoteNextSibling() const {
     if (IsDoc()) {
       // The normal code path doesn't work for documents because the parent
-      // might be a local OuterDoc, but IndexInParent() will return 1.
+      // might be a local OuterDoc, but IndexInParent() will return 0.
       // A document is always a single child of an OuterDoc anyway.
       return nullptr;
     }
@@ -86,6 +87,7 @@
     }
     MOZ_ASSERT(idx >= 0);
     size_t newIdx = idx + 1;
+    MOZ_ASSERT(RemoteParent());
     return newIdx < RemoteParent()->mChildren.Length()
                ? RemoteParent()->mChildren[newIdx]
                : nullptr;
@@ -107,7 +109,11 @@
     return RemotePrevSibling();
   }
 
-  virtual int32_t IndexInParent() const override { return mIndexInParent; }
+  virtual int32_t IndexInParent() const override {
+    MOZ_ASSERT(mParent || mIndexInParent == -1,
+               "IndexInParent should be -1 if no parent");
+    return mIndexInParent;
+  }
 
   virtual uint32_t EmbeddedChildCount() override;
   virtual int32_t IndexOfEmbeddedChild(Accessible* aChild) override;