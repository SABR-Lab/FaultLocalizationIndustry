# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsWaylandDisplay.cpp
# Commit: 6a13d76d61b8
# Full Hash: 6a13d76d61b876a3e4f22a42fecb27de5c106121
# Author: stransky <stransky@redhat.com>
# Date: 2024-09-13 04:28:43
# Description:
#   Bug 1917558 [Wayland] Explicitly request wl-pointer v.3 interface r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D221617
# ==============================================================================

diff -r a8e3d92b384c -r 6a13d76d61b8 widget/gtk/nsWaylandDisplay.cpp
--- a/widget/gtk/nsWaylandDisplay.cpp	Thu Sep 12 11:49:58 2024 +0000
+++ b/widget/gtk/nsWaylandDisplay.cpp	Thu Sep 12 12:15:42 2024 +0000
@@ -144,7 +144,8 @@
 };
 
 void nsWaylandDisplay::SetPointer(wl_pointer* aPointer) {
-  if (!mPointerGestures) {
+  if (!mPointerGestures || wl_proxy_get_version((struct wl_proxy*)aPointer) <
+                               WL_POINTER_RELEASE_SINCE_VERSION) {
     return;
   }
   MOZ_DIAGNOSTIC_ASSERT(!mPointer);
@@ -185,8 +186,14 @@
   }
 }
 
+static void seat_handle_name(void* data, struct wl_seat* seat,
+                             const char* name) {
+  /* We don't care about the name. */
+}
+
 static const struct wl_seat_listener seat_listener = {
     seat_handle_capabilities,
+    seat_handle_name,
 };
 
 void nsWaylandDisplay::SetSeat(wl_seat* aSeat, int aSeatId) {
@@ -322,10 +329,9 @@
         registry, id, &zwp_pointer_constraints_v1_interface, 1);
     display->SetPointerConstraints(pointer_constraints);
   } else if (iface.EqualsLiteral("wl_compositor")) {
-    // Requested wl_compositor version 4 as we need
-    // wl_surface_damage_buffer().
     auto* compositor = WaylandRegistryBind<wl_compositor>(
-        registry, id, &wl_compositor_interface, 4);
+        registry, id, &wl_compositor_interface,
+        WL_SURFACE_DAMAGE_BUFFER_SINCE_VERSION);
     display->SetCompositor(compositor);
   } else if (iface.EqualsLiteral("wl_subcompositor")) {
     auto* subcompositor = WaylandRegistryBind<wl_subcompositor>(
@@ -349,9 +355,11 @@
             registry, id, &xdg_dbus_annotation_manager_v1_interface, 1);
     display->SetXdgDbusAnnotationManager(annotationManager);
   } else if (iface.EqualsLiteral("wl_seat")) {
-    auto* seat =
-        WaylandRegistryBind<wl_seat>(registry, id, &wl_seat_interface, 1);
-    display->SetSeat(seat, id);
+    auto* seat = WaylandRegistryBind<wl_seat>(registry, id, &wl_seat_interface,
+                                              WL_POINTER_RELEASE_SINCE_VERSION);
+    if (seat) {
+      display->SetSeat(seat, id);
+    }
   } else if (iface.EqualsLiteral("wp_fractional_scale_manager_v1")) {
     auto* manager = WaylandRegistryBind<wp_fractional_scale_manager_v1>(
         registry, id, &wp_fractional_scale_manager_v1_interface, 1);
@@ -360,10 +368,12 @@
              iface.EqualsLiteral("zwp_primary_selection_device_manager_v1")) {
     display->EnablePrimarySelection();
   } else if (iface.EqualsLiteral("zwp_pointer_gestures_v1")) {
-    // HOLD is introduced in version 3
     auto* gestures = WaylandRegistryBind<zwp_pointer_gestures_v1>(
-        registry, id, &zwp_pointer_gestures_v1_interface, 3);
-    display->SetPointerGestures(gestures);
+        registry, id, &zwp_pointer_gestures_v1_interface,
+        ZWP_POINTER_GESTURES_V1_GET_HOLD_GESTURE_SINCE_VERSION);
+    if (gestures) {
+      display->SetPointerGestures(gestures);
+    }
   }
 }
 
