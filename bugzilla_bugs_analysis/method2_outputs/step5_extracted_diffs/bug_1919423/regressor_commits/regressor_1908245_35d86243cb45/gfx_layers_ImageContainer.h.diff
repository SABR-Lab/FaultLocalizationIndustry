# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: gfx/layers/ImageContainer.h
# Commit: 35d86243cb45
# Full Hash: 35d86243cb45f7e02dd6ec0eea04cd62c2a70196
# Author: Andrew Osmond <aosmond@mozilla.com>
# Date: 2024-09-16 09:14:26
# Regressor Bug: 1908245
# File Overlap Count: 1
# Description:
#   Bug 1908245 - Add support for missing requestVideoFrameCallback parameters. r=media-playback-reviewers,webidl,padenot,saschanaz
#   
#   This patch adds support for exposing the capture time, receive time,
#   processing duration and RTP timestamp parameters on the callback for
#   rVFC for WebRTC related elements.
# ==============================================================================

diff -r 7d143d92bf2a -r 35d86243cb45 gfx/layers/ImageContainer.h
--- a/gfx/layers/ImageContainer.h	Sun Sep 15 20:03:40 2024 +0000
+++ b/gfx/layers/ImageContainer.h	Sun Sep 15 21:49:38 2024 +0000
@@ -31,6 +31,7 @@
 #include "mozilla/EnumeratedArray.h"
 #include "mozilla/UniquePtr.h"
 #include "nsTHashMap.h"
+#include "TimeUnits.h"
 
 #ifdef XP_WIN
 struct ID3D10Texture2D;
@@ -328,8 +329,11 @@
 
   ~ImageContainer();
 
-  typedef ContainerFrameID FrameID;
-  typedef ContainerProducerID ProducerID;
+  using FrameID = ContainerFrameID;
+  using ProducerID = ContainerProducerID;
+  using CaptureTime = ContainerCaptureTime;
+  using ReceiveTime = ContainerReceiveTime;
+  using RtpTimestamp = ContainerRtpTimestamp;
 
   RefPtr<PlanarYCbCrImage> CreatePlanarYCbCrImage();
 
@@ -337,17 +341,32 @@
   RefPtr<SharedRGBImage> CreateSharedRGBImage();
 
   struct NonOwningImage {
-    explicit NonOwningImage(Image* aImage = nullptr,
-                            TimeStamp aTimeStamp = TimeStamp(),
-                            FrameID aFrameID = 0, ProducerID aProducerID = 0)
+    explicit NonOwningImage(
+        Image* aImage = nullptr, TimeStamp aTimeStamp = TimeStamp(),
+        FrameID aFrameID = 0, ProducerID aProducerID = 0,
+        media::TimeUnit aProcessingDuration = media::TimeUnit::Invalid(),
+        media::TimeUnit aMediaTime = media::TimeUnit::Invalid(),
+        const CaptureTime& aWebrtcCaptureTime = AsVariant(Nothing()),
+        const ReceiveTime& aWebrtcReceiveTime = Nothing(),
+        const RtpTimestamp& aRtpTimestamp = Nothing())
         : mImage(aImage),
           mTimeStamp(aTimeStamp),
           mFrameID(aFrameID),
-          mProducerID(aProducerID) {}
+          mProducerID(aProducerID),
+          mProcessingDuration(aProcessingDuration),
+          mMediaTime(aMediaTime),
+          mWebrtcCaptureTime(aWebrtcCaptureTime),
+          mWebrtcReceiveTime(aWebrtcReceiveTime),
+          mRtpTimestamp(aRtpTimestamp) {}
     Image* mImage;
     TimeStamp mTimeStamp;
     FrameID mFrameID;
     ProducerID mProducerID;
+    media::TimeUnit mProcessingDuration = media::TimeUnit::Invalid();
+    media::TimeUnit mMediaTime = media::TimeUnit::Invalid();
+    CaptureTime mWebrtcCaptureTime = AsVariant(Nothing());
+    ReceiveTime mWebrtcReceiveTime;
+    RtpTimestamp mRtpTimestamp;
   };
   /**
    * Set aImages as the list of timestamped to display. The Images must have
@@ -440,12 +459,16 @@
   bool HasCurrentImage();
 
   struct OwningImage {
-    OwningImage() : mFrameID(0), mProducerID(0), mComposited(false) {}
     RefPtr<Image> mImage;
     TimeStamp mTimeStamp;
-    FrameID mFrameID;
-    ProducerID mProducerID;
-    bool mComposited;
+    media::TimeUnit mProcessingDuration = media::TimeUnit::Invalid();
+    media::TimeUnit mMediaTime = media::TimeUnit::Invalid();
+    CaptureTime mWebrtcCaptureTime = AsVariant(Nothing());
+    ReceiveTime mWebrtcReceiveTime;
+    RtpTimestamp mRtpTimestamp;
+    FrameID mFrameID = 0;
+    ProducerID mProducerID = 0;
+    bool mComposited = false;
   };
   /**
    * Copy the current Image list to aImages.
@@ -679,7 +702,8 @@
     return mImages.IsEmpty() ? nullptr : mImages[0].mImage.get();
   }
 
-  Image* GetImage(TimeStamp aTimeStamp) const {
+  const ImageContainer::OwningImage* GetOwningImage(
+      TimeStamp aTimeStamp) const {
     if (mImages.IsEmpty()) {
       return nullptr;
     }
@@ -692,7 +716,14 @@
       ++chosenIndex;
     }
 
-    return mImages[chosenIndex].mImage.get();
+    return &mImages[chosenIndex];
+  }
+
+  Image* GetImage(TimeStamp aTimeStamp) const {
+    if (const auto* owningImage = GetOwningImage(aTimeStamp)) {
+      return owningImage->mImage.get();
+    }
+    return nullptr;
   }
 
  private: