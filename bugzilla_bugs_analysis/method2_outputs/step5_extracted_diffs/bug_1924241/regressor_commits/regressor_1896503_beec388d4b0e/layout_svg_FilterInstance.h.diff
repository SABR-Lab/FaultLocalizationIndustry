# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/svg/FilterInstance.h
# Commit: beec388d4b0e
# Full Hash: beec388d4b0e6a50ac243ed86c0e3f1f48cbe744
# Author: Ashley Hale <ahale@mozilla.com>
# Date: 2024-06-25 09:36:02
# Regressor Bug: 1896503
# File Overlap Count: 1
# Description:
#   Bug 1896503 - Implement FilterInstance code to send SVG filter graph to WebRender r=mstange,gw
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D174208
# ==============================================================================

diff -r 2147e0051e23 -r beec388d4b0e layout/svg/FilterInstance.h
--- a/layout/svg/FilterInstance.h	Mon Jun 24 23:40:38 2024 +0000
+++ b/layout/svg/FilterInstance.h	Mon Jun 24 23:45:05 2024 +0000
@@ -131,15 +131,28 @@
 
   /**
    * Try to build WebRender filters for a frame if the filters applied to it are
-   * supported. aInitialized is set to true if the filter has been initialized
-   * and false otherwise (e.g. a bad url). If aInitialized is false the filter
-   * the filter contents should not be drawn.
+   * supported, returns a status that indicates which code path will handle the
+   * filters on this frame, or if we must fall back to blob image.
    */
-  static bool BuildWebRenderFilters(
+  static WrFiltersStatus BuildWebRenderFilters(
       nsIFrame* aFilteredFrame,
       mozilla::Span<const mozilla::StyleFilter> aFilters,
       StyleFilterType aStyleFilterType, WrFiltersHolder& aWrFilters,
-      bool& aInitialized);
+      const nsPoint& aOffsetForSVGFilters);
+
+  /**
+   * Try to build WebRender SVG filter graph for a frame based on SVG and CSS
+   * filters.  If given an unreasonably costly set of filters this can reject
+   * the entire filter graph (a behavior permitted by SVG spec).
+   *
+   * See WrFiltersStatus for possible outcomes.
+   * Prefs such as gfx.webrender.svg-filter-effects affect this.
+   */
+  static WrFiltersStatus BuildWebRenderSVGFiltersImpl(
+      nsIFrame* aFilteredFrame,
+      mozilla::Span<const mozilla::StyleFilter> aFilters,
+      StyleFilterType aStyleFilterType, WrFiltersHolder& aWrFilters,
+      const nsPoint& aOffsetForSVGFilters);
 
  private:
   /**
@@ -166,6 +179,8 @@
    *   ink overflow rect for the target element.
    * @param aOverrideBBox [optional] Use a different SVG bbox for the target
    *   element. Must be non-null if aTargetFrame is null.
+   * @param aFilterSpaceBoundsNotSnapped [optional] The calculated bbox in
+   *   userspace can be returend in the provided outparam.
    */
   FilterInstance(
       nsIFrame* aTargetFrame, nsIContent* aTargetContent,
@@ -177,13 +192,13 @@
       const nsRegion* aPostFilterDirtyRegion = nullptr,
       const nsRegion* aPreFilterDirtyRegion = nullptr,
       const nsRect* aPreFilterInkOverflowRectOverride = nullptr,
-      const gfxRect* aOverrideBBox = nullptr);
+      const gfxRect* aOverrideBBox = nullptr,
+      gfxRect* aFilterSpaceBoundsNotSnapped = nullptr);
 
-  static bool BuildWebRenderFiltersImpl(
+  static WrFiltersStatus BuildWebRenderFiltersImpl(
       nsIFrame* aFilteredFrame,
       mozilla::Span<const mozilla::StyleFilter> aFilters,
-      StyleFilterType aStyleFilterType, WrFiltersHolder& aWrFilters,
-      bool& aInitialized);
+      StyleFilterType aStyleFilterType, WrFiltersHolder& aWrFilters);
 
   /**
    * Returns true if the filter instance was created successfully.
@@ -367,6 +382,11 @@
   nsIntRect mTargetBBoxInFilterSpace;
 
   /**
+   * The SVG filter element rect, in filter space, may be non-integer.
+   */
+  gfxRect mFilterSpaceBoundsNotSnapped;
+
+  /**
    * Transform rects between filter space and frame space in CSS pixels.
    */
   gfxMatrix mFilterSpaceToFrameSpaceInCSSPxTransform;