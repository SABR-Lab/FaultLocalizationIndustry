# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/gc/Allocator.cpp
# Commit: c63801497940
# Full Hash: c63801497940b667d2c47373aee95312502a2acb
# Author: Jon Coppeard <jcoppeard@mozilla.com>
# Date: 2024-10-15 16:18:18
# Regressor Bug: 1924504
# File Overlap Count: 1
# Description:
#   Bug 1924504 - Make GCRuntime::getOrAllocChunk leave chunk on the empty chunks list r=sfink
#   
#   The problem is that we can fail to allocate an arena in a new chunk for various
#   reason, but currently we eagerly move the chunk from the empty to the available
#   chunks list when getting an empty chunk and this causes an assertion failure
# ==============================================================================

diff -r 7a7ea826905f -r c63801497940 js/src/gc/Allocator.cpp
--- a/js/src/gc/Allocator.cpp	Tue Oct 15 07:07:54 2024 +0000
+++ b/js/src/gc/Allocator.cpp	Tue Oct 15 07:33:02 2024 +0000
@@ -549,9 +549,16 @@
 
 // ///////////  System -> ArenaChunk Allocator  ////////////////////////////////
 
+ArenaChunk* GCRuntime::takeOrAllocChunk(AutoLockGCBgAlloc& lock) {
+  ArenaChunk* chunk = getOrAllocChunk(lock);
+  emptyChunks(lock).remove(chunk);
+  return chunk;
+}
+
 ArenaChunk* GCRuntime::getOrAllocChunk(AutoLockGCBgAlloc& lock) {
-  ArenaChunk* chunk = emptyChunks(lock).pop();
-  if (chunk) {
+  ArenaChunk* chunk;
+  if (!emptyChunks(lock).empty()) {
+    chunk = emptyChunks(lock).head();
     // Reinitialize ChunkBase; arenas are all free and may or may not be
     // committed.
     SetMemCheckKind(chunk, sizeof(ChunkBase), MemCheckKind::MakeUndefined);
@@ -564,7 +571,8 @@
     }
 
     chunk = ArenaChunk::emplace(ptr, this, /* allMemoryCommitted = */ true);
-    MOZ_ASSERT(chunk->info.numArenasFree == ArenasPerChunk);
+    MOZ_ASSERT(chunk->unused());
+    emptyChunks(lock).push(chunk);
   }
 
   if (wantBackgroundAllocation(lock)) {
@@ -600,12 +608,9 @@
 #ifdef DEBUG
   chunk->verify();
   MOZ_ASSERT(chunk->unused());
-  MOZ_ASSERT(!fullChunks(lock).contains(chunk));
-  MOZ_ASSERT(!availableChunks(lock).contains(chunk));
+  MOZ_ASSERT(emptyChunks(lock).contains(chunk));
 #endif
 
-  availableChunks(lock).push(chunk);
-
   return chunk;
 }
 
@@ -675,6 +680,7 @@
     chunk->initAsCommitted();
   }
 
+  MOZ_ASSERT(chunk->unused());
   chunk->verify();
 
   return chunk;