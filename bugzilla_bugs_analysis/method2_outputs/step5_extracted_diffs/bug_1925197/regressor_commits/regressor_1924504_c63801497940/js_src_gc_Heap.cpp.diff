# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/gc/Heap.cpp
# Commit: c63801497940
# Full Hash: c63801497940b667d2c47373aee95312502a2acb
# Author: Jon Coppeard <jcoppeard@mozilla.com>
# Date: 2024-10-15 16:18:18
# Regressor Bug: 1924504
# File Overlap Count: 1
# Description:
#   Bug 1924504 - Make GCRuntime::getOrAllocChunk leave chunk on the empty chunks list r=sfink
#   
#   The problem is that we can fail to allocate an arena in a new chunk for various
#   reason, but currently we eagerly move the chunk from the empty to the available
#   chunks list when getting an empty chunk and this causes an assertion failure
# ==============================================================================

diff -r 7a7ea826905f -r c63801497940 js/src/gc/Heap.cpp
--- a/js/src/gc/Heap.cpp	Tue Oct 15 07:07:54 2024 +0000
+++ b/js/src/gc/Heap.cpp	Tue Oct 15 07:33:02 2024 +0000
@@ -442,6 +442,12 @@
 
 void ArenaChunk::updateChunkListAfterAlloc(GCRuntime* gc,
                                            const AutoLockGC& lock) {
+  if (MOZ_UNLIKELY(info.numArenasFree == ArenasPerChunk - 1)) {
+    gc->emptyChunks(lock).remove(this);
+    gc->availableChunks(lock).push(this);
+    return;
+  }
+
   if (MOZ_UNLIKELY(!hasAvailableArenas())) {
     gc->availableChunks(lock).remove(this);
     gc->fullChunks(lock).push(this);