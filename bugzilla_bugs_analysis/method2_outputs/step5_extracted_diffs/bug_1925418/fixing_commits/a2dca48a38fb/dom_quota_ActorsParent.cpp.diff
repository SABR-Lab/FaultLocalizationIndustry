# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/quota/ActorsParent.cpp
# Commit: a2dca48a38fb
# Full Hash: a2dca48a38fbf4ac41d9018d2949d7811e1a675f
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2024-11-19 05:18:08
# Description:
#   Bug 1925418 - Fail GetOrCreateTemporaryOriginDirectory if origin is not initialized; r=dom-storage-reviewers,asuth
#   
#   This is a temporary band-aid fix until the root cause of uninitialized origins
#   after obtaining a client directory lock via OpenClientDirectory is identified.
#   The issue might be caused by a race condition or a clear operation not returning
# ==============================================================================

diff -r 1679e606ce7b -r a2dca48a38fb dom/quota/ActorsParent.cpp
--- a/dom/quota/ActorsParent.cpp	Mon Nov 18 19:20:28 2024 +0000
+++ b/dom/quota/ActorsParent.cpp	Mon Nov 18 19:30:42 2024 +0000
@@ -3253,6 +3253,32 @@
   MOZ_ASSERT(IsTemporaryGroupInitializedInternal(aOriginMetadata));
   MOZ_ASSERT(IsTemporaryOriginInitializedInternal(aOriginMetadata));
 
+  // XXX Temporary band-aid fix until the root cause of uninitialized origins
+  // after obtaining a client directory lock via OpenClientDirectory is
+  // identified.
+  QM_TRY(
+      // Expression.
+      MOZ_TO_RESULT(IsTemporaryOriginInitializedInternal(aOriginMetadata))
+          .mapErr([](const nsresult rv) { return NS_ERROR_NOT_INITIALIZED; }),
+      // Custom return value.
+      QM_PROPAGATE,
+      // Cleanup function.
+      ([this, aOriginMetadata](const nsresult) {
+        MOZ_ALWAYS_SUCCEEDS(mOwningThread->Dispatch(
+            NS_NewRunnableFunction(
+                "QuotaManager::GetOrCreateTemporaryOriginDirectory",
+                [aOriginMetadata]() {
+                  QuotaManager* quotaManager = QuotaManager::Get();
+                  MOZ_ASSERT(quotaManager);
+
+                  OriginMetadataArray originMetadataArray;
+                  originMetadataArray.AppendElement(aOriginMetadata);
+
+                  quotaManager->NoteUninitializedOrigins(originMetadataArray);
+                }),
+            NS_DISPATCH_NORMAL));
+      }));
+
   QM_TRY_UNWRAP(auto directory, GetOriginDirectory(aOriginMetadata));
 
   QM_TRY_INSPECT(const bool& created, EnsureOriginDirectory(*directory));
