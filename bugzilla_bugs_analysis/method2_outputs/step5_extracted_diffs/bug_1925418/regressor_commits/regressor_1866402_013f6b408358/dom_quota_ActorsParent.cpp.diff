# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/quota/ActorsParent.cpp
# Commit: 013f6b408358
# Full Hash: 013f6b4083587bb523626c2cff60b74ac4d05871
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2024-10-15 04:16:11
# Regressor Bug: 1866402
# File Overlap Count: 1
# Description:
#   Bug 1866402 - Further reduce code duplication in QuotaManager::OpenStorageDirectory and QuotaManager::OpenClientDirectory; r=dom-storage-reviewers,jari
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D223710
# ==============================================================================

diff -r 84592335a026 -r 013f6b408358 dom/quota/ActorsParent.cpp
--- a/dom/quota/ActorsParent.cpp	Mon Oct 14 10:06:14 2024 +0000
+++ b/dom/quota/ActorsParent.cpp	Mon Oct 14 10:06:14 2024 +0000
@@ -5163,35 +5163,22 @@
   nsTArray<RefPtr<BoolPromise>> promises;
 
   RefPtr<UniversalDirectoryLock> storageDirectoryLock =
-      CreateDirectoryLockInternal(PersistenceScope::CreateFromNull(),
-                                  OriginScope::FromNull(),
-                                  Nullable<Client::Type>(),
-                                  /* aExclusive */ false);
-
-  if (mStorageInitialized &&
-      !IsDirectoryLockBlockedByUninitStorageOperation(storageDirectoryLock)) {
-    storageDirectoryLock = nullptr;
-  } else {
-    promises.AppendElement(storageDirectoryLock->Acquire());
-  }
+      CreateDirectoryLockForInitialization(
+          *this, PersistenceScope::CreateFromNull(), OriginScope::FromNull(),
+          mStorageInitialized, IsDirectoryLockBlockedByUninitStorageOperation,
+          MakeBackInserter(promises));
 
   RefPtr<UniversalDirectoryLock> temporaryStorageDirectoryLock;
 
   if (aInitializeOrigins &&
       MatchesBestEffortPersistenceScope(aPersistenceScope)) {
-    temporaryStorageDirectoryLock = CreateDirectoryLockInternal(
+    temporaryStorageDirectoryLock = CreateDirectoryLockForInitialization(
+        *this,
         PersistenceScope::CreateFromSet(PERSISTENCE_TYPE_TEMPORARY,
                                         PERSISTENCE_TYPE_DEFAULT),
-        OriginScope::FromNull(), Nullable<Client::Type>(),
-        /* aExclusive */ false);
-
-    if (mTemporaryStorageInitialized &&
-        !IsDirectoryLockBlockedByUninitStorageOperation(
-            temporaryStorageDirectoryLock)) {
-      temporaryStorageDirectoryLock = nullptr;
-    } else {
-      promises.AppendElement(temporaryStorageDirectoryLock->Acquire());
-    }
+        OriginScope::FromNull(), mTemporaryStorageInitialized,
+        IsDirectoryLockBlockedByUninitStorageOperation,
+        MakeBackInserter(promises));
   }
 
   RefPtr<UniversalDirectoryLock> universalDirectoryLock =
@@ -5262,54 +5249,34 @@
   nsTArray<RefPtr<BoolPromise>> promises;
 
   RefPtr<UniversalDirectoryLock> storageDirectoryLock =
-      CreateDirectoryLockInternal(PersistenceScope::CreateFromNull(),
-                                  OriginScope::FromNull(),
-                                  Nullable<Client::Type>(),
-                                  /* aExclusive */ false);
-
-  if (mStorageInitialized &&
-      !IsDirectoryLockBlockedByUninitStorageOperation(storageDirectoryLock)) {
-    storageDirectoryLock = nullptr;
-  } else {
-    promises.AppendElement(storageDirectoryLock->Acquire());
-  }
+      CreateDirectoryLockForInitialization(
+          *this, PersistenceScope::CreateFromNull(), OriginScope::FromNull(),
+          mStorageInitialized, IsDirectoryLockBlockedByUninitStorageOperation,
+          MakeBackInserter(promises));
 
   RefPtr<UniversalDirectoryLock> temporaryStorageDirectoryLock;
 
   if (IsBestEffortPersistenceType(persistenceType)) {
-    temporaryStorageDirectoryLock = CreateDirectoryLockInternal(
+    temporaryStorageDirectoryLock = CreateDirectoryLockForInitialization(
+        *this,
         PersistenceScope::CreateFromSet(PERSISTENCE_TYPE_TEMPORARY,
                                         PERSISTENCE_TYPE_DEFAULT),
-        OriginScope::FromNull(), Nullable<Client::Type>(),
-        /* aExclusive */ false);
-
-    if (mTemporaryStorageInitialized &&
-        !IsDirectoryLockBlockedByUninitStorageOperation(
-            temporaryStorageDirectoryLock)) {
-      temporaryStorageDirectoryLock = nullptr;
-    } else {
-      promises.AppendElement(temporaryStorageDirectoryLock->Acquire());
-    }
-  }
-
-  RefPtr<UniversalDirectoryLock> originDirectoryLock =
-      CreateDirectoryLockInternal(
-          PersistenceScope::CreateFromValue(persistenceType),
-          OriginScope::FromOrigin(aClientMetadata.mOrigin),
-          Nullable<Client::Type>(), /* aExclusive */ false);
+        OriginScope::FromNull(), mTemporaryStorageInitialized,
+        IsDirectoryLockBlockedByUninitStorageOperation,
+        MakeBackInserter(promises));
+  }
 
   const bool originInitialized =
       persistenceType == PERSISTENCE_TYPE_PERSISTENT
           ? IsPersistentOriginInitialized(principalInfo)
           : IsTemporaryOriginInitialized(persistenceType, principalInfo);
 
-  if (originInitialized &&
-      !IsDirectoryLockBlockedByUninitStorageOrUninitOriginsOperation(
-          originDirectoryLock)) {
-    originDirectoryLock = nullptr;
-  } else {
-    promises.AppendElement(originDirectoryLock->Acquire());
-  }
+  RefPtr<UniversalDirectoryLock> originDirectoryLock =
+      CreateDirectoryLockForInitialization(
+          *this, PersistenceScope::CreateFromValue(persistenceType),
+          OriginScope::FromOrigin(aClientMetadata.mOrigin), originInitialized,
+          IsDirectoryLockBlockedByUninitStorageOrUninitOriginsOperation,
+          MakeBackInserter(promises));
 
   RefPtr<ClientDirectoryLock> clientDirectoryLock =
       CreateDirectoryLock(aClientMetadata, /* aExclusive */ false);