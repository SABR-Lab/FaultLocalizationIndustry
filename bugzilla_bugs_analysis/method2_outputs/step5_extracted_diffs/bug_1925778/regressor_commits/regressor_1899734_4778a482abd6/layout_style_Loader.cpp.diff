# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/Loader.cpp
# Commit: 4778a482abd6
# Full Hash: 4778a482abd6ba484aa2d8ec1062700bbfbd3062
# Author: Tooru Fujisawa <arai_a@mac.com>
# Date: 2024-10-02 09:50:09
# Regressor Bug: 1899734
# File Overlap Count: 2
# Description:
#   Bug 1899734 - Part 8: Add performance entry when stylesheet is created from a cache. r=emilio
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D223354
# ==============================================================================

diff -r b59dcea26b32 -r 4778a482abd6 layout/style/Loader.cpp
--- a/layout/style/Loader.cpp	Tue Oct 01 12:17:23 2024 +0000
+++ b/layout/style/Loader.cpp	Tue Oct 01 12:17:24 2024 +0000
@@ -1700,11 +1700,34 @@
   return Completed::No;
 }
 
+void Loader::AddPerformanceEntryForCachedSheet(SheetLoadData& aLoadData) {
+  MOZ_ASSERT(aLoadData.mURI);
+
+  if (!aLoadData.mNetworkMetadata) {
+    return;
+  }
+
+  nsAutoCString name;
+  aLoadData.mURI->GetSpec(name);
+  NS_ConvertUTF8toUTF16 entryName(name);
+
+  auto end = TimeStamp::Now();
+  auto start = aLoadData.mLoadStart;
+  if (start.IsNull()) {
+    start = end;
+  }
+
+  SharedSubResourceCacheUtils::AddPerformanceEntryForCache(
+      entryName, aLoadData.InitiatorTypeString(), aLoadData.mNetworkMetadata,
+      start, end, mDocument);
+}
+
 void Loader::NotifyObservers(SheetLoadData& aData, nsresult aStatus) {
   RecordUseCountersIfNeeded(mDocument, *aData.mSheet);
   if (MaybePutIntoLoadsPerformed(aData) &&
       aData.mShouldEmulateNotificationsForCachedLoad) {
     NotifyObserversForCachedSheet(aData);
+    AddPerformanceEntryForCachedSheet(aData);
   }
 
   RefPtr loadDispatcher = aData.PrepareLoadEventIfNeeded();
@@ -2192,6 +2215,7 @@
       RecordUseCountersIfNeeded(mDocument, *data->mSheet);
       if (MaybePutIntoLoadsPerformed(*data)) {
         NotifyObserversForCachedSheet(*data);
+        AddPerformanceEntryForCachedSheet(*data);
       }
     }
     data->mIntentionallyDropped = true;