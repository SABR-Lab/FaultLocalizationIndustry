# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/Loader.cpp
# Commit: bad0506ecbc0
# Full Hash: bad0506ecbc0f1448e23a4398bf1c2e6aeb3f529
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-09-26 21:26:53
# Regressor Bug: 1899734
# File Overlap Count: 1
# Description:
#   Bug 1921110 - Distinguish rel=preload from early-hints preload. r=arai,firefox-style-system-reviewers,zrhoffman
#   
#   No behavior change right now, but this is needed to fix the initiator in
#   bug 1899734.
#   
# ==============================================================================

diff -r 722852dd8923 -r bad0506ecbc0 layout/style/Loader.cpp
--- a/layout/style/Loader.cpp	Thu Sep 26 15:23:51 2024 +0000
+++ b/layout/style/Loader.cpp	Thu Sep 26 15:33:15 2024 +0000
@@ -150,7 +150,7 @@
       mCORSMode(aLoadData.mSheet->GetCORSMode()),
       mParsingMode(aLoadData.mSheet->ParsingMode()),
       mCompatMode(aLoadData.mCompatMode),
-      mIsLinkRelPreload(aLoadData.IsLinkRelPreload()) {
+      mIsLinkRelPreloadOrEarlyHint(aLoadData.IsLinkRelPreloadOrEarlyHint()) {
   MOZ_COUNT_CTOR(SheetLoadDataHashKey);
   MOZ_ASSERT(mURI);
   MOZ_ASSERT(mPrincipal);
@@ -220,12 +220,11 @@
   // check makes sure that regular loads will never find such a weaker preload
   // and rather start a new, independent load with new, stronger SRI checker
   // set up, so that integrity is ensured.
-  if (mIsLinkRelPreload != aKey.mIsLinkRelPreload) {
+  if (mIsLinkRelPreloadOrEarlyHint != aKey.mIsLinkRelPreloadOrEarlyHint) {
     const auto& linkPreloadMetadata =
-        mIsLinkRelPreload ? mSRIMetadata : aKey.mSRIMetadata;
+        mIsLinkRelPreloadOrEarlyHint ? mSRIMetadata : aKey.mSRIMetadata;
     const auto& consumerPreloadMetadata =
-        mIsLinkRelPreload ? aKey.mSRIMetadata : mSRIMetadata;
-
+        mIsLinkRelPreloadOrEarlyHint ? aKey.mSRIMetadata : mSRIMetadata;
     if (!consumerPreloadMetadata.CanTrustBeDelegatedTo(linkPreloadMetadata)) {
       LOG((" > Preload SRI metadata mismatch\n"));
       return false;
@@ -458,7 +457,7 @@
   if (!node) {
     return nullptr;
   }
-  MOZ_ASSERT(!RootLoadData().IsLinkRelPreload(),
+  MOZ_ASSERT(!RootLoadData().IsLinkRelPreloadOrEarlyHint(),
              "rel=preload handled elsewhere");
   RefPtr<AsyncEventDispatcher> dispatcher;
   if (BlocksLoadEvent()) {
@@ -1370,9 +1369,9 @@
     if (aSheetState == SheetState::Pending) {
       ++mPendingLoadCount;
     } else {
-      aLoadData.NotifyOpen(
-          aPreloadKey, mDocument,
-          aLoadData.IsLinkRelPreload() /* TODO: why not `IsPreload()`?*/);
+      // TODO: why not just `IsPreload()`?
+      aLoadData.NotifyOpen(aPreloadKey, mDocument,
+                           aLoadData.IsLinkRelPreloadOrEarlyHint());
     }
   }
   return coalescedLoad;
@@ -1439,14 +1438,15 @@
     }
   }
 
-  aLoadData.NotifyOpen(preloadKey, mDocument, aLoadData.IsLinkRelPreload());
+  aLoadData.NotifyOpen(preloadKey, mDocument,
+                       aLoadData.IsLinkRelPreloadOrEarlyHint());
 
   return LoadSheetAsyncInternal(aLoadData, aEarlyHintPreloaderId, key);
 }
 
 void Loader::AdjustPriority(const SheetLoadData& aLoadData,
                             nsIChannel* aChannel) {
-  if (!aLoadData.ShouldDefer() && aLoadData.IsLinkRelPreload()) {
+  if (!aLoadData.ShouldDefer() && aLoadData.IsLinkRelPreloadOrEarlyHint()) {
     SheetLoadData::PrioritizeAsPreload(aChannel);
   }
 
@@ -1467,7 +1467,7 @@
       return FETCH_PRIORITY_ADJUSTMENT_FOR(deferred_style,
                                            aLoadData.mFetchPriority);
     }
-    if (aLoadData.IsLinkRelPreload()) {
+    if (aLoadData.IsLinkRelPreloadOrEarlyHint()) {
       return FETCH_PRIORITY_ADJUSTMENT_FOR(link_preload_style,
                                            aLoadData.mFetchPriority);
     }
@@ -1516,7 +1516,7 @@
       cos->AddClassFlags(nsIClassOfService::Leader);
     }
 
-    if (aLoadData.IsLinkRelPreload()) {
+    if (!aLoadData.BlocksLoadEvent()) {
       SheetLoadData::AddLoadBackgroundFlag(channel);
     }
   }