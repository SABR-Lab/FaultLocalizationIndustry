# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp
# Commit: fb720435215f
# Full Hash: fb720435215fa5be3b2bd2101f3a54382954b70c
# Author: Andrew Sutherland <asutherland@asutherland.org>
# Date: 2024-10-24 09:44:34
# Regressor Bug: 1544232
# File Overlap Count: 4
# Description:
#   Bug 1544232 - Limit lifetime extension of SWs by SWs to the sender's lifetime. r=edenchuang
#   
#   This patch introduces an explicit concept of lifetimes with mechanisms
#   in place so that actions taken by Clients (windows or non-ServiceWorker
#   orkers) will extend the lifetime of a ServiceWorker, but a ServiceWorker
# ==============================================================================

diff -r 25452f6623a0 -r fb720435215f dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp	Thu Oct 24 03:02:41 2024 +0000
+++ b/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp	Thu Oct 24 03:02:42 2024 +0000
@@ -322,11 +322,13 @@
 }
 
 void ServiceWorkerRegistrationInfo::TryToActivateAsync(
+    const ServiceWorkerLifetimeExtension& aLifetimeExtension,
     TryToActivateCallback&& aCallback) {
   MOZ_ALWAYS_SUCCEEDS(NS_DispatchToMainThread(
-      NewRunnableMethod<StoreCopyPassByRRef<TryToActivateCallback>>(
+      NewRunnableMethod<StoreCopyPassByRRef<ServiceWorkerLifetimeExtension>,
+                        StoreCopyPassByRRef<TryToActivateCallback>>(
           "ServiceWorkerRegistrationInfo::TryToActivate", this,
-          &ServiceWorkerRegistrationInfo::TryToActivate,
+          &ServiceWorkerRegistrationInfo::TryToActivate, aLifetimeExtension,
           std::move(aCallback))));
 }
 
@@ -334,13 +336,17 @@
  * TryToActivate should not be called directly, use TryToActivateAsync instead.
  */
 void ServiceWorkerRegistrationInfo::TryToActivate(
+    ServiceWorkerLifetimeExtension&& aLifetimeExtension,
     TryToActivateCallback&& aCallback) {
   MOZ_ASSERT(NS_IsMainThread());
   bool controlling = IsControllingClients();
   bool skipWaiting = mWaitingWorker && mWaitingWorker->SkipWaitingFlag();
   bool idle = IsIdle();
   if (idle && (!controlling || skipWaiting)) {
-    Activate();
+    if (controlling) {
+      aLifetimeExtension.emplace<FullLifetimeExtension>();
+    }
+    Activate(aLifetimeExtension);
   }
 
   if (aCallback) {
@@ -348,7 +354,8 @@
   }
 }
 
-void ServiceWorkerRegistrationInfo::Activate() {
+void ServiceWorkerRegistrationInfo::Activate(
+    const ServiceWorkerLifetimeExtension& aLifetimeExtension) {
   if (!mWaitingWorker) {
     return;
   }
@@ -375,7 +382,8 @@
 
   ServiceWorkerPrivate* workerPrivate = mActiveWorker->WorkerPrivate();
   MOZ_ASSERT(workerPrivate);
-  nsresult rv = workerPrivate->SendLifeCycleEvent(u"activate"_ns, callback);
+  nsresult rv = workerPrivate->SendLifeCycleEvent(u"activate"_ns,
+                                                  aLifetimeExtension, callback);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     nsCOMPtr<nsIRunnable> failRunnable = NewRunnableMethod<bool>(
         "dom::ServiceWorkerRegistrationInfo::FinishActivate", this,
@@ -578,6 +586,35 @@
   return nullptr;
 }
 
+ServiceWorkerInfo* ServiceWorkerRegistrationInfo::GetByClientInfo(
+    const ClientInfo& aClientInfo) const {
+  if (mActiveWorker) {
+    auto clientRef = mActiveWorker->GetClientInfo();
+    if (clientRef && *clientRef == aClientInfo) {
+      return mActiveWorker;
+    }
+  }
+  if (mWaitingWorker) {
+    auto clientRef = mWaitingWorker->GetClientInfo();
+    if (clientRef && *clientRef == aClientInfo) {
+      return mWaitingWorker;
+    }
+  }
+  if (mInstallingWorker) {
+    auto clientRef = mInstallingWorker->GetClientInfo();
+    if (clientRef && *clientRef == aClientInfo) {
+      return mInstallingWorker;
+    }
+  }
+  if (mEvaluatingWorker) {
+    auto clientRef = mEvaluatingWorker->GetClientInfo();
+    if (clientRef && *clientRef == aClientInfo) {
+      return mEvaluatingWorker;
+    }
+  }
+  return nullptr;
+}
+
 void ServiceWorkerRegistrationInfo::SetEvaluating(
     ServiceWorkerInfo* aServiceWorker) {
   MOZ_ASSERT(NS_IsMainThread());