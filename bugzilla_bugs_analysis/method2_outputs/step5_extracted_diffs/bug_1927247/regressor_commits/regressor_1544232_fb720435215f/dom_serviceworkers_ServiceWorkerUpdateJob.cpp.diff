# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/serviceworkers/ServiceWorkerUpdateJob.cpp
# Commit: fb720435215f
# Full Hash: fb720435215fa5be3b2bd2101f3a54382954b70c
# Author: Andrew Sutherland <asutherland@asutherland.org>
# Date: 2024-10-24 09:44:34
# Regressor Bug: 1544232
# File Overlap Count: 4
# Description:
#   Bug 1544232 - Limit lifetime extension of SWs by SWs to the sender's lifetime. r=edenchuang
#   
#   This patch introduces an explicit concept of lifetimes with mechanisms
#   in place so that actions taken by Clients (windows or non-ServiceWorker
#   orkers) will extend the lifetime of a ServiceWorker, but a ServiceWorker
# ==============================================================================

diff -r 25452f6623a0 -r fb720435215f dom/serviceworkers/ServiceWorkerUpdateJob.cpp
--- a/dom/serviceworkers/ServiceWorkerUpdateJob.cpp	Thu Oct 24 03:02:41 2024 +0000
+++ b/dom/serviceworkers/ServiceWorkerUpdateJob.cpp	Thu Oct 24 03:02:42 2024 +0000
@@ -141,9 +141,11 @@
 
 ServiceWorkerUpdateJob::ServiceWorkerUpdateJob(
     nsIPrincipal* aPrincipal, const nsACString& aScope, nsCString aScriptSpec,
-    ServiceWorkerUpdateViaCache aUpdateViaCache)
+    ServiceWorkerUpdateViaCache aUpdateViaCache,
+    const ServiceWorkerLifetimeExtension& aLifetimeExtension)
     : ServiceWorkerUpdateJob(Type::Update, aPrincipal, aScope,
-                             std::move(aScriptSpec), aUpdateViaCache) {}
+                             std::move(aScriptSpec), aUpdateViaCache,
+                             aLifetimeExtension) {}
 
 already_AddRefed<ServiceWorkerRegistrationInfo>
 ServiceWorkerUpdateJob::GetRegistration() const {
@@ -154,9 +156,11 @@
 
 ServiceWorkerUpdateJob::ServiceWorkerUpdateJob(
     Type aType, nsIPrincipal* aPrincipal, const nsACString& aScope,
-    nsCString aScriptSpec, ServiceWorkerUpdateViaCache aUpdateViaCache)
+    nsCString aScriptSpec, ServiceWorkerUpdateViaCache aUpdateViaCache,
+    const ServiceWorkerLifetimeExtension& aLifetimeExtension)
     : ServiceWorkerJob(aType, aPrincipal, aScope, std::move(aScriptSpec)),
       mUpdateViaCache(aUpdateViaCache),
+      mLifetimeExtension(aLifetimeExtension),
       mOnFailure(serviceWorkerScriptCache::OnFailure::DoNothing) {}
 
 ServiceWorkerUpdateJob::~ServiceWorkerUpdateJob() = default;
@@ -209,6 +213,9 @@
 void ServiceWorkerUpdateJob::FailUpdateJob(nsresult aRv) {
   ErrorResult rv(aRv);
   FailUpdateJob(rv);
+  // This signature is intentionally about not using the result, so we do need
+  // to suppress the exception.
+  rv.SuppressException();
 }
 
 void ServiceWorkerUpdateJob::AsyncExecute() {
@@ -432,8 +439,15 @@
 
   ServiceWorkerPrivate* workerPrivate = sw->WorkerPrivate();
   MOZ_ASSERT(workerPrivate);
-  rv = workerPrivate->CheckScriptEvaluation(callback);
+  // Note that there are some synchronous failure cases that may immediately
+  // invoke the callback, meaning that FailUpdateJob may have already been
+  // called before this method returns.
+  rv = workerPrivate->CheckScriptEvaluation(mLifetimeExtension, callback);
 
+  // We call FailUpdateJob because it is idempotent and as defense-in-depth
+  // against early errors returns potentially being introduced above that return
+  // with ensuring that the passed-in callback will be invoked (such as those
+  // that are frequently added for shutdown phases).
   if (NS_WARN_IF(NS_FAILED(rv))) {
     FailUpdateJob(NS_ERROR_DOM_ABORT_ERR);
     return;
@@ -493,7 +507,8 @@
   // Send the install event to the worker thread
   ServiceWorkerPrivate* workerPrivate =
       mRegistration->GetInstalling()->WorkerPrivate();
-  nsresult rv = workerPrivate->SendLifeCycleEvent(u"install"_ns, callback);
+  nsresult rv = workerPrivate->SendLifeCycleEvent(u"install"_ns,
+                                                  mLifetimeExtension, callback);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     ContinueAfterInstallEvent(false /* aSuccess */);
   }
@@ -539,7 +554,7 @@
   // Step 22 of the Install algorithm.  Activate is executed after the
   // completion of this job.  The controlling client and skipWaiting checks are
   // performed in TryToActivate().
-  mRegistration->TryToActivateAsync();
+  mRegistration->TryToActivateAsync(mLifetimeExtension);
 }
 
 }  // namespace mozilla::dom