# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmCode.cpp
# Commit: d2677d59ef45
# Full Hash: d2677d59ef4542dcc7feeacc232f3eb74751ee1a
# Author: Ryan Hunt <rhunt@eqrion.net>
# Date: 2024-10-31 04:51:12
# Regressor Bug: 1913119
# File Overlap Count: 1
# Description:
#   Bug 1913119 - wasm: Don't pad if we're not write-protecting code. r=jseward
#   
#   When we're not write-protecting code, functions will naturally fall on
#   different cache lines because we don't align them to a page size any
#   more. We can skip this step and save some code memory.
# ==============================================================================

diff -r 4c22ce111c01 -r d2677d59ef45 js/src/wasm/WasmCode.cpp
--- a/js/src/wasm/WasmCode.cpp	Wed Oct 30 21:54:24 2024 +0000
+++ b/js/src/wasm/WasmCode.cpp	Wed Oct 30 21:54:25 2024 +0000
@@ -456,6 +456,12 @@
   const size_t cacheLineSize = 64;
   const size_t systemPageSize = gc::SystemPageSize();
 
+  // If we're not write-protecting code, then we do not need to add any padding
+  if (!JitOptions.writeProtectCode) {
+    MOZ_ASSERT(CodeSegment::AllocationAlignment() != gc::SystemPageSize());
+    return 0;
+  }
+
   // Don't add more than 3/4 of a page of padding
   size_t maxPadBytes = ((systemPageSize * 3) / 4);
   size_t maxPadLines = maxPadBytes / cacheLineSize;
@@ -468,6 +474,11 @@
   // Limit padding to the smallest of the above
   size_t padLinesAvailable = std::min(maxPadLines, remainingLinesInPage);
 
+  // Don't add any padding if none is available
+  if (padLinesAvailable == 0) {
+    return 0;
+  }
+
   uint32_t random = counter++;
   uint32_t padding = (random % padLinesAvailable) * cacheLineSize;
   // "adding on the padding area doesn't change the total number of pages
