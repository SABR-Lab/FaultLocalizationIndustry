# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/generic/nsBlockFrame.cpp
# Commit: 55175ed82058
# Full Hash: 55175ed820584bbb1afe88f936b7dc2e382a7e0a
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2024-11-22 09:28:00
# Regressor Bug: 1926015
# File Overlap Count: 1
# Description:
#   Bug 1926015 - Percentage-basis aware intrinsic cache. r=TYLin,dholbert
#   
#   This avoids returning wrong intrinsic values with different calls into
#   intrinsic size computation, which is wrong by definition.
#   
# ==============================================================================

diff -r a4434b7aabda -r 55175ed82058 layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp	Thu Nov 21 16:53:09 2024 +0000
+++ b/layout/generic/nsBlockFrame.cpp	Thu Nov 21 17:04:14 2024 +0000
@@ -765,8 +765,7 @@
 /* virtual */
 void nsBlockFrame::MarkIntrinsicISizesDirty() {
   nsBlockFrame* dirtyBlock = static_cast<nsBlockFrame*>(FirstContinuation());
-  dirtyBlock->mCachedMinISize = NS_INTRINSIC_ISIZE_UNKNOWN;
-  dirtyBlock->mCachedPrefISize = NS_INTRINSIC_ISIZE_UNKNOWN;
+  dirtyBlock->mCachedIntrinsics.Clear();
   if (!HasAnyStateBits(NS_BLOCK_NEEDS_BIDI_RESOLUTION)) {
     for (nsIFrame* frame = dirtyBlock; frame;
          frame = frame->GetNextContinuation()) {
@@ -784,8 +783,7 @@
   }
   bool inflationEnabled = !presContext->mInflationDisabledForShrinkWrap;
   if (inflationEnabled != HasAnyStateBits(NS_BLOCK_INTRINSICS_INFLATED)) {
-    mCachedMinISize = NS_INTRINSIC_ISIZE_UNKNOWN;
-    mCachedPrefISize = NS_INTRINSIC_ISIZE_UNKNOWN;
+    mCachedIntrinsics.Clear();
     AddOrRemoveStateBits(NS_BLOCK_INTRINSICS_INFLATED, inflationEnabled);
   }
 }
@@ -823,17 +821,10 @@
 
   CheckIntrinsicCacheAgainstShrinkWrapState();
 
-  if (aType == IntrinsicISizeType::MinISize) {
-    if (mCachedMinISize == NS_INTRINSIC_ISIZE_UNKNOWN) {
-      mCachedMinISize = MinISize(aInput);
-    }
-    return mCachedMinISize;
-  }
-
-  if (mCachedPrefISize == NS_INTRINSIC_ISIZE_UNKNOWN) {
-    mCachedPrefISize = PrefISize(aInput);
-  }
-  return mCachedPrefISize;
+  return mCachedIntrinsics.GetOrSet(*this, aType, aInput, [&] {
+    return aType == IntrinsicISizeType::MinISize ? MinISize(aInput)
+                                                 : PrefISize(aInput);
+  });
 }
 
 /* virtual */