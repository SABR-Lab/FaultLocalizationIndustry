# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/notification/NotificationParent.cpp
# Commit: 33642b1c547b
# Full Hash: 33642b1c547b01c7a59417c8c2fe2a5ca33847c1
# Author: Kagami Sascha Rosylight <saschanaz@outlook.com>
# Date: 2024-11-08 04:19:40
# Regressor Bug: 1928702
# File Overlap Count: 1
# Description:
#   Bug 1928702 - Part 9: Implement alertclickcallback behavior r=asuth
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D227694
# ==============================================================================

diff -r 56ab49acff35 -r 33642b1c547b dom/notification/NotificationParent.cpp
--- a/dom/notification/NotificationParent.cpp	Thu Nov 07 17:32:06 2024 +0000
+++ b/dom/notification/NotificationParent.cpp	Thu Nov 07 17:32:07 2024 +0000
@@ -11,6 +11,7 @@
 #include "mozilla/Components.h"
 #include "nsComponentManagerUtils.h"
 #include "nsIAlertsService.h"
+#include "nsIServiceWorkerManager.h"
 
 namespace mozilla::dom::notification {
 
@@ -25,6 +26,9 @@
   if (!strcmp("alertsettingscallback", aTopic)) {
     return OpenSettings(mPrincipal);
   }
+  if (!strcmp("alertclickcallback", aTopic)) {
+    return FireClickEvent();
+  }
   if (!strcmp("alertshow", aTopic)) {
     (void)NS_WARN_IF(NS_FAILED(
         AdjustPushQuota(mPrincipal, NotificationStatusChange::Shown)));
@@ -56,6 +60,30 @@
   return NS_OK;
 }
 
+nsresult NotificationParent::FireClickEvent() {
+  // This needs to be done here rather than in the child actor's
+  // RecvNotifyClick because the caller might not be in the service worker
+  // context but in the window context
+  if (nsCOMPtr<nsIServiceWorkerManager> swm =
+          mozilla::components::ServiceWorkerManager::Service()) {
+    nsAutoCString originSuffix;
+    MOZ_TRY(mPrincipal->GetOriginSuffix(originSuffix));
+    nsAutoString behavior;
+    if (!mOptions.behavior().ToJSON(behavior)) {
+      return NS_ERROR_FAILURE;
+    }
+    MOZ_TRY(swm->SendNotificationClickEvent(
+        originSuffix, NS_ConvertUTF16toUTF8(mScope), mId, mOptions.title(),
+        NS_ConvertASCIItoUTF16(GetEnumString(mOptions.dir())), mOptions.lang(),
+        mOptions.body(), mOptions.tag(), mOptions.icon(),
+        mOptions.dataSerialized(), behavior));
+
+    return NS_OK;
+  }
+
+  return NS_ERROR_FAILURE;
+}
+
 // Step 4 of
 // https://notifications.spec.whatwg.org/#dom-notification-notification
 mozilla::ipc::IPCResult NotificationParent::RecvShow(ShowResolver&& aResolver) {