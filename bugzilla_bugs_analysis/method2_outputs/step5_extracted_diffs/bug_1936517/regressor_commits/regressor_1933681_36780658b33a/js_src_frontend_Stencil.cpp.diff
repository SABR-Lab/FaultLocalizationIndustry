# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/frontend/Stencil.cpp
# Commit: 36780658b33a
# Full Hash: 36780658b33a050e82385161eab2e5e2e5e90064
# Author: Tooru Fujisawa <arai_a@mac.com>
# Date: 2024-12-05 09:58:04
# Regressor Bug: 1933681
# File Overlap Count: 1
# Description:
#   Bug 1933681 - Part 2: Rewrite concurrent delazification's input/output based on InitialStencilAndDelazifications. r=nbp
#   
#   The concurrent delazification internal is still using CompilationStencilMerger.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D230388
# ==============================================================================

diff -r 31d3f2901db9 -r 36780658b33a js/src/frontend/Stencil.cpp
--- a/js/src/frontend/Stencil.cpp	Wed Dec 04 23:44:33 2024 +0000
+++ b/js/src/frontend/Stencil.cpp	Wed Dec 04 23:44:33 2024 +0000
@@ -3710,13 +3710,21 @@
 /* static */
 bool InitialStencilAndDelazifications::instantiateStencils(
     JSContext* cx, CompilationInput& input,
-    const InitialStencilAndDelazifications& stencils,
-    CompilationGCOutput& gcOutput) {
+    InitialStencilAndDelazifications& stencils, CompilationGCOutput& gcOutput) {
   if (!CompilationStencil::instantiateStencils(cx, input, *stencils.initial_,
                                                gcOutput)) {
     return false;
   }
 
+  if (input.options.populateDelazificationCache()) {
+    RefPtr<InitialStencilAndDelazifications> stencilsPtr = &stencils;
+    ScriptSourceObject* sso = gcOutput.script->sourceObject();
+    MOZ_ASSERT(!sso->maybeGetStencils());
+    if (!stencils.getInitial()->asmJS) {
+      sso->setStencils(stencilsPtr.forget());
+    }
+  }
+
   // At this point, gcOutput.script contains the top-level script, and
   // gcOutput.functions[i] contains i-th function, where 0-th item is
   // always nullptr.