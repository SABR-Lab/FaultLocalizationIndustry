# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/events/Event.cpp
# Commit: 89f824b90f28
# Full Hash: 89f824b90f28712add5e09abcdc16441ba85d973
# Author: Olli Pettay <Olli.Pettay@helsinki.fi>
# Date: 2025-01-14 04:54:49
# Description:
#   Bug 1941080, try to CanSkip target objects only when the targets are owned by the heap object, not stack event (similarly to traverse/unlink), r=mccr8
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D234061
# ==============================================================================

diff -r 5796b71434b4 -r 89f824b90f28 dom/events/Event.cpp
--- a/dom/events/Event.cpp	Mon Jan 13 17:33:46 2025 +0000
+++ b/dom/events/Event.cpp	Mon Jan 13 17:48:32 2025 +0000
@@ -222,25 +222,27 @@
 
 NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_BEGIN(Event)
   if (tmp->HasKnownLiveWrapper()) {
-    if (WidgetEvent* event = tmp->mEvent) {
-      auto mark = [](EventTarget* aTarget) {
-        if (!aTarget) {
-          return;
-        }
-        if (nsINode* node = aTarget->GetAsNode()) {
-          FragmentOrElement::MarkNodeChildren(node);
-          if (node->HasKnownLiveWrapper()) {
-            // Use CanSkip to possibly mark more nodes to be certainly alive.
-            FragmentOrElement::CanSkip(node, true);
+    if (tmp->mEventIsInternal) {
+      if (WidgetEvent* event = tmp->mEvent) {
+        auto mark = [](EventTarget* aTarget) {
+          if (!aTarget) {
+            return;
           }
-        }
-      };
+          if (nsINode* node = aTarget->GetAsNode()) {
+            FragmentOrElement::MarkNodeChildren(node);
+            if (node->HasKnownLiveWrapper()) {
+              // Use CanSkip to possibly mark more nodes to be certainly alive.
+              FragmentOrElement::CanSkip(node, true);
+            }
+          }
+        };
 
-      mark(event->mTarget);
-      mark(event->mCurrentTarget);
-      mark(event->mOriginalTarget);
-      mark(event->mRelatedTarget);
-      mark(event->mOriginalRelatedTarget);
+        mark(event->mTarget);
+        mark(event->mCurrentTarget);
+        mark(event->mOriginalTarget);
+        mark(event->mRelatedTarget);
+        mark(event->mOriginalRelatedTarget);
+      }
     }
     return true;
   }
