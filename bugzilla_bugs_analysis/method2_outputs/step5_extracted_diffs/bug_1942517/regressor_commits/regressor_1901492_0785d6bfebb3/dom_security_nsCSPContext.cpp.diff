# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/security/nsCSPContext.cpp
# Commit: 0785d6bfebb3
# Full Hash: 0785d6bfebb3405227469a255389dac80b627f91
# Author: Frédéric Wang <fwang@igalia.com>
# Date: 2025-01-17 21:57:54
# Regressor Bug: 1901492
# File Overlap Count: 1
# Description:
#   Bug 1901492 - Introduce RequireTrustedTypesForDirectiveState enum for CSP. r=smaug
#   
#   Extend the hasPolicyWithRequireTrustedTypesForDirective boolean on
#   nsIContentSecurityPolicy to an enum in order to indicate whether there
#   is actually a require-trusted-types-for directive with "enforce"
# ==============================================================================

diff -r 23ca1773d73a -r 0785d6bfebb3 dom/security/nsCSPContext.cpp
--- a/dom/security/nsCSPContext.cpp	Fri Jan 17 13:35:39 2025 +0000
+++ b/dom/security/nsCSPContext.cpp	Fri Jan 17 13:35:39 2025 +0000
@@ -470,7 +470,13 @@
     }
     if (policy->hasDirective(
             nsIContentSecurityPolicy::REQUIRE_TRUSTED_TYPES_FOR_DIRECTIVE)) {
-      mHasPolicyWithRequireTrustedTypesForDirective = true;
+      if (mRequireTrustedTypesForDirectiveState !=
+          RequireTrustedTypesForDirectiveState::ENFORCE) {
+        mRequireTrustedTypesForDirectiveState =
+            policy->getReportOnlyFlag()
+                ? RequireTrustedTypesForDirectiveState::REPORT_ONLY
+                : RequireTrustedTypesForDirectiveState::ENFORCE;
+      }
       if (nsCOMPtr<Document> doc = do_QueryReferent(mLoadingContext)) {
         doc->SetHasPolicyWithRequireTrustedTypesForDirective(true);
       }
@@ -483,10 +489,11 @@
 }
 
 NS_IMETHODIMP
-nsCSPContext::GetHasPolicyWithRequireTrustedTypesForDirective(
-    bool* aHasPolicyWithRequireTrustedTypesForDirective) {
-  *aHasPolicyWithRequireTrustedTypesForDirective =
-      mHasPolicyWithRequireTrustedTypesForDirective;
+nsCSPContext::GetRequireTrustedTypesForDirectiveState(
+    RequireTrustedTypesForDirectiveState*
+        aRequireTrustedTypesForDirectiveState) {
+  *aRequireTrustedTypesForDirectiveState =
+      mRequireTrustedTypesForDirectiveState;
   return NS_OK;
 }
 