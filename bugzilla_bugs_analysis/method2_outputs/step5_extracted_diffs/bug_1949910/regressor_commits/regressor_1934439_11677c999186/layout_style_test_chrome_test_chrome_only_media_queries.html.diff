# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/style/test/chrome/test_chrome_only_media_queries.html
# Commit: 11677c999186
# Full Hash: 11677c999186407cb5e0782802a471a5da19843c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-02-21 09:54:38
# Regressor Bug: 1934439
# File Overlap Count: 1
# Description:
#   Bug 1934439 - Make the mica prefs toggle-able at runtime. r=win-reviewers,rkraesig
#   
#   Not particularly pretty but this will do.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238705
# ==============================================================================

diff -r a1689cdc8048 -r 11677c999186 layout/style/test/chrome/test_chrome_only_media_queries.html
--- a/layout/style/test/chrome/test_chrome_only_media_queries.html	Thu Feb 20 22:17:05 2025 +0000
+++ b/layout/style/test/chrome/test_chrome_only_media_queries.html	Thu Feb 20 22:35:19 2025 +0000
@@ -6,6 +6,14 @@
 <script>
 const SHEET = document.querySelector('style');
 
+let lazy = {};
+
+ChromeUtils.defineESModuleGetters(lazy, {
+  WindowsVersionInfo:
+    "resource://gre/modules/components-utils/WindowsVersionInfo.sys.mjs",
+});
+
+
 SimpleTest.waitForExplicitFinish();
 
 function expect(q, shouldBeKnown) {
@@ -92,6 +100,26 @@
   await testMozPref('-moz-pref("foo.bar.str")', "foo.bar.str", "foo", "");
   await testMozPref('-moz-pref("foo.bar.int", 1)', "foo.bar.int", 1, 2);
   await testMozPref('-moz-pref("foo.bar.int")', "foo.bar.int", 1, 0);
+
+  let supportsMica = matchMedia('(-moz-platform: windows)').matches && lazy.WindowsVersionInfo.get().buildNumber >= 22621;
+  info(`Mica supported: ${supportsMica}`);
+  for (let [query, pref] of [['(-moz-windows-mica)', 'widget.windows.mica'], ['(-moz-windows-mica-popups)', 'widget.windows.mica.popups']]) {
+    let prefEnabled = SpecialPowers.getBoolPref("widget.windows.mica", false);
+    let mediaList = matchMedia(query);
+    is(mediaList.matches, supportsMica && prefEnabled, `Mica support is as expected ${query}`);
+    let change = new Promise(r => {
+      mediaList.addEventListener("change", r, { once: true });
+    });
+    await SpecialPowers.pushPrefEnv({
+      set:[[pref, !prefEnabled]],
+    });
+    if (supportsMica) {
+      await change;
+    }
+    is(mediaList.matches, supportsMica && !prefEnabled, `Mica query works dynamically if appropriate ${query}`);
+    await SpecialPowers.popPrefEnv();
+  }
+
   SimpleTest.finish();
 }());
 </script>