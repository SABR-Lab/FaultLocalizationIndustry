# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/WinUtils.cpp
# Commit: 11677c999186
# Full Hash: 11677c999186407cb5e0782802a471a5da19843c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-02-21 09:54:38
# Regressor Bug: 1934439
# File Overlap Count: 1
# Description:
#   Bug 1934439 - Make the mica prefs toggle-able at runtime. r=win-reviewers,rkraesig
#   
#   Not particularly pretty but this will do.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238705
# ==============================================================================

diff -r a1689cdc8048 -r 11677c999186 widget/windows/WinUtils.cpp
--- a/widget/windows/WinUtils.cpp	Thu Feb 20 22:17:05 2025 +0000
+++ b/widget/windows/WinUtils.cpp	Thu Feb 20 22:35:19 2025 +0000
@@ -68,8 +68,7 @@
 
 using namespace mozilla::gfx;
 
-namespace mozilla {
-namespace widget {
+namespace mozilla::widget {
 
 #ifdef MOZ_PLACES
 NS_IMPL_ISUPPORTS(myDownloadObserver, nsIDownloadObserver)
@@ -2005,16 +2004,43 @@
   return true;
 }
 
+static constexpr nsLiteralCString kMicaPrefs[] = {
+    "widget.windows.mica"_ns,
+    "widget.windows.mica.popups"_ns,
+};
+
+static BOOL CALLBACK UpdateMicaInHwnd(HWND aHwnd, LPARAM aLParam) {
+  if (RefPtr<nsWindow> win = WinUtils::GetNSWindowPtr(aHwnd)) {
+    win->UpdateMicaBackdrop(/* aForce = */ true);
+  }
+  return TRUE;
+}
+
+static void UpdateMicaInAllWindows(const char*, void*) {
+  ::EnumWindows(&UpdateMicaInHwnd, 0);
+  LookAndFeel::NotifyChangedAllWindows(
+      widget::ThemeChangeKind::MediaQueriesOnly);
+}
+
+bool WinUtils::MicaAvailable() {
+  static bool sAvailable = [] {
+    if (!IsWin1122H2OrLater()) {
+      return false;
+    }
+    for (const auto& pref : kMicaPrefs) {
+      Preferences::RegisterCallback(UpdateMicaInAllWindows, pref);
+    }
+    return true;
+  }();
+  return sAvailable;
+}
+
 bool WinUtils::MicaEnabled() {
-  static bool sEnabled =
-      IsWin1122H2OrLater() && StaticPrefs::widget_windows_mica_AtStartup();
-  return sEnabled;
+  return MicaAvailable() && StaticPrefs::widget_windows_mica();
 }
 
 bool WinUtils::MicaPopupsEnabled() {
-  static bool sEnabled = IsWin1122H2OrLater() &&
-                         StaticPrefs::widget_windows_mica_popups_AtStartup();
-  return sEnabled;
+  return MicaAvailable() && StaticPrefs::widget_windows_mica_popups();
 }
 
 // There are undocumented APIs to query/change the system DPI settings found by
@@ -2225,5 +2251,4 @@
   }
 }
 
-}  // namespace widget
-}  // namespace mozilla
+}  // namespace mozilla::widget