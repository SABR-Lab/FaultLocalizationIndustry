# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/WinUtils.cpp
# Commit: 1345d8372866
# Full Hash: 1345d8372866767b4a02ff62647af4c0e59bbfb9
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-02-21 09:54:38
# Regressor Bug: 1934439
# File Overlap Count: 1
# Description:
#   Bug 1934439 - Make the mica prefs toggle-able at runtime. r=win-reviewers,rkraesig
#   
#   Not particularly pretty but this will do.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238705
# ==============================================================================

diff -r 247db6ae4912 -r 1345d8372866 widget/windows/WinUtils.cpp
--- a/widget/windows/WinUtils.cpp	Thu Feb 20 18:02:21 2025 +0000
+++ b/widget/windows/WinUtils.cpp	Thu Feb 20 18:21:03 2025 +0000
@@ -2005,16 +2005,43 @@
   return true;
 }
 
+static constexpr nsLiteralCString kMicaPrefs[] = {
+    "widget.windows.mica"_ns,
+    "widget.windows.mica.popups"_ns,
+};
+
+static BOOL CALLBACK UpdateMicaInHwnd(HWND aHwnd, LPARAM aLParam) {
+  if (RefPtr<nsWindow> win = WinUtils::GetNSWindowPtr(aHwnd)) {
+    win->UpdateMicaBackdrop(/* aForce = */ true);
+  }
+  return TRUE;
+}
+
+static void UpdateMicaInAllWindows(const char*, void*) {
+  ::EnumWindows(&UpdateMicaInHwnd, 0);
+  LookAndFeel::NotifyChangedAllWindows(
+      widget::ThemeChangeKind::MediaQueriesOnly);
+}
+
+bool WinUtils::MicaAvailable() {
+  static bool sAvailable = [] {
+    if (!IsWin1122H2OrLater()) {
+      return false;
+    }
+    for (const auto& pref : kMicaPrefs) {
+      Preferences::RegisterCallback(::UpdateMicaInAllWindows, pref);
+    }
+    return true;
+  }();
+  return sAvailable;
+}
+
 bool WinUtils::MicaEnabled() {
-  static bool sEnabled =
-      IsWin1122H2OrLater() && StaticPrefs::widget_windows_mica_AtStartup();
-  return sEnabled;
+  return MicaAvailable() && StaticPrefs::widget_windows_mica();
 }
 
 bool WinUtils::MicaPopupsEnabled() {
-  static bool sEnabled = IsWin1122H2OrLater() &&
-                         StaticPrefs::widget_windows_mica_popups_AtStartup();
-  return sEnabled;
+  return MicaAvailable() && StaticPrefs::widget_windows_mica_popups();
 }
 
 // There are undocumented APIs to query/change the system DPI settings found by