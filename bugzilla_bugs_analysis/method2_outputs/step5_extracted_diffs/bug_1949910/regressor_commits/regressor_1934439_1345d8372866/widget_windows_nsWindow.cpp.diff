# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/windows/nsWindow.cpp
# Commit: 1345d8372866
# Full Hash: 1345d8372866767b4a02ff62647af4c0e59bbfb9
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-02-21 09:54:38
# Regressor Bug: 1934439
# File Overlap Count: 1
# Description:
#   Bug 1934439 - Make the mica prefs toggle-able at runtime. r=win-reviewers,rkraesig
#   
#   Not particularly pretty but this will do.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238705
# ==============================================================================

diff -r 247db6ae4912 -r 1345d8372866 widget/windows/nsWindow.cpp
--- a/widget/windows/nsWindow.cpp	Thu Feb 20 18:02:21 2025 +0000
+++ b/widget/windows/nsWindow.cpp	Thu Feb 20 18:21:03 2025 +0000
@@ -668,6 +668,7 @@
       mFrameState(std::in_place, this),
       mIsChildWindow(aIsChildWindow),
       mPIPWindow(false),
+      mMicaBackdrop(false),
       mLastPaintEndTime(TimeStamp::Now()),
       mCachedHitTestTime(TimeStamp::Now()),
       mSizeConstraintsScale(GetDefaultScale().scale),
@@ -2524,14 +2525,25 @@
 }
 
 void nsWindow::SetMicaBackdrop(bool aEnabled) {
+  if (aEnabled == mMicaBackdrop) {
+    return;
+  }
+
+  mMicaBackdrop = aEnabled;
+  UpdateMicaBackdrop();
+}
+
+void nsWindow::UpdateMicaBackdrop(bool aForce) {
   const bool micaEnabled =
       IsPopup() ? WinUtils::MicaPopupsEnabled() : WinUtils::MicaEnabled();
-  if (!micaEnabled) {
+  if (!micaEnabled && !aForce) {
     return;
   }
 
+  const bool useBackdrop = mMicaBackdrop && micaEnabled;
+
   const DWM_SYSTEMBACKDROP_TYPE backdrop = [&] {
-    if (!aEnabled) {
+    if (!useBackdrop) {
       return DWMSBT_AUTO;
     }
     return IsPopup() ? DWMSBT_TRANSIENTWINDOW : DWMSBT_TABBEDWINDOW;
@@ -2546,7 +2558,7 @@
     //    otherwise it'd draw the inactive window backdrop rather than
     //    acrylic). See also the WM_NCACTIVATE implementation.
     const DWM_WINDOW_CORNER_PREFERENCE corner =
-        aEnabled ? DWMWCP_ROUND : DWMWCP_DEFAULT;
+        useBackdrop ? DWMWCP_ROUND : DWMWCP_DEFAULT;
     ::DwmSetWindowAttribute(mWnd, DWMWA_WINDOW_CORNER_PREFERENCE, &corner,
                             sizeof corner);
     ::PostMessageW(mWnd, WM_NCACTIVATE, TRUE, -1);