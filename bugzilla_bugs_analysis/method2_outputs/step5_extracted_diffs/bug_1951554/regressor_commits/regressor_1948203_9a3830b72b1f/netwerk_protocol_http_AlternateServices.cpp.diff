# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/AlternateServices.cpp
# Commit: 9a3830b72b1f
# Full Hash: 9a3830b72b1f2a9640a7ff945b91d17d67828bcd
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2025-02-24 17:07:55
# Regressor Bug: 1948203
# File Overlap Count: 5
# Description:
#   Bug 1948203 - Skip alt-svc validation if we already connected to the server, r=necko-reviewers,jesup
#   
#   This patch optimizes how Firefox handles speculative connections for alt-svc headers. When a server sends an alt-svc header, Firefox normally creates a speculative connection to validate it. With this patch, if the connectionâ€™s hash key matches the one generated from the alt-svc header, the validation step is skipped since an equivalent connection is already in place, avoiding unnecessary work.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238218
# ==============================================================================

diff -r d5962b430cd3 -r 9a3830b72b1f netwerk/protocol/http/AlternateServices.cpp
--- a/netwerk/protocol/http/AlternateServices.cpp	Mon Feb 24 09:01:12 2025 +0000
+++ b/netwerk/protocol/http/AlternateServices.cpp	Mon Feb 24 09:20:35 2025 +0000
@@ -64,6 +64,7 @@
     bool privateBrowsing, nsIInterfaceRequestor* callbacks,
     nsProxyInfo* proxyInfo, uint32_t caps,
     const OriginAttributes& originAttributes,
+    nsHttpConnectionInfo* aTransConnInfo,
     bool aDontValidate /* = false */) {  // aDontValidate is only used for
                                          // testing
   MOZ_ASSERT(NS_IsMainThread());
@@ -188,6 +189,16 @@
   }
 
   auto doUpdateAltSvcMapping = [&](AltSvcMapping* aMapping) {
+    if (aTransConnInfo &&
+        StaticPrefs::network_http_skip_alt_svc_validation_on_https_rr()) {
+      RefPtr<nsHttpConnectionInfo> ci;
+      aMapping->GetConnectionInfo(getter_AddRefs(ci), proxyInfo,
+                                  originAttributes);
+      if (ci->HashKey().Equals(aTransConnInfo->HashKey())) {
+        LOG(("The transaction's conninfo is the same, no need to validate"));
+        aDontValidate = true;
+      }
+    }
     if (!aDontValidate) {
       gHttpHandler->UpdateAltServiceMapping(aMapping, proxyInfo, callbacks,
                                             caps, originAttributes);