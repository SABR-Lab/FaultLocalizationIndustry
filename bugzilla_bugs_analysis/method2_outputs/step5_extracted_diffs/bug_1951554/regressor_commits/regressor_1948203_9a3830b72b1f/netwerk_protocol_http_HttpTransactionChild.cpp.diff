# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/HttpTransactionChild.cpp
# Commit: 9a3830b72b1f
# Full Hash: 9a3830b72b1f2a9640a7ff945b91d17d67828bcd
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2025-02-24 17:07:55
# Regressor Bug: 1948203
# File Overlap Count: 5
# Description:
#   Bug 1948203 - Skip alt-svc validation if we already connected to the server, r=necko-reviewers,jesup
#   
#   This patch optimizes how Firefox handles speculative connections for alt-svc headers. When a server sends an alt-svc header, Firefox normally creates a speculative connection to validate it. With this patch, if the connectionâ€™s hash key matches the one generated from the alt-svc header, the validation step is skipped since an equivalent connection is already in place, avoiding unnecessary work.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238218
# ==============================================================================

diff -r d5962b430cd3 -r 9a3830b72b1f netwerk/protocol/http/HttpTransactionChild.cpp
--- a/netwerk/protocol/http/HttpTransactionChild.cpp	Mon Feb 24 09:01:12 2025 +0000
+++ b/netwerk/protocol/http/HttpTransactionChild.cpp	Mon Feb 24 09:20:35 2025 +0000
@@ -482,6 +482,10 @@
     }
   }
 
+  RefPtr<nsHttpConnectionInfo> connInfo = mTransaction->GetConnInfo();
+  HttpConnectionInfoCloneArgs infoArgs;
+  nsHttpConnectionInfo::SerializeHttpConnectionInfo(connInfo, infoArgs);
+
   Unused << SendOnStartRequest(
       status, std::move(optionalHead), securityInfo,
       mTransaction->ProxyConnectFailed(),
@@ -489,7 +493,7 @@
       dataForSniffer, optionalAltSvcUsed, !!mDataBridgeParent,
       mTransaction->TakeRestartedState(), mTransaction->HTTPSSVCReceivedStage(),
       mTransaction->GetSupportsHTTP3(), mode, reason, mTransaction->Caps(),
-      TimeStamp::Now());
+      TimeStamp::Now(), infoArgs);
   return NS_OK;
 }
 
@@ -564,14 +568,11 @@
     mDataBridgeParent = nullptr;
   }
 
-  RefPtr<nsHttpConnectionInfo> connInfo = mTransaction->GetConnInfo();
-  HttpConnectionInfoCloneArgs infoArgs;
-  nsHttpConnectionInfo::SerializeHttpConnectionInfo(connInfo, infoArgs);
   Unused << SendOnStopRequest(aStatus, mTransaction->ResponseIsComplete(),
                               mTransaction->GetTransferSize(),
                               ToTimingStructArgs(mTransaction->Timings()),
                               responseTrailers, mTransactionObserverResult,
-                              lastActTabOpt, infoArgs, TimeStamp::Now());
+                              lastActTabOpt, TimeStamp::Now());
 
   return NS_OK;
 }