# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/protocol/http/TRRServiceChannel.cpp
# Commit: 9a3830b72b1f
# Full Hash: 9a3830b72b1f2a9640a7ff945b91d17d67828bcd
# Author: Kershaw Chang <kershaw@mozilla.com>
# Date: 2025-02-24 17:07:55
# Regressor Bug: 1948203
# File Overlap Count: 5
# Description:
#   Bug 1948203 - Skip alt-svc validation if we already connected to the server, r=necko-reviewers,jesup
#   
#   This patch optimizes how Firefox handles speculative connections for alt-svc headers. When a server sends an alt-svc header, Firefox normally creates a speculative connection to validate it. With this patch, if the connectionâ€™s hash key matches the one generated from the alt-svc header, the validation step is skipped since an equivalent connection is already in place, avoiding unnecessary work.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D238218
# ==============================================================================

diff -r d5962b430cd3 -r 9a3830b72b1f netwerk/protocol/http/TRRServiceChannel.cpp
--- a/netwerk/protocol/http/TRRServiceChannel.cpp	Mon Feb 24 09:01:12 2025 +0000
+++ b/netwerk/protocol/http/TRRServiceChannel.cpp	Mon Feb 24 09:20:35 2025 +0000
@@ -918,7 +918,8 @@
   }
 }
 
-void TRRServiceChannel::ProcessAltService() {
+void TRRServiceChannel::ProcessAltService(
+    nsHttpConnectionInfo* aTransConnInfo) {
   // e.g. Alt-Svc: h2=":443"; ma=60
   // e.g. Alt-Svc: h2="otherhost:443"
   // Alt-Svc       = 1#( alternative *( OWS ";" OWS parameter ) )
@@ -967,21 +968,23 @@
     proxyInfo = do_QueryInterface(mProxyInfo);
   }
 
+  RefPtr<nsHttpConnectionInfo> connectionInfo = aTransConnInfo;
   auto processHeaderTask = [altSvc, scheme, originHost, originPort,
                             userName(mUsername),
                             privateBrowsing(mPrivateBrowsing), callbacks,
-                            proxyInfo, caps(mCaps)]() {
+                            proxyInfo, caps(mCaps), connectionInfo]() {
     if (XRE_IsSocketProcess()) {
       AltServiceChild::ProcessHeader(altSvc, scheme, originHost, originPort,
                                      userName, privateBrowsing, callbacks,
                                      proxyInfo, caps & NS_HTTP_DISALLOW_SPDY,
-                                     OriginAttributes());
+                                     OriginAttributes(), connectionInfo);
       return;
     }
 
-    AltSvcMapping::ProcessHeader(
-        altSvc, scheme, originHost, originPort, userName, privateBrowsing,
-        callbacks, proxyInfo, caps & NS_HTTP_DISALLOW_SPDY, OriginAttributes());
+    AltSvcMapping::ProcessHeader(altSvc, scheme, originHost, originPort,
+                                 userName, privateBrowsing, callbacks,
+                                 proxyInfo, caps & NS_HTTP_DISALLOW_SPDY,
+                                 OriginAttributes(), connectionInfo);
   };
 
   if (NS_IsMainThread()) {
@@ -1037,7 +1040,9 @@
       }
 
       if ((httpStatus < 500) && (httpStatus != 421) && (httpStatus != 407)) {
-        ProcessAltService();
+        RefPtr<nsHttpConnectionInfo> connectionInfo =
+            mTransaction->GetConnInfo();
+        ProcessAltService(connectionInfo);
       }
 
       if (httpStatus == 300 || httpStatus == 301 || httpStatus == 302 ||