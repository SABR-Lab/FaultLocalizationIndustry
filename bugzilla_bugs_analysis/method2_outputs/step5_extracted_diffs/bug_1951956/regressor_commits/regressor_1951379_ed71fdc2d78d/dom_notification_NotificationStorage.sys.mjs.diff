# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/notification/NotificationStorage.sys.mjs
# Commit: ed71fdc2d78d
# Full Hash: ed71fdc2d78dec085a3d153220bba4aeda89992b
# Author: Kagami Sascha Rosylight <saschanaz@outlook.com>
# Date: 2025-03-05 04:28:59
# Regressor Bug: 1951379
# File Overlap Count: 1
# Description:
#   Bug 1951379 - Part 3: Add NotificationStorageEntry r=asuth
#   
#   This skips handling `vibrate` for now, as we don't ship it and it also complicates test setup.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D240213
# ==============================================================================

diff -r 61ab7888abc4 -r ed71fdc2d78d dom/notification/NotificationStorage.sys.mjs
--- a/dom/notification/NotificationStorage.sys.mjs	Tue Mar 04 18:00:17 2025 +0000
+++ b/dom/notification/NotificationStorage.sys.mjs	Tue Mar 04 18:00:18 2025 +0000
@@ -68,35 +68,17 @@
     }
   }
 
-  put(
-    origin,
-    id,
-    title,
-    dir,
-    lang,
-    body,
-    tag,
-    icon,
-    data,
-    serviceWorkerRegistrationScope
-  ) {
-    lazy.console.debug(`PUT: ${origin} ${id}: ${title}`);
-    var notification = {
-      id,
-      title,
-      dir,
-      lang,
-      body,
-      tag,
-      icon,
+  put(aOrigin, aEntry, aScope) {
+    lazy.console.debug(`PUT: ${aOrigin} ${aEntry.id}: ${aEntry.title}`);
+    let { QueryInterface, ...entry } = aEntry;
+    let notification = {
+      ...entry,
       timestamp: new Date().getTime(),
-      origin,
-      data,
-      serviceWorkerRegistrationScope,
+      serviceWorkerRegistrationScope: aScope,
     };
 
     Services.cpmm.sendAsyncMessage(this.formatMessageType("Save"), {
-      origin,
+      origin: aOrigin,
       notification,
     });
   }
@@ -172,29 +154,10 @@
     // Pass each notification back separately.
     // The callback is called asynchronously to match the behaviour when
     // fetching from the database.
-    notifications.forEach(function (notification) {
-      try {
-        Services.tm.dispatchToMainThread(() =>
-          callback.handle(
-            notification.id,
-            notification.title,
-            notification.dir,
-            notification.lang,
-            notification.body,
-            notification.tag,
-            notification.icon,
-            notification.data,
-            notification.serviceWorkerRegistrationScope
-          )
-        );
-      } catch (e) {
-        lazy.console.debug(`Error calling callback handle: ${e}`);
-      }
-    });
     try {
-      Services.tm.dispatchToMainThread(callback.done);
+      Services.tm.dispatchToMainThread(() => callback.done(notifications));
     } catch (e) {
-      lazy.console.debug(`Error calling callback done: ${e}`);
+      lazy.console.debug(`Error calling callback handle: ${e}`);
     }
   }
 