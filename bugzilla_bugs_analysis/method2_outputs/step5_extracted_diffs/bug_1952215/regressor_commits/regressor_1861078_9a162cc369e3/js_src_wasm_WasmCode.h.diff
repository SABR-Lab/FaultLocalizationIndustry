# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/wasm/WasmCode.h
# Commit: 9a162cc369e3
# Full Hash: 9a162cc369e3b6f51f5767924e63d46539c4f631
# Author: Julien Pages <jpages@mozilla.com>
# Date: 2025-02-22 09:14:45
# Regressor Bug: 1861078
# File Overlap Count: 1
# Description:
#   Bug 1861078 - wasm: make metadata offsets relative to CodeBlock->codeBase. r=rhunt
#   
#   Metadata used offsets to the beginning of code segment. Change that to use
#   offsets relative to the beginning of CodeBlock. This allows us to avoid offseting
#   metadata later on and prepare the work for simplification of stackmaps.
# ==============================================================================

diff -r e543a77786c9 -r 9a162cc369e3 js/src/wasm/WasmCode.h
--- a/js/src/wasm/WasmCode.h	Fri Feb 21 17:09:51 2025 +0000
+++ b/js/src/wasm/WasmCode.h	Fri Feb 21 17:17:58 2025 +0000
@@ -561,21 +561,20 @@
 
   // The code segment our JIT code is within.
   SharedCodeSegment segment;
-  // The sub-range of the code segment our JIT code is within.
-  const uint8_t* codeBase;
+
+  // Pointer to the beginning of the CodeBlock.
+  uint8_t* codeBase;
   size_t codeLength;
 
   // Metadata about the code we have contributed to the segment.
   //
   // * `funcToCodeRange` does not involve code locations.
   //
-  // * `stackMaps` specifies code locations directly, in
-  //   StackMaps::Maplet::nextInsnAddr.
+  // * `stackMaps` specifies code locations directly, in nextInsnAddr.
   //
   // * All 6 other fields specify a code locations in by carrying an offset
   //   which is interpreted to be relative to the start of the containing
-  //   segment, *not* relative to `CodeBlock::codeBase`.  That is, the denoted
-  //   address is `segment->base() + ..offset...`.
+  //   CodeBlock::codeBase.
   //
   FuncToCodeRangeMap funcToCodeRange;
   CodeRangeVector codeRanges;
@@ -637,10 +636,7 @@
            kind == CodeBlockKind::OptimizedTier;
   }
 
-  // Add an offset to the metadata.  See comment above.
-  void offsetMetadataBy(uint32_t delta);
-
-  const uint8_t* base() const { return codeBase; }
+  uint8_t* base() const { return codeBase; }
   uint32_t length() const { return codeLength; }
   bool containsCodePC(const void* pc) const {
     return pc >= base() && pc < (base() + length());
@@ -1170,7 +1166,7 @@
                      uint8_t** codeBase) const {
     const CodeBlock& codeBlock = funcCodeBlock(funcIndex);
     *range = &codeBlock.codeRanges[codeBlock.funcToCodeRange[funcIndex]];
-    *codeBase = codeBlock.segment->base();
+    *codeBase = codeBlock.base();
   }
 
   const LinkData* codeBlockLinkData(const CodeBlock& block) const;