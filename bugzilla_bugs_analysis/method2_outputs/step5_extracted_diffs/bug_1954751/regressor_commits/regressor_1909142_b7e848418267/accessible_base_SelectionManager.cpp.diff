# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/base/SelectionManager.cpp
# Commit: b7e848418267
# Full Hash: b7e8484182677bf5b60bc3462476b48159b307d4
# Author: James Teh <jteh@mozilla.com>
# Date: 2025-02-10 21:39:27
# Regressor Bug: 1909142
# File Overlap Count: 1
# Description:
#   Bug 1909142 part 2: Expose custom highlights via accessibility APIs. r=morgan
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D233806
# ==============================================================================

diff -r 21dc535e2ebf -r b7e848418267 accessible/base/SelectionManager.cpp
--- a/accessible/base/SelectionManager.cpp	Mon Feb 10 10:19:47 2025 +0000
+++ b/accessible/base/SelectionManager.cpp	Mon Feb 10 10:24:15 2025 +0000
@@ -203,14 +203,20 @@
 bool SelectionManager::SelectionRangeChanged(SelectionType aType,
                                              const dom::AbstractRange& aRange) {
   if (aType != SelectionType::eSpellCheck &&
-      aType != SelectionType::eTargetText) {
+      aType != SelectionType::eTargetText &&
+      aType != SelectionType::eHighlight) {
     // We don't need to handle range changes for this selection type.
     return false;
   }
   if (!GetAccService()) {
     return false;
   }
-  dom::Document* doc = aRange.GetStartContainer()->OwnerDoc();
+  nsINode* start = aRange.GetStartContainer();
+  if (!start) {
+    // This can happen when the document is being cleaned up.
+    return false;
+  }
+  dom::Document* doc = start->OwnerDoc();
   MOZ_ASSERT(doc);
   nsINode* node = aRange.GetClosestCommonInclusiveAncestor();
   HyperTextAccessible* acc = nsAccUtils::GetTextContainer(node);