# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/notification/test/mochitest/test_notification_tag.html
# Commit: f9f3e107f36c
# Full Hash: f9f3e107f36c8cce438711ecef1b1a9574ae8f93
# Author: Kagami Sascha Rosylight <saschanaz@outlook.com>
# Date: 2025-03-22 09:02:07
# Regressor Bug: 1948339
# File Overlap Count: 2
# Description:
#   Bug 1948339 - Part 2: Add NotificationObserver r=asuth
#   
#   This also makes page-bound notifications to not be stored via NotificationStorage.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D240642
# ==============================================================================

diff -r b84ed8a9da4c -r f9f3e107f36c dom/notification/test/mochitest/test_notification_tag.html
--- a/dom/notification/test/mochitest/test_notification_tag.html	Fri Mar 21 09:52:31 2025 +0000
+++ b/dom/notification/test/mochitest/test_notification_tag.html	Fri Mar 21 09:52:31 2025 +0000
@@ -39,7 +39,8 @@
 
     const storageGet = (origin) => {
       const { promise, resolve } = Promise.withResolvers();
-      notificationStorage.get(origin, "", "", notifications => {
+      const scope = new URL("/tests/dom/notification/test/mochitest/", origin).toString();
+      notificationStorage.get(origin, scope, "", notifications => {
         resolve(notifications.map(({ id }) => id));
       });
       return promise;
@@ -144,6 +145,10 @@
     async function showNotifications() {
       await MockAlertsService.register();
 
+      // The windows below will register service workers but unregistering each would be tricky.
+      // Let's clean it up here for all.
+      SimpleTest.registerCleanupFunction(() => SpecialPowers.removeAllServiceWorkerData());
+
       // Load two frames with the same origin that create notification with the same tag.
       // Both pages should generate notifications with the same name, and thus the second
       // notification should replace the first.
