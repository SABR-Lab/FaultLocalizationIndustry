# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/generic/nsCanvasFrame.cpp
# Commit: 01cecf5bf7e5
# Full Hash: 01cecf5bf7e5603d5d7ebe4c28d8fdc0a74e6b51
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-03-25 21:02:33
# Regressor Bug: 1955697
# File Overlap Count: 1
# Description:
#   Bug 1955697 - Simplify scrolled canvas background painting. r=mstange
#   
#   Always paint the scrolled canvas background if it's CSS-specified.
#   
#   Compute the canvas background upfront so we don't need to walk the
# ==============================================================================

diff -r 892e1da580c2 -r 01cecf5bf7e5 layout/generic/nsCanvasFrame.cpp
--- a/layout/generic/nsCanvasFrame.cpp	Tue Mar 25 08:09:49 2025 +0000
+++ b/layout/generic/nsCanvasFrame.cpp	Tue Mar 25 08:09:57 2025 +0000
@@ -287,6 +287,13 @@
 
 Element* nsCanvasFrame::GetDefaultTooltip() { return mTooltipContent; }
 
+nsDisplayCanvasBackgroundColor::nsDisplayCanvasBackgroundColor(
+    nsDisplayListBuilder* aBuilder, nsIFrame* aFrame)
+    : nsDisplaySolidColorBase(
+          aBuilder, aFrame,
+          aFrame->PresShell()->GetCSSSpecifiedCanvasBackground(
+              aFrame->GetParent()->IsPageContentFrame())) {}
+
 void nsDisplayCanvasBackgroundColor::Paint(nsDisplayListBuilder* aBuilder,
                                            gfxContext* aCtx) {
   if (!NS_GET_A(mColor)) {
@@ -547,25 +554,10 @@
     layerItems.AppendToTop(&thisItemList);
   }
 
-  bool hasFixedBottomLayer =
-      layers.mImageCount > 0 &&
-      layers.mLayers[0].mAttachment == StyleImageLayerAttachment::Fixed;
-
   nsDisplayList list(aBuilder);
 
-  if (!hasFixedBottomLayer || needBlendContainer) {
-    // Put a scrolled background color item in place, at the bottom of the
-    // list. The color of this item will be filled in during
-    // PresShell::AddCanvasBackgroundColorItem.
-    // Do not add this item if there's a fixed background image at the bottom
-    // (unless we have to, for correct blending); with a fixed background,
-    // it's better to allow the fixed background image to combine itself with
-    // a non-scrolled background color directly underneath, rather than
-    // interleaving the two with a scrolled background color.
-    // PresShell::AddCanvasBackgroundColorItem makes sure there always is a
-    // non-scrolled background color item at the bottom.
-    list.AppendNewToTop<nsDisplayCanvasBackgroundColor>(aBuilder, this);
-  }
+  // Put a scrolled background color item in place, at the bottom of the list.
+  list.AppendNewToTop<nsDisplayCanvasBackgroundColor>(aBuilder, this);
 
   list.AppendToTop(&layerItems);
 