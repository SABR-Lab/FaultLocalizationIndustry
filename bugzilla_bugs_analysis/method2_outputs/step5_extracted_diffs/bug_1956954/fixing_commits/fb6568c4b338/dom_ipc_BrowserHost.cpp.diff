# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/ipc/BrowserHost.cpp
# Commit: fb6568c4b338
# Full Hash: fb6568c4b33879ef9c1a41c86f4df0c14fe0f0df
# Author: Nika Layzell <nika@thelayzells.com>
# Date: 2025-05-05 21:47:27
# Description:
#   Bug 1956954 - ValidatePrincipal in CreateAboutBlankDocumentViewer calls, r=smaug
#   
#   This should avoid the content crash by blocking the initial
#   createAboutBlankDocumentViewer call and throwing an exception instead of
#   crashing the content process.
# ==============================================================================

diff -r 48b0e94035f8 -r fb6568c4b338 dom/ipc/BrowserHost.cpp
--- a/dom/ipc/BrowserHost.cpp	Fri May 02 19:45:58 2025 +0000
+++ b/dom/ipc/BrowserHost.cpp	Fri May 02 19:53:14 2025 +0000
@@ -254,6 +254,14 @@
     return NS_OK;
   }
 
+  // Before creating the viewer in-content, ensure that the process is allowed
+  // to load this principal.
+  if (NS_WARN_IF(!mRoot->Manager()->ValidatePrincipal(aPrincipal))) {
+    ContentParent::LogAndAssertFailedPrincipalValidationInfo(
+        aPrincipal, "BrowserHost::CreateAboutBlankDocumentViewer");
+    return NS_ERROR_DOM_SECURITY_ERR;
+  }
+
   // Ensure the content process has permisisons for the new document we're about
   // to create in it.
   nsresult rv = GetContentParent()->TransmitPermissionsForPrincipal(aPrincipal);
