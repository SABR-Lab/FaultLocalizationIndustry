# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/security/SRICheck.cpp
# Commit: ebc6b2685ede
# Full Hash: ebc6b2685ede6059d3acf880a837783061777270
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-02-22 09:14:45
# Regressor Bug: 1948887
# File Overlap Count: 1
# Description:
#   Bug 1948887 - Allow parsing sheets with SRI metadata off the main thread. r=dshin
#   
#   Flush reports when back on the main thread, and stash the tainting
#   around since LoadInfo is main-thread only.
#   
# ==============================================================================

diff -r 57759a2ddebc -r ebc6b2685ede dom/security/SRICheck.cpp
--- a/dom/security/SRICheck.cpp	Fri Feb 21 15:06:55 2025 +0000
+++ b/dom/security/SRICheck.cpp	Fri Feb 21 15:09:28 2025 +0000
@@ -52,20 +52,15 @@
     return NS_OK;
   }
 
-  nsCOMPtr<nsIURI> finalURI;
-  nsresult rv = NS_GetFinalChannelURI(aChannel, getter_AddRefs(finalURI));
-  NS_ENSURE_SUCCESS(rv, rv);
   nsCOMPtr<nsIURI> originalURI;
-  rv = aChannel->GetOriginalURI(getter_AddRefs(originalURI));
+  nsresult rv = aChannel->GetOriginalURI(getter_AddRefs(originalURI));
   NS_ENSURE_SUCCESS(rv, rv);
   nsAutoCString requestSpec;
   rv = originalURI->GetSpec(requestSpec);
   NS_ENSURE_SUCCESS(rv, rv);
 
   if (MOZ_LOG_TEST(SRILogHelper::GetSriLog(), mozilla::LogLevel::Debug)) {
-    SRILOG(("SRICheck::IsEligible, requestURI=%s; finalURI=%s",
-            requestSpec.get(),
-            finalURI ? finalURI->GetSpecOrDefault().get() : ""));
+    SRILOG(("SRICheck::IsEligible, requestURI=%s", requestSpec.get()));
   }
 
   // Is the sub-resource same-origin?
@@ -203,6 +198,10 @@
   return NS_OK;
 }
 
+nsresult SRICheckDataVerifier::Update(Span<const uint8_t> aBytes) {
+  return Update(aBytes.size(), aBytes.data());
+}
+
 nsresult SRICheckDataVerifier::Update(uint32_t aStringLen,
                                       const uint8_t* aString) {
   NS_ENSURE_ARG_POINTER(aString);
@@ -312,12 +311,22 @@
                                       nsIChannel* aChannel,
                                       const nsACString& aSourceFileURI,
                                       nsIConsoleReportCollector* aReporter) {
+  MOZ_ASSERT(aChannel);
+  nsCOMPtr loadInfo = aChannel->LoadInfo();
+  return Verify(aMetadata, aChannel, loadInfo->GetTainting(), aSourceFileURI,
+                aReporter);
+}
+
+nsresult SRICheckDataVerifier::Verify(const SRIMetadata& aMetadata,
+                                      nsIChannel* aChannel,
+                                      LoadTainting aLoadTainting,
+                                      const nsACString& aSourceFileURI,
+                                      nsIConsoleReportCollector* aReporter) {
   NS_ENSURE_ARG_POINTER(aReporter);
 
   if (MOZ_LOG_TEST(SRILogHelper::GetSriLog(), mozilla::LogLevel::Debug)) {
     nsAutoCString requestURL;
-    nsCOMPtr<nsIRequest> request = aChannel;
-    request->GetName(requestURL);
+    aChannel->GetName(requestURL);
     SRILOG(("SRICheckDataVerifier::Verify, url=%s (length=%zu)",
             requestURL.get(), mBytesHashed));
   }
@@ -325,10 +334,8 @@
   nsresult rv = Finish();
   NS_ENSURE_SUCCESS(rv, rv);
 
-  nsCOMPtr<nsILoadInfo> loadInfo = aChannel->LoadInfo();
-  LoadTainting tainting = loadInfo->GetTainting();
-
-  if (NS_FAILED(IsEligible(aChannel, tainting, aSourceFileURI, aReporter))) {
+  if (NS_FAILED(
+          IsEligible(aChannel, aLoadTainting, aSourceFileURI, aReporter))) {
     return NS_ERROR_SRI_NOT_ELIGIBLE;
   }
 