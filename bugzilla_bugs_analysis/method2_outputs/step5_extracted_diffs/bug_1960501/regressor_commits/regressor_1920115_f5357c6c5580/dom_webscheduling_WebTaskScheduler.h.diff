# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/webscheduling/WebTaskScheduler.h
# Commit: f5357c6c5580
# Full Hash: f5357c6c558088e4d28f89f2bf87bf6f05a7c5b5
# Author: Sean Feng <sefeng@mozilla.com>
# Date: 2025-02-25 09:30:56
# Regressor Bug: 1920115
# File Overlap Count: 2
# Description:
#   Bug 1920115 - Fix a bug where AbortController doesn't abort scheduler.yield r=smaug
#   
#   Instead of passing a single `AbortSignal` argument to `CreateTask`,
#   we now separate it into a `AbortSignal` and a `TaskSignal`. They
#   could be the same when `TaskController` is used, and if its
# ==============================================================================

diff -r 6a8cb3cc704e -r f5357c6c5580 dom/webscheduling/WebTaskScheduler.h
--- a/dom/webscheduling/WebTaskScheduler.h	Mon Feb 24 19:31:29 2025 +0000
+++ b/dom/webscheduling/WebTaskScheduler.h	Mon Feb 24 19:31:29 2025 +0000
@@ -43,9 +43,9 @@
   }
 
   AbortSignal* GetAbortSource() { return mAbortSource; }
-  AbortSignal* GetPrioritySource() { return mPrioritySource; }
+  TaskSignal* GetPrioritySource() { return mPrioritySource; }
 
-  void SetPrioritySource(AbortSignal* aPrioritySource) {
+  void SetPrioritySource(TaskSignal* aPrioritySource) {
     MOZ_ASSERT(aPrioritySource->IsTaskSignal());
     mPrioritySource = aPrioritySource;
   }
@@ -54,7 +54,7 @@
   ~WebTaskSchedulingState() = default;
 
   RefPtr<AbortSignal> mAbortSource;
-  RefPtr<AbortSignal> mPrioritySource;
+  RefPtr<TaskSignal> mPrioritySource;
 };
 
 class WebTaskQueueHashKey : public PLDHashEntryHdr {
@@ -309,16 +309,16 @@
   };
 
   already_AddRefed<WebTask> CreateTask(
-      const Optional<OwningNonNull<AbortSignal>>& aSignal,
+      AbortSignal* aAbortSignal, TaskSignal* aTaskSignal,
       const Optional<TaskPriority>& aPriority, const bool aIsContinuation,
       const Maybe<SchedulerPostTaskCallback&>& aCallback,
       WebTaskSchedulingState* aSchedulingState, Promise* aPromise);
 
   bool DispatchTask(WebTask* aTask, EventQueuePriority aPriority);
 
-  SelectedTaskQueueData SelectTaskQueue(
-      const Optional<OwningNonNull<AbortSignal>>& aSignal,
-      const Optional<TaskPriority>& aPriority, const bool aIsContinuation);
+  SelectedTaskQueueData SelectTaskQueue(TaskSignal* aSignal,
+                                        const Optional<TaskPriority>& aPriority,
+                                        const bool aIsContinuation);
 
   virtual nsresult SetTimeoutForDelayedTask(WebTask* aTask, uint64_t aDelay,
                                             EventQueuePriority aPriority) = 0;