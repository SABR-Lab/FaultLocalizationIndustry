# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/TouchEvents.h
# Commit: 37f6acd499b1
# Full Hash: 37f6acd499b11386a9c97f5783c89c4908692029
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2025-05-16 16:19:07
# Regressor Bug: 1550462
# File Overlap Count: 1
# Description:
#   Bug 1550462 - part 2: Make PresShell::HandleEvent dispatch preceding pointerrawupdate event r=smaug,dom-core,edgar
#   
#   This patch tries to dispatch ePointerRawUpdate with
#   PresShell::EventHandler::DispatchPrecedingPointerEvent as same as usual
#   pointer events.
# ==============================================================================

diff -r 32ba02fa32ec -r 37f6acd499b1 widget/TouchEvents.h
--- a/widget/TouchEvents.h	Fri May 16 09:49:43 2025 +0000
+++ b/widget/TouchEvents.h	Fri May 16 09:49:44 2025 +0000
@@ -151,13 +151,23 @@
 
   MOZ_COUNTED_DEFAULT_CTOR(WidgetTouchEvent)
 
-  WidgetTouchEvent(const WidgetTouchEvent& aOther)
+  enum class CloneTouches : bool { No, Yes };
+  WidgetTouchEvent(const WidgetTouchEvent& aOther,
+                   CloneTouches aCloneTouches = CloneTouches::No)
       : WidgetInputEvent(aOther.IsTrusted(), aOther.mMessage, aOther.mWidget,
                          eTouchEventClass) {
     MOZ_COUNT_CTOR(WidgetTouchEvent);
     mModifiers = aOther.mModifiers;
     mTimeStamp = aOther.mTimeStamp;
-    mTouches.AppendElements(aOther.mTouches);
+    if (static_cast<bool>(aCloneTouches)) {
+      mTouches.SetCapacity(aOther.mTouches.Length());
+      for (const RefPtr<dom::Touch>& touch : aOther.mTouches) {
+        RefPtr<dom::Touch> clonedTouch = new dom::Touch(*touch);
+        mTouches.AppendElement(std::move(clonedTouch));
+      }
+    } else {
+      mTouches.AppendElements(aOther.mTouches);
+    }
     mInputSource = aOther.mInputSource;
     mButton = aOther.mButton;
     mButtons = aOther.mButtons;
@@ -213,6 +223,20 @@
     mTouches.AppendElements(aEvent.mTouches);
     mInputSource = aEvent.mInputSource;
   }
+
+  void SetConvertToPointerRawUpdate(bool aConvert) {
+    for (dom::Touch* const touch : mTouches) {
+      touch->convertToPointerRawUpdate = aConvert;
+    }
+  }
+  [[nodiscard]] bool CanConvertToPointerRawUpdate() const {
+    for (const dom::Touch* const touch : mTouches) {
+      if (touch->convertToPointerRawUpdate) {
+        return true;
+      }
+    }
+    return false;
+  }
 };
 
 }  // namespace mozilla