# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/cookie/CookieParser.cpp
# Commit: d01a1a055fec
# Full Hash: d01a1a055fece12b906b938954f984bd69278ef7
# Author: Andrea Marchesini <amarchesini@mozilla.com>
# Date: 2025-04-30 20:49:53
# Regressor Bug: 1960824
# File Overlap Count: 1
# Description:
#   Bug 1960824 - Introduce nsICookie::SAMESITE_UNSET, r=edgul,webdriver-reviewers,extension-reviewers,cookie-reviewers,valentin,Sasha,robwu
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D246638
# ==============================================================================

diff -r 307ff391dd02 -r d01a1a055fec netwerk/cookie/CookieParser.cpp
--- a/netwerk/cookie/CookieParser.cpp	Wed Apr 30 08:53:12 2025 +0000
+++ b/netwerk/cookie/CookieParser.cpp	Wed Apr 30 08:59:18 2025 +0000
@@ -355,12 +355,6 @@
   }
 }
 
-static inline void SetSameSiteAttribute(CookieStruct& aCookieData,
-                                        int32_t aValue) {
-  aCookieData.sameSite() = aValue;
-  aCookieData.rawSameSite() = aValue;
-}
-
 // Tests for control characters, defined by RFC 5234 to be %x00-1F / %x7F.
 // An exception is made for HTAB as the cookie spec treats that as whitespace.
 static bool ContainsControlChars(const nsACString& aString) {
@@ -372,13 +366,6 @@
          }) != end;
 }
 
-static inline void SetSameSiteAttributeDefault(CookieStruct& aCookieData) {
-  // Set cookie with SameSite attribute that is treated as Default
-  // and doesn't requires changing the DB schema.
-  aCookieData.sameSite() = nsICookie::SAMESITE_LAX;
-  aCookieData.rawSameSite() = nsICookie::SAMESITE_NONE;
-}
-
 // static
 bool CookieParser::CheckAttributeSize(const nsACString& currentValue,
                                       const char* aAttribute,
@@ -428,8 +415,7 @@
   mCookieData.isSecure() = false;
   mCookieData.isHttpOnly() = false;
   mCookieData.isPartitioned() = false;
-
-  SetSameSiteAttributeDefault(mCookieData);
+  mCookieData.sameSite() = nsICookie::SAMESITE_UNSET;
 
   nsDependentCSubstring tokenString(cookieStart, cookieStart);
   nsDependentCSubstring tokenValue(cookieStart, cookieStart);
@@ -493,14 +479,14 @@
 
     } else if (tokenString.LowerCaseEqualsLiteral(kSameSite)) {
       if (tokenValue.LowerCaseEqualsLiteral(kSameSiteLax)) {
-        SetSameSiteAttribute(mCookieData, nsICookie::SAMESITE_LAX);
+        mCookieData.sameSite() = nsICookie::SAMESITE_LAX;
       } else if (tokenValue.LowerCaseEqualsLiteral(kSameSiteStrict)) {
-        SetSameSiteAttribute(mCookieData, nsICookie::SAMESITE_STRICT);
+        mCookieData.sameSite() = nsICookie::SAMESITE_STRICT;
       } else if (tokenValue.LowerCaseEqualsLiteral(kSameSiteNone)) {
-        SetSameSiteAttribute(mCookieData, nsICookie::SAMESITE_NONE);
+        mCookieData.sameSite() = nsICookie::SAMESITE_NONE;
       } else {
         // Reset to Default if unknown token value (see Bug 1682450)
-        SetSameSiteAttributeDefault(mCookieData);
+        mCookieData.sameSite() = nsICookie::SAMESITE_UNSET;
         mWarnings.mInvalidSameSiteAttribute = true;
       }
     }
@@ -530,8 +516,7 @@
     return;
   }
 
-  if (mCookieData.rawSameSite() == nsICookie::SAMESITE_NONE &&
-      mCookieData.sameSite() == nsICookie::SAMESITE_LAX) {
+  if (mCookieData.sameSite() == nsICookie::SAMESITE_UNSET) {
     bool laxByDefault =
         StaticPrefs::network_cookie_sameSite_laxByDefault() &&
         !nsContentUtils::IsURIInPrefList(
@@ -546,8 +531,6 @@
 
   // Cookie accepted.
   aAcceptedByParser = true;
-
-  MOZ_ASSERT(Cookie::ValidateSameSite(mCookieData));
 }
 
 namespace {
@@ -1005,10 +988,13 @@
       StaticPrefs::network_cookie_sameSite_laxByDefault() &&
       !nsContentUtils::IsURIInPrefList(
           mHostURI, "network.cookie.sameSite.laxByDefault.disabledHosts");
-  auto effectiveSameSite =
-      laxByDefault ? mCookieData.sameSite() : mCookieData.rawSameSite();
-  if ((effectiveSameSite != nsICookie::SAMESITE_NONE) &&
-      aIsForeignAndNotAddon) {
+  uint32_t sameSite = mCookieData.sameSite();
+  if (sameSite == nsICookie::SAMESITE_UNSET) {
+    sameSite =
+        laxByDefault ? nsICookie::SAMESITE_LAX : nsICookie::SAMESITE_NONE;
+  }
+
+  if (sameSite != nsICookie::SAMESITE_NONE && aIsForeignAndNotAddon) {
     COOKIE_LOGFAILURE(SET_COOKIE, mHostURI, mCookieString,
                       "failed the samesite tests");
     RejectCookie(RejectedForNonSameSiteness);