# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: xpcom/base/CycleCollectedJSRuntime.cpp
# Commit: 5a65d2960e0d
# Full Hash: 5a65d2960e0d088d5f9b7ec573e6970014b58687
# Author: Matthew Gaudet <mgaudet@mozilla.com>
# Date: 2025-05-16 09:19:19
# Regressor Bug: 1964451
# File Overlap Count: 1
# Description:
#   Bug 1964451 - Add use counters for OOM handling r=sfink,mccr8
#   
#   So the goal here is that we get OOM data where processes survive long enough
#   send telemetry. To get the case where processes -crash- we'll also have to
#   get crash data. See Bug 1964092 for that half.
# ==============================================================================

diff -r 2f8d1dbbacf6 -r 5a65d2960e0d xpcom/base/CycleCollectedJSRuntime.cpp
--- a/xpcom/base/CycleCollectedJSRuntime.cpp	Thu May 15 19:59:25 2025 +0000
+++ b/xpcom/base/CycleCollectedJSRuntime.cpp	Thu May 15 20:04:27 2025 +0000
@@ -1992,7 +1992,13 @@
 
 void CycleCollectedJSRuntime::AnnotateAndSetOutOfMemory(OOMState* aStatePtr,
                                                         OOMState aNewState) {
+  enum class Size { Large, Small };
+
+  Size size = aStatePtr == &mOutOfMemoryState ? Size::Small : Size::Large;
+  MOZ_ASSERT_IF(size == Size::Large, aStatePtr == &mLargeAllocationFailureState);
+
   *aStatePtr = aNewState;
+
   CrashReporter::Annotation annotation =
       (aStatePtr == &mOutOfMemoryState)
           ? CrashReporter::Annotation::JSOutOfMemory
@@ -2000,6 +2006,29 @@
 
   CrashReporter::RecordAnnotationCString(annotation,
                                          OOMStateToString(aNewState));
+
+  // Attempt to report telemetry.
+  if (JSObject* global = JS::CurrentGlobalOrNull(GetContext()->Context())) {
+    if (aNewState == OOMState::Recovered) {
+      switch (size) {
+        case Size::Large:
+          SetUseCounter(global, eUseCounter_custom_JS_large_oom_recovered);
+          break;
+        case Size::Small:
+          SetUseCounter(global, eUseCounter_custom_JS_small_oom_recovered);
+          break;
+      }
+    } else {
+      switch (size) {
+        case Size::Large:
+          SetUseCounter(global, eUseCounter_custom_JS_large_oom_reported);
+          break;
+        case Size::Small:
+          SetUseCounter(global, eUseCounter_custom_JS_small_oom_reported);
+          break;
+      }
+    }
+  }
 }
 
 void CycleCollectedJSRuntime::OnGC(JSContext* aContext, JSGCStatus aStatus,
