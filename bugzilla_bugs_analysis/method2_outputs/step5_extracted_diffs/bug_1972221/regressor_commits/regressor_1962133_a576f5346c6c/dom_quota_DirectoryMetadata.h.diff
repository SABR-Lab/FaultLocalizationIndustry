# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/quota/DirectoryMetadata.h
# Commit: a576f5346c6c
# Full Hash: a576f5346c6cfc32a5b147158e48ec1f4fcf2a8f
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2025-06-12 16:31:09
# Regressor Bug: 1962133
# File Overlap Count: 5
# Description:
#   Bug 1962133 - QM: Prepare metadata header infrastructure for accessed flag addition and reduce duplication; r=dom-storage-reviewers,hsingh
#   
#   This patch restructures metadata header reading and writing code to reduce
#   duplication and establish clean infrastructure for adding the accessed flag to
#   the metadata file header.
# ==============================================================================

diff -r f4284b0494fc -r a576f5346c6c dom/quota/DirectoryMetadata.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/quota/DirectoryMetadata.h	Wed Jun 11 20:09:11 2025 +0000
@@ -0,0 +1,93 @@
+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=8 sts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,
+ * You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef DOM_QUOTA_DIRECTORYMETADATA_H_
+#define DOM_QUOTA_DIRECTORYMETADATA_H_
+
+#include <cstdint>
+
+enum class nsresult : uint32_t;
+
+class nsIBinaryInputStream;
+class nsIBinaryOutputStream;
+class nsIFile;
+
+namespace mozilla {
+
+template <typename V, typename E>
+class Result;
+
+}
+
+namespace mozilla::dom::quota {
+
+struct OriginStateMetadata;
+
+/**
+ * Directory Metadata File Format (.metadata-v2)
+ *
+ * The metadata file is a binary file containing metadata information for an
+ * origin directory. It consists of a header and several additional fields,
+ * some of which are maintained only for backward compatibility.
+ *
+ * Header (OriginStateMetadata):
+ * - int64_t mLastAccessTime
+ *     The last access time of the origin in microseconds since the epoch.
+ * - bool mPersisted
+ *     True if the origin is marked as persisted and should survive origin
+ *     eviction.
+ * - uint32_t reservedData1
+ *     Reserved for future use. Must be zero. Validation fails if nonzero.
+ * - uint32_t reservedData2
+ *     Reserved for future use. Currently ignored.
+ *
+ * Legacy fields (still written and read for backward compatibility, but no
+ * longer used):
+ * - nsCString mSuffix
+ *     Originally used for origin attributes. Still written to preserve
+ *     compatibility.
+ * - nsCString mGroup
+ *     Originally used for quota group. Still written to preserve
+ *     compatibility.
+ *
+ * Storage fields:
+ * - nsCString mStorageOrigin
+ *     Storage origin string (actively used for reconstructing the principal).
+ *
+ * Legacy fields (continued):
+ * - bool mIsPrivate
+ *     Flag originally used for private browsing contexts or apps. Still
+ *     written.
+ *
+ * Validation check:
+ * - After reading all expected fields, any additional data (even a single
+ *   32-bit value) is treated as an error.
+ *
+ * Notes:
+ * - OriginStateMetadata is loaded first and interpreted independently. This
+ *   allows fast and safe updates to the metadata header on disk without
+ *   rewriting the full file.
+ * - The header is intentionally designed to contain only fixed-size fields.
+ *   This allows updating the header in-place without creating a temporary
+ *   file.
+ */
+
+Result<OriginStateMetadata, nsresult> ReadDirectoryMetadataHeader(
+    nsIBinaryInputStream& aStream);
+
+nsresult WriteDirectoryMetadataHeader(
+    nsIBinaryOutputStream& aStream,
+    const OriginStateMetadata& aOriginStateMetadata);
+
+Result<OriginStateMetadata, nsresult> LoadDirectoryMetadataHeader(
+    nsIFile& aDirectory);
+
+nsresult SaveDirectoryMetadataHeader(
+    nsIFile& aDirectory, const OriginStateMetadata& aOriginStateMetadata);
+
+}  // namespace mozilla::dom::quota
+
+#endif  // DOM_QUOTA_NOTIFYUTILS_H_