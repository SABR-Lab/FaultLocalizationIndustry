# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: layout/painting/nsDisplayList.cpp
# Commit: 4022112ed77b
# Full Hash: 4022112ed77b0e7998e9fdfdcd0a048f4cabffce
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-03-26 09:13:23
# Regressor Bug: 1953823
# File Overlap Count: 2
# Description:
#   Bug 1953823 - When the root is snapshotted, snapshot the root contents but not top layer(s). r=view-transitions-reviewers,boris
#   
#   For fallback snapshots, for now just snapshot the canvas frame.
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D242016
# ==============================================================================

diff -r 81ebaa847d42 -r 4022112ed77b layout/painting/nsDisplayList.cpp
--- a/layout/painting/nsDisplayList.cpp	Tue Mar 25 13:49:21 2025 +0000
+++ b/layout/painting/nsDisplayList.cpp	Tue Mar 25 14:03:19 2025 +0000
@@ -89,6 +89,7 @@
 #include "mozilla/gfx/gfxVars.h"
 #include "ActiveLayerTracker.h"
 #include "nsEscape.h"
+#include "nsPresContextInlines.h"
 #include "nsPrintfCString.h"
 #include "UnitTransforms.h"
 #include "LayerAnimationInfo.h"
@@ -5209,7 +5210,6 @@
     const StackingContextHelper& aSc, RenderRootStateManager* aManager,
     nsDisplayListBuilder* aDisplayListBuilder) {
   Maybe<wr::WrAnimationProperty> prop;
-  Maybe<wr::SnapshotInfo> snapshot;
   const bool needsProp = aManager->LayerManager()->AsyncPanZoomEnabled() &&
                          (IsScrollThumbLayer() || IsZoomingLayer() ||
                           ShouldGetFixedAnimationId() ||
@@ -5239,28 +5239,6 @@
   if (rootScrollbarContainer) {
     params.prim_flags |= wr::PrimitiveFlags::IS_SCROLLBAR_CONTAINER;
   }
-  if (mFrame->HasAnyStateBits(NS_FRAME_CAPTURED_IN_VIEW_TRANSITION)) {
-    auto key = [&]() -> Maybe<wr::SnapshotImageKey> {
-      auto* vt = mFrame->PresContext()->Document()->GetActiveViewTransition();
-      if (NS_WARN_IF(!vt)) {
-        return Nothing();
-      }
-      const auto* key =
-          vt->GetImageKeyForCapturedFrame(mFrame, aManager, aResources);
-      return key ? Some(wr::SnapshotImageKey{*key}) : Nothing();
-    }();
-    if (key) {
-      float auPerDevPixel = mFrame->PresContext()->AppUnitsPerDevPixel();
-      snapshot.emplace(wr::SnapshotInfo{
-          .key = *key,
-          .area = wr::ToLayoutRect(LayoutDeviceRect::FromAppUnits(
-              mFrame->InkOverflowRectRelativeToSelf() + ToReferenceFrame(),
-              auPerDevPixel)),
-          .detached = true,
-      });
-      params.snapshot = snapshot.ptr();
-    }
-  }
   if (IsZoomingLayer() || ShouldGetFixedAnimationId() ||
       (rootScrollbarContainer && HasDynamicToolbar())) {
     params.is_2d_scale_translation = true;
@@ -5331,6 +5309,45 @@
                  .get();
 }
 
+bool nsDisplayViewTransitionCapture::CreateWebRenderCommands(
+    wr::DisplayListBuilder& aBuilder, wr::IpcResourceUpdateQueue& aResources,
+    const StackingContextHelper& aSc, RenderRootStateManager* aManager,
+    nsDisplayListBuilder* aDisplayListBuilder) {
+  Maybe<wr::SnapshotInfo> si;
+  nsPresContext* pc = mFrame->PresContext();
+  nsIFrame* capturedFrame =
+      mIsRoot ? pc->FrameConstructor()->GetRootElementStyleFrame() : mFrame;
+  const auto captureRect = mIsRoot
+                               ? ViewTransition::SnapshotContainingBlockRect(pc)
+                               : mFrame->InkOverflowRectRelativeToSelf();
+  auto key = [&]() -> Maybe<wr::SnapshotImageKey> {
+    auto* vt = pc->Document()->GetActiveViewTransition();
+    if (NS_WARN_IF(!vt)) {
+      return Nothing();
+    }
+    const auto* key =
+        vt->GetImageKeyForCapturedFrame(capturedFrame, aManager, aResources);
+    return key ? Some(wr::SnapshotImageKey{*key}) : Nothing();
+  }();
+  wr::StackingContextParams params;
+  params.clip =
+      wr::WrStackingContextClip::ClipChain(aBuilder.CurrentClipChainId());
+  if (key) {
+    si.emplace(wr::SnapshotInfo{
+        .key = *key,
+        .area = wr::ToLayoutRect(LayoutDeviceRect::FromAppUnits(
+            captureRect + ToReferenceFrame(), pc->AppUnitsPerDevPixel())),
+        .detached = true,
+    });
+    params.snapshot = si.ptr();
+  }
+  StackingContextHelper sc(aSc, GetActiveScrolledRoot(), mFrame, this, aBuilder,
+                           params);
+  nsDisplayWrapList::CreateWebRenderCommands(aBuilder, aResources, sc, aManager,
+                                             aDisplayListBuilder);
+  return true;
+}
+
 nsDisplaySubDocument::nsDisplaySubDocument(nsDisplayListBuilder* aBuilder,
                                            nsIFrame* aFrame,
                                            nsSubDocumentFrame* aSubDocFrame,