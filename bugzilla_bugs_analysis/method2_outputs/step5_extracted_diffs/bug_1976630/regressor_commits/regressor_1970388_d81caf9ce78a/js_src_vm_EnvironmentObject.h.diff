# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/src/vm/EnvironmentObject.h
# Commit: d81caf9ce78a
# Full Hash: d81caf9ce78a11c3bb82900a4b6b07dddbabd80e
# Author: Sandor Molnar <smolnar@mozilla.com>
# Date: 2025-07-04 09:11:29
# Regressor Bug: 1970388
# File Overlap Count: 1
# Description:
#   Revert "Bug 1970388 - Part 2: Reflect the enclosing environment to MissingEnvironmentMap. r=bthrall" for causing bug 1975376
#   
#   This reverts commit beba2f2d7c6ccb71e99f40346c9a8f55415ac442.
#   
#   Revert "Bug 1970388 - Part 1: Add more info to EnvironmentObject::dump. r=bthrall"
# ==============================================================================

diff -r c83184b73e25 -r d81caf9ce78a js/src/vm/EnvironmentObject.h
--- a/js/src/vm/EnvironmentObject.h	Fri Jul 04 04:01:01 2025 +0000
+++ b/js/src/vm/EnvironmentObject.h	Fri Jul 04 07:16:56 2025 +0300
@@ -1250,69 +1250,35 @@
   AbstractFramePtr maybeInitialFrame() const { return frame_; }
 };
 
-// The key in MissingEnvironmentMap.
-//
-//   * For live frames, maps live frames to their synthesized environments.
-//   * For completely optimized-out environments, maps the Scope to their
-//     synthesized environments.
-//
-// The env we synthesize for Scopes are read-only, but the parent links can be
-// used when accessing closed-over bindings held by the enclosing environments.
-// Thus these environments need to be distinct for multiple execution for the
-// same scope.  Otherwise looking up the MissingEnvironmentMap can yield
-// the environment for previous execution, which holds different values in the
-// variables.
+// The key in MissingEnvironmentMap. For live frames, maps live frames to
+// their synthesized environments. For completely optimized-out environments,
+// maps the Scope to their synthesized environments. The env we synthesize for
+// Scopes are read-only, and we never use their parent links, so they don't
+// need to be distinct.
 //
-// Completely optimized out environments lack the frame, and they can't be
-// distinguished by the frame pointers. Note that even if the frame
-// corresponding to the Scope is live on the stack, it is unsound to synthesize
-// environment from that live frame.
-//
-// If the frame is missing, the nearestEnv_ field is used for distinguishing
-// the missing environments across multiple executions.
-// The nearestEnv_ field holds the environment object that encloses this
-// environment.
-//
-// The goal of distinguishing the environments is to avoid mixing up the
-// variables in these enclosing environments, thus using these environment
-// object pointers should be sufficient.
-// For example, if there's no enclosing local environment which has environment
-// object, nearestEnv_ will point the global environment object, and
-// all executions for the same scope will alias, but there's no need to
-// distinguish between them.
+// That is, completely optimized out environments can't be distinguished by
+// frame. Note that even if the frame corresponding to the Scope is live on
+// the stack, it is unsound to synthesize an environment from that live
+// frame. In other words, the provenance of the environment chain is from
+// allocated closures (i.e., allocation sites) and is irrecoverable from
+// simple stack inspection (i.e., call sites).
 class MissingEnvironmentKey {
   friend class LiveEnvironmentVal;
 
-  // The corresponding frame for the environment.
-  // This can be null for function etc.
   AbstractFramePtr frame_;
-
-  // The nearest enclosing environment object.
-  // Used only if frame_ is null, to distinguish between multiple
-  // execution on the same scope.
-  WeakHeapPtr<EnvironmentObject*> nearestEnv_;
-
-  // The corresponding scope for the environment.
-  // This is shared betwen all executions.
   Scope* scope_;
 
  public:
-  MissingEnvironmentKey(JSContext* cx, const EnvironmentIter& ei);
+  explicit MissingEnvironmentKey(const EnvironmentIter& ei)
+      : frame_(ei.maybeInitialFrame()), scope_(ei.maybeScope()) {}
 
   MissingEnvironmentKey(AbstractFramePtr frame, Scope* scope)
-      : frame_(frame), nearestEnv_(nullptr), scope_(scope) {
-    MOZ_ASSERT(frame);
-  }
+      : frame_(frame), scope_(scope) {}
 
   AbstractFramePtr frame() const { return frame_; }
-  WeakHeapPtr<EnvironmentObject*>& nearestEnvRaw() { return nearestEnv_; }
-  EnvironmentObject* nearestEnvUnbarriered() const {
-    return nearestEnv_.unbarrieredGet();
-  }
   Scope* scope() const { return scope_; }
 
   void updateScope(Scope* scope) { scope_ = scope; }
-  void updateNearestEnv(EnvironmentObject* env) { nearestEnv_ = env; }
   void updateFrame(AbstractFramePtr frame) { frame_ = frame; }
 
   // For use as hash policy.
@@ -1320,8 +1286,7 @@
   static HashNumber hash(MissingEnvironmentKey sk);
   static bool match(MissingEnvironmentKey sk1, MissingEnvironmentKey sk2);
   bool operator!=(const MissingEnvironmentKey& other) const {
-    return frame_ != other.frame_ || nearestEnv_ != other.nearestEnv_ ||
-           scope_ != other.scope_;
+    return frame_ != other.frame_ || scope_ != other.scope_;
   }
   static void rekey(MissingEnvironmentKey& k,
                     const MissingEnvironmentKey& newKey) {
@@ -1335,17 +1300,13 @@
   friend class MissingEnvironmentKey;
 
   AbstractFramePtr frame_;
-  // See LiveEnvironmentVal::staticAsserts.
-  uintptr_t padding_ = 0;
   HeapPtr<Scope*> scope_;
 
   static void staticAsserts();
 
  public:
   explicit LiveEnvironmentVal(const EnvironmentIter& ei)
-      : frame_(ei.initialFrame()), scope_(ei.maybeScope()) {
-    (void)padding_;
-  }
+      : frame_(ei.initialFrame()), scope_(ei.maybeScope()) {}
 
   AbstractFramePtr frame() const { return frame_; }
 
