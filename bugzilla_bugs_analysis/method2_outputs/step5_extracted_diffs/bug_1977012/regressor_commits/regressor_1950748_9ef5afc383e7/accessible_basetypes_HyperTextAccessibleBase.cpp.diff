# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: accessible/basetypes/HyperTextAccessibleBase.cpp
# Commit: 9ef5afc383e7
# Full Hash: 9ef5afc383e75c435d7d2a3b4df5d45b675ce714
# Author: James Teh <jteh@mozilla.com>
# Date: 2025-07-14 09:19:02
# Regressor Bug: 1950748
# File Overlap Count: 1
# Description:
#   Bug 1950748 part 1: HyperTextAccessibleBase::ToTextLeafPoint: Descend to the end of an embedded object when given its end offset. r=morgan
#   
#   Normally, an embedded object only spans 1 HyperText offset.
#   However, if the embedded object is the last child of its container, GetChildAtOffset(containerCharacterLength) will also return the last embedded object.
#   There are some rare cases where we end up with a HyperText offset that refers to the end of a container; e.g. the caret offset when clicking in the empty area at the bottom of a container after an input.
# ==============================================================================

diff -r 189645f95663 -r 9ef5afc383e7 accessible/basetypes/HyperTextAccessibleBase.cpp
--- a/accessible/basetypes/HyperTextAccessibleBase.cpp	Mon Jul 14 00:14:47 2025 +0000
+++ b/accessible/basetypes/HyperTextAccessibleBase.cpp	Mon Jul 14 01:38:43 2025 +0000
@@ -329,12 +329,15 @@
   if (!child) {
     return TextLeafPoint();
   }
+  int32_t offset = aOffset - GetChildOffset(child);
   if (HyperTextAccessibleBase* childHt = child->AsHyperTextBase()) {
+    // This child is an embedded object, so the offset can only be 0 or 1.
+    MOZ_ASSERT(offset == 0 || offset == 1);
+    // Offset 1 refers to the end of this container, so descend to its end.
+    const bool end = aDescendToEnd || offset == 1;
     return childHt->ToTextLeafPoint(
-        aDescendToEnd ? static_cast<int32_t>(childHt->CharacterCount()) : 0,
-        aDescendToEnd);
+        end ? static_cast<int32_t>(childHt->CharacterCount()) : 0, end);
   }
-  int32_t offset = aOffset - GetChildOffset(child);
   return TextLeafPoint(child, offset);
 }
 
