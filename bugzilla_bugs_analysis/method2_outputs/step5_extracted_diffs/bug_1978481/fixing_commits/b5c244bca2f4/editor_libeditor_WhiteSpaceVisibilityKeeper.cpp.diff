# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: editor/libeditor/WhiteSpaceVisibilityKeeper.cpp
# Commit: b5c244bca2f4
# Full Hash: b5c244bca2f43cdf67e0a39f29ba4d80d991b52e
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2025-07-23 15:49:37
# Description:
#   Bug 1978481 - Restore the scope of `trackAfterRightBlockChild` in `WhiteSpaceVisibilityKeeper::MergeFirstLineOfRightBlockElementIntoDescendantLeftBlockElement` r=m_kato
#   
#   Previously, there was a scope for that [1] but it was not intentionally
#   created.  Therefore, the scope was deleted accidentally by outdenting
#   in bug 1951038.
# ==============================================================================

diff -r a2041475453f -r b5c244bca2f4 editor/libeditor/WhiteSpaceVisibilityKeeper.cpp
--- a/editor/libeditor/WhiteSpaceVisibilityKeeper.cpp	Wed Jul 23 08:29:20 2025 +0000
+++ b/editor/libeditor/WhiteSpaceVisibilityKeeper.cpp	Wed Jul 23 08:32:08 2025 +0000
@@ -134,24 +134,26 @@
     }
   }
   // Finally, make sure that we won't create new invisible white-spaces.
-  AutoTrackDOMPoint trackAfterRightBlockChild(aHTMLEditor.RangeUpdaterRef(),
-                                              &afterRightBlockChild);
-  Result<EditorDOMPoint, nsresult> atFirstVisibleThingOrError =
-      WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter(
-          aHTMLEditor, afterRightBlockChild,
-          {NormalizeOption::StopIfFollowingWhiteSpacesStartsWithNBSP});
-  if (MOZ_UNLIKELY(atFirstVisibleThingOrError.isErr())) {
-    NS_WARNING(
-        "WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter() failed");
-    return atFirstVisibleThingOrError.propagateErr();
-  }
-  Result<EditorDOMPoint, nsresult> afterLastVisibleThingOrError =
-      WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesBefore(
-          aHTMLEditor, EditorDOMPoint::AtEndOf(aLeftBlockElement), {});
-  if (MOZ_UNLIKELY(afterLastVisibleThingOrError.isErr())) {
-    NS_WARNING(
-        "WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter() failed");
-    return afterLastVisibleThingOrError.propagateErr();
+  {
+    AutoTrackDOMPoint trackAfterRightBlockChild(aHTMLEditor.RangeUpdaterRef(),
+                                                &afterRightBlockChild);
+    Result<EditorDOMPoint, nsresult> atFirstVisibleThingOrError =
+        WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter(
+            aHTMLEditor, afterRightBlockChild,
+            {NormalizeOption::StopIfFollowingWhiteSpacesStartsWithNBSP});
+    if (MOZ_UNLIKELY(atFirstVisibleThingOrError.isErr())) {
+      NS_WARNING(
+          "WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter() failed");
+      return atFirstVisibleThingOrError.propagateErr();
+    }
+    Result<EditorDOMPoint, nsresult> afterLastVisibleThingOrError =
+        WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesBefore(
+            aHTMLEditor, EditorDOMPoint::AtEndOf(aLeftBlockElement), {});
+    if (MOZ_UNLIKELY(afterLastVisibleThingOrError.isErr())) {
+      NS_WARNING(
+          "WhiteSpaceVisibilityKeeper::NormalizeWhiteSpacesAfter() failed");
+      return afterLastVisibleThingOrError.propagateErr();
+    }
   }
 
   // XXX And afterRightBlockChild.GetContainerAs<Element>() always returns