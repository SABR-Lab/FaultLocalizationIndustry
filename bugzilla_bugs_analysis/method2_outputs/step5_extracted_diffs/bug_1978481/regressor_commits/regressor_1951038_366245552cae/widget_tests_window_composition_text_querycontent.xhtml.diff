# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/tests/window_composition_text_querycontent.xhtml
# Commit: 366245552cae
# Full Hash: 366245552cae536ef883be806322395dc47b759d
# Author: Masayuki Nakano <masayuki@d-toybox.com>
# Date: 2025-06-17 09:24:05
# Regressor Bug: 1951038
# File Overlap Count: 1
# Description:
#   Bug 1951038 - Get rid of the legacy white-space normalizer of `HTMLEditor` and the pref r=m_kato
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D253589
# ==============================================================================

diff -r b13b0a530402 -r 366245552cae widget/tests/window_composition_text_querycontent.xhtml
--- a/widget/tests/window_composition_text_querycontent.xhtml	Tue Jun 17 00:10:27 2025 +0000
+++ b/widget/tests/window_composition_text_querycontent.xhtml	Tue Jun 17 00:37:22 2025 +0000
@@ -163,8 +163,6 @@
 );
 const kExpectInputBeforeCompositionEnd =
   SpecialPowers.getBoolPref("dom.input_events.dispatch_before_compositionend");
-const kNewWhiteSpaceNormalizerEnabled =
-  SpecialPowers.getBoolPref("editor.white_space_normalization.blink_compatible");
 
 function waitForTick() {
   return new Promise(resolve => { SimpleTest.executeSoon(resolve); });
@@ -6564,7 +6562,7 @@
 
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "abc&nbsp;" : "abc <br>",
+    "abc&nbsp;",
     "runBug1530649Test: The trailing space shouldn't be removed"
   );
 
@@ -6574,9 +6572,7 @@
 
   is(
     // It's fine to keep the preceding white-space as an NBSP until the composition ends
-    kNewWhiteSpaceNormalizerEnabled
-      ? contenteditable.innerHTML.replaceAll("&nbsp;", " ")
-      : contenteditable.innerHTML,
+    contenteditable.innerHTML.replaceAll("&nbsp;", " "),
     "abc d",
     "runBug1530649Test: The new composition string shouldn't remove the last space"
   );
@@ -6719,7 +6715,7 @@
 
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "a&nbsp;" : "a <br>",
+    "a&nbsp;",
     "runCommitCompositionWithSpaceKey: last single space should be kept"
   );
 
@@ -6731,7 +6727,7 @@
 
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "a b&nbsp;" : "a b <br>",
+    "a b&nbsp;",
     "runCommitCompositionWithSpaceKey: inserting composition shouldn't remove last single space."
   );
 
@@ -6743,7 +6739,7 @@
 
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "a b c&nbsp;" : "a b c <br>",
+    "a b c&nbsp;",
     "runCommitCompositionWithSpaceKey: inserting composition shouldn't remove last single space."
   );
 
@@ -6762,7 +6758,7 @@
 
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "ab&nbsp;" : "ab <br>",
+    "ab&nbsp;",
     "runCommitCompositionWithSpaceKey: contenteditable should end with a padding <br> element after inserting commit string ending with a space"
   );
 }
@@ -11330,7 +11326,7 @@
   });
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "<p>a&nbsp;</p>" : "<p>a <br></p>",
+    "<p>a&nbsp;</p>",
     "Padding <br> should be inserted after composition string when it ends with a collapsible white-space"
   );
   synthesizeCompositionChange({
@@ -11357,16 +11353,14 @@
   is(
     // If the new normalizer is enabled, it's fine to keep the last white-space
     // before composition stirng is an NBSP because it'll be normalized at end.
-    kNewWhiteSpaceNormalizerEnabled
-      ? contenteditable.innerHTML.replaceAll("&nbsp;", " ")
-      : contenteditable.innerHTML,
+    contenteditable.innerHTML.replaceAll("&nbsp;", " "),
     "<p>abc d</p>",
     `The padding <br> should be deleted when the composition string, "d", is inserted`
   );
   synthesizeComposition({ type: "compositioncommit", data: "" });
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "<p>abc&nbsp;</p>" : "<p>abc <br></p>",
+    "<p>abc&nbsp;</p>",
     "A padding <br> should be inserted if the composition string becomes empty and the previous character is a collapsible ASCII white-space"
   );
   synthesizeKey("z", {accelKey: true});
@@ -11376,30 +11370,28 @@
     "Undo should not delete the padding <br>"
   );
 
-  if (kNewWhiteSpaceNormalizerEnabled) {
-    contenteditable.innerHTML = "<p>abc&nbsp;</p>";
-    selection.collapse(contenteditable.querySelector("p").firstChild, "abc ".length);
-    synthesizeCompositionChange({
-      composition: {string: "d", clauses: [{length: 1, attr: COMPOSITION_ATTR_RAW_CLAUSE}]},
-    });
-    is(
-      contenteditable.innerHTML.replaceAll("&nbsp;", " "),
-      "<p>abc d</p>",
-      `The white-space should not become invislbe, but it's fine either an ASCII space or an NBSP`
-    );
-    synthesizeComposition({ type: "compositioncommit", data: "" });
-    is(
-      contenteditable.innerHTML,
-      "<p>abc&nbsp;</p>",
-      "The last white-space should be an NBSP if the composition string becomes empty and the previous character is a collapsible ASCII white-space"
-    );
-    synthesizeKey("z", {accelKey: true});
-    is(
-      contenteditable.innerHTML,
-      "<p>abc&nbsp;</p>",
-      "Undo should not delete the trailing white-space"
-    );
-  }
+  contenteditable.innerHTML = "<p>abc&nbsp;</p>";
+  selection.collapse(contenteditable.querySelector("p").firstChild, "abc ".length);
+  synthesizeCompositionChange({
+    composition: {string: "d", clauses: [{length: 1, attr: COMPOSITION_ATTR_RAW_CLAUSE}]},
+  });
+  is(
+    contenteditable.innerHTML.replaceAll("&nbsp;", " "),
+    "<p>abc d</p>",
+    `The white-space should not become invislbe, but it's fine either an ASCII space or an NBSP`
+  );
+  synthesizeComposition({ type: "compositioncommit", data: "" });
+  is(
+    contenteditable.innerHTML,
+    "<p>abc&nbsp;</p>",
+    "The last white-space should be an NBSP if the composition string becomes empty and the previous character is a collapsible ASCII white-space"
+  );
+  synthesizeKey("z", {accelKey: true});
+  is(
+    contenteditable.innerHTML,
+    "<p>abc&nbsp;</p>",
+    "Undo should not delete the trailing white-space"
+  );
 
   contenteditable.innerHTML = "";
 }
@@ -11424,7 +11416,7 @@
   synthesizeComposition({type: "compositioncommit", data: ""});
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "<p>A&nbsp;</p>" : "<p>A <br></p>",
+    "<p>A&nbsp;</p>",
     `${description}: Canceling the composition should keep the preceding collapsible white-space visible`
   );
   synthesizeKey("B");
@@ -11449,13 +11441,13 @@
   });
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "<p>A&nbsp;</p>" : "A <br>",
+    "<p>A&nbsp;</p>",
     `${description}: Composing string " " should be inserted`
   );
   synthesizeComposition({type: "compositioncommitasis", data: " "});
   is(
     contenteditable.innerHTML,
-    kNewWhiteSpaceNormalizerEnabled ? "<p>A&nbsp;</p>" : "<p>A <br></p>",
+    "<p>A&nbsp;</p>",
     `${description}: Committing the white-space should not change the value`
   );
   synthesizeKey("B");
