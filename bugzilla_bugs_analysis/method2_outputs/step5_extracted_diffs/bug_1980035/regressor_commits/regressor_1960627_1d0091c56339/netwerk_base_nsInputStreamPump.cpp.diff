# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: netwerk/base/nsInputStreamPump.cpp
# Commit: 1d0091c56339
# Full Hash: 1d0091c5633982e358737a96ed8af1a2be00bf61
# Author: smayya <smayya@mozilla.com>
# Date: 2025-07-27 09:20:01
# Regressor Bug: 1960627
# File Overlap Count: 1
# Description:
#   Bug 1960627 - add LNAPermissionRequest class for dispatching permission prompt requests. r=necko-reviewers,emz,kershaw
#   
#   LNAPermissionRequest is used for dispatching localhost and local-network permission prompts to the user.
#   Additionally, this patch also implements the transaction retry mechanism based on prompt action by the user.
#   This patch also modifies existing unit tests to validate the transaction retry mechanism.
# ==============================================================================

diff -r 0981f147243d -r 1d0091c56339 netwerk/base/nsInputStreamPump.cpp
--- a/netwerk/base/nsInputStreamPump.cpp	Sat Jul 26 21:51:08 2025 +0000
+++ b/netwerk/base/nsInputStreamPump.cpp	Sat Jul 26 21:51:08 2025 +0000
@@ -328,6 +328,23 @@
 }
 
 NS_IMETHODIMP
+nsInputStreamPump::Reset() {
+  RecursiveMutexAutoLock lock(mMutex);
+  LOG(("nsInputStreamPump::Reset [this=%p]\n", this));
+  mListener = nullptr;
+
+  if (mAsyncStream && NS_SUCCEEDED(mAsyncStream->StreamStatus())) {
+    mAsyncStream->Close();
+    mAsyncStream->AsyncWait(nullptr, 0, 0, nullptr);
+  }
+
+  // release the reference, input stream must be closed by the transaction
+  mStream = nullptr;
+
+  return NS_OK;
+}
+
+NS_IMETHODIMP
 nsInputStreamPump::AsyncRead(nsIStreamListener* listener) {
   RecursiveMutexAutoLock lock(mMutex);
 
@@ -494,6 +511,9 @@
 
   {
     nsCOMPtr<nsIStreamListener> listener = mListener;
+    if (!listener) {
+      return STATE_DEAD;
+    }
     // We're on the writing thread
     AssertOnThread();
 
@@ -573,6 +593,9 @@
       }
 
       nsCOMPtr<nsIStreamListener> listener = mListener;
+      if (!listener) {
+        return STATE_DEAD;
+      }
       // Note: Must exit mutex for call to OnStartRequest to avoid
       // deadlocks when calls to RetargetDeliveryTo for multiple
       // nsInputStreamPumps are needed (e.g. nsHttpChannel).
@@ -675,9 +698,8 @@
   // stream.  in some cases, this is redundant, but since close is idempotent,
   // this is OK.  otherwise, be sure to honor the "close-when-done" option.
 
-  if (!mAsyncStream || !mListener) {
+  if (!mAsyncStream) {
     MOZ_ASSERT(mAsyncStream, "null mAsyncStream: OnStateStop called twice?");
-    MOZ_ASSERT(mListener, "null mListener: OnStateStop called twice?");
     return STATE_DEAD;
   }
 