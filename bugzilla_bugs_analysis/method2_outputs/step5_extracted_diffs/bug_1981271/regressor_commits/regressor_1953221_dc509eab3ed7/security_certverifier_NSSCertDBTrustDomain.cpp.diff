# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: security/certverifier/NSSCertDBTrustDomain.cpp
# Commit: dc509eab3ed7
# Full Hash: dc509eab3ed7a513258723eb46b25f33a610e720
# Author: Dana Keeler <dkeeler@mozilla.com>
# Date: 2025-07-11 16:36:21
# Regressor Bug: 1953221
# File Overlap Count: 3
# Description:
#   Bug 1953221 - don't accept SCTs with a timestamp after the distrustAfter date for the root r=jschanck
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D256720
# ==============================================================================

diff -r 5b86ae2c81f9 -r dc509eab3ed7 security/certverifier/NSSCertDBTrustDomain.cpp
--- a/security/certverifier/NSSCertDBTrustDomain.cpp	Thu Jul 10 18:37:49 2025 +0000
+++ b/security/certverifier/NSSCertDBTrustDomain.cpp	Thu Jul 10 19:04:10 2025 +0000
@@ -1258,9 +1258,10 @@
   return rv;
 }
 
-nsresult isDistrustedCertificateChain(
+nsresult IsDistrustedCertificateChain(
     const nsTArray<nsTArray<uint8_t>>& certArray,
-    const SECTrustType certDBTrustType, bool& isDistrusted) {
+    const SECTrustType certDBTrustType, bool& isDistrusted,
+    Maybe<mozilla::pkix::Time>& distrustAfterTimeOut) {
   if (certArray.Length() == 0) {
     return NS_ERROR_FAILURE;
   }
@@ -1352,6 +1353,7 @@
 
   Time distrustAfterTime =
       mozilla::pkix::TimeFromEpochInSeconds(distrustAfter / PR_USEC_PER_SEC);
+  distrustAfterTimeOut.emplace(distrustAfterTime);
   if (endEntityNotBefore <= distrustAfterTime) {
     isDistrusted = false;
   }
@@ -1410,8 +1412,8 @@
   // the NotAfter value of the parent when the root is a builtin.
   if (mIsBuiltChainRootBuiltInRoot) {
     bool isDistrusted;
-    nsrv =
-        isDistrustedCertificateChain(certArray, mCertDBTrustType, isDistrusted);
+    nsrv = IsDistrustedCertificateChain(certArray, mCertDBTrustType,
+                                        isDistrusted, mDistrustAfterTime);
     if (NS_FAILED(nsrv)) {
       return Result::FATAL_ERROR_LIBRARY_FAILURE;
     }
@@ -1610,6 +1612,7 @@
   mSawDistrustedCAByPolicyError = false;
   mIsBuiltChainRootBuiltInRoot = false;
   mIssuerSources.clear();
+  mDistrustAfterTime.reset();
 }
 
 static Input SECItemToInput(const UniqueSECItem& item) {