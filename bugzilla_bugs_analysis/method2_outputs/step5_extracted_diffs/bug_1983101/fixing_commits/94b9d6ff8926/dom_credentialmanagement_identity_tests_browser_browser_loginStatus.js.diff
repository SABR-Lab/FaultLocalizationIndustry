# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/credentialmanagement/identity/tests/browser/browser_loginStatus.js
# Commit: 94b9d6ff8926
# Full Hash: 94b9d6ff8926b6b566916a4bc06a4d4718afe209
# Author: Benjamin VanderSloot <bvandersloot@mozilla.com>
# Date: 2025-08-26 09:53:22
# Description:
#   Bug 1983101 - Fix crash in navigator.login.setStatus - r=emz
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D262181
# ==============================================================================

diff -r ebb71534c42a -r 94b9d6ff8926 dom/credentialmanagement/identity/tests/browser/browser_loginStatus.js
--- a/dom/credentialmanagement/identity/tests/browser/browser_loginStatus.js	Mon Aug 25 18:57:11 2025 +0000
+++ b/dom/credentialmanagement/identity/tests/browser/browser_loginStatus.js	Mon Aug 25 19:04:15 2025 +0000
@@ -497,3 +497,32 @@
     "subresource header in frame"
   );
 });
+
+add_task(async function test_loginStatus_js_disconnected_doc_crash() {
+  let tab = await BrowserTestUtils.openNewForegroundTab(gBrowser, TEST_URL);
+  let complete = await SpecialPowers.spawn(
+    tab.linkedBrowser,
+    [],
+    async function () {
+      const doc1 = new content.Document();
+      const iframe = content.document.createElementNS(
+        "http://www.w3.org/1999/xhtml",
+        "iframe"
+      );
+      content.document.documentElement.appendChild(iframe);
+      const cw = iframe.contentWindow;
+      const element = content.document.querySelector("*");
+      doc1.adoptNode(element);
+
+      try {
+        await cw.navigator.login.setStatus("logged-out");
+      } catch (_) {}
+      try {
+        await cw.navigator.login.setStatus("logged-in");
+      } catch (_) {}
+      return true;
+    }
+  );
+  Assert.ok(complete, "Did not crash");
+  await BrowserTestUtils.removeTab(tab);
+});
