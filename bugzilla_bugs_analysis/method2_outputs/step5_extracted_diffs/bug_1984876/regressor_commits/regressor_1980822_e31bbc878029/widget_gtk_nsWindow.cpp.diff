# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/gtk/nsWindow.cpp
# Commit: e31bbc878029
# Full Hash: e31bbc878029d2155fabd8089c9b3f65d802f690
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-08-05 04:22:56
# Regressor Bug: 1980822
# File Overlap Count: 1
# Description:
#   Bug 1980822 - Modernize GSettings interface. r=stransky
#   
#   We don't really need to support scripting except for a single shell
#   test. Expose a much more reduced API for that instead.
#   
# ==============================================================================

diff -r 4dcb7e0802c5 -r e31bbc878029 widget/gtk/nsWindow.cpp
--- a/widget/gtk/nsWindow.cpp	Mon Aug 04 13:36:42 2025 +0000
+++ b/widget/gtk/nsWindow.cpp	Mon Aug 04 13:39:54 2025 +0000
@@ -24,6 +24,7 @@
 #include "gfxUtils.h"
 #include "GLContextProvider.h"
 #include "GLContext.h"
+#include "GSettings.h"
 #include "GtkCompositorWidget.h"
 #include "imgIContainer.h"
 #include "InputData.h"
@@ -83,7 +84,6 @@
 #include "nsGfxCIID.h"
 #include "nsGtkUtils.h"
 #include "nsIFile.h"
-#include "nsIGSettingsService.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsImageToPixbuf.h"
 #include "nsINode.h"
@@ -2872,10 +2872,7 @@
   mLastSizeModeRequest = aMode;
 }
 
-#define kDesktopMutterSchema "org.gnome.mutter"_ns
-#define kDesktopDynamicWorkspacesKey "dynamic-workspaces"_ns
-
-static bool WorkspaceManagementDisabled(GdkScreen* screen) {
+static bool WorkspaceManagementDisabled() {
   if (Preferences::GetBool("widget.disable-workspace-management", false)) {
     return true;
   }
@@ -2886,19 +2883,9 @@
   if (IsGnomeDesktopEnvironment()) {
     // Gnome uses dynamic workspaces by default so disable workspace management
     // in that case.
-    bool usesDynamicWorkspaces = true;
-    nsCOMPtr<nsIGSettingsService> gsettings =
-        do_GetService(NS_GSETTINGSSERVICE_CONTRACTID);
-    if (gsettings) {
-      nsCOMPtr<nsIGSettingsCollection> mutterSettings;
-      gsettings->GetCollectionForSchema(kDesktopMutterSchema,
-                                        getter_AddRefs(mutterSettings));
-      if (mutterSettings) {
-        mutterSettings->GetBoolean(kDesktopDynamicWorkspacesKey,
-                                   &usesDynamicWorkspaces);
-      }
-    }
-    return usesDynamicWorkspaces;
+    return widget::GSettings::GetBoolean("org.gnome.mutter"_ns,
+                                         "dynamic-workspaces"_ns)
+        .valueOr(false);
   }
 
   const auto& desktop = GetDesktopEnvironmentIdentifier();
@@ -2922,7 +2909,7 @@
     return;
   }
 
-  if (WorkspaceManagementDisabled(gdk_window_get_screen(gdk_window))) {
+  if (WorkspaceManagementDisabled()) {
     LOG("  WorkspaceManagementDisabled, quit.");
     return;
   }