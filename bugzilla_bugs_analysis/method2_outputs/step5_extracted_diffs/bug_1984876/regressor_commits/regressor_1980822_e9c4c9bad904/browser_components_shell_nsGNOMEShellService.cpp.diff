# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: browser/components/shell/nsGNOMEShellService.cpp
# Commit: e9c4c9bad904
# Full Hash: e9c4c9bad904fbba96c6e69baa347200f49814fc
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-08-04 21:33:32
# Regressor Bug: 1980822
# File Overlap Count: 1
# Description:
#   Bug 1980822 - Modernize GSettings interface. r=stransky
#   
#   We don't really need to support scripting except for a single shell
#   test. Expose a much more reduced API for that instead.
#   
# ==============================================================================

diff -r 8323476e4964 -r e9c4c9bad904 browser/components/shell/nsGNOMEShellService.cpp
--- a/browser/components/shell/nsGNOMEShellService.cpp	Mon Aug 04 09:36:44 2025 +0000
+++ b/browser/components/shell/nsGNOMEShellService.cpp	Mon Aug 04 09:37:04 2025 +0000
@@ -5,6 +5,7 @@
 
 #include "mozilla/ArrayUtils.h"
 #include "mozilla/Preferences.h"
+#include "mozilla/widget/GSettings.h"
 
 #include "nsCOMPtr.h"
 #include "nsGNOMEShellService.h"
@@ -15,7 +16,6 @@
 #include "prenv.h"
 #include "nsString.h"
 #include "nsIGIOService.h"
-#include "nsIGSettingsService.h"
 #include "nsIStringBundle.h"
 #include "nsServiceManagerUtils.h"
 #include "nsIImageLoadingContent.h"
@@ -75,12 +75,6 @@
   // GSettings or GIO _must_ be available, or we do not allow
   // CreateInstance to succeed.
 
-  nsCOMPtr<nsIGIOService> giovfs = do_GetService(NS_GIOSERVICE_CONTRACTID);
-  nsCOMPtr<nsIGSettingsService> gsettings =
-      do_GetService(NS_GSETTINGSSERVICE_CONTRACTID);
-
-  if (!giovfs && !gsettings) return NS_ERROR_NOT_AVAILABLE;
-
 #ifdef MOZ_ENABLE_DBUS
   if (widget::IsGnomeDesktopEnvironment() &&
       Preferences::GetBool("browser.gnome-search-provider.enabled", false)) {
@@ -407,15 +401,8 @@
   // write the image to a file in the home dir
   MOZ_TRY(WriteImage(filePath, container));
 
-  nsCOMPtr<nsIGSettingsService> gsettings =
-      do_GetService(NS_GSETTINGSSERVICE_CONTRACTID);
-  if (!gsettings) {
-    return NS_ERROR_FAILURE;
-  }
-  nsCOMPtr<nsIGSettingsCollection> backgroundSettings;
-  gsettings->GetCollectionForSchema(kDesktopBGSchema,
-                                    getter_AddRefs(backgroundSettings));
-  if (!backgroundSettings) {
+  widget::GSettings::Collection bgSettings(kDesktopBGSchema);
+  if (!bgSettings) {
     return NS_ERROR_FAILURE;
   }
 
@@ -425,11 +412,10 @@
     return NS_ERROR_FAILURE;
   }
 
-  backgroundSettings->SetString("picture-options"_ns, options);
-  backgroundSettings->SetString("picture-uri"_ns,
-                                nsDependentCString(fileURI.get()));
-  backgroundSettings->SetString("picture-uri-dark"_ns,
-                                nsDependentCString(fileURI.get()));
+  bgSettings.SetString("picture-options"_ns, options);
+  bgSettings.SetString("picture-uri"_ns, nsDependentCString(fileURI.get()));
+  bgSettings.SetString("picture-uri-dark"_ns,
+                       nsDependentCString(fileURI.get()));
   return NS_OK;
 }
 
@@ -438,19 +424,9 @@
 
 NS_IMETHODIMP
 nsGNOMEShellService::GetDesktopBackgroundColor(uint32_t* aColor) {
-  nsCOMPtr<nsIGSettingsService> gsettings =
-      do_GetService(NS_GSETTINGSSERVICE_CONTRACTID);
-  nsCOMPtr<nsIGSettingsCollection> background_settings;
   nsAutoCString background;
-
-  if (gsettings) {
-    gsettings->GetCollectionForSchema(kDesktopBGSchema,
-                                      getter_AddRefs(background_settings));
-    if (background_settings) {
-      background_settings->GetString(kDesktopColorGSKey, background);
-    }
-  }
-
+  widget::GSettings::GetString(kDesktopBGSchema, kDesktopColorGSKey,
+                               background);
   if (background.IsEmpty()) {
     *aColor = 0;
     return NS_OK;
@@ -485,17 +461,35 @@
   nsAutoCString colorString;
   ColorToCString(aColor, colorString);
 
-  nsCOMPtr<nsIGSettingsService> gsettings =
-      do_GetService(NS_GSETTINGSSERVICE_CONTRACTID);
-  if (gsettings) {
-    nsCOMPtr<nsIGSettingsCollection> background_settings;
-    gsettings->GetCollectionForSchema(nsLiteralCString(kDesktopBGSchema),
-                                      getter_AddRefs(background_settings));
-    if (background_settings) {
-      background_settings->SetString(kDesktopColorGSKey, colorString);
-      return NS_OK;
-    }
+  widget::GSettings::Collection bgSettings(kDesktopBGSchema);
+  if (bgSettings) {
+    bgSettings.SetString(kDesktopColorGSKey, colorString);
+    return NS_OK;
   }
 
   return NS_ERROR_FAILURE;
 }
+
+NS_IMETHODIMP
+nsGNOMEShellService::GetGSettingsString(const nsACString& aSchema,
+                                        const nsACString& aKey,
+                                        nsACString& aResult) {
+  widget::GSettings::GetString(PromiseFlatCString(aSchema),
+                               PromiseFlatCString(aKey), aResult);
+  return NS_OK;
+}
+
+NS_IMETHODIMP
+nsGNOMEShellService::SetGSettingsString(const nsACString& aSchema,
+                                        const nsACString& aKey,
+                                        const nsACString& aValue) {
+  widget::GSettings::Collection settings(PromiseFlatCString(aSchema));
+  if (!settings) {
+    return NS_ERROR_FAILURE;
+  }
+  if (!settings.SetString(PromiseFlatCString(aKey),
+                          PromiseFlatCString(aValue))) {
+    return NS_ERROR_FAILURE;
+  }
+  return NS_OK;
+}