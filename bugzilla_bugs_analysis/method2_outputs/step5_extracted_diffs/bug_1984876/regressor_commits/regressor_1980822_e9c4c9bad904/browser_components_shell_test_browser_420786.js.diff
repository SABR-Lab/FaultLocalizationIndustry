# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: browser/components/shell/test/browser_420786.js
# Commit: e9c4c9bad904
# Full Hash: e9c4c9bad904fbba96c6e69baa347200f49814fc
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-08-04 21:33:32
# Regressor Bug: 1980822
# File Overlap Count: 1
# Description:
#   Bug 1980822 - Modernize GSettings interface. r=stransky
#   
#   We don't really need to support scripting except for a single shell
#   test. Expose a much more reduced API for that instead.
#   
# ==============================================================================

diff -r 8323476e4964 -r e9c4c9bad904 browser/components/shell/test/browser_420786.js
--- a/browser/components/shell/test/browser_420786.js	Mon Aug 04 09:36:44 2025 +0000
+++ b/browser/components/shell/test/browser_420786.js	Mon Aug 04 09:37:04 2025 +0000
@@ -40,9 +40,9 @@
         wpFile.copyTo(null, wpFileBackup.leafName);
       }
 
-      var shell = Cc["@mozilla.org/browser/shell-service;1"].getService(
-        Ci.nsIShellService
-      );
+      var shell = Cc["@mozilla.org/browser/shell-service;1"]
+        .getService(Ci.nsIShellService)
+        .QueryInterface(Ci.nsIGNOMEShellService);
 
       // For simplicity, we're going to reach in and access the image on the
       // page directly, which means the page shouldn't be running in a remote
@@ -56,32 +56,30 @@
 
       let checkWallpaper, restoreSettings;
       try {
-        // Try via GSettings first
-        const gsettings = Cc["@mozilla.org/gsettings-service;1"]
-          .getService(Ci.nsIGSettingsService)
-          .getCollectionForSchema(GS_BG_SCHEMA);
-
-        const prevImage = gsettings.getString(GS_IMAGE_KEY);
-        const prevOption = gsettings.getString(GS_OPTION_KEY);
+        const prevImage = shell.getGSettingsString(GS_BG_SCHEMA, GS_IMAGE_KEY);
+        const prevOption = shell.getGSettingsString(
+          GS_BG_SCHEMA,
+          GS_OPTION_KEY
+        );
 
         checkWallpaper = function (position, expectedGSettingsPosition) {
           shell.setDesktopBackground(image, position, "");
           ok(wpFile.exists(), "Wallpaper was written to disk");
           is(
-            gsettings.getString(GS_IMAGE_KEY),
+            shell.getGSettingsString(GS_BG_SCHEMA, GS_IMAGE_KEY),
             encodeURI("file://" + wpFile.path),
             "Wallpaper file GSettings key is correct"
           );
           is(
-            gsettings.getString(GS_OPTION_KEY),
+            shell.getGSettingsString(GS_BG_SCHEMA, GS_OPTION_KEY),
             expectedGSettingsPosition,
             "Wallpaper position GSettings key is correct"
           );
         };
 
         restoreSettings = function () {
-          gsettings.setString(GS_IMAGE_KEY, prevImage);
-          gsettings.setString(GS_OPTION_KEY, prevOption);
+          shell.setGSettingsString(GS_BG_SCHEMA, GS_IMAGE_KEY, prevImage);
+          shell.setGSettingsString(GS_BG_SCHEMA, GS_OPTION_KEY, prevOption);
         };
       } catch (e) {}
 