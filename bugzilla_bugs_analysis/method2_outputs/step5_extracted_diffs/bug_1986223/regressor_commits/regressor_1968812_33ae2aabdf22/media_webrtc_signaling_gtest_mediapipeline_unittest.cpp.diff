# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: media/webrtc/signaling/gtest/mediapipeline_unittest.cpp
# Commit: 33ae2aabdf22
# Full Hash: 33ae2aabdf225a72dfceb09424e4e43ae9430e69
# Author: Atila Butkovits <abutkovits@mozilla.com>
# Date: 2025-06-12 16:31:09
# Regressor Bug: 1968812
# File Overlap Count: 1
# Description:
#   Revert "Bug 1968812 - Remove the CallWorker thread and use TaskQueue::Observer instead. r=bwc" for causing failures complaining about mutexLock.
#   
#   This reverts commit d53f26b530b4ad59aebe314c55a8af2c62a80fc3.
#   
#   Revert "Bug 1968812 - Copy WebrtcTaskQueueWrapper.h to WebrtcTaskQueueWrapper.cpp. r=bwc"
# ==============================================================================

diff -r ca232b0163c7 -r 33ae2aabdf22 media/webrtc/signaling/gtest/mediapipeline_unittest.cpp
--- a/media/webrtc/signaling/gtest/mediapipeline_unittest.cpp	Wed Jun 11 22:34:11 2025 +0300
+++ b/media/webrtc/signaling/gtest/mediapipeline_unittest.cpp	Wed Jun 11 23:24:24 2025 +0300
@@ -25,12 +25,12 @@
 #include "MediaPipelineFilter.h"
 #include "MediaTrackGraph.h"
 #include "MediaTrackListener.h"
+#include "TaskQueueWrapper.h"
 #include "mtransport_test_utils.h"
 #include "SharedBuffer.h"
 #include "MediaTransportHandler.h"
 #include "WebrtcCallWrapper.h"
 #include "WebrtcEnvironmentWrapper.h"
-#include "WebrtcTaskQueueWrapper.h"
 #include "PeerConnectionCtx.h"
 
 #define GTEST_HAS_RTTI 0
@@ -42,52 +42,20 @@
 static MtransportTestUtils* test_utils;
 
 namespace {
-class MainAsCurrent : public webrtc::TaskQueueBase {
+class MainAsCurrent : public TaskQueueWrapper<DeletionPolicy::NonBlocking> {
  public:
   MainAsCurrent()
-      : mTaskQueue(CreateWebrtcTaskQueueWrapper(
-            do_AddRef(GetMainThreadSerialEventTarget()), "MainAsCurrent"_ns,
-            false)),
-        mWebrtcTaskQueue(([&] {
-          // Shady but fine, as this raw pointer points to the WebrtcTaskQueue
-          // owned and kept alive by mTaskQueue.
-          webrtc::TaskQueueBase* queue{};
-          MOZ_ALWAYS_SUCCEEDS(mTaskQueue->Dispatch(NS_NewRunnableFunction(
-              "MainAsCurrent::Current",
-              [&] { queue = webrtc::TaskQueueBase::Current(); })));
-          NS_ProcessPendingEvents(nullptr);
-          MOZ_RELEASE_ASSERT(queue);
-          return queue;
-        })()),
-        mSetter(mWebrtcTaskQueue) {
+      : TaskQueueWrapper(
+            TaskQueue::Create(do_AddRef(GetMainThreadSerialEventTarget()),
+                              "MainAsCurrentTaskQueue"),
+            "MainAsCurrent"_ns),
+        mSetter(this) {
     MOZ_RELEASE_ASSERT(NS_IsMainThread());
   }
 
   ~MainAsCurrent() = default;
 
-  void Delete() override { delete this; }
-
-  void PostTaskImpl(absl::AnyInvocable<void() &&> task,
-                    const PostTaskTraits& traits,
-                    const webrtc::Location& location) override {
-    mWebrtcTaskQueue->PostTask(std::move(task), location);
-  }
-
-  void PostDelayedTaskImpl(absl::AnyInvocable<void() &&> task,
-                           webrtc::TimeDelta delay,
-                           const PostDelayedTaskTraits& traits,
-                           const webrtc::Location& location) override {
-    if (traits.high_precision) {
-      mWebrtcTaskQueue->PostDelayedHighPrecisionTask(std::move(task), delay,
-                                                     location);
-      return;
-    }
-    mWebrtcTaskQueue->PostDelayedTask(std::move(task), delay, location);
-  }
-
  private:
-  RefPtr<TaskQueue> mTaskQueue;
-  webrtc::TaskQueueBase* mWebrtcTaskQueue;
   CurrentTaskQueueSetter mSetter;
 };
 
@@ -497,7 +465,7 @@
  public:
   explicit MediaPipelineTest(MediaPipelineTestOptions options = {})
       : main_task_queue_(
-            std::unique_ptr<webrtc::TaskQueueBase, webrtc::TaskQueueDeleter>(
+            WrapUnique<TaskQueueWrapper<DeletionPolicy::NonBlocking>>(
                 new MainAsCurrent())),
         options_(options),
         env_wrapper_(WebrtcEnvironmentWrapper::Create(
@@ -619,8 +587,7 @@
  protected:
   // main_task_queue_ has this type to make sure it goes through Delete() when
   // we're destroyed.
-  std::unique_ptr<webrtc::TaskQueueBase, webrtc::TaskQueueDeleter>
-      main_task_queue_;
+  UniquePtr<TaskQueueWrapper<DeletionPolicy::NonBlocking>> main_task_queue_;
   const MediaPipelineTestOptions options_;
   const RefPtr<WebrtcEnvironmentWrapper> env_wrapper_;
   const RefPtr<SharedWebrtcState> shared_state_;