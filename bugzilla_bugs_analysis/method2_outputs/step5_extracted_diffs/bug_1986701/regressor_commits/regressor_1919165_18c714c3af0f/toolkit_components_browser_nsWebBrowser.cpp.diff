# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: toolkit/components/browser/nsWebBrowser.cpp
# Commit: 18c714c3af0f
# Full Hash: 18c714c3af0f77750cc36ec9f162e9d84d3f537f
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-04-29 20:49:47
# Regressor Bug: 1919165
# File Overlap Count: 1
# Description:
#   Bug 1919165 - Remove support for WindowType::Child, which is now unused. r=stransky
#   
#   We don't take this codepath anymore in any platform. Windows and GTK
#   were already asserting against it.
#   
# ==============================================================================

diff -r 734373410b28 -r 18c714c3af0f toolkit/components/browser/nsWebBrowser.cpp
--- a/toolkit/components/browser/nsWebBrowser.cpp	Tue Apr 29 14:04:48 2025 +0000
+++ b/toolkit/components/browser/nsWebBrowser.cpp	Tue Apr 29 14:04:53 2025 +0000
@@ -60,7 +60,6 @@
       mShouldEnableHistory(true),
       mWillChangeProcess(false),
       mProgressListener(nullptr),
-      mWidgetListenerDelegate(this),
       mBackgroundColor(0),
       mPersistCurrentState(nsIWebBrowserPersist::PERSIST_STATE_READY),
       mPersistResult(NS_OK),
@@ -73,25 +72,8 @@
 nsWebBrowser::~nsWebBrowser() { InternalDestroy(); }
 
 nsIWidget* nsWebBrowser::EnsureWidget() {
-  if (mParentWidget) {
-    return mParentWidget;
-  }
-
-  mInternalWidget = nsIWidget::CreateChildWindow();
-  if (NS_WARN_IF(!mInternalWidget)) {
-    return nullptr;
-  }
-
-  widget::InitData widgetInit;
-  widgetInit.mClipChildren = true;
-  widgetInit.mWindowType = widget::WindowType::Child;
-  LayoutDeviceIntRect bounds(0, 0, 0, 0);
-
-  mInternalWidget->SetWidgetListener(&mWidgetListenerDelegate);
-  NS_ENSURE_SUCCESS(mInternalWidget->Create(mParentWidget, bounds, &widgetInit),
-                    nullptr);
-
-  return mInternalWidget;
+  MOZ_DIAGNOSTIC_ASSERT(mParentWidget);
+  return mParentWidget;
 }
 
 /* static */
@@ -163,12 +145,6 @@
 }
 
 void nsWebBrowser::InternalDestroy() {
-  if (mInternalWidget) {
-    mInternalWidget->SetWidgetListener(nullptr);
-    mInternalWidget->Destroy();
-    mInternalWidget = nullptr;  // Force release here.
-  }
-
   SetDocShell(nullptr);
 
   if (mDocShellTreeOwner) {
@@ -941,14 +917,7 @@
   int32_t doc_x = aX;
   int32_t doc_y = aY;
 
-  // If there is an internal widget we need to make the docShell coordinates
-  // relative to the internal widget rather than the calling app's parent.
   // We also need to resize our widget then.
-  if (mInternalWidget) {
-    doc_x = doc_y = 0;
-    mInternalWidget->Resize(aX, aY, aCX, aCY,
-                            !!(aFlags & nsIBaseWindow::eRepaint));
-  }
   // Now reposition/ resize the doc
   NS_ENSURE_SUCCESS(
       mDocShell->SetPositionAndSize(doc_x, doc_y, aCX, aCY, aFlags),
@@ -960,24 +929,6 @@
 NS_IMETHODIMP
 nsWebBrowser::GetPositionAndSize(int32_t* aX, int32_t* aY, int32_t* aCX,
                                  int32_t* aCY) {
-  if (mInternalWidget) {
-    LayoutDeviceIntRect bounds = mInternalWidget->GetBounds();
-
-    if (aX) {
-      *aX = bounds.X();
-    }
-    if (aY) {
-      *aY = bounds.Y();
-    }
-    if (aCX) {
-      *aCX = bounds.Width();
-    }
-    if (aCY) {
-      *aCY = bounds.Height();
-    }
-    return NS_OK;
-  }
-
   // Can directly return this as it is the
   // same interface, thus same returns.
   return mDocShell->GetPositionAndSize(aX, aY, aCX, aCY);
@@ -1041,9 +992,6 @@
 nsWebBrowser::SetVisibility(bool aVisibility) {
   if (mDocShell) {
     NS_ENSURE_SUCCESS(mDocShell->SetVisibility(aVisibility), NS_ERROR_FAILURE);
-    if (mInternalWidget) {
-      mInternalWidget->Show(aVisibility);
-    }
   }
 
   return NS_OK;
@@ -1051,35 +999,18 @@
 
 NS_IMETHODIMP
 nsWebBrowser::GetEnabled(bool* aEnabled) {
-  if (mInternalWidget) {
-    *aEnabled = mInternalWidget->IsEnabled();
-    return NS_OK;
-  }
-
   return NS_ERROR_FAILURE;
 }
 
 NS_IMETHODIMP
 nsWebBrowser::SetEnabled(bool aEnabled) {
-  if (mInternalWidget) {
-    mInternalWidget->Enable(aEnabled);
-    return NS_OK;
-  }
   return NS_ERROR_FAILURE;
 }
 
 NS_IMETHODIMP
 nsWebBrowser::GetMainWidget(nsIWidget** aMainWidget) {
   NS_ENSURE_ARG_POINTER(aMainWidget);
-
-  if (mInternalWidget) {
-    *aMainWidget = mInternalWidget;
-  } else {
-    *aMainWidget = mParentWidget;
-  }
-
-  NS_IF_ADDREF(*aMainWidget);
-
+  NS_IF_ADDREF(*aMainWidget = mParentWidget);
   return NS_OK;
 }
 
@@ -1143,42 +1074,6 @@
   mDocShellTreeOwner->WebBrowser(this);
 }
 
-void nsWebBrowser::WindowActivated() {
-#if defined(DEBUG_smaug)
-  RefPtr<dom::Document> document = mDocShell->GetDocument();
-  nsAutoString documentURI;
-  document->GetDocumentURI(documentURI);
-  printf("nsWebBrowser::NS_ACTIVATE %p %s\n", (void*)this,
-         NS_ConvertUTF16toUTF8(documentURI).get());
-#endif
-  FocusActivate(nsFocusManager::GenerateFocusActionId());
-}
-
-void nsWebBrowser::WindowDeactivated() {
-#if defined(DEBUG_smaug)
-  RefPtr<dom::Document> document = mDocShell->GetDocument();
-  nsAutoString documentURI;
-  document->GetDocumentURI(documentURI);
-  printf("nsWebBrowser::NS_DEACTIVATE %p %s\n", (void*)this,
-         NS_ConvertUTF16toUTF8(documentURI).get());
-#endif
-  FocusDeactivate(nsFocusManager::GenerateFocusActionId());
-}
-
-bool nsWebBrowser::PaintWindow(nsIWidget* aWidget,
-                               LayoutDeviceIntRegion aRegion) {
-  WindowRenderer* renderer = aWidget->GetWindowRenderer();
-  NS_ASSERTION(renderer, "Must be in paint event");
-  if (FallbackRenderer* fallback = renderer->AsFallback()) {
-    if (fallback->BeginTransaction()) {
-      fallback->EndTransactionWithColor(aRegion.GetBounds().ToUnknownRect(),
-                                        ToDeviceColor(mBackgroundColor));
-    }
-    return true;
-  }
-  return false;
-}
-
 void nsWebBrowser::FocusActivate(uint64_t aActionId) {
   if (RefPtr<nsFocusManager> fm = nsFocusManager::GetFocusManager()) {
     if (nsCOMPtr<nsPIDOMWindowOuter> window = GetWindow()) {
@@ -1201,19 +1096,3 @@
     nsDocShell::Cast(mDocShell)->SetWillChangeProcess();
   }
 }
-
-void nsWebBrowser::WidgetListenerDelegate::WindowActivated() {
-  RefPtr<nsWebBrowser> holder = mWebBrowser;
-  holder->WindowActivated();
-}
-
-void nsWebBrowser::WidgetListenerDelegate::WindowDeactivated() {
-  RefPtr<nsWebBrowser> holder = mWebBrowser;
-  holder->WindowDeactivated();
-}
-
-bool nsWebBrowser::WidgetListenerDelegate::PaintWindow(
-    nsIWidget* aWidget, mozilla::LayoutDeviceIntRegion aRegion) {
-  RefPtr<nsWebBrowser> holder = mWebBrowser;
-  return holder->PaintWindow(aWidget, aRegion);
-}