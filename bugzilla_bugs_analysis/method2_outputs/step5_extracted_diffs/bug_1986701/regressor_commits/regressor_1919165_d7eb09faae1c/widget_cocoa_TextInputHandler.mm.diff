# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: widget/cocoa/TextInputHandler.mm
# Commit: d7eb09faae1c
# Full Hash: d7eb09faae1c39fe5ba7039c0c14b9ee13fe6f48
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-04-29 20:49:47
# Regressor Bug: 1919165
# File Overlap Count: 1
# Description:
#   Bug 1919165 - Get rid of nsChildView. r=mac-reviewers,mstange
#   
#   In a follow-up I want to merge nsChildView.mm into nsCocoaWindow.mm, but
#   I thought I'd send this for feedback.
#   
# ==============================================================================

diff -r 1eeb386120ff -r d7eb09faae1c widget/cocoa/TextInputHandler.mm
--- a/widget/cocoa/TextInputHandler.mm	Tue Apr 29 13:50:20 2025 +0000
+++ b/widget/cocoa/TextInputHandler.mm	Tue Apr 29 13:51:02 2025 +0000
@@ -20,7 +20,7 @@
 #include "mozilla/TextEvents.h"
 #include "mozilla/ToString.h"
 
-#include "nsChildView.h"
+#include "nsCocoaWindow.h"
 #include "nsObjCExceptions.h"
 #include "nsBidiUtils.h"
 #include "nsToolkit.h"
@@ -1789,7 +1789,7 @@
  *
  ******************************************************************************/
 
-TextInputHandler::TextInputHandler(nsChildView* aWidget,
+TextInputHandler::TextInputHandler(nsCocoaWindow* aWidget,
                                    NSView<mozView>* aNativeView)
     : IMEInputHandler(aWidget, aNativeView) {
   EnsureToLogAllKeyboardLayoutsAndIMEs();
@@ -1832,7 +1832,7 @@
     [NSCursor setHiddenUntilMouseMoves:YES];
   }
 
-  RefPtr<nsChildView> widget(mWidget);
+  RefPtr<nsCocoaWindow> widget(mWidget);
 
   KeyEventState* currentKeyEvent = PushKeyEvent(aNativeEvent, aUniqueId);
   AutoKeyEventStateCleaner remover(this);
@@ -2047,7 +2047,7 @@
     return;
   }
 
-  RefPtr<nsChildView> kungFuDeathGrip(mWidget);
+  RefPtr<nsCocoaWindow> kungFuDeathGrip(mWidget);
   mozilla::Unused << kungFuDeathGrip;  // Not referenced within this function
 
   MOZ_LOG_KEY_OR_IME(
@@ -2568,7 +2568,7 @@
   }
 
   // XXX Shouldn't we hold mDispatcher instead of mWidget?
-  RefPtr<nsChildView> widget(mWidget);
+  RefPtr<nsCocoaWindow> widget(mWidget);
   nsresult rv = mDispatcher->BeginNativeInputTransaction();
   if (NS_WARN_IF(NS_FAILED(rv))) {
     MOZ_LOG_KEY_OR_IME(LogLevel::Error,
@@ -2742,7 +2742,7 @@
     }
   }
 
-  RefPtr<nsChildView> widget(mWidget);
+  RefPtr<nsCocoaWindow> widget(mWidget);
   nsresult rv = mDispatcher->BeginNativeInputTransaction();
   if (NS_WARN_IF(NS_FAILED(rv))) {
     MOZ_LOG_KEY_OR_IME(LogLevel::Error,
@@ -3051,7 +3051,7 @@
 }
 
 bool TextInputHandler::DoCommandBySelector(const char* aSelector) {
-  RefPtr<nsChildView> widget(mWidget);
+  RefPtr<nsCocoaWindow> widget(mWidget);
 
   KeyEventState* currentKeyEvent = GetCurrentKeyEvent();
 
@@ -3977,7 +3977,7 @@
   // Mark currentKeyEvent as "dispatched eKeyDown event" and actually do it.
   currentKeyEvent->mKeyDownDispatched = true;
 
-  RefPtr<nsChildView> widget(mWidget);
+  RefPtr<nsCocoaWindow> widget(mWidget);
 
   WidgetKeyboardEvent keydownEvent(true, eKeyDown, widget);
   // Don't mark the eKeyDown event as "processed by IME" if the composition
@@ -4635,7 +4635,7 @@
  *
  ******************************************************************************/
 
-IMEInputHandler::IMEInputHandler(nsChildView* aWidget,
+IMEInputHandler::IMEInputHandler(nsCocoaWindow* aWidget,
                                  NSView<mozView>* aNativeView)
     : TextInputHandlerBase(aWidget, aNativeView),
       mPendingMethods(0),
@@ -4701,7 +4701,7 @@
   ResetTimer();
 }
 
-bool IMEInputHandler::OnDestroyWidget(nsChildView* aDestroyingWidget) {
+bool IMEInputHandler::OnDestroyWidget(nsCocoaWindow* aDestroyingWidget) {
   MOZ_LOG(gIMELog, LogLevel::Info,
           ("%p IMEInputHandler::OnDestroyWidget, aDestroyingWidget=%p, "
            "sFocusedIMEHandler=%p, IsIMEComposing()=%s",
@@ -4709,7 +4709,7 @@
            TrueOrFalse(IsIMEComposing())));
 
   // If we're not focused, the focused IMEInputHandler may have been
-  // created by another widget/nsChildView.
+  // created by another widget/nsCocoaWindow.
   if (sFocusedIMEHandler && sFocusedIMEHandler != this) {
     sFocusedIMEHandler->OnDestroyWidget(aDestroyingWidget);
   }
@@ -5338,7 +5338,7 @@
 NS_IMPL_ISUPPORTS(TextInputHandlerBase, TextEventDispatcherListener,
                   nsISupportsWeakReference)
 
-TextInputHandlerBase::TextInputHandlerBase(nsChildView* aWidget,
+TextInputHandlerBase::TextInputHandlerBase(nsCocoaWindow* aWidget,
                                            NSView<mozView>* aNativeView)
     : mWidget(aWidget), mDispatcher(aWidget->GetTextEventDispatcher()) {
   gHandlerInstanceCount++;
@@ -5352,7 +5352,7 @@
   }
 }
 
-bool TextInputHandlerBase::OnDestroyWidget(nsChildView* aDestroyingWidget) {
+bool TextInputHandlerBase::OnDestroyWidget(nsCocoaWindow* aDestroyingWidget) {
   MOZ_LOG_KEY_OR_IME(LogLevel::Info,
                      ("%p TextInputHandlerBase::OnDestroyWidget, "
                       "aDestroyingWidget=%p, mWidget=%p",