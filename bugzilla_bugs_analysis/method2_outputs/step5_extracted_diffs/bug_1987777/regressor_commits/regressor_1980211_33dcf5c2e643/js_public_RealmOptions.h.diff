# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: js/public/RealmOptions.h
# Commit: 33dcf5c2e643
# Full Hash: 33dcf5c2e643b94e90a0a197c99112a080501a12
# Author: Alexandra Borovova <aborovova@mozilla.com>
# Date: 2025-08-20 09:57:21
# Regressor Bug: 1980211
# File Overlap Count: 2
# Description:
#   Bug 1980211 - Attach locale override to Realm instead of setting it in the process. r=dom-core,smaug,tschuster
#   
#   Differential Revision: https://phabricator.services.mozilla.com/D260169
# ==============================================================================

diff -r 2cb7ca176216 -r 33dcf5c2e643 js/public/RealmOptions.h
--- a/js/public/RealmOptions.h	Tue Aug 19 16:57:59 2025 +0000
+++ b/js/public/RealmOptions.h	Tue Aug 19 17:01:50 2025 +0000
@@ -299,11 +299,34 @@
     return *this;
   }
 
+  RefPtr<LocaleString> localeOverride() const { return localeOverride_; }
+  RealmBehaviors& setLocaleOverride(const char* locale) {
+    if (locale) {
+      const size_t size = strlen(locale) + 1;
+
+      js::AutoEnterOOMUnsafeRegion oomUnsafe;
+      char* memoryPtr = js_pod_malloc<char>(sizeof(LocaleString) + size);
+      if (!memoryPtr) {
+        oomUnsafe.crash("RealmBehaviors::setLocaleOverride");
+      }
+
+      char* localePtr = memoryPtr + sizeof(LocaleString);
+      memcpy(localePtr, locale, size);
+
+      localeOverride_ = new (memoryPtr) LocaleString(localePtr);
+    } else {
+      localeOverride_ = nullptr;
+    }
+
+    return *this;
+  };
+
  private:
   mozilla::Maybe<RTPCallerTypeToken> rtpCallerType;
   bool discardSource_ = false;
   bool clampAndJitterTime_ = true;
   bool isNonLive_ = false;
+  RefPtr<LocaleString> localeOverride_;
 };
 
 /**
@@ -347,6 +370,9 @@
 
 extern JS_PUBLIC_API const RealmBehaviors& RealmBehaviorsRef(JSContext* cx);
 
+extern JS_PUBLIC_API void SetRealmLocaleOverride(Realm* realm,
+                                                 const char* locale);
+
 extern JS_PUBLIC_API void SetRealmNonLive(Realm* realm);
 
 // This behaves like RealmBehaviors::setReduceTimerPrecisionCallerType, but