{
  "bug_id": "1998185",
  "summary": "Crash in [@ NS_InputStreamIsBuffered]",
  "status": "RESOLVED",
  "resolution": "FIXED",
  "product": "Core",
  "component": "Networking",
  "version": "unspecified",
  "severity": "S3",
  "priority": "P1",
  "creation_time": "2025-11-04T15:15:19Z",
  "last_change_time": "2025-12-09T16:00:13Z",
  "is_recent": true,
  "crash_signature_raw": "[@ NS_InputStreamIsBuffered]",
  "crash_signatures": [
    "NS_InputStreamIsBuffered"
  ],
  "keywords": [
    "crash"
  ],
  "regressed_by": [],
  "regressions": [],
  "bugzilla_url": "https://bugzilla.mozilla.org/show_bug.cgi?id=1998185",
  "socorro_links": [
    {
      "url": "https://crash-stats.mozilla.org/report/index/f61604ae-0d6b-4cfe-ba73-f31bd0250821",
      "crash_id": "f61604ae-0d6b-4cfe-ba73-f31bd0250821",
      "comment_index": 0,
      "comment_text": "Crash report: https://crash-stats.mozilla.org/report/index/f61604ae-0d6b-4cfe-ba73-f31bd0250821\n\nReason:\n```\nEXCEPTION_ACCESS_VIOLATION_READ\n```\n\nTop 10 frames:\n```\n0  xul.dll  NS_InputStreamIsBuffered(nsIInputStream*)  xpcom/io/nsStreamUtils.cpp:732\n1  xul.dll  mozilla::nsMultiplexInputStream::StreamData::Initialize(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.h:77\n2  xul.dll  mozilla::nsMultiplexInputStream::AppendStream(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.cpp:114\n3  xul.dll  mozilla::nsMultiplexInputStream::Clone(nsIInputStream**)  xpcom/io/nsMultiplexInputStream.cpp:1054\n4  xul.dll  mozilla::dom::StreamBlobImpl::CreateInputStream(nsIInputStream**, mozilla::Er...  dom/file/StreamBlobImpl.cpp:137\n5  xul.dll  mozilla::dom::BlobImpl::GetSendInfo(nsIInputStream**, unsigned long long*, ns...  dom/file/BlobImpl.cpp:72\n6  xul.dll  mozilla::dom::XMLHttpRequestMainThread::SendInternal(mozilla::dom::BodyExtrac...  dom/xhr/XMLHttpRequestMainThread.cpp:3166\n7  xul.dll  mozilla::dom::BodyExtractor<const mozilla::dom::URLSearchParams>::BodyExtract...  dom/fetch/BodyExtractor.h:33\n7  xul.dll  mozilla::dom::XMLHttpRequestMainThread::Send(mozilla::dom::Nullable<mozilla::...  dom/xhr/XMLHttpRequestMainThread.cpp:3061\n8  xul.dll  mozilla::dom::SendRunnable::RunOnMainThread(mozilla::ErrorResult&)  dom/xhr/XMLHttpRequestWorker.cpp:1329\n```\n\nI was looking at bug 1879917 and noticed it started spiking about a month ago."
    }
  ],
  "socorro_crash_ids": [
    "f61604ae-0d6b-4cfe-ba73-f31bd0250821"
  ],
  "has_socorro_link": true,
  "has_direct_crash_id": true,
  "stack_traces": [
    {
      "comment_id": 17747783,
      "comment_count": 0,
      "creator": "valentin.gosu@gmail.com",
      "creation_time": "2025-11-04T15:15:19Z",
      "raw_text": "Crash report: https://crash-stats.mozilla.org/report/index/f61604ae-0d6b-4cfe-ba73-f31bd0250821\n\nReason:\n```\nEXCEPTION_ACCESS_VIOLATION_READ\n```\n\nTop 10 frames:\n```\n0  xul.dll  NS_InputStreamIsBuffered(nsIInputStream*)  xpcom/io/nsStreamUtils.cpp:732\n1  xul.dll  mozilla::nsMultiplexInputStream::StreamData::Initialize(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.h:77\n2  xul.dll  mozilla::nsMultiplexInputStream::AppendStream(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.cpp:114\n3  xul.dll  mozilla::nsMultiplexInputStream::Clone(nsIInputStream**)  xpcom/io/nsMultiplexInputStream.cpp:1054\n4  xul.dll  mozilla::dom::StreamBlobImpl::CreateInputStream(nsIInputStream**, mozilla::Er...  dom/file/StreamBlobImpl.cpp:137\n5  xul.dll  mozilla::dom::BlobImpl::GetSendInfo(nsIInputStream**, unsigned long long*, ns...  dom/file/BlobImpl.cpp:72\n6  xul.dll  mozilla::dom::XMLHttpRequestMainThread::SendInternal(mozilla::dom::BodyExtrac...  dom/xhr/XMLHttpRequestMainThread.cpp:3166\n7  xul.dll  mozilla::dom::BodyExtractor<const mozilla::dom::URLSearchParams>::BodyExtract...  dom/fetch/BodyExtractor.h:33\n7  xul.dll  mozilla::dom::XMLHttpRequestMainThread::Send(mozilla::dom::Nullable<mozilla::...  dom/xhr/XMLHttpRequestMainThread.cpp:3061\n8  xul.dll  mozilla::dom::SendRunnable::RunOnMainThread(mozilla::ErrorResult&)  dom/xhr/XMLHttpRequestWorker.cpp:1329\n```\n\nI was looking at bug 1879917 and noticed it started spiking about a month ago.",
      "matched_patterns": [
        "mozilla::\\S+::\\S+\\s*\\(",
        "ns[A-Z]\\w+::\\w+",
        "(?i)(crash|stack)\\s*(trace|dump|report)"
      ],
      "parsed_frames": [
        {
          "frame_index": 0,
          "module": "xul.dll",
          "function": "NS_InputStreamIsBuffered(nsIInputStream*)",
          "file": "xpcom/io/nsStreamUtils.cpp",
          "line": 732,
          "raw": "0  xul.dll  NS_InputStreamIsBuffered(nsIInputStream*)  xpcom/io/nsStreamUtils.cpp:732"
        },
        {
          "frame_index": 1,
          "module": "xul.dll",
          "function": "mozilla::nsMultiplexInputStream::StreamData::Initialize(nsIInputStream*)",
          "file": "xpcom/io/nsMultiplexInputStream.h",
          "line": 77,
          "raw": "1  xul.dll  mozilla::nsMultiplexInputStream::StreamData::Initialize(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.h:77"
        },
        {
          "frame_index": 2,
          "module": "xul.dll",
          "function": "mozilla::nsMultiplexInputStream::AppendStream(nsIInputStream*)",
          "file": "xpcom/io/nsMultiplexInputStream.cpp",
          "line": 114,
          "raw": "2  xul.dll  mozilla::nsMultiplexInputStream::AppendStream(nsIInputStream*)  xpcom/io/nsMultiplexInputStream.cpp:114"
        },
        {
          "frame_index": 3,
          "module": "xul.dll",
          "function": "mozilla::nsMultiplexInputStream::Clone(nsIInputStream**)",
          "file": "xpcom/io/nsMultiplexInputStream.cpp",
          "line": 1054,
          "raw": "3  xul.dll  mozilla::nsMultiplexInputStream::Clone(nsIInputStream**)  xpcom/io/nsMultiplexInputStream.cpp:1054"
        },
        {
          "frame_index": 4,
          "module": "xul.dll",
          "function": "mozilla::dom::StreamBlobImpl::CreateInputStream(nsIInputStream**, mozilla::Er...",
          "file": "dom/file/StreamBlobImpl.cpp",
          "line": 137,
          "raw": "4  xul.dll  mozilla::dom::StreamBlobImpl::CreateInputStream(nsIInputStream**, mozilla::Er...  dom/file/StreamBlobImpl.cpp:137"
        },
        {
          "frame_index": 5,
          "module": "xul.dll",
          "function": "mozilla::dom::BlobImpl::GetSendInfo(nsIInputStream**, unsigned long long*, ns...",
          "file": "dom/file/BlobImpl.cpp",
          "line": 72,
          "raw": "5  xul.dll  mozilla::dom::BlobImpl::GetSendInfo(nsIInputStream**, unsigned long long*, ns...  dom/file/BlobImpl.cpp:72"
        },
        {
          "frame_index": 6,
          "module": "xul.dll",
          "function": "mozilla::dom::XMLHttpRequestMainThread::SendInternal(mozilla::dom::BodyExtrac...",
          "file": "dom/xhr/XMLHttpRequestMainThread.cpp",
          "line": 3166,
          "raw": "6  xul.dll  mozilla::dom::XMLHttpRequestMainThread::SendInternal(mozilla::dom::BodyExtrac...  dom/xhr/XMLHttpRequestMainThread.cpp:3166"
        },
        {
          "frame_index": 7,
          "module": "xul.dll",
          "function": "mozilla::dom::BodyExtractor<const mozilla::dom::URLSearchParams>::BodyExtract...",
          "file": "dom/fetch/BodyExtractor.h",
          "line": 33,
          "raw": "7  xul.dll  mozilla::dom::BodyExtractor<const mozilla::dom::URLSearchParams>::BodyExtract...  dom/fetch/BodyExtractor.h:33"
        },
        {
          "frame_index": 7,
          "module": "xul.dll",
          "function": "mozilla::dom::XMLHttpRequestMainThread::Send(mozilla::dom::Nullable<mozilla::...",
          "file": "dom/xhr/XMLHttpRequestMainThread.cpp",
          "line": 3061,
          "raw": "7  xul.dll  mozilla::dom::XMLHttpRequestMainThread::Send(mozilla::dom::Nullable<mozilla::...  dom/xhr/XMLHttpRequestMainThread.cpp:3061"
        },
        {
          "frame_index": 8,
          "module": "xul.dll",
          "function": "mozilla::dom::SendRunnable::RunOnMainThread(mozilla::ErrorResult&)",
          "file": "dom/xhr/XMLHttpRequestWorker.cpp",
          "line": 1329,
          "raw": "8  xul.dll  mozilla::dom::SendRunnable::RunOnMainThread(mozilla::ErrorResult&)  dom/xhr/XMLHttpRequestWorker.cpp:1329"
        }
      ],
      "frame_count": 10
    },
    {
      "comment_id": 17797977,
      "comment_count": 6,
      "creator": "kershaw@mozilla.com",
      "creation_time": "2025-12-08T11:00:36Z",
      "raw_text": "The stacktrace from the recent crashes:\n```\n0 \tlibxul.so \tNS_InputStreamIsBuffered(nsIInputStream*) \t/usr/src/debug/firefox/firefox-145.0/xpcom/io/nsStreamUtils.cpp:732 \tcontext\n1 \tlibxul.so \tnsInputStreamPump::CreateBufferedStreamIfNeeded() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:744 \tcfi\n2 \tlibxul.so \tnsInputStreamPump::PeekStream(void (*)(void*, unsigned char const*, unsigned int), void*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:78 \tinlined\n2 \tlibxul.so \tmozilla::net::nsHttpChannel::CallOnStartRequest() \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:2390 \tcfi\n3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest3(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9106 \tinlined\n3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest2(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9095 \tinlined\n3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest1(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9068 \tcfi\n4 \tlibxul.so \tmozilla::net::nsHttpChannel::OnStartRequest(nsIRequest*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:8930 \tcfi\n5 \tlibxul.so \tnsInputStreamPump::OnStateStart() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:524 \tinlined\n5 \tlibxul.so \tnsInputStreamPump::OnInputStreamReady(nsIAsyncInputStream*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:426 \t\n```\nThe above trace shows `PeekStream` is called from `CallOnStartRequest` [here](https://searchfox.org/firefox-main/rev/d4456d810664a2a13a871a68e5323522a78c1131/netwerk/protocol/http/nsHttpChannel.cpp#2431), which implies `mTransactionPump` is non-null. What\u2019s puzzling is that the stack also shows `ContinueOnStartRequest1`, which only runs when the channel already has an error status (otherwise we\u2019d enter the [other branch and call ProcessResponse](https://searchfox.org/firefox-main/rev/d4456d810664a2a13a871a68e5323522a78c1131/netwerk/protocol/http/nsHttpChannel.cpp#9006-9039)).\nAnyways, the crash report indicates [mAsyncStream is null](https://searchfox.org/firefox-main/rev/d4456d810664a2a13a871a68e5323522a78c1131/netwerk/base/nsInputStreamPump.cpp#744), but the root cause isn\u2019t clear yet. I\u2019ll add a null check and some diagnostic assertions to try to catch where this is happening.",
      "matched_patterns": [
        "mozilla::\\S+::\\S+\\s*\\(",
        "ns[A-Z]\\w+::\\w+",
        "(?i)(crash|stack)\\s*(trace|dump|report)"
      ],
      "parsed_frames": [
        {
          "frame_index": 0,
          "module": "libxul.so",
          "function": "NS_InputStreamIsBuffered(nsIInputStream*) \t/usr/src/debug/firefox/firefox-145.0/xpcom/io/nsStreamUtils.cpp:732",
          "file": "",
          "line": null,
          "raw": "0 \tlibxul.so \tNS_InputStreamIsBuffered(nsIInputStream*) \t/usr/src/debug/firefox/firefox-145.0/xpcom/io/nsStreamUtils.cpp:732 \tcontext"
        },
        {
          "frame_index": 1,
          "module": "libxul.so",
          "function": "nsInputStreamPump::CreateBufferedStreamIfNeeded() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:744",
          "file": "",
          "line": null,
          "raw": "1 \tlibxul.so \tnsInputStreamPump::CreateBufferedStreamIfNeeded() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:744 \tcfi"
        },
        {
          "frame_index": 2,
          "module": "libxul.so",
          "function": "nsInputStreamPump::PeekStream(void (*)(void*, unsigned char const*, unsigned int), void*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:78",
          "file": "",
          "line": null,
          "raw": "2 \tlibxul.so \tnsInputStreamPump::PeekStream(void (*)(void*, unsigned char const*, unsigned int), void*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:78 \tinlined"
        },
        {
          "frame_index": 2,
          "module": "libxul.so",
          "function": "mozilla::net::nsHttpChannel::CallOnStartRequest() \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:2390",
          "file": "",
          "line": null,
          "raw": "2 \tlibxul.so \tmozilla::net::nsHttpChannel::CallOnStartRequest() \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:2390 \tcfi"
        },
        {
          "frame_index": 3,
          "module": "libxul.so",
          "function": "mozilla::net::nsHttpChannel::ContinueOnStartRequest3(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9106",
          "file": "",
          "line": null,
          "raw": "3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest3(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9106 \tinlined"
        },
        {
          "frame_index": 3,
          "module": "libxul.so",
          "function": "mozilla::net::nsHttpChannel::ContinueOnStartRequest2(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9095",
          "file": "",
          "line": null,
          "raw": "3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest2(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9095 \tinlined"
        },
        {
          "frame_index": 3,
          "module": "libxul.so",
          "function": "mozilla::net::nsHttpChannel::ContinueOnStartRequest1(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9068",
          "file": "",
          "line": null,
          "raw": "3 \tlibxul.so \tmozilla::net::nsHttpChannel::ContinueOnStartRequest1(nsresult) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:9068 \tcfi"
        },
        {
          "frame_index": 4,
          "module": "libxul.so",
          "function": "mozilla::net::nsHttpChannel::OnStartRequest(nsIRequest*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:8930",
          "file": "",
          "line": null,
          "raw": "4 \tlibxul.so \tmozilla::net::nsHttpChannel::OnStartRequest(nsIRequest*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/protocol/http/nsHttpChannel.cpp:8930 \tcfi"
        },
        {
          "frame_index": 5,
          "module": "libxul.so",
          "function": "nsInputStreamPump::OnStateStart() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:524",
          "file": "",
          "line": null,
          "raw": "5 \tlibxul.so \tnsInputStreamPump::OnStateStart() \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:524 \tinlined"
        },
        {
          "frame_index": 5,
          "module": "libxul.so",
          "function": "nsInputStreamPump::OnInputStreamReady(nsIAsyncInputStream*)",
          "file": "/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp",
          "line": 426,
          "raw": "5 \tlibxul.so \tnsInputStreamPump::OnInputStreamReady(nsIAsyncInputStream*) \t/usr/src/debug/firefox/firefox-145.0/netwerk/base/nsInputStreamPump.cpp:426"
        }
      ],
      "frame_count": 10
    }
  ],
  "has_stack_traces": true,
  "stack_trace_count": 2,
  "total_parsed_frames": 20
}