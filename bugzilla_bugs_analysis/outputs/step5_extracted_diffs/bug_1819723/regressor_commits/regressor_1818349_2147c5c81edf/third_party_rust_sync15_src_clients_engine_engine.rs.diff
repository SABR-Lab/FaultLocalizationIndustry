# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: third_party/rust/sync15/src/clients_engine/engine.rs
# Commit: 2147c5c81edf
# Full Hash: 2147c5c81edf9cd56c19e7e92dfebfcd77329978
# Author: Ryan VanderMeulen <ryanvm@gmail.com>
# Date: 2023-03-01 17:52 -0500
# Regressor Bug: 1818349
# File Overlap Count: 24
# Overlapping Files: third_party/rust/sync15/src/client/coll_update.rs, third_party/rust/sync15/src/client/mod.rs, third_party/rust/sync15/.cargo-checksum.json, third_party/rust/sync15/src/client/sync.rs, Cargo.toml
# Description:
#   Backed out changesets b05343a5b533 and 57b2cda7e0db (bug 1818349) for causing bug 1819723.
# ==============================================================================

diff -r d59b76766f0d -r 2147c5c81edf third_party/rust/sync15/src/clients_engine/engine.rs
--- a/third_party/rust/sync15/src/clients_engine/engine.rs	Wed Mar 01 05:53:30 2023 +0000
+++ b/third_party/rust/sync15/src/clients_engine/engine.rs	Wed Mar 01 17:52:01 2023 -0500
@@ -54,11 +54,13 @@
         inbound: IncomingChangeset,
         should_refresh_client: bool,
     ) -> Result<OutgoingChangeset> {
+        let mut outgoing = OutgoingChangeset::new(COLLECTION_NAME, inbound.timestamp);
+        outgoing.timestamp = inbound.timestamp;
+
         self.interruptee.err_if_interrupted()?;
         let outgoing_commands = self.command_processor.fetch_outgoing_commands()?;
 
         let mut has_own_client_record = false;
-        let mut changes = Vec::new();
 
         for bso in inbound.changes {
             self.interruptee.err_if_interrupted()?;
@@ -126,7 +128,9 @@
                         ttl: Some(CLIENTS_TTL),
                         ..Default::default()
                     };
-                    changes.push(OutgoingBso::from_content(envelope, current_client_record)?);
+                    outgoing
+                        .changes
+                        .push(OutgoingBso::from_content(envelope, current_client_record)?);
                 }
             } else {
                 // Add the other client to our map of recently synced clients.
@@ -172,7 +176,9 @@
                     ttl: Some(CLIENTS_TTL),
                     ..Default::default()
                 };
-                changes.push(OutgoingBso::from_content(envelope, new_client)?);
+                outgoing
+                    .changes
+                    .push(OutgoingBso::from_content(envelope, new_client)?);
             }
         }
 
@@ -185,10 +191,12 @@
                 ttl: Some(CLIENTS_TTL),
                 ..Default::default()
             };
-            changes.push(OutgoingBso::from_content(envelope, current_client_record)?);
+            outgoing
+                .changes
+                .push(OutgoingBso::from_content(envelope, current_client_record)?);
         }
 
-        Ok(OutgoingChangeset::new(COLLECTION_NAME.into(), changes))
+        Ok(outgoing)
     }
 
     /// Builds a fresh client record for this device.
@@ -283,7 +291,7 @@
             global_state.keys_timestamp,
             root_sync_key,
         )?;
-        let coll_state = CollState {
+        let mut coll_state = CollState {
             config: global_state.config.clone(),
             last_modified: global_state
                 .collections
@@ -293,7 +301,7 @@
             key: coll_keys.key_for_collection(COLLECTION_NAME).clone(),
         };
 
-        let inbound = self.fetch_incoming(storage_client, &coll_state)?;
+        let inbound = self.fetch_incoming(storage_client, &mut coll_state)?;
 
         let mut driver = Driver::new(
             self.command_processor,
@@ -304,6 +312,8 @@
         let outgoing = driver.sync(inbound, should_refresh_client)?;
         self.recent_clients = driver.recent_clients;
 
+        coll_state.last_modified = outgoing.timestamp;
+
         self.interruptee.err_if_interrupted()?;
         let upload_info =
             CollectionUpdate::new_from_changeset(storage_client, &coll_state, outgoing, true)?
@@ -322,15 +332,15 @@
     fn fetch_incoming(
         &self,
         storage_client: &Sync15StorageClient,
-        coll_state: &CollState,
+        coll_state: &mut CollState,
     ) -> Result<IncomingChangeset> {
         // Note that, unlike other stores, we always fetch the full collection
         // on every sync, so `inbound` will return all clients, not just the
         // ones that changed since the last sync.
-        let coll_request = CollectionRequest::new(COLLECTION_NAME.into()).full();
+        let coll_request = CollectionRequest::new(COLLECTION_NAME).full();
 
         self.interruptee.err_if_interrupted()?;
-        let inbound = crate::client::fetch_incoming(storage_client, coll_state, coll_request)?;
+        let inbound = crate::client::fetch_incoming(storage_client, coll_state, &coll_request)?;
 
         Ok(inbound)
     }
@@ -550,7 +560,7 @@
                 .into_iter()
                 .map(|c| OutgoingBso::to_test_incoming(&c))
                 .collect(),
-            timestamp: ServerTimestamp::default(),
+            timestamp: outgoing.timestamp,
             collection: outgoing.collection,
         };
         if let Value::Array(expected) = expected {
@@ -789,7 +799,7 @@
                     .into_iter()
                     .map(|c| OutgoingBso::to_test_incoming(&c))
                     .collect(),
-                timestamp: ServerTimestamp::default(),
+                timestamp: outgoing.timestamp,
                 collection: outgoing.collection,
             };
             for (incoming_cleartext, record) in zip(incoming.changes, expected) {