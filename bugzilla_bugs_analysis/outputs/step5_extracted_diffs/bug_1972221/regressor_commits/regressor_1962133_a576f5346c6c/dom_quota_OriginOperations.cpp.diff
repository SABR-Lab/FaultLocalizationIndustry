# ==============================================================================
# REGRESSOR COMMIT DIFF
# ==============================================================================
# File: dom/quota/OriginOperations.cpp
# Commit: a576f5346c6c
# Full Hash: a576f5346c6cfc32a5b147158e48ec1f4fcf2a8f
# Author: Jan Varga <jvarga@mozilla.com>
# Date: 2025-06-12 16:31:09
# Regressor Bug: 1962133
# File Overlap Count: 5
# Overlapping Files: dom/quota/DirectoryMetadata.h, dom/quota/DirectoryMetadata.cpp, dom/quota/OriginOperations.cpp, dom/quota/moz.build, dom/quota/ActorsParent.cpp
# Description:
#   Bug 1962133 - QM: Prepare metadata header infrastructure for accessed flag addition and reduce duplication; r=dom-storage-reviewers,hsingh
#   
#   This patch restructures metadata header reading and writing code to reduce
#   duplication and establish clean infrastructure for adding the accessed flag to
#   the metadata file header.
# ==============================================================================

diff -r f4284b0494fc -r a576f5346c6c dom/quota/OriginOperations.cpp
--- a/dom/quota/OriginOperations.cpp	Wed Jun 11 20:01:43 2025 +0000
+++ b/dom/quota/OriginOperations.cpp	Wed Jun 11 20:09:11 2025 +0000
@@ -10,6 +10,7 @@
 #include <cstdint>
 #include <utility>
 
+#include "DirectoryMetadata.h"
 #include "ErrorList.h"
 #include "FileUtils.h"
 #include "GroupInfo.h"
@@ -1327,7 +1328,12 @@
       OkIf(aQuotaManager.IsTemporaryOriginInitializedInternal(mOriginMetadata)),
       NS_ERROR_NOT_INITIALIZED);
 
-  int64_t timestamp = PR_Now();
+  auto maybeOriginStateMetadata =
+      aQuotaManager.GetOriginStateMetadata(mOriginMetadata);
+
+  auto originStateMetadata = maybeOriginStateMetadata.extract();
+
+  originStateMetadata.mLastAccessTime = PR_Now();
 
   QM_TRY_INSPECT(const auto& file,
                  aQuotaManager.GetOriginDirectory(mOriginMetadata));
@@ -1338,22 +1344,16 @@
   QM_TRY_INSPECT(const bool& exists, MOZ_TO_RESULT_INVOKE_MEMBER(file, Exists));
 
   if (exists) {
-    QM_TRY(MOZ_TO_RESULT(file->Append(nsLiteralString(METADATA_V2_FILE_NAME))));
-
-    QM_TRY_INSPECT(const auto& stream,
-                   GetBinaryOutputStream(*file, FileFlag::Update));
-    MOZ_ASSERT(stream);
-
-    QM_TRY(MOZ_TO_RESULT(stream->Write64(timestamp)));
-
-    QM_TRY(MOZ_TO_RESULT(stream->Close()));
+    QM_TRY(
+        MOZ_TO_RESULT(SaveDirectoryMetadataHeader(*file, originStateMetadata)));
 
     mSaved = true;
 
     aQuotaManager.IncreaseSaveOriginAccessTimeCountInternal();
   }
 
-  aQuotaManager.UpdateOriginAccessTime(mOriginMetadata, timestamp);
+  aQuotaManager.UpdateOriginAccessTime(mOriginMetadata,
+                                       originStateMetadata.mLastAccessTime);
 
   return NS_OK;
 }
@@ -3597,22 +3597,11 @@
         }()));
 
     if (!persisted) {
-      QM_TRY_INSPECT(const auto& file,
-                     CloneFileAndAppend(
-                         *directory, nsLiteralString(METADATA_V2_FILE_NAME)));
-
-      QM_TRY_INSPECT(const auto& stream,
-                     GetBinaryOutputStream(*file, FileFlag::Update));
-
-      MOZ_ASSERT(stream);
-
-      // Update origin access time while we are here.
-      QM_TRY(MOZ_TO_RESULT(stream->Write64(PR_Now())));
-
-      // Set the persisted flag to true.
-      QM_TRY(MOZ_TO_RESULT(stream->WriteBoolean(true)));
-
-      QM_TRY(MOZ_TO_RESULT(stream->Close()));
+      // Set the persisted flag to true and also update origin access time
+      // while we are here.
+      QM_TRY(MOZ_TO_RESULT(SaveDirectoryMetadataHeader(
+          *directory, OriginStateMetadata{/* aLastAccessTime */ PR_Now(),
+                                          /* aPersisted */ true})));
 
       // Directory metadata has been successfully updated.
       // Update OriginInfo too if temporary storage was already initialized.