# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: dom/view-transitions/ViewTransition.cpp
# Commit: d0a241d0c9b6
# Full Hash: d0a241d0c9b60dd81a2de262111995582864544c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-06-17 21:30:38
# Description:
#   Bug 1972259 - Skip view transition on page swap. r=nical
#   
#   This fixes the crash, but it causes the commented out assertion to fire,
#   probably because the delete op is queued already with the wrong
#   pipeline, which I think means the snapshots leak.
# ==============================================================================

diff -r a8e744a89b81 -r d0a241d0c9b6 dom/view-transitions/ViewTransition.cpp
--- a/dom/view-transitions/ViewTransition.cpp	Tue Jun 17 10:12:37 2025 +0000
+++ b/dom/view-transitions/ViewTransition.cpp	Tue Jun 17 10:43:10 2025 +0000
@@ -1259,9 +1259,8 @@
     MOZ_ASSERT(f->GetContent()->IsElement());
     // Capture the view-transition-class.
     // https://drafts.csswg.org/css-view-transitions-2/#vt-class-algorithms
-    auto capture =
-        MakeUnique<CapturedElement>(f, mInitialSnapshotContainingBlockSize,
-                                    DocumentScopedClassListFor(f));
+    auto capture = MakeUnique<CapturedElement>(
+        f, mInitialSnapshotContainingBlockSize, DocumentScopedClassListFor(f));
     mNamedElements.InsertOrUpdate(name, std::move(capture));
     mNames.AppendElement(name);
   }
@@ -1632,6 +1631,10 @@
         readyPromise->MaybeRejectWithInvalidStateError(
             "Skipped view transition due to root element going away");
         break;
+      case SkipTransitionReason::PageSwap:
+        readyPromise->MaybeRejectWithInvalidStateError(
+            "Skipped view transition due to page swap");
+        break;
       case SkipTransitionReason::Resize:
         readyPromise->MaybeRejectWithInvalidStateError(
             "Skipped view transition due to viewport resize");