# ==============================================================================
# FIXING COMMIT DIFF
# ==============================================================================
# File: unknown
# Commit: d0a241d0c9b6
# Full Hash: d0a241d0c9b60dd81a2de262111995582864544c
# Author: Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date: 2025-06-17 21:30:38
# Description:
#   Bug 1972259 - Skip view transition on page swap. r=nical
#   
#   This fixes the crash, but it causes the commented out assertion to fire,
#   probably because the delete op is queued already with the wrong
#   pipeline, which I think means the snapshots leak.
# ==============================================================================

diff -r a8e744a89b81 -r d0a241d0c9b6 dom/view-transitions/test/browser/browser_tab_detach_vt.js
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/dom/view-transitions/test/browser/browser_tab_detach_vt.js	Tue Jun 17 10:43:10 2025 +0000
@@ -0,0 +1,54 @@
+/* Any copyright is dedicated to the Public Domain.
+   https://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+const TEST_PAGE = `
+<!doctype html>
+<style>
+  :root::view-transition {
+    background-color: pink;
+  }
+  :root::view-transition-group(*) {
+    /* Keeps the transition up until timeout */
+    animation-play-state: paused;
+    opacity: 0;
+  }
+</style>
+`;
+
+async function detachTab(tab) {
+  let newWindowPromise = BrowserTestUtils.waitForNewWindow();
+  await EventUtils.synthesizePlainDragAndDrop({
+    srcElement: tab,
+    // destElement is null because tab detaching happens due
+    // to a drag'n'drop on an invalid drop target.
+    destElement: null,
+    // don't move horizontally because that could cause a tab move
+    // animation, and there's code to prevent a tab detaching if
+    // the dragged tab is released while the animation is running.
+    stepX: 0,
+    stepY: 100,
+  });
+  return newWindowPromise;
+}
+
+// Test for bug 1972259
+add_task(async function test_tab_detach_active_vt() {
+  await BrowserTestUtils.withNewTab(
+    {
+      gBrowser,
+      url: `https://example.com/document-builder.sjs?html=${encodeURIComponent(
+        TEST_PAGE
+      )}`,
+    },
+    async browser => {
+      await ContentTask.spawn(browser, null, async function () {
+        return content.document.startViewTransition().ready;
+      });
+      let newWin = await detachTab(gBrowser.selectedTab);
+      ok(!!newWin, "Opened a new window, without crashing");
+      await BrowserTestUtils.closeWindow(newWin);
+    }
+  );
+});